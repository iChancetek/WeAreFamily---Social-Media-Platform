[{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\analyze-lint.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\activity.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":81,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3490,3493],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3490,3493],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { headers } from \"next/headers\";\r\n\r\nexport async function startTrackingSession() {\r\n    const user = await getUserProfile();\r\n    if (!user) return null;\r\n\r\n    const headersList = await headers();\r\n    const userAgent = headersList.get(\"user-agent\") || \"Unknown Device\";\r\n\r\n    // Create a new session doc\r\n    const sessionRef = await adminDb.collection(\"users\").doc(user.id).collection(\"sessions\").add({\r\n        startedAt: FieldValue.serverTimestamp(),\r\n        endedAt: null,\r\n        duration: 0,\r\n        deviceInfo: userAgent,\r\n        status: 'active',\r\n        lastHeartbeat: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    // Update User's lastSignInAt and lastActiveAt to ensure they appear in online lists immediately\r\n    await adminDb.collection(\"users\").doc(user.id).update({\r\n        lastSignInAt: FieldValue.serverTimestamp(),\r\n        lastActiveAt: FieldValue.serverTimestamp(),\r\n        isOnline: true\r\n    });\r\n\r\n    return sessionRef.id;\r\n}\r\n\r\nexport async function updateSessionHeartbeat(sessionId: string, accumulatedDurationMs: number) {\r\n    const user = await getUserProfile();\r\n    if (!user) return;\r\n\r\n    const sessionRef = adminDb.collection(\"users\").doc(user.id).collection(\"sessions\").doc(sessionId);\r\n\r\n    // Update session\r\n    await sessionRef.update({\r\n        lastHeartbeat: FieldValue.serverTimestamp(),\r\n        duration: accumulatedDurationMs,\r\n        // We don't set endedAt here, we assume it's still ongoing.\r\n    });\r\n\r\n    // Update User Total Time (Incrementally? No, better to just update user online status)\r\n    // To efficiently track TOTAL time, we might want to increment a global counter on the user doc\r\n    // But incrementing every minute might be write-heavy? \r\n    // Let's do it: it's admin visibility, accuracy matters.\r\n    // 60 seconds interval = 1 write per user per minute. Acceptable for now.\r\n\r\n    // Calculating delta since last update is hard without reading.\r\n    // Simpler approach: Re-calculate total time when session ends OR just increment by Heartbeat Interval (client sends delta?)\r\n    // Let's rely on client sending \"I've been active for X extra ms\" OR just server diff?\r\n    // Client sending \"I've been active for 60s since last ping\" is safer.\r\n\r\n    // However, for simplicity and robustness against client tampering, let's just mark \"lastActive\"\r\n    // and rely on a background job or aggregation for \"Total Time\".\r\n    // BUT the requirement is \"Account Accurate Time Spent\".\r\n\r\n    // Let's try: Update user's `totalTimeSpent` by incrementing by the heartbeat interval (approx 60s).\r\n    // The client should call this every 60s.\r\n    // Debounce totalTimeSpent update to avoid multi-tab overcounting\r\n    // We only increment if lastActiveAt was older than 45 seconds (allowing for some jitter in 60s heartbeat)\r\n    const userDocRef = adminDb.collection(\"users\").doc(user.id);\r\n    const userDoc = await userDocRef.get();\r\n    const userData = userDoc.data();\r\n\r\n    let shouldIncrementDetails = true;\r\n    if (userData?.lastActiveAt) {\r\n        // Check if last update was very recent\r\n        const lastActiveTime = userData.lastActiveAt.toDate().getTime();\r\n        const now = Date.now();\r\n        if (now - lastActiveTime < 45000) {\r\n            shouldIncrementDetails = false;\r\n        }\r\n    }\r\n\r\n    const updates: any = {\r\n        isOnline: true,\r\n        lastActiveAt: FieldValue.serverTimestamp(),\r\n    };\r\n\r\n    if (shouldIncrementDetails) {\r\n        updates.totalTimeSpent = FieldValue.increment(60000); // 60s\r\n    }\r\n\r\n    await userDocRef.update(updates);\r\n}\r\n\r\nexport async function endTrackingSession(sessionId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) return;\r\n\r\n    try {\r\n        const sessionRef = adminDb.collection(\"users\").doc(user.id).collection(\"sessions\").doc(sessionId);\r\n\r\n        await sessionRef.update({\r\n            endedAt: FieldValue.serverTimestamp(),\r\n            status: 'completed',\r\n            // We could finalize duration here based on start/end difference if we trusted server times more\r\n        });\r\n\r\n        await adminDb.collection(\"users\").doc(user.id).update({\r\n            isOnline: false,\r\n            lastSignOffAt: FieldValue.serverTimestamp()\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Error ending session\", error);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\admin-messaging.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'revalidatePath' is defined but never used.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"revalidatePath"},"fix":{"range":[168,212],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\n// 1. Send Global Broadcast (Notification)\r\nexport async function sendSystemBroadcast(title: string, message: string, link?: string) {\r\n    const admin = await getUserProfile();\r\n    if (!admin || admin.role !== \"admin\") throw new Error(\"Unauthorized: Admin only\");\r\n\r\n    if (!title || !message) throw new Error(\"Title and message are required\");\r\n\r\n    console.log(`[Admin] Starting system broadcast: ${title}`);\r\n\r\n    // Fetch ALL users (batching handled if > 1000, but for now standard fetch is ok)\r\n    // Optimization: Store user IDs in a stripped list or use Cloud Functions.\r\n    // For this app scale, fetching 'users' collection is acceptable.\r\n    const usersSnapshot = await adminDb.collection(\"users\").get();\r\n\r\n    if (usersSnapshot.empty) return { count: 0 };\r\n\r\n    const batchSize = 500;\r\n    let batch = adminDb.batch();\r\n    let count = 0;\r\n    const total = usersSnapshot.size;\r\n\r\n    for (const doc of usersSnapshot.docs) {\r\n        const userId = doc.id;\r\n        const ref = adminDb.collection(\"notifications\").doc();\r\n\r\n        batch.set(ref, {\r\n            recipientId: userId,\r\n            type: \"system_broadcast\",\r\n            read: false,\r\n            createdAt: FieldValue.serverTimestamp(),\r\n            meta: {\r\n                title,\r\n                message,\r\n                link: link || \"/\",\r\n                action: \"announcement\"\r\n            }\r\n        });\r\n\r\n        count++;\r\n\r\n        if (count % batchSize === 0) {\r\n            await batch.commit();\r\n            batch = adminDb.batch();\r\n        }\r\n    }\r\n\r\n    if (count % batchSize !== 0) {\r\n        await batch.commit(); // Commit remaining\r\n    }\r\n\r\n    // Also Log to Audit\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"admin.broadcast\", {\r\n        details: { title, message, recipientCount: total }\r\n    });\r\n\r\n    return { success: true, count: total };\r\n}\r\n\r\n// 2. Send Direct Message as Admin (Bypassing some checks if needed, but reusing chat logic is best)\r\nexport async function sendAdminMessage(targetUserId: string, message: string) {\r\n    const admin = await getUserProfile();\r\n    if (!admin || admin.role !== \"admin\") throw new Error(\"Unauthorized\");\r\n\r\n    // Reuse existing chat logic but wrapped for admin explicit action\r\n    const { checkOrCreateChat, sendMessage } = await import(\"./chat\");\r\n\r\n    // Ensure chat exists\r\n    const chatId = await checkOrCreateChat(targetUserId);\r\n\r\n    // Send message\r\n    await sendMessage(chatId, message);\r\n\r\n    return { success: true };\r\n}\r\n\r\n// 3. Send Message to a Group (Admin override)\r\nexport async function sendAdminGroupMessage(groupId: string, message: string) {\r\n    const admin = await getUserProfile();\r\n    if (!admin || admin.role !== \"admin\") throw new Error(\"Unauthorized\");\r\n\r\n    // Check availability\r\n    const groupDoc = await adminDb.collection(\"chats\").doc(groupId).get();\r\n    if (!groupDoc.exists) throw new Error(\"Group not found\");\r\n\r\n    // Force add message even if not participant? \r\n    // Ideally Admin adds themselves first? Or just forced write?\r\n    // Let's stick to \"Join and Send\" or just \"Force Write\".\r\n    // Force write is cleaner for \"System\" messages.\r\n\r\n    await adminDb.collection(\"chats\").doc(groupId).collection(\"messages\").add({\r\n        senderId: admin.id,\r\n        content: message,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n        isSystemMessage: true // distinct flag\r\n    });\r\n\r\n    await adminDb.collection(\"chats\").doc(groupId).update({\r\n        lastMessageAt: FieldValue.serverTimestamp()\r\n    });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\admin.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":115,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3876,3879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3876,3879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":116,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3913,3916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3913,3916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { logAuditEvent } from \"@/app/actions/audit\";\r\n\r\nexport async function approveUser(userId: string) {\r\n    const admin = await getUserProfile()\r\n    if (admin?.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\")\r\n    }\r\n\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    if (!userDoc.exists) throw new Error(\"User not found\");\r\n    const userData = userDoc.data();\r\n\r\n    await adminDb.collection(\"users\").doc(userId).update({ role: 'member' });\r\n\r\n    const rawName = userData?.displayName;\r\n    const targetName = (rawName && rawName !== \"Family Member\") ? rawName : (userData?.email || \"Unknown\");\r\n\r\n    await logAuditEvent(\"admin.approve_user\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName,\r\n    });\r\n\r\n    revalidatePath('/admin')\r\n}\r\n\r\nexport async function rejectUser(userId: string) {\r\n    const admin = await getUserProfile()\r\n    if (admin?.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\")\r\n    }\r\n\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    if (!userDoc.exists) throw new Error(\"User not found\");\r\n    const userData = userDoc.data();\r\n\r\n    await adminDb.collection(\"users\").doc(userId).update({ role: 'rejected' });\r\n\r\n    const rawName = userData?.displayName;\r\n    const targetName = (rawName && rawName !== \"Family Member\") ? rawName : (userData?.email || \"Unknown\");\r\n\r\n    await logAuditEvent(\"admin.reject_user\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName,\r\n    });\r\n\r\n    revalidatePath('/admin')\r\n}\r\n\r\nexport async function makeAdmin(userId: string) {\r\n    const admin = await getUserProfile()\r\n    if (admin?.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\")\r\n    }\r\n\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    if (!userDoc.exists) throw new Error(\"User not found\");\r\n    const userData = userDoc.data();\r\n\r\n    await adminDb.collection(\"users\").doc(userId).update({ role: 'admin' });\r\n\r\n    const rawName = userData?.displayName;\r\n    const targetName = (rawName && rawName !== \"Family Member\") ? rawName : (userData?.email || \"Unknown\");\r\n\r\n    await logAuditEvent(\"admin.promote_user\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName,\r\n    });\r\n\r\n    revalidatePath('/admin')\r\n}\r\n\r\nexport async function toggleUserStatus(userId: string, isActive: boolean) {\r\n    const admin = await getUserProfile()\r\n    if (admin?.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\")\r\n    }\r\n\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    if (!userDoc.exists) throw new Error(\"User not found\");\r\n    const userData = userDoc.data();\r\n\r\n    await adminDb.collection(\"users\").doc(userId).update({ isActive });\r\n\r\n    const rawName = userData?.displayName;\r\n    const targetName = (rawName && rawName !== \"Family Member\") ? rawName : (userData?.email || \"Unknown\");\r\n\r\n    await logAuditEvent(isActive ? \"admin.enable_user\" : \"admin.disable_user\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName,\r\n    });\r\n\r\n    revalidatePath('/admin')\r\n}\r\n\r\nexport async function updateUserProfile(userId: string, data: { firstName?: string; lastName?: string; displayName?: string; email?: string }) {\r\n    const admin = await getUserProfile()\r\n    if (admin?.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\")\r\n    }\r\n\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    if (!userDoc.exists) throw new Error(\"User not found\");\r\n    const currentUserData = userDoc.data();\r\n\r\n    // Prepare update data - update both root fields and profileData map if needed\r\n    const updates: any = {};\r\n    const profileUpdates: any = {};\r\n\r\n    if (data.firstName) profileUpdates.firstName = data.firstName;\r\n    if (data.lastName) profileUpdates.lastName = data.lastName;\r\n\r\n    // Update root display name if provided, or derive from new first/last\r\n    if (data.displayName) {\r\n        updates.displayName = data.displayName;\r\n    } else if (data.firstName || data.lastName) {\r\n        // If changing real name but not explicit display name, ensure display name is updated to match new real name\r\n        // (Enforcing strictly First + Last)\r\n        const f = data.firstName || currentUserData?.profileData?.firstName || \"\";\r\n        const l = data.lastName || currentUserData?.profileData?.lastName || \"\";\r\n        updates.displayName = `${f} ${l}`.trim();\r\n    }\r\n\r\n    if (data.email && data.email !== currentUserData?.email) {\r\n        // Changing email requires updating Auth user too - complex, might need Admin SDK auth.updateUser\r\n        // For now, let's stick to Firestore updates and warn/handle Auth separately if needed.\r\n        // Actually, let's try to update Auth if possible.\r\n        try {\r\n            const { getAuth } = await import('firebase-admin/auth');\r\n            await getAuth().updateUser(userId, { email: data.email });\r\n            updates.email = data.email;\r\n        } catch (error) {\r\n            console.error(\"Failed to update Auth email:\", error);\r\n            throw new Error(\"Failed to update email address in Auth system.\");\r\n        }\r\n    }\r\n\r\n    if (Object.keys(profileUpdates).length > 0) {\r\n        updates.profileData = { ...currentUserData?.profileData, ...profileUpdates };\r\n    }\r\n\r\n    if (Object.keys(updates).length > 0) {\r\n        await adminDb.collection(\"users\").doc(userId).update(updates);\r\n    }\r\n\r\n    await logAuditEvent(\"admin.update_profile\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName: updates.displayName || currentUserData?.displayName || \"Unknown\",\r\n        details: { changes: Object.keys(updates) }\r\n    });\r\n\r\n    revalidatePath('/admin');\r\n}\r\n\r\nexport async function updateUserRole(userId: string, newRole: 'admin' | 'member') {\r\n    const admin = await getUserProfile()\r\n    if (admin?.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\")\r\n    }\r\n\r\n    if (userId === admin.uid) {\r\n        throw new Error(\"Cannot change your own role\");\r\n    }\r\n\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    if (!userDoc.exists) throw new Error(\"User not found\");\r\n    const userData = userDoc.data();\r\n\r\n    await adminDb.collection(\"users\").doc(userId).update({ role: newRole });\r\n\r\n    const rawName = userData?.displayName;\r\n    const targetName = (rawName && rawName !== \"Family Member\") ? rawName : (userData?.email || \"Unknown\");\r\n\r\n    await logAuditEvent(\"admin.update_role\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName,\r\n        details: { oldRole: userData?.role, newRole }\r\n    });\r\n\r\n    revalidatePath('/admin');\r\n}\r\n\r\nexport async function softDeleteUser(userId: string) {\r\n    const admin = await getUserProfile()\r\n    if (admin?.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\")\r\n    }\r\n\r\n    if (userId === admin.uid) {\r\n        throw new Error(\"Cannot delete yourself\");\r\n    }\r\n\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    if (!userDoc.exists) throw new Error(\"User not found\");\r\n    const userData = userDoc.data();\r\n\r\n    // Soft delete: set deletedAt and disable account\r\n    await adminDb.collection(\"users\").doc(userId).update({\r\n        deletedAt: new Date().toISOString(),\r\n        isActive: false // Automatically disable on delete\r\n    });\r\n\r\n    // Also disable in Auth to prevent login immediately\r\n    try {\r\n        const { getAuth } = await import('firebase-admin/auth');\r\n        await getAuth().updateUser(userId, { disabled: true });\r\n    } catch (e) {\r\n        console.error(\"Failed to disable Auth user:\", e);\r\n    }\r\n\r\n    const rawName = userData?.displayName;\r\n    const targetName = (rawName && rawName !== \"Family Member\") ? rawName : (userData?.email || \"Unknown\");\r\n\r\n    await logAuditEvent(\"admin.soft_delete_user\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName,\r\n    });\r\n\r\n    revalidatePath('/admin');\r\n}\r\n\r\nexport async function restoreUser(userId: string) {\r\n    const admin = await getUserProfile()\r\n    if (admin?.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\")\r\n    }\r\n\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    if (!userDoc.exists) throw new Error(\"User not found\");\r\n    const userData = userDoc.data();\r\n\r\n    // Restore: clear deletedAt and re-enable account\r\n    await adminDb.collection(\"users\").doc(userId).update({\r\n        deletedAt: null, // removing field or setting to null\r\n        isActive: true\r\n    });\r\n\r\n    // Re-enable in Auth\r\n    try {\r\n        const { getAuth } = await import('firebase-admin/auth');\r\n        await getAuth().updateUser(userId, { disabled: false });\r\n    } catch (e) {\r\n        console.error(\"Failed to enable Auth user:\", e);\r\n    }\r\n\r\n    const rawName = userData?.displayName;\r\n    const targetName = (rawName && rawName !== \"Family Member\") ? rawName : (userData?.email || \"Unknown\");\r\n\r\n    await logAuditEvent(\"admin.restore_user\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName,\r\n    });\r\n\r\n    revalidatePath('/admin');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\ai-agents.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cosineSimilarity' is defined but never used.","line":39,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3211,3214],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3211,3214],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4904,4907],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4904,4907],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":157,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6484,6487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6484,6487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":167,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7044,7047],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7044,7047],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":244,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10470,10473],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10470,10473],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":248,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":248,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10564,10567],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10564,10567],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":313,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":313,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13433,13436],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13433,13436],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":314,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":314,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13506,13509],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13506,13509],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport OpenAI from \"openai\";\r\nimport Anthropic from \"@anthropic-ai/sdk\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { queryVectors, upsertVectors } from \"@/lib/vector-db\";\r\n\r\n// ------------------------------------------------------------------\r\n// ü§ñ Agent Definitions\r\n// ------------------------------------------------------------------\r\n\r\nimport type { AgentMode, AIModel } from \"@/types/ai\";\r\nimport { AGENT_MODES_PROMPTS } from \"@/lib/prompts/agentic-voice\";\r\n\r\n// ------------------------------------------------------------------\r\n// ü§ñ Agent Definitions\r\n// ------------------------------------------------------------------\r\n\r\nconst AGENT_PERSONAS: Record<AgentMode, string> = AGENT_MODES_PROMPTS;\r\n\r\n// ------------------------------------------------------------------\r\n// üß† RAG & Similarity Search (Shared)\r\n// ------------------------------------------------------------------\r\n\r\nasync function generateEmbedding(text: string) {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) throw new Error(\"OpenAI API Key is missing\");\r\n    const openai = new OpenAI({ apiKey });\r\n\r\n    const response = await openai.embeddings.create({\r\n        model: \"text-embedding-3-small\",\r\n        input: text,\r\n        encoding_format: \"float\",\r\n        dimensions: 512, // Match Pinecone index configuration\r\n    });\r\n    return response.data[0].embedding;\r\n}\r\n\r\nfunction cosineSimilarity(vecA: number[], vecB: number[]) {\r\n    let dotProduct = 0;\r\n    let normA = 0;\r\n    let normB = 0;\r\n    for (let i = 0; i < vecA.length; i++) {\r\n        dotProduct += vecA[i] * vecB[i];\r\n        normA += vecA[i] * vecA[i];\r\n        normB += vecB[i] * vecB[i];\r\n    }\r\n    return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));\r\n}\r\n\r\n// ------------------------------------------------------------------\r\n// üöÄ Main Interaction Function\r\n// ------------------------------------------------------------------\r\n\r\n// ------------------------------------------------------------------\r\n// üîç Tavily Search Integration\r\n// ------------------------------------------------------------------\r\n\r\nasync function searchTavily(query: string) {\r\n    const apiKey = process.env.TAVILY_API_KEY;\r\n    if (!apiKey) {\r\n        console.warn(\"Tavily API Key missing\");\r\n        return \"Search functionality is currently unavailable (Missing API Key).\";\r\n    }\r\n\r\n    try {\r\n        console.log(`üîç Performing Tavily Search for: \"${query}\"`);\r\n        const response = await fetch(\"https://api.tavily.com/search\", {\r\n            method: \"POST\",\r\n            headers: {\r\n                \"Content-Type\": \"application/json\"\r\n            },\r\n            body: JSON.stringify({\r\n                api_key: apiKey,\r\n                query: query,\r\n                search_depth: \"basic\",\r\n                include_answer: true,\r\n                max_results: 5,\r\n                include_images: false\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`Tavily API Error: ${response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        // Return a summarized version to save tokens\r\n        const results = data.results?.map((r: any) => `[${r.title}](${r.url}): ${r.content}`).join(\"\\n\\n\") || \"\";\r\n        const answer = data.answer ? `Direct Answer: ${data.answer}\\n\\n` : \"\";\r\n\r\n        return `${answer}Search Results:\\n${results}`.trim() || \"No relevant results found.\";\r\n\r\n    } catch (error) {\r\n        console.error(\"Tavily Search Error:\", error);\r\n        return \"An error occurred while searching the internet.\";\r\n    }\r\n}\r\n\r\n// ------------------------------------------------------------------\r\n// üöÄ Main Interaction Function\r\n// ------------------------------------------------------------------\r\n\r\nexport async function chatWithAgent(\r\n    userMessage: string,\r\n    mode: AgentMode = \"general\",\r\n    model: AIModel = \"gpt-4o\",\r\n    attachments: { url: string; type: 'image' | 'file' }[] = [],\r\n    previousMessages: { role: 'user' | 'assistant', content: string }[] = []\r\n) {\r\n    try {\r\n        console.log(`ü§ñ AI Agent Activated: [${mode.toUpperCase()}] using [${model}] with [${attachments.length}] attachments`);\r\n\r\n        // 1. Get RAG Context using Vector Database (Pinecone)\r\n        let contextText = \"\";\r\n        if (attachments.length === 0) {\r\n            try {\r\n                const userEmbedding = await generateEmbedding(userMessage);\r\n\r\n                // Query vector database for relevant knowledge\r\n                const results = await queryVectors(\r\n                    'knowledge',\r\n                    userEmbedding,\r\n                    3, // top 3 results\r\n                    undefined,\r\n                    0.7 // minimum similarity score\r\n                );\r\n\r\n                if (results.length > 0) {\r\n                    contextText = results\r\n                        .map((r: any) => `[Knowledge: ${r.metadata.title || 'Reference'}]: ${r.metadata.content}`)\r\n                        .join(\"\\n\\n\");\r\n                    console.log(`üìö Found ${results.length} relevant knowledge items`);\r\n                }\r\n            } catch (error) {\r\n                console.warn('Vector DB query failed, continuing without context:', error);\r\n                // Graceful degradation - continue without RAG context\r\n            }\r\n        }\r\n\r\n        // 2. Select Persona\r\n        const systemPrompt = AGENT_PERSONAS[mode] || AGENT_PERSONAS.general;\r\n        const fullSystemMessage = systemPrompt +\r\n            \"\\n\\nYou have access to the internet via the 'search_internet' tool. USE IT FREQUENTLY for current events, sports, weather, news, or any question requiring up-to-date information.\" +\r\n            (contextText ? `\\n\\nKnowledge Base Context:\\n${contextText}` : \"\");\r\n\r\n        // 3. Dispatch to Model\r\n        if (model.startsWith(\"claude\")) {\r\n            // ... (Claude Implementation kept similar but simplified for now - No tools implementation for Claude in this pass unless requested)\r\n            // For brevity, falling back to simple text for Claude as user seems focused on \"Tavily\" which implies a tool use flow often paired with GPT.\r\n\r\n            const anthropicKey = process.env.ANTHROPIC_API_KEY;\r\n            if (!anthropicKey) throw new Error(\"Anthropic API Key is missing\");\r\n            const anthropic = new Anthropic({ apiKey: anthropicKey });\r\n\r\n            // Construct Message with Content Blocks\r\n            const messageContent: any[] = [{ type: \"text\", text: userMessage }];\r\n\r\n            if (attachments.length > 0) {\r\n                return \"Image analysis is currently optimized for GPT-4o. Please switch models to GPT-4o to analyze this image!\";\r\n            }\r\n\r\n            // Convert previous messages to Anthropic format\r\n            const history = previousMessages.map(msg => ({\r\n                role: msg.role === 'user' ? 'user' : 'assistant', // Map 'system' if present? Anthropic doesn't support system in messages\r\n                content: msg.content\r\n            })) as any[];\r\n\r\n            const response = await anthropic.messages.create({\r\n                model: \"claude-3-5-sonnet-20240620\",\r\n                max_tokens: 1024,\r\n                system: fullSystemMessage,\r\n                messages: [\r\n                    ...history,\r\n                    { role: \"user\", content: messageContent }\r\n                ]\r\n            });\r\n\r\n            const contentBlock = response.content[0];\r\n            if (contentBlock.type === 'text') {\r\n                return contentBlock.text;\r\n            }\r\n            return \"I couldn't process the response.\";\r\n\r\n        } else if (model.startsWith(\"gemini\")) {\r\n            // ... (Gemini Implementation - Keeping basic for now)\r\n            const googleKey = process.env.GOOGLE_GENERATIVE_AI_API_KEY;\r\n            if (!googleKey) throw new Error(\"Google API Key is missing\");\r\n            const genAI = new GoogleGenerativeAI(googleKey);\r\n            const geminiModel = genAI.getGenerativeModel({ model: model });\r\n\r\n            if (attachments.length > 0) {\r\n                return \"Image analysis is currently optimized for GPT-4o. Please switch models to GPT-4o to analyze this image!\";\r\n            }\r\n\r\n            // Convert hisotry\r\n            const history = previousMessages.map(msg => ({\r\n                role: msg.role === 'user' ? 'user' : 'model',\r\n                parts: [{ text: msg.content }]\r\n            }));\r\n\r\n            const chat = geminiModel.startChat({\r\n                history: [\r\n                    { role: \"user\", parts: [{ text: fullSystemMessage }] }, // Seed system prompt as first user message? Or Gemini system instruction\r\n                    { role: \"model\", parts: [{ text: \"Understood. I am ready to assist.\" }] },\r\n                    ...history\r\n                ],\r\n            });\r\n\r\n            const result = await chat.sendMessage(userMessage);\r\n            const response = result.response;\r\n            return response.text();\r\n\r\n        } else {\r\n            // --- OPENAI (GPT-4o, o1, etc) ---\r\n            const apiKey = process.env.OPENAI_API_KEY;\r\n            if (!apiKey) throw new Error(\"OpenAI API Key is missing\");\r\n            const openai = new OpenAI({ apiKey });\r\n\r\n            // Define Tools\r\n            const tools: OpenAI.Chat.Completions.ChatCompletionTool[] = [\r\n                {\r\n                    type: \"function\",\r\n                    function: {\r\n                        name: \"search_internet\",\r\n                        description: \"Search the internet for real-time information, current events, sports scores, news, weather, etc.\",\r\n                        parameters: {\r\n                            type: \"object\",\r\n                            properties: {\r\n                                query: {\r\n                                    type: \"string\",\r\n                                    description: \"The search query, e.g. 'Who won the Super Bowl 2024' or 'Weather in New York'\",\r\n                                },\r\n                            },\r\n                            required: [\"query\"],\r\n                        },\r\n                    },\r\n                },\r\n            ];\r\n\r\n            // Build Messages\r\n            const messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[] = [\r\n                { role: \"system\", content: fullSystemMessage },\r\n                ...previousMessages.map(msg => ({ role: msg.role, content: msg.content } as any)),\r\n            ];\r\n\r\n            // Current User Message\r\n            const userContent: any[] = [{ type: \"text\", text: userMessage }];\r\n            attachments.forEach(att => {\r\n                if (att.type === 'image') {\r\n                    userContent.push({\r\n                        type: \"image_url\",\r\n                        image_url: { url: att.url, detail: \"high\" }\r\n                    });\r\n                }\r\n            });\r\n            messages.push({ role: \"user\", content: userContent });\r\n\r\n            // 1st Call to OpenAI\r\n            const response = await openai.chat.completions.create({\r\n                model: model.startsWith(\"o1\") ? \"gpt-4o\" : model, // o1 preview doesn't support tools yet properly in some tiers, safe fallback or specific handling\r\n                messages: messages,\r\n                temperature: mode === \"executive\" ? 0.3 : 0.7,\r\n                tools: tools,\r\n                tool_choice: \"auto\",\r\n            });\r\n\r\n            const responseMessage = response.choices[0].message;\r\n\r\n            // Check for Tool Calls\r\n            if (responseMessage.tool_calls) {\r\n                // Return intermediate thought?? Or just process?\r\n                // Append the assistant's request to the conversation\r\n                messages.push(responseMessage);\r\n\r\n                // Process each tool call\r\n                // Process each tool call\r\n                for (const toolCall of responseMessage.tool_calls) {\r\n                    if (toolCall.type === 'function' && toolCall.function.name === \"search_internet\") {\r\n                        const args = JSON.parse(toolCall.function.arguments);\r\n                        const searchResult = await searchTavily(args.query);\r\n\r\n                        messages.push({\r\n                            tool_call_id: toolCall.id,\r\n                            role: \"tool\",\r\n                            content: searchResult,\r\n                        });\r\n                    }\r\n                }\r\n\r\n                // 2nd Call to OpenAI (with tool outputs)\r\n                const secondResponse = await openai.chat.completions.create({\r\n                    model: model.startsWith(\"o1\") ? \"gpt-4o\" : model,\r\n                    messages: messages,\r\n                });\r\n\r\n                return secondResponse.choices[0].message.content;\r\n            }\r\n\r\n            return responseMessage.content;\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error(`Error in chatWithAgent (${mode}/${model}):`, error);\r\n        // Log more details for debugging\r\n        if (error instanceof Error) {\r\n            console.error('Error name:', error.name);\r\n            console.error('Error message:', error.message);\r\n            console.error('Error stack:', error.stack);\r\n        }\r\n        // Check if it's an OpenAI API error\r\n        if (typeof error === 'object' && error !== null && 'status' in error) {\r\n            console.error('API Error status:', (error as any).status);\r\n            console.error('API Error details:', (error as any).message);\r\n        }\r\n        return \"I'm having trouble connecting to my neural core. Please try again in a moment. üß†\";\r\n    }\r\n}\r\n\r\n// ------------------------------------------------------------------\r\n// üå± Seeding Utility\r\n// ------------------------------------------------------------------\r\n\r\nexport async function seedKnowledgeBase() {\r\n    const knowledgeData = [\r\n        {\r\n            title: \"About Famio\",\r\n            content: \"Famio is a private, secure social platform built exclusively for families. It allows you to share moments, plan events, and stay connected with the people who matter most. It is powered by ChanceTEK.\"\r\n        },\r\n        {\r\n            title: \"Multi-Modal AI Agents\",\r\n            content: \"Famio Universal Intelligence offers specialized AI modes: 1) General (Helpful Assistant), 2) Tutor (Explains simply for kids/students), 3) Executive (Concise summaries for busy pros), 4) Biographer (Interviews you to save memories), 5) Architect (Technical details).\"\r\n        },\r\n        {\r\n            title: \"Magic Draft\",\r\n            content: \"Found in the 'Create Post' box, the Magic Draft button (wand icon) uses AI to instantly write warm, engaging social media posts for you. You just type a rough idea, and it polishes it into a publish-ready message.\"\r\n        },\r\n        {\r\n            title: \"Ask AI (Contextual)\",\r\n            content: \"On any post in the feed, you can click the Share menu and select 'Ask AI about this...'. This opens the AI Assistant with the post's content pre-loaded, allowing you to ask for summaries, explanations, or translations of that specific post.\"\r\n        },\r\n        {\r\n            title: \"Biographer & Legacy Building\",\r\n            content: \"The 'Record Memory' button on your Profile page launches the Biographer Agent. It conducts a friendly interview to help you capture important life stories. These memories are preserved as part family legacy.\"\r\n        },\r\n        {\r\n            title: \"Branding Pages\",\r\n            content: \"The Branding feature allows businesses, public figures, and organizations to create official pages. Users can follow Brands to see their updates. Brands are separate from personal profiles and have their own followers.\"\r\n        },\r\n        {\r\n            title: \"Live Broadcasts\",\r\n            content: \"Famio Live allows you to stream video in real-time to your family. You can start a broadcast from the 'Live' tab. Viewers can chat in real-time. You can control privacy (Family Only vs Public) before starting.\"\r\n        },\r\n        {\r\n            title: \"Privacy & Security\",\r\n            content: \"Famio uses End-to-End Encryption to keep data safe. Only members you approve can see your content. Features include 'Public Profile' toggle (default off) and strict owner-only deletion rights for gallery photos.\"\r\n        },\r\n        {\r\n            title: \"Stories\",\r\n            content: \"Stories are ephemeral photos or videos that disappear after 24 hours. You can upload them from the home tray. Videos autoplay muted but can be unmuted. You can see who viewed your story.\"\r\n        },\r\n        {\r\n            title: \"Groups\",\r\n            content: \"Groups allow for micro-communities (e.g., 'Cousins', 'Planning Committee'). You can join public groups or be invited to private ones. Groups have dedicated feeds and member lists.\"\r\n        },\r\n        {\r\n            title: \"Events\",\r\n            content: \"The Events feature lets you plan family gatherings. You can track RSVPs, see who is attending, and get reminders. Events appear on the main calendar.\"\r\n        },\r\n        {\r\n            title: \"Gallery\",\r\n            content: \"The Gallery organizes all your shared photos. IMPORTANT: Deleting a photo from the Gallery also deletes the original Post it was attached to. Only the owner of the photo can delete it.\"\r\n        },\r\n        {\r\n            title: \"Account & Settings\",\r\n            content: \"You can update your profile, change your display name, and manage privacy settings in the Settings page. Display Name is mandatory for all users.\"\r\n        }\r\n    ];\r\n\r\n    console.log(\"üå± Starting Knowledge Base Seed to Pinecone...\");\r\n\r\n    const vectors = [];\r\n\r\n    for (const item of knowledgeData) {\r\n        const embedding = await generateEmbedding(item.content);\r\n        vectors.push({\r\n            id: `knowledge_${item.title.toLowerCase().replace(/\\s+/g, '_').replace(/[^a-z0-9_]/g, '')}`,\r\n            values: embedding,\r\n            metadata: {\r\n                title: item.title,\r\n                content: item.content,\r\n                createdAt: new Date().toISOString()\r\n            }\r\n        });\r\n        console.log(`‚úÖ Prepared vector: ${item.title}`);\r\n    }\r\n\r\n    // Upsert to Pinecone 'knowledge' namespace\r\n    await upsertVectors('knowledge', vectors);\r\n\r\n    console.log(\"‚úÖ Knowledge Base Seeded Successfully to Pinecone!\");\r\n    return { success: true, count: knowledgeData.length };\r\n}\r\n\r\n// ------------------------------------------------------------------\r\n// ‚ú® Magic AI - User-Controlled Emotional Intelligence\r\n// ------------------------------------------------------------------\r\n\r\nimport type { EmotionalTone, MagicAIRequest, MagicAIResponse } from \"@/types/magic-ai\";\r\n\r\nconst TONE_PROMPTS: Record<EmotionalTone, string> = {\r\n    default: `You are helping a user write a warm, engaging social media post for their family platform.\r\n    \r\nGuidelines:\r\n- Keep it natural and conversational\r\n- Use emojis sparingly (1-3 max)\r\n- Stay under 280 characters\r\n- Maintain a balanced, family-friendly tone\r\n- Keep the original meaning and intent`,\r\n\r\n    enthusiastic: `You are helping a user write an ENTHUSIASTIC, high-energy social media post.\r\n    \r\nGuidelines:\r\n- Use exclamation points to show excitement!\r\n- Include celebratory emojis (üéâüéä‚ú®üåü)\r\n- Add energy words like \"amazing\", \"incredible\", \"awesome\"\r\n- Keep under 280 characters\r\n- Make it feel like a celebration!`,\r\n\r\n    positive_energy: `You are helping a user write an UPLIFTING, motivational social media post.\r\n    \r\nGuidelines:\r\n- Use encouraging, empowering language\r\n- Include positive emojis (‚ö°üí™üåü‚ú®)\r\n- Focus on growth, progress, and possibilities\r\n- Keep under 280 characters\r\n- Inspire and energize the reader`,\r\n\r\n    healing_energy: `You are helping a user write a GENTLE, compassionate social media post.\r\n    \r\nGuidelines:\r\n- Use soft, supportive language\r\n- Include calming emojis (üåøüíöüïäÔ∏è‚ú®)\r\n- Acknowledge emotions with empathy\r\n- Keep under 280 characters\r\n- Provide comfort and reassurance`,\r\n\r\n    sad: `You are helping a user write a REFLECTIVE, empathetic social media post.\r\n    \r\nGuidelines:\r\n- Honor difficult emotions respectfully\r\n- Use gentle, understanding language\r\n- Include thoughtful emojis (üíôüôè‚ú®)\r\n- Keep under 280 characters\r\n- Validate feelings without being overly heavy`,\r\n\r\n    professional: `You are helping a user write a POLISHED, professional social media post.\r\n    \r\nGuidelines:\r\n- Use clear, concise language\r\n- Minimal or no emojis (use sparingly if needed)\r\n- Focus on clarity and impact\r\n- Keep under 280 characters\r\n- Sound confident and competent`,\r\n\r\n    love: `You are helping a user write an AFFECTIONATE, heartfelt social media post.\r\n    \r\nGuidelines:\r\n- Use warm, loving language\r\n- Include heart emojis (‚ù§Ô∏èüíïüíñ‚ú®)\r\n- Express genuine care and appreciation\r\n- Keep under 280 characters\r\n- Make it feel personal and meaningful`,\r\n\r\n    grammar: `You are an expert editor polishing a social media post.\r\n    \r\nGuidelines:\r\n- Fix all grammar, spelling, and punctuation errors\r\n- Improve clarity and flow\r\n- Maintain the original voice and tone completely\r\n- Do NOT add emojis unless they were already there\r\n- Keep strictly to the original meaning`,\r\n\r\n    shorter: `You are an expert editor condensing a social media post.\r\n    \r\nGuidelines:\r\n- Make the text significantly shorter and punchier\r\n- Remove fluff and redundancy\r\n- Keep the core message intact\r\n- Use abbreviations if appropriate for social media\r\n- Stay under 140 characters if possible`,\r\n\r\n    longer: `You are a creative writer expanding a social media post.\r\n    \r\nGuidelines:\r\n- Add descriptive details and context\r\n- Expand on the core ideas\r\n- Make it more engaging and immersive\r\n- Keep the tone natural\r\n- Stay under 500 characters`,\r\n\r\n    witty: `You are a comedy writer making a social media post funny.\r\n    \r\nGuidelines:\r\n- Add clever wordplay, puns, or observational humor\r\n- Make it sound sharp and intelligent\r\n- Use a playful tone\r\n- Include 1-2 relevant funny emojis\r\n- Keep it family-friendly but amusing`,\r\n\r\n    storyteller: `You are a master storyteller formatting a social media post.\r\n    \r\nGuidelines:\r\n- Frame the content as a mini-narrative (Beginning, Middle, End)\r\n- Use evocative language\r\n- Create a sense of journey or realization\r\n- Use paragraph breaks for pacing\r\n- Make it feel like a \"story time\" moment`,\r\n\r\n    emotional_intelligence: `You are helping a user write an EMOTIONALLY INTELLIGENT social media post.\r\n    \r\nGuidelines:\r\n- Demonstrate awareness of emotional nuances and context\r\n- Use thoughtful, perceptive language that acknowledges feelings\r\n- Include reflective emojis (üß†üí≠üåü‚ú®)\r\n- Show empathy and emotional maturity\r\n- Keep under 280 characters\r\n- Balance emotion with insight`\r\n};\r\n\r\nexport async function generateMagicContent(request: MagicAIRequest): Promise<MagicAIResponse> {\r\n    try {\r\n        const { content, tone, context } = request;\r\n\r\n        if (!content.trim()) {\r\n            throw new Error(\"Content cannot be empty\");\r\n        }\r\n\r\n        // Select appropriate prompt based on tone\r\n        const systemPrompt = TONE_PROMPTS[tone];\r\n\r\n        // Build context-aware user message\r\n        let contextPrefix = \"\";\r\n        if (context?.type === 'group' && context.name) {\r\n            contextPrefix = `[Context: Posting in group \"${context.name}\"] `;\r\n        } else if (context?.type === 'branding' && context.name) {\r\n            contextPrefix = `[Context: Posting as brand \"${context.name}\"] `;\r\n        }\r\n\r\n        const userMessage = `${contextPrefix}Transform this into a ${tone === 'default' ? 'warm, engaging' : tone.replace('_', ' ')} post:\\n\\n\"${content}\"`;\r\n\r\n        // Call AI with appropriate tone\r\n        const enhancedContent = await chatWithAgent(\r\n            userMessage,\r\n            'general',\r\n            'gpt-4o-mini', // Use mini for faster responses\r\n            [],\r\n            [{ role: 'user', content: systemPrompt }]\r\n        );\r\n\r\n        return {\r\n            enhancedContent: enhancedContent || content,\r\n            tone,\r\n            originalContent: content,\r\n            timestamp: new Date().toISOString(),\r\n            characterCount: enhancedContent?.length || 0\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error('Magic AI generation error:', error);\r\n        throw new Error('Failed to generate enhanced content. Please try again.');\r\n    }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\ai-chat-enhanced.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'searchTavily' is defined but never used.","line":15,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1442,1445],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1442,1445],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Enhanced Chat with Agent - With LLM Failover, Memory, and Streaming Support\r\n */\r\n\r\n'use server';\r\n\r\nimport { AgentMode, AIModel, ConversationMessage } from '@/types/ai';\r\nimport {\r\n    getConversationHistory,\r\n    saveMessage\r\n} from '@/lib/memory-manager';\r\nimport { chatWithAgent as originalChatWithAgent } from './ai-agents';\r\n\r\n// Tavily search function (from ai-agents.ts)\r\nasync function searchTavily(query: string) {\r\n    const apiKey = process.env.TAVILY_API_KEY;\r\n    if (!apiKey) {\r\n        console.warn('Tavily API Key missing');\r\n        return 'Search functionality is currently unavailable (Missing API Key).';\r\n    }\r\n\r\n    try {\r\n        console.log(`üîç Performing Tavily Search for: \"${query}\"`);\r\n        const response = await fetch('https://api.tavily.com/search', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({\r\n                api_key: apiKey,\r\n                query: query,\r\n                search_depth: 'basic',\r\n                include_answer: true,\r\n                max_results: 5,\r\n                include_images: false,\r\n            }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`Tavily API Error: ${response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        const results =\r\n            data.results\r\n                ?.map((r: any) => `[${r.title}](${r.url}): ${r.content}`)\r\n                .join('\\n\\n') || '';\r\n        const answer = data.answer ? `Direct Answer: ${data.answer}\\n\\n` : '';\r\n\r\n        return `${answer}Search Results:\\n${results}`.trim() || 'No relevant results found.';\r\n    } catch (error: unknown) {\r\n        console.error('Tavily Search Error:', error);\r\n        return 'An error occurred while searching the internet.';\r\n    }\r\n}\r\n\r\n/**\r\n * Enhanced chat function with automatic LLM failover\r\n */\r\nexport async function chatWithAgentEnhanced(\r\n    userMessage: string,\r\n    userId: string,\r\n    conversationId: string,\r\n    mode: AgentMode = 'general',\r\n    model: AIModel = 'gpt-4o',\r\n    memoryEnabled: boolean = true\r\n): Promise<{\r\n    response: string;\r\n    model: string;\r\n    responseTimeMs: number;\r\n    failedOver: boolean;\r\n}> {\r\n    const startTime = Date.now();\r\n    const timeout = Number(process.env.AI_RESPONSE_TIMEOUT_MS) || 8000;\r\n    let failedOver = false;\r\n    let actualModel = model;\r\n\r\n    try {\r\n        // 1. Get conversation history if memory enabled\r\n        let previousMessages: ConversationMessage[] = [];\r\n        if (memoryEnabled) {\r\n            previousMessages = await getConversationHistory(userId, conversationId, 10);\r\n        }\r\n\r\n        // 2. Try primary model (OpenAI)\r\n        let response: string;\r\n        try {\r\n            const timeoutPromise = new Promise<string>((_, reject) =>\r\n                setTimeout(() => reject(new Error('Timeout')), timeout)\r\n            );\r\n\r\n            const chatPromise = originalChatWithAgent(\r\n                userMessage,\r\n                mode,\r\n                model,\r\n                [],\r\n                previousMessages\r\n                    .filter((m) => m.role === 'user' || m.role === 'assistant')\r\n                    .map((m) => ({ role: m.role as 'user' | 'assistant', content: m.content }))\r\n            );\r\n\r\n            const result = await Promise.race([chatPromise, timeoutPromise]);\r\n            response = result || 'I apologize, but I was unable to generate a response.';\r\n        } catch (primaryError: unknown) {\r\n            // Check if error is timeout or API failure\r\n            if (\r\n                primaryError instanceof Error && (\r\n                    primaryError.message === 'Timeout' ||\r\n                    (primaryError as Error & { status?: number; code?: string }).status === 429 ||\r\n                    (primaryError as Error & { code?: string }).code === 'rate_limit_exceeded' ||\r\n                    (primaryError as Error & { code?: string }).code === 'server_error'\r\n                )\r\n            ) {\r\n                console.warn(`‚ö†Ô∏è Primary model failed (${model}), failing over to Claude...`);\r\n                failedOver = true;\r\n                actualModel = 'claude-3-5-sonnet-20240620';\r\n\r\n                // Failover to Claude\r\n                const fallbackResult = await originalChatWithAgent(\r\n                    userMessage,\r\n                    mode,\r\n                    actualModel as AIModel,\r\n                    [],\r\n                    previousMessages\r\n                        .filter((m) => m.role === 'user' || m.role === 'assistant')\r\n                        .map((m) => ({ role: m.role as 'user' | 'assistant', content: m.content }))\r\n                );\r\n                response = fallbackResult || 'I apologize, but I was unable to generate a response.';\r\n            } else {\r\n                throw primaryError;\r\n            }\r\n        }\r\n\r\n        // 3. Save messages to memory\r\n        if (memoryEnabled) {\r\n            await saveMessage(\r\n                userId,\r\n                conversationId,\r\n                {\r\n                    role: 'user',\r\n                    content: userMessage,\r\n                    timestamp: new Date(),\r\n                },\r\n                mode,\r\n                memoryEnabled\r\n            );\r\n\r\n            await saveMessage(\r\n                userId,\r\n                conversationId,\r\n                {\r\n                    role: 'assistant',\r\n                    content: response,\r\n                    timestamp: new Date(),\r\n                    metadata: {\r\n                        model: actualModel,\r\n                        responseTime: Date.now() - startTime,\r\n                    },\r\n                },\r\n                mode,\r\n                memoryEnabled\r\n            );\r\n        }\r\n\r\n        const responseTimeMs = Date.now() - startTime;\r\n        console.log(\r\n            `‚úÖ Response generated in ${responseTimeMs}ms using ${actualModel}${failedOver ? ' (failover)' : ''}`\r\n        );\r\n\r\n        return {\r\n            response,\r\n            model: actualModel,\r\n            responseTimeMs,\r\n            failedOver,\r\n        };\r\n    } catch (error: unknown) {\r\n        console.error('Error in chatWithAgentEnhanced:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Generate a conversation title from the first user message\r\n */\r\nexport async function generateConversationTitle(\r\n    firstMessage: string\r\n): Promise<string> {\r\n    // Simple extraction: take first 50 chars or first sentence\r\n    const title = firstMessage\r\n        .split(/[.!?]/)[0]\r\n        .trim()\r\n        .substring(0, 50);\r\n    return title + (firstMessage.length > 50 ? '...' : '');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\ai-chat.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":64,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":97,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":97,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { AgentMode } from \"@/types/ai\";\r\n\r\nexport interface AIConversation {\r\n    id: string;\r\n    userId: string;\r\n    title: string;\r\n    createdAt: Date;\r\n    updatedAt: Date;\r\n    isDeleted: boolean;\r\n    lastMessage?: string;\r\n    mode?: AgentMode;\r\n    model?: string;\r\n}\r\n\r\nexport interface AIMessage {\r\n    id: string;\r\n    role: 'user' | 'assistant';\r\n    content: string;\r\n    createdAt: Date;\r\n}\r\n\r\n/**\r\n * Create a new conversation\r\n */\r\nexport async function createConversation(initialMessage?: string, mode: AgentMode = 'general', model: string = 'gpt-4o'): Promise<string> {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const title = initialMessage ? initialMessage.slice(0, 50) + (initialMessage.length > 50 ? \"...\" : \"\") : \"New Conversation\";\r\n\r\n    const docRef = await adminDb.collection(\"ai_conversations\").add({\r\n        userId: user.id,\r\n        title,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n        updatedAt: FieldValue.serverTimestamp(),\r\n        isDeleted: false,\r\n        lastMessage: initialMessage || \"\",\r\n        mode,\r\n        model\r\n    });\r\n\r\n    return docRef.id;\r\n}\r\n\r\n/**\r\n * Get active conversations for the current user\r\n */\r\nexport async function getConversations(): Promise<AIConversation[]> {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    let snapshot;\r\n    try {\r\n        snapshot = await adminDb.collection(\"ai_conversations\")\r\n            .where(\"userId\", \"==\", user.id)\r\n            .where(\"isDeleted\", \"==\", false)\r\n            .orderBy(\"updatedAt\", \"desc\")\r\n            .get();\r\n    } catch (error) {\r\n        console.warn(\"Index missing for getConversations, falling back to unordered query\");\r\n        snapshot = await adminDb.collection(\"ai_conversations\")\r\n            .where(\"userId\", \"==\", user.id)\r\n            .where(\"isDeleted\", \"==\", false)\r\n            .get();\r\n    }\r\n\r\n    const conversations = snapshot.docs.map(doc => ({\r\n        id: doc.id,\r\n        ...doc.data(),\r\n        createdAt: doc.data().createdAt?.toDate() || new Date(),\r\n        updatedAt: doc.data().updatedAt?.toDate() || new Date(),\r\n    })) as AIConversation[];\r\n\r\n    // Ensure sorted if fallback was used\r\n    return conversations.sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime());\r\n}\r\n\r\n/**\r\n * Get trashed conversations for recovery\r\n */\r\nexport async function getTrash(): Promise<AIConversation[]> {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    let snapshot;\r\n    try {\r\n        snapshot = await adminDb.collection(\"ai_conversations\")\r\n            .where(\"userId\", \"==\", user.id)\r\n            .where(\"isDeleted\", \"==\", true)\r\n            .orderBy(\"updatedAt\", \"desc\")\r\n            .get();\r\n    } catch (error) {\r\n        console.warn(\"Index missing for getTrash, falling back to unordered query\");\r\n        snapshot = await adminDb.collection(\"ai_conversations\")\r\n            .where(\"userId\", \"==\", user.id)\r\n            .where(\"isDeleted\", \"==\", true)\r\n            .get();\r\n    }\r\n\r\n    const trash = snapshot.docs.map(doc => ({\r\n        id: doc.id,\r\n        ...doc.data(),\r\n        createdAt: doc.data().createdAt?.toDate() || new Date(),\r\n        updatedAt: doc.data().updatedAt?.toDate() || new Date(),\r\n    })) as AIConversation[];\r\n\r\n    return trash.sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime());\r\n}\r\n\r\n/**\r\n * Save a message to a conversation\r\n */\r\nexport async function saveMessage(conversationId: string, role: 'user' | 'assistant', content: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    // Verify ownership\r\n    const convRef = adminDb.collection(\"ai_conversations\").doc(conversationId);\r\n    const conv = await convRef.get();\r\n\r\n    if (!conv.exists || conv.data()?.userId !== user.id) {\r\n        throw new Error(\"Conversation not found or unauthorized\");\r\n    }\r\n\r\n    // Add message to subcollection\r\n    await convRef.collection(\"messages\").add({\r\n        role,\r\n        content,\r\n        createdAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    // Update conversation metadata\r\n    await convRef.update({\r\n        updatedAt: FieldValue.serverTimestamp(),\r\n        lastMessage: content.slice(0, 100)\r\n    });\r\n}\r\n\r\n/**\r\n * Get messages for a conversation\r\n */\r\nexport async function getMessages(conversationId: string): Promise<AIMessage[]> {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const convRef = adminDb.collection(\"ai_conversations\").doc(conversationId);\r\n    const conv = await convRef.get();\r\n\r\n    if (!conv.exists || conv.data()?.userId !== user.id) {\r\n        throw new Error(\"Conversation not found or unauthorized\");\r\n    }\r\n\r\n    const snapshot = await convRef.collection(\"messages\")\r\n        .orderBy(\"createdAt\", \"asc\")\r\n        .get();\r\n\r\n    return snapshot.docs.map(doc => ({\r\n        id: doc.id,\r\n        role: doc.data().role,\r\n        content: doc.data().content,\r\n        createdAt: doc.data().createdAt?.toDate() || new Date()\r\n    }));\r\n}\r\n\r\n/**\r\n * Soft delete (move to trash)\r\n */\r\nexport async function softDeleteConversation(conversationId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const convRef = adminDb.collection(\"ai_conversations\").doc(conversationId);\r\n    const conv = await convRef.get();\r\n\r\n    if (!conv.exists || conv.data()?.userId !== user.id) {\r\n        throw new Error(\"Conversation not found or unauthorized\");\r\n    }\r\n\r\n    await convRef.update({\r\n        isDeleted: true,\r\n        updatedAt: FieldValue.serverTimestamp()\r\n    });\r\n}\r\n\r\n/**\r\n * Restore from trash\r\n */\r\nexport async function restoreConversation(conversationId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const convRef = adminDb.collection(\"ai_conversations\").doc(conversationId);\r\n    const conv = await convRef.get();\r\n\r\n    if (!conv.exists || conv.data()?.userId !== user.id) {\r\n        throw new Error(\"Conversation not found or unauthorized\");\r\n    }\r\n\r\n    await convRef.update({\r\n        isDeleted: false,\r\n        updatedAt: FieldValue.serverTimestamp()\r\n    });\r\n}\r\n\r\n/**\r\n * Permanently delete\r\n */\r\nexport async function permanentlyDeleteConversation(conversationId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const convRef = adminDb.collection(\"ai_conversations\").doc(conversationId);\r\n    const conv = await convRef.get();\r\n\r\n    if (!conv.exists || conv.data()?.userId !== user.id) {\r\n        throw new Error(\"Conversation not found or unauthorized\");\r\n    }\r\n\r\n    // Delete subcollection messages (batch delete)\r\n    const messages = await convRef.collection(\"messages\").get();\r\n    const batch = adminDb.batch();\r\n\r\n    messages.docs.forEach(doc => {\r\n        batch.delete(doc.ref);\r\n    });\r\n\r\n    batch.delete(convRef);\r\n    await batch.commit();\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\ai.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5197,5200],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5197,5200],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":151,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5398,5401],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5398,5401],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":157,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5585,5588],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5585,5588],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":157,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5593,5596],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5593,5596],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":160,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5730,5733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5730,5733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":163,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":163,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5836,5839],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5836,5839],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport OpenAI from \"openai\";\r\n\r\n// Helper to get client only when needed\r\nfunction getClient() {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n        throw new Error(\"OpenAI API Key is missing\");\r\n    }\r\n    return new OpenAI({ apiKey });\r\n}\r\n\r\nexport async function generatePostContent(prompt: string) {\r\n    try {\r\n        const apiKey = process.env.OPENAI_API_KEY;\r\n        console.log(\"AI Action: Checking API Key...\", apiKey ? \"Present\" : \"Missing\");\r\n\r\n        if (!apiKey) {\r\n            throw new Error(\"OpenAI API Key is missing\");\r\n        }\r\n\r\n        const openai = getClient();\r\n        const response = await openai.chat.completions.create({\r\n            model: \"gpt-4o\",\r\n            messages: [\r\n                {\r\n                    role: \"system\",\r\n                    content: \"You are a helpful assistant for a family social media app. Write a warm, engaging, and family-friendly post caption based on the user's input. Keep it under 280 characters if possible, but prioritize natural tone. Add emojis where appropriate.\"\r\n                },\r\n                {\r\n                    role: \"user\",\r\n                    content: `Write a post regarding: ${prompt}`\r\n                }\r\n            ],\r\n            temperature: 0.7,\r\n        });\r\n\r\n        return response.choices[0].message.content || \"\";\r\n    } catch (error) {\r\n        console.error(\"OpenAI Error Details:\", error);\r\n        throw new Error(\"Failed to generate content. See server logs.\");\r\n    }\r\n}\r\n\r\nexport async function generateCommentSuggestion(postContext: string) {\r\n    try {\r\n        const openai = getClient();\r\n        const response = await openai.chat.completions.create({\r\n            model: \"gpt-4o\",\r\n            messages: [\r\n                {\r\n                    role: \"system\",\r\n                    content: \"You are a helpful assistant for a family social media app. Write a short, positive, and supportive comment in response to a post. Keep it casual and friendly. Max 1-2 sentences. Add an emoji.\"\r\n                },\r\n                {\r\n                    role: \"user\",\r\n                    content: `The post says: \"${postContext}\". Write a nice comment.`\r\n                }\r\n            ],\r\n            temperature: 0.7,\r\n        });\r\n\r\n        return response.choices[0].message.content || \"\";\r\n    } catch (error) {\r\n        console.error(\"OpenAI Error:\", error);\r\n        throw new Error(\"Failed to generate comment. Check API Key.\");\r\n    }\r\n}\r\n\r\nexport async function generateBirthdayWish(name: string) {\r\n    try {\r\n        const openai = getClient();\r\n        const response = await openai.chat.completions.create({\r\n            model: \"gpt-4o\",\r\n            messages: [\r\n                {\r\n                    role: \"system\",\r\n                    content: \"You are a warm, loving member writing a short, heartwarming birthday wish. Use emojis. keep it under 50 words. Be festive!\"\r\n                },\r\n                {\r\n                    role: \"user\",\r\n                    content: `Write a birthday wish for ${name}.`\r\n                }\r\n            ],\r\n            temperature: 0.8,\r\n        });\r\n\r\n        return response.choices[0].message.content || `Happy Birthday ${name}! üéÇ`;\r\n        return response.choices[0].message.content || `Happy Birthday ${name}! üéÇ`;\r\n    } catch (error) {\r\n        console.error(\"AI Error:\", error);\r\n        return `Happy Birthday ${name}! üéÇ`; // Fallback\r\n    }\r\n}\r\n\r\n// --- RAG & Vector Search Implementation ---\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\n\r\n// Helper: Cosine Similarity\r\nfunction cosineSimilarity(vecA: number[], vecB: number[]) {\r\n    let dotProduct = 0;\r\n    let normA = 0;\r\n    let normB = 0;\r\n    for (let i = 0; i < vecA.length; i++) {\r\n        dotProduct += vecA[i] * vecB[i];\r\n        normA += vecA[i] * vecA[i];\r\n        normB += vecB[i] * vecB[i];\r\n    }\r\n    return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));\r\n}\r\n\r\nexport async function generateEmbedding(text: string) {\r\n    const openai = getClient();\r\n    const response = await openai.embeddings.create({\r\n        model: \"text-embedding-3-small\",\r\n        input: text,\r\n        encoding_format: \"float\",\r\n    });\r\n    return response.data[0].embedding;\r\n}\r\n\r\nexport async function chatWithAI(userMessage: string) {\r\n    try {\r\n        const openai = getClient();\r\n\r\n        // 1. Embed the user's question\r\n        const userEmbedding = await generateEmbedding(userMessage);\r\n\r\n        // 2. Fetch Knowledge Base (For this scale, fetching all is fine ~10-20 docs)\r\n        // In production with 1000s of docs, use a real Vector DB like Pinecone or Firestore Vector Search extension\r\n        const snapshot = await adminDb.collection(\"knowledge_base\").get();\r\n\r\n        if (snapshot.empty) {\r\n            // Fallback if KB is empty\r\n            const completion = await openai.chat.completions.create({\r\n                model: \"gpt-4o\",\r\n                messages: [{ role: \"user\", content: userMessage }],\r\n            });\r\n            return completion.choices[0].message.content;\r\n        }\r\n\r\n        // 3. Perform Similarity Search in-memory\r\n        const docs = snapshot.docs.map((doc: any) => ({\r\n            content: doc.data().content,\r\n            embedding: doc.data().embedding,\r\n            metadata: doc.data().metadata\r\n        }));\r\n\r\n        const scoredDocs = docs.map((doc: any) => ({\r\n            ...doc,\r\n            score: cosineSimilarity(userEmbedding, doc.embedding)\r\n        }));\r\n\r\n        // Get Top 3 most relevant chunks\r\n        scoredDocs.sort((a: any, b: any) => b.score - a.score);\r\n        const topDocs = scoredDocs.slice(0, 3);\r\n\r\n        console.log(\"AI Context Found:\", topDocs.map((d: any) => d.metadata.title));\r\n\r\n        // 4. Generate Answer\r\n        const contextText = topDocs.map((d: any) => `[${d.metadata.title}]: ${d.content}`).join(\"\\n\\n\");\r\n\r\n        const systemPrompt = `You are the Famio AI Assistant, a helpful guide for the Famio Family Social Platform.\r\n        \r\n        Use the following context to answer the user's question. \r\n        If the answer is not in the context, use your general knowledge but mention you are not 100% sure about specific platform details.\r\n        Be warm, friendly, and concise. Use emojis.\r\n        \r\n        Context from Knowledge Base:\r\n        ${contextText}`;\r\n\r\n        const response = await openai.chat.completions.create({\r\n            model: \"gpt-4o\",\r\n            messages: [\r\n                { role: \"system\", content: systemPrompt },\r\n                { role: \"user\", content: userMessage }\r\n            ],\r\n            temperature: 0.5,\r\n        });\r\n\r\n        return response.choices[0].message.content;\r\n\r\n    } catch (error) {\r\n        console.error(\"Chat With AI Error:\", error);\r\n        return \"I'm having a little trouble thinking right now. Please try again later! ü§ñ\";\r\n    }\r\n}\r\n\r\n// --- Seeding Utility (Run once via a button or manually) ---\r\nexport async function seedKnowledgeBase() {\r\n    const knowledgeData = [\r\n        {\r\n            title: \"About Famio\",\r\n            content: \"Famio is a private, secure social platform built exclusively for families. It allows you to share moments, plan events, and stay connected with the people who matter most. It is powered by ChanceTEK.\"\r\n        },\r\n        {\r\n            title: \"Privacy & Security\",\r\n            content: \"Famio uses End-to-End Encryption to keep data safe. Only members you approve can see your content. Features include 'Public Profile' toggle (default off) and strict owner-only deletion rights for gallery photos.\"\r\n        },\r\n        {\r\n            title: \"Stories\",\r\n            content: \"Stories are ephemeral photos or videos that disappear after 24 hours. You can upload them from the home tray. Videos autoplay muted but can be unmuted. You can see who viewed your story.\"\r\n        },\r\n        {\r\n            title: \"Groups\",\r\n            content: \"You can create Groups for specific branches of the family or interests (e.g., 'Cousins', 'Planning Committee'). Groups have their own posts and member lists.\"\r\n        },\r\n        {\r\n            title: \"Events\",\r\n            content: \"The Events feature lets you plan family gatherings. You can track RSVPs, see who is attending, and get reminders. Events appear on the main calendar.\"\r\n        },\r\n        {\r\n            title: \"Gallery\",\r\n            content: \"The Gallery organizes all your shared photos. IMPORTANT: Deleting a photo from the Gallery also deletes the original Post it was attached to. Only the owner of the photo can delete it.\"\r\n        },\r\n        {\r\n            title: \"AI Features\",\r\n            content: \"Famio includes AI features like: 1) Content Generation (helping write posts/comments), 2) Automated Birthday Wishes, 3) This AI Assistant (RAG) to answer questions.\"\r\n        },\r\n        {\r\n            title: \"Account & Settings\",\r\n            content: \"You can update your profile, change your display name, and manage privacy settings in the Settings page. Display Name is mandatory for all users.\"\r\n        }\r\n    ];\r\n\r\n    console.log(\"Starting Knowledge Base Seed...\");\r\n    const batch = adminDb.batch();\r\n    const collectionRef = adminDb.collection(\"knowledge_base\");\r\n\r\n    // Clear existing first? Maybe not for now, just overwrite or add.\r\n    // Ideally we delete all, but let's just add for this MVP step.\r\n\r\n    for (const item of knowledgeData) {\r\n        const embedding = await generateEmbedding(item.content);\r\n        const docRef = collectionRef.doc();\r\n        batch.set(docRef, {\r\n            content: item.content,\r\n            embedding: embedding,\r\n            metadata: { title: item.title },\r\n            createdAt: new Date()\r\n        });\r\n        console.log(`Prepared doc: ${item.title}`);\r\n    }\r\n\r\n    await batch.commit();\r\n    console.log(\"Knowledge Base Seeded Successfully!\");\r\n    return { success: true, count: knowledgeData.length };\r\n}\r\n\r\nexport async function translateText(text: string, targetLanguage: 'es' | 'en' | 'fr' | 'zh' | 'hi' | 'ar' = 'es') {\r\n    try {\r\n        const openai = getClient();\r\n\r\n        const langMap: Record<string, string> = {\r\n            'es': 'Spanish',\r\n            'en': 'English',\r\n            'fr': 'French',\r\n            'zh': 'Chinese (Mandarin)',\r\n            'hi': 'Hindi',\r\n            'ar': 'Arabic'\r\n        };\r\n\r\n        const targetLangName = langMap[targetLanguage] || 'English';\r\n\r\n        const systemPrompt = `You are a professional translator. Translate the following text to ${targetLangName}. Maintain the tone and emojis.`;\r\n\r\n        const response = await openai.chat.completions.create({\r\n            model: \"gpt-4o\",\r\n            messages: [\r\n                { role: \"system\", content: systemPrompt },\r\n                { role: \"user\", content: text }\r\n            ],\r\n            temperature: 0.3,\r\n        });\r\n\r\n        return response.choices[0].message.content || text;\r\n    } catch (error) {\r\n        console.error(\"Translation Error:\", error);\r\n        return text; // Fallback to original\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\analytics.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'subMonths' is defined but never used.","line":5,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"subMonths"},"fix":{"range":[140,151],"text":""},"desc":"Remove unused variable \"subMonths\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'startOfWeek' is defined but never used.","line":5,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":71,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"startOfWeek"},"fix":{"range":[169,182],"text":""},"desc":"Remove unused variable \"startOfWeek\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'subWeeks' is defined but never used.","line":5,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":81,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"subWeeks"},"fix":{"range":[182,192],"text":""},"desc":"Remove unused variable \"subWeeks\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3989,3992],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3989,3992],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { subDays, startOfDay, subMonths, subYears, format, startOfWeek, subWeeks } from \"date-fns\";\r\n\r\n/**\r\n * Helper to get date range start based on filter\r\n */\r\nfunction getStartDate(range: 'day' | 'week' | 'month' | 'year' | 'all') {\r\n    const now = new Date();\r\n    const today = startOfDay(now);\r\n\r\n    switch (range) {\r\n        case 'day': return today;\r\n        case 'week': return subDays(today, 7);\r\n        case 'month': return subDays(today, 30);\r\n        case 'year': return subYears(today, 1);\r\n        case 'all': return new Date(0); // Beginning of time\r\n    }\r\n    return today;\r\n}\r\n\r\n/**\r\n * Aggregates global sign-in stats\r\n */\r\nexport async function getGlobalAnalytics(range: 'day' | 'week' | 'month' | 'year') {\r\n    const user = await getUserProfile();\r\n    if (!user || user.role !== 'admin') throw new Error(\"Unauthorized\");\r\n\r\n    const startDate = getStartDate(range);\r\n\r\n    // Note: Querying Collection Group 'sessions' might be heavy. \r\n    // We should index 'startedAt'.\r\n    // If we don't use collection group query, we have to iterate users -> unlikely to scale.\r\n    // Solution: Collection Group Query on 'sessions'\r\n\r\n    // Check if 'sessions' is a subcollection of 'users'. Yes.\r\n    // Collection Group Query:\r\n    // await adminDb.collectionGroup('sessions').where('startedAt', '>=', startDate).get();\r\n    // This requires an index. If not present, it will fail with a link to create it.\r\n\r\n    try {\r\n        const sessionsSnapshot = await adminDb.collectionGroup('sessions')\r\n            .where('startedAt', '>=', startDate)\r\n            .orderBy('startedAt', 'asc') // Create index for this\r\n            .get();\r\n\r\n        const totalSignIns = sessionsSnapshot.size;\r\n        const uniqueUserIds = new Set<string>();\r\n        let totalDuration = 0;\r\n\r\n        // For Chart Data\r\n        // We aggregate based on range granularity\r\n        // day -> hourly (or just daily distinct if range is 1 day? User requirement says \"Today\", so hourly is good)\r\n        // week -> daily\r\n        // month -> daily\r\n        // year -> monthly\r\n\r\n        const chartMap = new Map<string, number>();\r\n\r\n        sessionsSnapshot.docs.forEach(doc => {\r\n            const data = doc.data();\r\n            uniqueUserIds.add(doc.ref.parent.parent!.id); // users/{userId}/sessions/{sessionId} -> parent is sessions, parent.parent is userDoc\r\n\r\n            // Safe aggregation\r\n            totalDuration += (data.duration || 0);\r\n\r\n            // Chart Aggregation\r\n            const date = data.startedAt.toDate();\r\n            let key = \"\";\r\n            if (range === 'day') {\r\n                key = format(date, 'HH:00'); // Hourly\r\n            } else if (range === 'year') {\r\n                key = format(date, 'MMM yyyy'); // Monthly\r\n            } else {\r\n                key = format(date, 'MMM dd'); // Daily\r\n            }\r\n\r\n            chartMap.set(key, (chartMap.get(key) || 0) + 1);\r\n        });\r\n\r\n        // Convert Chart Map to Array\r\n        const chartData = Array.from(chartMap.entries()).map(([name, value]) => ({ name, value }));\r\n\r\n        // Fill gaps if needed? (Optional refinement)\r\n\r\n        // New vs Returning (Naive approach based on user creation date vs session date)\r\n        // Ideally we check if it's their FIRST session in this period vs they had sessions before.\r\n        // This is hard without more history. \r\n        // Simpler: Just count unique users and average sessions per user.\r\n\r\n        const avgSessionsPerUser = uniqueUserIds.size > 0 ? (totalSignIns / uniqueUserIds.size) : 0;\r\n\r\n        return {\r\n            totalSignIns,\r\n            uniqueUsers: uniqueUserIds.size,\r\n            avgSessionDuration: totalSignIns > 0 ? Math.round(totalDuration / totalSignIns) : 0,\r\n            avgSessionsPerUser: parseFloat(avgSessionsPerUser.toFixed(1)),\r\n            chartData\r\n        };\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Error fetching global analytics:\", error);\r\n\r\n        // Check for \"FAILED_PRECONDITION\" which usually means missing index\r\n        const isMissingIndex = error?.code === 9 || error?.message?.includes(\"index\") || error?.message?.includes(\"FAILED_PRECONDITION\");\r\n\r\n        if (isMissingIndex) {\r\n            console.warn(\"‚ö†Ô∏è  Missing Firestore Index for 'sessions' collection group query.\");\r\n            console.warn(\"üìã To fix: Deploy firestore.indexes.json using 'firebase deploy --only firestore:indexes'\");\r\n            console.warn(\"üîß Using mock data for development...\");\r\n        }\r\n\r\n        // Return realistic mock data for development/testing\r\n        const mockChartData = generateMockChartData(range);\r\n\r\n        return {\r\n            totalSignIns: 156,\r\n            uniqueUsers: 42,\r\n            avgSessionDuration: 1247000, // ~20 minutes in ms\r\n            avgSessionsPerUser: 3.7,\r\n            chartData: mockChartData,\r\n            _isMockData: true, // Flag to indicate this is mock data\r\n            _error: isMissingIndex ? \"Missing Firestore indexes - using mock data\" : \"Error loading analytics\"\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Generate realistic mock chart data based on time range\r\n */\r\nfunction generateMockChartData(range: 'day' | 'week' | 'month' | 'year') {\r\n    const data: { name: string; value: number }[] = [];\r\n\r\n    if (range === 'day') {\r\n        // Hourly data for today\r\n        for (let hour = 0; hour < 24; hour++) {\r\n            const value = Math.floor(Math.random() * 15) + (hour >= 9 && hour <= 17 ? 10 : 2);\r\n            data.push({ name: `${hour.toString().padStart(2, '0')}:00`, value });\r\n        }\r\n    } else if (range === 'week') {\r\n        // Daily data for week\r\n        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\r\n        days.forEach(day => {\r\n            data.push({ name: day, value: Math.floor(Math.random() * 30) + 10 });\r\n        });\r\n    } else if (range === 'month') {\r\n        // Daily data for month (sampled)\r\n        for (let day = 1; day <= 30; day += 3) {\r\n            data.push({ name: `Jan ${day}`, value: Math.floor(Math.random() * 40) + 5 });\r\n        }\r\n    } else {\r\n        // Monthly data for year\r\n        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\r\n        months.forEach(month => {\r\n            data.push({ name: month + ' 2026', value: Math.floor(Math.random() * 200) + 50 });\r\n        });\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\n/**\r\n * Gets detailed activity for a specific user\r\n */\r\nexport async function getUserAnalytics(targetUserId: string, range: 'day' | 'week' | 'month' | 'year') {\r\n    const user = await getUserProfile();\r\n    if (!user || user.role !== 'admin') throw new Error(\"Unauthorized\");\r\n\r\n    const startDate = getStartDate(range);\r\n\r\n    try {\r\n        const sessionsSnapshot = await adminDb.collection(\"users\").doc(targetUserId).collection(\"sessions\")\r\n            .where('startedAt', '>=', startDate)\r\n            .orderBy('startedAt', 'desc')\r\n            .get();\r\n\r\n        const history = sessionsSnapshot.docs.map(doc => {\r\n            const data = doc.data();\r\n            return {\r\n                id: doc.id,\r\n                startedAt: data.startedAt?.toDate() || null,\r\n                endedAt: data.endedAt?.toDate() || null,\r\n                duration: data.duration || 0,\r\n                deviceInfo: data.deviceInfo || \"Unknown\",\r\n                status: data.status\r\n            };\r\n        });\r\n\r\n        const totalSignIns = history.length;\r\n        const totalDuration = history.reduce((acc, curr) => acc + curr.duration, 0);\r\n\r\n        // Chart: Duration per day? Or Sessions per day?\r\n        const chartMap = new Map<string, { sessions: number, duration: number }>();\r\n\r\n        history.forEach(session => {\r\n            if (!session.startedAt) return;\r\n            const key = format(session.startedAt, range === 'day' ? 'HH:00' : (range === 'year' ? 'MMM yyyy' : 'MMM dd'));\r\n\r\n            const curr = chartMap.get(key) || { sessions: 0, duration: 0 };\r\n            curr.sessions++;\r\n            curr.duration += session.duration; // ms\r\n            chartMap.set(key, curr);\r\n        });\r\n\r\n        // Convert duration to minutes for chart\r\n        const chartData = Array.from(chartMap.entries()).map(([name, val]) => ({\r\n            name,\r\n            sessions: val.sessions,\r\n            duration: Math.round(val.duration / 60000) // minutes\r\n        })).reverse(); // history is desc, we want charts often asc? Recharts handles strings order. \r\n        // Actually map iteration is insertion order. \r\n        // We sorted history DESC. So map creation is DESC dates. \r\n        // Charts usually read Left->Right as Old->New. So we should reverse to get ASC.\r\n\r\n        return {\r\n            summary: {\r\n                totalSignIns,\r\n                totalTimeSpent: totalDuration, // ms\r\n            },\r\n            history,\r\n            chartData: chartData.reverse()\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error(\"Error fetching user analytics:\", error);\r\n        return null;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\audit.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1802,1805],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1802,1805],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":85,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2142,2145],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2142,2145],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":144,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3948,3951],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3948,3951],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":148,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4054,4057],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4054,4057],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":152,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4169,4172],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4169,4172],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":156,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4280,4283],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4280,4283],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":160,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4371,4374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4371,4374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":181,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5171,5174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5171,5174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":191,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5487,5490],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5487,5490],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":191,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5495,5498],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5495,5498],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":194,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":194,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5691,5694],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5691,5694],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { resolveDisplayName } from \"@/lib/user-utils\";\r\n\r\nexport type AuditAction =\r\n    | \"user.login\"\r\n    | \"user.logout\"\r\n    | \"user.create\"\r\n    | \"user.update\"\r\n    | \"user.delete\"\r\n    | \"post.create\"\r\n    | \"post.update\"\r\n    | \"post.delete\"\r\n    | \"comment.create\"\r\n    | \"comment.delete\"\r\n    | \"comment.update\"\r\n    | \"story.create\"\r\n    | \"story.delete\"\r\n    | \"event.create\"\r\n    | \"event.update\"\r\n    | \"event.delete\"\r\n    | \"group.create\"\r\n    | \"group.join\"\r\n    | \"group.leave\"\r\n    | \"group.update\"\r\n    | \"group.update_cover\"\r\n    | \"group.delete\"\r\n    | \"branding.create\"\r\n    | \"branding.follow\"\r\n    | \"branding.unfollow\"\r\n    | \"branding.update\"\r\n    | \"branding.delete\"\r\n    | \"family.request_sent\"\r\n    | \"family.request_accepted\"\r\n    | \"family.request_rejected\"\r\n    | \"family.request_cancelled\"\r\n    | \"message.sent\"\r\n    | \"user.block\"\r\n    | \"user.unblock\"\r\n    | \"admin.approve_user\"\r\n    | \"admin.reject_user\"\r\n    | \"admin.promote_user\"\r\n    | \"admin.disable_user\"\r\n    | \"admin.enable_user\"\r\n    | \"admin.broadcast\"\r\n    | \"settings.update\"\r\n    | \"security.invisible_mode\"\r\n    | \"event.join\"\r\n    | \"event.leave\"\r\n    | \"group.post_create\"\r\n    | \"reaction.add\"\r\n    | \"reaction.remove\"\r\n    | \"admin.update_profile\"\r\n    | \"admin.update_role\"\r\n    | \"admin.soft_delete_user\"\r\n    | \"admin.restore_user\";\r\n\r\nexport interface AuditLogEntry {\r\n    userId: string;\r\n    userName: string;\r\n    userEmail: string;\r\n    userRole: string;\r\n    action: AuditAction;\r\n    targetType?: string; // e.g., \"post\", \"user\", \"group\"\r\n    targetId?: string;\r\n    targetName?: string;\r\n    details?: Record<string, any>;\r\n    ipAddress?: string;\r\n    userAgent?: string;\r\n    timestamp: Date;\r\n}\r\n\r\n/**\r\n * Log an audit event for admin monitoring\r\n */\r\nexport async function logAuditEvent(\r\n    action: AuditAction,\r\n    options?: {\r\n        targetType?: string;\r\n        targetId?: string;\r\n        targetName?: string;\r\n        details?: Record<string, any>;\r\n    }\r\n) {\r\n    try {\r\n        const user = await getUserProfile();\r\n        if (!user) {\r\n            console.warn(\"[logAuditEvent] Skipped: No user context\");\r\n            return;\r\n        }\r\n\r\n        /**\r\n         * Log an audit event for admin monitoring\r\n         */\r\n        const auditEntry: Omit<AuditLogEntry, \"timestamp\"> = {\r\n            userId: user.id,\r\n            userName: resolveDisplayName(user),\r\n            userEmail: user.email || \"Unknown\",\r\n            userRole: user.role || \"member\",\r\n            action,\r\n            targetType: options?.targetType,\r\n            targetId: options?.targetId,\r\n            targetName: options?.targetName,\r\n            details: options?.details,\r\n        };\r\n\r\n        // Remove undefined values which Firestore doesn't support\r\n        const cleanEntry = JSON.parse(JSON.stringify(auditEntry));\r\n\r\n        const docRef = await adminDb.collection(\"auditLogs\").add({\r\n            ...cleanEntry,\r\n            timestamp: FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        console.log(`[logAuditEvent] Success: ${action} (${docRef.id})`);\r\n\r\n    } catch (error) {\r\n        // Don't throw - audit logging shouldn't break the app\r\n        console.error(\"[logAuditEvent] FAILED:\", error);\r\n    }\r\n}\r\n\r\n/**\r\n * Get audit logs (admin only)\r\n */\r\nexport async function getAuditLogs(options?: {\r\n    userId?: string;\r\n    action?: AuditAction;\r\n    startDate?: Date;\r\n    endDate?: Date;\r\n    limit?: number;\r\n}) {\r\n    const user = await getUserProfile();\r\n    if (!user || user.role !== \"admin\") {\r\n        throw new Error(\"Unauthorized: Admin access required\");\r\n    }\r\n\r\n    let query = adminDb.collection(\"auditLogs\").orderBy(\"timestamp\", \"desc\");\r\n\r\n    if (options?.userId) {\r\n        query = query.where(\"userId\", \"==\", options.userId) as any;\r\n    }\r\n\r\n    if (options?.action) {\r\n        query = query.where(\"action\", \"==\", options.action) as any;\r\n    }\r\n\r\n    if (options?.startDate) {\r\n        query = query.where(\"timestamp\", \">=\", options.startDate) as any;\r\n    }\r\n\r\n    if (options?.endDate) {\r\n        query = query.where(\"timestamp\", \"<=\", options.endDate) as any;\r\n    }\r\n\r\n    const limit = options?.limit || 100;\r\n    query = query.limit(limit) as any;\r\n\r\n    let snapshot;\r\n    try {\r\n        snapshot = await query.get();\r\n    } catch (error) {\r\n        console.warn(\"[getAuditLogs] Index likely missing, falling back to unordered query:\", error);\r\n        // Fallback: Query all logs (or limited) and filter in memory\r\n        // This is safe for admin dashboards where we can client-side paginate or just show recent 100\r\n        snapshot = await adminDb.collection(\"auditLogs\")\r\n            .limit(limit)\r\n            .get();\r\n    }\r\n\r\n    if (!snapshot || snapshot.empty) return [];\r\n\r\n    console.log(`[getAuditLogs] Found ${snapshot.size} logs`);\r\n\r\n    // Import sanitizeData to ensure clean serialization for Client Components\r\n    const { sanitizeData } = await import(\"@/lib/serialization\");\r\n\r\n    const logs = snapshot.docs.map((doc: any) => {\r\n        const data = doc.data();\r\n        return {\r\n            id: doc.id,\r\n            ...data,\r\n            timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(data.timestamp || Date.now()),\r\n        };\r\n    });\r\n\r\n    // Sort in memory to cover the fallback case\r\n    logs.sort((a: any, b: any) => b.timestamp.getTime() - a.timestamp.getTime());\r\n\r\n    // Apply strict filtering in memory for the fallback results (to mimic the failed query)\r\n    const filteredLogs = logs.filter((log: any) => {\r\n        if (options?.userId && log.userId !== options.userId) return false;\r\n        if (options?.action && log.action !== options.action) return false;\r\n        if (options?.startDate && log.timestamp < options.startDate) return false;\r\n        if (options?.endDate && log.timestamp > options.endDate) return false;\r\n        return true;\r\n    });\r\n\r\n    return sanitizeData(filteredLogs);\r\n}\r\n\r\n/**\r\n * Get audit log summary stats (admin only)\r\n */\r\nexport async function getAuditStats() {\r\n    const user = await getUserProfile();\r\n    if (!user || user.role !== \"admin\") {\r\n        throw new Error(\"Unauthorized: Admin access required\");\r\n    }\r\n\r\n    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\r\n    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\r\n\r\n    const [last24h, last7days, total] = await Promise.all([\r\n        adminDb.collection(\"auditLogs\").where(\"timestamp\", \">=\", oneDayAgo).get(),\r\n        adminDb.collection(\"auditLogs\").where(\"timestamp\", \">=\", oneWeekAgo).get(),\r\n        adminDb.collection(\"auditLogs\").count().get(),\r\n    ]);\r\n\r\n    return {\r\n        last24h: last24h.size,\r\n        last7days: last7days.size,\r\n        total: total.data().count,\r\n    };\r\n}\r\n\r\nexport async function generateTestLog() {\r\n    await logAuditEvent(\"settings.update\", {\r\n        targetType: \"system\",\r\n        targetId: \"test\",\r\n        targetName: \"Test Log Entry\",\r\n        details: { message: \"This is a test audit log to verify the system.\" }\r\n    });\r\n    return { success: true };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":129,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5176,5179],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5176,5179],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":183,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7975,7978],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7975,7978],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":234,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":234,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9730,9733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9730,9733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'email' is defined but never used.","line":292,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":292,"endColumn":46}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\nimport { cookies } from \"next/headers\"\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\n\r\nexport async function createSession(uid: string) {\r\n    // In Next.js 15/16, cookies() is async\r\n    const cookieStore = await cookies()\r\n\r\n    console.log(`[createSession] Setting session_uid for ${uid}`);\r\n\r\n    cookieStore.set(\"session_uid\", uid, {\r\n        httpOnly: true,\r\n        // Force secure false locally if needed, but standardizing on NODE_ENV is best.\r\n        // If users have issues locally with production builds, this might be the cause.\r\n        // Forcing secure: false to resolve login issues on localhost/http environments.\r\n        // Revert this only when deploying to strict HTTPS production.\r\n        secure: false, // process.env.NODE_ENV === \"production\",\r\n        path: \"/\",\r\n        maxAge: 60 * 60 * 24 * 30, // 30 days\r\n        sameSite: 'lax' // Add explicit SameSite\r\n    })\r\n}\r\n\r\n\r\nexport async function deleteSession() {\r\n    // We should ideally end the session in DB too, but we need the sessionId.\r\n    // Since we don't track sessionId in cookie currently (only uid), \r\n    // we will rely on the client-side 'endTrackingSession' call for the specific session ID\r\n    // OR we can mark all 'active' sessions for this user as 'completed' here as a fallback.\r\n\r\n    // Fallback: Mark all active sessions as completed\r\n    try {\r\n        const cookieStore = await cookies()\r\n        // Note: we can't get the user ID easily if we just delete cookie first? \r\n        // Actually we should get it before deleting.\r\n        const uid = cookieStore.get(\"session_uid\")?.value;\r\n\r\n        if (uid) {\r\n            const { adminDb } = await import(\"@/lib/firebase-admin\"); // Dynamic import to avoid cycles if any\r\n            const { FieldValue } = await import(\"firebase-admin/firestore\");\r\n\r\n            // Get all active sessions\r\n            const sessionsSnapshot = await adminDb.collection(\"users\").doc(uid).collection(\"sessions\")\r\n                .where(\"status\", \"==\", \"active\")\r\n                .get();\r\n\r\n            const batch = adminDb.batch();\r\n            sessionsSnapshot.docs.forEach(doc => {\r\n                batch.update(doc.ref, {\r\n                    status: 'completed',\r\n                    endedAt: FieldValue.serverTimestamp()\r\n                });\r\n            });\r\n\r\n            // Update User Status\r\n            batch.update(adminDb.collection(\"users\").doc(uid), {\r\n                isOnline: false,\r\n                lastSignOffAt: FieldValue.serverTimestamp()\r\n            });\r\n\r\n            await batch.commit();\r\n        }\r\n\r\n        cookieStore.delete(\"session_uid\")\r\n    } catch (e) {\r\n        console.error(\"Error during sign out tracking:\", e);\r\n        // Ensure cookie is deleted even if tracking fails\r\n        const cookieStore = await cookies()\r\n        cookieStore.delete(\"session_uid\")\r\n    }\r\n}\r\n\r\nexport async function syncUserToDb(\r\n    uid: string,\r\n    email: string,\r\n    displayName: string,\r\n    firstName: string,\r\n    lastName: string,\r\n    emailVerified: boolean = false\r\n) {\r\n    try {\r\n        if (!uid || !email || !displayName || !firstName || !lastName) {\r\n            console.error(\"Missing required fields for user creation:\", { uid, email, displayName, firstName, lastName });\r\n            throw new Error(\"Missing required fields: First Name, Last Name, and Display Name are mandatory.\");\r\n        }\r\n\r\n        if (displayName.trim() === \"Unnamed User\" || displayName.trim().length < 2) {\r\n            throw new Error(\"Invalid Display Name. Please provide a valid name.\");\r\n        }\r\n\r\n        if (!adminDb || !adminDb.collection) {\r\n            throw new Error(\"Firebase Admin DB not initialized\");\r\n        }\r\n        const userRef = adminDb.collection(\"users\").doc(uid);\r\n        const userDoc = await userRef.get();\r\n\r\n        if (!userDoc.exists) {\r\n            // Default to 'member' (auto-approve) unless it's the specific admin email\r\n            const isAdmin = email === \"chancellor@ichancetek.com\";\r\n            const role = isAdmin ? \"admin\" : \"member\";\r\n            const isVerified = isAdmin || emailVerified;\r\n\r\n            await userRef.set({\r\n                email: email,\r\n                displayName: displayName,\r\n                profileData: {\r\n                    firstName: firstName.trim(),\r\n                    lastName: lastName.trim(),\r\n                },\r\n                role: role,\r\n                isActive: true,\r\n                emailVerified: isVerified,\r\n                createdAt: FieldValue.serverTimestamp(),\r\n            });\r\n\r\n            // Send Automated Welcome Message\r\n            await sendWelcomeMessageInternal(uid, displayName).catch(err => {\r\n                console.error(\"Failed to send welcome message:\", err);\r\n            });\r\n\r\n            // Notify Admins\r\n            await notifyAdminNewUser(uid, email, displayName, firstName, lastName).catch(err => {\r\n                console.error(\"Failed to notify admins:\", err);\r\n            });\r\n        } else {\r\n            // UPDATE EXISTING USER\r\n            const userData = userDoc.data();\r\n            const updates: any = {};\r\n\r\n            // 1. Sync Email Verification Status\r\n            // We trust the latest Auth Provider state.\r\n            if (emailVerified !== undefined && userData?.emailVerified !== emailVerified) {\r\n                updates.emailVerified = emailVerified;\r\n            }\r\n\r\n            // 2. Ensure createdAt exists (Critical for Grace Period logic)\r\n            // If missing, we backfill it now to start the clock or assume old user.\r\n            if (!userData?.createdAt) {\r\n                updates.createdAt = FieldValue.serverTimestamp();\r\n            }\r\n\r\n            // 3. Admin Promotion Check\r\n            if (email === \"chancellor@ichancetek.com\" && userData?.role !== \"admin\") {\r\n                updates.role = \"admin\";\r\n            }\r\n\r\n            if (Object.keys(updates).length > 0) {\r\n                await userRef.update(updates);\r\n                console.log(`[syncUserToDb] User ${uid} updated:`, Object.keys(updates));\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Error syncing user to database:\", error)\r\n        throw new Error(\"Failed to sync user to database\")\r\n    }\r\n}\r\n\r\nexport async function notifyAdminNewUser(uid: string, email: string, displayName: string, firstName?: string, lastName?: string) {\r\n    try {\r\n        const fullName = firstName ? `${firstName} ${lastName || ''}`.trim() : displayName;\r\n        const displayInfo = firstName ? `${displayName} (${fullName})` : displayName;\r\n\r\n        // 1. Send Email to Chancellor via 'mail' collection (Trigger Email Extension)\r\n        await adminDb.collection(\"mail\").add({\r\n            to: \"chancellor@ichancetek.com\",\r\n            message: {\r\n                subject: `New Famio Member: ${displayInfo}`,\r\n                text: `A new user has joined Famio!\\n\\nDisplay Name: ${displayName}\\nFull Name: ${fullName}\\nEmail: ${email}\\nUID: ${uid}\\n\\nThey have been auto-approved as a Member.`,\r\n                html: `<p>A new user has joined <strong>Famio</strong>!</p><ul><li><strong>Display Name:</strong> ${displayName}</li><li><strong>Full Name:</strong> ${fullName}</li><li><strong>Email:</strong> ${email}</li><li><strong>UID:</strong> ${uid}</li></ul><p>They have been auto-approved as a Member.</p>`,\r\n            },\r\n        });\r\n\r\n        // 2. Create In-App Notifications for all Admins\r\n        const adminsSnapshot = await adminDb.collection(\"users\")\r\n            .where(\"role\", \"==\", \"admin\")\r\n            .get();\r\n\r\n        // We write directly to adminDb to ensure it works even if session isn't fully propagated yet\r\n        // (createNotification relies on getUserProfile() which might be flaky in this specific exact moment)\r\n        const timestamp = FieldValue.serverTimestamp();\r\n\r\n        const notificationPromises = adminsSnapshot.docs.map((adminDoc: any) =>\r\n            adminDb.collection(\"notifications\").add({\r\n                recipientId: adminDoc.id,\r\n                senderId: uid, // The new user is the sender\r\n                type: 'admin_action',\r\n                referenceId: uid, // Link to the new user\r\n                read: false,\r\n                createdAt: timestamp,\r\n                meta: {\r\n                    action: 'new_user_registration',\r\n                    userName: displayName,\r\n                    userEmail: email,\r\n                    message: `New User: ${displayInfo} has joined Famio.`\r\n                }\r\n            })\r\n        );\r\n\r\n        await Promise.all(notificationPromises);\r\n    } catch (error) {\r\n        console.error(\"Error notifying admins:\", error);\r\n        // Don't throw - this shouldn't block the signup process\r\n    }\r\n}\r\n\r\n\r\n// Internal helper to avoid circular dependency with chat.ts\r\nasync function sendWelcomeMessageInternal(targetUserId: string, targetUserDisplayName: string) {\r\n    if (!adminDb) return;\r\n\r\n    // 1. Find Admin User\r\n    const adminQuery = await adminDb.collection(\"users\")\r\n        .where(\"email\", \"==\", \"chancellor@ichancetek.com\")\r\n        .limit(1)\r\n        .get();\r\n\r\n    if (adminQuery.empty) {\r\n        console.error(\"Welcome Message Error: Admin user 'chancellor@ichancetek.com' not found.\");\r\n        return;\r\n    }\r\n\r\n    const adminUser = adminQuery.docs[0];\r\n    const adminId = adminUser.id;\r\n\r\n    if (adminId === targetUserId) return;\r\n\r\n    // 2. Check/Create Chat\r\n    const chatsSnapshot = await adminDb.collection(\"chats\")\r\n        .where(\"participants\", \"array-contains\", targetUserId)\r\n        .get();\r\n\r\n    // Find existing 1-on-1 chat with Admin\r\n    let chatDoc = chatsSnapshot.docs.find((chatDoc: any) => {\r\n        const chatData = chatDoc.data();\r\n        return !chatData.isGroup && chatData.participants.includes(adminId);\r\n    });\r\n\r\n    let chatId;\r\n    if (chatDoc) {\r\n        chatId = chatDoc.id;\r\n    } else {\r\n        const newChatRef = await adminDb.collection(\"chats\").add({\r\n            participants: [targetUserId, adminId],\r\n            isGroup: false,\r\n            lastMessageAt: FieldValue.serverTimestamp(),\r\n            createdAt: FieldValue.serverTimestamp(),\r\n        });\r\n        chatId = newChatRef.id;\r\n    }\r\n\r\n    // 3. Send Message\r\n    const welcomeText = `Welcome to the Famio Family!\r\n\r\nThank you for joining us ‚Äî we‚Äôre excited to have you here. We hope you enjoy a wonderful experience on the Famio platform as you connect, share, and grow with the community.\r\n\r\nThese are exciting times at Famio! We‚Äôre rolling out new enhancements and updates every week to make your experience even better.\r\n\r\nWe truly appreciate you being part of the Famio Family.\r\n\r\nBest regards,\r\nChancellor Minus\r\nFounder & CEO\r\nChanceTEK | Famio`;\r\n\r\n    await adminDb.collection(\"chats\").doc(chatId).collection(\"messages\").add({\r\n        senderId: adminId,\r\n        content: welcomeText,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    await adminDb.collection(\"chats\").doc(chatId).update({\r\n        lastMessageAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // Notify logic (inlined simple create no-import to be safe or use raw db)\r\n    // We will simple write directly to db to avoid import cycle with notifications.ts if that is risky.\r\n    // notifications.ts imports lib/auth which is safe, but let's be 100% safe and write raw.\r\n    await adminDb.collection(\"notifications\").add({\r\n        recipientId: targetUserId,\r\n        senderId: adminId,\r\n        type: 'message',\r\n        referenceId: chatId,\r\n        read: false,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n        meta: { message: \"You have a new message from Chancellor Minus\" }\r\n    });\r\n\r\n    console.log(`[Internal] Welcome message sent to ${targetUserDisplayName} (${targetUserId}) from Admin.`);\r\n}\r\n\r\nexport async function sendPasswordReset(email: string) {\r\n    // This is typically handled on the client in Firebase, \r\n    // but we can provide a server-side trigger if needed \r\n    // or just document that it should be called on client.\r\n    // Actually, Firebase Admin doesn't have a direct 'sendPasswordReset' method \r\n    // like the client SDK. It usually generates a link.\r\n    // To keep it simple and consistent with Firebase patterns,\r\n    // we'll implement this on the client side in the Settings UI.\r\n    // But I'll provide a placeholder here if any server-side logic is needed.\r\n    return { success: true };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\birthdays.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[972,975],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[972,975],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1023,1026],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1023,1026],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1049,1052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1049,1052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1414,1417],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1414,1417],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { generateBirthdayWish } from \"./ai\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\n\r\nexport async function checkAndCelebrateBirthdays() {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n    const adminUserId = user.id;\r\n\r\n    // 1. Get today's MM-DD\r\n    const today = new Date();\r\n    const month = (today.getMonth() + 1).toString().padStart(2, \"0\");\r\n    const day = today.getDate().toString().padStart(2, \"0\");\r\n    const todayString = `${month}-${day}`;\r\n    const currentYear = today.getFullYear();\r\n\r\n    console.log(`Checking birthdays for ${todayString}...`);\r\n\r\n    // 2. Find users with this birthday\r\n    const usersSnapshot = await adminDb.collection(\"users\").get();\r\n\r\n    const birthdayUsers = usersSnapshot.docs\r\n        .map((userDoc: any) => ({ id: userDoc.id, ...userDoc.data() }) as any)\r\n        .filter((u: any) => u.birthday === todayString && u.lastCelebratedYear !== currentYear);\r\n\r\n    if (birthdayUsers.length === 0) {\r\n        return { success: true, message: \"No new birthdays to celebrate today.\" };\r\n    }\r\n\r\n    // 3. Generate wishes and create posts\r\n    let celebratedCount = 0;\r\n    for (const bdayUser of birthdayUsers) {\r\n        const name = (bdayUser as any).displayName || \"Unknown\";\r\n        const wish = await generateBirthdayWish(name);\r\n\r\n        // Create Post\r\n        await adminDb.collection(\"posts\").add({\r\n            authorId: adminUserId,\r\n            content: `üéâüéÇ HAPPY BIRTHDAY ${name}! üéÇüéâ\\n\\n${wish}`,\r\n            likes: [],\r\n            mediaUrls: [],\r\n            createdAt: FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        // Update user's lastCelebratedYear\r\n        await adminDb.collection(\"users\").doc(bdayUser.id).update({\r\n            lastCelebratedYear: currentYear\r\n        });\r\n\r\n        celebratedCount++;\r\n    }\r\n\r\n    revalidatePath(\"/\");\r\n    return { success: true, message: `Celebrated ${celebratedCount} birthdays! ü•≥` };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\branding.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[662,665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[662,665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[701,704],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[701,704],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2496,2499],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2496,2499],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":167,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5385,5388],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5385,5388],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":269,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":269,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9453,9456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9453,9456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":356,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":356,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12623,12626],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12623,12626],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { slugify } from \"@/lib/utils\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\n\r\nexport type Branding = {\r\n    id: string;\r\n    slug?: string;\r\n    name: string;\r\n    description: string;\r\n    category: string;\r\n    founderId: string;\r\n    imageUrl?: string; // Logo\r\n    bannerUrl?: string;\r\n    coverUrl?: string; // Cover photo/video\r\n    createdAt: Date;\r\n    followerCount?: number;\r\n    isFollowing?: boolean;\r\n    deletedAt?: any;\r\n    scheduledPermanentDeleteAt?: any;\r\n};\r\n\r\nexport async function createBranding(data: { name: string; description: string; category: string; imageUrl?: string; coverUrl?: string }) {\r\n    console.log(\"Creating branding\", data);\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    let slug = slugify(data.name);\r\n    let potentialId = slug;\r\n    let counter = 0;\r\n\r\n    // Check for uniqueness\r\n    while (true) {\r\n        // 1. Check ID collision\r\n        const doc = await adminDb.collection(\"pages\").doc(potentialId).get();\r\n        if (doc.exists) {\r\n            counter++;\r\n            potentialId = `${slug}-${counter}`;\r\n            continue;\r\n        }\r\n\r\n        // 2. Check Slug collision\r\n        const slugCheck = await adminDb.collection(\"pages\").where(\"slug\", \"==\", potentialId).limit(1).get();\r\n        if (!slugCheck.empty) {\r\n            counter++;\r\n            potentialId = `${slug}-${counter}`;\r\n            continue;\r\n        }\r\n\r\n        break;\r\n    }\r\n\r\n    const brandingRef = adminDb.collection(\"pages\").doc(potentialId);\r\n    await brandingRef.set({\r\n        ...data,\r\n        slug: potentialId,\r\n        founderId: user.id,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n        followerCount: 1, // Founder automatically follows? Maybe.\r\n    });\r\n\r\n    // Add founder as follower/admin\r\n    await brandingRef.collection(\"followers\").doc(user.id).set({\r\n        userId: user.id,\r\n        role: 'admin', // Founder is admin\r\n        followedAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    revalidatePath('/branding');\r\n    return brandingRef.id;\r\n}\r\n\r\nexport async function getBrandings() {\r\n    const brandingsSnapshot = await adminDb.collection(\"pages\").orderBy(\"createdAt\", \"desc\").get();\r\n\r\n    return brandingsSnapshot.docs\r\n        .map((doc: any) => {\r\n            return sanitizeData({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            }) as Branding;\r\n        })\r\n        .filter(b => !b.deletedAt);\r\n}\r\n\r\nexport async function getBranding(identifier: string) {\r\n    // 1. Try by ID (Fastest/Default for new pages)\r\n    let doc = await adminDb.collection(\"pages\").doc(identifier).get();\r\n\r\n    // 2. If not found, try by slug\r\n    if (!doc.exists) {\r\n        const snapshot = await adminDb.collection(\"pages\").where(\"slug\", \"==\", identifier).limit(1).get();\r\n        if (!snapshot.empty) {\r\n            doc = snapshot.docs[0];\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    return sanitizeData({\r\n        id: doc.id,\r\n        ...doc.data()\r\n    }) as Branding;\r\n}\r\n\r\nexport async function followBranding(brandingId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const followerRef = adminDb.collection(\"pages\").doc(brandingId).collection(\"followers\").doc(user.id);\r\n    const followerDoc = await followerRef.get();\r\n\r\n    if (followerDoc.exists) return; // Already following\r\n\r\n    await followerRef.set({\r\n        userId: user.id,\r\n        role: 'follower',\r\n        followedAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // Increment follower count\r\n    await adminDb.collection(\"pages\").doc(brandingId).update({\r\n        followerCount: FieldValue.increment(1)\r\n    });\r\n\r\n    // Notify Branding Founder/Admin\r\n    const brandingDoc = await adminDb.collection(\"pages\").doc(brandingId).get();\r\n    const brandingData = brandingDoc.data();\r\n    if (brandingData && brandingData.founderId) {\r\n        const { createNotification } = await import(\"./notifications\");\r\n        await createNotification(brandingData.founderId, 'follow', brandingId, {\r\n            brandingName: brandingData.name\r\n        }).catch(console.error);\r\n    }\r\n\r\n    revalidatePath(`/branding/${brandingId}`);\r\n    revalidatePath('/branding');\r\n}\r\n\r\nexport async function unfollowBranding(brandingId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"pages\").doc(brandingId).collection(\"followers\").doc(user.id).delete();\r\n\r\n    // Decrement follower count\r\n    await adminDb.collection(\"pages\").doc(brandingId).update({\r\n        followerCount: FieldValue.increment(-1)\r\n    });\r\n\r\n    revalidatePath(`/branding/${brandingId}`);\r\n    revalidatePath('/branding');\r\n}\r\n\r\nexport async function getBrandingFollowStatus(brandingId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) return null;\r\n\r\n    const followerDoc = await adminDb.collection(\"pages\").doc(brandingId).collection(\"followers\").doc(user.id).get();\r\n    if (!followerDoc.exists) return null;\r\n\r\n    return sanitizeData(followerDoc.data()) as { role: 'admin' | 'follower', followedAt: any };\r\n}\r\n\r\nexport async function createBrandingPost(brandingId: string, content: string, mediaUrls: string[] = []) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    // Check if user is a follower or admin\r\n    const status = await getBrandingFollowStatus(brandingId);\r\n    if (!status) throw new Error(\"Must follow the page to post\");\r\n\r\n    const isAdmin = status.role === 'admin';\r\n\r\n    await adminDb.collection(\"pages\").doc(brandingId).collection(\"posts\").add({\r\n        authorId: user.id,\r\n        postedAsBranding: isAdmin, // Only admins post AS the brand\r\n        brandingId: brandingId,\r\n        content,\r\n        mediaUrls,\r\n        likes: [],\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    revalidatePath(`/branding/${brandingId}`);\r\n}\r\n\r\nexport async function editBrandingPost(brandingId: string, postId: string, content: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = adminDb.collection(\"pages\").doc(brandingId).collection(\"posts\").doc(postId);\r\n    const postDoc = await postRef.get();\r\n\r\n    if (!postDoc.exists) throw new Error(\"Post not found\");\r\n    const postData = postDoc.data();\r\n\r\n    // Check permissions\r\n    if (postData?.postedAsBranding) {\r\n        // If posted as branding, checking if user is admin\r\n        const status = await getBrandingFollowStatus(brandingId);\r\n        if (status?.role !== 'admin') throw new Error(\"Unauthorized\");\r\n    } else {\r\n        // If posted as user, check authorId\r\n        if (postData?.authorId !== user.id) throw new Error(\"Unauthorized\");\r\n    }\r\n\r\n    await postRef.update({\r\n        content,\r\n        isEdited: true,\r\n        updatedAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    revalidatePath(`/branding/${brandingId}`);\r\n}\r\n\r\nimport { PostFilters } from \"./posts\";\r\n\r\nexport async function getBrandingPosts(brandingId: string, limit = 50, filters: PostFilters = { timeRange: 'all', contentType: 'all' }) {\r\n    const postsSnapshot = await adminDb.collection(\"pages\").doc(brandingId).collection(\"posts\")\r\n        .orderBy(\"createdAt\", \"desc\")\r\n        .get();\r\n\r\n    let allDocs = postsSnapshot.docs;\r\n\r\n    // Filter Soft Deleted\r\n    allDocs = allDocs.filter(doc => !doc.data().isDeleted);\r\n\r\n    // Apply Memory Filters\r\n    if (filters.contentType !== 'all') {\r\n        allDocs = allDocs.filter(doc => {\r\n            const data = doc.data();\r\n            const hasMedia = data.mediaUrls && data.mediaUrls.length > 0;\r\n            const videoUrlRegex = /https?:\\/\\/(www\\.)?(youtube\\.com|youtu\\.be|facebook\\.com|linkedin\\.com|vimeo\\.com|ds1\\.chancetek.com)\\/\\S+/i;\r\n            const hasVideoLink = videoUrlRegex.test(data.content || \"\");\r\n            const isVideo = (hasMedia && data.mediaUrls.some((u: string) => u.match(/\\.(mp4|mov|webm)$/i))) || hasVideoLink;\r\n            const isPhoto = hasMedia && !isVideo;\r\n            const isText = !hasMedia && !hasVideoLink;\r\n\r\n            if (filters.contentType === 'video') return isVideo;\r\n            if (filters.contentType === 'photo') return isPhoto;\r\n            if (filters.contentType === 'text') return isText;\r\n            return true;\r\n        });\r\n    }\r\n\r\n    if (filters.timeRange !== 'all') {\r\n        const now = new Date();\r\n        const msPerDay = 24 * 60 * 60 * 1000;\r\n        allDocs = allDocs.filter(doc => {\r\n            const data = doc.data();\r\n            const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();\r\n            const diff = now.getTime() - createdAt.getTime();\r\n            if (filters.timeRange === 'day') return diff < msPerDay;\r\n            if (filters.timeRange === 'week') return diff < msPerDay * 7;\r\n            if (filters.timeRange === 'month') return diff < msPerDay * 30;\r\n            if (filters.timeRange === 'year') return diff < msPerDay * 365;\r\n            return true;\r\n        });\r\n    }\r\n\r\n    const slicedDocs = allDocs.slice(0, limit);\r\n\r\n    const allPosts = await Promise.all(slicedDocs.map(async (postDoc: any) => {\r\n        const postData = postDoc.data();\r\n\r\n        // If postedAsBranding, Fetch Branding Details as Author\r\n        let author = null;\r\n        if (postData.postedAsBranding) {\r\n            const branding = await getBranding(brandingId);\r\n            if (branding) {\r\n                author = {\r\n                    id: branding.id,\r\n                    displayName: branding.name,\r\n                    imageUrl: branding.imageUrl,\r\n                    email: null\r\n                };\r\n            }\r\n        } else {\r\n            // Fetch author (should be the brand or the admin user posting as brand)\r\n            const authorDoc = await adminDb.collection(\"users\").doc(postData.authorId).get();\r\n            author = authorDoc.exists ? {\r\n                id: authorDoc.id,\r\n                displayName: authorDoc.data()?.displayName,\r\n                imageUrl: authorDoc.data()?.imageUrl,\r\n                email: authorDoc.data()?.email,\r\n            } : null;\r\n        }\r\n\r\n        return sanitizeData({\r\n            id: postDoc.id,\r\n            content: postData.content || \"\",\r\n            mediaUrls: postData.mediaUrls || [],\r\n            createdAt: postData.createdAt,\r\n            likes: postData.likes || [],\r\n            reactions: postData.reactions || {},\r\n            authorId: postData.authorId, // CRITICAL: Return authorId\r\n            author,\r\n            postedAsBranding: postData.postedAsBranding,\r\n            context: { type: 'branding', id: brandingId },\r\n            comments: []\r\n        });\r\n    }));\r\n\r\n    return allPosts;\r\n}\r\n\r\nexport async function getBrandingPost(brandingId: string, postId: string) {\r\n    try {\r\n        const postRef = adminDb.collection(\"pages\").doc(brandingId).collection(\"posts\").doc(postId);\r\n        const doc = await postRef.get();\r\n        if (!doc.exists) return null;\r\n\r\n        const data = doc.data()!;\r\n\r\n        // Fetch Author\r\n        const authorDoc = await adminDb.collection(\"users\").doc(data.authorId).get();\r\n        const author = authorDoc.exists ? {\r\n            id: authorDoc.id,\r\n            displayName: authorDoc.data()?.displayName,\r\n            imageUrl: authorDoc.data()?.imageUrl,\r\n            email: authorDoc.data()?.email,\r\n        } : null;\r\n\r\n        return sanitizeData({\r\n            id: doc.id,\r\n            content: data.content || \"\",\r\n            mediaUrls: data.mediaUrls || [],\r\n            createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(),\r\n            likes: data.likes || [],\r\n            reactions: data.reactions || {},\r\n            authorId: data.authorId, // CRITICAL\r\n            author,\r\n            postedAsBranding: data.postedAsBranding,\r\n            context: { type: 'branding', id: brandingId },\r\n            comments: []\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Error fetching branding post:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function getFollowedBrandingIds(userId: string) {\r\n    const snapshot = await adminDb.collectionGroup(\"followers\")\r\n        .where(\"userId\", \"==\", userId)\r\n        .get();\r\n\r\n    const brandingIds = new Set<string>();\r\n\r\n    snapshot.docs.forEach((doc: any) => {\r\n        const brandingDoc = doc.ref.parent.parent;\r\n        if (brandingDoc) {\r\n            brandingIds.add(brandingDoc.id);\r\n        }\r\n    });\r\n\r\n    return Array.from(brandingIds);\r\n}\r\n\r\nexport async function updateBrandingCover(brandingId: string, coverUrl: string | null) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    // Check if user is founder or admin\r\n    const brandingDoc = await adminDb.collection(\"pages\").doc(brandingId).get();\r\n    if (!brandingDoc.exists) throw new Error(\"Branding not found\");\r\n\r\n    const brandingData = brandingDoc.data();\r\n    const isFounder = brandingData?.founderId === user.id;\r\n\r\n    if (!isFounder) {\r\n        // Check if admin follower\r\n        const followerDoc = await adminDb.collection(\"pages\").doc(brandingId).collection(\"followers\").doc(user.id).get();\r\n        const isAdmin = followerDoc.exists && followerDoc.data()?.role === 'admin';\r\n        if (!isAdmin) {\r\n            throw new Error(\"Only branding founder or admins can update the cover\");\r\n        }\r\n    }\r\n\r\n    await adminDb.collection(\"pages\").doc(brandingId).update({\r\n        coverUrl: coverUrl || null\r\n    });\r\n\r\n    revalidatePath(`/branding/${brandingId}`);\r\n    revalidatePath('/branding');\r\n}\r\n\r\nexport async function updateBrandingDetails(brandingId: string, data: { name?: string; description?: string; coverUrl?: string }) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const brandingDoc = await adminDb.collection(\"pages\").doc(brandingId).get();\r\n    if (!brandingDoc.exists) throw new Error(\"Page not found\");\r\n\r\n    // Only founder or admin can update\r\n    const brandingData = brandingDoc.data();\r\n    if (brandingData?.founderId !== user.id) {\r\n        const followerDoc = await adminDb.collection(\"pages\").doc(brandingId).collection(\"followers\").doc(user.id).get();\r\n        if (!followerDoc.exists || followerDoc.data()?.role !== 'admin') {\r\n            throw new Error(\"Unauthorized\");\r\n        }\r\n    }\r\n\r\n    await adminDb.collection(\"pages\").doc(brandingId).update({\r\n        ...data,\r\n        updatedAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    revalidatePath(`/branding/${brandingId}`);\r\n    revalidatePath('/branding');\r\n}\r\n\r\nexport async function softDeleteBranding(brandingId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const brandingDoc = await adminDb.collection(\"pages\").doc(brandingId).get();\r\n    if (!brandingDoc.exists) throw new Error(\"Page not found\");\r\n\r\n    if (brandingDoc.data()?.founderId !== user.id) throw new Error(\"Only the founder can delete the page\");\r\n\r\n    const now = new Date();\r\n    const thirtyDaysLater = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));\r\n\r\n    await adminDb.collection(\"pages\").doc(brandingId).update({\r\n        deletedAt: FieldValue.serverTimestamp(),\r\n        scheduledPermanentDeleteAt: thirtyDaysLater\r\n    });\r\n\r\n    revalidatePath(`/branding/${brandingId}`);\r\n    revalidatePath('/branding');\r\n}\r\n\r\nexport async function restoreBranding(brandingId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const brandingDoc = await adminDb.collection(\"pages\").doc(brandingId).get();\r\n    if (!brandingDoc.exists) throw new Error(\"Page not found\");\r\n\r\n    if (brandingDoc.data()?.founderId !== user.id) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"pages\").doc(brandingId).update({\r\n        deletedAt: FieldValue.delete(),\r\n        scheduledPermanentDeleteAt: FieldValue.delete()\r\n    });\r\n\r\n    revalidatePath(`/branding/${brandingId}`);\r\n    revalidatePath('/branding');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\chat.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1558,1561],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1558,1561],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3472,3475],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3472,3475],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":185,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":185,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6143,6146],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6143,6146],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":249,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":249,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8182,8185],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8182,8185],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\n\r\n// --- Types ---\r\nexport type ChatUser = {\r\n    id: string;\r\n    displayName: string | null;\r\n    imageUrl: string | null;\r\n    email: string;\r\n}\r\n\r\nexport type ChatSession = {\r\n    id: string;\r\n    name: string | null;\r\n    isGroup: boolean | null;\r\n    participants: string[];\r\n    lastMessageAt: Date | null;\r\n    otherUser?: ChatUser; // Enriched data for FE convenience\r\n    lastMessage?: string | null;\r\n}\r\n\r\nexport type Message = {\r\n    id: string;\r\n    senderId: string;\r\n    content: string;\r\n    createdAt: Date;\r\n    sender?: ChatUser;\r\n}\r\n\r\n// --- Actions ---\r\n\r\nexport async function checkOrCreateChat(targetUserId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n    const myId = user.id;\r\n\r\n    if (myId === targetUserId) throw new Error(\"Cannot chat with yourself\");\r\n\r\n    // Check if chat already exists between these two users\r\n    // Note: Firestore Admin SDK doesn't support array-contains for multiple fields easily in one query if restricted\r\n    // But basic array-contains works.\r\n    const chatsSnapshot = await adminDb.collection(\"chats\")\r\n        .where(\"participants\", \"array-contains\", myId)\r\n        .get();\r\n\r\n    // Find existing 1-on-1 chat\r\n    const existingChat = chatsSnapshot.docs.find((chatDoc: any) => {\r\n        const chatData = chatDoc.data();\r\n        return !chatData.isGroup &&\r\n            chatData.participants.includes(targetUserId);\r\n    });\r\n\r\n    if (existingChat) {\r\n        return existingChat.id;\r\n    }\r\n\r\n    // Create new chat\r\n    const newChatRef = await adminDb.collection(\"chats\").add({\r\n        participants: [myId, targetUserId],\r\n        isGroup: false,\r\n        lastMessageAt: FieldValue.serverTimestamp(),\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // Notify the other user\r\n    try {\r\n        const { createNotification } = await import(\"./notifications\");\r\n        await createNotification(\r\n            targetUserId,\r\n            \"message\",\r\n            newChatRef.id,\r\n            { message: \"Started a new conversation with you\" }\r\n        );\r\n    } catch (error) {\r\n        console.error(\"Failed to send chat notification:\", error);\r\n    }\r\n\r\n    revalidatePath(\"/messages\");\r\n    return newChatRef.id;\r\n}\r\n\r\nexport async function getChats(): Promise<ChatSession[]> {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n    const myId = user.id;\r\n\r\n    // Fetch chats where user is participant\r\n    let chatsSnapshot;\r\n    try {\r\n        chatsSnapshot = await adminDb.collection(\"chats\")\r\n            .where(\"participants\", \"array-contains\", myId)\r\n            .orderBy(\"lastMessageAt\", \"desc\")\r\n            .get();\r\n    } catch (e) {\r\n        console.warn(\"Index likely missing for getChats, falling back to unordered query:\", e);\r\n        // Fallback: Fetch without ordering, then sort in memory\r\n        chatsSnapshot = await adminDb.collection(\"chats\")\r\n            .where(\"participants\", \"array-contains\", myId)\r\n            .get();\r\n    }\r\n\r\n    if (chatsSnapshot.empty) return [];\r\n\r\n    // Enrich with other user details\r\n    const enrichedChats = await Promise.all(chatsSnapshot.docs.map(async (chatDoc: any) => {\r\n        const chatData = chatDoc.data();\r\n        const participants = chatData.participants || [];\r\n        const otherId = participants.find((id: string) => id !== myId);\r\n\r\n        let otherUser: ChatUser | undefined;\r\n        if (otherId) {\r\n            const userDoc = await adminDb.collection(\"users\").doc(otherId).get();\r\n            if (userDoc.exists) {\r\n                const userData = userDoc.data();\r\n                otherUser = {\r\n                    id: userDoc.id,\r\n                    email: userData?.email,\r\n                    displayName: userData?.displayName || \"Unknown\",\r\n                    imageUrl: userData?.imageUrl || null\r\n                };\r\n            }\r\n        }\r\n\r\n        // Get last message content for preview\r\n        const messagesSnapshot = await adminDb.collection(\"chats\").doc(chatDoc.id).collection(\"messages\")\r\n            .orderBy(\"createdAt\", \"desc\")\r\n            .limit(1)\r\n            .get();\r\n\r\n        const lastMessage = messagesSnapshot.empty ? \"No messages yet\" : messagesSnapshot.docs[0].data().content;\r\n\r\n        return sanitizeData({\r\n            id: chatDoc.id,\r\n            name: chatData.name || null,\r\n            isGroup: chatData.isGroup || false,\r\n            participants: chatData.participants || [],\r\n            otherUser,\r\n            lastMessage,\r\n            lastMessageAt: chatData.lastMessageAt\r\n        });\r\n    }));\r\n\r\n    // Sort in memory to ensure correct order even if fallback was used\r\n    enrichedChats.sort((a, b) => {\r\n        const dateA = a.lastMessageAt?.toDate ? a.lastMessageAt.toDate() : new Date(0);\r\n        const dateB = b.lastMessageAt?.toDate ? b.lastMessageAt.toDate() : new Date(0);\r\n        return dateB.getTime() - dateA.getTime();\r\n    });\r\n\r\n    return enrichedChats;\r\n}\r\n\r\nexport async function getMessages(chatId: string): Promise<Message[]> {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    // Verify access\r\n    const chatDoc = await adminDb.collection(\"chats\").doc(chatId).get();\r\n    if (!chatDoc.exists) {\r\n        throw new Error(\"Chat not found\");\r\n    }\r\n\r\n    const chatData = chatDoc.data();\r\n    if (!chatData?.participants.includes(user.id)) {\r\n        throw new Error(\"Access denied\");\r\n    }\r\n\r\n    // Fetch messages\r\n    let messagesSnapshot;\r\n    try {\r\n        messagesSnapshot = await adminDb.collection(\"chats\").doc(chatId).collection(\"messages\")\r\n            .orderBy(\"createdAt\", \"asc\")\r\n            .limit(50)\r\n            .get();\r\n    } catch (e) {\r\n        console.error(\"Error fetching messages:\", e);\r\n        return [];\r\n    }\r\n\r\n    return messagesSnapshot.docs.map((msgDoc: any) => sanitizeData({\r\n        id: msgDoc.id,\r\n        ...msgDoc.data(),\r\n    })) as Message[];\r\n}\r\n\r\nexport async function sendMessage(chatId: string, content: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    if (!content.trim()) return;\r\n\r\n    // Verify access\r\n    const chatRef = adminDb.collection(\"chats\").doc(chatId);\r\n    const chatDoc = await chatRef.get();\r\n    if (!chatDoc.exists) {\r\n        throw new Error(\"Chat not found\");\r\n    }\r\n\r\n    const chatData = chatDoc.data();\r\n    if (!chatData?.participants.includes(user.id)) {\r\n        throw new Error(\"Access denied\");\r\n    }\r\n\r\n    // Add message to subcollection\r\n    await chatRef.collection(\"messages\").add({\r\n        senderId: user.id,\r\n        content: content.trim(),\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // Update conversation timestamp\r\n    await chatRef.update({\r\n        lastMessageAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    revalidatePath(\"/messages\");\r\n    return { success: true };\r\n}\r\n\r\nexport async function sendWelcomeMessage(targetUserId: string, targetUserDisplayName: string) {\r\n    // 1. Find Admin User\r\n    const adminQuery = await adminDb.collection(\"users\")\r\n        .where(\"email\", \"==\", \"chancellor@ichancetek.com\")\r\n        .limit(1)\r\n        .get();\r\n\r\n    if (adminQuery.empty) {\r\n        console.error(\"Welcome Message Error: Admin user 'chancellor@ichancetek.com' not found.\");\r\n        return;\r\n    }\r\n\r\n    const adminUser = adminQuery.docs[0];\r\n    const adminId = adminUser.id;\r\n\r\n    if (adminId === targetUserId) return; // Don't welcome yourself if you are the admin signing up\r\n\r\n    // 2. Check/Create Chat\r\n    // Use adminDb directly to bypass auth checks (since we are acting as system/admin)\r\n    const chatsSnapshot = await adminDb.collection(\"chats\")\r\n        .where(\"participants\", \"array-contains\", targetUserId)\r\n        .get();\r\n\r\n    // Find existing 1-on-1 chat with Admin\r\n    let chatDoc = chatsSnapshot.docs.find((chatDoc: any) => {\r\n        const chatData = chatDoc.data();\r\n        return !chatData.isGroup && chatData.participants.includes(adminId);\r\n    });\r\n\r\n    let chatId;\r\n    if (chatDoc) {\r\n        chatId = chatDoc.id;\r\n    } else {\r\n        const newChatRef = await adminDb.collection(\"chats\").add({\r\n            participants: [targetUserId, adminId],\r\n            isGroup: false,\r\n            lastMessageAt: FieldValue.serverTimestamp(),\r\n            createdAt: FieldValue.serverTimestamp(),\r\n        });\r\n        chatId = newChatRef.id;\r\n    }\r\n\r\n    // 3. Send Message\r\n    const welcomeText = `Welcome to the Famio Family!\r\n\r\nThank you for joining us ‚Äî we‚Äôre excited to have you here. We hope you enjoy a wonderful experience on the Famio platform as you connect, share, and grow with the community.\r\n\r\nThese are exciting times at Famio! We‚Äôre rolling out new enhancements and updates every week to make your experience even better.\r\n\r\nWe truly appreciate you being part of the Famio Family.\r\n\r\nBest regards,\r\nChancellor Minus\r\nFounder & CEO\r\nChanceTEK | Famio`;\r\n\r\n    await adminDb.collection(\"chats\").doc(chatId).collection(\"messages\").add({\r\n        senderId: adminId,\r\n        content: welcomeText,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    await adminDb.collection(\"chats\").doc(chatId).update({\r\n        lastMessageAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // Notify the user? We can try createNotification if needed, but the chat system usually handles it or the user sees it in messages.\r\n    // Let's ensure notification exists.\r\n    try {\r\n        const { createNotification } = await import(\"./notifications\");\r\n        await createNotification(\r\n            targetUserId,\r\n            \"message\",\r\n            chatId,\r\n            { message: \"You have a new message from Chancellor Minus\" }\r\n        );\r\n    } catch (error) {\r\n        console.error(\"Failed to send welcome notification:\", error);\r\n    }\r\n\r\n    console.log(`Welcome message sent to ${targetUserDisplayName} (${targetUserId}) from Admin.`);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\crypto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\debug.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[691,694],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[691,694],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\n\r\nexport async function debugEnv() {\r\n    try {\r\n        const postsRef = adminDb.collection(\"posts\");\r\n        const countSnapshot = await postsRef.count().get();\r\n\r\n        return {\r\n            projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || process.env.GOOGLE_CLOUD_PROJECT || \"unknown\",\r\n            numPosts: countSnapshot.data().count,\r\n            envProjectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || process.env.GOOGLE_CLOUD_PROJECT || \"N/A\",\r\n            nodeEnv: process.env.NODE_ENV,\r\n            serviceAccount: process.env.FIREBASE_CLIENT_EMAIL ? \"Custom\" : \"ADC\"\r\n        };\r\n    } catch (e: any) {\r\n        return {\r\n            error: e.message,\r\n            projectId: \"ALLOCATION_FAILED\"\r\n        }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\engagement.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1431,1434],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1431,1434],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\nimport { getFamilyMemberIds } from \"./family\";\r\nimport { EngagementPermissions, PostActivity } from \"@/types/engagement\";\r\n\r\n/**\r\n * Check if a user has permission to engage with a post\r\n * Based on friend status and blocked users\r\n */\r\nexport async function checkEngagementPermissions(\r\n    postAuthorId: string,\r\n    postPrivacy: 'public' | 'friends' | 'private' = 'friends',\r\n    allowLikes: boolean = true,\r\n    allowComments: boolean = true\r\n): Promise<EngagementPermissions> {\r\n    const currentUser = await getUserProfile();\r\n\r\n    // Not logged in - can only view public posts, no engagement\r\n    if (!currentUser) {\r\n        return {\r\n            canView: postPrivacy === 'public',\r\n            canLike: false,\r\n            canComment: false,\r\n            canReply: false,\r\n            reason: 'Please log in to engage with posts'\r\n        };\r\n    }\r\n\r\n    // Own post - full access\r\n    if (currentUser.id === postAuthorId) {\r\n        return {\r\n            canView: true,\r\n            canLike: true,\r\n            canComment: allowComments,\r\n            canReply: allowComments,\r\n        };\r\n    }\r\n\r\n    // Check if blocked\r\n    const blockedSnapshot = await adminDb.collection(\"blockedUsers\").get();\r\n    const isBlocked = blockedSnapshot.docs.some((doc: any) => {\r\n        const data = doc.data();\r\n        return (\r\n            (data.blockerId === currentUser.id && data.blockedId === postAuthorId) ||\r\n            (data.blockerId === postAuthorId && data.blockedId === currentUser.id)\r\n        );\r\n    });\r\n\r\n    if (isBlocked) {\r\n        return {\r\n            canView: false,\r\n            canLike: false,\r\n            canComment: false,\r\n            canReply: false,\r\n            reason: 'This content is not available'\r\n        };\r\n    }\r\n\r\n    // Check friend status\r\n    const familyIds = await getFamilyMemberIds(postAuthorId);\r\n    const isFriend = familyIds.includes(currentUser.id);\r\n\r\n    // Handle privacy levels\r\n    if (postPrivacy === 'private') {\r\n        return {\r\n            canView: false,\r\n            canLike: false,\r\n            canComment: false,\r\n            canReply: false,\r\n            reason: 'This post is private'\r\n        };\r\n    }\r\n\r\n    if (postPrivacy === 'friends' && !isFriend) {\r\n        return {\r\n            canView: false,\r\n            canLike: false,\r\n            canComment: false,\r\n            canReply: false,\r\n            reason: 'Connect as friends to view this content'\r\n        };\r\n    }\r\n\r\n    // Public post visible to non-friends but engagement requires friendship\r\n    if (postPrivacy === 'public' && !isFriend) {\r\n        return {\r\n            canView: true,\r\n            canLike: false,\r\n            canComment: false,\r\n            canReply: false,\r\n            reason: 'Connect as friends to engage with this post'\r\n        };\r\n    }\r\n\r\n    // Friends can engage based on post settings\r\n    return {\r\n        canView: true,\r\n        canLike: isFriend && allowLikes,\r\n        canComment: isFriend && allowComments,\r\n        canReply: isFriend && allowComments,\r\n    };\r\n}\r\n\r\n/**\r\n * Get detailed activity for a post\r\n * Shows who liked, recent comments, etc.\r\n */\r\nexport async function getPostActivity(postId: string, contextType?: string, contextId?: string): Promise<PostActivity | null> {\r\n    const user = await getUserProfile();\r\n    if (!user) return null;\r\n\r\n    // Get post reference\r\n    let postRef;\r\n    if (contextType === 'group' && contextId) {\r\n        postRef = adminDb.collection(\"groups\").doc(contextId).collection(\"posts\").doc(postId);\r\n    } else if (contextType === 'branding' && contextId) {\r\n        postRef = adminDb.collection(\"pages\").doc(contextId).collection(\"posts\").doc(postId);\r\n    } else {\r\n        postRef = adminDb.collection(\"posts\").doc(postId);\r\n    }\r\n\r\n    const postDoc = await postRef.get();\r\n    if (!postDoc.exists) return null;\r\n\r\n    const postData = postDoc.data()!;\r\n\r\n    // Get all reactions with user details\r\n    const reactions = postData.reactions || {};\r\n    const recentLikes = await Promise.all(\r\n        Object.entries(reactions).slice(-10).map(async ([userId, reactionType]) => {\r\n            const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n            const userData = userDoc.data();\r\n            return {\r\n                userId,\r\n                displayName: userData?.displayName || 'Unknown',\r\n                imageUrl: userData?.imageUrl,\r\n                reactionType: reactionType as string,\r\n                timestamp: new Date().toISOString() // We don't store reaction timestamps currently\r\n            };\r\n        })\r\n    );\r\n\r\n    // Get comments with replies\r\n    const commentsSnapshot = await postRef.collection(\"comments\")\r\n        .orderBy(\"createdAt\", \"desc\")\r\n        .limit(5)\r\n        .get();\r\n\r\n    const recentComments = await Promise.all(\r\n        commentsSnapshot.docs.map(async (doc) => {\r\n            const commentData = doc.data();\r\n            const authorDoc = await adminDb.collection(\"users\").doc(commentData.authorId).get();\r\n            const authorData = authorDoc.data();\r\n\r\n            // Count replies\r\n            const repliesSnapshot = await doc.ref.collection(\"replies\").get();\r\n\r\n            return {\r\n                id: doc.id,\r\n                authorId: commentData.authorId,\r\n                displayName: authorData?.displayName || 'Unknown',\r\n                imageUrl: authorData?.imageUrl,\r\n                content: commentData.content,\r\n                timestamp: commentData.createdAt?.toDate ? commentData.createdAt.toDate().toISOString() : new Date().toISOString(),\r\n                replyCount: repliesSnapshot.size\r\n            };\r\n        })\r\n    );\r\n\r\n    // Count total comments and replies\r\n    const allCommentsSnapshot = await postRef.collection(\"comments\").get();\r\n    let totalReplies = 0;\r\n\r\n    for (const commentDoc of allCommentsSnapshot.docs) {\r\n        const repliesSnapshot = await commentDoc.ref.collection(\"replies\").get();\r\n        totalReplies += repliesSnapshot.size;\r\n    }\r\n\r\n    return sanitizeData({\r\n        postId,\r\n        likeCount: Object.keys(reactions).length,\r\n        commentCount: allCommentsSnapshot.size,\r\n        replyCount: totalReplies,\r\n        recentLikes,\r\n        recentComments\r\n    });\r\n}\r\n\r\n/**\r\n * Check if two users are friends\r\n */\r\nexport async function checkFriendStatus(userId: string, targetId: string): Promise<boolean> {\r\n    const familyIds = await getFamilyMemberIds(userId);\r\n    return familyIds.includes(targetId);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\events.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1917,1920],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1917,1920],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":85,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2772,2775],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2772,2775],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue, Timestamp } from \"firebase-admin/firestore\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nexport type Event = {\r\n    id: string;\r\n    title: string;\r\n    description: string | null;\r\n    date: Date;\r\n    location: string | null;\r\n    creatorId: string;\r\n    attendees: string[]; // User IDs\r\n    createdAt: Date;\r\n    creator?: {\r\n        displayName: string | null;\r\n        imageUrl: string | null;\r\n    };\r\n    attendeeProfiles?: {\r\n        displayName: string | null;\r\n        imageUrl: string | null;\r\n    }[];\r\n}\r\n\r\nexport type EventForm = {\r\n    title: string;\r\n    description?: string;\r\n    date: Date;\r\n    location?: string;\r\n}\r\n\r\nexport async function createEvent(data: EventForm) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const docRef = await adminDb.collection(\"events\").add({\r\n        creatorId: user.id,\r\n        title: data.title,\r\n        description: data.description || null,\r\n        date: Timestamp.fromDate(data.date),\r\n        location: data.location || null,\r\n        attendees: [user.id], // Creator attends by default\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"event.create\", {\r\n        targetType: \"event\",\r\n        targetId: docRef.id, // Need to capture docRef from add()\r\n        details: { title: data.title }\r\n    });\r\n\r\n    revalidatePath(\"/events\");\r\n    return { success: true };\r\n}\r\n\r\nexport async function getEvents(): Promise<Event[]> {\r\n    try {\r\n        const eventsSnapshot = await adminDb.collection(\"events\").orderBy(\"date\", \"desc\").get();\r\n\r\n        // Collect all unique user IDs\r\n        const allUserIds = new Set<string>();\r\n        eventsSnapshot.docs.forEach((eventDoc: any) => {\r\n            const eventData = eventDoc.data();\r\n            allUserIds.add(eventData.creatorId);\r\n            (eventData.attendees || []).forEach((id: string) => allUserIds.add(id));\r\n        });\r\n\r\n        // Fetch all user profiles\r\n        const userProfiles = new Map();\r\n        await Promise.all(Array.from(allUserIds).map(async (userId) => {\r\n            const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n            if (userDoc.exists) {\r\n                const userData = userDoc.data();\r\n                userProfiles.set(userId, {\r\n                    displayName: userData?.displayName || \"Unknown\",\r\n                    imageUrl: userData?.imageUrl || null,\r\n                });\r\n            }\r\n        }));\r\n\r\n        // Build events with enriched data\r\n        const events = eventsSnapshot.docs.map((eventDoc: any) => {\r\n            const eventData = eventDoc.data();\r\n            const attendees = eventData.attendees || [];\r\n\r\n            // Serialize creator\r\n            const creator = userProfiles.get(eventData.creatorId) ? {\r\n                ...userProfiles.get(eventData.creatorId)\r\n            } : null;\r\n\r\n            return {\r\n                id: eventDoc.id,\r\n                title: eventData.title,\r\n                description: eventData.description || null,\r\n                date: eventData.date?.toDate ? eventData.date.toDate() : new Date(eventData.date || Date.now()),\r\n                location: eventData.location || null,\r\n                creatorId: eventData.creatorId,\r\n                attendees,\r\n                createdAt: eventData.createdAt?.toDate ? eventData.createdAt.toDate() : new Date(eventData.createdAt || Date.now()),\r\n                creator: creator,\r\n                attendeeProfiles: attendees.map((id: string) => userProfiles.get(id)).filter(Boolean),\r\n            };\r\n        });\r\n\r\n        return events;\r\n    } catch (error) {\r\n        console.error(\"Error fetching events:\", error);\r\n        return [];\r\n    }\r\n}\r\n\r\nexport async function joinEvent(eventId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const eventRef = adminDb.collection(\"events\").doc(eventId);\r\n    const eventSnap = await eventRef.get();\r\n\r\n    if (!eventSnap.exists) throw new Error(\"Event not found\");\r\n\r\n    const eventData = eventSnap.data();\r\n    const currentAttendees = eventData?.attendees || [];\r\n\r\n    if (!currentAttendees.includes(user.id)) {\r\n        await eventRef.update({\r\n            attendees: FieldValue.arrayUnion(user.id)\r\n        });\r\n    }\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"event.join\", {\r\n        targetType: \"event\",\r\n        targetId: eventId\r\n    });\r\n\r\n    revalidatePath(\"/events\");\r\n    return { success: true };\r\n}\r\n\r\nexport async function leaveEvent(eventId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const eventRef = adminDb.collection(\"events\").doc(eventId);\r\n    const eventSnap = await eventRef.get();\r\n\r\n    if (!eventSnap.exists) throw new Error(\"Event not found\");\r\n\r\n    await eventRef.update({\r\n        attendees: FieldValue.arrayRemove(user.id)\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"event.leave\", {\r\n        targetType: \"event\",\r\n        targetId: eventId\r\n    });\r\n\r\n    revalidatePath(\"/events\");\r\n    return { success: true };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\family.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":239,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8771,8774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8771,8774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":266,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":266,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9928,9931],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9928,9931],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":315,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":315,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11589,11592],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11589,11592],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":341,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":341,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12782,12785],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12782,12785],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\nimport { QueryDocumentSnapshot } from \"firebase-admin/firestore\";\r\n\r\nexport type FamilyStatus = {\r\n    status: 'none' | 'pending' | 'accepted' | 'rejected' | 'pending_sent' | 'pending_received';\r\n    requestId?: string;\r\n};\r\n\r\nexport async function sendFamilyRequest(receiverId: string) {\r\n    const user = await getUserProfile()\r\n    if (!user) throw new Error(\"Unauthorized\")\r\n    if (user.id === receiverId) throw new Error(\"Cannot add yourself\")\r\n\r\n    // Check if request already exists\r\n    // Check if request already exists (in either direction)\r\n    const [existingSent, existingReceived] = await Promise.all([\r\n        adminDb.collection(\"familyRequests\")\r\n            .where(\"senderId\", \"==\", user.id)\r\n            .where(\"receiverId\", \"==\", receiverId)\r\n            .get(),\r\n        adminDb.collection(\"familyRequests\")\r\n            .where(\"senderId\", \"==\", receiverId)\r\n            .where(\"receiverId\", \"==\", user.id)\r\n            .get()\r\n    ]);\r\n\r\n    if (!existingSent.empty || !existingReceived.empty) {\r\n        const status = !existingSent.empty ? existingSent.docs[0].data().status : existingReceived.docs[0].data().status;\r\n        if (status === 'accepted') throw new Error(\"You are already family\");\r\n        if (status === 'pending') throw new Error(\"A request is already pending between you\");\r\n        if (!existingSent.empty && status === 'rejected') {\r\n            // Allow resending if previously rejected? Maybe. But for now let's block to avoid spam.\r\n            // Or maybe we treat rejected as 'none' here to allow retry? \r\n            // Logic: If I sent it and it was rejected, I probably shouldn't spam.\r\n            throw new Error(\"Request was rejected previously.\");\r\n        }\r\n        // If received and rejected, maybe I can try again? \r\n        // Let's safe block for now.\r\n        // Actually, if existing reverse request exists, we should tell them to accept it!\r\n        if (!existingReceived.empty && status === 'pending') {\r\n            throw new Error(\"This person already sent you a request. Please accept it.\");\r\n        }\r\n    }\r\n\r\n    const docRef = await adminDb.collection(\"familyRequests\").add({\r\n        senderId: user.id,\r\n        receiverId: receiverId,\r\n        status: 'pending',\r\n        createdAt: new Date(),\r\n    });\r\n\r\n    revalidatePath(`/u/${receiverId}`)\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"family.request_sent\", {\r\n        targetType: \"user\",\r\n        targetId: receiverId,\r\n        details: { requestId: docRef.id }\r\n    });\r\n\r\n    return docRef.id;\r\n}\r\n\r\nexport async function acceptFamilyRequest(requestId: string) {\r\n    const requestDoc = await adminDb.collection(\"familyRequests\").doc(requestId).get();\r\n    const requestData = requestDoc.data();\r\n\r\n    if (!requestData) throw new Error(\"Request not found\");\r\n\r\n    // Update request status\r\n    await adminDb.collection(\"familyRequests\").doc(requestId).update({\r\n        status: 'accepted'\r\n    });\r\n\r\n    // Create denormalized bidirectional family connections for efficient security rules\r\n    const batch = adminDb.batch();\r\n\r\n    // Connection from sender to receiver\r\n    const senderConnectionRef = adminDb.collection(\"users\")\r\n        .doc(requestData.senderId)\r\n        .collection(\"familyConnections\")\r\n        .doc(requestData.receiverId);\r\n    batch.set(senderConnectionRef, {\r\n        connectedUserId: requestData.receiverId,\r\n        status: 'accepted',\r\n        createdAt: new Date()\r\n    });\r\n\r\n    // Connection from receiver to sender\r\n    const receiverConnectionRef = adminDb.collection(\"users\")\r\n        .doc(requestData.receiverId)\r\n        .collection(\"familyConnections\")\r\n        .doc(requestData.senderId);\r\n    batch.set(receiverConnectionRef, {\r\n        connectedUserId: requestData.senderId,\r\n        status: 'accepted',\r\n        createdAt: new Date()\r\n    });\r\n\r\n    await batch.commit();\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"family.request_accepted\", {\r\n        targetType: \"family_request\",\r\n        targetId: requestId\r\n    });\r\n\r\n    revalidatePath('/family');\r\n    revalidatePath('/'); // Refresh home feed to show new posts\r\n}\r\n\r\nexport async function rejectFamilyRequest(requestId: string) {\r\n    const requestDoc = await adminDb.collection(\"familyRequests\").doc(requestId).get();\r\n    const requestData = requestDoc.data();\r\n\r\n    await adminDb.collection(\"familyRequests\").doc(requestId).delete();\r\n\r\n    // Clean up any family connections if they exist\r\n    if (requestData) {\r\n        const batch = adminDb.batch();\r\n\r\n        const senderConnectionRef = adminDb.collection(\"users\")\r\n            .doc(requestData.senderId)\r\n            .collection(\"familyConnections\")\r\n            .doc(requestData.receiverId);\r\n        batch.delete(senderConnectionRef);\r\n\r\n        const receiverConnectionRef = adminDb.collection(\"users\")\r\n            .doc(requestData.receiverId)\r\n            .collection(\"familyConnections\")\r\n            .doc(requestData.senderId);\r\n        batch.delete(receiverConnectionRef);\r\n\r\n        await batch.commit();\r\n    }\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"family.request_rejected\", {\r\n        targetType: \"family_request\",\r\n        targetId: requestId\r\n    });\r\n\r\n    revalidatePath('/family');\r\n    revalidatePath('/');\r\n}\r\n\r\nexport async function cancelFamilyRequest(requestId: string) {\r\n    const requestDoc = await adminDb.collection(\"familyRequests\").doc(requestId).get();\r\n    const requestData = requestDoc.data();\r\n\r\n    await adminDb.collection(\"familyRequests\").doc(requestId).delete();\r\n\r\n    // Clean up any family connections if they exist\r\n    if (requestData) {\r\n        const batch = adminDb.batch();\r\n\r\n        const senderConnectionRef = adminDb.collection(\"users\")\r\n            .doc(requestData.senderId)\r\n            .collection(\"familyConnections\")\r\n            .doc(requestData.receiverId);\r\n        batch.delete(senderConnectionRef);\r\n\r\n        const receiverConnectionRef = adminDb.collection(\"users\")\r\n            .doc(requestData.receiverId)\r\n            .collection(\"familyConnections\")\r\n            .doc(requestData.senderId);\r\n        batch.delete(receiverConnectionRef);\r\n\r\n        await batch.commit();\r\n    }\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"family.request_cancelled\", {\r\n        targetType: \"family_request\",\r\n        targetId: requestId\r\n    });\r\n\r\n    revalidatePath('/family');\r\n    revalidatePath('/');\r\n}\r\n\r\nexport async function denyFamilyRequest(requestId: string) {\r\n    await adminDb.collection(\"familyRequests\").doc(requestId).update({\r\n        status: 'rejected'\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"family.request_rejected\", { // Reuse rejected for denied\r\n        targetType: \"family_request\",\r\n        targetId: requestId,\r\n        details: { action: 'deny' }\r\n    });\r\n\r\n    revalidatePath('/family')\r\n    revalidatePath('/')\r\n}\r\n\r\n// ... imports\r\n\r\n// Helper for serialization removed in favor of @/lib/serialization\r\n\r\n// ... send, accept, reject, cancel, deny ...\r\n\r\nexport async function getFamilyRequests() {\r\n    const user = await getUserProfile();\r\n    if (!user) return { incoming: [], sent: [] };\r\n\r\n    const incomingSnapshot = await adminDb.collection(\"familyRequests\")\r\n        .where(\"receiverId\", \"==\", user.id)\r\n        .where(\"status\", \"==\", 'pending')\r\n        .get();\r\n\r\n    const sentSnapshot = await adminDb.collection(\"familyRequests\")\r\n        .where(\"senderId\", \"==\", user.id)\r\n        .where(\"status\", \"==\", 'pending')\r\n        .get();\r\n\r\n    const incomingRequests = await Promise.all(incomingSnapshot.docs.map(async (doc: QueryDocumentSnapshot) => {\r\n        const data = doc.data();\r\n        const senderDoc = await adminDb.collection(\"users\").doc(data.senderId).get();\r\n\r\n        let sender = { email: 'Unknown', displayName: 'Unknown', imageUrl: null };\r\n        if (senderDoc.exists) {\r\n            const u = senderDoc.data();\r\n            const rawName = u?.displayName;\r\n            const profileName = u?.profileData?.firstName ? `${u.profileData.firstName} ${u.profileData.lastName || ''}`.trim() : null;\r\n            const emailName = u?.email?.split('@')[0];\r\n\r\n            sender = {\r\n                id: senderDoc.id,\r\n                email: u?.email,\r\n                imageUrl: u?.imageUrl,\r\n                displayName: (rawName && rawName !== \"Family Member\") ? rawName : (profileName || emailName || \"Unknown\")\r\n            } as any;\r\n        }\r\n\r\n        return {\r\n            id: doc.id,\r\n            ...data,\r\n            sender,\r\n            createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())\r\n        };\r\n    }));\r\n\r\n    const sentRequests = await Promise.all(sentSnapshot.docs.map(async (doc: QueryDocumentSnapshot) => {\r\n        const data = doc.data();\r\n        const receiverDoc = await adminDb.collection(\"users\").doc(data.receiverId).get();\r\n\r\n        let receiver = { email: 'Unknown', displayName: 'Unknown', imageUrl: null };\r\n        if (receiverDoc.exists) {\r\n            const u = receiverDoc.data();\r\n            const rawName = u?.displayName;\r\n            const profileName = u?.profileData?.firstName ? `${u.profileData.firstName} ${u.profileData.lastName || ''}`.trim() : null;\r\n            const emailName = u?.email?.split('@')[0];\r\n\r\n            receiver = {\r\n                id: receiverDoc.id,\r\n                email: u?.email,\r\n                imageUrl: u?.imageUrl,\r\n                displayName: (rawName && rawName !== \"Family Member\") ? rawName : (profileName || emailName || \"Unknown\")\r\n            } as any;\r\n        }\r\n\r\n        return {\r\n            id: doc.id,\r\n            ...data,\r\n            receiver,\r\n            createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())\r\n        };\r\n    }));\r\n\r\n    return {\r\n        incoming: sanitizeData(incomingRequests),\r\n        sent: sanitizeData(sentRequests)\r\n    };\r\n}\r\n\r\n// Alias for family page\r\nexport const getPendingRequests = getFamilyRequests;\r\n\r\n// Filter out invisible users and blocked users\r\n// Note: This is an unoptimized in-memory filter. For production, we'd need a dedicated search index (Algolia/Typesense)\r\n// or denormalized privacy flags.\r\n// or denormalized privacy flags.\r\nexport async function searchFamilyMembers(searchTerm: string) {\r\n    const currentUser = await getUserProfile();\r\n\r\n    // Filter out invisible users and blocked users\r\n    const usersSnapshot = await adminDb.collection(\"users\").get();\r\n\r\n    // Fetch blocked users\r\n    const blockedIds = new Set<string>();\r\n    if (currentUser) {\r\n        const blockedSnapshot = await adminDb.collection(\"blockedUsers\").get();\r\n        blockedSnapshot.docs.forEach((doc: QueryDocumentSnapshot) => {\r\n            const data = doc.data();\r\n            if (data.blockerId === currentUser.id || data.blockedId === currentUser.id) {\r\n                blockedIds.add(data.blockerId === currentUser.id ? data.blockedId : data.blockerId);\r\n            }\r\n        });\r\n    }\r\n\r\n    const allUsers = usersSnapshot.docs.map((doc: QueryDocumentSnapshot) => {\r\n        return {\r\n            id: doc.id,\r\n            ...doc.data()\r\n        };\r\n    });\r\n\r\n    const filteredUsers = allUsers.filter((u: any) => {\r\n        if (blockedIds.has(u.id)) return false;\r\n        // Don't show invisible users unless it's yourself (though why search for yourself?) or admin?\r\n        // Let's just hide invisible users from search completely except for admins.\r\n        if (u.isInvisible && u.id !== currentUser?.id && currentUser?.role !== 'admin') return false;\r\n\r\n        const name = (u.displayName || \"\").toLowerCase();\r\n        const email = (u.email || \"\").toLowerCase();\r\n\r\n        // Check for profile name fields (firstName/lastName)\r\n        const profileFirst = (u.profileData?.firstName || \"\").toLowerCase();\r\n        const profileLast = (u.profileData?.lastName || \"\").toLowerCase();\r\n        const profileFull = `${profileFirst} ${profileLast}`.trim();\r\n\r\n        const search = searchTerm.toLowerCase();\r\n\r\n        return (\r\n            name.includes(search) ||\r\n            email.includes(search) ||\r\n            profileFirst.includes(search) ||\r\n            profileLast.includes(search) ||\r\n            profileFull.includes(search)\r\n        );\r\n    });\r\n\r\n    // Enhance with family status & Return Strict POJOs\r\n    const usersWithStatus = await Promise.all(filteredUsers.map(async (u: any) => {\r\n        const status = await getFamilyStatus(u.id);\r\n\r\n        // Return ONLY what the UI needs, ensuring simple types\r\n        return {\r\n            id: u.id,\r\n            displayName: u.displayName || null,\r\n            email: u.email || null,\r\n            imageUrl: u.imageUrl || null,\r\n            isInvisible: !!u.isInvisible,\r\n            familyStatus: {\r\n                status: status.status,\r\n                requestId: status.requestId || null\r\n            }\r\n        };\r\n    }));\r\n\r\n    // Double safety: JSON parse/stringify to guarantee POJO\r\n    return JSON.parse(JSON.stringify(usersWithStatus));\r\n}\r\n\r\n// Alias for backward compatibility\r\nexport const searchUsers = searchFamilyMembers;\r\n\r\nexport async function getFamilyMembers() {\r\n    const user = await getUserProfile();\r\n    if (!user) return [];\r\n\r\n    // Use getFamilyMemberIds to get the IDs first (which handles blocking logic)\r\n    const familyIds = await getFamilyMemberIds(user.id);\r\n\r\n    // Fetch family member details\r\n    const familyMembers = await Promise.all(\r\n        familyIds.map(async id => {\r\n            const userDoc = await adminDb.collection(\"users\").doc(id).get();\r\n            if (userDoc.exists) {\r\n                const data = userDoc.data()!;\r\n                const rawName = data.displayName;\r\n                const profileName = data.profileData?.firstName ? `${data.profileData.firstName} ${data.profileData.lastName || ''}`.trim() : null;\r\n                const emailName = data.email?.split('@')[0];\r\n                const cleanName = (rawName && rawName !== \"Family Member\") ? rawName : (profileName || emailName || \"Unknown\");\r\n\r\n                return {\r\n                    id: userDoc.id,\r\n                    ...data,\r\n                    displayName: cleanName,\r\n                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())\r\n                };\r\n            }\r\n            return null;\r\n        })\r\n    );\r\n\r\n    return sanitizeData(familyMembers.filter(Boolean));\r\n}\r\n\r\nexport async function getFamilyMemberIds(userId: string) {\r\n    const familyIds = new Set<string>();\r\n\r\n    // 1. Efficient Family Connections (Subcollection)\r\n    try {\r\n        const connectionsSnap = await adminDb.collection(\"users\")\r\n            .doc(userId)\r\n            .collection(\"familyConnections\")\r\n            .where(\"status\", \"==\", \"accepted\")\r\n            .get();\r\n\r\n        connectionsSnap.forEach(doc => {\r\n            if (doc.data().connectedUserId) {\r\n                familyIds.add(doc.data().connectedUserId);\r\n            }\r\n        });\r\n    } catch (e) {\r\n        console.error(\"Error fetching familyConnections:\", e);\r\n    }\r\n\r\n    // 2. Legacy/Fallback: Family Requests (Bidirectional)\r\n    try {\r\n        const [sentSnapshot, receivedSnapshot] = await Promise.all([\r\n            adminDb.collection(\"familyRequests\")\r\n                .where(\"senderId\", \"==\", userId)\r\n                .where(\"status\", \"==\", 'accepted')\r\n                .get(),\r\n            adminDb.collection(\"familyRequests\")\r\n                .where(\"receiverId\", \"==\", userId)\r\n                .where(\"status\", \"==\", 'accepted')\r\n                .get()\r\n        ]);\r\n\r\n        sentSnapshot.forEach((doc: QueryDocumentSnapshot) => familyIds.add(doc.data().receiverId));\r\n        receivedSnapshot.forEach((doc: QueryDocumentSnapshot) => familyIds.add(doc.data().senderId));\r\n    } catch (e) {\r\n        console.error(\"Error fetching familyRequests:\", e);\r\n    }\r\n\r\n    // 3. Filter out blocked users (Optimized)\r\n    try {\r\n        const [blockedBySnapshot, blockingSnapshot] = await Promise.all([\r\n            adminDb.collection(\"blockedUsers\").where(\"blockerId\", \"==\", userId).get(),\r\n            adminDb.collection(\"blockedUsers\").where(\"blockedId\", \"==\", userId).get()\r\n        ]);\r\n\r\n        const blockedIds = new Set<string>();\r\n        blockedBySnapshot.forEach((doc: QueryDocumentSnapshot) => blockedIds.add(doc.data().blockedId));\r\n        blockingSnapshot.forEach((doc: QueryDocumentSnapshot) => blockedIds.add(doc.data().blockerId));\r\n\r\n        blockedIds.forEach(blockedId => familyIds.delete(blockedId));\r\n    } catch (e) {\r\n        console.error(\"Error fetching blockedUsers:\", e);\r\n    }\r\n\r\n    return Array.from(familyIds);\r\n}\r\n\r\n// ... family members ...\r\n\r\nexport async function getFamilyStatus(targetUserId: string): Promise<FamilyStatus> {\r\n    const user = await getUserProfile();\r\n    if (!user) return { status: 'none' } as FamilyStatus;\r\n\r\n    const [sentSnapshot, receivedSnapshot] = await Promise.all([\r\n        adminDb.collection(\"familyRequests\")\r\n            .where(\"senderId\", \"==\", user.id)\r\n            .where(\"receiverId\", \"==\", targetUserId)\r\n            .get(),\r\n        adminDb.collection(\"familyRequests\")\r\n            .where(\"senderId\", \"==\", targetUserId)\r\n            .where(\"receiverId\", \"==\", user.id)\r\n            .get()\r\n    ]);\r\n\r\n    const sentData = !sentSnapshot.empty ? sentSnapshot.docs[0].data() : null;\r\n    const receivedData = !receivedSnapshot.empty ? receivedSnapshot.docs[0].data() : null;\r\n\r\n    // Check for ANY accepted status first\r\n    if (sentData?.status === 'accepted') return { status: 'accepted', requestId: sentSnapshot.docs[0].id };\r\n    if (receivedData?.status === 'accepted') return { status: 'accepted', requestId: receivedSnapshot.docs[0].id };\r\n\r\n    // Then check for pending logic\r\n    // If I sent a request, I see 'pending_sent'\r\n    if (sentData?.status === 'pending') return { status: 'pending_sent', requestId: sentSnapshot.docs[0].id };\r\n\r\n    // If I received a request, I see 'pending_received' (or just 'pending' which UI interprets)\r\n    // The UI likely expects 'pending' or 'pending_received'. \r\n    // Looking at family-request-button.tsx might help, but let's stick to standard 'pending' or differentiate.\r\n    // Existing code returned raw status. 'pending' usually implies \"I can accept it\" or \"Waiting\".\r\n    // If received, I CAN accept it.\r\n    if (receivedData?.status === 'pending') return { status: 'pending_received', requestId: receivedSnapshot.docs[0].id };\r\n\r\n    // If rejected?\r\n    if (sentData?.status === 'rejected') return { status: 'rejected', requestId: sentSnapshot.docs[0].id };\r\n    // Received rejected? user shouldn't probably know? or yes?\r\n\r\n    return { status: 'none' };\r\n}\r\n\r\nexport async function getUserFamilyMembers(targetUserId: string) {\r\n    const currentUser = await getUserProfile();\r\n    if (!currentUser) return [];\r\n\r\n    // 1. Check permissions\r\n    // Allow if: Own Profile OR Admin OR Accepted Family\r\n    const isOwnProfile = currentUser.id === targetUserId;\r\n    const isAdmin = currentUser.role === 'admin';\r\n    let hasAccess = isOwnProfile || isAdmin;\r\n\r\n    if (!hasAccess) {\r\n        const familyStatus = await getFamilyStatus(targetUserId);\r\n        if (familyStatus.status === 'accepted') {\r\n            hasAccess = true;\r\n        }\r\n    }\r\n\r\n    if (!hasAccess) {\r\n        // Return empty or throw? Return empty for safety so UI just shows nothing.\r\n        return [];\r\n    }\r\n\r\n    // 2. Fetch Family Members of the TARGET user\r\n    const familyIds = await getFamilyMemberIds(targetUserId);\r\n\r\n    // 3. Hydrate details\r\n    const familyMembers = await Promise.all(\r\n        familyIds.map(async id => {\r\n            const userDoc = await adminDb.collection(\"users\").doc(id).get();\r\n            if (userDoc.exists) {\r\n                const data = userDoc.data()!;\r\n                return {\r\n                    id: userDoc.id,\r\n                    ...data,\r\n                    // Sanitize sensitive fields? \r\n                    // Family members can generally see other family members' basic info.\r\n                    // Let's stick to standard public profile fields.\r\n                    displayName: data.displayName,\r\n                    imageUrl: data.imageUrl,\r\n                    email: data.email, // Maybe? \r\n                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())\r\n                };\r\n            }\r\n            return null;\r\n        })\r\n    );\r\n\r\n    return sanitizeData(familyMembers.filter(Boolean));\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\groups.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[636,639],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[636,639],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[675,678],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[675,678],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":86,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":86,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":93,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2877,2880],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2877,2880],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":180,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5630,5633],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5630,5633],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":294,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":294,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10050,10053],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10050,10053],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":374,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":374,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12931,12934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12931,12934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { slugify } from \"@/lib/utils\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\n\r\nexport type Group = {\r\n    id: string;\r\n    slug?: string;\r\n    name: string;\r\n    description: string;\r\n    category: string;\r\n    privacy: 'public' | 'private';\r\n    founderId: string;\r\n    imageUrl?: string;\r\n    coverUrl?: string;\r\n    createdAt: Date;\r\n    memberCount?: number;\r\n    isMember?: boolean;\r\n    deletedAt?: any;\r\n    scheduledPermanentDeleteAt?: any;\r\n};\r\n\r\nexport async function createGroup(data: { name: string; description: string; category: string; privacy: 'public' | 'private'; imageUrl?: string; coverUrl?: string }) {\r\n    console.log(\"Creating group\", data);\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    let slug = slugify(data.name);\r\n    let potentialId = slug;\r\n    let counter = 0;\r\n\r\n    // Check for uniqueness\r\n    while (true) {\r\n        // 1. Check ID collision\r\n        const doc = await adminDb.collection(\"groups\").doc(potentialId).get();\r\n        if (doc.exists) {\r\n            counter++;\r\n            potentialId = `${slug}-${counter}`;\r\n            continue;\r\n        }\r\n\r\n        // 2. Check Slug collision (for old groups)\r\n        const slugCheck = await adminDb.collection(\"groups\").where(\"slug\", \"==\", potentialId).limit(1).get();\r\n        if (!slugCheck.empty) {\r\n            counter++;\r\n            potentialId = `${slug}-${counter}`;\r\n            continue;\r\n        }\r\n\r\n        break;\r\n    }\r\n\r\n    const groupRef = adminDb.collection(\"groups\").doc(potentialId);\r\n    await groupRef.set({\r\n        ...data,\r\n        slug: potentialId, // Force slug to match ID for new groups\r\n        founderId: user.id,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n        memberCount: 1, // Founder is first member\r\n    });\r\n\r\n    // Add founder as admin member\r\n    await groupRef.collection(\"members\").doc(user.id).set({\r\n        userId: user.id,\r\n        role: 'admin',\r\n        joinedAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"group.create\", {\r\n        targetType: \"group\",\r\n        targetId: groupRef.id,\r\n        details: { name: data.name }\r\n    });\r\n\r\n    revalidatePath('/groups');\r\n    return groupRef.id;\r\n}\r\n\r\nexport async function getGroups() {\r\n    const user = await getUserProfile();\r\n    const groupsSnapshot = await adminDb.collection(\"groups\").orderBy(\"createdAt\", \"desc\").get();\r\n\r\n    // In a real app, we might want to check membership for each group efficiently\r\n    // For now, we'll just return the groups.\r\n\r\n    return groupsSnapshot.docs\r\n        .map((doc: any) => {\r\n            return sanitizeData({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            }) as Group;\r\n        })\r\n        .filter(g => !g.deletedAt); // Filter out soft-deleted groups by default\r\n}\r\n\r\nexport async function getGroup(identifier: string) {\r\n    // 1. Try by ID (Fastest/Default for new groups)\r\n    let doc = await adminDb.collection(\"groups\").doc(identifier).get();\r\n\r\n    // 2. If not found, try by slug (for old groups migrated to have slugs)\r\n    if (!doc.exists) {\r\n        const snapshot = await adminDb.collection(\"groups\").where(\"slug\", \"==\", identifier).limit(1).get();\r\n        if (!snapshot.empty) {\r\n            doc = snapshot.docs[0];\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    return sanitizeData({\r\n        id: doc.id,\r\n        ...doc.data()\r\n    }) as Group;\r\n}\r\n\r\nexport async function joinGroup(groupId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const memberRef = adminDb.collection(\"groups\").doc(groupId).collection(\"members\").doc(user.id);\r\n    const memberDoc = await memberRef.get();\r\n\r\n    if (memberDoc.exists) return; // Already a member\r\n\r\n    await memberRef.set({\r\n        userId: user.id,\r\n        role: 'member',\r\n        joinedAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // Increment member count\r\n    await adminDb.collection(\"groups\").doc(groupId).update({\r\n        memberCount: FieldValue.increment(1)\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"group.join\", {\r\n        targetType: \"group\",\r\n        targetId: groupId\r\n    });\r\n\r\n    revalidatePath(`/groups/${groupId}`);\r\n    revalidatePath('/groups');\r\n}\r\n\r\nexport async function leaveGroup(groupId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"groups\").doc(groupId).collection(\"members\").doc(user.id).delete();\r\n\r\n    // Decrement member count\r\n    await adminDb.collection(\"groups\").doc(groupId).update({\r\n        memberCount: FieldValue.increment(-1)\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"group.leave\", {\r\n        targetType: \"group\",\r\n        targetId: groupId\r\n    });\r\n\r\n    revalidatePath(`/groups/${groupId}`);\r\n    revalidatePath('/groups');\r\n}\r\n\r\nexport async function getGroupMemberStatus(groupId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) return null;\r\n\r\n    const memberDoc = await adminDb.collection(\"groups\").doc(groupId).collection(\"members\").doc(user.id).get();\r\n    if (!memberDoc.exists) return null;\r\n\r\n    return sanitizeData(memberDoc.data()) as { role: 'admin' | 'member', joinedAt: any };\r\n}\r\n\r\nexport async function createGroupPost(groupId: string, content: string, mediaUrls: string[] = []) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    // Check membership\r\n    const memberStatus = await getGroupMemberStatus(groupId);\r\n    if (!memberStatus) throw new Error(\"Must be a member to post\");\r\n\r\n    const docRef = await adminDb.collection(\"groups\").doc(groupId).collection(\"posts\").add({\r\n        authorId: user.id,\r\n        content,\r\n        mediaUrls,\r\n        likes: [],\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"group.post_create\", {\r\n        targetType: \"group_post\",\r\n        targetId: docRef.id,\r\n        details: { groupId, content: content.substring(0, 50) }\r\n    });\r\n\r\n    // Revalidate ID and Slug\r\n    const group = await getGroup(groupId);\r\n    revalidatePath(`/groups/${groupId}`);\r\n    if (group?.slug) revalidatePath(`/groups/${group.slug}`);\r\n}\r\n\r\n\r\n\r\nexport async function editGroupPost(groupId: string, postId: string, content: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = adminDb.collection(\"groups\").doc(groupId).collection(\"posts\").doc(postId);\r\n    const postDoc = await postRef.get();\r\n\r\n    if (!postDoc.exists) throw new Error(\"Post not found\");\r\n    // Only author can edit\r\n    if (postDoc.data()?.authorId !== user.id) throw new Error(\"Unauthorized\");\r\n\r\n    await postRef.update({\r\n        content,\r\n        isEdited: true,\r\n        updatedAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    // Revalidate both ID and Slug paths to ensure real-time updates work regardless of URL\r\n    const group = await getGroup(groupId);\r\n    revalidatePath(`/groups/${groupId}`);\r\n    if (group?.slug) revalidatePath(`/groups/${group.slug}`);\r\n}\r\n\r\nimport { PostFilters } from \"./posts\";\r\n\r\nexport async function getGroupPosts(groupId: string, limit = 50, filters: PostFilters = { timeRange: 'all', contentType: 'all' }) {\r\n    const user = await getUserProfile();\r\n    if (!user) return [];\r\n\r\n    // Check privacy\r\n    const group = await getGroup(groupId);\r\n    if (group?.privacy === 'private') {\r\n        const memberStatus = await getGroupMemberStatus(groupId);\r\n        if (!memberStatus) return [];\r\n    }\r\n\r\n    const postsSnapshot = await adminDb.collection(\"groups\").doc(groupId).collection(\"posts\")\r\n        .orderBy(\"createdAt\", \"desc\")\r\n        .get();\r\n\r\n    let allDocs = postsSnapshot.docs;\r\n\r\n    // Filter Soft Deleted\r\n    allDocs = allDocs.filter(doc => !doc.data().isDeleted);\r\n\r\n    // Apply Memory Filters\r\n    if (filters.contentType !== 'all') {\r\n        allDocs = allDocs.filter(doc => {\r\n            const data = doc.data();\r\n            const hasMedia = data.mediaUrls && data.mediaUrls.length > 0;\r\n            const videoUrlRegex = /https?:\\/\\/(www\\.)?(youtube\\.com|youtu\\.be|facebook\\.com|linkedin\\.com|vimeo\\.com|ds1\\.chancetek.com)\\/\\S+/i;\r\n            const hasVideoLink = videoUrlRegex.test(data.content || \"\");\r\n            const isVideo = (hasMedia && data.mediaUrls.some((u: string) => u.match(/\\.(mp4|mov|webm)$/i))) || hasVideoLink;\r\n            const isPhoto = hasMedia && !isVideo;\r\n            const isText = !hasMedia && !hasVideoLink;\r\n\r\n            if (filters.contentType === 'video') return isVideo;\r\n            if (filters.contentType === 'photo') return isPhoto;\r\n            if (filters.contentType === 'text') return isText;\r\n            return true;\r\n        });\r\n    }\r\n\r\n    if (filters.timeRange !== 'all') {\r\n        const now = new Date();\r\n        const msPerDay = 24 * 60 * 60 * 1000;\r\n        allDocs = allDocs.filter(doc => {\r\n            const data = doc.data();\r\n            const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();\r\n            const diff = now.getTime() - createdAt.getTime();\r\n            if (filters.timeRange === 'day') return diff < msPerDay;\r\n            if (filters.timeRange === 'week') return diff < msPerDay * 7;\r\n            if (filters.timeRange === 'month') return diff < msPerDay * 30;\r\n            if (filters.timeRange === 'year') return diff < msPerDay * 365;\r\n            return true;\r\n        });\r\n    }\r\n\r\n    const slicedDocs = allDocs.slice(0, limit);\r\n\r\n    const allPosts = await Promise.all(slicedDocs.map(async (postDoc: any) => {\r\n        const postData = postDoc.data();\r\n\r\n        // Fetch author\r\n        const authorDoc = await adminDb.collection(\"users\").doc(postData.authorId).get();\r\n        const author = authorDoc.exists ? {\r\n            id: authorDoc.id,\r\n            displayName: authorDoc.data()?.displayName,\r\n            imageUrl: authorDoc.data()?.imageUrl,\r\n            email: authorDoc.data()?.email,\r\n        } : null;\r\n\r\n        // Fetch Group Name for Context\r\n        const groupSnap = await adminDb.collection(\"groups\").doc(groupId).get();\r\n        const groupName = groupSnap.data()?.name;\r\n\r\n        return sanitizeData({\r\n            id: postDoc.id,\r\n            content: postData.content || \"\",\r\n            mediaUrls: postData.mediaUrls || [],\r\n            createdAt: postData.createdAt,\r\n            likes: postData.likes || [],\r\n            reactions: postData.reactions || {},\r\n            authorId: postData.authorId,\r\n            author,\r\n            context: { type: 'group', id: groupId, name: groupName },\r\n            comments: []\r\n        });\r\n    }));\r\n\r\n    return allPosts;\r\n}\r\n\r\nexport async function getGroupPost(groupId: string, postId: string) {\r\n    try {\r\n        const postRef = adminDb.collection(\"groups\").doc(groupId).collection(\"posts\").doc(postId);\r\n        const doc = await postRef.get();\r\n        if (!doc.exists) return null;\r\n\r\n        const data = doc.data()!;\r\n\r\n        // Fetch Author\r\n        const authorDoc = await adminDb.collection(\"users\").doc(data.authorId).get();\r\n        const author = authorDoc.exists ? {\r\n            id: authorDoc.id,\r\n            displayName: authorDoc.data()?.displayName,\r\n            imageUrl: authorDoc.data()?.imageUrl,\r\n            email: authorDoc.data()?.email,\r\n        } : null;\r\n\r\n        // Fetch Group Name for Context\r\n        const groupSnap = await adminDb.collection(\"groups\").doc(groupId).get();\r\n        const groupName = groupSnap.data()?.name;\r\n\r\n        return sanitizeData({\r\n            id: doc.id,\r\n            content: data.content || \"\",\r\n            mediaUrls: data.mediaUrls || [],\r\n            createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(),\r\n            likes: data.likes || [],\r\n            reactions: data.reactions || {},\r\n            authorId: data.authorId,\r\n            author,\r\n            context: { type: 'group', id: groupId, name: groupName },\r\n            comments: []\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Error fetching group post:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function getJoinedGroupIds(userId: string) {\r\n    // Use collectionGroup query to find all 'members' docs where userId matches\r\n    const snapshot = await adminDb.collectionGroup(\"members\")\r\n        .where(\"userId\", \"==\", userId)\r\n        .get();\r\n\r\n    const groupIds = new Set<string>();\r\n\r\n    snapshot.docs.forEach((doc: any) => {\r\n        // Doc path: groups/{groupId}/members/{userId}\r\n        // doc.ref.parent is 'members' collection\r\n        // doc.ref.parent.parent is 'groups/{groupId}' doc\r\n        const groupDoc = doc.ref.parent.parent;\r\n        if (groupDoc) {\r\n            groupIds.add(groupDoc.id);\r\n        }\r\n    });\r\n\r\n    return Array.from(groupIds);\r\n}\r\n\r\nexport async function updateGroupCover(groupId: string, coverUrl: string | null) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    // Check if user is founder or admin\r\n    const groupDoc = await adminDb.collection(\"groups\").doc(groupId).get();\r\n    if (!groupDoc.exists) throw new Error(\"Group not found\");\r\n\r\n    const groupData = groupDoc.data();\r\n    const isFounder = groupData?.founderId === user.id;\r\n\r\n    if (!isFounder) {\r\n        // Check if admin member\r\n        const memberDoc = await adminDb.collection(\"groups\").doc(groupId).collection(\"members\").doc(user.id).get();\r\n        const isAdmin = memberDoc.exists && memberDoc.data()?.role === 'admin';\r\n        if (!isAdmin) {\r\n            throw new Error(\"Only group founder or admins can update the cover\");\r\n        }\r\n    }\r\n\r\n    await adminDb.collection(\"groups\").doc(groupId).update({\r\n        coverUrl: coverUrl || null\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"group.update_cover\", {\r\n        targetType: \"group\",\r\n        targetId: groupId,\r\n        details: { hasCover: !!coverUrl }\r\n    });\r\n\r\n    revalidatePath(`/groups/${groupId}`);\r\n    revalidatePath('/groups');\r\n}\r\n\r\n\r\nexport async function updateGroupDetails(groupId: string, data: { name?: string; description?: string; coverUrl?: string }) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const groupDoc = await adminDb.collection(\"groups\").doc(groupId).get();\r\n    if (!groupDoc.exists) throw new Error(\"Group not found\");\r\n\r\n    const groupData = groupDoc.data();\r\n    if (groupData?.founderId !== user.id) {\r\n        // Check if admin member\r\n        const memberDoc = await adminDb.collection(\"groups\").doc(groupId).collection(\"members\").doc(user.id).get();\r\n        if (!memberDoc.exists || memberDoc.data()?.role !== 'admin') {\r\n            throw new Error(\"Unauthorized\");\r\n        }\r\n    }\r\n\r\n    await adminDb.collection(\"groups\").doc(groupId).update({\r\n        ...data,\r\n        updatedAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    revalidatePath(`/groups/${groupId}`);\r\n    revalidatePath('/groups');\r\n}\r\n\r\nexport async function softDeleteGroup(groupId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const groupDoc = await adminDb.collection(\"groups\").doc(groupId).get();\r\n    if (!groupDoc.exists) throw new Error(\"Group not found\");\r\n\r\n    // Only founder can delete\r\n    if (groupDoc.data()?.founderId !== user.id) throw new Error(\"Only the founder can delete the group\");\r\n\r\n    const now = new Date();\r\n    const thirtyDaysLater = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));\r\n\r\n    await adminDb.collection(\"groups\").doc(groupId).update({\r\n        deletedAt: FieldValue.serverTimestamp(),\r\n        scheduledPermanentDeleteAt: thirtyDaysLater\r\n    });\r\n\r\n    revalidatePath(`/groups/${groupId}`);\r\n    revalidatePath('/groups');\r\n}\r\n\r\nexport async function restoreGroup(groupId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const groupDoc = await adminDb.collection(\"groups\").doc(groupId).get();\r\n    if (!groupDoc.exists) throw new Error(\"Group not found\");\r\n\r\n    if (groupDoc.data()?.founderId !== user.id) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"groups\").doc(groupId).update({\r\n        deletedAt: FieldValue.delete(),\r\n        scheduledPermanentDeleteAt: FieldValue.delete()\r\n    });\r\n\r\n    revalidatePath(`/groups/${groupId}`);\r\n    revalidatePath('/groups');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\landing-rag.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\linkedin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\news.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'unstable_cache' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"unstable_cache"},"fix":{"range":[16,60],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { unstable_cache } from 'next/cache';\r\n\r\nexport type NewsItem = {\r\n    title: string;\r\n    link: string;\r\n    source: string;\r\n    pubDate: string;\r\n    thumbnail?: string;\r\n    description?: string;\r\n    // AI-powered fields\r\n    aiSummary?: string[];\r\n    sentiment?: 'positive' | 'neutral' | 'negative';\r\n    whyItMatters?: string;\r\n};\r\n\r\nconst FEEDS: Record<string, string> = {\r\n    general: 'https://feeds.bbci.co.uk/news/rss.xml',\r\n    sports: 'https://www.espn.com/espn/rss/news',\r\n    tech: 'https://techcrunch.com/feed/',\r\n    business: 'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=10001147',\r\n    world: 'https://feeds.bbci.co.uk/news/world/rss.xml',\r\n};\r\n\r\nconst FEED_NAMES: Record<string, string> = {\r\n    general: 'BBC News',\r\n    sports: 'ESPN',\r\n    tech: 'TechCrunch',\r\n    business: 'CNBC',\r\n    world: 'BBC World',\r\n};\r\n\r\nasync function fetchFromUrl(url: string): Promise<string> {\r\n    const res = await fetch(url, { next: { revalidate: 300 } }); // Cache for 5 mins\r\n    if (!res.ok) throw new Error(`Failed to fetch RSS: ${res.statusText}`);\r\n    return res.text();\r\n}\r\n\r\nfunction parseRSS(xml: string, sourceName: string): NewsItem[] {\r\n    const items: NewsItem[] = [];\r\n\r\n    // Simple regex parser for basic RSS 2.0\r\n    // Matches <item>...</item>\r\n    const itemRegex = /<item>([\\s\\S]*?)<\\/item>/g;\r\n    let match;\r\n\r\n    while ((match = itemRegex.exec(xml)) !== null) {\r\n        const itemContent = match[1];\r\n\r\n        const title = extractTag(itemContent, 'title');\r\n        const link = extractTag(itemContent, 'link');\r\n        const pubDate = extractTag(itemContent, 'pubDate');\r\n        const description = extractTag(itemContent, 'description');\r\n        let thumbnail = extractTag(itemContent, 'media:content', 'url') || extractTag(itemContent, 'media:thumbnail', 'url');\r\n\r\n        // Verify image url or try to extract from description if CDATA contains img\r\n        if (!thumbnail && description) {\r\n            const imgMatch = /src=\"([^\"]+)\"/.exec(description);\r\n            if (imgMatch) thumbnail = imgMatch[1];\r\n        }\r\n\r\n        if (title && link) {\r\n            // Clean CData\r\n            items.push({\r\n                title: cleanText(title),\r\n                link: cleanText(link),\r\n                pubDate: cleanText(pubDate),\r\n                description: cleanText(description).replace(/<[^>]+>/g, '').substring(0, 100) + '...',\r\n                source: sourceName,\r\n                thumbnail\r\n            });\r\n        }\r\n        if (items.length >= 8) break; // Limit to 8 items\r\n    }\r\n    return items;\r\n}\r\n\r\nfunction extractTag(content: string, tagName: string, attr?: string): string | undefined {\r\n    if (attr) {\r\n        // Match <tagName ... attr=\"VALUE\" ... >\r\n        const regex = new RegExp(`<${tagName}[^>]*${attr}=[\"']([^\"']+)[\"']`, 'i');\r\n        const match = regex.exec(content);\r\n        return match ? match[1] : undefined;\r\n    } else {\r\n        // Match <tagName>VALUE</tagName>\r\n        const regex = new RegExp(`<${tagName}[^>]*>([\\\\s\\\\S]*?)<\\\\/${tagName}>`, 'i');\r\n        const match = regex.exec(content);\r\n        return match ? match[1] : undefined;\r\n    }\r\n}\r\n\r\nfunction cleanText(text: string | undefined): string {\r\n    if (!text) return '';\r\n    // Remove CDATA\r\n    return text.replace(/<!\\[CDATA\\[(.*?)\\]\\]>/g, '$1').trim();\r\n}\r\n\r\nexport async function getNews(category: string = 'general'): Promise<NewsItem[]> {\r\n    try {\r\n        const url = FEEDS[category] || FEEDS.general;\r\n        const xml = await fetchFromUrl(url);\r\n        const items = parseRSS(xml, FEED_NAMES[category] || 'News');\r\n\r\n        // Add AI summaries to first 3 items (to manage API costs)\r\n        const itemsWithAI = await Promise.all(\r\n            items.map(async (item, index) => {\r\n                if (index < 3) {\r\n                    // Only generate AI for top 3 stories\r\n                    const aiEnhancements = await generateNewsSummary(item);\r\n                    return { ...item, ...aiEnhancements };\r\n                }\r\n                return item;\r\n            })\r\n        );\r\n\r\n        return itemsWithAI;\r\n    } catch (e) {\r\n        console.error(\"News fetch error:\", e);\r\n        return [];\r\n    }\r\n}\r\n\r\n// AI Summary Generation\r\nasync function generateNewsSummary(item: NewsItem): Promise<Partial<NewsItem>> {\r\n    try {\r\n        const apiKey = process.env.OPENAI_API_KEY;\r\n        if (!apiKey) {\r\n            return {}; // Skip AI if no key\r\n        }\r\n\r\n        const { default: OpenAI } = await import('openai');\r\n        const openai = new OpenAI({ apiKey });\r\n\r\n        const prompt = `Analyze this news article and provide:\r\n1. A concise 3-bullet summary (each bullet max 15 words)\r\n2. Overall sentiment (positive, neutral, or negative)\r\n3. A one-sentence \"Why It Matters\" explanation\r\n\r\nArticle Title: ${item.title}\r\nDescription: ${item.description}\r\n\r\nRespond in JSON format:\r\n{\r\n  \"summary\": [\"bullet 1\", \"bullet 2\", \"bullet 3\"],\r\n  \"sentiment\": \"neutral\",\r\n  \"whyItMatters\": \"one sentence explanation\"\r\n}`;\r\n\r\n        const response = await openai.chat.completions.create({\r\n            model: \"gpt-4o-mini\", // Cost-effective model\r\n            messages: [\r\n                { role: \"system\", content: \"You are a neutral news analyst. Provide factual, unbiased summaries.\" },\r\n                { role: \"user\", content: prompt }\r\n            ],\r\n            temperature: 0.3,\r\n            response_format: { type: \"json_object\" }\r\n        });\r\n\r\n        const content = response.choices[0].message.content;\r\n        if (!content) return {};\r\n\r\n        const parsed = JSON.parse(content);\r\n\r\n        return {\r\n            aiSummary: parsed.summary || [],\r\n            sentiment: parsed.sentiment || 'neutral',\r\n            whyItMatters: parsed.whyItMatters || ''\r\n        };\r\n    } catch (error) {\r\n        console.error(\"AI Summary Error:\", error);\r\n        return {}; // Fail gracefully\r\n    }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\notifications.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[820,823],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[820,823],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1015,1018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1015,1018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":69,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":69,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2506,2509],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2506,2509],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3242,3245],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3242,3245],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3250,3253],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3250,3253],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4090,4093],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4090,4093],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { resolveDisplayName } from \"@/lib/user-utils\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\n\r\n\r\nexport type NotificationType = 'like' | 'comment' | 'group_invite' | 'follow' | 'mention' | 'admin_action' | 'family_request' | 'message';\r\n\r\n\r\nexport type Notification = {\r\n    id: string;\r\n    recipientId: string;\r\n    senderId: string;\r\n    type: NotificationType;\r\n    referenceId: string; // The ID of the post, group, or branding\r\n    read: boolean;\r\n    createdAt: Date;\r\n    sender?: {\r\n        id?: string;\r\n        displayName: string;\r\n        imageUrl?: string;\r\n    };\r\n    meta?: any; // Extra data like \"GroupName\" or \"PostPreview\"\r\n};\r\n\r\nexport async function createNotification(\r\n    recipientId: string,\r\n    type: NotificationType,\r\n    referenceId: string,\r\n    meta?: any\r\n) {\r\n    const sender = await getUserProfile();\r\n    if (!sender) return; // Should likely be logged in to trigger notifs\r\n    if (sender.id === recipientId) return; // Don't notify self\r\n\r\n    // Check for existing similar notification to avoid spam? \r\n    // E.g. multiple likes on same post? \r\n    // For now simple add.\r\n\r\n    await adminDb.collection(\"notifications\").add({\r\n        recipientId,\r\n        senderId: sender.id,\r\n        type,\r\n        referenceId,\r\n        read: false,\r\n        createdAt: FieldValue.serverTimestamp(),\r\n        meta: meta || {}\r\n    });\r\n\r\n    // We don't revalidate immediately usually for notifications as they are polled or fetched on page load.\r\n    // But specific paths might care.\r\n}\r\n\r\nexport async function getNotifications() {\r\n    const user = await getUserProfile();\r\n    if (!user) return [];\r\n\r\n    let snapshot;\r\n    try {\r\n        snapshot = await adminDb.collection(\"notifications\")\r\n            .where(\"recipientId\", \"==\", user.id)\r\n            .orderBy(\"createdAt\", \"desc\")\r\n            .limit(20)\r\n            .get();\r\n    } catch (err) {\r\n        console.log(\"Index missing for getNotifications, falling back to unordered query\");\r\n        snapshot = await adminDb.collection(\"notifications\")\r\n            .where(\"recipientId\", \"==\", user.id)\r\n            .limit(50) // Fetch a bit more to ensure recent ones are included\r\n            .get();\r\n    }\r\n\r\n    const notifications = await Promise.all(snapshot.docs.map(async (doc: any) => {\r\n        const data = doc.data();\r\n\r\n        // Hydrate sender info\r\n        const senderDoc = await adminDb.collection('users').doc(data.senderId).get();\r\n\r\n        const sender = senderDoc.exists ? {\r\n            id: senderDoc.id,\r\n            displayName: resolveDisplayName(senderDoc.data()),\r\n            imageUrl: senderDoc.data()?.imageUrl\r\n        } : { displayName: \"Unknown\" };\r\n\r\n        return sanitizeData({\r\n            id: doc.id,\r\n            ...data,\r\n            sender,\r\n            createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())\r\n        });\r\n    }));\r\n\r\n    // Ensure sorting in case we fell back to unordered query\r\n    return notifications.sort((a: any, b: any) => {\r\n        const dateA = new Date(a.createdAt);\r\n        const dateB = new Date(b.createdAt);\r\n        return dateB.getTime() - dateA.getTime();\r\n    });\r\n}\r\n\r\nexport async function markAsRead(notificationId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"notifications\").doc(notificationId).update({\r\n        read: true\r\n    });\r\n\r\n    revalidatePath('/notifications');\r\n}\r\n\r\nexport async function markAllAsRead() {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const snapshot = await adminDb.collection(\"notifications\")\r\n        .where(\"recipientId\", \"==\", user.id)\r\n        .where(\"read\", \"==\", false)\r\n        .get();\r\n\r\n    const batch = adminDb.batch();\r\n    snapshot.docs.forEach((doc: any) => {\r\n        batch.update(doc.ref, { read: true });\r\n    });\r\n\r\n    await batch.commit();\r\n    revalidatePath('/notifications');\r\n}\r\n\r\nexport async function getUnreadCount() {\r\n    const user = await getUserProfile();\r\n    if (!user) return 0;\r\n\r\n    const snapshot = await adminDb.collection(\"notifications\")\r\n        .where(\"recipientId\", \"==\", user.id)\r\n        .where(\"read\", \"==\", false)\r\n        .count()\r\n        .get();\r\n\r\n    return snapshot.data().count;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\posts.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NotificationType' is defined but never used.","line":9,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"NotificationType"},"fix":{"range":[370,388],"text":""},"desc":"Remove unused variable \"NotificationType\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3297,3300],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3297,3300],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4032,4035],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4032,4035],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4066,4069],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4066,4069],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userFamilyIds' is assigned a value but never used.","line":119,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":119,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAuthor' is assigned a value but never used.","line":164,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":164,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'privacy' is assigned a value but never used.","line":165,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":165,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'postId' is defined but never used.","line":425,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":425,"endColumn":40},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":736,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":736,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29013,29016],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29013,29016],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'author' is assigned a value but never used.","line":932,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":932,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n// critical-build-trigger: force redeploy of fixed syntax\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { getUserProfile, requireVerifiedAction } from \"@/lib/auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\nimport { ReactionType, NotificationType } from \"@/types/posts\";\r\n\r\nimport { resolveDisplayName } from \"@/lib/user-utils\";\r\n\r\n// Removed local resolveDisplayName helper in favor of shared utility\r\n\r\n// Helper to unfurl Pinterest links\r\nasync function fetchLinkPreview(url: string) {\r\n    try {\r\n        const response = await fetch(url, {\r\n            headers: {\r\n                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',\r\n                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'\r\n            }\r\n        });\r\n        const html = await response.text();\r\n\r\n        const imageMatch = html.match(/<meta property=\"?og:image\"? content=\"([^\"]+)\"/i) || html.match(/<meta name=\"?twitter:image\"? content=\"([^\"]+)\"/i);\r\n        const titleMatch = html.match(/<meta property=\"?og:title\"? content=\"([^\"]+)\"/i) || html.match(/<title>([^<]+)<\\/title>/i);\r\n\r\n        if (imageMatch && imageMatch[1]) {\r\n            return {\r\n                url,\r\n                image: imageMatch[1],\r\n                title: titleMatch ? titleMatch[1] : '',\r\n                source: url.includes('pinterest') || url.includes('pin.it') ? 'pinterest' : 'link'\r\n            };\r\n        }\r\n        return null;\r\n    } catch (e) {\r\n        console.error(\"Link unfurl failed:\", e);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function createPost(\r\n    content: string,\r\n    mediaUrls: string[] = [],\r\n    engagementSettings?: { allowLikes?: boolean; allowComments?: boolean; privacy?: 'public' | 'friends' | 'private' | 'companions' | 'specific' },\r\n    thumbnailUrl?: string | null,\r\n    allowedViewerIds?: string[]\r\n) {\r\n    const user = await requireVerifiedAction();\r\n\r\n    // Safe sanitization\r\n    const safeMediaUrls = Array.isArray(mediaUrls) ? mediaUrls : [];\r\n\r\n    // Default engagement settings\r\n    const settings = {\r\n        allowLikes: engagementSettings?.allowLikes ?? true,\r\n        allowComments: engagementSettings?.allowComments ?? true,\r\n        privacy: engagementSettings?.privacy ?? 'public' // Changed default to public\r\n    };\r\n\r\n    // Detect and unfurl Pinterest links\r\n    let linkPreview = null;\r\n    const pinterestMatch = content.match(/(https?:\\/\\/(?:www\\.)?(?:pinterest\\.com\\/pin\\/|pin\\.it\\/)[^\\s]+)/);\r\n    if (pinterestMatch) {\r\n        linkPreview = await fetchLinkPreview(pinterestMatch[0]);\r\n    }\r\n\r\n    try {\r\n        await adminDb.collection(\"posts\").add({\r\n            authorId: user.id,\r\n            content,\r\n            mediaUrls: safeMediaUrls,\r\n            thumbnailUrl: thumbnailUrl || null,\r\n            linkPreview,\r\n            reactions: {}, // Map of userId -> reactionType\r\n            engagementSettings: settings,\r\n            allowedViewerIds: allowedViewerIds || [], // Store specific viewers if any\r\n            createdAt: FieldValue.serverTimestamp(),\r\n        });\r\n    } catch (e: any) {\r\n        console.error(\"Create Post Failed:\", e);\r\n        throw new Error(e.message || \"Database write failed\");\r\n    }\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"post.create\", {\r\n        targetType: \"post\",\r\n        details: { content: content.substring(0, 20) }\r\n    });\r\n\r\n    revalidatePath('/');\r\n    revalidatePath('/profile');\r\n}\r\n\r\nexport type PostFilters = {\r\n    timeRange: 'day' | 'week' | 'month' | 'year' | 'all';\r\n    contentType: 'text' | 'photo' | 'video' | 'all';\r\n};\r\n\r\n\r\n\r\n\r\n\r\nexport async function getPosts(limit = 50, filters: PostFilters = { timeRange: 'all', contentType: 'all' }) {\r\n    const user = await getUserProfile();\r\n\r\n    try {\r\n        let validPosts: any[] = [];\r\n        let lastDoc: any = null;\r\n        let safetyCounter = 0;\r\n        const MAX_LOOPS = 10; // Allow enough text-to-public filtering\r\n\r\n        // Fetch family IDs once\r\n        let userFamilyIds: string[] = [];\r\n        if (user) {\r\n            const { getFamilyMemberIds } = await import(\"./family\");\r\n            userFamilyIds = await getFamilyMemberIds(user.id);\r\n        }\r\n\r\n        while (validPosts.length < limit && safetyCounter < MAX_LOOPS) {\r\n            let query = adminDb.collection(\"posts\").orderBy(\"createdAt\", \"desc\");\r\n\r\n            if (lastDoc) {\r\n                query = query.startAfter(lastDoc);\r\n            }\r\n\r\n            const fetchSize = Math.max((limit - validPosts.length) * 2, 20);\r\n            query = query.limit(fetchSize);\r\n\r\n            const snapshot = await query.get();\r\n            if (snapshot.empty) break;\r\n\r\n            lastDoc = snapshot.docs[snapshot.docs.length - 1];\r\n            let rawDocs = snapshot.docs;\r\n\r\n            // ALWAYS Filter Soft Deleted\r\n            rawDocs = rawDocs.filter(doc => !doc.data().isDeleted);\r\n\r\n            // Content Type Filter\r\n            if (filters.contentType !== 'all') {\r\n                rawDocs = rawDocs.filter(doc => {\r\n                    const data = doc.data();\r\n                    // if (data.isDeleted) return false; // Already filtered above\r\n\r\n                    const hasMedia = data.mediaUrls && data.mediaUrls.length > 0;\r\n                    const videoUrlRegex = /https?:\\/\\/(www\\.)?(youtube\\.com|youtu\\.be|facebook\\.com|linkedin\\.com|vimeo\\.com|ds1\\.chancetek.com)\\/\\S+/i;\r\n                    const hasVideoLink = videoUrlRegex.test(data.content || \"\");\r\n                    const isVideo = (hasMedia && data.mediaUrls.some((u: string) => u.match(/\\.(mp4|mov|webm)$/i))) || hasVideoLink;\r\n                    const isPhoto = hasMedia && !isVideo;\r\n                    const isText = !hasMedia && !hasVideoLink;\r\n                    if (filters.contentType === 'video') return isVideo;\r\n                    if (filters.contentType === 'photo') return isPhoto;\r\n                    if (filters.contentType === 'text') return isText;\r\n                    return true;\r\n                });\r\n            }\r\n\r\n            const batchPosts = await Promise.all(rawDocs.map(async (doc) => {\r\n                const data = doc.data();\r\n\r\n                // VISIBILITY CHECK\r\n                const isAuthor = user?.id === data.authorId;\r\n                const privacy = data.engagementSettings?.privacy || 'public';\r\n\r\n                // BYPASS VISIBILITY CHECK PER USER REQUEST: Show all posts regardless of privacy\r\n                /*\r\n                if (!isAuthor && privacy !== 'public') {\r\n                    if (!user) return null;\r\n                    if (privacy === 'private') return null;\r\n                    if ((privacy === 'friends' || privacy === 'companions') && !userFamilyIds.includes(data.authorId)) return null;\r\n                    if (privacy === 'specific') {\r\n                        const allowed = data.allowedViewerIds || [];\r\n                        if (!allowed.includes(user.id)) return null;\r\n                    }\r\n                }\r\n                */\r\n\r\n                // Hydrate Author\r\n                let author = null;\r\n                if (data.authorId) {\r\n                    const docSpan = await adminDb.collection(\"users\").doc(data.authorId).get();\r\n                    if (docSpan.exists) {\r\n                        const d = docSpan.data();\r\n                        author = { id: docSpan.id, displayName: resolveDisplayName(d), imageUrl: d?.imageUrl, email: d?.email };\r\n                    }\r\n                }\r\n\r\n                // Hydrate Comments & Replies\r\n                const commentsRef = doc.ref.collection(\"comments\").orderBy(\"createdAt\", \"asc\");\r\n                const commentsSnap = await commentsRef.get();\r\n                const comments = await Promise.all(commentsSnap.docs.map(async (cDoc) => {\r\n                    const cData = cDoc.data();\r\n                    let cAuthor = null;\r\n                    if (cData.authorId) {\r\n                        const u = await adminDb.collection(\"users\").doc(cData.authorId).get();\r\n                        if (u.exists) {\r\n                            const uD = u.data();\r\n                            cAuthor = { id: u.id, displayName: resolveDisplayName(uD), imageUrl: uD?.imageUrl };\r\n                        }\r\n                    }\r\n                    const repliesSnap = await cDoc.ref.collection(\"replies\").orderBy(\"createdAt\", \"asc\").get();\r\n                    const replies = await Promise.all(repliesSnap.docs.map(async (r) => {\r\n                        const rData = r.data();\r\n                        let rAuthor = null;\r\n                        if (rData.authorId) {\r\n                            const u = await adminDb.collection(\"users\").doc(rData.authorId).get();\r\n                            if (u.exists) { const uD = u.data(); rAuthor = { id: u.id, displayName: resolveDisplayName(uD), imageUrl: uD?.imageUrl }; }\r\n                        }\r\n                        return sanitizeData({ id: r.id, ...rData, author: rAuthor, createdAt: rData.createdAt?.toDate ? rData.createdAt.toDate() : new Date() });\r\n                    }));\r\n                    return sanitizeData({ id: cDoc.id, ...cData, author: cAuthor, replies, createdAt: cData.createdAt?.toDate ? cData.createdAt.toDate() : new Date() });\r\n                }));\r\n\r\n                return sanitizeData({\r\n                    id: doc.id,\r\n                    ...data,\r\n                    author,\r\n                    comments: comments || [],\r\n                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date()\r\n                });\r\n            }));\r\n\r\n            const visible = batchPosts.filter(p => p !== null);\r\n            validPosts = [...validPosts, ...visible];\r\n            safetyCounter++;\r\n        }\r\n\r\n        return validPosts.slice(0, limit);\r\n\r\n    } catch (error) {\r\n        console.error(\"Error fetching posts:\", error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// Helper to get correct collection based on context\r\nfunction getPostRef(postId: string, contextType?: string, contextId?: string) {\r\n    if (contextType === 'group' && contextId) {\r\n        return adminDb.collection(\"groups\").doc(contextId).collection(\"posts\").doc(postId);\r\n    }\r\n    if (contextType === 'branding' && contextId) {\r\n        return adminDb.collection(\"pages\").doc(contextId).collection(\"posts\").doc(postId);\r\n    }\r\n    return adminDb.collection(\"posts\").doc(postId);\r\n}\r\n\r\nexport async function toggleReaction(postId: string, reactionType: ReactionType, contextType?: string, contextId?: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const postDoc = await postRef.get();\r\n\r\n    if (!postDoc.exists) throw new Error(\"Post not found\");\r\n\r\n    const currentReactions = postDoc.data()?.reactions || {};\r\n    const hasReaction = currentReactions[user.id] === reactionType;\r\n\r\n    if (hasReaction) {\r\n        delete currentReactions[user.id];\r\n    } else {\r\n        currentReactions[user.id] = reactionType;\r\n    }\r\n\r\n    await postRef.update({ reactions: currentReactions });\r\n\r\n    // Notification Logic\r\n    if (!hasReaction && postDoc.data()?.authorId !== user.id) {\r\n        const { createNotification } = await import(\"./notifications\");\r\n        await createNotification(\r\n            postDoc.data()?.authorId,\r\n            \"like\",\r\n            postId,\r\n            { type: reactionType, message: `${user.displayName || user.email || 'Someone'} reacted to your post` }\r\n        );\r\n    }\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function editPost(postId: string, content: string, contextType?: string, contextId?: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const postDoc = await postRef.get();\r\n\r\n    if (!postDoc.exists) throw new Error(\"Post not found\");\r\n    const postData = postDoc.data();\r\n\r\n    // Permission Check\r\n    if (contextType === 'branding' && postData?.postedAsBranding) {\r\n        // Branding Logic\r\n        const { getBrandingFollowStatus } = await import(\"./branding\");\r\n        const status = await getBrandingFollowStatus(contextId!);\r\n        if (status?.role !== 'admin') throw new Error(\"Unauthorized\");\r\n    } else {\r\n        // Standard User Check\r\n        if (postData?.authorId !== user.id) throw new Error(\"Unauthorized\");\r\n    }\r\n\r\n    await postRef.update({\r\n        content,\r\n        isEdited: true,\r\n        updatedAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function addComment(postId: string, content: string, contextType?: string, contextId?: string, mediaUrl?: string, youtubeUrl?: string) {\r\n    const user = await requireVerifiedAction();\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const postDoc = await postRef.get();\r\n    if (!postDoc.exists) throw new Error(\"Post not found\");\r\n\r\n    const docRef = await postRef.collection(\"comments\").add({\r\n        authorId: user.id,\r\n        content,\r\n        mediaUrl: mediaUrl || null,\r\n        youtubeUrl: youtubeUrl || null,\r\n        likes: [],\r\n        createdAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    const commentData = {\r\n        id: docRef.id,\r\n        authorId: user.id,\r\n        content,\r\n        mediaUrl: mediaUrl || null,\r\n        youtubeUrl: youtubeUrl || null,\r\n        likes: [],\r\n        createdAt: new Date().toISOString()\r\n    };\r\n\r\n    // Notify post author\r\n    if (postDoc.data()?.authorId !== user.id) {\r\n        const { createNotification } = await import(\"./notifications\");\r\n        await createNotification(\r\n            postDoc.data()?.authorId,\r\n            \"comment\",\r\n            postId,\r\n            { commentSnippet: content.substring(0, 50), message: `${user.displayName || user.email || 'Someone'} commented on your post` }\r\n        );\r\n    }\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n\r\n    return {\r\n        ...commentData,\r\n        author: {\r\n            id: user.id,\r\n            displayName: user.displayName,\r\n            email: user.email,\r\n            imageUrl: user.photoURL\r\n        }\r\n    };\r\n}\r\n\r\nexport async function deleteComment(postId: string, commentId: string, contextType?: string, contextId?: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const commentRef = postRef.collection(\"comments\").doc(commentId);\r\n\r\n    // Fetch both comment and post to check permissions\r\n    const [commentDoc, postDoc] = await Promise.all([\r\n        commentRef.get(),\r\n        postRef.get()\r\n    ]);\r\n\r\n    if (!commentDoc.exists) throw new Error(\"Comment not found\");\r\n    if (!postDoc.exists) throw new Error(\"Post not found\");\r\n\r\n    const isCommentAuthor = commentDoc.data()?.authorId === user.id;\r\n    const isPostAuthor = postDoc.data()?.authorId === user.id;\r\n\r\n    // Allow deletion if user is Comment Author OR Post Author\r\n    if (!isCommentAuthor && !isPostAuthor) throw new Error(\"Unauthorized\");\r\n\r\n    await commentRef.delete();\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function editComment(postId: string, commentId: string, content: string, contextType?: string, contextId?: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const commentRef = postRef.collection(\"comments\").doc(commentId);\r\n    const commentDoc = await commentRef.get();\r\n\r\n    if (!commentDoc.exists || commentDoc.data()?.authorId !== user.id) throw new Error(\"Unauthorized\");\r\n\r\n    await commentRef.update({ content });\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function archiveComment(postId: string, commentId: string, contextType?: string, contextId?: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const commentRef = postRef.collection(\"comments\").doc(commentId);\r\n    await commentRef.update({ isArchived: true });\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function deletePost(postId: string) {\r\n    // Note: deletePost might need context to find the post to soft delete\r\n    // Defaulting to \"posts\" collection for now implies we can't delete group posts yet via this action\r\n    // unless we update it. But usually delete takes context or we search.\r\n    // For now, let's keep it legacy for main feed but warn.\r\n    // A better way is to pass context.\r\n    // However, the function signature is deletePost(postId).\r\n    // I can't easily change signature without breaking clients unless I make params optional.\r\n    // But clients (PostCard) WILL pass context if I update it.\r\n    console.error(\"deletePost called without context - likely legacy\");\r\n    // ... Legacy implementation ...\r\n    // To support context, we need to robustly update signature or make a new one.\r\n    // Given the prompt \"Add options to edit posts\", I'll focus on that, but fixing delete is good.\r\n    // See `deletePostWithContext` below or just overload.\r\n}\r\n\r\n// Overloaded / Context-aware delete\r\nexport async function deletePostWithContext(postId: string, contextType?: string, contextId?: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const postDoc = await postRef.get();\r\n    if (!postDoc.exists) throw new Error(\"Post not found\");\r\n\r\n    // Check Auth (Author or Admin)\r\n    const isAuthor = postDoc.data()?.authorId === user.id;\r\n    // TODO: Add refined admin check for groups/branding if needed\r\n    if (!isAuthor) throw new Error(\"Unauthorized\");\r\n\r\n    // Soft Delete\r\n    // Soft Delete with 10-day recovery\r\n    const now = new Date();\r\n    const tenDaysLater = new Date(now.getTime() + 10 * 24 * 60 * 60 * 1000);\r\n\r\n    await postRef.update({\r\n        isDeleted: true,\r\n        deletedAt: FieldValue.serverTimestamp(),\r\n        permanentDeleteAt: tenDaysLater\r\n    });\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function restorePost(postId: string, contextType?: string, contextId?: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const doc = await postRef.get();\r\n\r\n    if (!doc.exists) throw new Error(\"Post not found\");\r\n    // Only author can restore for now\r\n    if (doc.data()?.authorId !== user.id) throw new Error(\"Unauthorized\");\r\n\r\n    await postRef.update({\r\n        isDeleted: false,\r\n        deletedAt: FieldValue.delete(),\r\n        permanentDeleteAt: FieldValue.delete()\r\n    });\r\n\r\n    revalidatePath('/');\r\n    revalidatePath('/profile');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function toggleCommentLike(postId: string, commentId: string, reactionType: ReactionType = 'like', contextType?: string, contextId?: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const commentRef = postRef.collection(\"comments\").doc(commentId);\r\n\r\n    const commentDoc = await commentRef.get();\r\n    if (!commentDoc.exists) throw new Error(\"Comment not found\");\r\n\r\n    // Use reactions map like posts instead of likes array\r\n    const currentReactions = commentDoc.data()?.reactions || {};\r\n    const hasReaction = currentReactions[user.id] === reactionType;\r\n\r\n    let newReactions = { ...currentReactions };\r\n    if (hasReaction) {\r\n        delete newReactions[user.id];\r\n    } else {\r\n        newReactions[user.id] = reactionType;\r\n    }\r\n\r\n    await commentRef.update({ reactions: newReactions });\r\n\r\n    if (!hasReaction && commentDoc.data()?.authorId !== user.id) {\r\n        const { createNotification } = await import(\"./notifications\");\r\n        await createNotification(\r\n            commentDoc.data()?.authorId,\r\n            \"like\",\r\n            postId,\r\n            { commentId, message: `${user.displayName || user.email || 'Someone'} reacted to your comment` }\r\n        );\r\n    }\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\n// ============================================================================\r\n// THREADED REPLIES SYSTEM\r\n// ============================================================================\r\n\r\n/**\r\n * Add a reply to a comment (threaded conversation)\r\n */\r\nexport async function addReply(\r\n    postId: string,\r\n    commentId: string,\r\n    content: string,\r\n    contextType?: string,\r\n    contextId?: string\r\n) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const commentRef = postRef.collection(\"comments\").doc(commentId);\r\n\r\n    const commentDoc = await commentRef.get();\r\n    if (!commentDoc.exists) throw new Error(\"Comment not found\");\r\n\r\n    // Create reply in subcollection\r\n    const replyRef = await commentRef.collection(\"replies\").add({\r\n        authorId: user.id,\r\n        content,\r\n        reactions: {}, // Use reactions map instead of likes array\r\n        createdAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    const replyData = {\r\n        id: replyRef.id,\r\n        authorId: user.id,\r\n        content,\r\n        reactions: {}, // Use reactions map\r\n        createdAt: new Date().toISOString()\r\n    };\r\n\r\n    // Notify comment author\r\n    if (commentDoc.data()?.authorId !== user.id) {\r\n        const { createNotification } = await import(\"./notifications\");\r\n        await createNotification(\r\n            commentDoc.data()?.authorId,\r\n            \"comment\", // We can add 'reply' type if needed\r\n            postId,\r\n            {\r\n                commentId,\r\n                replyId: replyRef.id,\r\n                message: `${user.displayName || user.email || 'Someone'} replied to your comment`\r\n            }\r\n        );\r\n    }\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n\r\n    return {\r\n        ...replyData,\r\n        author: {\r\n            id: user.id,\r\n            displayName: user.displayName,\r\n            email: user.email,\r\n            imageUrl: user.photoURL\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * Delete a reply\r\n */\r\nexport async function deleteReply(\r\n    postId: string,\r\n    commentId: string,\r\n    replyId: string,\r\n    contextType?: string,\r\n    contextId?: string\r\n) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const commentRef = postRef.collection(\"comments\").doc(commentId);\r\n    const replyRef = commentRef.collection(\"replies\").doc(replyId);\r\n\r\n    // Need to check 3 levels of ownership: Reply Author, Comment Author, Post Author\r\n    const [replyDoc, commentDoc, postDoc] = await Promise.all([\r\n        replyRef.get(),\r\n        commentRef.get(),\r\n        postRef.get()\r\n    ]);\r\n\r\n    if (!replyDoc.exists) throw new Error(\"Reply not found\");\r\n\r\n    const isReplyAuthor = replyDoc.data()?.authorId === user.id;\r\n    const isCommentAuthor = commentDoc.exists && commentDoc.data()?.authorId === user.id;\r\n    const isPostAuthor = postDoc.exists && postDoc.data()?.authorId === user.id;\r\n\r\n    // Allow if: Reply Author OR Comment Author OR Post Author\r\n    if (!isReplyAuthor && !isCommentAuthor && !isPostAuthor) {\r\n        throw new Error(\"Unauthorized\");\r\n    }\r\n\r\n    await replyRef.delete();\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\n/**\r\n * Edit a reply\r\n */\r\nexport async function editReply(\r\n    postId: string,\r\n    commentId: string,\r\n    replyId: string,\r\n    content: string,\r\n    contextType?: string,\r\n    contextId?: string\r\n) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const replyRef = postRef.collection(\"comments\").doc(commentId).collection(\"replies\").doc(replyId);\r\n\r\n    const replyDoc = await replyRef.get();\r\n    if (!replyDoc.exists) throw new Error(\"Reply not found\");\r\n    if (replyDoc.data()?.authorId !== user.id) throw new Error(\"Unauthorized\");\r\n\r\n    await replyRef.update({\r\n        content,\r\n        isEdited: true,\r\n        updatedAt: FieldValue.serverTimestamp()\r\n    });\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\n/**\r\n * Toggle like on a reply\r\n */\r\nexport async function toggleReplyLike(\r\n    postId: string,\r\n    commentId: string,\r\n    replyId: string,\r\n    reactionType: ReactionType = 'like',\r\n    contextType?: string,\r\n    contextId?: string\r\n) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const replyRef = postRef.collection(\"comments\").doc(commentId).collection(\"replies\").doc(replyId);\r\n\r\n    const replyDoc = await replyRef.get();\r\n    if (!replyDoc.exists) throw new Error(\"Reply not found\");\r\n\r\n    // Use reactions map like posts instead of likes array\r\n    const currentReactions = replyDoc.data()?.reactions || {};\r\n    const hasReaction = currentReactions[user.id] === reactionType;\r\n\r\n    let newReactions = { ...currentReactions };\r\n    if (hasReaction) {\r\n        delete newReactions[user.id];\r\n    } else {\r\n        newReactions[user.id] = reactionType;\r\n    }\r\n\r\n    await replyRef.update({ reactions: newReactions });\r\n\r\n    // Notify reply author\r\n    if (!hasReaction && replyDoc.data()?.authorId !== user.id) {\r\n        const { createNotification } = await import(\"./notifications\");\r\n        await createNotification(\r\n            replyDoc.data()?.authorId,\r\n            \"like\",\r\n            postId,\r\n            {\r\n                commentId,\r\n                replyId,\r\n                message: `${user.displayName || user.email || 'Someone'} reacted to your reply`\r\n            }\r\n        );\r\n    }\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function getUserPosts(userId: string, limit = 50, filters: PostFilters = { timeRange: 'all', contentType: 'all' }) {\r\n    // If we're filtering, we might need to fetch more and filter in memory\r\n    // Since this is a profile feed, we can't rely on 'adminDb' sorting if we filter by content type in memory\r\n    // But usually profile feeds are small enough.\r\n    // However, to be robust, let's fetch all (or a large batch) and filter.\r\n    // Ideally we'd use complex queries, but Firestore has limits.\r\n\r\n    try {\r\n        let allDocs: any[] = [];\r\n\r\n        // 1. Fetch by authorId (Standard)\r\n        // NOTE: We do not use orderBy(\"createdAt\", \"desc\") here to avoid needing a Composite Index.\r\n        // We fetch all posts (which is what it was doing anyway) and sort in memory.\r\n        const postsRef = adminDb.collection(\"posts\")\r\n            .where(\"authorId\", \"==\", userId);\r\n\r\n        const snapshot = await postsRef.get();\r\n        allDocs = snapshot.docs\r\n            .filter(d => !d.data().isDeleted)\r\n            .sort((a, b) => {\r\n                const timeA = a.data().createdAt?.toMillis() || 0;\r\n                const timeB = b.data().createdAt?.toMillis() || 0;\r\n                return timeB - timeA; // Descending\r\n            });\r\n\r\n        // 2. Fallback: If no posts found, try legacy email match (slow path)\r\n        if (snapshot.empty) {\r\n            const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n            const userEmail = userDoc.data()?.email;\r\n\r\n            if (userEmail) {\r\n                const globalSnap = await adminDb.collection(\"posts\").orderBy(\"createdAt\", \"desc\").get();\r\n                // This is very expensive for a fallback, but maintaining current logic\r\n                for (const doc of globalSnap.docs) {\r\n                    const data = doc.data();\r\n                    if (data.authorId) {\r\n                        // We'd need to cache authors to make this performant, \r\n                        // but assuming this is a rare edge case for old data.\r\n                        // For now, let's skip the deep check to avoid N+1 queries in this loop \r\n                        // unless absolutely necessary.\r\n                        // Or just rely on ID match. \r\n                    }\r\n                }\r\n                // ... (Legacy logic omitted for performance safety in this upgrade, assuming IDs match now)\r\n            }\r\n        }\r\n\r\n        // 3. Apply Filters in Memory\r\n        let filteredDocs = allDocs;\r\n\r\n        // Content Type Filter\r\n        if (filters.contentType !== 'all') {\r\n            filteredDocs = filteredDocs.filter(doc => {\r\n                const data = doc.data();\r\n                const hasMedia = data.mediaUrls && data.mediaUrls.length > 0;\r\n                const videoUrlRegex = /https?:\\/\\/(www\\.)?(youtube\\.com|youtu\\.be|facebook\\.com|linkedin\\.com|vimeo\\.com|ds1\\.chancetek.com)\\/\\S+/i;\r\n                const hasVideoLink = videoUrlRegex.test(data.content || \"\");\r\n                const isVideo = (hasMedia && data.mediaUrls.some((u: string) => u.match(/\\.(mp4|mov|webm)$/i))) || hasVideoLink;\r\n                const isPhoto = hasMedia && !isVideo;\r\n                const isText = !hasMedia && !hasVideoLink;\r\n\r\n                if (filters.contentType === 'video') return isVideo;\r\n                if (filters.contentType === 'photo') return isPhoto;\r\n                if (filters.contentType === 'text') return isText;\r\n                return true;\r\n            });\r\n        }\r\n\r\n        // Time Range Filter \r\n        if (filters.timeRange !== 'all') {\r\n            const now = new Date();\r\n            const msPerDay = 24 * 60 * 60 * 1000;\r\n            filteredDocs = filteredDocs.filter(doc => {\r\n                const data = doc.data();\r\n                const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();\r\n                const diff = now.getTime() - createdAt.getTime();\r\n\r\n                if (filters.timeRange === 'day') return diff < msPerDay;\r\n                if (filters.timeRange === 'week') return diff < msPerDay * 7;\r\n                if (filters.timeRange === 'month') return diff < msPerDay * 30;\r\n                if (filters.timeRange === 'year') return diff < msPerDay * 365;\r\n                return true;\r\n            });\r\n        }\r\n\r\n        // 4. Apply Limit\r\n        const slicedDocs = filteredDocs.slice(0, limit);\r\n\r\n        // 5. Hydrate & Sanitize\r\n        const finalPosts = await Promise.all(slicedDocs.map(async (doc) => {\r\n            const post = doc.data();\r\n            const currentUser = await getUserProfile();\r\n\r\n            // VISIBILITY CHECK\r\n            const isAuthor = currentUser?.id === post.authorId;\r\n            const privacy = post.engagementSettings?.privacy || 'public';\r\n\r\n            if (!isAuthor && privacy !== 'public') {\r\n                if (!currentUser) return null;\r\n                if (privacy === 'private') return null;\r\n\r\n                // Family check\r\n                const { getFamilyStatus } = await import(\"./family\");\r\n                const status = await getFamilyStatus(userId);\r\n                const isFamily = status.status === 'accepted';\r\n\r\n                if ((privacy === 'friends' || privacy === 'companions') && !isFamily) return null;\r\n\r\n                if (privacy === 'specific') {\r\n                    const allowed = post.allowedViewerIds || [];\r\n                    if (!allowed.includes(currentUser.id)) return null;\r\n                }\r\n            }\r\n\r\n            // Hydrate Author\r\n            const authorDoc = await adminDb.collection(\"users\").doc(post.authorId).get();\r\n            const author = authorDoc.exists ? {\r\n                id: authorDoc.id,\r\n                displayName: resolveDisplayName(authorDoc.data()),\r\n                imageUrl: authorDoc.data()?.imageUrl,\r\n                email: authorDoc.data()?.email,\r\n            } : null;\r\n\r\n            // Fetch comments\r\n            const commentsRef = adminDb.collection(\"posts\").doc(doc.id).collection(\"comments\");\r\n            const commentsSnap = await commentsRef.orderBy(\"createdAt\", \"asc\").get();\r\n            const comments = await Promise.all(commentsSnap.docs.map(async (c) => {\r\n                const cData = c.data();\r\n                let cAuthor = cData.author;\r\n                if (!cAuthor && cData.authorId) {\r\n                    const u = await adminDb.collection(\"users\").doc(cData.authorId).get();\r\n                    cAuthor = u.exists ? {\r\n                        id: u.id,\r\n                        displayName: resolveDisplayName(u.data()),\r\n                        imageUrl: u.data()?.imageUrl\r\n                    } : null;\r\n                }\r\n                const repliesSnap = await commentsRef.doc(c.id).collection(\"replies\").orderBy(\"createdAt\", \"asc\").get();\r\n                const replies = await Promise.all(repliesSnap.docs.map(async (r) => {\r\n                    const rData = r.data();\r\n                    let rAuthor = null;\r\n                    if (rData.authorId) {\r\n                        const u = await adminDb.collection(\"users\").doc(rData.authorId).get();\r\n                        if (u.exists) {\r\n                            const uData = u.data();\r\n                            rAuthor = { id: u.id, displayName: resolveDisplayName(uData), imageUrl: uData?.imageUrl };\r\n                        }\r\n                    }\r\n                    return sanitizeData({ id: r.id, ...rData, author: rAuthor, createdAt: rData.createdAt?.toDate ? rData.createdAt.toDate() : new Date() });\r\n                }));\r\n\r\n                return sanitizeData({ id: c.id, ...cData, author: cAuthor, replies, createdAt: cData.createdAt?.toDate ? cData.createdAt.toDate() : new Date() });\r\n            }));\r\n\r\n            return sanitizeData({\r\n                id: doc.id,\r\n                ...post,\r\n                author,\r\n                comments: comments || [],\r\n                createdAt: post.createdAt?.toDate ? post.createdAt.toDate() : new Date()\r\n            });\r\n        }));\r\n\r\n        return finalPosts.filter(p => p !== null);\r\n\r\n    } catch (error) {\r\n        console.error(\"Error fetching user posts:\", error);\r\n        return [];\r\n    }\r\n\r\n}\r\n\r\n// Global Post Lookup for /post/[id]\r\nexport async function getPostGlobal(postId: string) {\r\n    // 1. Try Main Feed\r\n    const mainRef = adminDb.collection(\"posts\").doc(postId);\r\n    const mainDoc = await mainRef.get();\r\n\r\n    if (mainDoc.exists) {\r\n        const post = mainDoc.data();\r\n        if (!post) return null;\r\n        const user = await getUserProfile();\r\n\r\n        // VISIBILITY CHECK\r\n        const isAuthor = user?.id === post.authorId;\r\n        const privacy = post.engagementSettings?.privacy || 'public';\r\n\r\n        if (!isAuthor && privacy !== 'public') {\r\n            if (!user) return null; // prompt login or 404 in UI\r\n            if (privacy === 'private') return null;\r\n\r\n            const { getFamilyStatus } = await import(\"./family\");\r\n            const status = await getFamilyStatus(post.authorId);\r\n            const isFamily = status.status === 'accepted';\r\n\r\n            if ((privacy === 'friends' || privacy === 'companions') && !isFamily) return null;\r\n\r\n            if (privacy === 'specific') {\r\n                const allowed = post.allowedViewerIds || [];\r\n                if (!allowed.includes(user.id)) return null;\r\n            }\r\n        }\r\n\r\n        // Hydrate\r\n        let author = null;\r\n        if (post.authorId) {\r\n            const data = mainDoc.data()!;\r\n\r\n            let author = null;\r\n            if (data.authorId) {\r\n                const authorDoc = await adminDb.collection(\"users\").doc(data.authorId).get();\r\n                if (authorDoc.exists) {\r\n                    const aData = authorDoc.data();\r\n                    author = {\r\n                        id: authorDoc.id,\r\n                        displayName: resolveDisplayName(aData),\r\n                        imageUrl: aData?.imageUrl,\r\n                        email: aData?.email\r\n                    };\r\n                }\r\n            }\r\n\r\n            // Fetch comments\r\n            const commentsSnap = await mainRef.collection(\"comments\").orderBy(\"createdAt\", \"asc\").get();\r\n            const comments = await Promise.all(commentsSnap.docs.map(async c => {\r\n                const cData = c.data();\r\n                let cAuthor = null;\r\n                if (cData.authorId) {\r\n                    const u = await adminDb.collection(\"users\").doc(cData.authorId).get();\r\n                    if (u.exists) {\r\n                        const uData = u.data();\r\n                        cAuthor = {\r\n                            id: u.id,\r\n                            displayName: resolveDisplayName(uData),\r\n                            imageUrl: uData?.imageUrl,\r\n                            email: uData?.email\r\n                        };\r\n                    }\r\n                }\r\n\r\n                // Fetch replies for this comment\r\n                const repliesSnap = await mainRef.collection(\"comments\").doc(c.id).collection(\"replies\").orderBy(\"createdAt\", \"asc\").get();\r\n                const replies = await Promise.all(repliesSnap.docs.map(async (r) => {\r\n                    const rData = r.data();\r\n                    let rAuthor = null;\r\n                    if (rData.authorId) {\r\n                        const u = await adminDb.collection(\"users\").doc(rData.authorId).get();\r\n                        if (u.exists) {\r\n                            const uData = u.data();\r\n                            rAuthor = {\r\n                                id: u.id,\r\n                                displayName: resolveDisplayName(uData),\r\n                                imageUrl: uData?.imageUrl,\r\n                                email: uData?.email\r\n                            };\r\n                        }\r\n                    }\r\n                    return {\r\n                        id: r.id,\r\n                        ...rData,\r\n                        author: rAuthor,\r\n                        createdAt: rData.createdAt?.toDate ? rData.createdAt.toDate() : new Date()\r\n                    };\r\n                }));\r\n\r\n                return {\r\n                    id: c.id,\r\n                    ...cData,\r\n                    createdAt: cData.createdAt?.toDate ? cData.createdAt.toDate() : new Date(),\r\n                    author: cAuthor,\r\n                    replies: replies || []\r\n                };\r\n            }));\r\n\r\n            return sanitizeData({\r\n                id: mainDoc.id,\r\n                ...data,\r\n                createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(),\r\n                authorId: data.authorId, // CRITICAL\r\n                author,\r\n                comments,\r\n                type: 'personal',\r\n                context: null\r\n            });\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n/**\r\n * Update post engagement settings (enable/disable likes, comments, change privacy)\r\n */\r\nexport async function updatePostEngagementSettings(\r\n    postId: string,\r\n    settings: { allowLikes?: boolean; allowComments?: boolean; privacy?: 'public' | 'friends' | 'private' },\r\n    contextType?: string,\r\n    contextId?: string\r\n) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = getPostRef(postId, contextType, contextId);\r\n    const postDoc = await postRef.get();\r\n\r\n    if (!postDoc.exists) throw new Error(\"Post not found\");\r\n    if (postDoc.data()?.authorId !== user.id) throw new Error(\"Unauthorized\");\r\n\r\n    // Update only provided settings\r\n    const currentSettings = postDoc.data()?.engagementSettings || {};\r\n    const newSettings = {\r\n        allowLikes: settings.allowLikes ?? currentSettings.allowLikes ?? true,\r\n        allowComments: settings.allowComments ?? currentSettings.allowComments ?? true,\r\n        privacy: settings.privacy ?? currentSettings.privacy ?? 'friends'\r\n    };\r\n\r\n    await postRef.update({ engagementSettings: newSettings });\r\n\r\n    revalidatePath('/');\r\n    if (contextType === 'group' && contextId) revalidatePath(`/groups/${contextId}`);\r\n    if (contextType === 'branding' && contextId) revalidatePath(`/branding/${contextId}`);\r\n}\r\n\r\nexport async function getDeletedPosts(userId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user || user.id !== userId) throw new Error(\"Unauthorized\");\r\n\r\n    const postsRef = adminDb.collection(\"posts\")\r\n        .where(\"authorId\", \"==\", userId)\r\n        .where(\"isDeleted\", \"==\", true)\r\n        .orderBy(\"createdAt\", \"desc\");\r\n\r\n    const snapshot = await postsRef.get();\r\n\r\n    // Manual mapping to avoid circular dependency or sanitization limit issues\r\n    return snapshot.docs.map(doc => {\r\n        const data = doc.data();\r\n        return {\r\n            id: doc.id,\r\n            ...data,\r\n            createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(),\r\n            deletedAt: data.deletedAt?.toDate ? data.deletedAt.toDate() : new Date(),\r\n            permanentDeleteAt: data.permanentDeleteAt?.toDate ? data.permanentDeleteAt.toDate() : undefined,\r\n            type: 'post' // Helper for UI\r\n        };\r\n    });\r\n}\r\n\r\nexport async function permanentDeletePost(postId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const postRef = adminDb.collection(\"posts\").doc(postId);\r\n    const doc = await postRef.get();\r\n\r\n    if (!doc.exists) return;\r\n    if (doc.data()?.authorId !== user.id) throw new Error(\"Unauthorized\");\r\n\r\n    await postRef.delete();\r\n    revalidatePath('/profile');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\reporting.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[466,469],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[466,469],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\n\r\nexport type ReportReason = 'spam' | 'harassment' | 'hate_speech' | 'nudity' | 'violence' | 'other';\r\n\r\nexport async function createReport(\r\n    targetType: 'post' | 'comment' | 'group' | 'branding' | 'user',\r\n    targetId: string,\r\n    reason: ReportReason,\r\n    details?: string,\r\n    context?: any // JSON object for extra context like groupId, brandingId, etc.\r\n) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"reports\").add({\r\n        reporterId: user.id,\r\n        targetType,\r\n        targetId,\r\n        reason,\r\n        details: details || null,\r\n        context: context || null,\r\n        status: 'pending', // pending, reviewed, dismissed\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // In a real app, we might trigger a notification to admins here\r\n    console.log(`Report created by ${user.id} against ${targetType}:${targetId} for ${reason}`);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\rtc.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[453,456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[453,456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[473,476],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[473,476],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[609,612],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[609,612],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":87,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3128,3131],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3128,3131],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":200,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":200,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6598,6601],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6598,6601],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":351,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":351,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11981,11984],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11981,11984],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { logAuditEvent } from \"./audit\";\r\n\r\nexport type SessionType = \"broadcast\" | \"call_video\" | \"call_audio\";\r\n\r\nexport interface RTCSession {\r\n    id: string;\r\n    hostId: string;\r\n    type: SessionType;\r\n    participants: string[];\r\n    status: \"active\" | \"ended\";\r\n    startedAt: any;\r\n    endedAt?: any;\r\n}\r\n\r\nexport interface SignalPayload {\r\n    type: \"offer\" | \"answer\" | \"candidate\" | \"kicked\";\r\n    sdp?: string;\r\n    candidate?: any;\r\n    from: string;\r\n    to: string;\r\n}\r\n\r\nexport async function startSession(type: SessionType, targetUserId?: string, isPublic: boolean = false) {\r\n    try {\r\n        const user = await getUserProfile();\r\n        if (!user) {\r\n            console.error(\"[startSession] Unauthorized: No user profile found\");\r\n            throw new Error(\"Unauthorized\");\r\n        }\r\n\r\n        // Determine participants based on session type\r\n        const participants = type === \"broadcast\"\r\n            ? [user.id]\r\n            : [user.id, targetUserId!];\r\n\r\n        // For direct calls, check if target user has blocked caller\r\n        if (type !== \"broadcast\" && targetUserId) {\r\n            const targetUserDoc = await adminDb.collection(\"users\").doc(targetUserId).get();\r\n            const targetUserData = targetUserDoc.data();\r\n\r\n            if (targetUserData?.blockedUsers?.includes(user.id)) {\r\n                throw new Error(\"Cannot call this user\");\r\n            }\r\n        }\r\n\r\n        const sessionData = {\r\n            hostId: user.id,\r\n            type,\r\n            participants,\r\n            status: \"active\",\r\n            isPublic: type === \"broadcast\" ? isPublic : true, // Calls are always \"public\" to participants\r\n            viewers: type === \"broadcast\" ? [] : undefined, // Track active viewers for broadcasts\r\n            startedAt: FieldValue.serverTimestamp(),\r\n            lastActiveAt: FieldValue.serverTimestamp(), // Initialize heartbeat\r\n        };\r\n\r\n        console.log(\"[startSession] Creating session in Firestore:\", sessionData);\r\n        const sessionRef = await adminDb.collection(\"active_sessions\").add(sessionData);\r\n\r\n        // Log audit event\r\n        try {\r\n            await logAuditEvent(\r\n                type === \"broadcast\" ? \"settings.update\" : \"message.sent\",\r\n                {\r\n                    targetType: \"rtc_session\",\r\n                    targetId: sessionRef.id,\r\n                    targetName: type === \"broadcast\" ? \"Live Broadcast\" : \"Direct Call\",\r\n                    details: { sessionType: type, participants }\r\n                }\r\n            );\r\n        } catch (auditErr) {\r\n            console.error(\"[startSession] Audit log failed (non-critical):\", auditErr);\r\n        }\r\n\r\n        return {\r\n            sessionId: sessionRef.id,\r\n            ...sessionData,\r\n            // OVERRIDE FieldValue objects with serializable values for the client\r\n            startedAt: new Date(),\r\n            lastActiveAt: new Date(),\r\n        };\r\n    } catch (error: any) {\r\n        console.error(\"[startSession] Critical error:\", error);\r\n        throw new Error(error.message || \"Failed to start session\");\r\n    }\r\n}\r\n\r\nexport async function endSession(sessionId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const sessionRef = adminDb.collection(\"active_sessions\").doc(sessionId);\r\n    const sessionDoc = await sessionRef.get();\r\n\r\n    if (!sessionDoc.exists) {\r\n        throw new Error(\"Session not found\");\r\n    }\r\n\r\n    const sessionData = sessionDoc.data();\r\n\r\n    // Only host or participants can end the session\r\n    if (!sessionData?.participants?.includes(user.id)) {\r\n        throw new Error(\"Unauthorized to end this session\");\r\n    }\r\n\r\n    await sessionRef.update({\r\n        status: \"ended\",\r\n        endedAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // Clean up signaling data after a delay (optional)\r\n    // For now, we'll keep it for debugging purposes\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function sendSignal(sessionId: string, payload: Omit<SignalPayload, \"from\">) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const sessionRef = adminDb.collection(\"active_sessions\").doc(sessionId);\r\n    const sessionDoc = await sessionRef.get();\r\n\r\n    if (!sessionDoc.exists) {\r\n        throw new Error(\"Session not found\");\r\n    }\r\n\r\n    const sessionData = sessionDoc.data();\r\n\r\n    // Verify user is a participant or viewer\r\n    const isParticipant = sessionData?.participants?.includes(user.id);\r\n    const isViewer = sessionData?.type === \"broadcast\" && sessionData?.viewers?.includes(user.id);\r\n\r\n    if (!isParticipant && !isViewer) {\r\n        throw new Error(\"Unauthorized to signal in this session\");\r\n    }\r\n\r\n    const signalData = {\r\n        ...payload,\r\n        from: user.id,\r\n        timestamp: FieldValue.serverTimestamp(),\r\n    };\r\n\r\n    await sessionRef.collection(\"signals\").add(signalData);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function getActiveSession(sessionId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const sessionDoc = await adminDb.collection(\"active_sessions\").doc(sessionId).get();\r\n\r\n    if (!sessionDoc.exists) {\r\n        return null;\r\n    }\r\n\r\n    const sessionData = sessionDoc.data();\r\n\r\n    // For broadcasts, anyone can view\r\n    // For calls, only participants can view\r\n    if (sessionData?.type !== \"broadcast\" && !sessionData?.participants?.includes(user.id)) {\r\n        throw new Error(\"Unauthorized to view this session\");\r\n    }\r\n\r\n    return {\r\n        id: sessionDoc.id,\r\n        ...sessionData,\r\n    } as RTCSession;\r\n}\r\n\r\n// Update session heartbeat\r\nexport async function updateSessionHeartbeat(sessionId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"active_sessions\").doc(sessionId).update({\r\n        lastActiveAt: FieldValue.serverTimestamp(),\r\n    });\r\n}\r\n\r\nexport async function getActiveBroadcasts() {\r\n    const snapshot = await adminDb\r\n        .collection(\"active_sessions\")\r\n        .where(\"type\", \"==\", \"broadcast\")\r\n        .where(\"status\", \"==\", \"active\")\r\n        .orderBy(\"startedAt\", \"desc\")\r\n        .limit(50)\r\n        .get();\r\n\r\n    const now = Date.now();\r\n    const STALE_TIMEOUT = 30 * 1000; // 30 seconds (reduced from 2 mins)\r\n\r\n    const validDocs: any[] = [];\r\n\r\n    // Filter and cleanup stale sessions\r\n    for (const doc of snapshot.docs) {\r\n        const data = doc.data();\r\n\r\n        // Determine last activity time\r\n        // Use lastActiveAt if present, otherwise startedAt, otherwise assume stale\r\n        let lastActivityTime = 0;\r\n\r\n        if (data.lastActiveAt?.toDate) {\r\n            lastActivityTime = data.lastActiveAt.toDate().getTime();\r\n        } else if (data.startedAt?.toDate) {\r\n            lastActivityTime = data.startedAt.toDate().getTime();\r\n        } else {\r\n            // No timestamps? Mark as stale.\r\n            lastActivityTime = 0;\r\n        }\r\n\r\n        if (now - lastActivityTime > STALE_TIMEOUT) {\r\n            // Mark as ended\r\n            console.log(`Cleaning up stale session: ${doc.id}, inactive for ${(now - lastActivityTime) / 1000}s`);\r\n            try {\r\n                await adminDb.collection(\"active_sessions\").doc(doc.id).update({\r\n                    status: \"ended\",\r\n                    endedReason: \"timeout\"\r\n                });\r\n            } catch (err) {\r\n                console.error(`Failed to cleanup stale session ${doc.id}:`, err);\r\n            }\r\n            continue;\r\n        }\r\n\r\n        validDocs.push(doc);\r\n    }\r\n\r\n    const broadcasts = await Promise.all(\r\n        validDocs.map(async (doc) => {\r\n            const data = doc.data();\r\n\r\n            // Get host profile\r\n            const hostDoc = await adminDb.collection(\"users\").doc(data.hostId).get();\r\n            const hostData = hostDoc.data();\r\n\r\n            return {\r\n                id: doc.id,\r\n                ...data,\r\n                hostName: hostData?.displayName || \"Unknown User\",\r\n                hostImage: hostData?.imageUrl || hostData?.profileData?.imageUrl,\r\n            };\r\n        })\r\n    );\r\n\r\n    return broadcasts;\r\n}\r\n\r\n// Get active viewers for a broadcast session\r\nexport async function getSessionViewers(sessionId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const sessionDoc = await adminDb.collection(\"active_sessions\").doc(sessionId).get();\r\n    if (!sessionDoc.exists) throw new Error(\"Session not found\");\r\n\r\n    const sessionData = sessionDoc.data();\r\n    if (sessionData?.hostId !== user.id) throw new Error(\"Not authorized\");\r\n\r\n    const viewerIds = sessionData?.viewers || [];\r\n\r\n    // Get viewer profiles\r\n    const viewers = await Promise.all(\r\n        viewerIds.map(async (viewerId: string) => {\r\n            const viewerDoc = await adminDb.collection(\"users\").doc(viewerId).get();\r\n            const viewerData = viewerDoc.data();\r\n            return {\r\n                id: viewerId,\r\n                displayName: viewerData?.displayName || \"Unknown User\",\r\n                imageUrl: viewerData?.imageUrl || viewerData?.profileData?.imageUrl,\r\n            };\r\n        })\r\n    );\r\n\r\n    return viewers;\r\n}\r\n\r\n// Kick a viewer from broadcast\r\nexport async function kickViewer(sessionId: string, viewerId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const sessionDoc = await adminDb.collection(\"active_sessions\").doc(sessionId).get();\r\n    if (!sessionDoc.exists) throw new Error(\"Session not found\");\r\n\r\n    const sessionData = sessionDoc.data();\r\n    if (sessionData?.hostId !== user.id) throw new Error(\"Not authorized\");\r\n\r\n    // Remove viewer from viewers array\r\n    await adminDb.collection(\"active_sessions\").doc(sessionId).update({\r\n        viewers: FieldValue.arrayRemove(viewerId),\r\n        kickedViewers: FieldValue.arrayUnion(viewerId), // Track kicked viewers\r\n    });\r\n\r\n    // Send signal to viewer to disconnect\r\n    await sendSignal(sessionId, {\r\n        type: \"kicked\",\r\n        to: viewerId,\r\n    });\r\n\r\n    return { success: true };\r\n}\r\n\r\n// Update broadcast privacy setting\r\nexport async function updateSessionPrivacy(sessionId: string, isPublic: boolean) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const sessionDoc = await adminDb.collection(\"active_sessions\").doc(sessionId).get();\r\n    if (!sessionDoc.exists) throw new Error(\"Session not found\");\r\n\r\n    const sessionData = sessionDoc.data();\r\n    if (sessionData?.hostId !== user.id) throw new Error(\"Not authorized\");\r\n\r\n    await adminDb.collection(\"active_sessions\").doc(sessionId).update({\r\n        isPublic,\r\n    });\r\n\r\n    return { success: true, isPublic };\r\n}\r\n\r\n// Add viewer to session (called when viewer joins)\r\nexport async function addViewer(sessionId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const sessionDoc = await adminDb.collection(\"active_sessions\").doc(sessionId).get();\r\n    if (!sessionDoc.exists) throw new Error(\"Session not found\");\r\n\r\n    const sessionData = sessionDoc.data();\r\n\r\n    // Check if viewer was kicked\r\n    if (sessionData?.kickedViewers?.includes(user.id)) {\r\n        throw new Error(\"You have been removed from this broadcast\");\r\n    }\r\n\r\n    // Check privacy settings\r\n    if (!sessionData?.isPublic) {\r\n        // Family-only broadcast - check if viewer is in host's family\r\n        const familySnapshot = await adminDb.collection(\"familyConnections\")\r\n            .where(\"users\", \"array-contains\", user.id)\r\n            .get();\r\n\r\n        const isFamily = familySnapshot.docs.some((doc: any) => {\r\n            const data = doc.data();\r\n            return data.users?.includes(sessionData?.hostId || \"\");\r\n        });\r\n\r\n        if (!isFamily && sessionData?.hostId !== user.id) {\r\n            throw new Error(\"This is a family-only broadcast\");\r\n        }\r\n    }\r\n\r\n    // Add viewer to viewers array\r\n    await adminDb.collection(\"active_sessions\").doc(sessionId).update({\r\n        viewers: FieldValue.arrayUnion(user.id),\r\n    });\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function getIncomingCall(userId: string) {\r\n    const snapshot = await adminDb\r\n        .collection(\"active_sessions\")\r\n        .where(\"participants\", \"array-contains\", userId)\r\n        .where(\"status\", \"==\", \"active\")\r\n        .where(\"type\", \"in\", [\"call_video\", \"call_audio\"])\r\n        .orderBy(\"startedAt\", \"desc\")\r\n        .limit(1)\r\n        .get();\r\n\r\n    if (snapshot.empty) return null;\r\n\r\n    const doc = snapshot.docs[0];\r\n    const data = doc.data();\r\n\r\n    // Only return if user is NOT the host (i.e., they're receiving the call)\r\n    if (data.hostId === userId) return null;\r\n\r\n    // Get caller info\r\n    const callerDoc = await adminDb.collection(\"users\").doc(data.hostId).get();\r\n    const callerData = callerDoc.data();\r\n\r\n    return {\r\n        id: doc.id,\r\n        ...data,\r\n        callerName: callerData?.displayName || \"Unknown User\",\r\n        callerImage: callerData?.imageUrl || callerData?.profileData?.imageUrl,\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\security.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1993,1996],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1993,1996],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2792,2795],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2792,2795],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\nimport { logAuditEvent } from \"@/app/actions/audit\";\r\n\r\nexport async function blockUser(userId: string) {\r\n    const currentUser = await getUserProfile();\r\n    if (!currentUser) throw new Error(\"Unauthorized\");\r\n\r\n    if (currentUser.id === userId) throw new Error(\"Cannot block yourself\");\r\n\r\n    // Check if already blocked\r\n    const existing = await adminDb.collection(\"blockedUsers\")\r\n        .where(\"blockerId\", \"==\", currentUser.id)\r\n        .where(\"blockedId\", \"==\", userId)\r\n        .get();\r\n\r\n    if (!existing.empty) return;\r\n\r\n    // Get blocked user info for audit\r\n    const blockedUserDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    const blockedUserData = blockedUserDoc.data();\r\n\r\n    await adminDb.collection(\"blockedUsers\").add({\r\n        blockerId: currentUser.id,\r\n        blockedId: userId,\r\n        createdAt: new Date(),\r\n    });\r\n\r\n    await logAuditEvent(\"user.block\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName: blockedUserData?.displayName || blockedUserData?.email || \"Unknown\",\r\n    });\r\n\r\n    revalidatePath(\"/settings\");\r\n    revalidatePath(`/u/${userId}`);\r\n    revalidatePath(\"/\");\r\n}\r\n\r\nexport async function unblockUser(userId: string) {\r\n    const currentUser = await getUserProfile();\r\n    if (!currentUser) throw new Error(\"Unauthorized\");\r\n\r\n    // Get user info for audit before unblocking\r\n    const unblockedUserDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n    const unblockedUserData = unblockedUserDoc.data();\r\n\r\n    const blockedSnapshot = await adminDb.collection(\"blockedUsers\")\r\n        .where(\"blockerId\", \"==\", currentUser.id)\r\n        .where(\"blockedId\", \"==\", userId)\r\n        .get();\r\n\r\n    const batch = adminDb.batch();\r\n    blockedSnapshot.docs.forEach((doc: any) => {\r\n        batch.delete(doc.ref);\r\n    });\r\n    await batch.commit();\r\n\r\n    await logAuditEvent(\"user.unblock\", {\r\n        targetType: \"user\",\r\n        targetId: userId,\r\n        targetName: unblockedUserData?.displayName || unblockedUserData?.email || \"Unknown\",\r\n    });\r\n\r\n    revalidatePath(\"/settings\");\r\n    revalidatePath(`/u/${userId}`);\r\n    revalidatePath(\"/\");\r\n}\r\n\r\nexport async function getBlockedUsers() {\r\n    const currentUser = await getUserProfile();\r\n    if (!currentUser) return [];\r\n\r\n    const blockedSnapshot = await adminDb.collection(\"blockedUsers\")\r\n        .where(\"blockerId\", \"==\", currentUser.id)\r\n        .get();\r\n\r\n    // Fetch user details for each blocked user\r\n    const blockedUsers = await Promise.all(\r\n        blockedSnapshot.docs.map(async (blockDoc: any) => {\r\n            const blockData = blockDoc.data();\r\n            const userDoc = await adminDb.collection(\"users\").doc(blockData.blockedId).get();\r\n            if (userDoc.exists) {\r\n                const userData = userDoc.data();\r\n                return sanitizeData({\r\n                    id: userDoc.id,\r\n                    displayName: userData?.displayName,\r\n                    email: userData?.email,\r\n                    imageUrl: userData?.imageUrl,\r\n                });\r\n            }\r\n            return null;\r\n        })\r\n    );\r\n\r\n    return blockedUsers.filter(Boolean);\r\n}\r\n\r\nexport async function toggleInvisibleMode(isInvisible: boolean) {\r\n    const currentUser = await getUserProfile();\r\n    if (!currentUser) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"users\").doc(currentUser.id).update({ isInvisible });\r\n\r\n    await logAuditEvent(\"security.invisible_mode\", {\r\n        details: { enabled: isInvisible },\r\n    });\r\n\r\n    revalidatePath(\"/settings\");\r\n    revalidatePath(\"/\");\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\settings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\simple-analytics.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[446,449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[446,449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":18,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1610,1613],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1610,1613],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\n\r\n/**\r\n * Get simple real analytics without complex queries\r\n */\r\nexport async function getSimpleAnalytics() {\r\n    const user = await getUserProfile();\r\n    if (!user || user.role !== 'admin') throw new Error(\"Unauthorized\");\r\n\r\n    // Helper to get count with fallback for Firestore SDK versions\r\n    const getCount = async (query: any) => {\r\n        try {\r\n            const agg = await query.count().get();\r\n            return agg.data().count;\r\n        } catch (e) {\r\n            const snap = await query.get();\r\n            return snap.size;\r\n        }\r\n    };\r\n    try {\r\n        // Fetch basic counts using fallback helper\r\n        const totalUsers = await getCount(adminDb.collection(\"users\"));\r\n        const totalPosts = await getCount(adminDb.collection(\"posts\"));\r\n        const totalGroups = await getCount(adminDb.collection(\"groups\"));\r\n        const totalBranding = await getCount(adminDb.collection(\"branding\"));\r\n\r\n        // Get recent activity (last 7 days posts)\r\n        const sevenDaysAgo = new Date();\r\n        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\r\n        // Recent posts count with fallback\r\n        const recentPosts = await getCount(\r\n            adminDb.collection(\"posts\").where(\"createdAt\", \">=\", sevenDaysAgo)\r\n        );\r\n        return {\r\n            totalUsers,\r\n            totalPosts,\r\n            totalGroups,\r\n            totalBranding,\r\n            recentActivity: recentPosts,\r\n            _isRealData: true\r\n        };\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Error fetching analytics:\", error);\r\n\r\n        // Return minimal data if queries fail\r\n        return {\r\n            totalUsers: 0,\r\n            totalPosts: 0,\r\n            totalGroups: 0,\r\n            totalBranding: 0,\r\n            recentActivity: 0,\r\n            _isRealData: false,\r\n            _error: error.message\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get list of users for Individual User Analysis\r\n */\r\nexport async function getAnalyticsUserList() {\r\n    const user = await getUserProfile();\r\n    if (!user || user.role !== 'admin') throw new Error(\"Unauthorized\");\r\n\r\n    try {\r\n        const usersSnapshot = await adminDb.collection(\"users\")\r\n            .orderBy(\"createdAt\", \"desc\")\r\n            .limit(100)\r\n            .get();\r\n\r\n        const users = usersSnapshot.docs.map(doc => ({\r\n            id: doc.id,\r\n            displayName: doc.data().displayName || \"Unknown User\",\r\n            email: doc.data().email || \"\",\r\n            photoURL: doc.data().photoURL || \"\",\r\n            createdAt: doc.data().createdAt?.toDate().toISOString() || null\r\n        }));\r\n\r\n        return users;\r\n\r\n    } catch (error) {\r\n        console.error(\"Error fetching users:\", error);\r\n        return [];\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\stocks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\stories.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1892,1895],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1892,1895],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2049,2052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2049,2052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2379,2382],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2379,2382],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2442,2445],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2442,2445],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3163,3166],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3163,3166],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":99,"column":98,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":101,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4087,4090],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4087,4090],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":117,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4936,4939],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4936,4939],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5124,5127],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5124,5127],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":141,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":141,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5669,5672],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5669,5672],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue, Timestamp } from \"firebase-admin/firestore\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\n\r\nexport async function createStory(mediaUrl: string, mediaType: 'image' | 'video') {\r\n    const user = await getUserProfile();\r\n\r\n    if (!user) {\r\n        throw new Error(\"Unauthorized\");\r\n    }\r\n\r\n    if (user.role !== 'member' && user.role !== 'admin') {\r\n        throw new Error(\"Only members can create stories\");\r\n    }\r\n\r\n    // Default expiration: 24 hours from now\r\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\r\n\r\n    const docRef = await adminDb.collection(\"stories\").add({\r\n        authorId: user.id,\r\n        mediaUrl,\r\n        mediaType,\r\n        expiresAt: Timestamp.fromDate(expiresAt),\r\n        createdAt: FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"story.create\", {\r\n        targetType: \"story\",\r\n        targetId: docRef.id,\r\n        details: { mediaUrl: mediaUrl.substring(0, 50) } // don't log full url if long\r\n    });\r\n\r\n\r\n\r\n    revalidatePath(\"/\", 'layout'); // Revalidate everything to be safe\r\n    return { success: true };\r\n}\r\n\r\nexport async function getActiveStories() {\r\n    try {\r\n        // Get stories that haven't expired\r\n        const now = Timestamp.now();\r\n\r\n        const user = await getUserProfile();\r\n        if (!user) return [];\r\n\r\n        const { getFamilyMemberIds } = await import(\"./family\");\r\n        const familyIds = await getFamilyMemberIds(user.id).catch(e => { console.error(\"Story family fetch error:\", e); return []; });\r\n\r\n        // Allowed authors: Myself + Family\r\n        const allowedAuthorIds = [user.id, ...familyIds];\r\n        const queries: Promise<any>[] = [];\r\n\r\n        if (allowedAuthorIds.length > 0) {\r\n            const chunks = chunkArray(allowedAuthorIds, 10);\r\n            chunks.forEach((chunk: any[]) => {\r\n                queries.push(\r\n                    adminDb.collection(\"stories\")\r\n                        .where(\"authorId\", \"in\", chunk)\r\n                        .where(\"expiresAt\", \">\", now)\r\n                        .orderBy(\"expiresAt\", \"asc\")\r\n                        .get()\r\n                        .then((snap: any) => snap.docs)\r\n                        .catch(async (err: any) => {\r\n                            console.warn(\"Family stories ordered query failed, trying robust fallback:\", err);\r\n                            // Fallback: Query ONLY by authorId, filter date in memory\r\n                            // This avoids needing complex composite indexes for 'in' + 'range'\r\n                            try {\r\n                                const fallbackSnap = await adminDb.collection(\"stories\")\r\n                                    .where(\"authorId\", \"in\", chunk)\r\n                                    .get(); // Fetch ALL stories for these authors\r\n\r\n                                const nowMillis = Date.now();\r\n                                return fallbackSnap.docs.filter((doc: any) => {\r\n                                    const data = doc.data();\r\n                                    const exp = data.expiresAt?.toMillis ? data.expiresAt.toMillis() : 0;\r\n                                    return exp > nowMillis;\r\n                                });\r\n                            } catch (fallbackErr) {\r\n                                console.error(\"Family stories fallback query also failed:\", fallbackErr);\r\n                                return [];\r\n                            }\r\n                        })\r\n                );\r\n            });\r\n        }\r\n\r\n        const results = await Promise.all(queries);\r\n        const storiesDocs = results.flat();\r\n\r\n        // Mock snapshot structure for compatibility with existing map logic\r\n        const storiesSnapshot = { docs: storiesDocs };\r\n\r\n        const activeStoriesResults = await Promise.all(storiesSnapshot.docs.map(async (storyDoc: any) => {\r\n            const storyData = storyDoc.data();\r\n            const authorDoc = await adminDb.collection(\"users\").doc(storyData.authorId).get();\r\n            const author = authorDoc.exists ? {\r\n                id: authorDoc.id,\r\n                displayName: authorDoc.data()?.displayName || (authorDoc.data()?.profileData?.firstName ? `${authorDoc.data()?.profileData.firstName} ${authorDoc.data()?.profileData.lastName || ''}`.trim() : null) || authorDoc.data()?.email?.split('@')[0] || \"Unknown\",\r\n                imageUrl: authorDoc.data()?.imageUrl\r\n            } : null;\r\n\r\n            if (!author) return null;\r\n\r\n            return sanitizeData({\r\n                id: storyDoc.id,\r\n                ...storyData,\r\n                author\r\n            });\r\n        }));\r\n\r\n        const activeStories = activeStoriesResults.filter((s: any) => s !== null);\r\n\r\n        // Group stories by user\r\n        const userStoriesMap = new Map();\r\n\r\n        for (const story of activeStories) {\r\n            const storyData = story as any;\r\n            const authorId = storyData.authorId;\r\n            if (!userStoriesMap.has(authorId)) {\r\n                userStoriesMap.set(authorId, {\r\n                    user: storyData.author,\r\n                    stories: [],\r\n                });\r\n            }\r\n            userStoriesMap.get(authorId).stories.push(story);\r\n        }\r\n\r\n        return Array.from(userStoriesMap.values());\r\n    } catch (error) {\r\n        console.error(\"Error fetching active stories:\", error);\r\n        return [];\r\n    }\r\n}\r\n\r\nfunction chunkArray(array: any[], size: number) {\r\n    const chunked = [];\r\n    let index = 0;\r\n    while (index < array.length) {\r\n        chunked.push(array.slice(index, size + index));\r\n        index += size;\r\n    }\r\n    return chunked;\r\n}\r\n\r\nexport async function deleteStory(storyId: string) {\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    const storyRef = adminDb.collection(\"stories\").doc(storyId);\r\n    const storyDoc = await storyRef.get();\r\n\r\n    if (!storyDoc.exists) throw new Error(\"Story not found\");\r\n\r\n    // Only author (or admin, implicitly) can delete\r\n    if (storyDoc.data()?.authorId !== user.id && user.role !== 'admin') {\r\n        throw new Error(\"Unauthorized\");\r\n    }\r\n\r\n    await storyRef.delete();\r\n\r\n    // Log audit\r\n    const { logAuditEvent } = await import(\"./audit\");\r\n    await logAuditEvent(\"story.delete\", {\r\n        targetType: \"story\",\r\n        targetId: storyId\r\n    });\r\n\r\n    revalidatePath(\"/\", 'layout');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\tavily.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\trends.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1659,1662],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1659,1662],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":99,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3239,3242],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3239,3242],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nexport type TrendSource = 'tiktok' | 'youtube' | 'news' | 'twitter';\r\n\r\nexport type TrendItem = {\r\n    id: string;\r\n    title: string;\r\n    source: TrendSource;\r\n    description?: string;\r\n    url?: string;\r\n    thumbnail?: string;\r\n    metric?: number; // views, tweets, engagement count\r\n    timestamp: Date;\r\n};\r\n\r\nexport type AITrendAnalysis = {\r\n    summary: string;          // What is trending (20 words max)\r\n    origin: string;           // Where it started\r\n    traction: string;         // Why it's gaining momentum\r\n    crossPlatform: {\r\n        tiktok?: string;\r\n        youtube?: string;\r\n        twitter?: string;\r\n        news?: string;\r\n    };\r\n    whyItMatters: string;     // Cultural/economic/tech impact\r\n    lifecycle: 'emerging' | 'peaking' | 'sustaining' | 'declining';\r\n};\r\n\r\nexport type EnhancedTrend = TrendItem & {\r\n    aiAnalysis?: AITrendAnalysis;\r\n};\r\n\r\n// YouTube Trending\r\nexport async function getYouTubeTrends(): Promise<TrendItem[]> {\r\n    try {\r\n        const apiKey = process.env.YOUTUBE_API_KEY;\r\n        if (!apiKey) {\r\n            console.warn('YouTube API key not configured');\r\n            return [];\r\n        }\r\n\r\n        const response = await fetch(\r\n            `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&chart=mostPopular&regionCode=US&maxResults=10&key=${apiKey}`,\r\n            { next: { revalidate: 3600 } } // Cache for 1 hour\r\n        );\r\n\r\n        if (!response.ok) {\r\n            console.error('YouTube API error:', response.statusText);\r\n            return [];\r\n        }\r\n\r\n        const data = await response.json();\r\n\r\n        return data.items?.map((item: any) => ({\r\n            id: `youtube-${item.id}`,\r\n            title: item.snippet.title,\r\n            source: 'youtube' as TrendSource,\r\n            description: item.snippet.description.substring(0, 200),\r\n            url: `https://www.youtube.com/watch?v=${item.id}`,\r\n            thumbnail: item.snippet.thumbnails?.medium?.url,\r\n            metric: parseInt(item.statistics.viewCount),\r\n            timestamp: new Date(item.snippet.publishedAt)\r\n        })) || [];\r\n    } catch (error) {\r\n        console.error('YouTube trends fetch error:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// Twitter Trending (using free tier v2 API)\r\nexport async function getTwitterTrends(): Promise<TrendItem[]> {\r\n    try {\r\n        const bearerToken = process.env.TWITTER_BEARER_TOKEN;\r\n        if (!bearerToken) {\r\n            console.warn('Twitter API token not configured');\r\n            return [];\r\n        }\r\n\r\n        // Twitter API v2 - Get trending topics (WOEID 1 = Worldwide)\r\n        const response = await fetch(\r\n            'https://api.twitter.com/1.1/trends/place.json?id=1',\r\n            {\r\n                headers: {\r\n                    'Authorization': `Bearer ${bearerToken}`\r\n                },\r\n                next: { revalidate: 1800 } // Cache for 30 minutes\r\n            }\r\n        );\r\n\r\n        if (!response.ok) {\r\n            console.error('Twitter API error:', response.statusText);\r\n            return [];\r\n        }\r\n\r\n        const data = await response.json();\r\n        const trends = data[0]?.trends || [];\r\n\r\n        return trends.slice(0, 10).map((trend: any, index: number) => ({\r\n            id: `twitter-${index}`,\r\n            title: trend.name,\r\n            source: 'twitter' as TrendSource,\r\n            description: `${trend.tweet_volume ? `${trend.tweet_volume.toLocaleString()} tweets` : 'Trending'}`,\r\n            url: trend.url || `https://twitter.com/search?q=${encodeURIComponent(trend.name)}`,\r\n            metric: trend.tweet_volume || 0,\r\n            timestamp: new Date()\r\n        }));\r\n    } catch (error) {\r\n        console.error('Twitter trends fetch error:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// TikTok Trends (aggregated from public sources)\r\nexport async function getTikTokTrends(): Promise<TrendItem[]> {\r\n    try {\r\n        // Note: TikTok doesn't have a free public API\r\n        // This is a placeholder for trend aggregation from public sources\r\n        // You could integrate with third-party services or RSS feeds\r\n\r\n        // For now, return mock data structure\r\n        // In production, integrate with trend aggregator APIs or scrape public trend pages\r\n        return [];\r\n    } catch (error) {\r\n        console.error('TikTok trends fetch error:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// News Trends (reuse existing news feed infrastructure)\r\nexport async function getNewsTrends(): Promise<TrendItem[]> {\r\n    try {\r\n        const { getNews } = await import('./news');\r\n        const newsItems = await getNews('general');\r\n\r\n        return newsItems.slice(0, 5).map((item, index) => ({\r\n            id: `news-${index}`,\r\n            title: item.title,\r\n            source: 'news' as TrendSource,\r\n            description: item.description,\r\n            url: item.link,\r\n            thumbnail: item.thumbnail,\r\n            metric: 0, // News doesn't have engagement metrics readily available\r\n            timestamp: new Date(item.pubDate)\r\n        }));\r\n    } catch (error) {\r\n        console.error('News trends fetch error:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// Aggregate all trends\r\nexport async function aggregateTrends(): Promise<TrendItem[]> {\r\n    try {\r\n        const [youtube, twitter, tiktok, news] = await Promise.all([\r\n            getYouTubeTrends(),\r\n            getTwitterTrends(),\r\n            getTikTokTrends(),\r\n            getNewsTrends()\r\n        ]);\r\n\r\n        const allTrends = [...youtube, ...twitter, ...tiktok, ...news];\r\n\r\n        // Sort by metric (engagement) descending\r\n        return allTrends.sort((a, b) => (b.metric || 0) - (a.metric || 0));\r\n    } catch (error) {\r\n        console.error('Trend aggregation error:', error);\r\n        return [];\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\user-analytics.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1292,1295],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1292,1295],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1631,1634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1631,1634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":92,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3511,3514],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3511,3514],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\n\r\n/**\r\n * Get individual user analytics\r\n */\r\nexport async function getUserAnalyticsSimple(userId: string) {\r\n    console.log('--- getUserAnalyticsSimple START ---');\r\n    console.log('Fetching user analytics for ID:', userId);\r\n\r\n    try {\r\n        if (!userId) {\r\n            console.error('Error: userId is empty');\r\n            return null;\r\n        }\r\n\r\n        const userDocRef = adminDb.collection(\"users\").doc(userId);\r\n        const userDoc = await userDocRef.get();\r\n        console.log('User doc path:', userDocRef.path);\r\n        console.log('User doc exists:', userDoc.exists);\r\n\r\n        if (!userDoc.exists) {\r\n            console.warn(`User document with ID ${userId} does not exist in collection 'users'.`);\r\n            return {\r\n                _error: \"User Document Not Found\",\r\n                _searchedId: userId,\r\n                _collection: \"users\",\r\n                _dbProjectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || \"unknown\"\r\n            };\r\n        }\r\n        const userData = userDoc.data();\r\n        console.log('User data found:', userData?.email);\r\n\r\n        // Helper to get count with fallback\r\n        const getCount = async (query: any, label: string) => {\r\n            try {\r\n                // Firestore aggregate count (supported in newer SDKs)\r\n                const agg = await query.count().get();\r\n                const count = agg.data().count;\r\n                console.log(`${label} count (agg):`, count);\r\n                return count;\r\n            } catch (e: any) {\r\n                console.warn(`Aggregation failed for ${label}, falling back to size. Error: ${e.message}`);\r\n                // Fallback to fetching docs and using size\r\n                const snap = await query.get();\r\n                console.log(`${label} count (snap):`, snap.size);\r\n                return snap.size;\r\n            }\r\n        };\r\n\r\n        // Count user's posts\r\n        const postsCount = await getCount(\r\n            adminDb.collection(\"posts\").where(\"authorId\", \"==\", userId),\r\n            'Posts'\r\n        );\r\n\r\n        // Count user's groups (as member)\r\n        // Groups use a subcollection 'members', so we must query that via collectionGroup\r\n        const groupsCount = await getCount(\r\n            adminDb.collectionGroup(\"members\").where(\"userId\", \"==\", userId),\r\n            'Groups'\r\n        );\r\n\r\n        // Recent posts (last 7 days)\r\n        const sevenDaysAgo = new Date();\r\n        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\r\n        const recentPostsCount = await getCount(\r\n            adminDb\r\n                .collection(\"posts\")\r\n                .where(\"authorId\", \"==\", userId)\r\n                .where(\"createdAt\", \">=\", sevenDaysAgo),\r\n            'Recent Posts'\r\n        );\r\n\r\n        const result = {\r\n            userId,\r\n            displayName: userData?.displayName || \"Unknown User\",\r\n            email: userData?.email || \"\",\r\n            photoURL: userData?.photoURL || \"\",\r\n            joinedDate: userData?.createdAt?.toDate ? userData?.createdAt?.toDate().toISOString() : null,\r\n            totalPosts: postsCount,\r\n            totalGroups: groupsCount,\r\n            recentPosts: recentPostsCount,\r\n            _isRealData: true,\r\n        };\r\n        console.log('Returning analysis result:', result);\r\n        console.log('--- getUserAnalyticsSimple END ---');\r\n        return result;\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Error fetching user analytics:\", error);\r\n        // Log the full stack trace if possible\r\n        if (error.stack) console.error(error.stack);\r\n        return {\r\n            _error: error.message\r\n        }; // Return error details instead of just null to help debug specific issues\r\n    }\r\n}\r\n\r\n/**\r\n * Get list of all users for the dropdown\r\n */\r\nexport async function getAllUsersList() {\r\n    const user = await getUserProfile();\r\n    if (!user || user.role !== 'admin') throw new Error(\"Unauthorized\");\r\n\r\n    try {\r\n        const usersSnapshot = await adminDb.collection(\"users\")\r\n            .orderBy(\"createdAt\", \"desc\")\r\n            .limit(100)\r\n            .get();\r\n\r\n        const users = usersSnapshot.docs.map(doc => ({\r\n            id: doc.id,\r\n            displayName: doc.data().displayName || \"Unknown User\",\r\n            email: doc.data().email || \"\"\r\n        }));\r\n\r\n        return users;\r\n\r\n    } catch (error) {\r\n        console.error(\"Error fetching users list:\", error);\r\n        return [];\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\user.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doc' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"doc"},"fix":{"range":[75,79],"text":""},"desc":"Remove unused variable \"doc\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateDoc' is defined but never used.","line":4,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"updateDoc"},"fix":{"range":[66,118],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1149,1152],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1149,1152],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1191,1194],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1191,1194],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1218,1221],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1218,1221],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { doc, updateDoc } from \"firebase/firestore\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nexport async function updateBirthday(birthday: string) {\r\n    // Basic validation for MM-DD format\r\n    const regex = /^(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;\r\n    if (!regex.test(birthday)) {\r\n        throw new Error(\"Invalid format. Use MM-DD\");\r\n    }\r\n\r\n    const user = await getUserProfile();\r\n    if (!user) throw new Error(\"Unauthorized\");\r\n\r\n    await adminDb.collection(\"users\").doc(user.id).update({ birthday });\r\n\r\n    revalidatePath(\"/\");\r\n    return { success: true };\r\n}\r\n\r\nexport async function searchUsers(query: string) {\r\n    if (!query || query.length < 2) return [];\r\n\r\n    const user = await getUserProfile();\r\n    if (!user) return [];\r\n\r\n    // Simple prefix search\r\n    const snapshot = await adminDb.collection(\"users\")\r\n        .where(\"displayName\", \">=\", query)\r\n        .where(\"displayName\", \"<=\", query + \"\\uf8ff\")\r\n        .limit(10)\r\n        .get();\r\n\r\n    return snapshot.docs\r\n        .map((doc: any) => ({ id: doc.id, ...doc.data() } as any))\r\n        .filter((u: any) => u.id !== user.id);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\users.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1120,1123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1120,1123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1171,1174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1171,1174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1201,1204],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1201,1204],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1520,1523],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1520,1523],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1893,1896],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1893,1896],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2051,2054],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2051,2054],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3294,3297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3294,3297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\n\r\nexport async function updateLastActive() {\r\n    try {\r\n        const user = await getUserProfile();\r\n        if (!user) return;\r\n\r\n        await adminDb.collection(\"users\").doc(user.id).update({\r\n            lastActiveAt: FieldValue.serverTimestamp()\r\n        });\r\n    } catch (error) {\r\n        // Silent fail for activity tracking\r\n        console.error(\"Error updating last active:\", error);\r\n    }\r\n}\r\n\r\nexport async function getActiveUsers() {\r\n    try {\r\n        const currentUser = await getUserProfile();\r\n\r\n        // Query most recent 50 users (online or offline)\r\n        // This ensures the \"Members\" list is populated so you can DM/Call them anytime.\r\n        const usersSnapshot = await adminDb.collection(\"users\")\r\n            .orderBy(\"lastActiveAt\", \"desc\")\r\n            .limit(50)\r\n            .get();\r\n\r\n        // Filter out current user and blocked users\r\n        let activeUsers = usersSnapshot.docs\r\n            .map((userDoc: any) => ({ id: userDoc.id, ...userDoc.data() }) as any)\r\n            .filter((u: any) => u.id !== currentUser?.id && u.isInvisible !== true);\r\n\r\n        if (currentUser) {\r\n            // Fetch blocked users\r\n            const blockedSnapshot = await adminDb.collection(\"blockedUsers\").get();\r\n            const excludedIds = new Set<string>();\r\n\r\n            blockedSnapshot.docs.forEach((blockDoc: any) => {\r\n                const blockData = blockDoc.data();\r\n                if (blockData.blockerId === currentUser.id || blockData.blockedId === currentUser.id) {\r\n                    excludedIds.add(blockData.blockerId);\r\n                    excludedIds.add(blockData.blockedId);\r\n                }\r\n            });\r\n\r\n            activeUsers = activeUsers.filter((u: any) => !excludedIds.has(u.id));\r\n        }\r\n\r\n        const fifteenMinutesAgo = new Date(Date.now() - 15 * 60 * 1000);\r\n\r\n        return activeUsers.map((u: any) => {\r\n            const displayName = u.displayName ||\r\n                (u.profileData?.firstName ? `${u.profileData.firstName} ${u.profileData.lastName || ''}`.trim() : null) ||\r\n                u.email?.split('@')[0] ||\r\n                \"Unknown\";\r\n\r\n            // Calculate Online Status\r\n            // Check if lastActiveAt is a Firestore Timestamp or Date\r\n            let lastActiveDate = u.lastActiveAt instanceof Date ? u.lastActiveAt : u.lastActiveAt?.toDate?.();\r\n            const isOnline = lastActiveDate ? lastActiveDate > fifteenMinutesAgo : false;\r\n\r\n            return JSON.parse(JSON.stringify({\r\n                id: u.id,\r\n                displayName: displayName,\r\n                imageUrl: u.imageUrl || null,\r\n                profileData: u.profileData,\r\n                isOnline: isOnline\r\n            }));\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Error fetching users:\", error);\r\n        return [];\r\n    }\r\n}\r\n\r\nexport async function getProfileById(userId: string) {\r\n    try {\r\n        const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n        if (!userDoc.exists) return null;\r\n\r\n        return {\r\n            id: userDoc.id,\r\n            ...userDoc.data()\r\n        } as any;\r\n    } catch (error) {\r\n        console.error(\"Error fetching profile by ID:\", error);\r\n        return null;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\actions\\verification.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4405,4408],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4405,4408],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { FieldValue } from \"firebase-admin/firestore\";\r\nimport { getAuth } from \"firebase-admin/auth\";\r\n\r\nconst RATE_LIMIT_COOLDOWN_MS = 5 * 60 * 1000; // 5 minutes\r\nconst MAX_ATTEMPTS_PER_24H = 3;\r\n\r\nexport async function sendVerificationEmail() {\r\n    try {\r\n        const user = await getUserProfile();\r\n        if (!user) return { success: false, error: \"Not logged in\" };\r\n\r\n        const userRef = adminDb.collection(\"users\").doc(user.id);\r\n        const userDoc = await userRef.get();\r\n        const userData = userDoc.data();\r\n\r\n        if (!userData) return { success: false, error: \"User not found\" };\r\n        if (userData.emailVerified) return { success: false, error: \"Already verified\" };\r\n\r\n        // Rate Limiting Checks\r\n        const now = Date.now();\r\n        const lastSent = userData.verificationEmailSentAt?.toDate().getTime() || 0;\r\n        const attempts = userData.verificationResendCountToday || 0;\r\n        const lastReset = userData.verificationCountResetAt?.toDate().getTime() || 0;\r\n\r\n        // Reset daily counter if > 24h\r\n        let currentAttempts = attempts;\r\n        if (now - lastReset > 24 * 60 * 60 * 1000) {\r\n            currentAttempts = 0;\r\n            await userRef.update({\r\n                verificationResendCountToday: 0,\r\n                verificationCountResetAt: FieldValue.serverTimestamp()\r\n            });\r\n        }\r\n\r\n        // Check Cooldown\r\n        if (now - lastSent < RATE_LIMIT_COOLDOWN_MS) {\r\n            const remainingS = Math.ceil((RATE_LIMIT_COOLDOWN_MS - (now - lastSent)) / 1000);\r\n            return { success: false, error: `Please wait ${remainingS}s before resending.`, nextAvailableIn: remainingS };\r\n        }\r\n\r\n        // Check Max Daily\r\n        if (currentAttempts >= MAX_ATTEMPTS_PER_24H) {\r\n            return { success: false, error: \"Daily limit reached. Try again tomorrow.\" };\r\n        }\r\n\r\n        // Send Email via Firebase Admin Auth (Generate Link)\r\n        // Firebase Admin doesn't natively \"send\" the template email like Client SDK does.\r\n        // It provides 'generateEmailVerificationLink'.\r\n        // To stick to the prompt \"Verification email must be sent immediately... default behavior must not be trusted\",\r\n        // we can GENERATE the link and send it via our own mailer (Firestore 'mail' collection trigger).\r\n\r\n        // However, standard Firebase Auth 'sendEmailVerification' on CLIENT side is the easiest path for \"Magic Link\" equivalent.\r\n        // But prompt says \"Backend Enforcement Rules... No trusted action rely solely on frontend\".\r\n\r\n        // Let's use the Admin SDK to generic the link and send it via our Email Extension/System.\r\n        // This ensures WE control the delivery and can log it.\r\n\r\n        const auth = getAuth();\r\n        const link = await auth.generateEmailVerificationLink(user.email);\r\n\r\n        // Log to 'mail' collection for delivery\r\n        await adminDb.collection(\"mail\").add({\r\n            to: user.email,\r\n            message: {\r\n                subject: \"Verify your Famio email\",\r\n                text: `Please verify your email for Famio by clicking here: ${link}`,\r\n                html: `\r\n                <div style=\"font-family: sans-serif; padding: 20px; text-align: center;\">\r\n                    <h1>Verify your email</h1>\r\n                    <p>Click the button below to verify your email address and unlock full access to Famio.</p>\r\n                    <a href=\"${link}\" style=\"display: inline-block; padding: 12px 24px; background-color: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;\">Verify Email</a>\r\n                    <p style=\"margin-top: 20px; font-size: 12px; color: #666;\">If you didn't create an account, you can ignore this email.</p>\r\n                </div>\r\n                `\r\n            }\r\n        });\r\n\r\n        // Update Stats\r\n        await userRef.update({\r\n            verificationEmailSentAt: FieldValue.serverTimestamp(),\r\n            verificationResendCountToday: FieldValue.increment(1),\r\n            verificationCountResetAt: (!userData.verificationCountResetAt || currentAttempts === 0) ? FieldValue.serverTimestamp() : userData.verificationCountResetAt // Set reset time if new cycle\r\n        });\r\n\r\n        return { success: true };\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Verification email failed:\", error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\admin\\analytics\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\admin\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1248,1251],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1248,1251],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1571,1574],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1571,1574],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1662,1665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1662,1665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1759,1762],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1759,1762],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1856,1859],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1856,1859],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2162,2165],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2162,2165],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2453,2456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2453,2456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2464,2467],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2464,2467],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const dynamic = \"force-dynamic\";\r\n\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { UserList } from \"@/components/admin/user-list\";\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { BirthdayTrigger } from \"@/components/admin/birthday-trigger\";\r\nimport { AdminCharts } from \"@/components/admin/admin-charts\";\r\nimport { AuditLogViewer } from \"@/components/admin/audit-log-viewer\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Users, UserPlus, Calendar, BarChart2 } from \"lucide-react\";\r\nimport { subDays, startOfDay, subYears, format } from \"date-fns\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\nimport { BroadcastPanel } from \"@/components/admin/broadcast-panel\";\r\nimport Link from \"next/link\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nexport default async function AdminPage() {\r\n    const user = await getUserProfile();\r\n\r\n    if (!user || user.role !== 'admin') {\r\n        redirect(\"/\");\r\n    }\r\n\r\n    const usersSnapshot = await adminDb.collection(\"users\").orderBy(\"createdAt\", \"desc\").get();\r\n    const allUsers = usersSnapshot.docs.map((doc: any) => sanitizeData({ id: doc.id, ...doc.data() }));\r\n\r\n    // Calculate Metrics\r\n    const now = new Date();\r\n    const today = startOfDay(now);\r\n    const oneWeekAgo = subDays(today, 7);\r\n    const oneMonthAgo = subDays(today, 30);\r\n    const oneYearAgo = subYears(today, 1);\r\n\r\n    const newDaily = allUsers.filter((u: any) => new Date(u.createdAt) >= today).length;\r\n    const newWeekly = allUsers.filter((u: any) => new Date(u.createdAt) >= oneWeekAgo).length;\r\n    const newMonthly = allUsers.filter((u: any) => new Date(u.createdAt) >= oneMonthAgo).length;\r\n    const newYearly = allUsers.filter((u: any) => new Date(u.createdAt) >= oneYearAgo).length;\r\n\r\n    // Prepare Chart Data (Last 7 Days Registration)\r\n    const registrationData = [];\r\n    for (let i = 6; i >= 0; i--) {\r\n        const d = subDays(today, i);\r\n        const dateStr = format(d, 'MMM dd');\r\n        const count = allUsers.filter((u: any) => {\r\n            const uDate = startOfDay(new Date(u.createdAt));\r\n            return uDate.getTime() === d.getTime();\r\n        }).length;\r\n        registrationData.push({ name: dateStr, total: count });\r\n    }\r\n\r\n    // Role Distribution\r\n    const roleCounts = allUsers.reduce((acc: any, curr: any) => {\r\n        acc[curr.role] = (acc[curr.role] || 0) + 1;\r\n        return acc;\r\n    }, {} as Record<string, number>);\r\n\r\n    const roleData = Object.entries(roleCounts).map(([key, value]) => ({\r\n        name: key.charAt(0).toUpperCase() + key.slice(1),\r\n        value: value as number\r\n    }));\r\n\r\n    return (\r\n        <MainLayout>\r\n            <div className=\"container mx-auto py-10\">\r\n                <div className=\"flex justify-between items-center mb-6\">\r\n                    <h1 className=\"text-3xl font-bold\">Admin Dashboard</h1>\r\n                </div>\r\n\r\n                {/* Metrics Cards */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6\">\r\n                    <Card>\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium\">New Users (Daily)</CardTitle>\r\n                            <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold\">+{newDaily}</div>\r\n                            <p className=\"text-xs text-muted-foreground\">Registered today</p>\r\n                        </CardContent>\r\n                    </Card>\r\n                    <Card>\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium\">New Users (Weekly)</CardTitle>\r\n                            <UserPlus className=\"h-4 w-4 text-muted-foreground\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold\">+{newWeekly}</div>\r\n                            <p className=\"text-xs text-muted-foreground\">Past 7 days</p>\r\n                        </CardContent>\r\n                    </Card>\r\n                    <Card>\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium\">New Users (Monthly)</CardTitle>\r\n                            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold\">+{newMonthly}</div>\r\n                            <p className=\"text-xs text-muted-foreground\">Past 30 days</p>\r\n                        </CardContent>\r\n                    </Card>\r\n                    <Card>\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium\">New Users (Yearly)</CardTitle>\r\n                            <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold\">+{newYearly}</div>\r\n                            <p className=\"text-xs text-muted-foreground\">Past year</p>\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* Charts */}\r\n                <AdminCharts registrationData={registrationData} roleData={roleData} />\r\n\r\n                <div className=\"bg-white dark:bg-card rounded-lg shadow p-6 mb-6\">\r\n                    <h2 className=\"text-xl font-semibold mb-4\">Actions</h2>\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <BirthdayTrigger />\r\n                        <BroadcastPanel />\r\n                        <Link href=\"/admin/analytics\" className=\"col-span-1 md:col-span-2\">\r\n                            <Button variant=\"outline\" className=\"w-full h-24 flex flex-col gap-2 items-center justify-center border-dashed border-2 hover:border-solid hover:bg-muted/50\">\r\n                                <BarChart2 className=\"h-8 w-8 text-blue-600\" />\r\n                                <div className=\"text-lg font-semibold\">Analytics Dashboard</div>\r\n                                <span className=\"text-xs text-muted-foreground\">View platform growth and user trends</span>\r\n                            </Button>\r\n                        </Link>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"bg-white dark:bg-card rounded-lg shadow p-6 mb-6\">\r\n                    <h2 className=\"text-xl font-semibold mb-4\">User Management</h2>\r\n                    <UserList users={allUsers} />\r\n                </div>\r\n\r\n                <div className=\"bg-white dark:bg-card rounded-lg shadow p-6\">\r\n                    <h2 className=\"text-xl font-semibold mb-4\">Audit Logs</h2>\r\n                    <AuditLogViewer />\r\n                </div>\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\api\\admin\\migrate\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'errorsCount' is assigned a value but never used.","line":21,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1025,1028],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1025,1028],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3019,3022],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3019,3022],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { NextResponse } from \"next/server\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function GET() {\r\n    try {\r\n        // 1. Security Check\r\n        const currentUser = await getUserProfile();\r\n        if (!currentUser || currentUser.role !== 'admin') {\r\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n        }\r\n\r\n        console.log(\"[Migration] Starting Global Family Member Removal...\");\r\n\r\n        // 2. Fetch all users\r\n        const usersSnap = await adminDb.collection(\"users\").get();\r\n        let migratedCount = 0;\r\n        let errorsCount = 0;\r\n\r\n        let batch = adminDb.batch();\r\n        let batchSize = 0;\r\n        const MAX_BATCH_SIZE = 450; // Firestore limit is 500\r\n\r\n        // 3. Iterate and Update\r\n        for (const doc of usersSnap.docs) {\r\n            const data = doc.data();\r\n            let needsUpdate = false;\r\n            const updates: any = {};\r\n\r\n            // CHECK 1: Remove \"Family Member\" display name\r\n            if (data.displayName === \"Family Member\") {\r\n                // Check if we can derive a better name from profile\r\n                if (data.profileData?.firstName) {\r\n                    updates.displayName = `${data.profileData.firstName} ${data.profileData.lastName || ''}`.trim();\r\n                } else if (data.firstName) {\r\n                    updates.displayName = `${data.firstName} ${data.lastName || ''}`.trim();\r\n                } else {\r\n                    // Set to null so the strict utility takes over (returning \"Unnamed User\")\r\n                    updates.displayName = null;\r\n                }\r\n                needsUpdate = true;\r\n            }\r\n\r\n            // CHECK 2: Migrate \"family_member\" role -> \"member\"\r\n            if (data.role === \"family_member\") {\r\n                updates.role = \"member\";\r\n                needsUpdate = true;\r\n            }\r\n\r\n            // CHECK 3: Ensure no \"Family Member\" string in role (just in case)\r\n            if (data.role === \"Family Member\") {\r\n                updates.role = \"member\";\r\n                needsUpdate = true;\r\n            }\r\n\r\n            if (needsUpdate) {\r\n                batch.update(doc.ref, updates);\r\n                batchSize++;\r\n                migratedCount++;\r\n\r\n                // Commit batch if full\r\n                if (batchSize >= MAX_BATCH_SIZE) {\r\n                    await batch.commit();\r\n                    batchSize = 0;\r\n                    batch = adminDb.batch(); // Create new batch\r\n                }\r\n            }\r\n        }\r\n\r\n        // Commit remaining\r\n        if (batchSize > 0) {\r\n            await batch.commit();\r\n        }\r\n\r\n        console.log(`[Migration] Complete. Migrated ${migratedCount} users.`);\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            migrated: migratedCount,\r\n            totalScanned: usersSnap.size\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error(\"[Migration] Failed:\", error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\api\\ai\\chat\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\api\\debug\\find-user\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1002,1005],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1002,1005],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1221,1224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1221,1224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse, NextRequest } from 'next/server';\r\nimport { adminDb } from '@/lib/firebase-admin';\r\n\r\nexport async function GET(request: NextRequest) {\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const email = searchParams.get('email');\r\n\r\n    if (!email) {\r\n        return NextResponse.json({ error: 'Email parameter required' }, { status: 400 });\r\n    }\r\n\r\n    try {\r\n        console.log(`Debug API: Searching for user with email: ${email}`);\r\n        const snapshot = await adminDb.collection(\"users\").where(\"email\", \"==\", email).limit(1).get();\r\n\r\n        if (snapshot.empty) {\r\n            return NextResponse.json({ success: false, message: 'User not found' });\r\n        }\r\n\r\n        const doc = snapshot.docs[0];\r\n        return NextResponse.json({\r\n            success: true,\r\n            user: {\r\n                id: doc.id,\r\n                ...doc.data(),\r\n                // Convert timestamp to string if present\r\n                createdAt: (doc.data().createdAt as any)?.toDate?.() || doc.data().createdAt\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error('Debug API search error:', error);\r\n        return NextResponse.json({ success: false, error: (error as any).message }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\api\\debug\\user\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[544,547],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[544,547],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse, NextRequest } from 'next/server';\r\nimport { getUserAnalyticsSimple } from '@/app/actions/user-analytics';\r\n\r\nexport async function GET(request: NextRequest, context: { params: Promise<{ id: string }> }) {\r\n    try {\r\n        const { id } = await context.params;\r\n        const data = await getUserAnalyticsSimple(id);\r\n        return NextResponse.json({ success: true, data });\r\n    } catch (error) {\r\n        console.error('Debug API error:', error);\r\n        return NextResponse.json({ success: false, error: (error as any).message }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\api\\tavily-search\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1805,1808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1805,1808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const { query, maxResults = 5 } = await req.json();\r\n\r\n        if (!query) {\r\n            return NextResponse.json(\r\n                { error: 'Query is required' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const apiKey = process.env.TAVILY_API_KEY;\r\n        if (!apiKey) {\r\n            console.error('[Tavily] API key not configured');\r\n            return NextResponse.json(\r\n                { error: 'Tavily API not configured' },\r\n                { status: 500 }\r\n            );\r\n        }\r\n\r\n        console.log(`[Tavily] Searching for: \"${query}\"`);\r\n\r\n        const response = await fetch('https://api.tavily.com/search', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({\r\n                api_key: apiKey,\r\n                query: query,\r\n                max_results: maxResults,\r\n                include_answer: true,\r\n                search_depth: 'advanced',\r\n            }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('[Tavily] API error:', response.status, errorText);\r\n            return NextResponse.json(\r\n                { error: 'Search failed', details: errorText },\r\n                { status: response.status }\r\n            );\r\n        }\r\n\r\n        const data = await response.json();\r\n\r\n        console.log(`[Tavily] Found ${data.results?.length || 0} results`);\r\n\r\n        return NextResponse.json({\r\n            answer: data.answer,\r\n            results: data.results,\r\n            query: data.query,\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error('[Tavily] Search error:', error);\r\n        return NextResponse.json(\r\n            { error: 'Search failed', details: error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\api\\transcribe\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2093,2096],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2093,2096],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport OpenAI from 'openai';\r\n\r\n// Initialize OpenAI client lazily to avoid build-time errors if env vars are missing\r\nconst getOpenAIClient = () => {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n        throw new Error(\"OPENAI_API_KEY is not set\");\r\n    }\r\n    return new OpenAI({ apiKey });\r\n};\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const formData = await req.formData();\r\n        const audioFile = formData.get('audio') as File;\r\n\r\n        if (!audioFile) {\r\n            return NextResponse.json(\r\n                { error: 'No audio file provided' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Validate file type\r\n        const allowedTypes = ['audio/webm', 'audio/mp4', 'audio/mpeg', 'audio/wav', 'audio/ogg'];\r\n        if (!allowedTypes.includes(audioFile.type)) {\r\n            return NextResponse.json(\r\n                { error: 'Invalid audio format. Supported: webm, mp4, mpeg, wav, ogg' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Validate file size (max 25MB)\r\n        if (audioFile.size > 25 * 1024 * 1024) {\r\n            return NextResponse.json(\r\n                { error: 'File too large. Maximum size is 25MB' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        console.log('[Whisper] Transcribing audio:', {\r\n            filename: audioFile.name,\r\n            type: audioFile.type,\r\n            size: audioFile.size,\r\n        });\r\n\r\n        // Transcribe using Whisper\r\n        const openai = getOpenAIClient();\r\n        const transcription = await openai.audio.transcriptions.create({\r\n            file: audioFile,\r\n            model: 'whisper-1',\r\n            language: 'en', // Auto-detect if omitted\r\n            response_format: 'json',\r\n        });\r\n\r\n        console.log('[Whisper] Transcription complete:', transcription.text);\r\n\r\n        return NextResponse.json({\r\n            text: transcription.text,\r\n            language: 'en',\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error('[Whisper] Transcription error:', error);\r\n\r\n        return NextResponse.json(\r\n            {\r\n                error: 'Transcription failed',\r\n                details: error.message\r\n            },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\api\\tts\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1340,1343],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1340,1343],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1677,1680],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1677,1680],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport OpenAI from 'openai';\r\n\r\n// Initialize OpenAI client lazily to avoid build-time errors if env vars are missing\r\nconst getOpenAIClient = () => {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n        throw new Error(\"OPENAI_API_KEY is not set\");\r\n    }\r\n    return new OpenAI({ apiKey });\r\n};\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const { text, voice = 'alloy' } = await req.json();\r\n\r\n        if (!text) {\r\n            return NextResponse.json(\r\n                { error: 'No text provided' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Validate voice\r\n        const validVoices = ['alloy', 'echo', 'fable', 'onyx', 'nova', 'shimmer'];\r\n        if (!validVoices.includes(voice)) {\r\n            return NextResponse.json(\r\n                { error: `Invalid voice. Choose from: ${validVoices.join(', ')}` },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        console.log('[TTS] Generating speech:', { voice, textLength: text.length });\r\n\r\n        // Generate speech with OpenAI TTS\r\n        const openai = getOpenAIClient();\r\n        const mp3 = await openai.audio.speech.create({\r\n            model: 'tts-1', // Use tts-1-hd for higher quality\r\n            voice: voice as any,\r\n            input: text,\r\n        });\r\n\r\n        const buffer = Buffer.from(await mp3.arrayBuffer());\r\n\r\n        return new NextResponse(buffer, {\r\n            headers: {\r\n                'Content-Type': 'audio/mpeg',\r\n                'Content-Length': buffer.length.toString(),\r\n            },\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error('[TTS] Generation error:', error);\r\n\r\n        return NextResponse.json(\r\n            {\r\n                error: 'TTS generation failed',\r\n                details: error.message\r\n            },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\branding\\[brandingId]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\branding\\[brandingId]\\post\\[postId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getBrandingPost' is defined but never used.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getBrandingPost"},"fix":{"range":[9,25],"text":""},"desc":"Remove unused variable \"getBrandingPost\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[283,331],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isUrlVideo' is defined but never used.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"isUrlVideo"},"fix":{"range":[418,429],"text":""},"desc":"Remove unused variable \"isUrlVideo\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'searchParams' is defined but never used.","line":21,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'parent' is defined but never used.","line":22,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'videoTitle' is assigned a value but never used.","line":58,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getBrandingPost, getBranding } from \"@/app/actions/branding\";\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { PostCard } from \"@/components/feed/post-card\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { notFound } from \"next/navigation\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport Link from \"next/link\";\r\nimport { ArrowLeft } from \"lucide-react\";\r\n\r\nimport { isUrlVideo, extractYouTubeId, fetchYouTubeTitle } from \"@/lib/media-utils\";\r\nimport { Metadata, ResolvingMetadata } from \"next\";\r\n\r\ntype Props = {\r\n    params: Promise<{ brandingId: string; postId: string }>\r\n    searchParams: Promise<{ [key: string]: string | string[] | undefined }>\r\n}\r\n\r\nimport { generateContentMetadata } from \"@/lib/metadata\";\r\n\r\nexport async function generateMetadata(\r\n    { params, searchParams }: Props,\r\n    parent: ResolvingMetadata\r\n): Promise<Metadata> {\r\n    const { brandingId, postId } = await params;\r\n\r\n    // Dynamically import or just hope it's tree-shaken well, but better to use import like in component or static import.\r\n    // The component used dynamic import: const { getBrandingPost } = await import(\"@/app/actions/branding\");\r\n    // I can do the same.\r\n    const { getBrandingPost } = await import(\"@/app/actions/branding\");\r\n\r\n    let post = null;\r\n    try {\r\n        post = await getBrandingPost(brandingId, postId);\r\n    } catch (e) { console.error(e); }\r\n\r\n    if (!post) {\r\n        return {\r\n            title: 'Post Unavailable | Famio',\r\n            description: 'This content is private or does not exist.'\r\n        };\r\n    }\r\n\r\n    const baseUrl = process.env.NEXT_PUBLIC_SITE_URL\r\n        || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : null)\r\n        || 'https://we-are-family-221.web.app';\r\n\r\n    const postUrl = `${baseUrl}/branding/${brandingId}/post/${postId}`;\r\n\r\n    // Check for YouTube URL in post content\r\n    const youtubeUrlMatch = post.content?.match(/https?:\\/\\/(www\\.)?(youtube\\.com|youtu\\.be)\\/\\S+/gi);\r\n    const youtubeUrl = youtubeUrlMatch ? youtubeUrlMatch[0].replace(/[\\s.,!?;:]+$/, '').trim() : null;\r\n\r\n    // Fetch YouTube Title if available\r\n    let videoTitle = null;\r\n    if (youtubeUrl) {\r\n        const yId = extractYouTubeId(youtubeUrl);\r\n        if (yId) {\r\n            videoTitle = await fetchYouTubeTitle(yId);\r\n        }\r\n    }\r\n    return generateContentMetadata(post, postUrl);\r\n}\r\n\r\nexport default async function BrandingPostPage({ params }: { params: Promise<{ brandingId: string; postId: string }> }) {\r\n    const { brandingId, postId } = await params;\r\n    const branding = await getBranding(brandingId);\r\n\r\n    const { getBrandingPost } = await import(\"@/app/actions/branding\");\r\n    const post = await getBrandingPost(brandingId, postId);\r\n\r\n    if (!post || !branding) return notFound();\r\n\r\n    const user = await getUserProfile();\r\n\r\n    return (\r\n        <MainLayout>\r\n            <div className=\"max-w-2xl mx-auto py-8\">\r\n                <Link href={`/branding/${brandingId}`} className=\"inline-flex items-center text-sm text-muted-foreground hover:text-primary mb-4\">\r\n                    <ArrowLeft className=\"mr-1 w-4 h-4\" />\r\n                    Back to {branding.name}\r\n                </Link>\r\n                <PostCard post={post} currentUserId={user?.id} />\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\branding\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\chat\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\embed\\post\\[postId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Play' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Play"},"fix":{"range":[103,139],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Head' is defined but never used.","line":4,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Head"},"fix":{"range":[141,170],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":29,"column":50,"nodeType":"JSXOpeningElement","endLine":29,"endColumn":117},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"img elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":29,"column":50,"nodeType":"JSXOpeningElement","endLine":29,"endColumn":117},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":53,"column":17,"nodeType":"JSXOpeningElement","endLine":53,"endColumn":102}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getPostGlobal } from \"@/app/actions/posts\";\r\nimport { isUrlVideo } from \"@/lib/media-utils\";\r\nimport { Play } from \"lucide-react\";\r\nimport Head from \"next/head\";\r\n\r\n// Allow standalone embedding\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function EmbedPostPage({ params }: { params: Promise<{ postId: string }> }) {\r\n    const { postId } = await params;\r\n    const post = await getPostGlobal(postId);\r\n\r\n    if (!post || post.engagementSettings?.privacy === 'private') {\r\n        return (\r\n            <div className=\"flex items-center justify-center w-screen h-screen bg-black text-white p-4 text-center\">\r\n                <p>Content is unavailable or private.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const firstMedia = post.mediaUrls?.[0];\r\n    if (!firstMedia) {\r\n        // Text post embed?\r\n        return (\r\n            <div className=\"flex flex-col items-center justify-center w-screen h-screen bg-white text-black p-4 text-center font-sans\">\r\n                <div className=\"max-w-md\">\r\n                    <p className=\"text-xl font-medium mb-4\">\"{post.content}\"</p>\r\n                    <div className=\"flex items-center justify-center gap-2\">\r\n                        {post.author.imageUrl && <img src={post.author.imageUrl} className=\"w-8 h-8 rounded-full\" />}\r\n                        <span className=\"font-bold\">{post.author.displayName}</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const isVideo = isUrlVideo(firstMedia);\r\n\r\n    return (\r\n        <div className=\"w-screen h-screen bg-black overflow-hidden flex items-center justify-center relative group\">\r\n            {isVideo ? (\r\n                <video\r\n                    src={firstMedia}\r\n                    className=\"w-full h-full object-contain\"\r\n                    controls\r\n                    autoPlay\r\n                    muted\r\n                    playsInline\r\n                    loop\r\n                    poster={post.mediaUrls?.[1] || undefined} // Fallback if 2nd media is thumbnail? Unlikely.\r\n                />\r\n            ) : (\r\n                <img src={firstMedia} className=\"w-full h-full object-contain\" alt=\"Famio Content\" />\r\n            )}\r\n\r\n            {/* Overlay branding */}\r\n            <a href=\"https://famio.us\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"absolute bottom-4 right-4 bg-black/50 text-white px-2 py-1 rounded text-xs font-bold hover:bg-black/70 transition-colors z-10\">\r\n                Famio\r\n            </a>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\events\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\family\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\gallery\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MainLayout' is defined but never used.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":20,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"MainLayout"},"fix":{"range":[0,61],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":31,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1453,1456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1453,1456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1532,1535],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1532,1535],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1921,1924],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1921,1924],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\nimport { GalleryView } from \"@/components/gallery/gallery-view\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function GalleryPage() {\r\n    const user = await getUserProfile();\r\n    if (!user || user.role === 'pending') {\r\n        redirect(\"/\");\r\n    }\r\n\r\n    const { getFamilyMemberIds } = await import(\"@/app/actions/family\");\r\n    const familyIds = await getFamilyMemberIds(user.id);\r\n    const allowedIds = [user.id, ...familyIds];\r\n    const queryIds = allowedIds.slice(0, 30); // Limit to 30 for Firestore 'in' query\r\n\r\n    if (queryIds.length === 0) {\r\n        return <GalleryView mediaItems={[]} currentUserId={user.id} />;\r\n    }\r\n\r\n    let postsSnapshot;\r\n    try {\r\n        postsSnapshot = await adminDb.collection(\"posts\")\r\n            .where(\"authorId\", \"in\", queryIds)\r\n            .orderBy(\"createdAt\", \"desc\")\r\n            .get();\r\n    } catch (e) {\r\n        console.log(\"Gallery index missing, falling back to unordered query\");\r\n        postsSnapshot = await adminDb.collection(\"posts\")\r\n            .where(\"authorId\", \"in\", queryIds)\r\n            .get();\r\n        // We will sort in memory below\r\n    }\r\n\r\n    const allPosts = postsSnapshot.docs.map((doc: any) => sanitizeData({\r\n        id: doc.id,\r\n        ...doc.data()\r\n    })) as any[];\r\n\r\n    // Sort in memory to handle fallback case\r\n    allPosts.sort((a, b) => {\r\n        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);\r\n        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);\r\n        return dateB.getTime() - dateA.getTime();\r\n    });\r\n\r\n    const mediaItems = allPosts.flatMap((post: any) =>\r\n        (post.mediaUrls || []).map((url: string) => ({\r\n            url,\r\n            postId: post.id,\r\n            authorId: post.authorId\r\n        }))\r\n    );\r\n\r\n    return (\r\n        <GalleryView\r\n            mediaItems={mediaItems}\r\n            currentUserId={user.id}\r\n        />\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\groups\\[groupId]\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":54,"column":25,"nodeType":"JSXOpeningElement","endLine":58,"endColumn":27},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":61,"column":21,"nodeType":"JSXOpeningElement","endLine":65,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getGroup, getGroupMemberStatus } from \"@/app/actions/groups\";\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { notFound } from \"next/navigation\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Users, Lock, Globe, ArrowLeft, Trash2 } from \"lucide-react\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { JoinGroupButton } from \"@/components/groups/join-group-button\";\r\nimport { GroupAITutorBanner } from \"@/components/groups/group-ai-tutor-banner\";\r\nimport { GroupManagementDialog } from \"@/components/groups/group-management-dialog\";\r\nimport { ShareButton } from \"@/components/shared/share-button\";\r\n\r\nimport { GroupFeed } from \"@/components/groups/group-feed\";\r\nimport Link from \"next/link\";\r\n\r\nexport default async function GroupPage({ params }: { params: Promise<{ groupId: string }> }) {\r\n    const { groupId } = await params;\r\n    const group = await getGroup(groupId);\r\n    if (!group) return notFound();\r\n\r\n    const user = await getUserProfile();\r\n    // Use group.id (resolved) instead of params.groupId (potential slug)\r\n    const memberStatus = await getGroupMemberStatus(group.id);\r\n    const isMember = !!memberStatus;\r\n\r\n\r\n    // If private and not member, check if we can see anything?\r\n    // Usually show basic info and join button.\r\n    const canViewContent = group.privacy === 'public' || isMember;\r\n\r\n    return (\r\n        <MainLayout>\r\n            {/* Back Button */}\r\n            <Link href=\"/\">\r\n                <Button variant=\"ghost\" size=\"sm\" className=\"mb-4\">\r\n                    <ArrowLeft className=\"w-4 h-4 mr-2\" />\r\n                    Back to Home\r\n                </Button>\r\n            </Link>\r\n\r\n            {/* Group Header */}\r\n            <div className=\"relative h-64 w-full rounded-b-xl overflow-hidden mb-8\">\r\n                {group.coverUrl ? (\r\n                    group.coverUrl.includes('mp4') || group.coverUrl.includes('webm') ? (\r\n                        <video\r\n                            src={group.coverUrl}\r\n                            className=\"w-full h-full object-cover\"\r\n                            autoPlay\r\n                            loop\r\n                            muted\r\n                            playsInline\r\n                        />\r\n                    ) : (\r\n                        <img\r\n                            src={group.coverUrl}\r\n                            alt=\"Cover\"\r\n                            className=\"w-full h-full object-cover\"\r\n                        />\r\n                    )\r\n                ) : group.imageUrl ? (\r\n                    <img\r\n                        src={group.imageUrl}\r\n                        alt={group.name}\r\n                        className=\"w-full h-full object-cover\"\r\n                    />\r\n                ) : (\r\n                    <div className=\"w-full h-full bg-gradient-to-r from-blue-600 to-purple-600\" />\r\n                )}\r\n\r\n                <div className=\"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-6 pt-24 text-white\">\r\n                    <div className=\"flex items-end justify-between\">\r\n                        <div>\r\n                            <div className=\"flex items-center gap-2 text-sm font-medium opacity-90 mb-1\">\r\n                                {group.privacy === 'private' ? <Lock className=\"w-4 h-4\" /> : <Globe className=\"w-4 h-4\" />}\r\n                                <span className=\"capitalize\">{group.privacy} Group</span>\r\n                                <span>‚Ä¢</span>\r\n                                <span className=\"capitalize\">{group.category}</span>\r\n                            </div>\r\n                            <h1 className=\"text-4xl font-bold\">{group.name}</h1>\r\n                            <p className=\"mt-2 max-w-2xl opacity-90\">{group.description}</p>\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center gap-3\">\r\n                            {/* Management Dialog for Admins/Founders */}\r\n                            {(user?.id === group.founderId || memberStatus?.role === 'admin') && user && (\r\n                                <GroupManagementDialog\r\n                                    group={group}\r\n                                    currentUser={user}\r\n                                    isAdmin={true}\r\n                                />\r\n                            )}\r\n                            {/* Join/Leave Button Client Component */}\r\n                            <JoinGroupButton\r\n                                groupId={group.id}\r\n                                isMember={isMember}\r\n                                memberCount={group.memberCount}\r\n                            />\r\n                            <ShareButton\r\n                                title={group.name}\r\n                                text={`Check out this group: ${group.name}`}\r\n                                variant=\"secondary\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Soft Delete Notice for Owner */}\r\n            {group.deletedAt && (user?.id === group.founderId) && (\r\n                <div className=\"mb-8 p-4 bg-yellow-500/10 border border-yellow-500 rounded-lg flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <Trash2 className=\"h-5 w-5 text-yellow-500\" />\r\n                        <div>\r\n                            <h4 className=\"font-semibold text-yellow-500\">This group is scheduled for deletion</h4>\r\n                            <p className=\"text-sm text-yellow-500/90\">\r\n                                It is currently hidden from the public. It will be permanently deleted on {group.scheduledPermanentDeleteAt?.toDate().toLocaleDateString()}.\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n                <div className=\"lg:col-span-2 space-y-6\">\r\n                    {canViewContent ? (\r\n                        <>\r\n                            {/* AI Tutor Banner for School Groups */}\r\n                            {(group.name.toLowerCase().includes('school') || group.name.toLowerCase().includes('homework') || group.category.toLowerCase() === 'education') && (\r\n                                <GroupAITutorBanner />\r\n                            )}\r\n\r\n                            <GroupFeed groupId={group.id} currentUser={user} />\r\n                        </>\r\n                    ) : (\r\n\r\n                        <div className=\"text-center py-12 bg-muted/30 rounded-lg border border-dashed\">\r\n                            <Lock className=\"w-12 h-12 mx-auto text-muted-foreground mb-4\" />\r\n                            <h3 className=\"text-xl font-medium mb-2\">This group is private</h3>\r\n                            <p className=\"text-muted-foreground\">Join this group to view posts and participate in the discussion.</p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"space-y-6\">\r\n                    <Card className=\"p-4\">\r\n                        <h3 className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                            <Users className=\"w-4 h-4\" />\r\n                            About\r\n                        </h3>\r\n                        <div className=\"space-y-4 text-sm\">\r\n                            <div className=\"flex justify-between py-2 border-b\">\r\n                                <span className=\"text-muted-foreground\">Created</span>\r\n                                <span>{group.createdAt.toLocaleDateString()}</span>\r\n                            </div>\r\n                            <div className=\"flex justify-between py-2 border-b\">\r\n                                <span className=\"text-muted-foreground\">Members</span>\r\n                                <span>{group.memberCount || 1}</span>\r\n                            </div>\r\n                            <div className=\"flex justify-between py-2 border-b\">\r\n                                <span className=\"text-muted-foreground\">Category</span>\r\n                                <span className=\"capitalize\">{group.category}</span>\r\n                            </div>\r\n                        </div>\r\n                    </Card>\r\n                </div>\r\n            </div>\r\n\r\n        </MainLayout >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\groups\\[groupId]\\post\\[postId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getGroupPost' is defined but never used.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getGroupPost"},"fix":{"range":[9,22],"text":""},"desc":"Remove unused variable \"getGroupPost\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[275,323],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isUrlVideo' is defined but never used.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"isUrlVideo"},"fix":{"range":[410,421],"text":""},"desc":"Remove unused variable \"isUrlVideo\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'extractYouTubeId' is defined but never used.","line":10,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"extractYouTubeId"},"fix":{"range":[420,438],"text":""},"desc":"Remove unused variable \"extractYouTubeId\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'fetchYouTubeTitle' is defined but never used.","line":10,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":57,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"fetchYouTubeTitle"},"fix":{"range":[401,485],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'searchParams' is defined but never used.","line":21,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'parent' is defined but never used.","line":22,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getGroupPost, getGroup } from \"@/app/actions/groups\";\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { PostCard } from \"@/components/feed/post-card\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { notFound } from \"next/navigation\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport Link from \"next/link\";\r\nimport { ArrowLeft } from \"lucide-react\";\r\n\r\nimport { isUrlVideo, extractYouTubeId, fetchYouTubeTitle } from \"@/lib/media-utils\";\r\nimport { Metadata, ResolvingMetadata } from \"next\";\r\n\r\ntype Props = {\r\n    params: Promise<{ groupId: string; postId: string }>\r\n    searchParams: Promise<{ [key: string]: string | string[] | undefined }>\r\n}\r\n\r\nimport { generateContentMetadata } from \"@/lib/metadata\";\r\n\r\nexport async function generateMetadata(\r\n    { params, searchParams }: Props,\r\n    parent: ResolvingMetadata\r\n): Promise<Metadata> {\r\n    const { groupId, postId } = await params;\r\n\r\n    // We can use getGroupPost if we exported it, OR getPostGlobal if permission allows, \r\n    // OR the inline logic we saw before. \r\n    // The previous code used 'getGroupPost' but caught error.\r\n\r\n    // Let's use getGroupPost safely.\r\n    const { getGroupPost } = await import(\"@/app/actions/groups\");\r\n    let post = null;\r\n    try {\r\n        post = await getGroupPost(groupId, postId);\r\n    } catch (e) { console.error(e); }\r\n\r\n    if (!post) {\r\n        return {\r\n            title: 'Post Unavailable | Famio',\r\n            description: 'This content is private or does not exist.'\r\n        };\r\n    }\r\n\r\n    const baseUrl = process.env.NEXT_PUBLIC_SITE_URL\r\n        || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : null)\r\n        || 'https://we-are-family-221.web.app';\r\n\r\n    const postUrl = `${baseUrl}/groups/${groupId}/post/${postId}`;\r\n\r\n    // Use Shared Logic\r\n    return generateContentMetadata(post, postUrl);\r\n}\r\n\r\nexport default async function GroupPostPage({ params }: { params: Promise<{ groupId: string; postId: string }> }) {\r\n    const { groupId, postId } = await params;\r\n    const group = await getGroup(groupId);\r\n    // Note: getGroupPost might need to be created if not exists, \r\n    // BUT we can usually just 'getGroupPosts' and find it, or simpler: use a direct fetch helper.\r\n    // Let's assume we need to add 'getGroupPost' single fetcher or reuse getPostGlobal logic implicitly?\r\n    // Actually, let's look at actions/groups.ts - we don't have getGroupPost (single).\r\n    // I'll add a quick fetch here or add to actions. Adding to actions is cleaner.\r\n\r\n    // TEMPORARY: Adding inline fetch logic for speed, then refactor to action if needed.\r\n    // Actually, I can use the 'toggleReaction's helper logic but for reading.\r\n\r\n    // Better: let's import the NEW getPostGlobal I just made? \r\n    // getPostGlobal currently only checks main feed.\r\n\r\n    // Let's add 'getGroupPost' to actions/groups.ts quickly.\r\n    // For now, I will error if action not ready.\r\n    // Wait, I can just use getPostGlobal if I update it?\r\n    // No, creating specific page means I know the context.\r\n\r\n    // Let's implement getting the post.\r\n    const { getGroupPost } = await import(\"@/app/actions/groups\");\r\n    const post = await getGroupPost(groupId, postId);\r\n\r\n    if (!post || !group) return notFound();\r\n\r\n    const user = await getUserProfile();\r\n\r\n    return (\r\n        <MainLayout>\r\n            <div className=\"max-w-2xl mx-auto py-8\">\r\n                <Link href={`/groups/${groupId}`} className=\"inline-flex items-center text-sm text-muted-foreground hover:text-primary mb-4\">\r\n                    <ArrowLeft className=\"mr-1 w-4 h-4\" />\r\n                    Back to {group.name}\r\n                </Link>\r\n                <PostCard post={post} currentUserId={user?.id} />\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\groups\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used.","line":18,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Users"},"fix":{"range":[475,512],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getGroups } from \"@/app/actions/groups\";\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { GroupsView } from \"@/components/groups/groups-view\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function GroupsPage() {\r\n    const groups = await getGroups();\r\n\r\n    return (\r\n        <MainLayout>\r\n            <GroupsView groups={groups} />\r\n        </MainLayout>\r\n    );\r\n}\r\n\r\n// Need to import Users icon for the empty state\r\nimport { Users } from \"lucide-react\";\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CallOverlay' is defined but never used.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":21,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"CallOverlay"},"fix":{"range":[400,460],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata } from \"next\";\nimport { Inter } from \"next/font/google\";\nimport { AuthProvider } from \"@/components/auth-provider\";\nimport { Toaster } from \"@/components/ui/sonner\";\nimport \"./globals.css\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { LanguageProvider } from \"@/components/language-context\";\nimport { AIAssistant } from \"@/components/ai/ai-assistant\";\nimport { CallOverlay } from \"@/components/rtc/call-overlay\";\nimport { MessageNotificationProvider } from \"@/components/messages/message-notification-provider\";\n\nconst inter = Inter({\n  subsets: [\"latin\"],\n  variable: \"--font-inter\",\n});\n\nexport const metadata: Metadata = {\n  title: \"Famio - Connect with Your Family and Friends\",\n  description: \"A private, AI-powered social platform for families. Share moments, plan events, and stay connected.\",\n};\n\n\n\nexport default function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  return (\n    <AuthProvider>\n      <html lang=\"en\" suppressHydrationWarning>\n        <body\n          className={`${inter.variable} antialiased min-h-screen bg-background text-foreground font-sans`}\n          suppressHydrationWarning\n        >\n          <ThemeProvider\n            attribute=\"class\"\n            defaultTheme=\"dark\"\n            enableSystem\n            disableTransitionOnChange\n          >\n            <LanguageProvider>\n              <MessageNotificationProvider>\n                {children}\n                <Toaster />\n                {/* <CallOverlay /> */}\n                <AIAssistant />\n              </MessageNotificationProvider>\n            </LanguageProvider>\n          </ThemeProvider>\n        </body>\n      </html>\n    </AuthProvider>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\learn-more\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\live\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\live\\broadcast\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[885,888],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[885,888],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { startSession } from \"@/app/actions/rtc\"\r\nimport { BroadcastView } from \"@/components/rtc/broadcast-view\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Video, Loader2, ArrowLeft } from \"lucide-react\"\r\nimport { toast } from \"sonner\"\r\nimport Link from \"next/link\"\r\n\r\nexport default function BroadcastPage() {\r\n    const router = useRouter()\r\n    const [sessionId, setSessionId] = useState<string | null>(null)\r\n    const [isStarting, setIsStarting] = useState(false)\r\n\r\n    const handleStartBroadcast = async () => {\r\n        setIsStarting(true)\r\n        try {\r\n            const result = await startSession(\"broadcast\")\r\n            setSessionId(result.sessionId)\r\n        } catch (error: any) {\r\n            toast.error(error.message || \"Failed to start broadcast\")\r\n            setIsStarting(false)\r\n        }\r\n    }\r\n\r\n    const handleEndBroadcast = () => {\r\n        setSessionId(null)\r\n        router.push(\"/live\")\r\n    }\r\n\r\n    if (sessionId) {\r\n        return (\r\n            <div className=\"container mx-auto p-6 max-w-4xl\">\r\n                <BroadcastView sessionId={sessionId} onEnd={handleEndBroadcast} />\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"container mx-auto p-6 max-w-2xl\">\r\n            <div className=\"mb-4\">\r\n                <Link href=\"/live\">\r\n                    <Button variant=\"ghost\" size=\"sm\" className=\"gap-2\">\r\n                        <ArrowLeft className=\"h-4 w-4\" />\r\n                        Back to Live\r\n                    </Button>\r\n                </Link>\r\n            </div>\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"text-center text-2xl\">Start Your Broadcast</CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"flex flex-col items-center gap-6 py-8\">\r\n                    <div className=\"w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center\">\r\n                        <Video className=\"h-12 w-12 text-primary\" />\r\n                    </div>\r\n                    <div className=\"text-center max-w-md\">\r\n                        <h3 className=\"font-semibold text-lg mb-2\">Go Live with Your Family</h3>\r\n                        <p className=\"text-muted-foreground text-sm\">\r\n                            Share special moments in real-time. Your members will be able to watch and connect with you instantly.\r\n                        </p>\r\n                    </div>\r\n                    <div className=\"bg-muted/50 p-4 rounded-lg max-w-md\">\r\n                        <p className=\"text-sm text-muted-foreground\">\r\n                            <strong>Note:</strong> For best performance, we recommend having no more than 5-10 viewers at once. Make sure you have a stable internet connection.\r\n                        </p>\r\n                    </div>\r\n                    <Button\r\n                        size=\"lg\"\r\n                        onClick={handleStartBroadcast}\r\n                        disabled={isStarting}\r\n                        className=\"gap-2 px-8\"\r\n                    >\r\n                        {isStarting ? (\r\n                            <>\r\n                                <Loader2 className=\"h-5 w-5 animate-spin\" />\r\n                                Starting...\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <Video className=\"h-5 w-5\" />\r\n                                Start Broadcasting\r\n                            </>\r\n                        )}\r\n                    </Button>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\live\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[353,356],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[353,356],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[486,489],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[486,489],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getActiveBroadcasts } from \"@/app/actions/rtc\";\r\nimport { LiveView } from \"@/components/live/live-view\";\r\n\r\n// Force dynamic rendering to avoid build-time Firestore index requirement\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// Live broadcasts page - deployed 2026-01-04 03:40\r\nexport default async function LivePage() {\r\n    let broadcasts: any[] = [];\r\n    let error: string | null = null;\r\n\r\n    try {\r\n        broadcasts = await getActiveBroadcasts();\r\n    } catch (err: any) {\r\n        console.error(\"Error loading broadcasts:\", err);\r\n        error = err.message;\r\n    }\r\n\r\n    return <LiveView broadcasts={broadcasts} error={error} />;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1052,1055],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1052,1055],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2556,2559],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2556,2559],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3706,3709],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3706,3709],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5363,5366],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5363,5366],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from \"firebase/auth\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { toast } from \"sonner\"\r\nimport Link from \"next/link\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Loader2, Heart } from \"lucide-react\"\r\nimport \"@/lib/firebase\"\r\n\r\nimport { createSession, syncUserToDb } from \"@/app/actions/auth\";\r\n\r\nexport default function LoginPage() {\r\n    const [email, setEmail] = useState(\"\")\r\n    const [password, setPassword] = useState(\"\")\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const router = useRouter()\r\n\r\n    const [needsVerification, setNeedsVerification] = useState(false)\r\n    const [unverifiedUser, setUnverifiedUser] = useState<any>(null)\r\n    const [resendCooldown, setResendCooldown] = useState(0)\r\n\r\n    const handleEmailLogin = async (e: React.FormEvent) => {\r\n        e.preventDefault()\r\n        setIsLoading(true)\r\n        try {\r\n            const auth = getAuth()\r\n            const { setPersistence, browserLocalPersistence } = await import(\"firebase/auth\");\r\n            await setPersistence(auth, browserLocalPersistence);\r\n            const userCredential = await signInWithEmailAndPassword(auth, email, password)\r\n            const user = userCredential.user\r\n\r\n            if (!user.emailVerified) {\r\n                setUnverifiedUser(user)\r\n                setNeedsVerification(true)\r\n                return;\r\n            }\r\n\r\n            console.log(\"User authenticated, syncing to database...\")\r\n            // Sync user (existing users might have empty profileData, that's fine)\r\n            // Split display name into first/last for fallback\r\n            const nameParts = (user.displayName || \"\").split(' ');\r\n            const firstName = nameParts[0] || \"Famio\";\r\n            const lastName = nameParts.slice(1).join(' ') || \"Member\";\r\n\r\n            await syncUserToDb(user.uid, user.email!, user.displayName || user.email!.split('@')[0], firstName, lastName, user.emailVerified)\r\n\r\n            console.log(\"Creating session cookie...\")\r\n            await createSession(user.uid)\r\n\r\n            toast.success(\"Welcome back!\")\r\n            router.push(\"/\")\r\n            router.refresh()\r\n        } catch (error: any) {\r\n            console.error(\"Login Critical Failure:\", error);\r\n            console.error(\"Error Code:\", error.code);\r\n            console.error(\"Error Message:\", error.message);\r\n            toast.error(`Login Failed: ${error.message} (${error.code || 'Unknown'})`);\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleResendVerification = async () => {\r\n        if (!unverifiedUser || resendCooldown > 0) return;\r\n\r\n        setIsLoading(true);\r\n        try {\r\n            const { sendEmailVerification } = await import(\"firebase/auth\");\r\n            await sendEmailVerification(unverifiedUser);\r\n            toast.success(\"Verification email sent! Please check your inbox.\");\r\n            setResendCooldown(60);\r\n\r\n            // Start cooldown timer\r\n            const interval = setInterval(() => {\r\n                setResendCooldown((prev) => {\r\n                    if (prev <= 1) {\r\n                        clearInterval(interval);\r\n                        return 0;\r\n                    }\r\n                    return prev - 1;\r\n                });\r\n            }, 1000);\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Error sending verification email:\", error);\r\n            toast.error(error.message || \"Failed to send verification email\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleBackToLogin = async () => {\r\n        const auth = getAuth();\r\n        await auth.signOut();\r\n        setNeedsVerification(false);\r\n        setUnverifiedUser(null);\r\n        setEmail(\"\");\r\n        setPassword(\"\");\r\n    };\r\n\r\n    const handleGoogleLogin = async () => {\r\n        setIsLoading(true)\r\n        try {\r\n            const auth = getAuth()\r\n            const { setPersistence, browserLocalPersistence } = await import(\"firebase/auth\");\r\n            await setPersistence(auth, browserLocalPersistence);\r\n            const provider = new GoogleAuthProvider()\r\n            const userCredential = await signInWithPopup(auth, provider)\r\n            const user = userCredential.user\r\n\r\n            // Split display name into first/last\r\n            const nameParts = (user.displayName || \"\").split(' ');\r\n            const firstName = nameParts[0] || \"\";\r\n            const lastName = nameParts.slice(1).join(' ') || \"\";\r\n\r\n            // Ensure user exists in database\r\n            await syncUserToDb(\r\n                user.uid,\r\n                user.email!,\r\n                user.displayName || user.email!.split('@')[0],\r\n                firstName,\r\n                lastName,\r\n                user.emailVerified\r\n            )\r\n            await createSession(user.uid)\r\n\r\n            toast.success(\"Welcome back!\")\r\n            router.push(\"/\")\r\n            router.refresh()\r\n        } catch (error: any) {\r\n            console.error(error)\r\n            toast.error(error.message || \"Failed to login with Google\")\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    if (needsVerification) {\r\n        return (\r\n            <div className=\"flex items-center justify-center min-h-screen bg-gradient-to-b from-blue-50 to-white py-12\">\r\n                <Card className=\"w-full max-w-md shadow-lg border-blue-100\">\r\n                    <CardHeader className=\"text-center space-y-2\">\r\n                        <div className=\"flex items-center justify-center gap-2 mb-2\">\r\n                            <Heart className=\"w-8 h-8 text-blue-600\" fill=\"currentColor\" />\r\n                            <span className=\"text-2xl font-bold text-blue-600\">Famio</span>\r\n                        </div>\r\n                        <CardTitle className=\"text-2xl font-bold text-gray-900\">Verify Your Email</CardTitle>\r\n                        <CardDescription>\r\n                            We sent a verification email to <span className=\"font-medium text-foreground\">{unverifiedUser?.email}</span>.\r\n                            <br />Please check your inbox and click the link to verify your account.\r\n                        </CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent className=\"space-y-4\">\r\n                        <div className=\"p-4 bg-amber-50 rounded-lg border border-amber-100 text-sm text-amber-800\">\r\n                            <p className=\"font-semibold mb-1\">Account requires verification</p>\r\n                            <p>You must verify your email address before you can access your account.</p>\r\n                            <p className=\"mt-1 font-medium\">Please check your Junk/Spam folder if you don't see the email.</p>\r\n                        </div>\r\n\r\n                        <Button\r\n                            className=\"w-full\"\r\n                            onClick={handleResendVerification}\r\n                            disabled={isLoading || resendCooldown > 0}\r\n                        >\r\n                            {isLoading ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : null}\r\n                            {resendCooldown > 0 ? `Resend available in ${resendCooldown}s` : \"Resend Verification Email\"}\r\n                        </Button>\r\n\r\n                        <div className=\"relative my-4\">\r\n                            <div className=\"absolute inset-0 flex items-center\">\r\n                                <Separator />\r\n                            </div>\r\n                            <div className=\"relative flex justify-center text-xs uppercase\">\r\n                                <span className=\"bg-white px-2 text-muted-foreground\">or</span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <Button variant=\"outline\" className=\"w-full\" onClick={handleBackToLogin}>\r\n                            Back to Login\r\n                        </Button>\r\n                    </CardContent>\r\n                </Card>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex items-center justify-center min-h-screen bg-gradient-to-b from-blue-50 to-white py-12 relative z-[10]\">\r\n            <Card className=\"w-full max-w-md shadow-lg border-blue-100 relative z-[50]\">\r\n                <CardHeader className=\"text-center space-y-2\">\r\n                    <div className=\"flex items-center justify-center gap-2 mb-2\">\r\n                        <Heart className=\"w-8 h-8 text-blue-600\" fill=\"currentColor\" />\r\n                        <span className=\"text-2xl font-bold text-blue-600\">Famio</span>\r\n                    </div>\r\n                    <CardTitle className=\"text-2xl font-bold text-gray-900\">Welcome Back</CardTitle>\r\n                    <CardDescription>Sign in to your account</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                    <form onSubmit={handleEmailLogin} className=\"space-y-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"email\">Email</Label>\r\n                            <Input\r\n                                id=\"email\"\r\n                                type=\"email\"\r\n                                placeholder=\"name@example.com\"\r\n                                value={email}\r\n                                onChange={(e) => setEmail(e.target.value)}\r\n                                required\r\n                                className=\"bg-gray-50 border-gray-200 focus:bg-white transition-colors\"\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"password\">Password</Label>\r\n                            <Input\r\n                                id=\"password\"\r\n                                type=\"password\"\r\n                                value={password}\r\n                                onChange={(e) => setPassword(e.target.value)}\r\n                                required\r\n                                className=\"bg-gray-50 border-gray-200 focus:bg-white transition-colors\"\r\n                            />\r\n                        </div>\r\n                        <Button type=\"submit\" className=\"w-full bg-blue-600 hover:bg-blue-700 font-semibold\" disabled={isLoading}>\r\n                            {isLoading ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : null}\r\n                            Sign In\r\n                        </Button>\r\n                    </form>\r\n\r\n                    <div className=\"relative my-6\">\r\n                        <div className=\"absolute inset-0 flex items-center\">\r\n                            <Separator />\r\n                        </div>\r\n                        <div className=\"relative flex justify-center text-xs uppercase\">\r\n                            <span className=\"bg-white px-2 text-muted-foreground\">Or continue with</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <Button variant=\"outline\" className=\"w-full border-gray-200 hover:bg-gray-50\" onClick={handleGoogleLogin} disabled={isLoading}>\r\n                        <svg className=\"mr-2 h-4 w-4\" viewBox=\"0 0 24 24\">\r\n                            <path\r\n                                d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\"\r\n                                fill=\"#4285F4\"\r\n                            />\r\n                            <path\r\n                                d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\"\r\n                                fill=\"#34A853\"\r\n                            />\r\n                            <path\r\n                                d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\"\r\n                                fill=\"#FBBC05\"\r\n                            />\r\n                            <path\r\n                                d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\"\r\n                                fill=\"#EA4335\"\r\n                            />\r\n                        </svg>\r\n                        Google\r\n                    </Button>\r\n\r\n                    <div className=\"text-center text-sm text-muted-foreground mt-6\">\r\n                        Don't have an account?{\" \"}\r\n                        <Link href=\"/signup\" className=\"text-blue-600 hover:underline font-semibold\">\r\n                            Create Account\r\n                        </Link>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            <div className=\"absolute bottom-4 left-0 right-0 text-center space-y-2 z-[50]\">\r\n                <Link href=\"/privacy\" className=\"text-xs text-muted-foreground hover:text-blue-600 font-medium transition-colors\">\r\n                    Privacy Policy\r\n                </Link>\r\n                <p className=\"text-[10px] text-muted-foreground/60\">\r\n                    Built with privacy and security at the core. ¬© ChanceTEK\r\n                </p>\r\n            </div>\r\n        </div >\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\members\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1063,1066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1063,1066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1737,1740],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1737,1740],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2406,2409],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2406,2409],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const dynamic = \"force-dynamic\";\r\n\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport Link from \"next/link\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\n\r\nexport default async function MembersDirectoryPage() {\r\n    const currentUser = await getUserProfile();\r\n    if (!currentUser) {\r\n        redirect(\"/\");\r\n    }\r\n\r\n    // Fetch members (limit 50 for now)\r\n    // We only want 'members' or 'admins', not pending? Or everyone?\r\n    // Users said \"view a directory of all members\".\r\n    const membersSnapshot = await adminDb.collection(\"users\")\r\n        .where(\"isActive\", \"==\", true) // Assuming we use this flag? If not, just remove.\r\n        .limit(50)\r\n        .get();\r\n\r\n    let members = membersSnapshot.docs.map((doc: any) => {\r\n        const data = doc.data();\r\n        return sanitizeData({\r\n            id: doc.id,\r\n            displayName: ((data.displayName && data.displayName !== \"Family Member\") ? data.displayName : null) || (data.profileData?.firstName ? `${data.profileData.firstName} ${data.profileData.lastName || ''}`.trim() : null) || data.email?.split('@')[0] || \"Unknown\",\r\n            email: data.email,\r\n            imageUrl: data.imageUrl,\r\n            role: data.role,\r\n            // Only expose public fields\r\n        });\r\n    });\r\n\r\n    // Filter out current user from display? Or keep them? Usually keep.\r\n    // Filter out pending?\r\n    members = members.filter((m: any) => m.role === 'member' || m.role === 'admin');\r\n\r\n    return (\r\n        <MainLayout>\r\n            <div className=\"mb-6\">\r\n                <h1 className=\"text-2xl font-bold tracking-tight\">Members Directory</h1>\r\n                <p className=\"text-muted-foreground\">Discover and connect with the Famio community.</p>\r\n            </div>\r\n\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle>All Members ({members.length})</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6\">\r\n                        {members.map((member: any) => (\r\n                            <Link key={member.id} href={`/u/${member.id}`} className=\"block group\">\r\n                                <div className=\"flex flex-col items-center p-6 border rounded-xl bg-card hover:border-blue-200 hover:bg-blue-50/50 dark:hover:bg-muted/50 transition-all duration-200 shadow-sm hover:shadow-md\">\r\n                                    <Avatar className=\"w-20 h-20 mb-4 border-2 border-background shadow-sm group-hover:scale-105 transition-transform\">\r\n                                        <AvatarImage src={member.imageUrl} />\r\n                                        <AvatarFallback>{member.email?.slice(0, 2).toUpperCase()}</AvatarFallback>\r\n                                    </Avatar>\r\n                                    <h3 className=\"font-semibold text-center text-foreground group-hover:text-blue-600 transition-colors w-full truncate px-2\">\r\n                                        {member.displayName}\r\n                                    </h3>\r\n                                    <p className=\"text-xs text-muted-foreground capitalize mt-1\">\r\n                                        {member.role === 'admin' ? 'Administrator' : 'Member'}\r\n                                    </p>\r\n                                </div>\r\n                            </Link>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {members.length === 0 && (\r\n                        <div className=\"text-center py-10 text-muted-foreground\">\r\n                            No members found.\r\n                        </div>\r\n                    )}\r\n                </CardContent>\r\n            </Card>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\messages\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\news\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\notifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\post\\[postId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'notFound' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"notFound"},"fix":{"range":[220,263],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isUrlVideo' is defined but never used.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"isUrlVideo"},"fix":{"range":[451,462],"text":""},"desc":"Remove unused variable \"isUrlVideo\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'extractYouTubeId' is defined but never used.","line":10,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"extractYouTubeId"},"fix":{"range":[461,479],"text":""},"desc":"Remove unused variable \"extractYouTubeId\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'fetchYouTubeTitle' is defined but never used.","line":10,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":57,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"fetchYouTubeTitle"},"fix":{"range":[442,526],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'searchParams' is defined but never used.","line":20,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'parent' is defined but never used.","line":21,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getPostGlobal } from \"@/app/actions/posts\";\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { PostCard } from \"@/components/feed/post-card\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { notFound } from \"next/navigation\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport Link from \"next/link\";\r\nimport { ArrowLeft } from \"lucide-react\";\r\nimport { Metadata, ResolvingMetadata } from \"next\";\r\nimport { isUrlVideo, extractYouTubeId, fetchYouTubeTitle } from \"@/lib/media-utils\";\r\n\r\ntype Props = {\r\n    params: Promise<{ postId: string }>\r\n    searchParams: Promise<{ [key: string]: string | string[] | undefined }>\r\n}\r\n\r\nimport { generateContentMetadata } from \"@/lib/metadata\";\r\n\r\nexport async function generateMetadata(\r\n    { params, searchParams }: Props,\r\n    parent: ResolvingMetadata\r\n): Promise<Metadata> {\r\n    const { postId } = await params;\r\n\r\n    const post = await getPostGlobal(postId);\r\n\r\n    if (!post || post.engagementSettings?.privacy === 'private') {\r\n        return {\r\n            title: 'Post Unavailable | Famio',\r\n            description: 'This content is private or does not exist.'\r\n        };\r\n    }\r\n\r\n    const baseUrl = process.env.NEXT_PUBLIC_SITE_URL\r\n        || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : null)\r\n        || 'https://we-are-family-221.web.app';\r\n\r\n    const postUrl = `${baseUrl}/post/${postId}`;\r\n    const embedUrl = `${baseUrl}/embed/post/${postId}`;\r\n\r\n    return generateContentMetadata(post, postUrl, embedUrl);\r\n}\r\n\r\n\r\n\r\nexport default async function PostPage({ params }: { params: Promise<{ postId: string }> }) {\r\n    const { postId } = await params;\r\n    const post = await getPostGlobal(postId);\r\n\r\n    if (!post) {\r\n        return (\r\n            <MainLayout>\r\n                <div className=\"flex flex-col items-center justify-center min-h-[50vh] text-center p-4\">\r\n                    <h1 className=\"text-2xl font-bold mb-2\">Post Not Found</h1>\r\n                    <p className=\"text-muted-foreground mb-6\">This post may have been deleted or does not exist.</p>\r\n                    <Link href=\"/\">\r\n                        <Button>\r\n                            <ArrowLeft className=\"mr-2 w-4 h-4\" />\r\n                            Back to Home\r\n                        </Button>\r\n                    </Link>\r\n                </div>\r\n            </MainLayout>\r\n        );\r\n    }\r\n\r\n    const user = await getUserProfile();\r\n\r\n    return (\r\n        <MainLayout>\r\n            <div className=\"max-w-2xl mx-auto py-8\">\r\n                <Link href=\"/\" className=\"inline-flex items-center text-sm text-muted-foreground hover:text-primary mb-4\">\r\n                    <ArrowLeft className=\"mr-1 w-4 h-4\" />\r\n                    Back to Feed\r\n                </Link>\r\n                <PostCard post={post} currentUserId={user?.id} />\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\privacy\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":3,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FileText"},"fix":{"range":[164,174],"text":""},"desc":"Remove unused variable \"FileText\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Shield, Lock, Eye, Server, RefreshCw, FileText, Globe, CheckCircle } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\n\r\nexport default function PrivacyPage() {\r\n    return (\r\n        <MainLayout className=\"max-w-6xl mx-auto\">\r\n            <div className=\"max-w-4xl mx-auto pb-16 pt-8\">\r\n\r\n                {/* Header Section */}\r\n                <div className=\"mb-8 space-y-4\">\r\n                    <h1 className=\"text-4xl font-bold tracking-tight bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent\">\r\n                        Privacy & Security\r\n                    </h1>\r\n                    <p className=\"text-lg text-muted-foreground\">\r\n                        Trust is the foundation of every meaningful digital experience.\r\n                    </p>\r\n                </div>\r\n\r\n                {/* Executive Trust Message - CANONICAL */}\r\n                <div className=\"bg-card/50 backdrop-blur-md border border-primary/20 rounded-xl p-8 mb-12 shadow-sm relative overflow-hidden\">\r\n                    <div className=\"absolute top-0 left-0 w-1 h-full bg-primary\" />\r\n                    <div className=\"relative z-10\">\r\n                        <h2 className=\"text-2xl font-semibold mb-6 flex items-center gap-2\">\r\n                            <Shield className=\"w-6 h-6 text-primary\" />\r\n                            Executive Trust Message\r\n                        </h2>\r\n\r\n                        <div className=\"space-y-6 text-card-foreground leading-relaxed\">\r\n                            <p>\r\n                                At <span className=\"font-bold text-primary\">ChanceTEK</span>, we believe trust is the foundation of every meaningful digital experience.\r\n                            </p>\r\n                            <p>\r\n                                <span className=\"font-bold\">Famio.us</span> is an AI-powered social media platform built to bring people closer‚Äîsecurely, intelligently, and responsibly. We take the privacy, security, and protection of our users‚Äô data extremely seriously, and we design every layer of Famio with that responsibility in mind.\r\n                            </p>\r\n                            <p>\r\n                                Famio.us is built on top of <span className=\"font-semibold\">Google‚Äôs secure cloud infrastructure</span>, leveraging enterprise-grade security, reliability, and compliance standards trusted by organizations around the world. From data encryption to access controls, our systems are engineered to safeguard your information while delivering a powerful, intelligent, and seamless social experience.\r\n                            </p>\r\n                            <p className=\"text-xl font-medium italic text-primary/90 mt-4\">\r\n                                \"Your data belongs to you. Our role is to protect it, respect it, and use it only to improve your experience‚Äînever to compromise it.\"\r\n                            </p>\r\n\r\n                            <div className=\"pt-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4 border-t border-border/50\">\r\n                                <div>\r\n                                    <p className=\"font-bold\">Chancellor Minus</p>\r\n                                    <p className=\"text-sm text-muted-foreground\">Founder & CEO @ ChanceTEK</p>\r\n                                    <Link href=\"https://iChanceTEK.com\" className=\"text-xs text-primary hover:underline\" target=\"_blank\">\r\n                                        iChanceTEK.com\r\n                                    </Link>\r\n                                </div>\r\n                                <div className=\"text-right\">\r\n                                    <Link href=\"https://Famio.us\" className=\"text-sm font-semibold hover:text-primary transition-colors\">\r\n                                        Famio.us\r\n                                    </Link>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <Separator className=\"my-12\" />\r\n\r\n                {/* Core Privacy Sections */}\r\n                <div className=\"space-y-16\">\r\n\r\n                    {/* 1. Privacy Commitment */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-6 flex items-center gap-3\">\r\n                            <Lock className=\"w-6 h-6 text-blue-500\" />\r\n                            1. Privacy Commitment\r\n                        </h3>\r\n                        <ul className=\"grid gap-4 md:grid-cols-2\">\r\n                            {[\r\n                                \"Privacy-first by design\",\r\n                                \"Data is never sold\",\r\n                                \"Transparency is a core value\",\r\n                                \"Users retain ownership of their data\"\r\n                            ].map((item, i) => (\r\n                                <li key={i} className=\"flex items-center gap-3 p-4 bg-card rounded-lg border\">\r\n                                    <CheckCircle className=\"w-5 h-5 text-green-500 flex-shrink-0\" />\r\n                                    <span>{item}</span>\r\n                                </li>\r\n                            ))}\r\n                        </ul>\r\n                    </section>\r\n\r\n                    {/* 2. Infrastructure & Security */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-6 flex items-center gap-3\">\r\n                            <Server className=\"w-6 h-6 text-purple-500\" />\r\n                            2. Infrastructure & Security\r\n                        </h3>\r\n                        <div className=\"bg-slate-950 text-slate-100 p-6 rounded-xl border border-slate-800\">\r\n                            <p className=\"mb-4\">\r\n                                Famio.us is essentially built on <span className=\"text-blue-400 font-semibold\">Google Cloud Platform (GCP)</span>.\r\n                            </p>\r\n                            <div className=\"grid gap-3 sm:grid-cols-2\">\r\n                                {[\r\n                                    \"Enterprise-grade protections\",\r\n                                    \"Encryption in transit (TLS / HTTPS)\",\r\n                                    \"Encryption at rest\",\r\n                                    \"Secure authentication\",\r\n                                    \"Role-based access controls\",\r\n                                    \"Continuous monitoring\",\r\n                                    \"High availability and redundancy\"\r\n                                ].map((item, i) => (\r\n                                    <div key={i} className=\"flex items-center gap-2\">\r\n                                        <div className=\"w-1.5 h-1.5 rounded-full bg-blue-500\" />\r\n                                        <span className=\"text-sm text-slate-300\">{item}</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    </section>\r\n\r\n                    {/* 3. Data Collection */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-4\">3. Data Collection Philosophy</h3>\r\n                        <p className=\"text-muted-foreground mb-4\">\r\n                            We adhere to a strict philosophy of minimal data collection. We only collect what is necessary to operate effectively and improve your experience.\r\n                        </p>\r\n                        <div className=\"pl-4 border-l-2 border-primary/30 space-y-2 text-sm\">\r\n                            <p>‚Ä¢ <strong>Minimal Collection:</strong> We do not hoard data.</p>\r\n                            <p>‚Ä¢ <strong>Purpose-Limited:</strong> Data is used strictly for its intended purpose.</p>\r\n                            <p>‚Ä¢ <strong>Retention:</strong> We minimize retention periods wherever possible.</p>\r\n                        </div>\r\n                    </section>\r\n\r\n                    {/* 4. AI & Responsible Data */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-4 flex items-center gap-3\">\r\n                            <RefreshCw className=\"w-6 h-6 text-teal-500\" />\r\n                            4. AI & Responsible Data Use\r\n                        </h3>\r\n                        <div className=\"bg-teal-500/10 border border-teal-500/20 p-6 rounded-xl\">\r\n                            <p className=\"mb-4 font-medium text-teal-700 dark:text-teal-300\">\r\n                                All AI systems on Famio are Privacy-aware, Secure-by-design, and Purpose-driven.\r\n                            </p>\r\n                            <ul className=\"space-y-3\">\r\n                                <li className=\"flex gap-3\">\r\n                                    <Shield className=\"w-5 h-5 text-teal-500\" />\r\n                                    <span>No sensitive user data is used to train public models.</span>\r\n                                </li>\r\n                                <li className=\"flex gap-3\">\r\n                                    <Eye className=\"w-5 h-5 text-teal-500\" />\r\n                                    <span>AI operates only within authorized scopes.</span>\r\n                                </li>\r\n                                <li className=\"flex gap-3\">\r\n                                    <UsersIcon className=\"w-5 h-5 text-teal-500\" />\r\n                                    <span>AI enhances human connection‚Äînever exploitation.</span>\r\n                                </li>\r\n                            </ul>\r\n                        </div>\r\n                    </section>\r\n\r\n                    {/* 5. User Control */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-4\">5. User Control & Transparency</h3>\r\n                        <p className=\"mb-4\">You have full control over your digital footprint on Famio.</p>\r\n                        <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\r\n                            {[\"Control what you share\", \"Edit or delete content\", \"Manage privacy settings\", \"Request account deletion\", \"Request data access\", \"Request data removal\"].map((action, i) => (\r\n                                <div key={i} className=\"p-3 bg-secondary/30 rounded text-center text-sm font-medium hover:bg-secondary/50 transition-colors cursor-default\">\r\n                                    {action}\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </section>\r\n\r\n                    {/* 6. GDPR */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-4 flex items-center gap-3\">\r\n                            <Globe className=\"w-6 h-6 text-indigo-500\" />\r\n                            6. GDPR Compliance (EU / EEA)\r\n                        </h3>\r\n                        <p className=\"mb-4\">Famio.us explicitly complies with the General Data Protection Regulation (GDPR).</p>\r\n                        <div className=\"space-y-2 text-sm text-muted-foreground\">\r\n                            <p><strong>Lawful Basis:</strong> We process data based on consent, contract necessity, and legitimate interests.</p>\r\n                            <p><strong>Your Rights:</strong> Access, Rectification, Erasure (&quot;Right to be Forgotten&quot;), Portability, Restriction, and Objection.</p>\r\n                            <p className=\"mt-2 text-primary\">To exercise these rights, please contact us via the platform settings.</p>\r\n                        </div>\r\n                    </section>\r\n\r\n                    {/* 7. CCPA */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-4\">7. CCPA / CPRA Compliance (California)</h3>\r\n                        <p className=\"mb-2\">We respect the rights of California residents.</p>\r\n                        <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground text-sm\">\r\n                            <li>Right to know what data is collected.</li>\r\n                            <li>Right to access your data.</li>\r\n                            <li>Right to delete your data.</li>\r\n                            <li>Right to non-discrimination.</li>\r\n                            <li className=\"font-bold text-foreground mt-2\">We do not sell your personal data.</li>\r\n                        </ul>\r\n                    </section>\r\n\r\n                    {/* 8. Third Party */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-4\">8. Third-Party Services</h3>\r\n                        <p className=\"text-muted-foreground\">\r\n                            We partner only with vetted, trusted providers who agree to our contractual security obligations. Data sharing is minimal and authorized only when necessary for service delivery.\r\n                        </p>\r\n                    </section>\r\n\r\n                    {/* 9. Childrens Privacy */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-4\">9. Children‚Äôs Privacy</h3>\r\n                        <div className=\"p-4 border-l-4 border-red-500 bg-red-50 dark:bg-red-950/10\">\r\n                            <p className=\"font-medium\">\r\n                                Famio.us is not intended for children under 13.\r\n                            </p>\r\n                            <p className=\"text-sm mt-1 text-muted-foreground\">\r\n                                We do not intentionally collect data from children. If discovered, such data will be promptly removed.\r\n                            </p>\r\n                        </div>\r\n                    </section>\r\n\r\n                    {/* 10. Continuous Security */}\r\n                    <section>\r\n                        <h3 className=\"text-2xl font-bold mb-4 flex items-center gap-3\">\r\n                            <RefreshCw className=\"w-6 h-6 text-green-500\" />\r\n                            10. Continuous Security Commitment\r\n                        </h3>\r\n                        <p className=\"text-muted-foreground\">\r\n                            Security is not a destination, but a journey. We are committed to ongoing monitoring, regular reviews, proactive threat mitigation, and a continuous improvement mindset.\r\n                        </p>\r\n                    </section>\r\n\r\n                </div>\r\n\r\n                <footer className=\"mt-20 pt-10 border-t text-center space-y-4\">\r\n                    <div className=\"flex justify-center gap-6 text-sm font-medium\">\r\n                        <Link href=\"/privacy\" className=\"hover:text-primary transition-colors\">Privacy Policy</Link>\r\n                        <Link href=\"#\" className=\"hover:text-primary transition-colors text-muted-foreground\">Terms of Service</Link>\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"text-sm text-muted-foreground\">Built with privacy and security at the core.</p>\r\n                        <p className=\"text-xs text-muted-foreground mt-1\">¬© ChanceTEK. All rights reserved.</p>\r\n                    </div>\r\n                </footer>\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n\r\n// User Icon helper\r\nfunction UsersIcon({ className }: { className?: string }) {\r\n    return (\r\n        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className={className}>\r\n            <path d=\"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2\" /><circle cx=\"9\" cy=\"7\" r=\"4\" /><path d=\"M22 21v-2a4 4 0 0 0-3-3.87\" /><path d=\"M16 3.13a4 4 0 0 1 0 7.75\" />\r\n        </svg>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\profile\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[985,988],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[985,988],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1283,1286],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1283,1286],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { ProfileHeader } from \"@/components/profile/profile-header\";\r\nimport { FamilyMembersCard } from \"@/components/profile/family-members-card\";\r\nimport { getFamilyMembers } from \"@/app/actions/family\";\r\nimport { ProfileFeed } from \"@/components/profile/profile-feed\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function ProfilePage() {\r\n    const user = await getUserProfile();\r\n\r\n    if (!user || user.role === 'pending') {\r\n        redirect(\"/\");\r\n    }\r\n\r\n    const familyMembers = await getFamilyMembers();\r\n\r\n    // DEBUG: Log to server console\r\n    console.log(\"Profile Debug:\", {\r\n        userId: user.id,\r\n        userEmail: user.email\r\n    });\r\n\r\n    return (\r\n        <MainLayout className=\"max-w-6xl\">\r\n            <div className=\"pb-16 pt-0\">\r\n\r\n                <ProfileHeader user={user as any} isCurrentUser={true} />\r\n\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6\">\r\n                    {/* Left Column: Sidebar Info */}\r\n                    <div className=\"lg:col-span-4 space-y-6\">\r\n                        <FamilyMembersCard members={familyMembers as any} />\r\n                    </div>\r\n\r\n                    {/* Right Column: Timeline Feed */}\r\n                    <div className=\"lg:col-span-8 space-y-6\">\r\n                        <ProfileFeed userId={user.id} />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[921,924],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[921,924],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { SettingsContent } from \"@/components/settings/settings-content\";\r\nimport { getBlockedUsers } from \"@/app/actions/security\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function SettingsPage() {\r\n    const user = await getUserProfile();\r\n\r\n    if (!user) {\r\n        redirect(\"/\");\r\n    }\r\n\r\n    const blockedUsers = await getBlockedUsers();\r\n\r\n    console.log(\"[SettingsPage] User ID:\", user.id);\r\n    console.log(\"[SettingsPage] isInvisible:\", user.isInvisible);\r\n    console.log(\"[SettingsPage] Blocked Users Count:\", blockedUsers.length);\r\n\r\n    return (\r\n        <MainLayout className=\"max-w-4xl\">\r\n            <div className=\"pb-16 pt-6\">\r\n                <SettingsContent user={user} blockedUsers={blockedUsers.filter(Boolean) as any} />\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\signup\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createSession' is defined but never used.","line":14,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"createSession"},"fix":{"range":[590,604],"text":""},"desc":"Remove unused variable \"createSession\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'signupSchema' is assigned a value but never used.","line":17,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":109,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4367,4370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4367,4370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { getAuth, createUserWithEmailAndPassword, updateProfile, sendEmailVerification } from \"firebase/auth\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { toast } from \"sonner\"\r\nimport Link from \"next/link\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Loader2, Heart } from \"lucide-react\"\r\nimport \"@/lib/firebase\"\r\nimport { createSession, syncUserToDb, notifyAdminNewUser } from \"@/app/actions/auth\"\r\nimport { z } from \"zod\";\r\n\r\nconst signupSchema = z.object({\r\n    firstName: z.string().min(1, \"First Name is required\"),\r\n    lastName: z.string().min(1, \"Last Name is required\"),\r\n    email: z.string().email(\"Invalid email address\"),\r\n    password: z.string().min(6, \"Password must be at least 6 characters\"),\r\n    confirmPassword: z.string(),\r\n    displayName: z.string().min(2, \"Display Name is required (min 2 characters)\"),\r\n}).refine((data) => data.password === data.confirmPassword, {\r\n    message: \"Passwords don't match\",\r\n    path: [\"confirmPassword\"],\r\n});\r\n\r\nexport default function SignupPage() {\r\n    const [firstName, setFirstName] = useState(\"\")\r\n    const [lastName, setLastName] = useState(\"\")\r\n    const [displayName, setDisplayName] = useState(\"\")\r\n    const [email, setEmail] = useState(\"\")\r\n    const [password, setPassword] = useState(\"\")\r\n    const [confirmPassword, setConfirmPassword] = useState(\"\")\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [isDisplayNameManuallyEdited, setIsDisplayNameManuallyEdited] = useState(false)\r\n    const router = useRouter()\r\n\r\n    // Auto-generate Display Name\r\n    const updateDisplayName = (fName: string, lName: string) => {\r\n        if (!isDisplayNameManuallyEdited && fName && lName) {\r\n            setDisplayName(`${fName} ${lName}`.trim())\r\n        }\r\n    }\r\n\r\n    const handleFirstNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const val = e.target.value;\r\n        setFirstName(val);\r\n        updateDisplayName(val, lastName);\r\n    }\r\n\r\n    const handleLastNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const val = e.target.value;\r\n        setLastName(val);\r\n        updateDisplayName(firstName, val);\r\n    }\r\n\r\n    const handleDisplayNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        setDisplayName(e.target.value);\r\n        setIsDisplayNameManuallyEdited(true);\r\n    }\r\n\r\n    const handleSignup = async (e: React.FormEvent) => {\r\n        e.preventDefault()\r\n\r\n        // Validation\r\n        if (password !== confirmPassword) {\r\n            toast.error(\"Passwords do not match!\")\r\n            return\r\n        }\r\n\r\n        if (password.length < 6) {\r\n            toast.error(\"Password must be at least 6 characters\")\r\n            return\r\n        }\r\n\r\n        if (displayName.trim().length < 2) {\r\n            toast.error(\"Display Name is required (min 2 characters)\")\r\n            return\r\n        }\r\n\r\n        setIsLoading(true)\r\n        try {\r\n            const auth = getAuth()\r\n            const { setPersistence, browserLocalPersistence } = await import(\"firebase/auth\");\r\n            await setPersistence(auth, browserLocalPersistence);\r\n            const userCredential = await createUserWithEmailAndPassword(auth, email, password)\r\n            const user = userCredential.user\r\n\r\n            // Update display name in Firebase (use displayName if provided, otherwise firstName)\r\n            const finalDisplayName = displayName || firstName\r\n            await updateProfile(user, { displayName: finalDisplayName })\r\n\r\n            // Send verification email\r\n            await sendEmailVerification(user);\r\n\r\n            // Sync to Database with all fields\r\n            await syncUserToDb(user.uid, email, finalDisplayName, firstName, lastName)\r\n\r\n            // Notify admins of new user registration\r\n            await notifyAdminNewUser(user.uid, email, `${firstName} ${lastName}`)\r\n\r\n            // Do NOT create session. Enforce verification.\r\n            await auth.signOut();\r\n\r\n            toast.success(\"Account created! Please check your email (and Junk folder) to verify.\")\r\n            router.push(\"/login\")\r\n        } catch (error: any) {\r\n            console.error(error)\r\n            if (error.code === 'auth/email-already-in-use') {\r\n                toast.error(\"This email is already registered. Please login instead.\")\r\n            } else if (error.code === 'auth/invalid-email') {\r\n                toast.error(\"Invalid email address\")\r\n            } else if (error.code === 'auth/weak-password') {\r\n                toast.error(\"Password is too weak. Please use a stronger password.\")\r\n            } else {\r\n                toast.error(error.message || \"Failed to create account\")\r\n            }\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex items-center justify-center min-h-screen bg-gradient-to-b from-blue-50 to-white py-12\">\r\n            <Card className=\"w-full max-w-md shadow-lg\">\r\n                <CardHeader className=\"text-center space-y-2\">\r\n                    <div className=\"flex items-center justify-center gap-2 mb-2\">\r\n                        <Heart className=\"w-8 h-8 text-blue-600\" fill=\"currentColor\" />\r\n                        <span className=\"text-2xl font-bold text-blue-600\">Famio</span>\r\n                    </div>\r\n                    <CardTitle className=\"text-2xl font-bold\">Create Your Account</CardTitle>\r\n                    <CardDescription>Join your family network on Famio</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <form onSubmit={handleSignup} className=\"space-y-4\">\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"firstName\">First Name *</Label>\r\n                                <Input\r\n                                    id=\"firstName\"\r\n                                    type=\"text\"\r\n                                    placeholder=\"John\"\r\n                                    value={firstName}\r\n                                    onChange={handleFirstNameChange}\r\n                                    required\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"lastName\">Last Name *</Label>\r\n                                <Input\r\n                                    id=\"lastName\"\r\n                                    type=\"text\"\r\n                                    placeholder=\"Doe\"\r\n                                    value={lastName}\r\n                                    onChange={handleLastNameChange}\r\n                                    required\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"displayName\">Display Name <span className=\"text-red-500\">*</span></Label>\r\n                            <Input\r\n                                id=\"displayName\"\r\n                                type=\"text\"\r\n                                placeholder=\"How you'd like to be known\"\r\n                                value={displayName}\r\n                                onChange={handleDisplayNameChange}\r\n                                required\r\n                                minLength={2}\r\n                            />\r\n                            <p className=\"text-xs text-muted-foreground\">This will be your public name on Famio</p>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"email\">Email Address *</Label>\r\n                            <Input\r\n                                id=\"email\"\r\n                                type=\"email\"\r\n                                placeholder=\"name@example.com\"\r\n                                value={email}\r\n                                onChange={(e) => setEmail(e.target.value)}\r\n                                required\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"password\">Password *</Label>\r\n                            <Input\r\n                                id=\"password\"\r\n                                type=\"password\"\r\n                                placeholder=\"Minimum 6 characters\"\r\n                                value={password}\r\n                                onChange={(e) => setPassword(e.target.value)}\r\n                                required\r\n                                minLength={6}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"confirmPassword\">Confirm Password *</Label>\r\n                            <Input\r\n                                id=\"confirmPassword\"\r\n                                type=\"password\"\r\n                                placeholder=\"Re-enter your password\"\r\n                                value={confirmPassword}\r\n                                onChange={(e) => setConfirmPassword(e.target.value)}\r\n                                required\r\n                                minLength={6}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-gray-700\">\r\n                            <p className=\"font-semibold mb-1\">Next Steps:</p>\r\n                            <ul className=\"text-xs space-y-1 text-gray-600\">\r\n                                <li>‚Ä¢ Check your email to verify your account</li>\r\n                                <li>‚Ä¢ <strong>Note:</strong> Check your Junk or Spam folder if you don't see it</li>\r\n                                <li>‚Ä¢ You can login immediately after verification</li>\r\n                            </ul>\r\n                        </div>\r\n\r\n                        <Button type=\"submit\" className=\"w-full bg-blue-600 hover:bg-blue-700\" disabled={isLoading}>\r\n                            {isLoading ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : null}\r\n                            Create Account\r\n                        </Button>\r\n                    </form>\r\n\r\n                    <div className=\"text-center text-sm text-muted-foreground mt-6\">\r\n                        Already have an account?{\" \"}\r\n                        <Link href=\"/login\" className=\"text-blue-600 hover:underline font-semibold\">\r\n                            Login\r\n                        </Link>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\stories\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\u\\[userId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PostCard' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"PostCard"},"fix":{"range":[237,292],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { notFound, redirect } from \"next/navigation\";\r\nimport { ProfileHeader } from \"@/components/profile/profile-header\";\r\nimport { PostCard } from \"@/components/feed/post-card\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\n\r\nimport { getFamilyStatus } from \"@/app/actions/family\";\r\nimport { getUserPosts } from \"@/app/actions/posts\";\r\nimport { Lock } from \"lucide-react\";\r\n\r\nimport { ProfileTabs } from \"@/components/profile/profile-tabs\";\r\nimport { Metadata } from \"next\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\ntype Props = {\r\n    params: Promise<{ userId: string }>\r\n}\r\n\r\nexport async function generateMetadata({ params }: Props): Promise<Metadata> {\r\n    const { userId } = await params;\r\n\r\n    try {\r\n        const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n\r\n        if (!userDoc.exists) {\r\n            return {\r\n                title: 'Profile Not Found | Famio',\r\n                description: 'This profile does not exist.'\r\n            };\r\n        }\r\n\r\n        const userData = userDoc.data()!;\r\n        // Show metadata by default, only hide if explicitly set to false (private)\r\n        const isExplicitlyPrivate = userData.isPublicProfile === false;\r\n\r\n        // Privacy: Only hide metadata for explicitly private profiles\r\n        if (isExplicitlyPrivate) {\r\n            return {\r\n                title: 'Famio Profile',\r\n                description: 'This profile is private.',\r\n                openGraph: {\r\n                    type: 'website',\r\n                    title: 'Famio Profile',\r\n                    description: 'This profile is private.',\r\n                    siteName: 'Famio'\r\n                }\r\n            };\r\n        }\r\n\r\n        // Build display name\r\n        const displayName = ((userData.displayName && userData.displayName !== \"Family Member\")\r\n            ? userData.displayName\r\n            : null)\r\n            || (userData.profileData?.firstName\r\n                ? `${userData.profileData.firstName} ${userData.profileData.lastName || ''}`.trim()\r\n                : null)\r\n            || \"Famio Member\";\r\n\r\n        const bio = userData.bio || \"Member on Famio. View profile and activity.\";\r\n\r\n        // Use actual image URL from Firebase Storage or fallback to a placeholder\r\n        // Firebase Storage URLs are publicly accessible if the bucket has public read rules\r\n        const imageUrl = userData.imageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&size=630&background=random`;\r\n\r\n        // Use the actual deployment URL (production or preview)\r\n        // This ensures the URLs work regardless of where the app is hosted\r\n        const baseUrl = process.env.NEXT_PUBLIC_SITE_URL\r\n            || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : null)\r\n            || 'https://we-are-family-221.web.app';\r\n\r\n        const profileUrl = `${baseUrl}/u/${userId}`;\r\n\r\n        return {\r\n            title: `${displayName} | Famio`,\r\n            description: bio,\r\n            openGraph: {\r\n                type: 'profile',\r\n                title: displayName,\r\n                description: bio,\r\n                url: profileUrl,\r\n                siteName: 'Famio',\r\n                images: [\r\n                    {\r\n                        url: imageUrl,\r\n                        width: 1200,\r\n                        height: 630,\r\n                        alt: `${displayName}'s profile photo`\r\n                    }\r\n                ]\r\n            },\r\n            twitter: {\r\n                card: 'summary_large_image',\r\n                title: `${displayName} | Famio`,\r\n                description: bio,\r\n                images: [imageUrl]\r\n            }\r\n        };\r\n    } catch (error) {\r\n        console.error('Error generating profile metadata:', error);\r\n        return {\r\n            title: 'Famio Profile',\r\n            description: 'Member profile on Famio'\r\n        };\r\n    }\r\n}\r\n\r\n\r\nexport default async function ProfilePage({ params }: { params: Promise<{ userId: string }> }) {\r\n    const currentUser = await getUserProfile();\r\n    if (!currentUser || currentUser.role === 'pending') {\r\n        redirect(\"/\");\r\n    }\r\n\r\n    const { userId } = await params;\r\n    const userDoc = await adminDb.collection(\"users\").doc(userId).get();\r\n\r\n    if (!userDoc.exists) {\r\n        notFound();\r\n    }\r\n\r\n    const isOwnProfile = currentUser.id === userId;\r\n    // Fetch family status\r\n    const familyStatus = await getFamilyStatus(userId);\r\n\r\n    // Privacy Logic: Owner OR Family OR Public Profile\r\n    const userData = userDoc.data()!;\r\n    const isPublicProfile = userData.isPublicProfile === true;\r\n\r\n    // STRICT ACCESS CHECK\r\n    const hasAccess = isOwnProfile || familyStatus.status === 'accepted' || currentUser.role === 'admin' || isPublicProfile;\r\n\r\n    // Sanitize user data based on access\r\n    // If public but NOT family/owner, we show LIMITED data.\r\n    const isFamilyOrOwner = isOwnProfile || familyStatus.status === 'accepted' || currentUser.role === 'admin';\r\n    const showFullProfile = isFamilyOrOwner;\r\n\r\n    const user = sanitizeData({\r\n        id: userDoc.id,\r\n        displayName: ((userData.displayName && userData.displayName !== \"Family Member\") ? userData.displayName : null) || (userData.profileData?.firstName ? `${userData.profileData.firstName} ${userData.profileData.lastName || ''}`.trim() : null) || userData.email?.split('@')[0] || \"Unknown\",\r\n        imageUrl: userData.imageUrl,\r\n        // Public Data (Allowed for everyone)\r\n        isPublicProfile: userData.isPublicProfile,\r\n\r\n        // Private Data (Only for Owner/Family)\r\n        ...(showFullProfile ? userData : {}),\r\n\r\n        // Explicit overrides for safety\r\n        coverUrl: showFullProfile ? userData.coverUrl : null,\r\n        coverType: showFullProfile ? userData.coverType : null,\r\n        bio: showFullProfile ? userData.bio : null,\r\n        email: showFullProfile ? userData.email : null,\r\n    });\r\n\r\n    // Fetch user posts\r\n    console.log(`Checking profile access for viewer ${currentUser.id} to target ${userId}`);\r\n    console.log(`Access status: isOwn=${isOwnProfile}, family=${familyStatus.status}, pub=${isPublicProfile}`);\r\n    console.log(`Has Access: ${hasAccess}`);\r\n\r\n    const userPosts = hasAccess ? await getUserPosts(userId) : [];\r\n    console.log(`Fetched ${userPosts.length} posts for profile ${userId}`);\r\n\r\n    const { getUserFamilyMembers } = await import(\"@/app/actions/family\");\r\n    const userFamily = hasAccess ? await getUserFamilyMembers(userId) : [];\r\n\r\n    // Check if user is blocked by current user\r\n    const { getBlockedUsers } = await import(\"@/app/actions/security\");\r\n    const blockedQueue = await getBlockedUsers();\r\n    const isBlocked = blockedQueue.some(u => u.id === userId);\r\n\r\n    return (\r\n        <MainLayout>\r\n            <ProfileHeader\r\n                user={user}\r\n                isCurrentUser={isOwnProfile}\r\n                isBlocked={isBlocked}\r\n            />\r\n            <div className=\"mt-8\">\r\n                {!hasAccess ? (\r\n                    <div className=\"flex flex-col items-center justify-center p-10 bg-slate-50 dark:bg-card rounded-lg border border-slate-200 dark:border-border text-center\">\r\n                        <div className=\"bg-slate-200 dark:bg-muted p-4 rounded-full mb-4\">\r\n                            <Lock className=\"w-8 h-8 text-slate-500\" />\r\n                        </div>\r\n                        <h3 className=\"text-lg font-semibold text-foreground\">Private Profile</h3>\r\n                        <p className=\"text-muted-foreground mt-2 max-w-sm\">\r\n                            This profile is private. You must be family to view {user.displayName || \"this user\"}'s posts and photos.\r\n                        </p>\r\n                    </div>\r\n                ) : (\r\n                    <ProfileTabs\r\n                        posts={userPosts}\r\n                        familyMembers={userFamily}\r\n                        isOwnProfile={isOwnProfile}\r\n                        currentUserId={currentUser.id}\r\n                    />\r\n                )}\r\n            </div>\r\n        </MainLayout >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\verify-email\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Suspense' is defined but never used.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Suspense"},"fix":{"range":[0,32],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VerificationBanner' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":28,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"VerificationBanner"},"fix":{"range":[123,197],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Suspense } from \"react\"\r\nimport { getUserProfile } from \"@/lib/auth\"\r\nimport { redirect } from \"next/navigation\"\r\nimport { VerificationBanner } from \"@/components/auth/verification-banner\"\r\nimport { VerificationBlock } from \"./verification-block\" // Client component\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function VerifyEmailPage() {\r\n    const user = await getUserProfile();\r\n\r\n    if (!user) {\r\n        redirect(\"/login\");\r\n    }\r\n\r\n    // If already verified, go home\r\n    if (user.emailVerified || user.role === 'admin') {\r\n        redirect(\"/\");\r\n    }\r\n\r\n    // This page is the \"Jail\". It renders a blocking UI.\r\n    return (\r\n        <div className=\"min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-950 p-4\">\r\n            <VerificationBlock email={user.email} />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\app\\verify-email\\verification-block.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowLeft' is defined but never used.","line":6,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowLeft"},"fix":{"range":[246,257],"text":""},"desc":"Remove unused variable \"ArrowLeft\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/ui/card\";\r\nimport { Loader2, Mail, ArrowLeft, RefreshCw, LogOut } from \"lucide-react\";\r\nimport { sendVerificationEmail } from \"@/app/actions/verification\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { toast } from \"sonner\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\nexport function VerificationBlock({ email }: { email: string }) {\r\n    const { refreshUser, signOut } = useAuth();\r\n    const [sending, setSending] = useState(false);\r\n    const [cooldown, setCooldown] = useState(0);\r\n    const [verifying, setVerifying] = useState(false);\r\n    const router = useRouter();\r\n\r\n    useEffect(() => {\r\n        if (cooldown > 0) {\r\n            const timer = setInterval(() => setCooldown(c => c - 1), 1000);\r\n            return () => clearInterval(timer);\r\n        }\r\n    }, [cooldown]);\r\n\r\n    const handleResend = async () => {\r\n        if (cooldown > 0) return;\r\n        setSending(true);\r\n        try {\r\n            const result = await sendVerificationEmail();\r\n            if (result.success) {\r\n                toast.success(\"Email sent!\");\r\n                setCooldown(300);\r\n            } else {\r\n                toast.error(result.error);\r\n                if (result.nextAvailableIn) setCooldown(result.nextAvailableIn);\r\n            }\r\n        } catch {\r\n            toast.error(\"Error sending email\");\r\n        } finally {\r\n            setSending(false);\r\n        }\r\n    }\r\n\r\n    const handleCheck = async () => {\r\n        setVerifying(true);\r\n        try {\r\n            await refreshUser();\r\n            // If verified, refreshUser triggers router.refresh which might redirect if the page logic re-runs \r\n            // OR we can manually check and push.\r\n            // But layout/page logic handles redirect if verified.\r\n            // Let's force a hard reload or router replace to home to trigger server check.\r\n            router.push('/');\r\n        } finally {\r\n            setVerifying(false);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Card className=\"w-full max-w-md shadow-lg border-2 border-amber-500/10\">\r\n            <CardHeader className=\"text-center pb-2\">\r\n                <div className=\"mx-auto w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mb-4\">\r\n                    <Mail className=\"w-6 h-6 text-blue-600 dark:text-blue-400\" />\r\n                </div>\r\n                <CardTitle className=\"text-2xl font-bold\">Verify Your Email</CardTitle>\r\n                <CardDescription className=\"pt-2\">\r\n                    We sent a verification email to <br />\r\n                    <span className=\"font-semibold text-foreground\">{email}</span>\r\n                </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n                <div className=\"bg-amber-50 dark:bg-amber-950/40 p-3 rounded-lg border border-amber-200 dark:border-amber-900/50 text-amber-800 dark:text-amber-200 text-sm\">\r\n                    <p className=\"font-medium mb-1\">Account requires verification</p>\r\n                    <p className=\"opacity-90\">\r\n                        You must verify your email address before you can access your account.\r\n                        Please check your Junk/Spam folder if you don't see the email.\r\n                    </p>\r\n                </div>\r\n\r\n                <Button\r\n                    className=\"w-full bg-blue-600 hover:bg-blue-700 text-white\"\r\n                    onClick={handleResend}\r\n                    disabled={sending || cooldown > 0}\r\n                >\r\n                    {sending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\r\n                    {cooldown > 0 ? `Resend available in ${cooldown}s` : \"Resend Verification Email\"}\r\n                </Button>\r\n\r\n                <div className=\"relative\">\r\n                    <div className=\"absolute inset-0 flex items-center\">\r\n                        <span className=\"w-full border-t\" />\r\n                    </div>\r\n                    <div className=\"relative flex justify-center text-xs uppercase\">\r\n                        <span className=\"bg-background px-2 text-muted-foreground\">Or</span>\r\n                    </div>\r\n                </div>\r\n\r\n                <Button variant=\"outline\" className=\"w-full\" onClick={handleCheck} disabled={verifying}>\r\n                    {verifying ? <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> : <RefreshCw className=\"mr-2 w-4 h-4\" />}\r\n                    I've verified my email\r\n                </Button>\r\n            </CardContent>\r\n            <CardFooter className=\"flex justify-center border-t pt-4\">\r\n                <Button variant=\"link\" className=\"text-muted-foreground\" onClick={() => signOut()}>\r\n                    <LogOut className=\"w-4 h-4 mr-2\" />\r\n                    Back to Login\r\n                </Button>\r\n            </CardFooter>\r\n        </Card>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\admin-charts.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\analytics\\analytics-dashboard-simple.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used.","line":7,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[346,353],"text":""},"desc":"Remove unused variable \"Clock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LogIn' is defined but never used.","line":7,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"LogIn"},"fix":{"range":[353,360],"text":""},"desc":"Remove unused variable \"LogIn\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used.","line":7,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertCircle"},"fix":{"range":[370,383],"text":""},"desc":"Remove unused variable \"AlertCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Briefcase' is defined but never used.","line":7,"column":64,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":73,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Briefcase"},"fix":{"range":[393,404],"text":""},"desc":"Remove unused variable \"Briefcase\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[829,832],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[829,832],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2002,2005],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2002,2005],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'timeRange' is defined but never used.","line":215,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":215,"endColumn":44},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":216,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":216,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12920,12923],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12920,12923],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":218,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":218,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13043,13046],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13043,13046],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":302,"column":37,"nodeType":"JSXOpeningElement","endLine":306,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Users, Clock, LogIn, Activity, AlertCircle, FileText, Briefcase } from \"lucide-react\";\r\nimport { getSimpleAnalytics } from \"@/app/actions/simple-analytics\";\r\nimport { toast } from \"sonner\";\r\nimport { Bar, BarChart, ResponsiveContainer, XAxis, YAxis, Tooltip, PieChart, Pie, Cell, Legend } from \"recharts\";\r\n\r\nexport default function AnalyticsDashboard() {\r\n    const [timeRange, setTimeRange] = useState<'day' | 'week' | 'month' | 'year'>('week');\r\n    const [stats, setStats] = useState<any>(null);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        const fetchData = async () => {\r\n            setLoading(true);\r\n            try {\r\n                const data = await getSimpleAnalytics();\r\n                setStats(data);\r\n\r\n                if (data._error) {\r\n                    console.error(\"Analytics error:\", data._error);\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Failed to fetch analytics\", error);\r\n                toast.error(\"Failed to load analytics data\");\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchData();\r\n    }, [timeRange]);\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n                <div>\r\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Analytics Dashboard</h2>\r\n                    <p className=\"text-muted-foreground\">Monitor platform growth and user engagement trends.</p>\r\n                </div>\r\n                <Select value={timeRange} onValueChange={(val: any) => setTimeRange(val)}>\r\n                    <SelectTrigger className=\"w-[180px]\">\r\n                        <SelectValue placeholder=\"Select period\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                        <SelectItem value=\"day\">Today</SelectItem>\r\n                        <SelectItem value=\"week\">This Week</SelectItem>\r\n                        <SelectItem value=\"month\">This Month</SelectItem>\r\n                        <SelectItem value=\"year\">This Year</SelectItem>\r\n                    </SelectContent>\r\n                </Select>\r\n            </div>\r\n\r\n            {/* Tabs for Global vs Individual */}\r\n            <Tabs defaultValue=\"global\" className=\"space-y-4\">\r\n                <TabsList>\r\n                    <TabsTrigger value=\"global\">Global Overview</TabsTrigger>\r\n                    <TabsTrigger value=\"individual\">Individual User Analysis</TabsTrigger>\r\n                </TabsList>\r\n\r\n                <TabsContent value=\"global\" className=\"space-y-4\">\r\n                    {/* Metrics Cards */}\r\n                    <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\r\n                        <Card>\r\n                            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Total Users</CardTitle>\r\n                                <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{loading ? \"...\" : (stats?.totalUsers || 0)}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">Platform members</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                        <Card>\r\n                            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Total Posts</CardTitle>\r\n                                <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{loading ? \"...\" : (stats?.totalPosts || 0)}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">All content created</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                        <Card>\r\n                            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Groups</CardTitle>\r\n                                <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{loading ? \"...\" : (stats?.totalGroups || 0)}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">Active communities</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                        <Card>\r\n                            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Recent Activity</CardTitle>\r\n                                <Activity className=\"h-4 w-4 text-muted-foreground\" />\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{loading ? \"...\" : (stats?.recentActivity || 0)}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">Posts last 7 days</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                    </div>\r\n\r\n                    {/* Charts */}\r\n                    <div className=\"grid gap-4 md:grid-cols-2\">\r\n                        {/* Platform Stats Bar Chart */}\r\n                        <Card>\r\n                            <CardHeader>\r\n                                <CardTitle>Platform Statistics</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                {loading ? (\r\n                                    <div className=\"h-[300px] flex items-center justify-center text-muted-foreground\">\r\n                                        Loading...\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"h-[300px]\">\r\n                                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                            <BarChart data={[\r\n                                                { name: 'Users', value: stats?.totalUsers || 0, fill: '#8b5cf6' },\r\n                                                { name: 'Posts', value: stats?.totalPosts || 0, fill: '#0ea5e9' },\r\n                                                { name: 'Groups', value: stats?.totalGroups || 0, fill: '#10b981' },\r\n                                                { name: 'Recent', value: stats?.recentActivity || 0, fill: '#f59e0b' }\r\n                                            ]}>\r\n                                                <XAxis dataKey=\"name\" stroke=\"#a1a1aa\" fontSize={12} tickLine={false} axisLine={false} />\r\n                                                <YAxis stroke=\"#a1a1aa\" fontSize={12} tickLine={false} axisLine={false} allowDecimals={false} />\r\n                                                <Tooltip\r\n                                                    contentStyle={{\r\n                                                        backgroundColor: 'hsl(var(--card))',\r\n                                                        border: '1px solid hsl(var(--border))',\r\n                                                        borderRadius: '8px'\r\n                                                    }}\r\n                                                />\r\n                                                <Bar dataKey=\"value\" radius={[6, 6, 0, 0]}>\r\n                                                    {[\r\n                                                        { name: 'Users', value: stats?.totalUsers || 0, fill: '#8b5cf6' },\r\n                                                        { name: 'Posts', value: stats?.totalPosts || 0, fill: '#0ea5e9' },\r\n                                                        { name: 'Groups', value: stats?.totalGroups || 0, fill: '#10b981' },\r\n                                                        { name: 'Recent', value: stats?.recentActivity || 0, fill: '#f59e0b' }\r\n                                                    ].map((entry, index) => (\r\n                                                        <Cell key={`cell-${index}`} fill={entry.fill} />\r\n                                                    ))}\r\n                                                </Bar>\r\n                                            </BarChart>\r\n                                        </ResponsiveContainer>\r\n                                    </div>\r\n                                )}\r\n                            </CardContent>\r\n                        </Card>\r\n\r\n                        {/* Content Distribution Pie Chart */}\r\n                        <Card>\r\n                            <CardHeader>\r\n                                <CardTitle>Content Distribution</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                {loading ? (\r\n                                    <div className=\"h-[300px] flex items-center justify-center text-muted-foreground\">\r\n                                        Loading...\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"h-[300px]\">\r\n                                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                            <PieChart>\r\n                                                <Pie\r\n                                                    data={[\r\n                                                        { name: 'User Posts', value: stats?.totalPosts || 1 },\r\n                                                        { name: 'Groups', value: stats?.totalGroups || 1 },\r\n                                                        { name: 'Branding', value: stats?.totalBranding || 1 }\r\n                                                    ]}\r\n                                                    cx=\"50%\"\r\n                                                    cy=\"50%\"\r\n                                                    innerRadius={60}\r\n                                                    outerRadius={80}\r\n                                                    paddingAngle={5}\r\n                                                    dataKey=\"value\"\r\n                                                    stroke=\"none\"\r\n                                                >\r\n                                                    <Cell fill=\"#8b5cf6\" />\r\n                                                    <Cell fill=\"#0ea5e9\" />\r\n                                                    <Cell fill=\"#10b981\" />\r\n                                                </Pie>\r\n                                                <Tooltip\r\n                                                    contentStyle={{\r\n                                                        backgroundColor: 'hsl(var(--card))',\r\n                                                        border: '1px solid hsl(var(--border))',\r\n                                                        borderRadius: '8px'\r\n                                                    }}\r\n                                                />\r\n                                                <Legend verticalAlign=\"bottom\" height={36} iconType=\"circle\" />\r\n                                            </PieChart>\r\n                                        </ResponsiveContainer>\r\n                                    </div>\r\n                                )}\r\n                            </CardContent>\r\n                        </Card>\r\n                    </div>\r\n                </TabsContent>\r\n\r\n                <TabsContent value=\"individual\">\r\n                    <IndividualUserAnalysis timeRange={timeRange} />\r\n                </TabsContent>\r\n            </Tabs>\r\n        </div>\r\n    );\r\n}\r\n\r\n// Individual User Analysis Component\r\nfunction IndividualUserAnalysis({ timeRange }: { timeRange: string }) {\r\n    const [users, setUsers] = useState<any[]>([]);\r\n    const [selectedUserId, setSelectedUserId] = useState(\"\");\r\n    const [userStats, setUserStats] = useState<any>(null);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Load users list on mount\r\n    useEffect(() => {\r\n        const loadUsers = async () => {\r\n            try {\r\n                const { getAllUsersList } = await import(\"@/app/actions/user-analytics\");\r\n                const usersList = await getAllUsersList();\r\n                setUsers(usersList);\r\n            } catch (error) {\r\n                console.error(\"Failed to load users\", error);\r\n            }\r\n        };\r\n        loadUsers();\r\n    }, []);\r\n\r\n    // Load user stats when user is selected\r\n    useEffect(() => {\r\n        if (!selectedUserId) {\r\n            setUserStats(null);\r\n            return;\r\n        }\r\n\r\n        const loadUserStats = async () => {\r\n            setLoading(true);\r\n            try {\r\n                const { getUserAnalyticsSimple } = await import(\"@/app/actions/user-analytics\");\r\n                const stats = await getUserAnalyticsSimple(selectedUserId);\r\n                console.log('Fetched user stats:', stats);\r\n                setUserStats(stats);\r\n            } catch (error) {\r\n                console.error(\"Failed to load user stats\", error);\r\n                toast.error(\"Failed to load user analytics\");\r\n                setUserStats(null);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        console.log('Selected user ID:', selectedUserId);\r\n        loadUserStats();\r\n    }, [selectedUserId]);\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle>Select User</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <Select value={selectedUserId} onValueChange={setSelectedUserId}>\r\n                        <SelectTrigger className=\"w-full\">\r\n                            <SelectValue placeholder=\"Choose a user to analyze...\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                            {users.map(user => (\r\n                                <SelectItem key={user.id} value={user.id}>\r\n                                    {user.displayName} ({user.email})\r\n                                </SelectItem>\r\n                            ))}\r\n                        </SelectContent>\r\n                    </Select>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {loading && (\r\n                <Card>\r\n                    <CardContent className=\"py-10 text-center text-muted-foreground\">\r\n                        Loading user analytics...\r\n                    </CardContent>\r\n                </Card>\r\n            )}\r\n\r\n            {!loading && userStats && (\r\n                <>\r\n                    {/* User Info Card */}\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle>User Profile</CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"flex items-center gap-4\">\r\n                                {userStats.photoURL && (\r\n                                    <img\r\n                                        src={userStats.photoURL}\r\n                                        alt={userStats.displayName}\r\n                                        className=\"w-16 h-16 rounded-full\"\r\n                                    />\r\n                                )}\r\n                                <div>\r\n                                    <h3 className=\"font-semibold text-lg\">{userStats.displayName}</h3>\r\n                                    <p className=\"text-sm text-muted-foreground\">{userStats.email}</p>\r\n                                    {userStats.joinedDate && (\r\n                                        <p className=\"text-xs text-muted-foreground mt-1\">\r\n                                            Joined: {new Date(userStats.joinedDate).toLocaleDateString()}\r\n                                        </p>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Stats Cards */}\r\n                    <div className=\"grid gap-4 md:grid-cols-3\">\r\n                        <Card>\r\n                            <CardHeader className=\"pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Total Posts</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{userStats.totalPosts}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">All time</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                        <Card>\r\n                            <CardHeader className=\"pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Groups Joined</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{userStats.totalGroups}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">Active memberships</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                        <Card>\r\n                            <CardHeader className=\"pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Recent Activity</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{userStats.recentPosts}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">Posts last 7 days</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                    </div>\r\n                </>\r\n            )}\r\n\r\n            {!loading && userStats && userStats._error && (\r\n                <Card className=\"border-red-500 bg-red-50 dark:bg-red-950/10\">\r\n                    <CardContent className=\"py-10 text-center text-red-600 dark:text-red-400\">\r\n                        <div className=\"font-bold\">Analytics Load Error</div>\r\n                        <div className=\"text-lg mt-2\">{userStats._error}</div>\r\n\r\n                        <div className=\"mt-4 p-4 bg-white/50 dark:bg-black/20 rounded text-left font-mono text-xs overflow-auto\">\r\n                            <div>Searched ID: {userStats._searchedId || selectedUserId}</div>\r\n                            {userStats._collection && <div>Collection: {userStats._collection}</div>}\r\n                            {userStats._dbProjectId && <div>Project ID: {userStats._dbProjectId}</div>}\r\n                        </div>\r\n                    </CardContent>\r\n                </Card>\r\n            )}\r\n\r\n            {!loading && (userStats === null || (userStats && !userStats._error && !userStats._isRealData && !userStats.totalPosts)) && selectedUserId && !userStats?._error && (\r\n                <Card>\r\n                    <CardContent className=\"py-10 text-center text-muted-foreground\">\r\n                        <div>User not found or unable to load analytics</div>\r\n                        <div className=\"text-xs mt-2 font-mono\">Debug ID: {selectedUserId}</div>\r\n                        <div className=\"text-xs\">Response was null/empty without specific error.</div>\r\n                    </CardContent>\r\n                </Card>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\analytics\\analytics-dashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[855,858],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[855,858],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchStats'. Either include it or remove the dependency array.","line":38,"column":8,"nodeType":"ArrayExpression","endLine":38,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [fetchStats, timeRange]","fix":{"range":[1642,1653],"text":"[fetchStats, timeRange]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3062,3065],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3062,3065],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { getGlobalAnalytics } from \"@/app/actions/analytics\";\r\nimport { SignInBarChart, UserDistributionPieChart } from \"@/components/admin/analytics/charts\";\r\nimport { Users, Clock, LogIn, Activity } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { UserAnalyticsView } from \"@/components/admin/analytics/user-analytics-view\";\r\n\r\nexport default function AnalyticsDashboard() {\r\n    const [timeRange, setTimeRange] = useState<'day' | 'week' | 'month' | 'year'>('day');\r\n    const [stats, setStats] = useState<any>(null);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    const fetchStats = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await getGlobalAnalytics(timeRange);\r\n            setStats(data);\r\n\r\n            // Only show error toast if we don't have mock data fallback\r\n            if (!data || (!data._isMockData && (!data.totalSignIns && !data.uniqueUsers))) {\r\n                toast.error(\"Failed to load analytics data\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to fetch analytics\", error);\r\n            // Don't show toast - the server action handles fallback to mock data\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchStats();\r\n    }, [timeRange]);\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Mock Data Warning Banner */}\r\n            {stats?._isMockData && (\r\n                <div className=\"bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 flex items-start gap-3\">\r\n                    <Activity className=\"h-5 w-5 text-yellow-500 mt-0.5 flex-shrink-0\" />\r\n                    <div className=\"flex-1\">\r\n                        <h4 className=\"font-semibold text-yellow-500 mb-1\">Demo Mode - Using Mock Data</h4>\r\n                        <p className=\"text-sm text-yellow-500/90\">\r\n                            {stats._error || \"Firestore indexes are missing. Deploy indexes with:\"}\r\n                        </p>\r\n                        <code className=\"text-xs bg-yellow-500/10 px-2 py-1 rounded mt-2 inline-block\">\r\n                            firebase deploy --only firestore:indexes\r\n                        </code>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n                <div>\r\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Analytics Dashboard</h2>\r\n                    <p className=\"text-muted-foreground\">Monitor platform growth and user engagement trends.</p>\r\n                </div>\r\n                <Select value={timeRange} onValueChange={(val: any) => setTimeRange(val)}>\r\n                    <SelectTrigger className=\"w-[180px]\">\r\n                        <SelectValue placeholder=\"Select period\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                        <SelectItem value=\"day\">Today</SelectItem>\r\n                        <SelectItem value=\"week\">This Week</SelectItem>\r\n                        <SelectItem value=\"month\">This Month</SelectItem>\r\n                        <SelectItem value=\"year\">This Year</SelectItem>\r\n                    </SelectContent>\r\n                </Select>\r\n            </div>\r\n\r\n            <Tabs defaultValue=\"global\" className=\"space-y-4\">\r\n                <TabsList>\r\n                    <TabsTrigger value=\"global\">Global Overview</TabsTrigger>\r\n                    <TabsTrigger value=\"individual\">Individual User Analysis</TabsTrigger>\r\n                </TabsList>\r\n\r\n                <TabsContent value=\"global\" className=\"space-y-4\">\r\n                    {/* Metrics Cards */}\r\n                    <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\r\n                        <Card>\r\n                            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Total Sign-ins</CardTitle>\r\n                                <LogIn className=\"h-4 w-4 text-muted-foreground\" />\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{loading ? \"...\" : stats?.totalSignIns}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">In selected period</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                        <Card>\r\n                            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Unique Users</CardTitle>\r\n                                <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{loading ? \"...\" : stats?.uniqueUsers}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">Active in period</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                        <Card>\r\n                            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Avg Session Duration</CardTitle>\r\n                                <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{loading ? \"...\" : (stats?.avgSessionDuration ? Math.round(stats.avgSessionDuration / 60000) + 'm' : '0m')}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">Per session</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                        <Card>\r\n                            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                                <CardTitle className=\"text-sm font-medium\">Avg Frequency</CardTitle>\r\n                                <Activity className=\"h-4 w-4 text-muted-foreground\" />\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"text-2xl font-bold\">{loading ? \"...\" : stats?.avgSessionsPerUser}</div>\r\n                                <p className=\"text-xs text-muted-foreground\">Sessions / User</p>\r\n                            </CardContent>\r\n                        </Card>\r\n                    </div>\r\n\r\n                    <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-7\">\r\n                        <div className=\"col-span-4\">\r\n                            <SignInBarChart data={stats?.chartData || []} title=\"Sign-ins Over Time\" />\r\n                        </div>\r\n                        <div className=\"col-span-3\">\r\n                            {/* Construct Pie Data dynamically if possible, or just mock New/Returning if backend doesn't support yet */}\r\n                            {/* For now we enable the visual container, but data might be placeholder until we add filtering logic */}\r\n                            <UserDistributionPieChart data={[\r\n                                { name: 'Active', value: stats?.uniqueUsers || 0 },\r\n                                { name: 'Sessions', value: stats?.totalSignIns || 0 }\r\n                            ]} />\r\n                        </div>\r\n                    </div>\r\n                </TabsContent>\r\n\r\n                <TabsContent value=\"individual\">\r\n                    <UserAnalyticsView />\r\n                </TabsContent>\r\n            </Tabs>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\analytics\\charts.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[381,384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[381,384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[678,681],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[678,681],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1260,1263],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1260,1263],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4064,4067],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4064,4067],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5815,5818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5815,5818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Bar, BarChart, ResponsiveContainer, XAxis, YAxis, Tooltip, PieChart, Pie, Cell, Legend } from \"recharts\";\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\r\n\r\n// Luminous Palette\r\nconst COLORS = ['#8b5cf6', '#0ea5e9', '#f43f5e', '#f59e0b', '#10b981'];\r\n\r\nconst CustomTooltip = ({ active, payload, label }: any) => {\r\n    if (active && payload && payload.length) {\r\n        return (\r\n            <div className=\"glass-panel px-3 py-2 rounded-lg !border-white/40 shadow-glow-sm text-xs\">\r\n                <p className=\"font-semibold mb-1 text-foreground\">{label}</p>\r\n                {payload.map((entry: any, index: number) => (\r\n                    <div key={index} className=\"flex items-center gap-2 mb-0.5\">\r\n                        <div className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: entry.color }} />\r\n                        <span className=\"text-muted-foreground capitalize\">{entry.name}:</span>\r\n                        <span className=\"font-mono font-medium text-foreground\">{entry.value}</span>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        );\r\n    }\r\n    return null;\r\n};\r\n\r\nexport function SignInBarChart({ data, title }: { data: any[], title: string }) {\r\n    if (!data || data.length === 0) {\r\n        return (\r\n            <Card className=\"glass-card shadow-lg border-0\">\r\n                <CardHeader>\r\n                    <CardTitle>{title}</CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"h-[300px] flex items-center justify-center text-muted-foreground\">\r\n                    No data available for this period.\r\n                </CardContent>\r\n            </Card>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <Card className=\"glass-card border-0 shadow-lg relative overflow-hidden\">\r\n            <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-violet-500 to-fuchsia-500 opacity-50\" />\r\n            <CardHeader>\r\n                <CardTitle>{title}</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n                <div className=\"h-[300px]\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <BarChart data={data}>\r\n                            <defs>\r\n                                <linearGradient id=\"violetGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                    <stop offset=\"0%\" stopColor=\"#8b5cf6\" stopOpacity={1} />\r\n                                    <stop offset=\"100%\" stopColor=\"#c084fc\" stopOpacity={0.6} />\r\n                                </linearGradient>\r\n                            </defs>\r\n                            <XAxis\r\n                                dataKey=\"name\"\r\n                                stroke=\"#a1a1aa\"\r\n                                fontSize={12}\r\n                                tickLine={false}\r\n                                axisLine={false}\r\n                                dy={10}\r\n                            />\r\n                            <YAxis\r\n                                stroke=\"#a1a1aa\"\r\n                                fontSize={12}\r\n                                tickLine={false}\r\n                                axisLine={false}\r\n                                allowDecimals={false}\r\n                            />\r\n                            <Tooltip content={<CustomTooltip />} cursor={{ fill: 'rgba(0,0,0,0.03)' }} />\r\n                            <Bar\r\n                                dataKey=\"value\"\r\n                                fill=\"url(#violetGradient)\"\r\n                                radius={[6, 6, 0, 0]}\r\n                                name=\"Sign-ins\"\r\n                                className=\"filter drop-shadow-[0_0_6px_rgba(139,92,246,0.3)]\"\r\n                            />\r\n                        </BarChart>\r\n                    </ResponsiveContainer>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n\r\n\r\nexport function UserDistributionPieChart({ data }: { data: any[] }) {\r\n    return (\r\n        <Card className=\"glass-card border-0 shadow-lg\">\r\n            <CardHeader>\r\n                <CardTitle>Distribution</CardTitle>\r\n                <CardDescription>User breakdown for this period</CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n                <div className=\"h-[300px]\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <PieChart>\r\n                            <Pie\r\n                                data={data}\r\n                                cx=\"50%\"\r\n                                cy=\"50%\"\r\n                                innerRadius={60}\r\n                                outerRadius={80}\r\n                                paddingAngle={5}\r\n                                dataKey=\"value\"\r\n                                stroke=\"none\"\r\n                            >\r\n                                {data.map((entry, index) => (\r\n                                    <Cell\r\n                                        key={`cell-${index}`}\r\n                                        fill={COLORS[index % COLORS.length]}\r\n                                        className=\"filter drop-shadow-sm hover:drop-shadow-md transition-all duration-300\"\r\n                                    />\r\n                                ))}\r\n                            </Pie>\r\n                            <Tooltip content={<CustomTooltip />} />\r\n                            <Legend verticalAlign=\"bottom\" height={36} iconType=\"circle\" />\r\n                        </PieChart>\r\n                    </ResponsiveContainer>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n\r\nexport function UserActivityChart({ data }: { data: any[] }) {\r\n    if (!data || data.length === 0) {\r\n        return (\r\n            <Card className=\"glass-card border-0 shadow-lg\">\r\n                <CardHeader>\r\n                    <CardTitle>User Activity Trends</CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"h-[300px] flex items-center justify-center text-muted-foreground\">\r\n                    No activity recorded in this period.\r\n                </CardContent>\r\n            </Card>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <Card className=\"glass-card border-0 shadow-lg\">\r\n            <CardHeader>\r\n                <CardTitle>Activity Trends</CardTitle>\r\n                <CardDescription>Sessions and Duration over time</CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n                <div className=\"h-[300px]\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <BarChart data={data} barGap={8}>\r\n                            <defs>\r\n                                <linearGradient id=\"blueGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                    <stop offset=\"0%\" stopColor=\"#3b82f6\" stopOpacity={1} />\r\n                                    <stop offset=\"100%\" stopColor=\"#60a5fa\" stopOpacity={0.6} />\r\n                                </linearGradient>\r\n                                <linearGradient id=\"emeraldGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                    <stop offset=\"0%\" stopColor=\"#10b981\" stopOpacity={1} />\r\n                                    <stop offset=\"100%\" stopColor=\"#34d399\" stopOpacity={0.6} />\r\n                                </linearGradient>\r\n                            </defs>\r\n                            <XAxis dataKey=\"name\" stroke=\"#a1a1aa\" fontSize={12} tickLine={false} axisLine={false} dy={10} />\r\n                            <YAxis yAxisId=\"left\" orientation=\"left\" stroke=\"#3b82f6\" fontSize={12} tickLine={false} axisLine={false} />\r\n                            <YAxis yAxisId=\"right\" orientation=\"right\" stroke=\"#10b981\" fontSize={12} tickLine={false} axisLine={false} />\r\n                            <Tooltip content={<CustomTooltip />} cursor={{ fill: 'rgba(0,0,0,0.03)' }} />\r\n                            <Legend iconType=\"circle\" wrapperStyle={{ paddingTop: '20px' }} />\r\n                            <Bar\r\n                                yAxisId=\"left\"\r\n                                dataKey=\"sessions\"\r\n                                fill=\"url(#blueGradient)\"\r\n                                name=\"Sessions\"\r\n                                radius={[4, 4, 0, 0]}\r\n                                className=\"filter drop-shadow-[0_0_6px_rgba(59,130,246,0.3)]\"\r\n                            />\r\n                            <Bar\r\n                                yAxisId=\"right\"\r\n                                dataKey=\"duration\"\r\n                                fill=\"url(#emeraldGradient)\"\r\n                                name=\"Duration (min)\"\r\n                                radius={[4, 4, 0, 0]}\r\n                                className=\"filter drop-shadow-[0_0_6px_rgba(16,185,129,0.3)]\"\r\n                            />\r\n                        </BarChart>\r\n                    </ResponsiveContainer>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\analytics\\user-analytics-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Input' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Input"},"fix":{"range":[52,98],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RotateCcw' is defined but never used.","line":9,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RotateCcw"},"fix":{"range":[456,467],"text":""},"desc":"Remove unused variable \"RotateCcw\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[985,988],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[985,988],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":33,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2816,2819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2816,2819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6676,6679],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6676,6679],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Search, RotateCcw } from \"lucide-react\";\r\nimport { getUserAnalytics } from \"@/app/actions/analytics\";\r\nimport { UserActivityChart } from \"@/components/admin/analytics/charts\";\r\nimport { toast } from \"sonner\";\r\nimport { format } from \"date-fns\";\r\nimport { UserSearch } from \"@/components/admin/analytics/user-search\";\r\n\r\nexport function UserAnalyticsView() {\r\n    const [userId, setUserId] = useState(\"\");\r\n    const [range, setRange] = useState<'day' | 'week' | 'month' | 'year'>('week');\r\n    const [userData, setUserData] = useState<any>(null);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    const handleSearch = async () => {\r\n        if (!userId.trim()) return;\r\n        setLoading(true);\r\n        try {\r\n            const data = await getUserAnalytics(userId, range);\r\n            if (!data) {\r\n                toast.error(\"User not found or no data available\");\r\n                setUserData(null);\r\n            } else {\r\n                setUserData(data);\r\n            }\r\n        } catch (e) {\r\n            toast.error(\"Failed to fetch user data\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle>User Query</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <div className=\"flex flex-col md:flex-row gap-4\">\r\n                        <div className=\"w-full md:w-[300px]\">\r\n                            <UserSearch onSelect={(id) => {\r\n                                setUserId(id);\r\n                                // Optionally trigger search immediately or waiting for button? \r\n                                // Let's keep the button for now or auto-trigger? \r\n                                // UserSearch sets userId, user still clicks Analyze.\r\n                                // Or better UX: auto trigger. But stick to existing flow for safety.\r\n                            }} />\r\n                        </div>\r\n                        <Button onClick={handleSearch} disabled={loading || !userId}>\r\n                            <Search className=\"mr-2 h-4 w-4\" />\r\n                            {loading ? \"Analyzing...\" : \"Analyze\"}\r\n                        </Button>\r\n\r\n                        <Select value={range} onValueChange={(val: any) => setRange(val)}>\r\n                            <SelectTrigger className=\"w-[180px]\">\r\n                                <SelectValue placeholder=\"Select period\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"day\">Today</SelectItem>\r\n                                <SelectItem value=\"week\">This Week</SelectItem>\r\n                                <SelectItem value=\"month\">This Month</SelectItem>\r\n                                <SelectItem value=\"year\">This Year</SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {\r\n                userData && (\r\n                    <div className=\"space-y-6\">\r\n                        <div className=\"grid gap-4 md:grid-cols-3\">\r\n                            <Card>\r\n                                <CardHeader className=\"pb-2\">\r\n                                    <CardTitle className=\"text-sm font-medium\">Total Sessions</CardTitle>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"text-2xl font-bold\">{userData.summary.totalSignIns}</div>\r\n                                </CardContent>\r\n                            </Card>\r\n                            <Card>\r\n                                <CardHeader className=\"pb-2\">\r\n                                    <CardTitle className=\"text-sm font-medium\">Total Time Spent</CardTitle>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"text-2xl font-bold\">\r\n                                        {Math.round(userData.summary.totalTimeSpent / 60000)}m\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                            <Card>\r\n                                <CardHeader className=\"pb-2\">\r\n                                    <CardTitle className=\"text-sm font-medium\">Avg Session</CardTitle>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"text-2xl font-bold\">\r\n                                        {userData.summary.totalSignIns > 0\r\n                                            ? Math.round((userData.summary.totalTimeSpent / userData.summary.totalSignIns) / 60000)\r\n                                            : 0}m\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n\r\n                        <UserActivityChart data={userData.chartData} />\r\n\r\n                        <Card>\r\n                            <CardHeader>\r\n                                <CardTitle>Session History</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <Table>\r\n                                    <TableHeader>\r\n                                        <TableRow>\r\n                                            <TableHead>Start Time</TableHead>\r\n                                            <TableHead>End Time</TableHead>\r\n                                            <TableHead>Duration</TableHead>\r\n                                            <TableHead>Status</TableHead>\r\n                                            <TableHead>Device</TableHead>\r\n                                        </TableRow>\r\n                                    </TableHeader>\r\n                                    <TableBody>\r\n                                        {userData.history.map((session: any) => (\r\n                                            <TableRow key={session.id}>\r\n                                                <TableCell>{format(new Date(session.startedAt), \"PPpp\")}</TableCell>\r\n                                                <TableCell>{session.endedAt ? format(new Date(session.endedAt), \"PPpp\") : '-'}</TableCell>\r\n                                                <TableCell>{Math.round(session.duration / 60000)} min</TableCell>\r\n                                                <TableCell>{session.status}</TableCell>\r\n                                                <TableCell className=\"max-w-[200px] truncate\" title={session.deviceInfo}>{session.deviceInfo}</TableCell>\r\n                                            </TableRow>\r\n                                        ))}\r\n                                    </TableBody>\r\n                                </Table>\r\n                            </CardContent>\r\n                        </Card>\r\n                    </div>\r\n                )\r\n            }\r\n        </div >\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\analytics\\user-search.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Search' is defined but never used.","line":4,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Search"},"fix":{"range":[80,88],"text":""},"desc":"Remove unused variable \"Search\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[993,996],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[993,996],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1123,1126],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1123,1126],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport * as React from \"react\";\r\nimport { Check, ChevronsUpDown, Search } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n    Command,\r\n    CommandEmpty,\r\n    CommandGroup,\r\n    CommandInput,\r\n    CommandItem,\r\n    CommandList,\r\n} from \"@/components/ui/command\";\r\nimport {\r\n    Popover,\r\n    PopoverContent,\r\n    PopoverTrigger,\r\n} from \"@/components/ui/popover\";\r\nimport { searchUsers } from \"@/app/actions/family\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\n// Simple debounce hook logic implemented inline below\r\n// Let's implement a self-contained one to avoid dependency issues.\r\n\r\nexport function UserSearch({ onSelect }: { onSelect: (userId: string) => void }) {\r\n    const [open, setOpen] = React.useState(false);\r\n    const [value, setValue] = React.useState(\"\");\r\n    const [query, setQuery] = React.useState(\"\");\r\n    const [users, setUsers] = React.useState<any[]>([]);\r\n    const [loading, setLoading] = React.useState(false);\r\n    const [selectedUser, setSelectedUser] = React.useState<any>(null);\r\n\r\n    // simple debounce\r\n    React.useEffect(() => {\r\n        const timer = setTimeout(() => {\r\n            if (query.length > 1) {\r\n                handleSearch(query);\r\n            }\r\n        }, 300);\r\n        return () => clearTimeout(timer);\r\n    }, [query]);\r\n\r\n    const handleSearch = async (term: string) => {\r\n        setLoading(true);\r\n        try {\r\n            const results = await searchUsers(term);\r\n            setUsers(results);\r\n        } catch (error) {\r\n            console.error(\"Search failed\", error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Popover open={open} onOpenChange={setOpen}>\r\n            <PopoverTrigger asChild>\r\n                <Button\r\n                    variant=\"outline\"\r\n                    role=\"combobox\"\r\n                    aria-expanded={open}\r\n                    className=\"w-full justify-between\"\r\n                >\r\n                    {selectedUser ? (\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Avatar className=\"h-6 w-6\">\r\n                                <AvatarImage src={selectedUser.imageUrl || undefined} className=\"object-cover\" />\r\n                                <AvatarFallback>{selectedUser.displayName?.charAt(0)}</AvatarFallback>\r\n                            </Avatar>\r\n                            <span>{selectedUser.displayName}</span>\r\n                        </div>\r\n                    ) : (\r\n                        \"Select user...\"\r\n                    )}\r\n                    <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                </Button>\r\n            </PopoverTrigger>\r\n            <PopoverContent className=\"w-[300px] p-0\">\r\n                <Command shouldFilter={false}>\r\n                    <CommandInput\r\n                        placeholder=\"Search user...\"\r\n                        value={query}\r\n                        onValueChange={setQuery}\r\n                    />\r\n                    <CommandList>\r\n                        {loading && <div className=\"p-4 text-sm text-muted-foreground text-center\">Searching...</div>}\r\n                        {!loading && users.length === 0 && <CommandEmpty>No users found.</CommandEmpty>}\r\n                        <CommandGroup>\r\n                            {users.map((user) => (\r\n                                <CommandItem\r\n                                    key={user.id}\r\n                                    value={user.id}\r\n                                    onSelect={(currentValue) => {\r\n                                        setValue(currentValue === value ? \"\" : currentValue);\r\n                                        setSelectedUser(user);\r\n                                        onSelect(user.id);\r\n                                        setOpen(false);\r\n                                    }}\r\n                                >\r\n                                    <Check\r\n                                        className={cn(\r\n                                            \"mr-2 h-4 w-4\",\r\n                                            value === user.id ? \"opacity-100\" : \"opacity-0\"\r\n                                        )}\r\n                                    />\r\n                                    <Avatar className=\"h-6 w-6 mr-2\">\r\n                                        <AvatarImage src={user.imageUrl || undefined} className=\"object-cover\" />\r\n                                        <AvatarFallback>{user.displayName?.charAt(0)}</AvatarFallback>\r\n                                    </Avatar>\r\n                                    <div className=\"flex flex-col\">\r\n                                        <span className=\"font-medium\">{user.displayName}</span>\r\n                                        <span className=\"text-xs text-muted-foreground\">{user.email}</span>\r\n                                    </div>\r\n                                </CommandItem>\r\n                            ))}\r\n                        </CommandGroup>\r\n                    </CommandList>\r\n                </Command>\r\n            </PopoverContent>\r\n        </Popover>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\audit-log-viewer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1057,1060],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1057,1060],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":78,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":78,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { getAuditStats, generateTestLog } from \"@/app/actions/audit\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { Loader2, Shield, Activity, Clock, AlertTriangle, PlusCircle } from \"lucide-react\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\"\r\nimport { toast } from \"sonner\"\r\nimport { db } from \"@/lib/firebase\"\r\nimport { collection, query, orderBy, limit, onSnapshot } from \"firebase/firestore\"\r\n\r\ninterface AuditLog {\r\n    id: string;\r\n    userId: string;\r\n    userName: string;\r\n    userEmail: string;\r\n    userRole: string;\r\n    action: string;\r\n    targetType?: string;\r\n    targetId?: string;\r\n    targetName?: string;\r\n    details?: Record<string, any>;\r\n    timestamp: Date;\r\n}\r\n\r\nexport function AuditLogViewer() {\r\n    const [logs, setLogs] = useState<AuditLog[]>([])\r\n    const [stats, setStats] = useState<{ last24h: number; last7days: number; total: number } | null>(null)\r\n    const [loading, setLoading] = useState(true)\r\n    const [error, setError] = useState<string | null>(null)\r\n    const [filter, setFilter] = useState<string>(\"all\")\r\n    const [generating, setGenerating] = useState(false)\r\n\r\n    useEffect(() => {\r\n        // Real-time listener for audit logs\r\n        const logsQuery = query(\r\n            collection(db, \"auditLogs\"),\r\n            orderBy(\"timestamp\", \"desc\"),\r\n            limit(100)\r\n        )\r\n\r\n        const unsubscribe = onSnapshot(\r\n            logsQuery,\r\n            (snapshot) => {\r\n                const logsData = snapshot.docs.map(doc => ({\r\n                    id: doc.id,\r\n                    ...doc.data(),\r\n                    timestamp: doc.data().timestamp?.toDate() || new Date(),\r\n                })) as AuditLog[]\r\n\r\n                setLogs(logsData)\r\n                setLoading(false)\r\n                setError(null)\r\n            },\r\n            (error) => {\r\n                console.error(\"Audit logs listener error:\", error)\r\n                setError(error.message || \"Failed to load logs\")\r\n                setLoading(false)\r\n            }\r\n        )\r\n\r\n        // Fetch stats (not real-time)\r\n        getAuditStats().then(setStats).catch(console.error)\r\n\r\n        return () => unsubscribe()\r\n    }, [])\r\n\r\n    const handleGenerateTestLog = async () => {\r\n        setGenerating(true)\r\n        try {\r\n            await generateTestLog()\r\n            toast.success(\"Test log generated!\")\r\n            // No need to fetch - real-time listener will update automatically\r\n        } catch (error) {\r\n            toast.error(\"Failed to generate test log\")\r\n        } finally {\r\n            setGenerating(false)\r\n        }\r\n    }\r\n\r\n    const filteredLogs = filter === \"all\" ? logs : logs.filter(log => {\r\n        if (filter === \"admin\") return log.action.startsWith(\"admin.\")\r\n        if (filter === \"security\") return log.action.startsWith(\"security.\") || log.action.includes(\"block\")\r\n        if (filter === \"user\") return log.action.startsWith(\"user.\")\r\n        if (filter === \"content\") return [\"post\", \"comment\", \"story\", \"event\"].some(t => log.action.includes(t))\r\n        return true\r\n    })\r\n\r\n    const getActionBadgeColor = (action: string) => {\r\n        if (action.startsWith(\"admin.\")) return \"destructive\"\r\n        if (action.includes(\"delete\") || action.includes(\"block\") || action.includes(\"reject\")) return \"destructive\"\r\n        if (action.includes(\"create\") || action.includes(\"approve\")) return \"default\"\r\n        return \"secondary\"\r\n    }\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center p-12\">\r\n                <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Stats Cards */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                <Card>\r\n                    <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                        <CardTitle className=\"text-sm font-medium\">Last 24 Hours</CardTitle>\r\n                        <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        <div className=\"text-2xl font-bold\">{stats?.last24h || 0}</div>\r\n                        <p className=\"text-xs text-muted-foreground\">Actions logged</p>\r\n                    </CardContent>\r\n                </Card>\r\n                <Card>\r\n                    <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                        <CardTitle className=\"text-sm font-medium\">Last 7 Days</CardTitle>\r\n                        <Activity className=\"h-4 w-4 text-muted-foreground\" />\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        <div className=\"text-2xl font-bold\">{stats?.last7days || 0}</div>\r\n                        <p className=\"text-xs text-muted-foreground\">Actions logged</p>\r\n                    </CardContent>\r\n                </Card>\r\n                <Card>\r\n                    <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                        <CardTitle className=\"text-sm font-medium\">Total Logs</CardTitle>\r\n                        <Shield className=\"h-4 w-4 text-muted-foreground\" />\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        <div className=\"text-2xl font-bold\">{stats?.total || 0}</div>\r\n                        <p className=\"text-xs text-muted-foreground\">All time</p>\r\n                    </CardContent>\r\n                </Card>\r\n            </div>\r\n\r\n            {/* Error Banner */}\r\n            {error && (\r\n                <Alert variant=\"destructive\">\r\n                    <AlertTriangle className=\"h-4 w-4\" />\r\n                    <AlertTitle>Error Loading Logs</AlertTitle>\r\n                    <AlertDescription>\r\n                        {error}\r\n                        <div className=\"mt-2\">\r\n                            <span className=\"text-xs opacity-80\">This usually means an index is missing or the collection is empty.</span>\r\n                        </div>\r\n                    </AlertDescription>\r\n                </Alert>\r\n            )}\r\n\r\n            {/* Filter & Logs */}\r\n            <Card>\r\n                <CardHeader>\r\n                    <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n                        <div>\r\n                            <CardTitle>Activity Audit Log</CardTitle>\r\n                            <CardDescription>Track all user and admin actions on the platform</CardDescription>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                onClick={handleGenerateTestLog}\r\n                                disabled={generating}\r\n                            >\r\n                                {generating ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <PlusCircle className=\"mr-2 h-4 w-4\" />}\r\n                                Generate Test Entry\r\n                            </Button>\r\n                            <Select value={filter} onValueChange={setFilter}>\r\n                                <SelectTrigger className=\"w-[180px]\">\r\n                                    <SelectValue placeholder=\"Filter by type\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    <SelectItem value=\"all\">All Actions</SelectItem>\r\n                                    <SelectItem value=\"admin\">Admin Actions</SelectItem>\r\n                                    <SelectItem value=\"security\">Security</SelectItem>\r\n                                    <SelectItem value=\"user\">User Actions</SelectItem>\r\n                                    <SelectItem value=\"content\">Content</SelectItem>\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n                    </div>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <div className=\"space-y-3 max-h-[600px] overflow-y-auto\">\r\n                        {filteredLogs.map((log) => (\r\n                            <div\r\n                                key={log.id}\r\n                                className=\"flex items-start justify-between p-4 border rounded-lg hover:bg-muted/50 transition-colors\"\r\n                            >\r\n                                <div className=\"space-y-1 flex-1\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Badge variant={getActionBadgeColor(log.action)}>\r\n                                            {log.action}\r\n                                        </Badge>\r\n                                        <span className=\"text-sm font-medium\">{log.userName}</span>\r\n                                        <span className=\"text-xs text-muted-foreground\">({log.userRole})</span>\r\n                                    </div>\r\n                                    {log.targetName && (\r\n                                        <p className=\"text-sm text-muted-foreground\">\r\n                                            Target: {log.targetType} - {log.targetName}\r\n                                        </p>\r\n                                    )}\r\n                                    {log.details && Object.keys(log.details).length > 0 && (\r\n                                        <p className=\"text-xs text-muted-foreground font-mono\">\r\n                                            {JSON.stringify(log.details)}\r\n                                        </p>\r\n                                    )}\r\n                                </div>\r\n                                <div className=\"text-xs text-muted-foreground text-right\">\r\n                                    {formatDistanceToNow(new Date(log.timestamp), { addSuffix: true })}\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                        {filteredLogs.length === 0 && (\r\n                            <div className=\"text-center py-12 text-muted-foreground\">\r\n                                No audit logs found\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\birthday-trigger.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\broadcast-panel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1830,1833],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1830,1833],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2532,2535],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2532,2535],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { toast } from \"sonner\";\r\nimport { sendSystemBroadcast, sendAdminMessage } from \"@/app/actions/admin-messaging\";\r\nimport { Loader2, Send } from \"lucide-react\";\r\n\r\nexport function BroadcastPanel() {\r\n    const [mode, setMode] = useState<\"broadcast\" | \"direct\">(\"broadcast\");\r\n    const [title, setTitle] = useState(\"\");\r\n    const [message, setMessage] = useState(\"\");\r\n    const [targetId, setTargetId] = useState(\"\"); // For direct message\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    const handleSend = async () => {\r\n        if (!message) return;\r\n        setLoading(true);\r\n\r\n        try {\r\n            if (mode === \"broadcast\") {\r\n                if (!title) {\r\n                    toast.error(\"Title is required for broadcast\");\r\n                    return;\r\n                }\r\n                const result = await sendSystemBroadcast(title, message);\r\n                toast.success(`Broadcast sent to ${result.count} users!`);\r\n                setTitle(\"\");\r\n                setMessage(\"\");\r\n            } else {\r\n                if (!targetId) {\r\n                    toast.error(\"User ID is required for direct message\");\r\n                    return;\r\n                }\r\n                await sendAdminMessage(targetId, message);\r\n                toast.success(\"Direct message sent!\");\r\n                setMessage(\"\");\r\n                setTargetId(\"\");\r\n            }\r\n        } catch (error: any) {\r\n            console.error(\"Failed to send:\", error);\r\n            toast.error(error.message || \"Failed to send message\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Card className=\"h-full\">\r\n            <CardHeader>\r\n                <CardTitle>Messaging Center</CardTitle>\r\n                <CardDescription>Send system-wide announcements or helper messages.</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n                <div className=\"space-y-2\">\r\n                    <label className=\"text-sm font-medium\">Message Type</label>\r\n                    <Select value={mode} onValueChange={(v: any) => setMode(v)}>\r\n                        <SelectTrigger>\r\n                            <SelectValue />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                            <SelectItem value=\"broadcast\">üì¢ System Broadcast (All Users)</SelectItem>\r\n                            <SelectItem value=\"direct\">üë§ Direct Message (Specific User)</SelectItem>\r\n                        </SelectContent>\r\n                    </Select>\r\n                </div>\r\n\r\n                {mode === \"broadcast\" && (\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-medium\">Notification Title</label>\r\n                        <Input\r\n                            placeholder=\"e.g. System Maintenance or New Feature!\"\r\n                            value={title}\r\n                            onChange={(e) => setTitle(e.target.value)}\r\n                        />\r\n                    </div>\r\n                )}\r\n\r\n                {mode === \"direct\" && (\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-medium\">Target User ID</label>\r\n                        <Input\r\n                            placeholder=\"Paste User ID here...\"\r\n                            value={targetId}\r\n                            onChange={(e) => setTargetId(e.target.value)}\r\n                        />\r\n                    </div>\r\n                )}\r\n\r\n                <div className=\"space-y-2\">\r\n                    <label className=\"text-sm font-medium\">Message Content</label>\r\n                    <Textarea\r\n                        placeholder={mode === \"broadcast\" ? \"Detailed announcement...\" : \"Hello, how can I help you today?\"}\r\n                        value={message}\r\n                        onChange={(e) => setMessage(e.target.value)}\r\n                        rows={4}\r\n                    />\r\n                </div>\r\n\r\n                <Button className=\"w-full\" onClick={handleSend} disabled={loading || !message}>\r\n                    {loading ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Send className=\"mr-2 h-4 w-4\" />}\r\n                    {mode === \"broadcast\" ? \"Send Broadcast\" : \"Send Message\"}\r\n                </Button>\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\edit-user-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1037,1040],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1037,1040],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2200,2203],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2200,2203],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useForm } from \"react-hook-form\"\r\nimport { zodResolver } from \"@hookform/resolvers/zod\"\r\nimport * as z from \"zod\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogFooter,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n    Form,\r\n    FormControl,\r\n    FormField,\r\n    FormItem,\r\n    FormLabel,\r\n    FormMessage,\r\n} from \"@/components/ui/form\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { toast } from \"sonner\"\r\nimport { updateUserProfile } from \"@/app/actions/admin\"\r\nimport { Loader2 } from \"lucide-react\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\n\r\nconst formSchema = z.object({\r\n    firstName: z.string().optional(),\r\n    lastName: z.string().optional(),\r\n    displayName: z.string().optional(),\r\n    email: z.string().email(\"Invalid email address\").optional(),\r\n})\r\n\r\ninterface EditUserDialogProps {\r\n    user: any;\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n}\r\n\r\nexport function EditUserDialog({ user, open, onOpenChange }: EditUserDialogProps) {\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const profileData = user.profileData || {};\r\n\r\n    const formatDuration = (ms: number) => {\r\n        if (!ms) return \"0m\";\r\n        const minutes = Math.floor(ms / 60000);\r\n        const hours = Math.floor(minutes / 60);\r\n        if (hours > 0) return `${hours}h ${minutes % 60}m`;\r\n        return `${minutes}m`;\r\n    };\r\n\r\n    const form = useForm<z.infer<typeof formSchema>>({\r\n        resolver: zodResolver(formSchema),\r\n        defaultValues: {\r\n            firstName: profileData.firstName || \"\",\r\n            lastName: profileData.lastName || \"\",\r\n            displayName: user.displayName || \"\",\r\n            email: user.email || \"\",\r\n        },\r\n    })\r\n\r\n    async function onSubmit(values: z.infer<typeof formSchema>) {\r\n        try {\r\n            setIsSaving(true);\r\n            await updateUserProfile(user.id, values);\r\n            toast.success(\"User profile updated\");\r\n            onOpenChange(false);\r\n        } catch (error: any) {\r\n            toast.error(error.message || \"Failed to update profile\");\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-[425px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Edit User Profile</DialogTitle>\r\n                    <DialogDescription>\r\n                        Make changes to the user's profile and account details.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n                <Tabs defaultValue=\"profile\" className=\"w-full\">\r\n                    <TabsList className=\"grid w-full grid-cols-2 mb-4\">\r\n                        <TabsTrigger value=\"profile\">Profile</TabsTrigger>\r\n                        <TabsTrigger value=\"activity\">Activity</TabsTrigger>\r\n                    </TabsList>\r\n\r\n                    <TabsContent value=\"profile\">\r\n                        <Form {...form}>\r\n                            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <FormField\r\n                                        control={form.control}\r\n                                        name=\"firstName\"\r\n                                        render={({ field }) => (\r\n                                            <FormItem>\r\n                                                <FormLabel>First Name</FormLabel>\r\n                                                <FormControl>\r\n                                                    <Input placeholder=\"First Name\" {...field} />\r\n                                                </FormControl>\r\n                                                <FormMessage />\r\n                                            </FormItem>\r\n                                        )}\r\n                                    />\r\n                                    <FormField\r\n                                        control={form.control}\r\n                                        name=\"lastName\"\r\n                                        render={({ field }) => (\r\n                                            <FormItem>\r\n                                                <FormLabel>Last Name</FormLabel>\r\n                                                <FormControl>\r\n                                                    <Input placeholder=\"Last Name\" {...field} />\r\n                                                </FormControl>\r\n                                                <FormMessage />\r\n                                            </FormItem>\r\n                                        )}\r\n                                    />\r\n                                </div>\r\n                                <FormField\r\n                                    control={form.control}\r\n                                    name=\"displayName\"\r\n                                    render={({ field }) => (\r\n                                        <FormItem>\r\n                                            <FormLabel>Display Name</FormLabel>\r\n                                            <FormControl>\r\n                                                <Input placeholder=\"Display Name\" {...field} />\r\n                                            </FormControl>\r\n                                            <FormMessage />\r\n                                        </FormItem>\r\n                                    )}\r\n                                />\r\n                                <FormField\r\n                                    control={form.control}\r\n                                    name=\"email\"\r\n                                    render={({ field }) => (\r\n                                        <FormItem>\r\n                                            <FormLabel>Email</FormLabel>\r\n                                            <FormControl>\r\n                                                <Input placeholder=\"Email Address\" {...field} />\r\n                                            </FormControl>\r\n                                            <FormMessage />\r\n                                        </FormItem>\r\n                                    )}\r\n                                />\r\n                                <DialogFooter>\r\n                                    <Button type=\"button\" variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n                                        Cancel\r\n                                    </Button>\r\n                                    <Button type=\"submit\" disabled={isSaving}>\r\n                                        {isSaving && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                                        Save Changes\r\n                                    </Button>\r\n                                </DialogFooter>\r\n                            </form>\r\n                        </Form>\r\n                    </TabsContent>\r\n\r\n                    <TabsContent value=\"activity\">\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"grid grid-cols-2 gap-4\">\r\n                                <div className=\"p-4 rounded-lg border bg-card\">\r\n                                    <div className=\"text-sm font-medium text-muted-foreground\">Account Created</div>\r\n                                    <div className=\"text-lg font-bold mt-1\">\r\n                                        {new Date(user.createdAt).toLocaleDateString()}\r\n                                    </div>\r\n                                    <div className=\"text-xs text-muted-foreground\">\r\n                                        {new Date(user.createdAt).toLocaleTimeString()}\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"p-4 rounded-lg border bg-card\">\r\n                                    <div className=\"text-sm font-medium text-muted-foreground\">Total Time Spent</div>\r\n                                    <div className=\"text-lg font-bold mt-1\">{formatDuration(user.totalTimeSpent || 0)}</div>\r\n                                    <div className=\"text-xs text-muted-foreground\">Lifetime usage</div>\r\n                                </div>\r\n                                <div className=\"p-4 rounded-lg border bg-card\">\r\n                                    <div className=\"text-sm font-medium text-muted-foreground\">Last Active</div>\r\n                                    <div className=\"text-lg font-bold mt-1\">\r\n                                        {(() => {\r\n                                            const lastActive = user.lastActiveAt || user.lastSignInAt;\r\n                                            if (!lastActive) return \"Never\";\r\n                                            const date = lastActive.toDate ? lastActive.toDate() : new Date(lastActive);\r\n                                            return date.toLocaleString();\r\n                                        })()}\r\n                                    </div>\r\n                                    {user.lastSignInAt && (\r\n                                        <div className=\"text-xs text-muted-foreground\">\r\n                                            Signed in: {new Date(user.lastSignInAt.toDate ? user.lastSignInAt.toDate() : user.lastSignInAt).toLocaleTimeString()}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                                <div className=\"p-4 rounded-lg border bg-card\">\r\n                                    <div className=\"text-sm font-medium text-muted-foreground\">Current Status</div>\r\n                                    <div className={`text-lg font-bold mt-1 ${user.isOnline ? \"text-green-600\" : \"text-muted-foreground\"}`}>\r\n                                        {user.isOnline ? \"Online\" : \"Offline\"}\r\n                                    </div>\r\n                                    {user.lastSignOffAt && !user.isOnline && (\r\n                                        <div className=\"text-xs text-muted-foreground\">\r\n                                            Left at {new Date(user.lastSignOffAt.toDate ? user.lastSignOffAt.toDate() : user.lastSignOffAt).toLocaleTimeString()}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </TabsContent>\r\n                </Tabs>\r\n            </DialogContent>\r\n        </Dialog>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\admin\\user-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":18,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[577,580],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1511,1514],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1511,1514],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1549,1552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1549,1552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1586,1589],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1586,1589],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleReject' is assigned a value but never used.","line":90,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":90,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3334,3337],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3334,3337],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":122,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3981,3984],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3981,3984],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4240,4243],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4240,4243],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport Link from \"next/link\"\r\nimport {\r\n    Table,\r\n    TableBody,\r\n    TableCell,\r\n    TableHead,\r\n    TableHeader,\r\n    TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { approveUser, rejectUser, toggleUserStatus, updateUserRole, softDeleteUser, restoreUser } from \"@/app/actions/admin\"\r\nimport { toast } from \"sonner\"\r\nimport { MoreHorizontal, Check, X, Shield, Pencil, Trash2, Undo2, Ban, PlayCircle } from \"lucide-react\"\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuItem,\r\n    DropdownMenuLabel,\r\n    DropdownMenuTrigger,\r\n    DropdownMenuSeparator,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport { EditUserDialog } from \"@/components/admin/edit-user-dialog\"\r\nimport {\r\n    AlertDialog,\r\n    AlertDialogAction,\r\n    AlertDialogCancel,\r\n    AlertDialogContent,\r\n    AlertDialogDescription,\r\n    AlertDialogFooter,\r\n    AlertDialogHeader,\r\n    AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { Label } from \"@/components/ui/label\"\r\n\r\ntype User = {\r\n    id: string\r\n    email: string\r\n    role: \"admin\" | \"member\" | \"pending\" | \"rejected\"\r\n    isActive: boolean\r\n    displayName: string | null\r\n    imageUrl: string | null\r\n    profileData: unknown\r\n    createdAt: Date\r\n    lastSignInAt?: any // Timestamp\r\n    lastSignOffAt?: any // Timestamp\r\n    lastActiveAt?: any // Timestamp\r\n    totalTimeSpent?: number // milliseconds\r\n    isOnline?: boolean\r\n    deletedAt?: string | null\r\n}\r\n\r\nfunction formatDuration(ms: number) {\r\n    if (!ms) return \"0m\";\r\n    const minutes = Math.floor(ms / 60000);\r\n    const hours = Math.floor(minutes / 60);\r\n    if (hours > 0) return `${hours}h ${minutes % 60}m`;\r\n    return `${minutes}m`;\r\n}\r\n\r\nexport function UserList({ users }: { users: User[] }) {\r\n    const [showDeleted, setShowDeleted] = useState(false);\r\n    const [editingUser, setEditingUser] = useState<User | null>(null);\r\n    const [deletingUserId, setDeletingUserId] = useState<string | null>(null);\r\n\r\n    const filteredUsers = users.filter(user => {\r\n        if (showDeleted) return true; // Show all (active + deleted)\r\n        return !user.deletedAt; // Show only non-deleted\r\n    }).sort((a, b) => {\r\n        // Simple sort to keep deleted users at bottom if showing mixed, or standard sort\r\n        if (a.deletedAt && !b.deletedAt) return 1;\r\n        if (!a.deletedAt && b.deletedAt) return -1;\r\n        return 0;\r\n    });\r\n\r\n    const handleApprove = async (id: string) => {\r\n        try {\r\n            await approveUser(id)\r\n            toast.success(\"User approved\")\r\n        } catch {\r\n            toast.error(\"Failed to approve\")\r\n        }\r\n    }\r\n\r\n    const handleReject = async (id: string) => {\r\n        try {\r\n            await rejectUser(id)\r\n            toast.success(\"User rejected\")\r\n        } catch {\r\n            toast.error(\"Failed to reject\")\r\n        }\r\n    }\r\n\r\n    const handleUpdateRole = async (id: string, newRole: 'admin' | 'member') => {\r\n        try {\r\n            await updateUserRole(id, newRole)\r\n            toast.success(`Role updated to ${newRole}`)\r\n        } catch (e: any) {\r\n            toast.error(e.message || \"Failed to update role\")\r\n        }\r\n    }\r\n\r\n    const handleToggleStatus = async (id: string, currentStatus: boolean) => {\r\n        try {\r\n            await toggleUserStatus(id, !currentStatus)\r\n            toast.success(`User ${!currentStatus ? 'enabled' : 'disabled'}`)\r\n        } catch {\r\n            toast.error(\"Failed to update status\")\r\n        }\r\n    }\r\n\r\n    const handleSoftDelete = async (id: string) => {\r\n        try {\r\n            await softDeleteUser(id);\r\n            toast.success(\"User deleted (recoverable for 60 days)\");\r\n            setDeletingUserId(null);\r\n        } catch (e: any) {\r\n            toast.error(e.message || \"Failed to delete user\");\r\n        }\r\n    }\r\n\r\n    const handleRestore = async (id: string) => {\r\n        try {\r\n            await restoreUser(id);\r\n            toast.success(\"User restored\");\r\n        } catch (e: any) {\r\n            toast.error(e.message || \"Failed to restore user\");\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"flex justify-between items-center px-2\">\r\n                <div className=\"flex items-center space-x-2\">\r\n                    <Switch\r\n                        id=\"show-deleted\"\r\n                        checked={showDeleted}\r\n                        onCheckedChange={setShowDeleted}\r\n                    />\r\n                    <Label htmlFor=\"show-deleted\">Show Deleted Users</Label>\r\n                </div>\r\n            </div>\r\n\r\n            <Table>\r\n                <TableHeader>\r\n                    <TableRow>\r\n                        <TableHead>Name</TableHead>\r\n                        <TableHead>Email</TableHead>\r\n                        <TableHead>Status</TableHead>\r\n                        <TableHead>Joined</TableHead>\r\n                        <TableHead>Last Active</TableHead>\r\n                        <TableHead>Total Time</TableHead>\r\n                        <TableHead className=\"text-right\">Actions</TableHead>\r\n                    </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                    {filteredUsers.map((user) => {\r\n                        // Type assertion for profileData since it's jsonb\r\n                        const profile = user.profileData as { firstName?: string, lastName?: string, imageUrl?: string } | null;\r\n                        const lowerName = (user.displayName || \"\").toLowerCase();\r\n                        const isGeneric = [\"family member\", \"unnamed user\", \"unknown user\", \"user\", \"member\"].includes(lowerName);\r\n\r\n                        const displayName = (user.displayName && !isGeneric) ? user.displayName : null;\r\n                        const profileName = (profile?.firstName && profile?.lastName) ? `${profile.firstName} ${profile.lastName}`.trim() : null;\r\n                        const emailName = user.email.split('@')[0];\r\n\r\n                        const name = displayName || profileName || emailName || \"Famio Member\";\r\n                        const initials = name.slice(0, 2).toUpperCase();\r\n                        const isDeleted = !!user.deletedAt;\r\n\r\n                        return (\r\n                            <TableRow key={user.id} className={!user.isActive || isDeleted ? \"opacity-60 bg-muted/20\" : \"\"}>\r\n                                <TableCell className=\"flex items-center gap-3\">\r\n                                    <Avatar>\r\n                                        <AvatarImage src={user.imageUrl || profile?.imageUrl} />\r\n                                        <AvatarFallback>{initials}</AvatarFallback>\r\n                                    </Avatar>\r\n                                    <div className=\"flex flex-col\">\r\n                                        <Link href={`/u/${user.id}`} className={`font-medium hover:underline cursor-pointer ${isDeleted ? \"line-through text-muted-foreground\" : \"text-blue-600 dark:text-blue-400\"}`}>\r\n                                            {name}\r\n                                        </Link>\r\n                                        <div className=\"flex gap-2 items-center\">\r\n                                            {user.role === 'admin' && (\r\n                                                <Badge variant=\"default\" className=\"w-fit text-[10px] h-5 px-1.5 mt-1\">\r\n                                                    Admin\r\n                                                </Badge>\r\n                                            )}\r\n                                            {isDeleted && (\r\n                                                <Badge variant=\"destructive\" className=\"w-fit text-[10px] h-5 px-1.5 mt-1\">\r\n                                                    Deleted\r\n                                                </Badge>\r\n                                            )}\r\n                                        </div>\r\n                                        <span className=\"text-xs text-muted-foreground select-all font-mono opacity-50 hover:opacity-100 mt-1\">{user.id}</span>\r\n                                    </div>\r\n                                </TableCell>\r\n                                <TableCell>\r\n                                    <span className=\"text-sm text-gray-500\">{user.email}</span>\r\n                                </TableCell>\r\n                                <TableCell>\r\n                                    {!isDeleted ? (\r\n                                        <Badge variant={user.isActive ? 'outline' : 'secondary'}>\r\n                                            {user.isActive ? 'Active' : 'Disabled'}\r\n                                        </Badge>\r\n                                    ) : (\r\n                                        <span className=\"text-xs text-destructive\">Deleted on {new Date(user.deletedAt!).toLocaleDateString()}</span>\r\n                                    )}\r\n                                </TableCell>\r\n                                <TableCell>{new Date(user.createdAt).toLocaleDateString()}</TableCell>\r\n                                <TableCell>\r\n                                    <div className=\"flex flex-col\">\r\n                                        <span className={user.isOnline ? \"text-green-600 font-medium\" : \"text-muted-foreground\"}>\r\n                                            {(() => {\r\n                                                const lastActive = user.lastActiveAt || user.lastSignInAt;\r\n                                                if (user.isOnline) return \"Online Now\";\r\n                                                if (!lastActive) return \"Never\";\r\n                                                const date = lastActive.toDate ? lastActive.toDate() : new Date(lastActive);\r\n                                                return date.toLocaleString();\r\n                                            })()}\r\n                                        </span>\r\n                                        {/* Optional: Show last sign off if needed, but last active is key */}\r\n                                    </div>\r\n                                </TableCell>\r\n                                <TableCell>\r\n                                    <span className=\"font-mono text-xs\">{formatDuration(user.totalTimeSpent || 0)}</span>\r\n                                </TableCell>\r\n                                <TableCell className=\"text-right\">\r\n                                    <DropdownMenu>\r\n                                        <DropdownMenuTrigger asChild>\r\n                                            <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\r\n                                                <span className=\"sr-only\">Open menu</span>\r\n                                                <MoreHorizontal className=\"h-4 w-4\" />\r\n                                            </Button>\r\n                                        </DropdownMenuTrigger>\r\n                                        <DropdownMenuContent align=\"end\">\r\n                                            <DropdownMenuLabel>Actions</DropdownMenuLabel>\r\n\r\n                                            {/* Approvals */}\r\n                                            {(user.role === 'pending' || user.role === 'rejected') && !isDeleted && (\r\n                                                <DropdownMenuItem onClick={() => handleApprove(user.id)}>\r\n                                                    <Check className=\"mr-2 h-4 w-4 text-green-600\" /> Approve\r\n                                                </DropdownMenuItem>\r\n                                            )}\r\n\r\n                                            {/* General Actions */}\r\n                                            {!isDeleted && (\r\n                                                <DropdownMenuItem onClick={() => setEditingUser(user)}>\r\n                                                    <Pencil className=\"mr-2 h-4 w-4\" /> Edit Profile\r\n                                                </DropdownMenuItem>\r\n                                            )}\r\n\r\n                                            {/* Role Management */}\r\n                                            {!isDeleted && user.role !== 'admin' && (\r\n                                                <DropdownMenuItem onClick={() => handleUpdateRole(user.id, 'admin')}>\r\n                                                    <Shield className=\"mr-2 h-4 w-4 text-blue-600\" /> Make Admin\r\n                                                </DropdownMenuItem>\r\n                                            )}\r\n                                            {!isDeleted && user.role === 'admin' && (\r\n                                                <DropdownMenuItem onClick={() => handleUpdateRole(user.id, 'member')}>\r\n                                                    <Shield className=\"mr-2 h-4 w-4 text-gray-600\" /> Remove Admin\r\n                                                </DropdownMenuItem>\r\n                                            )}\r\n\r\n                                            <DropdownMenuSeparator />\r\n\r\n                                            {/* Status Management */}\r\n                                            {!isDeleted && (\r\n                                                <DropdownMenuItem onClick={() => handleToggleStatus(user.id, user.isActive)}>\r\n                                                    {user.isActive ? (\r\n                                                        <>\r\n                                                            <Ban className=\"mr-2 h-4 w-4 text-orange-600\" /> Disable Account\r\n                                                        </>\r\n                                                    ) : (\r\n                                                        <>\r\n                                                            <PlayCircle className=\"mr-2 h-4 w-4 text-green-600\" /> Enable Account\r\n                                                        </>\r\n                                                    )}\r\n                                                </DropdownMenuItem>\r\n                                            )}\r\n\r\n                                            {/* Soft Delete / Restore */}\r\n                                            {isDeleted ? (\r\n                                                <DropdownMenuItem onClick={() => handleRestore(user.id)}>\r\n                                                    <Undo2 className=\"mr-2 h-4 w-4 text-green-600\" /> Restore User\r\n                                                </DropdownMenuItem>\r\n                                            ) : (\r\n                                                <DropdownMenuItem onClick={() => setDeletingUserId(user.id)} className=\"text-red-600\">\r\n                                                    <Trash2 className=\"mr-2 h-4 w-4\" /> Delete User\r\n                                                </DropdownMenuItem>\r\n                                            )}\r\n\r\n                                        </DropdownMenuContent>\r\n                                    </DropdownMenu>\r\n                                </TableCell>\r\n                            </TableRow>\r\n                        )\r\n                    })}\r\n                </TableBody>\r\n            </Table>\r\n\r\n            {/* Edit Dialog */}\r\n            {editingUser && (\r\n                <EditUserDialog\r\n                    user={editingUser}\r\n                    open={!!editingUser}\r\n                    onOpenChange={(open) => !open && setEditingUser(null)}\r\n                />\r\n            )}\r\n\r\n            {/* Delete Confirmation Dialog */}\r\n            <AlertDialog open={!!deletingUserId} onOpenChange={(open) => !open && setDeletingUserId(null)}>\r\n                <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                        <AlertDialogTitle>Are you sure you want to delete this user?</AlertDialogTitle>\r\n                        <AlertDialogDescription>\r\n                            This action can be reversed within 60 days. The user will be disabled and hidden from the platform.\r\n                        </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                        <AlertDialogCancel>Cancel</AlertDialogCancel>\r\n                        <AlertDialogAction\r\n                            onClick={() => deletingUserId && handleSoftDelete(deletingUserId)}\r\n                            className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\r\n                        >\r\n                            Delete User\r\n                        </AlertDialogAction>\r\n                    </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n            </AlertDialog>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ai\\ai-assistant.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[974,977],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[974,977],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":44,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\"\r\nimport { Sparkles, X, Database, Loader2 } from \"lucide-react\"\r\nimport { seedKnowledgeBase } from \"@/app/actions/ai-agents\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { toast } from \"sonner\"\r\nimport { ChatInterface } from \"@/components/ai/chat-interface\"\r\nimport { useAuth } from \"@/components/auth-provider\"\r\nimport { AgentMode } from \"@/types/ai\"\r\n\r\nexport function AIAssistant() {\r\n    const { user } = useAuth()\r\n    const [isOpen, setIsOpen] = useState(false)\r\n    const [externalContext, setExternalContext] = useState<string | null>(null)\r\n    const [mode, setMode] = useState<AgentMode>('general')\r\n    const [isSeeding, setIsSeeding] = useState(false)\r\n\r\n    // Listen for custom \"Open AI\" events from other components\r\n    useEffect(() => {\r\n        const handleOpenAI = (e: any) => {\r\n            const { context, mode: newMode } = e.detail || {};\r\n            setIsOpen(true);\r\n            if (context) {\r\n                setExternalContext(context);\r\n            }\r\n            if (newMode) {\r\n                setMode(newMode);\r\n            }\r\n        };\r\n\r\n        window.addEventListener('famio:open-ai', handleOpenAI);\r\n        return () => window.removeEventListener('famio:open-ai', handleOpenAI);\r\n    }, []);\r\n\r\n    const handleSeed = async () => {\r\n        setIsSeeding(true)\r\n        try {\r\n            toast.info(\"Updating AI Knowledge Base...\")\r\n            await seedKnowledgeBase()\r\n            toast.success(\"Knowledge Base Updated Successfully!\")\r\n        } catch (e) {\r\n            toast.error(\"Failed to seed knowledge base\")\r\n        } finally {\r\n            setIsSeeding(false)\r\n        }\r\n    }\r\n\r\n    if (!user) return null\r\n\r\n    return (\r\n        <div className=\"fixed bottom-20 md:bottom-6 right-4 md:right-6 z-[30] flex flex-col items-end pointer-events-none\">\r\n            {/* Chat Window */}\r\n            <div className={cn(\r\n                \"mb-4 transition-all duration-300 origin-bottom-right pointer-events-auto\",\r\n                isOpen ? \"scale-100 opacity-100\" : \"scale-0 opacity-0 h-0 w-0 overflow-hidden\"\r\n            )}>\r\n                <Card className=\"w-[350px] md:w-[400px] h-[500px] shadow-2xl border-blue-200 flex flex-col bg-white/95 dark:bg-zinc-900/95 backdrop-blur-sm overflow-hidden\">\r\n                    <CardHeader className=\"bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-3 flex flex-row items-center justify-between shrink-0\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Sparkles className=\"w-4 h-4 text-yellow-300\" />\r\n                            <CardTitle className=\"text-base\">Famio Intelligence</CardTitle>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1\">\r\n                            <Button\r\n                                variant=\"ghost\"\r\n                                size=\"icon\"\r\n                                className=\"h-6 w-6 text-white/50 hover:text-white hover:bg-white/20\"\r\n                                onClick={handleSeed}\r\n                                title=\"Refresh Knowledge Base\"\r\n                                disabled={isSeeding}\r\n                            >\r\n                                {isSeeding ? <Loader2 className=\"w-3 h-3 animate-spin\" /> : <Database className=\"w-3 h-3\" />}\r\n                            </Button>\r\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 text-white hover:bg-white/20\" onClick={() => setIsOpen(false)}>\r\n                                <X className=\"w-4 h-4\" />\r\n                            </Button>\r\n                        </div>\r\n                    </CardHeader>\r\n\r\n                    <CardContent className=\"flex-1 overflow-hidden p-0 relative flex flex-col\">\r\n                        <ChatInterface\r\n                            isCompact={true}\r\n                            externalContext={externalContext}\r\n                            initialMode={mode}\r\n                            onContextHandled={() => setExternalContext(null)}\r\n                        />\r\n                    </CardContent>\r\n                </Card>\r\n            </div>\r\n\r\n            {/* Toggle Button */}\r\n            <Button\r\n                size=\"lg\"\r\n                className={cn(\r\n                    \"h-14 w-14 rounded-full shadow-xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white transition-transform duration-300 pointer-events-auto\",\r\n                    isOpen ? \"rotate-90 scale-0 opacity-0\" : \"scale-100 opacity-100\"\r\n                )}\r\n                onClick={() => setIsOpen(true)}\r\n            >\r\n                <Sparkles className=\"w-6 h-6 animate-pulse\" />\r\n            </Button>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ai\\chat-interface.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Message' is defined but never used.","line":21,"column":6,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setMemoryEnabled' is assigned a value but never used.","line":43,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'transcript' is assigned a value but never used.","line":75,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'voiceState' is assigned a value but never used.","line":117,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":117,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAgentSpeaking' is assigned a value but never used.","line":120,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":120,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Bot, Send, User, Sparkles, Terminal, BookOpen, Briefcase, Mic, MicOff, Volume2, Paperclip, FileText, X } from \"lucide-react\";\r\nimport { AgentMode } from \"@/types/ai\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport { useVoiceConversation } from \"@/hooks/use-voice-conversation\";\r\nimport { useSpeechRecognition } from \"@/hooks/use-speech-recognition\";\r\nimport { useTextToSpeech } from \"@/hooks/use-text-to-speech\";\r\nimport { Linkify } from \"@/components/shared/linkify\";\r\nimport { useChat } from \"@/hooks/use-chat\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\ntype Message = {\r\n    role: 'user' | 'assistant';\r\n    content: string;\r\n};\r\n\r\ntype FileAttachment = {\r\n    name: string;\r\n    content: string;\r\n};\r\n\r\ninterface ChatInterfaceProps {\r\n    isCompact?: boolean;\r\n    externalContext?: string | null;\r\n    initialMode?: AgentMode; // Added prop\r\n    onContextHandled?: () => void;\r\n}\r\n\r\nexport function ChatInterface({ isCompact = false, externalContext, initialMode, onContextHandled }: ChatInterfaceProps) {\r\n    const { user } = useAuth();\r\n    const { t } = useLanguage();\r\n\r\n    // Enhanced chat with memory support\r\n    const [memoryEnabled, setMemoryEnabled] = useState(true);\r\n    const [selectedMode, setSelectedMode] = useState<AgentMode>(initialMode || 'general');\r\n    const chat = useChat({\r\n        userId: user?.uid || 'anonymous',\r\n        memoryEnabled,\r\n        mode: selectedMode,\r\n        model: 'gpt-4o'\r\n    });\r\n\r\n    const [inputValue, setInputValue] = useState(\"\");\r\n    const scrollRef = useRef<HTMLDivElement>(null);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n    const [attachedFile, setAttachedFile] = useState<FileAttachment | null>(null);\r\n\r\n    // Mode is now set directly in useState initialization above\r\n\r\n    // Handle External Context (e.g. \"Ask AI\")\r\n    useEffect(() => {\r\n        if (externalContext) {\r\n            const contextMsg = `[Shared Context]: \"${externalContext.substring(0, 200)}${externalContext.length > 200 ? '...' : ''}\"`;\r\n\r\n            // Send the context as a message using chat hook\r\n            chat.sendMessage(contextMsg);\r\n            if (onContextHandled) onContextHandled();\r\n        }\r\n    }, [externalContext, onContextHandled, chat]);\r\n\r\n    const { speak, stop: stopSpeaking, isSpeaking } = useTextToSpeech({\r\n        useOpenAI: true, // Enable premium OpenAI voices\r\n        voice: 'nova' // Choose from: alloy, echo, fable, onyx, nova, shimmer\r\n    });\r\n\r\n    const { isListening, transcript, startListening, stopListening, isSupported: isSpeechSupported, isProcessing } = useSpeechRecognition({\r\n        onResult: (result) => setInputValue(result), // Transcript is handled here\r\n        useWhisper: true // Enable OpenAI Whisper for superior accuracy\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (scrollRef.current) {\r\n            scrollRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n        }\r\n    }, [chat.messages]);\r\n\r\n    const handleSendMessage = async (e?: React.FormEvent) => {\r\n        e?.preventDefault();\r\n        const textToSend = inputValue.trim();\r\n        if ((!textToSend && !attachedFile) || chat.isLoading) return;\r\n\r\n        let fullMessage = textToSend;\r\n        if (attachedFile) {\r\n            fullMessage = `[Attached File: ${attachedFile.name}]\\n\\n${attachedFile.content}\\n\\n${textToSend}`;\r\n        }\r\n\r\n        // Use chat hook to send message\r\n        await chat.sendMessage(fullMessage);\r\n        setInputValue(\"\");\r\n        setAttachedFile(null);\r\n    };\r\n\r\n    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file) return;\r\n\r\n        // Simple text file read for demo; image handling would need upload logic\r\n        const reader = new FileReader();\r\n        reader.onload = (e) => {\r\n            const content = e.target?.result as string;\r\n            setAttachedFile({ name: file.name, content });\r\n        };\r\n        reader.readAsText(file);\r\n    };\r\n\r\n    // Agentic Voice Conversation Hook\r\n    const {\r\n        state: voiceState,\r\n        isContinuous,\r\n        toggleContinuous,\r\n        isSpeaking: isAgentSpeaking\r\n    } = useVoiceConversation({\r\n        onMessage: async (msg) => {\r\n            const response = await chat.sendMessage(msg);\r\n            return response || \"I processed that, but have no verbal response.\";\r\n        }\r\n    });\r\n\r\n    // NOTE: The above onMessage has a limitation because useChat doesn't return the text.\r\n    // We will fix useChat in the next step to return the response string.\r\n\r\n    const modes = [\r\n        { id: 'general', label: t('ai.mode.general'), icon: Sparkles, desc: t('ai.mode.general') },\r\n        { id: 'architect', label: t('ai.mode.architect'), icon: Terminal, desc: t('ai.mode.architect') },\r\n        { id: 'tutor', label: t('ai.mode.tutor'), icon: BookOpen, desc: t('ai.mode.tutor') },\r\n        { id: 'executive', label: t('ai.mode.executive'), icon: Briefcase, desc: t('ai.mode.executive') },\r\n    ] as const;\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-[calc(100vh-8rem)]\">\r\n            {!isCompact && (\r\n                <div className=\"mb-6 flex justify-between items-start\">\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-bold flex items-center gap-3\">\r\n                            <Bot className=\"w-8 h-8 text-primary\" />\r\n                            {t('ai.title')}\r\n                        </h1>\r\n                        <p className=\"text-muted-foreground mt-1\">\r\n                            Powered by OpenAI and Claude Models\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Mode Selector */}\r\n            <div className={cn(\r\n                \"grid gap-3 mb-6\",\r\n                isCompact ? \"grid-cols-4 gap-1 mb-2\" : \"grid-cols-2 md:grid-cols-4\"\r\n            )}>\r\n                {modes.map((mode) => (\r\n                    <button\r\n                        key={mode.id}\r\n                        onClick={() => setSelectedMode(mode.id as AgentMode)}\r\n                        className={cn(\r\n                            \"flex flex-col items-center p-3 rounded-xl border transition-all hover:bg-muted/50\",\r\n                            isCompact ? \"p-1.5 border-none bg-muted/20\" : \"\",\r\n                            selectedMode === mode.id\r\n                                ? \"border-primary bg-primary/5 text-primary shadow-sm\"\r\n                                : \"border-border bg-card text-muted-foreground\"\r\n                        )}\r\n                        title={mode.label}\r\n                    >\r\n                        <mode.icon className={cn(\"mb-2\", isCompact ? \"w-4 h-4 mb-0\" : \"w-5 h-5\")} />\r\n                        {!isCompact && <span className=\"font-semibold text-sm\">{mode.label}</span>}\r\n                        {!isCompact && <span className=\"text-[10px] opacity-70 hidden md:block\">{mode.desc}</span>}\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Chat Area */}\r\n            <Card className=\"flex-1 flex flex-col overflow-hidden border-border/50 shadow-sm bg-card/50 glass-effect\">\r\n                <ScrollArea className=\"flex-1 p-4\">\r\n                    <div className=\"space-y-6 max-w-3xl mx-auto\">\r\n                        {chat.messages.map((msg, idx) => (\r\n                            <div\r\n                                key={idx}\r\n                                className={cn(\r\n                                    \"flex gap-4 w-full\",\r\n                                    msg.role === 'user' ? \"justify-end\" : \"justify-start\"\r\n                                )}\r\n                            >\r\n                                {msg.role === 'assistant' && (\r\n                                    <Avatar className=\"w-8 h-8 border border-primary/20 bg-primary/10\">\r\n                                        <AvatarFallback><Bot className=\"w-5 h-5 text-primary\" /></AvatarFallback>\r\n                                    </Avatar>\r\n                                )}\r\n\r\n                                <div className={cn(\r\n                                    \"rounded-2xl p-4 max-w-[80%] text-sm leading-relaxed shadow-sm relative group\",\r\n                                    msg.role === 'user'\r\n                                        ? \"bg-primary text-primary-foreground rounded-tr-none\"\r\n                                        : \"bg-white dark:bg-zinc-900 border border-border rounded-tl-none\"\r\n                                )}>\r\n                                    <div className=\"whitespace-pre-wrap font-sans\">\r\n                                        <Linkify text={msg.content} />\r\n                                    </div>\r\n\r\n                                    {/* TTS Button */}\r\n                                    <Button\r\n                                        variant=\"ghost\"\r\n                                        size=\"icon\"\r\n                                        className={cn(\r\n                                            \"absolute -bottom-8 opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6\",\r\n                                            msg.role === 'user' ? \"right-0 text-white\" : \"left-0 text-muted-foreground\"\r\n                                        )}\r\n                                        onClick={() => isSpeaking ? stopSpeaking() : speak(msg.content)}\r\n                                    >\r\n                                        <Volume2 className=\"w-3 h-3\" />\r\n                                    </Button>\r\n                                </div>\r\n\r\n                                {msg.role === 'user' && (\r\n                                    <Avatar className=\"w-8 h-8 border border-border\">\r\n                                        <AvatarImage src={user?.photoURL || undefined} />\r\n                                        <AvatarFallback><User className=\"w-4 h-4\" /></AvatarFallback>\r\n                                    </Avatar>\r\n                                )}\r\n                            </div>\r\n                        ))}\r\n                        <div ref={scrollRef} />\r\n                    </div>\r\n                </ScrollArea>\r\n\r\n                {/* Input Area */}\r\n                <div className=\"p-4 border-t border-border bg-card\">\r\n                    {/* Attached File Preview */}\r\n                    {attachedFile && (\r\n                        <div className=\"max-w-3xl mx-auto mb-2 flex items-center gap-2 p-2 bg-muted/50 rounded-lg border border-border text-xs\">\r\n                            <FileText className=\"w-4 h-4 text-primary\" />\r\n                            <span className=\"font-medium truncate flex-1\">{attachedFile.name} (Preview loaded)</span>\r\n                            <button onClick={() => setAttachedFile(null)} className=\"p-1 hover:bg-destructive/10 hover:text-destructive rounded-full\">\r\n                                <X className=\"w-3 h-3\" />\r\n                            </button>\r\n                        </div>\r\n                    )}\r\n\r\n                    <form onSubmit={handleSendMessage} className=\"max-w-3xl mx-auto relative flex gap-3 items-end\">\r\n                        {/* File Upload Trigger */}\r\n                        <div className=\"flex flex-col gap-2 pb-1\">\r\n                            <input\r\n                                type=\"file\"\r\n                                ref={fileInputRef}\r\n                                className=\"hidden\"\r\n                                onChange={handleFileUpload}\r\n                                accept=\".txt,.md,.js,.ts,.tsx,.json,.csv\"\r\n                            />\r\n                            <Button\r\n                                type=\"button\"\r\n                                variant=\"ghost\"\r\n                                size=\"icon\"\r\n                                className=\"rounded-full text-muted-foreground hover:text-primary\"\r\n                                onClick={() => fileInputRef.current?.click()}\r\n                                title=\"Attach text file\"\r\n                            >\r\n                                <Paperclip className=\"w-5 h-5\" />\r\n                            </Button>\r\n                        </div>\r\n\r\n                        <Input\r\n                            value={inputValue}\r\n                            onChange={(e) => setInputValue(e.target.value)}\r\n                            onKeyDown={(e) => {\r\n                                if (e.key === 'Enter' && !e.shiftKey) {\r\n                                    e.preventDefault();\r\n                                    handleSendMessage();\r\n                                }\r\n                            }}\r\n                            placeholder={isListening ? t('feed.listening') : isProcessing ? \"Processing...\" : `${t('post.ask_ai')} ${selectedMode}...`}\r\n                            className=\"flex-1 min-h-[50px] py-3 pr-12 text-base rounded-2xl bg-white dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800 shadow-sm focus-visible:ring-primary resize-none\"\r\n                            disabled={chat.isLoading}\r\n                            autoFocus\r\n                        />\r\n\r\n                        <div className=\"flex gap-2 pb-1\">\r\n                            {/* Voice Input Trigger */}\r\n                            {isSpeechSupported && (\r\n                                <>\r\n                                    {/* Continuous Mode Toggle */}\r\n                                    <Button\r\n                                        type=\"button\"\r\n                                        variant={isContinuous ? \"destructive\" : \"ghost\"}\r\n                                        size=\"icon\"\r\n                                        className={cn(\r\n                                            \"rounded-full h-[42px] w-[42px] shadow-sm transition-all\",\r\n                                            isContinuous && \"animate-pulse ring-2 ring-red-500 ring-offset-2\"\r\n                                        )}\r\n                                        onClick={toggleContinuous}\r\n                                        title={isContinuous ? \"Stop Agentic Voice Mode\" : \"Start Agentic Voice Mode (Continuous)\"}\r\n                                    >\r\n                                        <Bot className={cn(\"w-6 h-6\", isContinuous ? \"text-white\" : \"text-muted-foreground\")} />\r\n                                    </Button>\r\n\r\n                                    {/* Standard Mic (Push to Talk) - Hide if continuous is on */}\r\n                                    {!isContinuous && (\r\n                                        <Button\r\n                                            type=\"button\"\r\n                                            variant={isListening ? \"destructive\" : \"secondary\"}\r\n                                            size=\"icon\"\r\n                                            className=\"rounded-full h-[42px] w-[42px] shadow-sm\"\r\n                                            onClick={isListening ? stopListening : startListening}\r\n                                            title=\"Hold or click to speak\"\r\n                                        >\r\n                                            {isListening ? (\r\n                                                <MicOff className=\"w-5 h-5 animate-pulse\" />\r\n                                            ) : (\r\n                                                <Mic className=\"w-5 h-5\" />\r\n                                            )}\r\n                                        </Button>\r\n                                    )}\r\n                                </>\r\n                            )}\r\n\r\n                            <Button\r\n                                type=\"submit\"\r\n                                size=\"icon\"\r\n                                disabled={(!inputValue.trim() && !attachedFile) || chat.isLoading}\r\n                                className={cn(\r\n                                    \"h-[42px] w-[42px] rounded-full transition-all shadow-sm\",\r\n                                    (inputValue.trim() || attachedFile) ? \"bg-primary hover:bg-primary/90\" : \"bg-muted text-muted-foreground hover:bg-muted\"\r\n                                )}\r\n                            >\r\n                                {chat.isLoading ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <Send className=\"w-5 h-5\" />}\r\n                            </Button>\r\n                        </div>\r\n                    </form>\r\n                    <p className=\"text-center text-[10px] text-muted-foreground mt-2\">\r\n                        Famio Intelligence can make mistakes. Consider checking important information.\r\n                    </p>\r\n                </div>\r\n            </Card>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ai\\full-screen-chat.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Card' is defined but never used.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Card"},"fix":{"range":[169,213],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AvatarImage' is defined but never used.","line":8,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AvatarImage"},"fix":{"range":[305,318],"text":""},"desc":"Remove unused variable \"AvatarImage\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"User"},"fix":{"range":[353,389],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ImageIcon' is defined but never used.","line":29,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ImageIcon"},"fix":{"range":[1054,1065],"text":""},"desc":"Remove unused variable \"ImageIcon\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadConversations'. Either include it or remove the dependency array.","line":93,"column":8,"nodeType":"ArrayExpression","endLine":93,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [loadConversations, user]","fix":{"range":[3281,3287],"text":"[loadConversations, user]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":201,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7130,7133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7130,7133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":284,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":284,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":295,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":295,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":306,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":306,"endColumn":23},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":555,"column":41,"nodeType":"JSXOpeningElement","endLine":555,"endColumn":116}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { User } from \"lucide-react\";\r\nimport { chatWithAgent } from \"@/app/actions/ai-agents\";\r\nimport { AgentMode, AIModel } from \"@/types/ai\";\r\nimport {\r\n    createConversation,\r\n    getConversations,\r\n    getMessages,\r\n    saveMessage,\r\n    softDeleteConversation,\r\n    restoreConversation,\r\n    permanentlyDeleteConversation,\r\n    getTrash,\r\n    AIConversation\r\n} from \"@/app/actions/ai-chat\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport { useTextToSpeech } from \"@/hooks/use-text-to-speech\";\r\nimport { useSpeechRecognition } from \"@/hooks/use-speech-recognition\";\r\nimport {\r\n    Paperclip, Mic, MicOff, ImageIcon, BookHeart, PanelLeft, Bot, Cpu, Sparkles,\r\n    Terminal, BookOpen, Briefcase, Trash2, ArrowLeft, Volume2, StopCircle,\r\n    LayoutList, Send, X\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuItem,\r\n    DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport { storage } from \"@/lib/firebase\";\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\";\r\n\r\ntype Message = {\r\n    role: 'user' | 'assistant';\r\n    content: string;\r\n};\r\n\r\ninterface FullScreenChatProps {\r\n    initialChatId?: string;\r\n}\r\n\r\nexport function FullScreenChat({ initialChatId }: FullScreenChatProps) {\r\n    const { user } = useAuth();\r\n    const { speak, stop, isSpeaking, isSupported } = useTextToSpeech();\r\n\r\n    // Voice Input Hook\r\n    const {\r\n        isListening,\r\n        startListening,\r\n        stopListening,\r\n        isSupported: isSpeechInputSupported\r\n    } = useSpeechRecognition({\r\n        onResult: (transcript) => setInputValue(prev => {\r\n            // Simple append logic\r\n            if (!prev) return transcript;\r\n            return prev + \" \" + transcript;\r\n        })\r\n    });\r\n\r\n    // State\r\n    const [messages, setMessages] = useState<Message[]>([]);\r\n    const [inputValue, setInputValue] = useState(\"\");\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [selectedMode, setSelectedMode] = useState<AgentMode>('general');\r\n    const [selectedModel, setSelectedModel] = useState<AIModel>('gpt-4o');\r\n\r\n    // Persistence State\r\n    const [conversations, setConversations] = useState<AIConversation[]>([]);\r\n    const [activeConversationId, setActiveConversationId] = useState<string | null>(null);\r\n    const [isSidebarOpen, setIsSidebarOpen] = useState(false);\r\n    const [showTrash, setShowTrash] = useState(false);\r\n    const [trashItems, setTrashItems] = useState<AIConversation[]>([]);\r\n    const [isInitialLoad, setIsInitialLoad] = useState(true);\r\n\r\n    const scrollRef = useRef<HTMLDivElement>(null);\r\n\r\n    // Load Conversations on Mount\r\n    useEffect(() => {\r\n        if (user) {\r\n            loadConversations();\r\n        }\r\n    }, [user]);\r\n\r\n    // Handle Deep Link\r\n    useEffect(() => {\r\n        if (initialChatId) {\r\n            setActiveConversationId(initialChatId);\r\n        }\r\n    }, [initialChatId]);\r\n\r\n    // Load Messages when Active Chat Changes\r\n    useEffect(() => {\r\n        if (activeConversationId) {\r\n            loadMessages(activeConversationId);\r\n        } else {\r\n            // New Chat State\r\n            setMessages([{ role: 'assistant', content: \"Hello! I am your AI Research Assistant. I can help you find information, write code, or explain complex topics. What are we working on today?\" }]);\r\n        }\r\n    }, [activeConversationId]);\r\n\r\n    // Cleanup Speech\r\n    useEffect(() => {\r\n        return () => stop();\r\n    }, [stop]);\r\n\r\n    // Auto-scroll\r\n    useEffect(() => {\r\n        if (scrollRef.current) {\r\n            scrollRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n        }\r\n    }, [messages]);\r\n\r\n    const loadConversations = async () => {\r\n        if (!user) return;\r\n        try {\r\n            const data = await getConversations();\r\n            setConversations(data);\r\n            if (isInitialLoad && data.length > 0) {\r\n                // Optional: Auto-load most recent? For now let's default to New Chat or let user choose\r\n                // setActiveConversationId(data[0].id);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to load history\", error);\r\n        } finally {\r\n            setIsInitialLoad(false);\r\n        }\r\n    };\r\n\r\n    const loadTrash = async () => {\r\n        if (!user) return;\r\n        try {\r\n            const data = await getTrash();\r\n            setTrashItems(data);\r\n        } catch (error) {\r\n            console.error(\"Failed to load trash\", error);\r\n        }\r\n    };\r\n\r\n    const loadMessages = async (chatId: string) => {\r\n        setIsLoading(true);\r\n        try {\r\n            const history = await getMessages(chatId);\r\n            if (history.length > 0) {\r\n                setMessages(history);\r\n            } else {\r\n                // Fallback for empty chat\r\n                setMessages([{ role: 'assistant', content: \"This conversation is empty.\" }]);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to load messages\", error);\r\n            toast.error(\"Failed to load chat history\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    // Media Upload State\r\n    const [attachments, setAttachments] = useState<{ url: string, type: 'image' | 'file', name: string }[]>([]);\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n\r\n\r\n    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (!user) {\r\n            toast.error(\"Please login to upload.\");\r\n            return;\r\n        }\r\n        if (e.target.files && e.target.files[0]) {\r\n            setIsUploading(true);\r\n            try {\r\n                const file = e.target.files[0];\r\n                const isImage = file.type.startsWith('image/');\r\n\r\n                // Use 'users/' path to match existing storage rules\r\n                const storageRef = ref(storage, `users/${user.uid}/ai-uploads/${Date.now()}-${file.name}`);\r\n\r\n                console.log(\"Starting upload...\", storageRef.fullPath);\r\n                const snapshot = await uploadBytes(storageRef, file);\r\n                console.log(\"Upload complete, getting URL...\");\r\n                const url = await getDownloadURL(snapshot.ref);\r\n                console.log(\"URL retrieved:\", url);\r\n\r\n                setAttachments(prev => [...prev, {\r\n                    url,\r\n                    type: isImage ? 'image' : 'file',\r\n                    name: file.name\r\n                }]);\r\n                toast.success(\"Attached successfully\");\r\n            } catch (error: any) {\r\n                console.error(\"Upload failed detailed:\", error);\r\n                // Show detailed error to user\r\n                toast.error(`Upload failed: ${error.message || \"Unknown error\"}`);\r\n            } finally {\r\n                setIsUploading(false);\r\n                // Reset input\r\n                if (fileInputRef.current) fileInputRef.current.value = \"\";\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleSendMessage = async (e?: React.FormEvent) => {\r\n        e?.preventDefault();\r\n        if ((!inputValue.trim() && attachments.length === 0) || isLoading) return;\r\n\r\n        stop(); // Stop speech\r\n        const userMsg = inputValue.trim();\r\n        setInputValue(\"\");\r\n        const sentAttachments = [...attachments];\r\n        setAttachments([]); // Clear immediately\r\n\r\n        // Optimistic UI Update\r\n        const newMessages = [...messages, {\r\n            role: 'user',\r\n            content: userMsg + (sentAttachments.length > 0 ? `\\n[Attached ${sentAttachments.length} file(s)]` : \"\")\r\n        } as Message];\r\n\r\n        setMessages(newMessages);\r\n        setIsLoading(true);\r\n\r\n        try {\r\n            let chatId = activeConversationId;\r\n\r\n            // Create new conversation if none active\r\n            if (!chatId) {\r\n                chatId = await createConversation(userMsg || \"New File Upload\", selectedMode, selectedModel);\r\n                setActiveConversationId(chatId);\r\n                loadConversations();\r\n            } else {\r\n                await saveMessage(chatId, 'user', userMsg);\r\n            }\r\n\r\n            // Get AI Response (Pass Attachments & History)\r\n            // Filter out any potential non-serializable data from messages if needed\r\n            const history = messages.map(m => ({\r\n                role: m.role,\r\n                content: m.content\r\n            }));\r\n\r\n            // Note: Currently backend only fully uses 'image' types for Vision\r\n            const response = await chatWithAgent(userMsg, selectedMode, selectedModel, sentAttachments, history);\r\n            const aiMsg = response || \"I couldn't generate a response.\";\r\n\r\n            await saveMessage(chatId!, 'assistant', aiMsg);\r\n            setMessages(prev => [...prev, { role: 'assistant', content: aiMsg }]);\r\n\r\n        } catch (error) {\r\n            console.error(error);\r\n            setMessages(prev => [...prev, { role: 'assistant', content: \"Sorry, I encountered an error. Please try again.\" }]);\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    // ------------------------------------------------------------------\r\n    // Helpers (Restored)\r\n    // ------------------------------------------------------------------\r\n\r\n    const handleNewChat = () => {\r\n        setActiveConversationId(null);\r\n        setMessages([{ role: 'assistant', content: \"Hello! I am your AI Research Assistant. I can help you find information, write code, or explain complex topics. What are we working on today?\" }]);\r\n        setAttachments([]);\r\n        if (window.innerWidth < 768) setIsSidebarOpen(false);\r\n    };\r\n\r\n    const handleDeleteChat = async (e: React.MouseEvent, chatId: string) => {\r\n        e.stopPropagation();\r\n        try {\r\n            await softDeleteConversation(chatId);\r\n            toast.success(\"Moved to Trash\");\r\n            if (activeConversationId === chatId) handleNewChat();\r\n            loadConversations();\r\n        } catch (error) {\r\n            toast.error(\"Failed to delete\");\r\n        }\r\n    };\r\n\r\n    const handleRestoreChat = async (chatId: string) => {\r\n        try {\r\n            await restoreConversation(chatId);\r\n            toast.success(\"Restored\");\r\n            loadTrash();\r\n            loadConversations();\r\n        } catch (error) {\r\n            toast.error(\"Failed to restore\");\r\n        }\r\n    };\r\n\r\n    const handlePermanentDelete = async (chatId: string) => {\r\n        if (!confirm(\"Permanently delete this chat? This cannot be undone.\")) return;\r\n        try {\r\n            await permanentlyDeleteConversation(chatId);\r\n            toast.success(\"Deleted permanently\");\r\n            loadTrash();\r\n        } catch (error) {\r\n            toast.error(\"Failed to delete\");\r\n        }\r\n    };\r\n\r\n    const modes = [\r\n        { id: 'general', label: 'General', icon: Sparkles, desc: 'Everyday assistance' },\r\n        { id: 'architect', label: 'Architect (Code)', icon: Terminal, desc: 'Software & Code generation' },\r\n        { id: 'tutor', label: 'Tutor', icon: BookOpen, desc: 'Explanations & learning' },\r\n        { id: 'executive', label: 'Executive', icon: Briefcase, desc: 'Concise summaries' },\r\n        { id: 'biographer', label: 'Biographer', icon: BookHeart, desc: 'Memory preservation' },\r\n    ] as const;\r\n\r\n    // ------------------------------------------------------------------\r\n\r\n    return (\r\n        <div className=\"flex h-[calc(100dvh-8rem)] md:h-[calc(100vh-8rem)] mb-20 md:mb-0 overflow-hidden rounded-xl border border-border shadow-sm bg-background\">\r\n\r\n            {/* Sidebar (Existing Code) */}\r\n            {isSidebarOpen && (\r\n                <div\r\n                    className=\"fixed inset-0 bg-black/50 z-40 md:hidden\"\r\n                    onClick={() => setIsSidebarOpen(false)}\r\n                />\r\n            )}\r\n            <div className={cn(\r\n                \"flex flex-col w-64 border-r border-border bg-muted/30 absolute md:static z-50 h-full transition-transform duration-300 md:translate-x-0\",\r\n                isSidebarOpen ? \"translate-x-0\" : \"-translate-x-full\"\r\n            )}>\r\n                <div className=\"p-4 border-b border-border flex justify-between items-center\">\r\n                    <span className=\"font-semibold text-sm\">History</span>\r\n                    <Button variant=\"ghost\" size=\"icon\" className=\"md:hidden\" onClick={() => setIsSidebarOpen(false)}>\r\n                        <X className=\"w-4 h-4\" />\r\n                    </Button>\r\n                </div>\r\n\r\n                <div className=\"p-2\">\r\n                    <Button onClick={handleNewChat} className=\"w-full justify-start gap-2\" variant={!activeConversationId ? \"secondary\" : \"ghost\"}>\r\n                        <Sparkles className=\"w-4 h-4 text-primary\" />\r\n                        New Research\r\n                    </Button>\r\n                </div>\r\n\r\n                <ScrollArea className=\"flex-1 px-2\">\r\n                    {showTrash ? (\r\n                        <div className=\"space-y-1\">\r\n                            <div className=\"px-2 py-1 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2\">Trash</div>\r\n                            {trashItems.length === 0 && <p className=\"text-xs text-muted-foreground p-2 text-center\">Trash is empty</p>}\r\n                            {trashItems.map(chat => (\r\n                                <div key={chat.id} className=\"flex flex-col gap-1 p-2 rounded-lg hover:bg-muted/50 text-sm group border border-transparent hover:border-border\">\r\n                                    <div className=\"font-medium truncate\">{chat.title}</div>\r\n                                    <div className=\"text-xs text-muted-foreground\">{formatDistanceToNow(chat.updatedAt)} ago</div>\r\n                                    <div className=\"flex gap-2 mt-1\">\r\n                                        <Button size=\"sm\" variant=\"outline\" className=\"h-6 text-[10px]\" onClick={() => handleRestoreChat(chat.id)}>Restore</Button>\r\n                                        <Button size=\"sm\" variant=\"destructive\" className=\"h-6 text-[10px]\" onClick={() => handlePermanentDelete(chat.id)}>Delete</Button>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"space-y-1\">\r\n                            <div className=\"px-2 py-1 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2\">Recent</div>\r\n                            {conversations.length === 0 && <p className=\"text-xs text-muted-foreground p-2 text-center\">No history yet</p>}\r\n                            {conversations.map(chat => (\r\n                                <button\r\n                                    key={chat.id}\r\n                                    onClick={() => {\r\n                                        setActiveConversationId(chat.id);\r\n                                        if (window.innerWidth < 768) setIsSidebarOpen(false);\r\n                                    }}\r\n                                    className={cn(\r\n                                        \"w-full text-left p-2 rounded-lg text-sm transition-colors flex items-center justify-between group\",\r\n                                        activeConversationId === chat.id ? \"bg-primary/10 text-primary font-medium\" : \"hover:bg-muted text-muted-foreground hover:text-foreground\"\r\n                                    )}\r\n                                >\r\n                                    <div className=\"truncate flex-1 pr-2\">\r\n                                        {chat.title}\r\n                                    </div>\r\n                                    <div className=\"opacity-0 group-hover:opacity-100 transition-opacity flex items-center\" onClick={(e) => handleDeleteChat(e, chat.id)}>\r\n                                        <Trash2 className=\"w-3.5 h-3.5 text-muted-foreground hover:text-red-500\" />\r\n                                    </div>\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </ScrollArea>\r\n\r\n                <div className=\"p-2 border-t border-border\">\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        className=\"w-full justify-start gap-2 text-muted-foreground\"\r\n                        onClick={() => {\r\n                            setShowTrash(!showTrash);\r\n                            if (!showTrash) loadTrash();\r\n                        }}\r\n                    >\r\n                        {showTrash ? <ArrowLeft className=\"w-4 h-4\" /> : <Trash2 className=\"w-4 h-4\" />}\r\n                        {showTrash ? \"Back to History\" : \"Trash & Recovery\"}\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Chat Area */}\r\n            <div className=\"flex-1 flex flex-col min-w-0 bg-card/50 glass-effect\">\r\n                {/* Header (Existing Code) */}\r\n                <div className=\"h-14 border-b border-border flex items-center px-4 justify-between bg-card/80 backdrop-blur-sm\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <Button variant=\"ghost\" size=\"icon\" className=\"md:hidden -ml-2\" onClick={() => setIsSidebarOpen(true)}>\r\n                            <PanelLeft className=\"w-5 h-5\" />\r\n                        </Button>\r\n                        <Bot className=\"w-5 h-5 text-primary\" />\r\n                        <h2 className=\"font-semibold text-sm md:text-base truncate\">\r\n                            {activeConversationId ? (conversations.find(c => c.id === activeConversationId)?.title || \"Research Session\") : \"New Research\"}\r\n                        </h2>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                        {/* Model Selector */}\r\n                        <DropdownMenu modal={false}>\r\n                            <DropdownMenuTrigger asChild>\r\n                                <Button variant=\"outline\" size=\"sm\" className=\"h-7 text-xs gap-1 flex border-dashed\">\r\n                                    <Cpu className=\"w-3.5 h-3.5\" />\r\n                                    <span className=\"md:hidden\">Model</span>\r\n                                    <span className=\"hidden md:inline\">\r\n                                        {selectedModel === 'gpt-4o' ? 'GPT-4o' : (selectedModel === 'claude-3-5-sonnet-20240620' ? 'Claude 3.5' : (selectedModel || 'Select Model'))}\r\n                                    </span>\r\n                                </Button>\r\n                            </DropdownMenuTrigger>\r\n                            <DropdownMenuContent align=\"end\">\r\n                                <DropdownMenuItem key=\"gpt-4o\" onClick={() => setSelectedModel('gpt-4o')} className=\"gap-2\">\r\n                                    <span>GPT-4o</span>\r\n                                    {selectedModel === 'gpt-4o' && <span className=\"opacity-50 text-xs\">(Active)</span>}\r\n                                </DropdownMenuItem>\r\n                                <DropdownMenuItem onClick={() => setSelectedModel('gpt-4o-mini')} className=\"gap-2\">\r\n                                    <span>GPT-4o Mini</span>\r\n                                    {selectedModel === 'gpt-4o-mini' && <span className=\"opacity-50 text-xs\">(Active)</span>}\r\n                                </DropdownMenuItem>\r\n                                <DropdownMenuItem onClick={() => setSelectedModel('o1-preview')} className=\"gap-2\">\r\n                                    <span>o1 Preview (Reasoning)</span>\r\n                                    {selectedModel === 'o1-preview' && <span className=\"opacity-50 text-xs\">(Active)</span>}\r\n                                </DropdownMenuItem>\r\n                                <DropdownMenuItem onClick={() => setSelectedModel('claude-3-5-sonnet-20240620')} className=\"gap-2\">\r\n                                    <span>Claude 3.5 Sonnet</span>\r\n                                    {selectedModel === 'claude-3-5-sonnet-20240620' && <span className=\"opacity-50 text-xs\">(Active)</span>}\r\n                                </DropdownMenuItem>\r\n                                <DropdownMenuItem onClick={() => setSelectedModel('gemini-1.5-pro')} className=\"gap-2\">\r\n                                    <span>Gemini 1.5 Pro</span>\r\n                                    {selectedModel === 'gemini-1.5-pro' && <span className=\"opacity-50 text-xs\">(Active)</span>}\r\n                                </DropdownMenuItem>\r\n                            </DropdownMenuContent>\r\n                        </DropdownMenu>\r\n\r\n                        <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            onClick={handleNewChat}\r\n                            title=\"New Conversation\"\r\n                            className=\"hidden md:flex\"\r\n                        >\r\n                            <Sparkles className=\"w-5 h-5 text-primary\" />\r\n                        </Button>\r\n\r\n                        {/* Mode Selector - Compact */}\r\n                        <div className=\"flex bg-muted/50 rounded-lg p-0.5\">\r\n                            {modes.map((mode) => (\r\n                                <button\r\n                                    key={mode.id}\r\n                                    onClick={() => setSelectedMode(mode.id as AgentMode)}\r\n                                    className={cn(\r\n                                        \"p-1.5 rounded-md transition-all\",\r\n                                        selectedMode === mode.id\r\n                                            ? \"bg-primary text-primary-foreground shadow-sm\"\r\n                                            : \"text-muted-foreground hover:text-foreground\"\r\n                                    )}\r\n                                    title={mode.label}\r\n                                >\r\n                                    <mode.icon className=\"w-4 h-4\" />\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Messages */}\r\n                <ScrollArea className=\"flex-1 p-4\">\r\n                    <div className=\"space-y-6 max-w-3xl mx-auto pb-4\">\r\n                        {messages.map((msg, idx) => (\r\n                            <div\r\n                                key={idx}\r\n                                className={cn(\r\n                                    \"flex gap-4 w-full group relative animate-in fade-in slide-in-from-bottom-2\",\r\n                                    msg.role === 'user' ? \"justify-end\" : \"justify-start\"\r\n                                )}\r\n                            >\r\n                                {msg.role === 'assistant' && (\r\n                                    <Avatar className=\"w-8 h-8 border border-primary/20 bg-primary/10 flex-shrink-0 mt-1\">\r\n                                        <AvatarFallback><Bot className=\"w-5 h-5 text-primary\" /></AvatarFallback>\r\n                                    </Avatar>\r\n                                )}\r\n\r\n                                <div className={cn(\r\n                                    \"rounded-2xl p-4 max-w-[85%] md:max-w-[75%] leading-relaxed shadow-sm relative\",\r\n                                    msg.role === 'user'\r\n                                        ? \"bg-primary text-primary-foreground rounded-tr-none\"\r\n                                        : \"bg-white dark:bg-zinc-900 border border-border rounded-tl-none pr-10\"\r\n                                )}>\r\n                                    <div className=\"whitespace-pre-wrap font-sans text-sm\">\r\n                                        {msg.content}\r\n                                    </div>\r\n\r\n                                    {msg.role === 'assistant' && isSupported && (\r\n                                        <div className=\"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                                            <Button\r\n                                                variant=\"ghost\"\r\n                                                size=\"icon\"\r\n                                                className=\"h-6 w-6 rounded-full hover:bg-primary/10 hover:text-primary\"\r\n                                                onClick={() => speak(msg.content)}\r\n                                            >\r\n                                                <Volume2 className=\"h-3.5 w-3.5\" />\r\n                                                <span className=\"sr-only\">Read Aloud</span>\r\n                                            </Button>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                        {isLoading && (\r\n                            <div className=\"flex gap-4 w-full justify-start animate-pulse\">\r\n                                <Avatar className=\"w-8 h-8 border border-primary/20 bg-primary/10 flex-shrink-0\">\r\n                                    <AvatarFallback><Bot className=\"w-5 h-5 text-primary\" /></AvatarFallback>\r\n                                </Avatar>\r\n                                <div className=\"bg-white dark:bg-zinc-900 border border-border rounded-2xl rounded-tl-none p-4 flex items-center gap-2\">\r\n                                    <div className=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce\" style={{ animationDelay: \"0ms\" }} />\r\n                                    <div className=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce\" style={{ animationDelay: \"150ms\" }} />\r\n                                    <div className=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce\" style={{ animationDelay: \"300ms\" }} />\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                        <div ref={scrollRef} />\r\n                    </div>\r\n                </ScrollArea>\r\n\r\n                {/* Input Area */}\r\n                <div className=\"p-4 border-t border-border bg-card/80 backdrop-blur-sm\">\r\n                    {attachments.length > 0 && (\r\n                        <div className=\"flex gap-2 mb-2 px-2 max-w-3xl mx-auto\">\r\n                            {attachments.map((file, i) => (\r\n                                <div key={i} className=\"relative group bg-muted rounded-md overflow-hidden border border-border w-16 h-16 flex items-center justify-center\">\r\n                                    {file.type === 'image' ? (\r\n                                        <img src={file.url} alt=\"preview\" className=\"w-full h-full object-cover\" />\r\n                                    ) : (\r\n                                        <LayoutList className=\"w-6 h-6 text-muted-foreground\" />\r\n                                    )}\r\n                                    <button\r\n                                        onClick={() => setAttachments(prev => prev.filter((_, idx) => idx !== i))}\r\n                                        className=\"absolute top-0 right-0 bg-black/50 text-white rounded-bl-md p-0.5 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                                    >\r\n                                        <X className=\"w-3 h-3\" />\r\n                                    </button>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                    <form onSubmit={handleSendMessage} className=\"max-w-3xl mx-auto relative flex gap-3\">\r\n                        {isSpeaking && (\r\n                            <div className=\"absolute -top-12 left-1/2 -translate-x-1/2 z-10\">\r\n                                <Button\r\n                                    type=\"button\"\r\n                                    variant=\"destructive\"\r\n                                    size=\"sm\"\r\n                                    className=\"rounded-full shadow-lg gap-2\"\r\n                                    onClick={stop}\r\n                                >\r\n                                    <StopCircle className=\"h-4 w-4 animate-pulse\" />\r\n                                    Stop Speaking\r\n                                </Button>\r\n                            </div>\r\n                        )}\r\n\r\n                        <input\r\n                            type=\"file\"\r\n                            hidden\r\n                            ref={fileInputRef}\r\n                            onChange={handleFileSelect}\r\n                            // Accept common formats. User asked for \"all formats\", so maybe don't limit accepting but show warning if not supported??\r\n                            // For images: image/*\r\n                            // For docs: .pdf, .docx, .txt\r\n                            accept=\"image/*,.pdf,.doc,.docx,.txt\"\r\n                        />\r\n\r\n                        <Input\r\n                            value={inputValue}\r\n                            onChange={(e) => setInputValue(e.target.value)}\r\n                            placeholder={isListening ? \"Listening...\" : `Message ${selectedMode} agent...`}\r\n                            className=\"flex-1 min-h-[50px] pl-10 pr-24 text-base rounded-full bg-white dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800 shadow-sm focus-visible:ring-primary\"\r\n                            disabled={isLoading}\r\n                            autoFocus\r\n                        />\r\n                        <Button\r\n                            type=\"button\"\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            className=\"absolute left-2 top-1.5 text-muted-foreground hover:text-foreground\"\r\n                            onClick={() => fileInputRef.current?.click()}\r\n                            disabled={isUploading}\r\n                        >\r\n                            {isUploading ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <Paperclip className=\"w-5 h-5\" />}\r\n                        </Button>\r\n\r\n                        {isSpeechInputSupported && (\r\n                            <Button\r\n                                type=\"button\"\r\n                                variant=\"ghost\"\r\n                                size=\"icon\"\r\n                                className={cn(\r\n                                    \"absolute right-12 top-1.5 h-[38px] w-[38px] rounded-full transition-all\",\r\n                                    isListening ? \"text-red-500 bg-red-50 animate-pulse\" : \"text-muted-foreground hover:text-foreground\"\r\n                                )}\r\n                                onClick={isListening ? stopListening : startListening}\r\n                            >\r\n                                {isListening ? <MicOff className=\"w-5 h-5\" /> : <Mic className=\"w-5 h-5\" />}\r\n                            </Button>\r\n                        )}\r\n\r\n                        <Button\r\n                            type=\"submit\"\r\n                            size=\"icon\"\r\n                            disabled={(!inputValue.trim() && attachments.length === 0) || isLoading || isUploading}\r\n                            className={cn(\r\n                                \"absolute right-1.5 top-1.5 h-[38px] w-[38px] rounded-full transition-all\",\r\n                                (inputValue.trim() || attachments.length > 0) ? \"bg-primary hover:bg-primary/90\" : \"bg-muted text-muted-foreground hover:bg-muted\"\r\n                            )}\r\n                        >\r\n                            {isLoading ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <Send className=\"w-5 h-5\" />}\r\n                        </Button>\r\n                    </form>\r\n                    <p className=\"text-center text-[10px] text-muted-foreground mt-2\">\r\n                        AI responses are auto-saved. Visual analysis available with GPT-4o.\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ai\\memory-controls.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ai\\voice-provider.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'newState' is defined but never used.","line":33,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { createContext, useContext, ReactNode, useCallback } from \"react\";\r\nimport { useVoiceConversation } from \"@/hooks/use-voice-conversation\";\r\nimport { chatWithAgent } from \"@/app/actions/ai-agents\";\r\n\r\ninterface VoiceContextType {\r\n    state: 'idle' | 'listening' | 'processing' | 'speaking';\r\n    isSpeaking: boolean;\r\n    isListening: boolean;\r\n    isContinuous: boolean;\r\n    toggleContinuous: () => void;\r\n}\r\n\r\nconst VoiceContext = createContext<VoiceContextType | undefined>(undefined);\r\n\r\nexport function VoiceProvider({ children }: { children: ReactNode }) {\r\n\r\n    // Adapter to call the server action from the hook\r\n    const handleMessage = useCallback(async (message: string) => {\r\n        try {\r\n            // Default to general mode, gpt-4o\r\n            const response = await chatWithAgent(message, 'general', 'gpt-4o');\r\n            return response || \"I'm sorry, I didn't catch that.\";\r\n        } catch (error) {\r\n            console.error(\"Voice Agent Error:\", error);\r\n            return \"I'm having trouble connecting right now.\";\r\n        }\r\n    }, []);\r\n\r\n    const voice = useVoiceConversation({\r\n        onMessage: handleMessage,\r\n        onStateChange: (newState) => {\r\n            // Optional: Log state changes or trigger other global effects\r\n            // console.log(\"Voice State:\", newState);\r\n        }\r\n    });\r\n\r\n    return (\r\n        <VoiceContext.Provider value={{\r\n            state: voice.state,\r\n            isSpeaking: voice.isSpeaking,\r\n            isListening: voice.state === 'listening',\r\n            isContinuous: voice.isContinuous,\r\n            toggleContinuous: voice.toggleContinuous\r\n        }}>\r\n            {children}\r\n        </VoiceContext.Provider>\r\n    );\r\n}\r\n\r\nexport function useVoice() {\r\n    const context = useContext(VoiceContext);\r\n    if (!context) {\r\n        throw new Error(\"useVoice must be used within a VoiceProvider\");\r\n    }\r\n    return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ai\\voice-status-indicator.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isBroadcasting' is defined but never used.","line":17,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { motion } from \"framer-motion\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\ninterface VoiceStatusIndicatorProps {\r\n    state: 'idle' | 'listening' | 'processing' | 'speaking';\r\n    isBroadcasting?: boolean;\r\n    onClick?: () => void;\r\n    className?: string;\r\n}\r\n\r\nexport function VoiceStatusIndicator({\r\n    state,\r\n    isBroadcasting,\r\n    onClick,\r\n    className\r\n}: VoiceStatusIndicatorProps) {\r\n    const { t } = useLanguage();\r\n\r\n    // Status color mapping\r\n    const getStatusColor = () => {\r\n        switch (state) {\r\n            case 'listening': return \"bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.6)]\";\r\n            case 'processing': return \"bg-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.6)]\";\r\n            case 'speaking': return \"bg-primary shadow-[0_0_15px_rgba(111,76,255,0.6)]\";\r\n            default: return \"bg-zinc-400 group-hover:bg-zinc-600 dark:bg-zinc-600 dark:group-hover:bg-zinc-400\"; // Idle\r\n        }\r\n    };\r\n\r\n    const getStatusText = () => {\r\n        switch (state) {\r\n            case 'listening': return t('ai.status.listening');\r\n            case 'processing': return t('ai.status.processing');\r\n            case 'speaking': return t('ai.status.speaking');\r\n            default: return t('ai.status.ready');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <button\r\n            onClick={onClick}\r\n            className={cn(\r\n                \"group relative flex items-center justify-center p-2 rounded-xl transition-all duration-300\",\r\n                \"hover:bg-zinc-100 dark:hover:bg-white/5 border border-transparent hover:border-zinc-200 dark:hover:border-white/10\",\r\n                className\r\n            )}\r\n        >\r\n            {/* Orb Container */}\r\n            <div className=\"relative w-8 h-8 flex items-center justify-center\">\r\n                {/* Core Orb */}\r\n                <motion.div\r\n                    className={cn(\r\n                        \"w-3 h-3 rounded-full transition-colors duration-300\",\r\n                        getStatusColor()\r\n                    )}\r\n                    animate={state === 'listening' ? {\r\n                        scale: [1, 1.2, 1],\r\n                        opacity: [1, 0.8, 1]\r\n                    } : state === 'speaking' ? {\r\n                        scale: [1, 1.5, 1],\r\n                    } : {\r\n                        scale: 1\r\n                    }}\r\n                    transition={{\r\n                        duration: 1.5,\r\n                        repeat: Infinity,\r\n                        ease: \"easeInOut\"\r\n                    }}\r\n                />\r\n\r\n                {/* Ripple Effect for Listening */}\r\n                {state === 'listening' && (\r\n                    <motion.div\r\n                        className=\"absolute inset-0 rounded-full border border-red-500/30\"\r\n                        animate={{ scale: [1, 2], opacity: [0.5, 0] }}\r\n                        transition={{ duration: 1.5, repeat: Infinity }}\r\n                    />\r\n                )}\r\n\r\n                {/* Processing Spinner Ring */}\r\n                {state === 'processing' && (\r\n                    <motion.div\r\n                        className=\"absolute inset-0 rounded-full border-t-2 border-yellow-400\"\r\n                        animate={{ rotate: 360 }}\r\n                        transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\r\n                    />\r\n                )}\r\n\r\n                {/* Speaking Waveform Sim (Simple bars) */}\r\n                {state === 'speaking' && (\r\n                    <div className=\"absolute inset-0 flex items-center justify-center gap-0.5\">\r\n                        {[1, 2, 3].map((i) => (\r\n                            <motion.div\r\n                                key={i}\r\n                                className=\"w-0.5 bg-primary/80\"\r\n                                animate={{ height: [4, 12, 4] }}\r\n                                transition={{\r\n                                    duration: 0.5,\r\n                                    repeat: Infinity,\r\n                                    delay: i * 0.1\r\n                                }}\r\n                            />\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Expanded Label (handled by parent layout usually, but we can include text here) */}\r\n            <div className=\"ml-3 overflow-hidden hidden group-hover:block md:group-[.expanded]:block\">\r\n                <span className={cn(\r\n                    \"text-xs font-medium uppercase tracking-wider\",\r\n                    state !== 'idle' ? \"text-zinc-900 dark:text-white\" : \"text-zinc-500 dark:text-zinc-500\"\r\n                )}>\r\n                    {getStatusText()}\r\n                </span>\r\n            </div>\r\n        </button>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\auth-provider.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[435,438],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[435,438],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[962,965],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[962,965],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'router'. Either include it or remove the dependency array.","line":90,"column":8,"nodeType":"ArrayExpression","endLine":90,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [router]","fix":{"range":[3403,3405],"text":"[router]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { createContext, useContext, useEffect, useState } from \"react\"\r\nimport { getAuth, onAuthStateChanged, User, signOut as firebaseSignOut } from \"firebase/auth\"\r\nimport { createSession, deleteSession, syncUserToDb } from \"@/app/actions/auth\"\r\nimport { useRouter } from \"next/navigation\"\r\n\r\nimport \"@/lib/firebase\"; // Ensure firebase is initialized\r\n\r\ntype AuthContextType = {\r\n    user: User | null\r\n    profile: any | null\r\n    loading: boolean\r\n    signOut: () => Promise<void>\r\n    refreshUser: () => Promise<void>\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType>({\r\n    user: null,\r\n    profile: null,\r\n    loading: true,\r\n    signOut: async () => { },\r\n    refreshUser: async () => { },\r\n})\r\n\r\nexport const useAuth = () => useContext(AuthContext)\r\n\r\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\r\n    const [user, setUser] = useState<User | null>(null)\r\n    const [profile, setProfile] = useState<any | null>(null)\r\n    const [loading, setLoading] = useState(true)\r\n    const router = useRouter()\r\n\r\n    useEffect(() => {\r\n        const auth = getAuth()\r\n        let profileUnsubscribe: (() => void) | null = null;\r\n\r\n        const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {\r\n            if (firebaseUser) {\r\n                setUser(firebaseUser)\r\n                try {\r\n                    // Sync user to DB first\r\n                    console.log(\"[AuthProvider] Syncing user to DB:\", firebaseUser.uid);\r\n\r\n                    const nameParts = (firebaseUser.displayName || \"\").split(' ');\r\n                    const firstName = nameParts[0] || \"Famio\";\r\n                    const lastName = nameParts.slice(1).join(' ') || \"Member\";\r\n\r\n                    await syncUserToDb(\r\n                        firebaseUser.uid,\r\n                        firebaseUser.email || \"\",\r\n                        firebaseUser.displayName || firebaseUser.email?.split('@')[0] || \"User\",\r\n                        firstName,\r\n                        lastName,\r\n                        firebaseUser.emailVerified\r\n                    );\r\n                    console.log(\"[AuthProvider] User synced.\");\r\n                    // Then create session\r\n                    await createSession(firebaseUser.uid)\r\n\r\n                    // Listen to profile\r\n                    const { db } = await import(\"@/lib/firebase\");\r\n                    const { doc, onSnapshot } = await import(\"firebase/firestore\");\r\n                    profileUnsubscribe = onSnapshot(doc(db, \"users\", firebaseUser.uid), (doc) => {\r\n                        if (doc.exists()) {\r\n                            setProfile({ ...doc.data(), id: doc.id });\r\n                        }\r\n                    });\r\n\r\n                    // Refresh to ensure Server Components reflect the session\r\n                    router.refresh();\r\n\r\n                } catch (error) {\r\n                    console.error(\"Auth sync failed:\", error);\r\n                }\r\n            } else {\r\n                setUser(null)\r\n                setProfile(null)\r\n                if (profileUnsubscribe) profileUnsubscribe();\r\n                // Clear session on server\r\n                await deleteSession()\r\n            }\r\n            setLoading(false)\r\n        })\r\n\r\n        return () => {\r\n            unsubscribe();\r\n            if (profileUnsubscribe) profileUnsubscribe();\r\n        }\r\n    }, [])\r\n\r\n    const signOut = async () => {\r\n        const auth = getAuth()\r\n        await firebaseSignOut(auth)\r\n        await deleteSession()\r\n        router.push(\"/login\")\r\n    }\r\n\r\n    const refreshUser = async () => {\r\n        if (!user) return;\r\n        try {\r\n            await user.reload();\r\n            // Re-sync to DB to update verification status there too\r\n            const nameParts = (user.displayName || \"\").split(' ');\r\n            const firstName = nameParts[0] || \"Famio\";\r\n            const lastName = nameParts.slice(1).join(' ') || \"Member\";\r\n\r\n            await syncUserToDb(\r\n                user.uid,\r\n                user.email || \"\",\r\n                user.displayName || user.email?.split('@')[0] || \"User\",\r\n                firstName,\r\n                lastName,\r\n                user.emailVerified\r\n            );\r\n\r\n            // Force state update\r\n            setUser({ ...user });\r\n            router.refresh();\r\n        } catch (e) {\r\n            console.error(\"User refresh failed\", e);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <AuthContext.Provider value={{ user, profile, loading, signOut, refreshUser }}>\r\n            {children}\r\n        </AuthContext.Provider>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\auth\\activity-tracker.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'endTrackingSession' is defined but never used.","line":4,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":74,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"endTrackingSession"},"fix":{"range":[114,134],"text":""},"desc":"Remove unused variable \"endTrackingSession\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useRef } from \"react\";\r\nimport { startTrackingSession, updateSessionHeartbeat, endTrackingSession } from \"@/app/actions/activity\";\r\n\r\nconst HEARTBEAT_INTERVAL_MS = 60 * 1000; // 60 seconds\r\n\r\nexport function ActivityTracker({ userId }: { userId: string | null | undefined }) {\r\n    const sessionIdRef = useRef<string | null>(null);\r\n    const durationRef = useRef<number>(0);\r\n    const intervalRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n    useEffect(() => {\r\n        if (!userId) return;\r\n\r\n        let isActive = true;\r\n\r\n        const initSession = async () => {\r\n            try {\r\n                const sid = await startTrackingSession();\r\n                if (isActive && sid) {\r\n                    sessionIdRef.current = sid;\r\n                    console.log(\"[ActivityTracker] Session started:\", sid);\r\n\r\n                    // Start Heartbeat\r\n                    intervalRef.current = setInterval(async () => {\r\n                        if (!sessionIdRef.current) return;\r\n\r\n                        // Only track time if page is visible\r\n                        if (document.visibilityState === 'visible') {\r\n                            durationRef.current += HEARTBEAT_INTERVAL_MS;\r\n\r\n                            // We send the accumulated duration\r\n                            await updateSessionHeartbeat(sessionIdRef.current, durationRef.current).catch(err => {\r\n                                console.error(\"[ActivityTracker] Heartbeat failed\", err);\r\n                            });\r\n                        }\r\n                    }, HEARTBEAT_INTERVAL_MS);\r\n                }\r\n            } catch (error) {\r\n                console.error(\"[ActivityTracker] Failed to start session\", error);\r\n            }\r\n        };\r\n\r\n        initSession();\r\n\r\n        const handleUnload = () => {\r\n            if (sessionIdRef.current) {\r\n                // Try to send beacon or simple fetch safely?\r\n                // Next.js actions might not work reliably in 'unload'.\r\n                // We rely on the heartbeat validity window usually.\r\n                // But let's try calling the action via keepalive fetch if we had an endpoint, \r\n                // but actions are POST.\r\n                // For now, we rely on the server cleaning up \"stale\" sessions if needed, \r\n                // or just the last heartbeat time as the \"end\" time roughly.\r\n                // Explicit logout handles the clean \"Completed\" status.\r\n                // Tab close will leave it as \"Active\" until considered stale?\r\n                // Actually, we can use `navigator.sendBeacon` if we had an API route.\r\n                // Given the constraints, we accept that tab-close might miss the absolute final second.\r\n                // We will just clear the interval.\r\n            }\r\n        };\r\n\r\n        window.addEventListener(\"beforeunload\", handleUnload);\r\n\r\n        return () => {\r\n            isActive = false;\r\n            window.removeEventListener(\"beforeunload\", handleUnload);\r\n            if (intervalRef.current) {\r\n                clearInterval(intervalRef.current);\r\n            }\r\n            // Note: We do NOT end the session on unmount because unmount happens on route change in SPAs.\r\n            // We only end it on explicit logout or let it timeout on server/next-visit.\r\n            // Wait, MainLayout persists? Yes. So unmount means Refresh or Leave.\r\n            // If Refresh, we want to continue? Actually unmount means leaving the SPA context.\r\n            // So we SHOULD probably end it or let a new one start?\r\n            // If we start a new one on refresh, we get a lot of sessions.\r\n            // Better to keep it simple: New Load = New Session.\r\n\r\n            // Allow session to be marked completed on unmount if we can?\r\n            // But strict mode mounts/unmounts.\r\n            // Implementation detail: We'll leave it 'active' and rely on \"lastHeartbeat\" to determine validity.\r\n            // Explicit logout calls 'deleteSession' which cleans up.\r\n        };\r\n    }, [userId]);\r\n\r\n    return null; // Invisible component\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\auth\\pending-approval-screen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\auth\\verification-banner.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle2' is defined but never used.","line":6,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle2"},"fix":{"range":[188,202],"text":""},"desc":"Remove unused variable \"CheckCircle2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Mail' is defined but never used.","line":6,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":41,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Mail"},"fix":{"range":[202,208],"text":""},"desc":"Remove unused variable \"Mail\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'lastSent' is assigned a value but never used.","line":19,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":21,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":54,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { AlertCircle, CheckCircle2, Mail, Loader2, Send } from \"lucide-react\";\r\nimport { sendVerificationEmail } from \"@/app/actions/verification\"; // We will create this\r\nimport { toast } from \"sonner\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\ninterface VerificationBannerProps {\r\n    className?: string;\r\n}\r\n\r\nexport function VerificationBanner({ className }: VerificationBannerProps) {\r\n    const { profile, loading } = useAuth();\r\n    const [sending, setSending] = useState(false);\r\n    const [lastSent, setLastSent] = useState<number>(0);\r\n    const [cooldown, setCooldown] = useState(0);\r\n    const router = useRouter();\r\n\r\n    // Check rate limit timer\r\n    useEffect(() => {\r\n        if (cooldown > 0) {\r\n            const timer = setInterval(() => setCooldown(c => c - 1), 1000);\r\n            return () => clearInterval(timer);\r\n        }\r\n    }, [cooldown]);\r\n\r\n    if (loading || !profile) return null;\r\n\r\n    // Hidden if verified or admin\r\n    if (profile.emailVerified || profile.role === 'admin') return null;\r\n\r\n    const handleSendEmail = async () => {\r\n        if (cooldown > 0) return;\r\n\r\n        setSending(true);\r\n        try {\r\n            const result = await sendVerificationEmail();\r\n            if (result.success) {\r\n                toast.success(\"Verification email sent!\", {\r\n                    description: \"Please check your inbox (and spam folder).\"\r\n                });\r\n                setLastSent(Date.now());\r\n                setCooldown(300); // 5 minutes 300s\r\n            } else {\r\n                toast.error(\"Failed to send\", { description: result.error });\r\n                if (result.nextAvailableIn) {\r\n                    setCooldown(result.nextAvailableIn);\r\n                }\r\n            }\r\n        } catch (e) {\r\n            toast.error(\"Something went wrong\");\r\n        } finally {\r\n            setSending(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className={cn(\"bg-amber-100 dark:bg-amber-900/30 border-b border-amber-200 dark:border-amber-800/50 px-4 py-2.5\", className)}>\r\n            <div className=\"max-w-6xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-3 text-sm\">\r\n                <div className=\"flex items-center gap-2 text-amber-800 dark:text-amber-200\">\r\n                    <AlertCircle className=\"w-4 h-4 shrink-0\" />\r\n                    <span>\r\n                        <span className=\"font-semibold\">Account Unverified:</span> You have limited access. Verify your email to unlock posting and messaging.\r\n                    </span>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2 w-full sm:w-auto\">\r\n                    <Button\r\n                        size=\"sm\"\r\n                        variant=\"outline\"\r\n                        className=\"h-8 bg-transparent text-amber-900 border-amber-300 hover:bg-amber-200 dark:text-amber-100 dark:border-amber-700 dark:hover:bg-amber-800 ml-auto sm:ml-0\"\r\n                        onClick={handleSendEmail}\r\n                        disabled={sending || cooldown > 0}\r\n                    >\r\n                        {sending ? (\r\n                            <Loader2 className=\"w-3 h-3 mr-2 animate-spin\" />\r\n                        ) : (\r\n                            <Send className=\"w-3 h-3 mr-2\" />\r\n                        )}\r\n                        {cooldown > 0 ? `Resend (${cooldown}s)` : \"Resend Email\"}\r\n                    </Button>\r\n\r\n                    <Button\r\n                        size=\"sm\"\r\n                        variant=\"ghost\"\r\n                        className=\"h-8 text-amber-800 hover:bg-amber-200 dark:text-amber-200 dark:hover:bg-amber-800\"\r\n                        onClick={() => {\r\n                            window.location.reload(); // Hard reload to re-sync auth\r\n                        }}\r\n                    >\r\n                        I've Verified\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\birthdays\\birthday-modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\branding-card.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":54,"column":29,"nodeType":"JSXOpeningElement","endLine":60,"endColumn":31},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":66,"column":37,"nodeType":"JSXOpeningElement","endLine":71,"endColumn":39},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":78,"column":21,"nodeType":"JSXOpeningElement","endLine":84,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":128,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":131,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4885,4888],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4885,4888],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { Card, CardContent, CardFooter, CardHeader } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Briefcase, Users } from \"lucide-react\";\r\nimport { Branding } from \"@/app/actions/branding\";\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\nexport function BrandingCard({ branding }: { branding: Branding }) {\r\n    const { t } = useLanguage();\r\n    const [imageError, setImageError] = useState(false);\r\n    const imgRef = useRef<HTMLImageElement>(null);\r\n\r\n    // Check for broken image on mount/update (catches pre-hydration errors)\r\n    useEffect(() => {\r\n        const img = imgRef.current;\r\n        if (img && img.complete && (img.naturalWidth === 0)) {\r\n            // Move state update to next tick to avoid \"setState in useEffect\" warning\r\n            const timer = setTimeout(() => setImageError(true), 0);\r\n            return () => clearTimeout(timer);\r\n        }\r\n    }, [branding.coverUrl, branding.imageUrl]);\r\n\r\n    // Determines what to show.\r\n    // If we have a coverUrl and no error -> show cover\r\n    // If coverUrl fails or is missing -> try imageUrl\r\n    // If imageUrl fails or is missing -> show fallback\r\n\r\n    const hasCover = !!branding.coverUrl && !imageError;\r\n    // We treat video covers as robust for now, assuming valid URL if mp4/webm. \r\n    // Ideally we'd wrap video in error boundaries too, but <img> is the main culprit here.\r\n    const isVideo = hasCover && (branding.coverUrl!.includes('mp4') || branding.coverUrl!.includes('webm'));\r\n\r\n    // Fallback logic is tricky with dual images. \r\n    // Simplest robust fix: If the MAIN display image fails, revert to the \"Default Gradient\" state.\r\n\r\n    return (\r\n        <Card className=\"flex flex-col h-full hover:shadow-md transition-shadow\">\r\n            <div className=\"h-32 w-full bg-muted relative rounded-t-lg overflow-hidden\">\r\n                {hasCover ? (\r\n                    <>\r\n                        {isVideo ? (\r\n                            <video\r\n                                src={branding.coverUrl}\r\n                                className=\"w-full h-full object-cover\"\r\n                                autoPlay\r\n                                loop\r\n                                muted\r\n                                playsInline\r\n                            />\r\n                        ) : (\r\n                            <img\r\n                                ref={imgRef}\r\n                                src={branding.coverUrl}\r\n                                alt={branding.name}\r\n                                className=\"w-full h-full object-cover\"\r\n                                onError={() => setImageError(true)}\r\n                            />\r\n                        )}\r\n                        {/* Overlay Logo if Cover exists */}\r\n                        {branding.imageUrl && (\r\n                            <div className=\"absolute inset-0 flex items-center justify-center\">\r\n                                <div className=\"w-16 h-16 rounded-full border-4 border-white dark:border-gray-800 overflow-hidden bg-white shadow-lg\">\r\n                                    <img\r\n                                        src={branding.imageUrl}\r\n                                        alt={branding.name}\r\n                                        className=\"w-full h-full object-cover\"\r\n                                        onError={(e) => (e.currentTarget.style.display = 'none')}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                    </>\r\n                ) : branding.imageUrl && !imageError ? (\r\n                    // Logic when NO cover but YES logo -> use logo as cover\r\n                    <img\r\n                        ref={imgRef}\r\n                        src={branding.imageUrl}\r\n                        alt={branding.name}\r\n                        className=\"w-full h-full object-cover\"\r\n                        onError={() => setImageError(true)}\r\n                    />\r\n                ) : (\r\n                    // Fallback to Gradient\r\n                    <div className=\"w-full h-full bg-gradient-to-br from-green-600/20 to-green-600/10 flex items-center justify-center\">\r\n                        <Briefcase className=\"w-12 h-12 text-green-600/40\" />\r\n                    </div>\r\n                )}\r\n            </div>\r\n            <CardHeader className=\"pb-2\">\r\n                <div className=\"flex justify-between items-start\">\r\n                    <div>\r\n                        <h3 className=\"font-bold text-lg leading-tight\">{branding.name}</h3>\r\n                        <p className=\"text-sm text-muted-foreground capitalize\">{t(`branding.category.${branding.category}` as any)}</p>\r\n                    </div>\r\n                </div>\r\n            </CardHeader>\r\n            <CardContent className=\"flex-1 pb-4\">\r\n                <p className=\"text-sm text-muted-foreground line-clamp-2\">\r\n                    {branding.description}\r\n                </p>\r\n                <div className=\"mt-4 flex items-center gap-2 text-xs text-muted-foreground\">\r\n                    <Users className=\"w-3 h-3\" />\r\n                    <span>{branding.followerCount || 1} {t('branding.followers')}</span>\r\n                </div>\r\n            </CardContent>\r\n            <CardFooter>\r\n                <Button asChild variant=\"outline\" className=\"w-full\">\r\n                    <Link href={`/branding/${branding.slug || branding.id}`}>\r\n                        {t('branding.view')}\r\n                    </Link>\r\n                </Button>\r\n            </CardFooter>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\branding-cover-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\branding-feed.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[474,477],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[474,477],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[500,503],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[500,503],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { AnimatePresence, motion } from \"framer-motion\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Plus } from \"lucide-react\";\r\nimport { BrandingPostCreator } from \"@/components/branding/branding-post-creator\";\r\nimport { FeedList } from \"@/components/feed/feed-list\";\r\nimport { getBrandingPosts } from \"@/app/actions/branding\";\r\n\r\ninterface BrandingFeedProps {\r\n    brandingId: string;\r\n    currentUser: any;\r\n    brandingAuthor: any;\r\n    role: string;\r\n}\r\n\r\nexport function BrandingFeed({ brandingId, currentUser, brandingAuthor, role }: BrandingFeedProps) {\r\n    const [isComposeOpen, setIsComposeOpen] = useState(false);\r\n\r\n    return (\r\n        <>\r\n            {/* Create Post - Smooth Expand/Collapse */}\r\n            <AnimatePresence initial={false}>\r\n                {isComposeOpen && (\r\n                    <motion.div\r\n                        initial={{ height: 0, opacity: 0 }}\r\n                        animate={{ height: \"auto\", opacity: 1 }}\r\n                        exit={{ height: 0, opacity: 0 }}\r\n                        transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n                        className=\"overflow-hidden mb-6\"\r\n                    >\r\n                        <BrandingPostCreator\r\n                            brandingId={brandingId}\r\n                            branding={brandingAuthor}\r\n                            currentUser={currentUser}\r\n                            role={role}\r\n                            onClose={() => setIsComposeOpen(false)}\r\n                        />\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            <FeedList\r\n                variant=\"pinterest-mobile\"\r\n                fetcher={(limit, filters) => getBrandingPosts(brandingId, limit, filters)}\r\n                headerAction={\r\n                    <Button\r\n                        size=\"sm\"\r\n                        variant=\"outline\"\r\n                        className=\"rounded-full w-8 h-8 p-0 bg-background border-dashed border-primary/50 text-primary hover:bg-primary hover:text-white transition-all shadow-sm\"\r\n                        onClick={() => setIsComposeOpen(!isComposeOpen)}\r\n                    >\r\n                        <Plus className={`w-4 h-4 transition-transform duration-300 ${isComposeOpen ? \"rotate-45\" : \"\"}`} />\r\n                    </Button>\r\n                }\r\n            />\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\branding-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[572,575],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[572,575],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":57,"column":25,"nodeType":"JSXOpeningElement","endLine":63,"endColumn":27},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":89,"column":29,"nodeType":"JSXOpeningElement","endLine":94,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Branding } from \"@/app/actions/branding\";\r\nimport { BrandingCoverButton } from \"@/components/branding/branding-cover-button\";\r\nimport { BrandingManagementDialog } from \"@/components/branding/branding-management-dialog\";\r\nimport { FollowBrandingButton } from \"@/components/branding/follow-branding-button\";\r\nimport { ShareButton } from \"@/components/shared/share-button\";\r\nimport { Briefcase } from \"lucide-react\";\r\nimport { useState, useRef, useEffect } from \"react\";\r\n\r\ninterface BrandingHeaderProps {\r\n    branding: Branding;\r\n    currentUser: any;\r\n    isBrandingAdmin: boolean;\r\n    isFollowing: boolean;\r\n    followStatusRole?: \"admin\" | \"follower\" | null;\r\n}\r\n\r\nexport function BrandingHeader({\r\n    branding,\r\n    currentUser,\r\n    isBrandingAdmin,\r\n    isFollowing,\r\n    followStatusRole\r\n}: BrandingHeaderProps) {\r\n    const [imageError, setImageError] = useState(false);\r\n    const imgRef = useRef<HTMLImageElement>(null);\r\n\r\n    // Robust Image Error Handling (Same as BrandingCard)\r\n    useEffect(() => {\r\n        const img = imgRef.current;\r\n        if (img && img.complete && (img.naturalWidth === 0)) {\r\n            // Move state update to next tick to avoid \"setState in useEffect\" warning\r\n            const timer = setTimeout(() => setImageError(true), 0);\r\n            return () => clearTimeout(timer);\r\n        }\r\n    }, [branding.coverUrl]);\r\n\r\n    const hasCover = !!branding.coverUrl && !imageError;\r\n    const isVideo = hasCover && (branding.coverUrl!.includes('mp4') || branding.coverUrl!.includes('webm'));\r\n\r\n    return (\r\n        <div className=\"w-full bg-background border rounded-xl overflow-hidden shadow-sm mb-6\">\r\n            {/* Cover Area */}\r\n            <div className=\"relative h-48 md:h-64 bg-muted w-full group\">\r\n                {hasCover ? (\r\n                    isVideo ? (\r\n                        <video\r\n                            src={branding.coverUrl}\r\n                            className=\"w-full h-full object-cover\"\r\n                            autoPlay\r\n                            loop\r\n                            muted\r\n                            playsInline\r\n                        />\r\n                    ) : (\r\n                        <img\r\n                            ref={imgRef}\r\n                            src={branding.coverUrl}\r\n                            alt=\"Cover\"\r\n                            className=\"w-full h-full object-cover\"\r\n                            onError={() => setImageError(true)}\r\n                        />\r\n                    )\r\n                ) : (\r\n                    <div className=\"w-full h-full bg-gradient-to-br from-green-600/20 to-green-600/10 flex items-center justify-center\">\r\n                        <Briefcase className=\"w-12 h-12 text-green-600/40\" />\r\n                    </div>\r\n                )}\r\n\r\n                {/* Edit Cover Button (Visible to Admin) */}\r\n                {isBrandingAdmin && currentUser && (\r\n                    <div className=\"absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                        <BrandingCoverButton\r\n                            brandingId={branding.id}\r\n                            currentCoverUrl={branding.coverUrl}\r\n                            userId={currentUser.id}\r\n                        />\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Info Bar */}\r\n            <div className=\"px-6 py-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\r\n                <div className=\"flex items-center gap-4 -mt-12 md:-mt-16\">\r\n                    {/* Logo */}\r\n                    <div className=\"w-24 h-24 md:w-32 md:h-32 rounded-full border-4 border-background bg-background shadow-md overflow-hidden relative z-10 shrink-0\">\r\n                        {branding.imageUrl ? (\r\n                            <img\r\n                                src={branding.imageUrl}\r\n                                alt={branding.name}\r\n                                className=\"w-full h-full object-cover\"\r\n                                onError={(e) => (e.currentTarget.style.display = 'none')}\r\n                            />\r\n                        ) : (\r\n                            <div className=\"w-full h-full bg-muted flex items-center justify-center\">\r\n                                <Briefcase className=\"w-8 h-8 text-muted-foreground\" />\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Accessibly Hidden / Mobile visual fix could go here if needed */}\r\n                </div>\r\n\r\n                {/* Details & Actions */}\r\n                <div className=\"flex-1 min-w-0 mt-2 md:mt-0 md:ml-2\">\r\n                    <h1 className=\"text-2xl font-bold truncate\">{branding.name}</h1>\r\n                    <p className=\"text-muted-foreground text-sm capitalize\">{branding.category.replace('_', ' ')} ‚Ä¢ {branding.followerCount || 0} followers</p>\r\n\r\n                    {/* Description preview? (Optional, maybe keep it in the About card) */}\r\n                </div>\r\n\r\n                {/* Action Buttons */}\r\n                <div className=\"flex items-center gap-2 w-full md:w-auto mt-2 md:mt-0\">\r\n                    {isBrandingAdmin && currentUser && (\r\n                        <BrandingManagementDialog\r\n                            branding={branding}\r\n                            currentUser={currentUser}\r\n                            isAdmin={true}\r\n                        />\r\n                    )}\r\n                    <FollowBrandingButton\r\n                        brandingId={branding.id}\r\n                        isFollowing={isFollowing}\r\n                        role={followStatusRole}\r\n                    />\r\n                    <ShareButton\r\n                        title={branding.name}\r\n                        text={`Check out this page: ${branding.name}`}\r\n                        variant=\"ghost\"\r\n                        className=\"h-9 w-9 p-0\"\r\n                    />\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\branding-management-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogFooter' is defined but never used.","line":5,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":64,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogFooter"},"fix":{"range":[151,165],"text":""},"desc":"Remove unused variable \"DialogFooter\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogTrigger' is defined but never used.","line":5,"column":93,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":106,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogTrigger"},"fix":{"range":[192,207],"text":""},"desc":"Remove unused variable \"DialogTrigger\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Trash2' is defined but never used.","line":10,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Trash2"},"fix":{"range":[511,519],"text":""},"desc":"Remove unused variable \"Trash2\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1893,1896],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1893,1896],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2361,2364],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2361,2364],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":121,"column":45,"nodeType":"JSXOpeningElement","endLine":121,"endColumn":115},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"img elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":121,"column":45,"nodeType":"JSXOpeningElement","endLine":121,"endColumn":115}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Settings, Image as ImageIcon, Trash2, AlertTriangle, Loader2 } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { updateBrandingDetails, softDeleteBranding } from \"@/app/actions/branding\";\r\nimport { CoverUploadDialog } from \"@/components/shared/cover-upload-dialog\";\r\n\r\ninterface BrandingManagementDialogProps {\r\n    branding: {\r\n        id: string;\r\n        name: string;\r\n        description: string;\r\n        coverUrl?: string;\r\n        founderId: string;\r\n    };\r\n    currentUser: {\r\n        id: string;\r\n    };\r\n    isAdmin: boolean;\r\n}\r\n\r\nexport function BrandingManagementDialog({ branding, currentUser, isAdmin }: BrandingManagementDialogProps) {\r\n    const router = useRouter();\r\n    const [open, setOpen] = useState(false);\r\n    const [isLoading, setIsLoading] = useState(false);\r\n\r\n    // Form State\r\n    const [name, setName] = useState(branding.name);\r\n    const [description, setDescription] = useState(branding.description);\r\n\r\n    // Cover Upload State\r\n    const [coverDialogOpen, setCoverDialogOpen] = useState(false);\r\n\r\n    const handleUpdate = async () => {\r\n        setIsLoading(true);\r\n        try {\r\n            await updateBrandingDetails(branding.id, { name, description });\r\n            toast.success(\"Page details updated successfully\");\r\n            setOpen(false);\r\n            router.refresh();\r\n        } catch (error: any) {\r\n            toast.error(error.message || \"Failed to update page\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleDelete = async () => {\r\n        setIsLoading(true);\r\n        try {\r\n            await softDeleteBranding(branding.id);\r\n            toast.success(\"Page deleted. It will be permanently removed in 30 days.\");\r\n            setOpen(false);\r\n            router.push('/branding');\r\n        } catch (error: any) {\r\n            toast.error(error.message || \"Failed to delete page\");\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const isFounder = branding.founderId === currentUser.id;\r\n\r\n    // Only admins/founder can see this\r\n    if (!isAdmin && !isFounder) return null;\r\n\r\n    return (\r\n        <>\r\n            <Button variant=\"ghost\" size=\"icon\" onClick={() => setOpen(true)} title=\"Page Settings\">\r\n                <Settings className=\"h-5 w-5\" />\r\n            </Button>\r\n\r\n            <Dialog open={open} onOpenChange={setOpen}>\r\n                <DialogContent className=\"sm:max-w-[600px]\">\r\n                    <DialogHeader>\r\n                        <DialogTitle>Manage Page</DialogTitle>\r\n                        <DialogDescription>\r\n                            Update page details or manage settings.\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <Tabs defaultValue=\"general\" className=\"w-full\">\r\n                        <TabsList className=\"grid w-full grid-cols-2\">\r\n                            <TabsTrigger value=\"general\">General</TabsTrigger>\r\n                            <TabsTrigger value=\"danger\">Danger Zone</TabsTrigger>\r\n                        </TabsList>\r\n\r\n                        <TabsContent value=\"general\" className=\"space-y-4 py-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"name\">Page Name</Label>\r\n                                <Input\r\n                                    id=\"name\"\r\n                                    value={name}\r\n                                    onChange={(e) => setName(e.target.value)}\r\n                                    placeholder=\"Page Name\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"description\">Description</Label>\r\n                                <Textarea\r\n                                    id=\"description\"\r\n                                    value={description}\r\n                                    onChange={(e) => setDescription(e.target.value)}\r\n                                    placeholder=\"Describe your page...\"\r\n                                    className=\"min-h-[100px]\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"pt-4 border-t\">\r\n                                <Label className=\"mb-2 block\">Cover Photo/Video</Label>\r\n                                <div className=\"flex items-center gap-4\">\r\n                                    <div className=\"relative w-32 h-20 bg-muted rounded overflow-hidden\">\r\n                                        {branding.coverUrl ? (\r\n                                            <img src={branding.coverUrl} className=\"w-full h-full object-cover\" />\r\n                                        ) : (\r\n                                            <div className=\"flex items-center justify-center w-full h-full text-muted-foreground\">\r\n                                                <ImageIcon className=\"w-6 h-6\" />\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                    <Button variant=\"outline\" onClick={() => setCoverDialogOpen(true)}>\r\n                                        Change Cover\r\n                                    </Button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"flex justify-end pt-4\">\r\n                                <Button onClick={handleUpdate} disabled={isLoading}>\r\n                                    {isLoading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                                    Save Changes\r\n                                </Button>\r\n                            </div>\r\n                        </TabsContent>\r\n\r\n                        <TabsContent value=\"danger\" className=\"space-y-4 py-4\">\r\n                            <div className=\"rounded-md border border-destructive/50 bg-destructive/10 p-4\">\r\n                                <div className=\"flex items-start gap-4\">\r\n                                    <AlertTriangle className=\"h-5 w-5 text-destructive mt-0.5\" />\r\n                                    <div>\r\n                                        <h4 className=\"font-semibold text-destructive\">Delete Page</h4>\r\n                                        <p className=\"text-sm text-destructive/90 mt-1\">\r\n                                            This action will hide the page immediately. You will have 30 days to restore it before it is permanently deleted along with all posts and followers.\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {isFounder ? (\r\n                                    <div className=\"mt-4 flex justify-end\">\r\n                                        <Button\r\n                                            variant=\"destructive\"\r\n                                            onClick={handleDelete}\r\n                                            disabled={isLoading}\r\n                                        >\r\n                                            {isLoading ? \"Deleting...\" : \"Delete Page\"}\r\n                                        </Button>\r\n                                    </div>\r\n                                ) : (\r\n                                    <p className=\"text-sm text-muted-foreground mt-4 italic\">\r\n                                        Only the page founder can delete this page.\r\n                                    </p>\r\n                                )}\r\n                            </div>\r\n                        </TabsContent>\r\n                    </Tabs>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            <CoverUploadDialog\r\n                open={coverDialogOpen}\r\n                onOpenChange={setCoverDialogOpen}\r\n                type=\"branding\"\r\n                id={branding.id}\r\n                currentCoverUrl={branding.coverUrl}\r\n                userId={currentUser.id}\r\n            />\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\branding-post-creator.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3687,3690],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3687,3690],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":158,"column":45,"nodeType":"JSXOpeningElement","endLine":162,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { createBrandingPost } from \"@/app/actions/branding\"\r\nimport { toast } from \"sonner\"\r\nimport { Image as ImageIcon, Send, Loader2, X, Video, Mic, MicOff } from \"lucide-react\"\r\nimport { storage } from \"@/lib/firebase\"\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\"\r\nimport { useSpeechRecognition } from \"@/hooks/use-speech-recognition\"\r\nimport { useMagicAI } from \"@/hooks/use-magic-ai\"\r\nimport { MagicAIButton } from \"@/components/magic-ai/magic-ai-button\"\r\nimport { AIPreviewPanel } from \"@/components/magic-ai/ai-preview-panel\"\r\n\r\ninterface BrandingPostCreatorProps {\r\n    brandingId: string;\r\n    branding: { name: string; imageUrl?: string };\r\n    currentUser: { displayName?: string | null; imageUrl?: string | null; id: string };\r\n    role?: string | null; // Broadened to accept any string role\r\n    onClose?: () => void;\r\n}\r\n\r\nexport function BrandingPostCreator({ brandingId, branding, currentUser, role, onClose }: BrandingPostCreatorProps) {\r\n    const router = useRouter();\r\n    const [content, setContent] = useState(\"\");\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [mediaUrls, setMediaUrls] = useState<string[]>([]);\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    const isAdmin = role === 'admin';\r\n\r\n    // Determining identity to display in the input area\r\n    const postingAsName = isAdmin ? branding.name : currentUser.displayName;\r\n    const postingAsImage = isAdmin ? branding.imageUrl : currentUser.imageUrl;\r\n    const placeholder = isAdmin ? `Post as ${branding.name}...` : `Write on ${branding.name}'s page...`;\r\n\r\n    // Magic AI Integration\r\n    const magicAI = useMagicAI({ context: { type: 'branding', name: branding.name } });\r\n\r\n    const { isListening, startListening, stopListening, isSupported: isSpeechSupported } = useSpeechRecognition({\r\n        onResult: (result) => setContent(prev => prev ? prev + \" \" + result : result)\r\n    });\r\n\r\n    // Magic AI handlers\r\n    const handleOpenMagicAI = () => {\r\n        magicAI.openMagic(content);\r\n    };\r\n\r\n    const handleAcceptMagic = () => {\r\n        const enhancedContent = magicAI.acceptEnhanced();\r\n        if (enhancedContent) {\r\n            setContent(enhancedContent);\r\n        }\r\n    };\r\n\r\n    const handleRevertMagic = () => {\r\n        const originalContent = magicAI.revertToOriginal();\r\n        setContent(originalContent);\r\n    };\r\n\r\n    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files && e.target.files[0]) {\r\n            const file = e.target.files[0];\r\n            setIsUploading(true);\r\n            try {\r\n                // Determine path based on file type or context\r\n                const timestamp = Date.now();\r\n                const filename = `${timestamp}-${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;\r\n\r\n                // Use branding bucket path\r\n                const storageRef = ref(storage, `branding/${brandingId}/posts/${filename}`);\r\n\r\n                // Direct upload\r\n                const snapshot = await uploadBytes(storageRef, file);\r\n                const url = await getDownloadURL(snapshot.ref);\r\n\r\n                setMediaUrls(prev => [...prev, url]);\r\n                toast.success(\"File uploaded\");\r\n            } catch (error: any) {\r\n                console.error(\"Error uploading file:\", error);\r\n                toast.error(`Failed to upload: ${error.message}`);\r\n            } finally {\r\n                setIsUploading(false);\r\n                if (fileInputRef.current) fileInputRef.current.value = \"\";\r\n            }\r\n        }\r\n    };\r\n\r\n    const removeMedia = (index: number) => {\r\n        setMediaUrls(prev => prev.filter((_, i) => i !== index));\r\n    };\r\n\r\n    async function handlePost() {\r\n        if (!content.trim() && mediaUrls.length === 0) return;\r\n\r\n        setIsSubmitting(true);\r\n        try {\r\n            await createBrandingPost(brandingId, content, mediaUrls);\r\n            setContent(\"\");\r\n            setMediaUrls([]);\r\n            toast.success(\"Posted to branding!\");\r\n            if (onClose) onClose();\r\n            router.refresh();\r\n        } catch (error) {\r\n            console.error(error);\r\n            toast.error(\"Failed to post\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Card className=\"mb-6 border-none glass-card rounded-lg\">\r\n            <CardContent className=\"p-4\">\r\n                <div className=\"flex gap-3\">\r\n                    <Avatar className=\"w-10 h-10 border border-gray-200\">\r\n                        <AvatarImage src={postingAsImage || undefined} />\r\n                        <AvatarFallback>{postingAsName?.[0]}</AvatarFallback>\r\n                    </Avatar>\r\n                    <div className=\"flex-1 space-y-4\">\r\n                        <div className=\"relative\">\r\n                            <Textarea\r\n                                placeholder={isListening ? \"Listening...\" : placeholder}\r\n                                className=\"min-h-[80px] bg-muted/50 border-0 focus-visible:ring-1 rounded-xl resize-none text-[15px] pr-12\"\r\n                                value={content}\r\n                                onChange={(e) => setContent(e.target.value)}\r\n                                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && handlePost()}\r\n                            />\r\n                            {isSpeechSupported && (\r\n                                <div className=\"absolute right-3 top-3\">\r\n                                    <Button\r\n                                        size=\"icon\"\r\n                                        variant=\"ghost\"\r\n                                        onClick={isListening ? stopListening : startListening}\r\n                                        className={isListening ? \"text-red-500 hover:bg-red-50 animate-pulse\" : \"text-gray-400 hover:text-gray-600\"}\r\n                                    >\r\n                                        {isListening ? <MicOff className=\"w-5 h-5\" /> : <Mic className=\"w-5 h-5\" />}\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Media Previews */}\r\n                        {mediaUrls.length > 0 && (\r\n                            <div className=\"flex gap-2 overflow-x-auto py-2\">\r\n                                {mediaUrls.map((url, index) => (\r\n                                    <div key={index} className=\"relative group flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border border-border\">\r\n                                        {url.includes('.mp4') || url.includes('.webm') ? (\r\n                                            <div className=\"w-full h-full bg-black flex items-center justify-center\">\r\n                                                <Video className=\"w-8 h-8 text-white/70\" />\r\n                                            </div>\r\n                                        ) : (\r\n                                            <img\r\n                                                src={url}\r\n                                                alt=\"Uploaded content\"\r\n                                                className=\"w-full h-full object-cover\"\r\n                                            />\r\n                                        )}\r\n                                        <button\r\n                                            onClick={() => removeMedia(index)}\r\n                                            className=\"absolute top-1 right-1 bg-black/50 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                                        >\r\n                                            <X className=\"w-3 h-3\" />\r\n                                        </button>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"flex justify-between items-center pt-2 border-t border-border\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <input\r\n                                    type=\"file\"\r\n                                    ref={fileInputRef}\r\n                                    className=\"hidden\"\r\n                                    accept=\"image/*,video/*\"\r\n                                    onChange={handleFileSelect}\r\n                                    disabled={isUploading}\r\n                                />\r\n                                <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    className=\"text-muted-foreground hover:text-primary gap-2\"\r\n                                    onClick={() => fileInputRef.current?.click()}\r\n                                    disabled={isUploading}\r\n                                >\r\n                                    {isUploading ? (\r\n                                        <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                                    ) : (\r\n                                        <ImageIcon className=\"w-5 h-5\" />\r\n                                    )}\r\n                                    <span className=\"hidden sm:inline\">Photo/Video</span>\r\n                                </Button>\r\n                                <MagicAIButton\r\n                                    onClick={handleOpenMagicAI}\r\n                                    disabled={!content.trim()}\r\n                                    isGenerating={magicAI.isGenerating}\r\n                                />\r\n                            </div>\r\n                            <Button\r\n                                size=\"sm\"\r\n                                onClick={handlePost}\r\n                                disabled={(!content.trim() && mediaUrls.length === 0) || isSubmitting || isUploading}\r\n                                className=\"bg-primary text-primary-foreground font-semibold px-6\"\r\n                            >\r\n                                {isSubmitting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4 mr-2\" />}\r\n                                Post\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Magic AI Preview Panel */}\r\n                <AIPreviewPanel\r\n                    isOpen={magicAI.isPreviewOpen}\r\n                    onClose={magicAI.closePreview}\r\n                    originalContent={magicAI.originalContent}\r\n                    enhancedContent={magicAI.enhancedContent}\r\n                    selectedTone={magicAI.selectedTone}\r\n                    isGenerating={magicAI.isGenerating}\r\n                    onSelectTone={magicAI.generatePreview}\r\n                    onAccept={handleAcceptMagic}\r\n                    onRevert={handleRevertMagic}\r\n                />\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\branding-view.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\create-branding-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FormDescription' is defined but never used.","line":20,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FormDescription"},"fix":{"range":[461,483],"text":""},"desc":"Remove unused variable \"FormDescription\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { useForm } from \"react-hook-form\"\r\nimport { zodResolver } from \"@hookform/resolvers/zod\"\r\nimport * as z from \"zod\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n    Form,\r\n    FormControl,\r\n    FormDescription,\r\n    FormField,\r\n    FormItem,\r\n    FormLabel,\r\n    FormMessage,\r\n} from \"@/components/ui/form\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { createBranding } from \"@/app/actions/branding\"\r\nimport { toast } from \"sonner\"\r\nimport { PlusCircle, Loader2 } from \"lucide-react\"\r\n\r\nconst formSchema = z.object({\r\n    name: z.string().min(2, \"Name must be at least 2 characters\"),\r\n    description: z.string().min(10, \"Description must be at least 10 characters\"),\r\n    category: z.string().min(1, \"Please select a category\"),\r\n    imageUrl: z.string().optional(),\r\n})\r\n\r\nexport function CreateBrandingDialog() {\r\n    const [open, setOpen] = useState(false)\r\n    const router = useRouter()\r\n    const [isSubmitting, setIsSubmitting] = useState(false)\r\n\r\n    const form = useForm<z.infer<typeof formSchema>>({\r\n        resolver: zodResolver(formSchema),\r\n        defaultValues: {\r\n            name: \"\",\r\n            description: \"\",\r\n            category: \"\",\r\n            imageUrl: \"\",\r\n        },\r\n    })\r\n\r\n    async function onSubmit(values: z.infer<typeof formSchema>) {\r\n        setIsSubmitting(true)\r\n        try {\r\n            const brandingId = await createBranding(values)\r\n            toast.success(\"Branding created successfully!\")\r\n            setOpen(false)\r\n            form.reset()\r\n            router.push(`/branding/${brandingId}`)\r\n        } catch (error) {\r\n            console.error(error)\r\n            toast.error(\"Failed to create branding\")\r\n        } finally {\r\n            setIsSubmitting(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={setOpen}>\r\n            <DialogTrigger asChild>\r\n                <Button className=\"gap-2\">\r\n                    <PlusCircle className=\"w-4 h-4\" />\r\n                    Create Branding\r\n                </Button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"sm:max-w-[425px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Create a New Branding</DialogTitle>\r\n                    <DialogDescription>\r\n                        Promote your business, brand, or public profile.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n                <Form {...form}>\r\n                    <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"name\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>Branding Name</FormLabel>\r\n                                    <FormControl>\r\n                                        <Input placeholder=\"e.g., Grandma's Bakery\" {...field} />\r\n                                    </FormControl>\r\n                                    <FormMessage />\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"category\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>Category</FormLabel>\r\n                                    <Select onValueChange={field.onChange} defaultValue={field.value}>\r\n                                        <FormControl>\r\n                                            <SelectTrigger>\r\n                                                <SelectValue placeholder=\"Select a category\" />\r\n                                            </SelectTrigger>\r\n                                        </FormControl>\r\n                                        <SelectContent>\r\n                                            <SelectItem value=\"business\">Business</SelectItem>\r\n                                            <SelectItem value=\"brand\">Brand</SelectItem>\r\n                                            <SelectItem value=\"organization\">Organization</SelectItem>\r\n                                            <SelectItem value=\"public_figure\">Public Figure</SelectItem>\r\n                                            <SelectItem value=\"other\">Other</SelectItem>\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                    <FormMessage />\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"description\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>Description</FormLabel>\r\n                                    <FormControl>\r\n                                        <Textarea placeholder=\"What is this branding about?\" {...field} />\r\n                                    </FormControl>\r\n                                    <FormMessage />\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"imageUrl\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>Logo URL (Optional)</FormLabel>\r\n                                    <FormControl>\r\n                                        <Input placeholder=\"https://...\" {...field} />\r\n                                    </FormControl>\r\n                                    <FormMessage />\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n\r\n                        <div className=\"flex justify-end pt-4\">\r\n                            <Button type=\"submit\" disabled={isSubmitting}>\r\n                                {isSubmitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                                Create Branding\r\n                            </Button>\r\n                        </div>\r\n                    </form>\r\n                </Form>\r\n            </DialogContent>\r\n        </Dialog>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\branding\\follow-branding-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\chat\\chat-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\chat\\chat-window.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMessages'. Either include it or remove the dependency array.","line":48,"column":8,"nodeType":"ArrayExpression","endLine":48,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [fetchMessages, session.id]","fix":{"range":[1800,1812],"text":"[fetchMessages, session.id]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3178,3181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3178,3181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { getMessages, sendMessage, Message, ChatSession } from \"@/app/actions/chat\";\r\nimport { Send, Loader2, Smile, Phone, Video } from \"lucide-react\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\r\nimport { startSession } from \"@/app/actions/rtc\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\ninterface ChatWindowProps {\r\n    session: ChatSession;\r\n    currentUserId: string;\r\n    onStartCall?: (sessionId: string) => void;\r\n}\r\n\r\nexport function ChatWindow({ session, currentUserId, onStartCall }: ChatWindowProps) {\r\n    const { t } = useLanguage();\r\n    const [messages, setMessages] = useState<Message[]>([]);\r\n    const [inputText, setInputText] = useState(\"\");\r\n    const [isSending, setIsSending] = useState(false);\r\n    const scrollRef = useRef<HTMLDivElement>(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n\r\n    const otherUser = session.otherUser;\r\n\r\n    const fetchMessages = async () => {\r\n        try {\r\n            const data = await getMessages(session.id);\r\n            setMessages(data);\r\n            setIsLoading(false);\r\n        } catch (err) {\r\n            console.error(err);\r\n        }\r\n    };\r\n\r\n    // Initial fetch and Polling\r\n    useEffect(() => {\r\n        fetchMessages();\r\n        const interval = setInterval(fetchMessages, 3000); // Poll every 3s\r\n        return () => clearInterval(interval);\r\n    }, [session.id]);\r\n\r\n    // Auto-scroll to bottom on new messages\r\n    useEffect(() => {\r\n        if (scrollRef.current) {\r\n            scrollRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n        }\r\n    }, [messages]);\r\n\r\n    const handleSend = async () => {\r\n        if (!inputText.trim()) return;\r\n\r\n        const content = inputText;\r\n        setInputText(\"\"); // Optimistic clear\r\n\r\n        // Optimistic append\r\n        const tempMsg: Message = {\r\n            id: Date.now().toString(), // Temp ID as string\r\n            senderId: currentUserId,\r\n            content: content,\r\n            createdAt: new Date(),\r\n        };\r\n        setMessages(prev => [...prev, tempMsg]);\r\n\r\n        setIsSending(true);\r\n        try {\r\n            await sendMessage(session.id, content);\r\n            await fetchMessages(); // Sync real ID\r\n        } catch {\r\n            // Revert or show error (simplified)\r\n            console.error(\"Failed to send\");\r\n        } finally {\r\n            setIsSending(false);\r\n        }\r\n    };\r\n\r\n    const handleStartCall = async (type: \"call_video\" | \"call_audio\") => {\r\n        try {\r\n            const result = await startSession(type, otherUser?.id);\r\n            onStartCall?.(result.sessionId);\r\n            toast.success(type === \"call_video\" ? t('messages.call.video.started') : t('messages.call.voice.started'));\r\n        } catch (error: any) {\r\n            toast.error(error.message || t('messages.call.error'));\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-white dark:bg-card rounded-lg overflow-hidden border border-gray-200 dark:border-white/10 shadow-sm\">\r\n            {/* Header */}\r\n            <div className=\"p-4 border-b border-gray-100 dark:border-white/5 flex items-center gap-3 bg-white/50 backdrop-blur-md\">\r\n                <Avatar className=\"h-10 w-10\">\r\n                    <AvatarImage src={otherUser?.imageUrl || undefined} />\r\n                    <AvatarFallback>{otherUser?.displayName?.charAt(0) || \"?\"}</AvatarFallback>\r\n                </Avatar>\r\n                <div className=\"flex-1\">\r\n                    <h3 className=\"font-semibold text-sm md:text-base text-foreground\">\r\n                        {otherUser?.displayName || t('messages.chat.unknown')}\r\n                    </h3>\r\n                    <p className=\"text-xs text-green-500 font-medium\">{t('messages.status.online')}</p>\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => handleStartCall(\"call_audio\")}\r\n                        className=\"text-muted-foreground hover:text-foreground\"\r\n                    >\r\n                        <Phone className=\"h-5 w-5\" />\r\n                    </Button>\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => handleStartCall(\"call_video\")}\r\n                        className=\"text-muted-foreground hover:text-foreground\"\r\n                    >\r\n                        <Video className=\"h-5 w-5\" />\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Messages Area */}\r\n            <ScrollArea className=\"flex-1 p-4 bg-gray-50/50 dark:bg-background/50\">\r\n                <div className=\"flex flex-col gap-3 min-h-full justify-end\">\r\n                    {isLoading ? (\r\n                        <div className=\"flex justify-center py-10\">\r\n                            <Loader2 className=\"w-6 h-6 animate-spin text-muted-foreground\" />\r\n                        </div>\r\n                    ) : messages.length === 0 ? (\r\n                        <div className=\"text-center text-muted-foreground py-10 text-sm\">\r\n                            {t('messages.chat.say_hello')}\r\n                        </div>\r\n                    ) : (\r\n                        messages.map((msg) => {\r\n                            const isMe = msg.senderId === currentUserId;\r\n                            return (\r\n                                <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>\r\n                                    <div className={`max-w-[75%] px-4 py-2 rounded-2xl text-sm ${isMe\r\n                                        ? 'bg-primary text-primary-foreground rounded-br-none'\r\n                                        : 'bg-white dark:bg-card text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-white/5 rounded-bl-none shadow-sm'\r\n                                        }`}>\r\n                                        {msg.content}\r\n                                        <div className={`text-[10px] mt-1 opacity-70 ${isMe ? 'text-primary-foreground/80' : 'text-gray-500'}`}>\r\n                                            {formatDistanceToNow(new Date(msg.createdAt), { addSuffix: true })}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })\r\n                    )}\r\n                    <div ref={scrollRef} />\r\n                </div>\r\n            </ScrollArea>\r\n\r\n            {/* Input Area */}\r\n            <div className=\"p-4 bg-white dark:bg-card border-t border-gray-100 dark:border-white/5\">\r\n                <form\r\n                    onSubmit={(e) => { e.preventDefault(); handleSend(); }}\r\n                    className=\"flex gap-2 items-center\"\r\n                >\r\n                    <Popover>\r\n                        <PopoverTrigger asChild>\r\n                            <Button variant=\"ghost\" size=\"icon\" className=\"shrink-0 text-muted-foreground hover:text-foreground\">\r\n                                <Smile className=\"w-5 h-5\" />\r\n                            </Button>\r\n                        </PopoverTrigger>\r\n                        <PopoverContent className=\"w-full p-2\" align=\"start\">\r\n                            <div className=\"grid grid-cols-8 gap-2\">\r\n                                {[\"üëç\", \"‚ù§Ô∏è\", \"üòÇ\", \"üòÆ\", \"üò¢\", \"üò°\", \"üéâ\", \"üî•\", \"üòé\", \"‚ú®\", \"üëã\", \"üôè\", \"ü§ù\", \"üëÄ\", \"üíØ\", \"ü§î\"].map(emoji => (\r\n                                    <button\r\n                                        key={emoji}\r\n                                        onClick={() => setInputText(prev => prev + emoji)}\r\n                                        className=\"text-xl hover:bg-muted p-1 rounded transition-colors\"\r\n                                        type=\"button\"\r\n                                    >\r\n                                        {emoji}\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        </PopoverContent>\r\n                    </Popover>\r\n\r\n                    <Input\r\n                        placeholder={t('messages.input.placeholder')}\r\n                        value={inputText}\r\n                        onChange={(e) => setInputText(e.target.value)}\r\n                        className=\"flex-1 bg-gray-100 dark:bg-secondary border-none focus-visible:ring-1 focus-visible:ring-primary\"\r\n                    />\r\n                    <Button type=\"submit\" size=\"icon\" disabled={!inputText.trim() || isSending} className=\"shrink-0\">\r\n                        <Send className=\"w-4 h-4\" />\r\n                    </Button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\chat\\messages-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[419,422],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[419,422],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[446,449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[446,449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[462,465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[462,465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[487,490],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[487,490],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { ChatList } from \"@/components/chat/chat-list\";\r\nimport { ChatWindow } from \"@/components/chat/chat-window\";\r\nimport { NewChatDialog } from \"@/components/chat/new-chat-dialog\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport { MessageSquare } from \"lucide-react\";\r\n\r\ninterface MessagesViewProps {\r\n    chats: any[];\r\n    activeSession: any;\r\n    user: any;\r\n    familyMembers: any[];\r\n    activeChatId: string | null;\r\n}\r\n\r\nexport function MessagesView({ chats, activeSession, user, familyMembers, activeChatId }: MessagesViewProps) {\r\n    const { t } = useLanguage();\r\n\r\n    return (\r\n        <MainLayout className=\"max-w-7xl w-full h-[calc(100vh-theme(spacing.32))]\">\r\n            <div className=\"flex gap-6 h-full\">\r\n                {/* Sidebar List */}\r\n                <div className={`w-full md:w-80 flex flex-col bg-white dark:bg-card rounded-xl border border-gray-200 dark:border-white/5 overflow-hidden shadow-sm ${activeChatId ? 'hidden md:flex' : 'flex'}`}>\r\n                    <div className=\"p-4 border-b border-gray-100 dark:border-white/5 flex items-center justify-between\">\r\n                        <h1 className=\"font-bold text-xl tracking-tight\">{t('nav.messages')}</h1>\r\n                        <NewChatDialog familyMembers={familyMembers} />\r\n                    </div>\r\n                    <div className=\"flex-1 overflow-y-auto\">\r\n                        <ChatList chats={chats} />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Main Chat Area */}\r\n                <div className={`flex-1 ${!activeChatId ? 'hidden md:flex' : 'flex'} flex-col h-full`}>\r\n                    {activeSession ? (\r\n                        <ChatWindow session={activeSession} currentUserId={user.id} />\r\n                    ) : (\r\n                        <div className=\"flex-1 flex flex-col items-center justify-center bg-white/50 dark:bg-card/50 rounded-xl border border-dashed border-gray-200 dark:border-white/10 p-8 text-center text-muted-foreground animate-in fade-in zoom-in-95 duration-500 h-full\">\r\n                            <div className=\"h-16 w-16 bg-muted/50 rounded-full flex items-center justify-center mb-4\">\r\n                                <MessageSquare className=\"w-8 h-8 opacity-50\" />\r\n                            </div>\r\n                            <h2 className=\"text-xl font-semibold mb-2 text-foreground\">{t('messages.select')}</h2>\r\n                            <p className=\"max-w-xs text-sm\">\r\n                                {t('messages.placeholder.desc')}\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\chat\\new-chat-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\events\\create-event-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":11,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calendar"},"fix":{"range":[481,491],"text":""},"desc":"Remove unused variable \"Calendar\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { createEvent } from \"@/app/actions/events\";\r\nimport { toast } from \"sonner\";\r\nimport { Loader2, Plus, Calendar } from \"lucide-react\";\r\n\r\nexport function CreateEventDialog() {\r\n    const [open, setOpen] = useState(false);\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [formData, setFormData] = useState({\r\n        title: \"\",\r\n        location: \"\",\r\n        description: \"\",\r\n        date: \"\" // YYYY-MM-DDTHH:mm\r\n    });\r\n\r\n    const handleSubmit = async () => {\r\n        if (!formData.title || !formData.date) {\r\n            toast.error(\"Title and Date are required\");\r\n            return;\r\n        }\r\n\r\n        setIsSubmitting(true);\r\n        try {\r\n            await createEvent({\r\n                ...formData,\r\n                date: new Date(formData.date)\r\n            });\r\n            toast.success(\"Event created! üéâ\");\r\n            setOpen(false);\r\n            setFormData({ title: \"\", location: \"\", description: \"\", date: \"\" });\r\n        } catch {\r\n            toast.error(\"Failed to create event\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={setOpen}>\r\n            <DialogTrigger asChild>\r\n                <Button className=\"gap-2 bg-primary hover:bg-primary/90 text-white border-0 shadow-lg shadow-primary/20\">\r\n                    <Plus className=\"w-4 h-4\" />\r\n                    New Event\r\n                </Button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"sm:max-w-[425px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Plan a Gathering</DialogTitle>\r\n                </DialogHeader>\r\n                <div className=\"grid gap-4 py-4\">\r\n                    <div className=\"grid gap-2\">\r\n                        <Label htmlFor=\"title\">Event Title</Label>\r\n                        <Input\r\n                            id=\"title\"\r\n                            placeholder=\"e.g. Grandma's 80th Birthday\"\r\n                            value={formData.title}\r\n                            onChange={(e) => setFormData({ ...formData, title: e.target.value })}\r\n                        />\r\n                    </div>\r\n                    <div className=\"grid gap-2\">\r\n                        <Label htmlFor=\"date\">Date & Time</Label>\r\n                        <Input\r\n                            id=\"date\"\r\n                            type=\"datetime-local\"\r\n                            value={formData.date}\r\n                            onChange={(e) => setFormData({ ...formData, date: e.target.value })}\r\n                        />\r\n                    </div>\r\n                    <div className=\"grid gap-2\">\r\n                        <Label htmlFor=\"location\">Location</Label>\r\n                        <Input\r\n                            id=\"location\"\r\n                            placeholder=\"e.g. The Old Family House\"\r\n                            value={formData.location}\r\n                            onChange={(e) => setFormData({ ...formData, location: e.target.value })}\r\n                        />\r\n                    </div>\r\n                    <div className=\"grid gap-2\">\r\n                        <Label htmlFor=\"description\">Details</Label>\r\n                        <Textarea\r\n                            id=\"description\"\r\n                            placeholder=\"Add details about food, dress code, etc.\"\r\n                            value={formData.description}\r\n                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}\r\n                        />\r\n                    </div>\r\n                </div>\r\n                <DialogFooter>\r\n                    <Button onClick={handleSubmit} disabled={isSubmitting}>\r\n                        {isSubmitting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : \"Create Event\"}\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\events\\event-card.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardContent' is defined but never used.","line":4,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardContent"},"fix":{"range":[100,113],"text":""},"desc":"Remove unused variable \"CardContent\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardFooter' is defined but never used.","line":4,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardFooter"},"fix":{"range":[113,125],"text":""},"desc":"Remove unused variable \"CardFooter\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":4,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[125,137],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used.","line":8,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Users"},"fix":{"range":[376,383],"text":""},"desc":"Remove unused variable \"Users\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Event, joinEvent, leaveEvent } from \"@/app/actions/events\";\r\nimport { Card, CardContent, CardFooter, CardHeader } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { format } from \"date-fns\";\r\nimport { MapPin, Calendar as CalendarIcon, Users, Loader2, Check } from \"lucide-react\";\r\nimport { useState } from \"react\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface EventCardProps {\r\n    event: Event;\r\n    currentUserId: string;\r\n}\r\n\r\nexport function EventCard({ event, currentUserId }: EventCardProps) {\r\n    const [isUpdating, setIsUpdating] = useState(false);\r\n    const isAttending = event.attendees.includes(currentUserId);\r\n    const date = new Date(event.date);\r\n\r\n    const handleToggle = async () => {\r\n        setIsUpdating(true);\r\n        try {\r\n            if (isAttending) {\r\n                await leaveEvent(event.id);\r\n                toast.info(\"You're no longer attending.\");\r\n            } else {\r\n                await joinEvent(event.id);\r\n                toast.success(\"You're going! üèÉ‚Äç‚ôÇÔ∏è\");\r\n            }\r\n        } catch {\r\n            toast.error(\"Failed to update status\");\r\n        } finally {\r\n            setIsUpdating(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Card className=\"hover:shadow-md transition-shadow dark:border-white/10 overflow-hidden group\">\r\n            <div className=\"flex flex-col sm:flex-row h-full\">\r\n                {/* Date Badge */}\r\n                <div className=\"bg-primary/10 dark:bg-primary/20 sm:w-24 flex sm:flex-col items-center justify-center p-4 gap-2 sm:gap-0 border-b sm:border-b-0 sm:border-r border-primary/10 dark:border-white/5\">\r\n                    <span className=\"text-xl sm:text-2xl font-bold text-primary dark:text-primary-foreground uppercase\">\r\n                        {format(date, \"MMM\")}\r\n                    </span>\r\n                    <span className=\"text-3xl sm:text-4xl font-extrabold text-slate-800 dark:text-slate-100\">\r\n                        {format(date, \"d\")}\r\n                    </span>\r\n                    <span className=\"text-sm font-medium text-slate-500 uppercase\">\r\n                        {format(date, \"EEE\")}\r\n                    </span>\r\n                </div>\r\n\r\n                <div className=\"flex-1 flex flex-col p-5\">\r\n                    <div className=\"flex justify-between items-start mb-2\">\r\n                        <div>\r\n                            <h3 className=\"text-xl font-bold text-foreground mb-1 group-hover:text-primary transition-colors\">\r\n                                {event.title}\r\n                            </h3>\r\n                            {event.location && (\r\n                                <div className=\"flex items-center text-sm text-gray-500 gap-1\">\r\n                                    <MapPin className=\"w-4 h-4\" />\r\n                                    {event.location}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                        <div className=\"flex items-center text-xs text-gray-400 bg-gray-100 dark:bg-white/5 px-2 py-1 rounded-full\">\r\n                            <CalendarIcon className=\"w-3 h-3 mr-1\" />\r\n                            {format(date, \"h:mm a\")}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <p className=\"text-gray-600 dark:text-gray-300 text-sm mb-4 line-clamp-2\">\r\n                        {event.description}\r\n                    </p>\r\n\r\n                    <div className=\"mt-auto flex justify-between items-center pt-2 sm:pt-0\">\r\n                        <div className=\"flex -space-x-2\">\r\n                            {event.attendeeProfiles?.slice(0, 5).map((profile, i) => (\r\n                                <Avatar key={i} className=\"w-8 h-8 border-2 border-white dark:border-zinc-900\">\r\n                                    <AvatarImage src={profile.imageUrl || undefined} />\r\n                                    <AvatarFallback>{profile.displayName?.charAt(0)}</AvatarFallback>\r\n                                </Avatar>\r\n                            ))}\r\n                            {event.attendees.length > 5 && (\r\n                                <div className=\"w-8 h-8 rounded-full bg-gray-100 dark:bg-zinc-800 flex items-center justify-center text-xs font-semibold text-gray-600 border-2 border-white dark:border-zinc-900\">\r\n                                    +{event.attendees.length - 5}\r\n                                </div>\r\n                            )}\r\n                            {event.attendees.length === 0 && (\r\n                                <span className=\"text-sm text-gray-400 italic\">Be the first to join!</span>\r\n                            )}\r\n                        </div>\r\n\r\n                        <Button\r\n                            variant={isAttending ? \"outline\" : \"default\"}\r\n                            size=\"sm\"\r\n                            onClick={handleToggle}\r\n                            disabled={isUpdating}\r\n                            className={isAttending ? \"border-green-500 text-green-600 hover:text-green-700 hover:bg-green-50\" : \"\"}\r\n                        >\r\n                            {isUpdating ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : isAttending ? (\r\n                                <>\r\n                                    <Check className=\"w-4 h-4 mr-1\" /> Going\r\n                                </>\r\n                            ) : \"Join\"}\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\events\\event-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleLeave' is assigned a value but never used.","line":34,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { CalendarIcon, MapPin } from \"lucide-react\"\r\nimport { format } from \"date-fns\"\r\nimport { joinEvent, leaveEvent } from \"@/app/actions/events\"\r\nimport { toast } from \"sonner\"\r\nimport { useAuth } from \"@/components/auth-provider\"\r\n\r\ntype Event = {\r\n    id: string;\r\n    title: string;\r\n    description: string | null;\r\n    date: Date;\r\n    location: string | null;\r\n    attendees: string[] | null;\r\n    creatorId: string;\r\n}\r\n\r\nexport function EventList({ events }: { events: Event[] }) {\r\n    const { user } = useAuth();\r\n\r\n    const handleJoin = async (id: string) => {\r\n        try {\r\n            await joinEvent(id);\r\n            toast.success(\"You're going! üèÉ‚Äç‚ôÇÔ∏è\");\r\n        } catch {\r\n            toast.error(\"Failed to join.\");\r\n        }\r\n    };\r\n\r\n    const handleLeave = async (id: string) => {\r\n        try {\r\n            await leaveEvent(id);\r\n            toast.success(\"Cancelled RSVP\");\r\n        } catch {\r\n            toast.error(\"Failed to leave.\");\r\n        }\r\n    };\r\n\r\n    if (events.length === 0) {\r\n        return (\r\n            <div className=\"text-center py-12 bg-white rounded-lg border border-dashed border-gray-200\">\r\n                <p className=\"text-gray-500\">No upcoming events. Plan one now!</p>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"grid md:grid-cols-2 gap-4\">\r\n            {events.map((event) => {\r\n                const isAttending = user && event.attendees?.includes(user.uid);\r\n\r\n                return (\r\n                    <Card key={event.id} className=\"border-l-4 border-l-primary shadow-sm hover:shadow-md transition-all\">\r\n                        <CardHeader className=\"pb-2\">\r\n                            <CardTitle className=\"flex justify-between items-start text-lg\">\r\n                                <span>{event.title}</span>\r\n                                {isAttending && <Badge variant=\"secondary\" className=\"bg-primary/10 text-primary\">Going</Badge>}\r\n                            </CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent className=\"space-y-3\">\r\n                            <div className=\"flex items-center text-sm text-gray-500 gap-2\">\r\n                                <CalendarIcon className=\"w-4 h-4\" />\r\n                                <span>{format(new Date(event.date), \"PPP\")}</span>\r\n                            </div>\r\n                            {event.location && (\r\n                                <div className=\"flex items-center text-sm text-gray-500 gap-2\">\r\n                                    <MapPin className=\"w-4 h-4\" />\r\n                                    <span>{event.location}</span>\r\n                                </div>\r\n                            )}\r\n                            {event.description && (\r\n                                <p className=\"text-gray-600 text-sm mt-2\">{event.description}</p>\r\n                            )}\r\n\r\n                            <div className=\"pt-2 flex justify-between items-center\">\r\n                                <span className=\"text-xs text-gray-400\">\r\n                                    {(event.attendees?.length || 0)} attending\r\n                                </span>\r\n                                {!isAttending && (\r\n                                    <Button size=\"sm\" variant=\"outline\" onClick={() => handleJoin(event.id)}>\r\n                                        I'll be there\r\n                                    </Button>\r\n                                )}\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n                )\r\n            })}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\family\\family-request-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1522,1525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1522,1525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1951,1954],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1951,1954],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2354,2357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2354,2357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3667,3670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3667,3670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chanc\\Documents\\WeAreFamily\\components\\family\\family-request-button.tsx:25:9\n  23 |     useEffect(() => {\n  24 |         // eslint-disable-next-line react-hooks/set-state-in-effect\n> 25 |         setStatus(initialStatus)\n     |         ^^^^^^^^^ Avoid calling setState() directly within an effect\n  26 |          \n  27 |         setRequestId(initialRequestId)\n  28 |     }, [initialStatus, initialRequestId])","line":25,"column":9,"nodeType":null,"endLine":25,"endColumn":18,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { sendFamilyRequest, cancelFamilyRequest, acceptFamilyRequest, denyFamilyRequest, FamilyStatus } from \"@/app/actions/family\"\r\nimport { toast } from \"sonner\"\r\nimport { UserPlus, UserCheck, UserX, Loader2 } from \"lucide-react\"\r\nimport { useState, useTransition, useEffect } from \"react\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface FamilyRequestButtonProps {\r\n    targetUserId: string\r\n    initialStatus: FamilyStatus\r\n    initialRequestId?: string\r\n    className?: string\r\n}\r\n\r\nexport function FamilyRequestButton({ targetUserId, initialStatus, initialRequestId, className }: FamilyRequestButtonProps) {\r\n    const [status, setStatus] = useState<FamilyStatus>(initialStatus)\r\n    const [requestId, setRequestId] = useState<string | undefined>(initialRequestId)\r\n    const [isPending, startTransition] = useTransition()\r\n\r\n    // Sync state with props if they change (e.g. navigation)\r\n    useEffect(() => {\r\n        // eslint-disable-next-line react-hooks/set-state-in-effect\r\n        setStatus(initialStatus)\r\n         \r\n        setRequestId(initialRequestId)\r\n    }, [initialStatus, initialRequestId])\r\n\r\n    const handleSend = () => {\r\n        startTransition(async () => {\r\n            try {\r\n                const newId = await sendFamilyRequest(targetUserId)\r\n                setStatus({ status: 'pending_sent', requestId: newId })\r\n                setRequestId(newId)\r\n                toast.success(\"Request sent\")\r\n            } catch (err: any) {\r\n                toast.error(err.message)\r\n            }\r\n        })\r\n    }\r\n\r\n    const handleCancel = () => {\r\n        if (!requestId) return\r\n        startTransition(async () => {\r\n            try {\r\n                await cancelFamilyRequest(requestId)\r\n                setStatus({ status: 'none' })\r\n                setRequestId(undefined)\r\n                toast.success(\"Request canceled\")\r\n            } catch (err: any) {\r\n                toast.error(err.message)\r\n            }\r\n        })\r\n    }\r\n\r\n    const handleAccept = () => {\r\n        if (!requestId) return\r\n        startTransition(async () => {\r\n            try {\r\n                await acceptFamilyRequest(requestId)\r\n                setStatus({ status: 'accepted', requestId })\r\n                toast.success(\"Request accepted\")\r\n            } catch (err: any) {\r\n                toast.error(err.message)\r\n            }\r\n        })\r\n    }\r\n\r\n    if (status.status === 'accepted') {\r\n        return (\r\n            <Button variant=\"outline\" className={cn(\"gap-2 text-green-600 border-green-200 cursor-default hover:text-green-600 hover:bg-green-50\", className)}>\r\n                <UserCheck className=\"w-4 h-4\" />\r\n                Family\r\n            </Button>\r\n        )\r\n    }\r\n\r\n    if (status.status === 'pending_sent') {\r\n        return (\r\n            <Button\r\n                variant=\"secondary\"\r\n                className={cn(\"gap-2 whitespace-nowrap\", className)}\r\n                onClick={handleCancel}\r\n                disabled={isPending}\r\n            >\r\n                {isPending ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <UserX className=\"w-4 h-4\" />}\r\n                Cancel Request\r\n            </Button>\r\n        )\r\n    }\r\n\r\n    if (status.status === 'pending_received') {\r\n        const handleDeny = () => {\r\n            if (!requestId) return\r\n            startTransition(async () => {\r\n                try {\r\n                    await denyFamilyRequest(requestId)\r\n                    setStatus({ status: 'none' })\r\n                    setRequestId(undefined)\r\n                    toast.success(\"Request denied\")\r\n                } catch (err: any) {\r\n                    toast.error(err.message)\r\n                }\r\n            })\r\n        }\r\n\r\n        return (\r\n            <div className=\"flex items-center gap-2\">\r\n                <Button\r\n                    variant=\"default\"\r\n                    className={cn(\"gap-2 bg-blue-600 hover:bg-blue-700\", className)}\r\n                    onClick={handleAccept}\r\n                    disabled={isPending}\r\n                >\r\n                    {isPending ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <UserPlus className=\"w-4 h-4\" />}\r\n                    Accept\r\n                </Button>\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    size=\"icon\"\r\n                    className=\"text-red-500 hover:text-red-600 hover:bg-red-50\"\r\n                    onClick={handleDeny}\r\n                    disabled={isPending}\r\n                    title=\"Deny Request\"\r\n                >\r\n                    <UserX className=\"w-4 h-4\" />\r\n                    <span className=\"sr-only\">Deny</span>\r\n                </Button>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <Button\r\n            variant=\"default\"\r\n            className={cn(\"gap-2 whitespace-nowrap\", className)}\r\n            onClick={handleSend}\r\n            disabled={isPending}\r\n        >\r\n            {isPending ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <UserPlus className=\"w-4 h-4\" />}\r\n            Add Family\r\n        </Button>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\family\\family-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[582,585],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[582,585],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[600,603],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[600,603],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[627,630],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[627,630],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2328,2331],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2328,2331],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":73,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4284,4287],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4284,4287],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6820,6823],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6820,6823],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { SearchUsers } from \"@/components/family/search-users\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport Link from \"next/link\";\r\nimport { FamilyRequestButton } from \"@/components/family/family-request-button\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\ninterface FamilyViewProps {\r\n    incoming: any[];\r\n    sent: any[];\r\n    familyMembers: any[];\r\n}\r\n\r\nexport function FamilyView({ incoming, sent, familyMembers }: FamilyViewProps) {\r\n    const { t } = useLanguage();\r\n\r\n    return (\r\n        <MainLayout className=\"max-w-6xl\">\r\n            <div className=\"space-y-6 pb-16\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-bold tracking-tight\">{t('family.title')}</h1>\r\n                    <p className=\"text-muted-foreground\">{t('family.desc')}</p>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n                    {/* Left Column: Search & Requests */}\r\n                    <div className=\"lg:col-span-1 space-y-6\">\r\n                        <Card>\r\n                            <CardHeader>\r\n                                <CardTitle>{t('family.find')}</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <SearchUsers />\r\n                            </CardContent>\r\n                        </Card>\r\n\r\n                        {(incoming.length > 0 || sent.length > 0) && (\r\n                            <Card>\r\n                                <CardHeader>\r\n                                    <CardTitle>{t('family.requests')}</CardTitle>\r\n                                </CardHeader>\r\n                                <CardContent className=\"space-y-6\">\r\n                                    {incoming.length > 0 && (\r\n                                        <div className=\"space-y-3\">\r\n                                            <h3 className=\"text-sm font-medium text-muted-foreground\">{t('family.incoming')}</h3>\r\n                                            {incoming.map((req: any) => (\r\n                                                <div key={req.id} className=\"flex flex-col gap-2 p-3 bg-muted/50 rounded-lg\">\r\n                                                    <div className=\"flex items-center gap-2\">\r\n                                                        <Avatar className=\"w-8 h-8\">\r\n                                                            <AvatarImage src={req.sender.imageUrl} />\r\n                                                            <AvatarFallback>{req.sender.email.slice(0, 2).toUpperCase()}</AvatarFallback>\r\n                                                        </Avatar>\r\n                                                        <span className=\"text-sm font-medium truncate\">{req.sender.displayName || req.sender.email}</span>\r\n                                                    </div>\r\n                                                    <FamilyRequestButton\r\n                                                        targetUserId={req.senderId}\r\n                                                        initialStatus={{ status: 'pending_received', requestId: req.id }}\r\n                                                        initialRequestId={req.id}\r\n                                                        className=\"w-full h-8 text-xs\"\r\n                                                    />\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                    {incoming.length > 0 && sent.length > 0 && <Separator />}\r\n                                    {sent.length > 0 && (\r\n                                        <div className=\"space-y-3\">\r\n                                            <h3 className=\"text-sm font-medium text-muted-foreground\">{t('family.sent')}</h3>\r\n                                            {sent.map((req: any) => (\r\n                                                <div key={req.id} className=\"flex flex-col gap-2 p-3 bg-muted/50 rounded-lg\">\r\n                                                    <div className=\"flex items-center gap-2\">\r\n                                                        <Avatar className=\"w-8 h-8\">\r\n                                                            <AvatarImage src={req.receiver.imageUrl} />\r\n                                                            <AvatarFallback>{req.receiver.email.slice(0, 2).toUpperCase()}</AvatarFallback>\r\n                                                        </Avatar>\r\n                                                        <span className=\"text-sm font-medium truncate\">{req.receiver.displayName || req.receiver.email}</span>\r\n                                                    </div>\r\n                                                    <FamilyRequestButton\r\n                                                        targetUserId={req.receiverId}\r\n                                                        initialStatus={{ status: 'pending_sent', requestId: req.id }}\r\n                                                        initialRequestId={req.id}\r\n                                                        className=\"w-full h-8 text-xs\"\r\n                                                    />\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                </CardContent>\r\n                            </Card>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Right Column: My Family Grid */}\r\n                    <div className=\"lg:col-span-2\">\r\n                        <Card>\r\n                            <CardHeader>\r\n                                <CardTitle>{t('family.my_family')} ({familyMembers.length})</CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                {familyMembers.length === 0 ? (\r\n                                    <div className=\"text-center py-10 text-muted-foreground\">\r\n                                        {t('family.empty')}\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-4\">\r\n                                        {familyMembers.map((member: any) => (\r\n                                            <Link key={member.id} href={`/u/${member.id}`} className=\"block group\">\r\n                                                <div className=\"flex flex-col items-center p-4 border rounded-lg bg-card hover:border-primary/50 transition-colors\">\r\n                                                    <Avatar className=\"w-20 h-20 mb-3 border-2 border-background group-hover:scale-105 transition-transform\">\r\n                                                        <AvatarImage src={member.imageUrl} />\r\n                                                        <AvatarFallback>{member.email.slice(0, 2).toUpperCase()}</AvatarFallback>\r\n                                                    </Avatar>\r\n                                                    <span className=\"font-semibold text-center truncate w-full\">{member.displayName || member.email}</span>\r\n                                                </div>\r\n                                            </Link>\r\n                                        ))}\r\n                                    </div>\r\n                                )}\r\n                            </CardContent>\r\n                        </Card>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\family\\search-users.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[558,561],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[558,561],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { useState, useTransition } from \"react\"\r\nimport { searchUsers } from \"@/app/actions/family\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { FamilyRequestButton } from \"./family-request-button\"\r\nimport { Loader2, Search } from \"lucide-react\"\r\nimport { useDebouncedCallback } from \"use-debounce\"\r\nimport Link from \"next/link\"\r\n\r\nexport function SearchUsers() {\r\n    const [query, setQuery] = useState(\"\")\r\n    const [results, setResults] = useState<any[]>([])\r\n    const [isSearching, startTransition] = useTransition()\r\n\r\n    const handleSearch = useDebouncedCallback((term: string) => {\r\n        if (term.length < 2) {\r\n            setResults([])\r\n            return\r\n        }\r\n        startTransition(async () => {\r\n            const users = await searchUsers(term)\r\n            setResults(users)\r\n        })\r\n    }, 500)\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"relative\">\r\n                <Search className=\"absolute left-3 top-3 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                    placeholder=\"Search for members...\"\r\n                    className=\"pl-9\"\r\n                    onChange={(e) => {\r\n                        setQuery(e.target.value)\r\n                        handleSearch(e.target.value)\r\n                    }}\r\n                />\r\n            </div>\r\n\r\n            {isSearching && (\r\n                <div className=\"flex justify-center py-4\">\r\n                    <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\r\n                </div>\r\n            )}\r\n\r\n            {!isSearching && results.length === 0 && query.length >= 2 && (\r\n                <div className=\"text-center text-sm text-muted-foreground py-4\">\r\n                    No users found matching \"{query}\"\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"space-y-2\">\r\n                {results.map((user) => (\r\n                    <div key={user.id} className=\"flex items-center justify-between p-3 rounded-lg border bg-card text-card-foreground shadow-sm gap-3\">\r\n                        <Link href={`/u/${user.id}`} className=\"flex items-center gap-3 hover:opacity-80 transition-opacity flex-1 min-w-0\">\r\n                            <Avatar>\r\n                                <AvatarImage src={user.imageUrl} />\r\n                                <AvatarFallback>{user.displayName?.slice(0, 2).toUpperCase() || user.email.slice(0, 2).toUpperCase()}</AvatarFallback>\r\n                            </Avatar>\r\n                            <div className=\"flex flex-col min-w-0\">\r\n                                <span className=\"font-medium truncate\">{user.displayName || user.email}</span>\r\n                                {user.displayName && <span className=\"text-xs text-muted-foreground truncate\">{user.email}</span>}\r\n                            </div>\r\n                        </Link>\r\n                        <FamilyRequestButton\r\n                            targetUserId={user.id}\r\n                            initialStatus={user.familyStatus.status}\r\n                            initialRequestId={user.familyStatus.requestId}\r\n                            className=\"h-8 text-xs\"\r\n                        />\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\ask-ai-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogFooter' is defined but never used.","line":3,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":72,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogFooter"},"fix":{"range":[74,88],"text":""},"desc":"Remove unused variable \"DialogFooter\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Sparkles, FileText, HelpCircle, AlertTriangle, MessageSquare, Loader2 } from \"lucide-react\";\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { createConversation } from \"@/app/actions/ai-chat\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface AskAIDialogProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    postContent: string;\r\n    postAuthor: string;\r\n}\r\n\r\nexport function AskAIDialog({ isOpen, onClose, postContent, postAuthor }: AskAIDialogProps) {\r\n    const [customQuery, setCustomQuery] = useState(\"\");\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const router = useRouter();\r\n\r\n    const handleAction = async (action: string) => {\r\n        setIsLoading(true);\r\n        try {\r\n            let prompt = \"\";\r\n            const context = `Context (Post by ${postAuthor}):\\n\"${postContent.substring(0, 1000)}${postContent.length > 1000 ? '...' : ''}\"\\n\\n`;\r\n\r\n            switch (action) {\r\n                case 'summarize':\r\n                    prompt = `${context}User Request:\\nPlease summarize the key points of this post.`;\r\n                    break;\r\n                case 'explain':\r\n                    prompt = `${context}User Request:\\nPlease explain the concepts or context mentioned in this post in simple terms.`;\r\n                    break;\r\n                case 'fact-check':\r\n                    prompt = `${context}User Request:\\nPlease fact-check any claims made in this post and provide context if needed.`;\r\n                    break;\r\n                default: // Custom\r\n                    if (!customQuery.trim()) return;\r\n                    prompt = `${context}User Request:\\n${customQuery}`;\r\n                    break;\r\n            }\r\n\r\n            // Create conversation and redirect\r\n            const chatId = await createConversation(prompt, 'general', 'gpt-4o');\r\n\r\n            toast.success(\"Opening AI Chat...\");\r\n            router.push(`/chat?id=${chatId}`);\r\n            onClose();\r\n        } catch (error) {\r\n            console.error(\"Failed to start chat\", error);\r\n            toast.error(\"Failed to start AI chat\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={onClose}>\r\n            <DialogContent className=\"sm:max-w-md\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <Sparkles className=\"w-5 h-5 text-primary\" />\r\n                        Ask AI about this Post\r\n                    </DialogTitle>\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-4 py-4\">\r\n                    <div className=\"p-3 bg-muted/50 rounded-lg text-xs text-muted-foreground italic border border-border/50 max-h-24 overflow-y-auto\">\r\n                        \"{postContent.substring(0, 200)}{postContent.length > 200 ? '...' : ''}\"\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-2\">\r\n                        <Button variant=\"outline\" className=\"justify-start gap-2 h-auto py-3\" onClick={() => handleAction('summarize')} disabled={isLoading}>\r\n                            <FileText className=\"w-4 h-4 text-blue-500\" />\r\n                            <div className=\"flex flex-col items-start\">\r\n                                <span className=\"font-semibold text-xs\">Summarize</span>\r\n                                <span className=\"text-[10px] text-muted-foreground font-normal\">Get key points</span>\r\n                            </div>\r\n                        </Button>\r\n                        <Button variant=\"outline\" className=\"justify-start gap-2 h-auto py-3\" onClick={() => handleAction('explain')} disabled={isLoading}>\r\n                            <HelpCircle className=\"w-4 h-4 text-green-500\" />\r\n                            <div className=\"flex flex-col items-start\">\r\n                                <span className=\"font-semibold text-xs\">Explain</span>\r\n                                <span className=\"text-[10px] text-muted-foreground font-normal\">Simple terms</span>\r\n                            </div>\r\n                        </Button>\r\n                        <Button variant=\"outline\" className=\"justify-start gap-2 h-auto py-3\" onClick={() => handleAction('fact-check')} disabled={isLoading}>\r\n                            <AlertTriangle className=\"w-4 h-4 text-orange-500\" />\r\n                            <div className=\"flex flex-col items-start\">\r\n                                <span className=\"font-semibold text-xs\">Fact Check</span>\r\n                                <span className=\"text-[10px] text-muted-foreground font-normal\">Verify claims</span>\r\n                            </div>\r\n                        </Button>\r\n                        <Button variant=\"outline\" className=\"justify-start gap-2 h-auto py-3 opacity-50 cursor-not-allowed\" disabled={true}>\r\n                            <MessageSquare className=\"w-4 h-4 text-purple-500\" />\r\n                            <div className=\"flex flex-col items-start\">\r\n                                <span className=\"font-semibold text-xs\">Critique</span>\r\n                                <span className=\"text-[10px] text-muted-foreground font-normal\">Coming soon</span>\r\n                            </div>\r\n                        </Button>\r\n                    </div>\r\n\r\n                    <div className=\"relative\">\r\n                        <div className=\"absolute inset-0 flex items-center\">\r\n                            <span className=\"w-full border-t\" />\r\n                        </div>\r\n                        <div className=\"relative flex justify-center text-xs uppercase\">\r\n                            <span className=\"bg-background px-2 text-muted-foreground\">Or ask specific question</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-2\">\r\n                        <Input\r\n                            placeholder=\"e.g. What does the author mean by...\"\r\n                            value={customQuery}\r\n                            onChange={(e) => setCustomQuery(e.target.value)}\r\n                            onKeyDown={(e) => e.key === 'Enter' && handleAction('custom')}\r\n                            disabled={isLoading}\r\n                        />\r\n                        <Button size=\"icon\" onClick={() => handleAction('custom')} disabled={isLoading || !customQuery.trim()}>\r\n                            {isLoading ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Sparkles className=\"w-4 h-4\" />}\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\auto-scroll-toggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\comment-item.tsx","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: ')' expected.","line":387,"column":42}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useRef } from 'react';\r\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { SafeDate } from '@/components/shared/safe-date';\r\nimport { Heart, MessageCircle, Send, Loader2, MoreHorizontal, Trash2, Edit2, Image as ImageIcon, Video, X, Sparkles } from 'lucide-react';\r\nimport { storage } from '@/lib/firebase';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\nimport { chatWithAgent } from '@/app/actions/ai-agents';\r\nimport { toast } from 'sonner';\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuItem,\r\n    DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu';\r\nimport { cn } from '@/lib/utils';\r\nimport Link from 'next/link';\r\nimport {\r\n    toggleCommentLike,\r\n    deleteComment,\r\n    editComment,\r\n    addReply,\r\n    toggleReplyLike,\r\n    deleteReply,\r\n    editReply\r\n} from '@/app/actions/posts';\r\nimport { Linkify } from '@/components/shared/linkify';\r\nimport { Reply, EnhancedComment } from '@/types/engagement';\r\nimport { REACTIONS, getReactionIcon } from './reaction-selector';\r\nimport { ReactionType } from '@/types/posts';\r\n\r\ninterface CommentItemProps {\r\n    comment: EnhancedComment;\r\n    postId: string;\r\n    currentUserId?: string;\r\n    contextType?: string;\r\n    contextId?: string;\r\n    onUpdate?: () => void;\r\n}\r\n\r\nexport function CommentItem({\r\n    comment,\r\n    postId,\r\n    currentUserId,\r\n    contextType,\r\n\r\n    contextId,\r\n    onUpdate,\r\n    postAuthorId\r\n}: CommentItemProps & { postAuthorId?: string }) {\r\n    const [showReplyInput, setShowReplyInput] = useState(false);\r\n    const [replyText, setReplyText] = useState('');\r\n    const [isSubmittingReply, setIsSubmittingReply] = useState(false);\r\n    const [showReplies, setShowReplies] = useState(true);\r\n    const [replyMediaUrl, setReplyMediaUrl] = useState<string | null>(null);\r\n    const [isUploadingReply, setIsUploadingReply] = useState(false);\r\n    const [isGeneratingReply, setIsGeneratingReply] = useState(false);\r\n    const replyFileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    const [isEditingComment, setIsEditingComment] = useState(false);\r\n    const [editContent, setEditContent] = useState(comment.content || '');\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const [likesState, setLikesState] = useState(comment.reactions || {});\r\n    const [replies, setReplies] = useState<Reply[]>(comment.replies || []);\r\n\r\n    const isAuthor = currentUserId === comment.authorId;\r\n    const canDelete = currentUserId === comment.authorId || currentUserId === postAuthorId;\r\n    const canEdit = currentUserId === comment.authorId;\r\n\r\n    // DEBUG LOGGING\r\n    if (typeof window !== 'undefined') {\r\n        console.log(`Comment ${comment.id} permissions:`, {\r\n            currentUserId,\r\n            commentAuthor: comment.authorId,\r\n            postAuthor: postAuthorId,\r\n            canEdit,\r\n            canDelete\r\n        });\r\n    }\r\n\r\n    const userReaction = currentUserId ? likesState[currentUserId] : null;\r\n    const hasLiked = !!userReaction;\r\n    const commentAuthor = comment.author ? {\r\n        ...comment.author,\r\n        displayName: (comment.author.displayName && comment.author.displayName !== \"Family Member\")\r\n            ? comment.author.displayName\r\n            : \"Unknown\"\r\n    } : { displayName: 'Unknown' };\r\n\r\n    // Handle comment like\r\n    const handleLike = async (reactionType: ReactionType) => {\r\n        if (!currentUserId) return toast.error('Please login');\r\n\r\n        const prevLikes = { ...likesState };\r\n        const newLikes = { ...likesState };\r\n\r\n        // If clicking the same reaction, remove it. Otherwise, set new reaction\r\n        if (newLikes[currentUserId] === reactionType) {\r\n            delete newLikes[currentUserId];\r\n        } else {\r\n            newLikes[currentUserId] = reactionType;\r\n        }\r\n\r\n        setLikesState(newLikes);\r\n\r\n        try {\r\n            await toggleCommentLike(postId, comment.id, reactionType, contextType, contextId);\r\n        } catch (error) {\r\n            setLikesState(prevLikes);\r\n            toast.error('Failed to react to comment');\r\n        }\r\n    };\r\n\r\n    // Handle Magic AI for reply\r\n    const handleReplyMagic = async () => {\r\n        if (!replyText.trim()) {\r\n            toast.error('Type something first!');\r\n            return;\r\n        }\r\n        setIsGeneratingReply(true);\r\n        try {\r\n            const magicText = await chatWithAgent(\r\n                `Write a thoughtful, friendly reply to this: \"${replyText}\". Keep it under 140 chars. Use emojis naturally.`,\r\n                'general'\r\n            );\r\n            setReplyText(magicText || replyText);\r\n            toast.success('Magic applied! ‚ú®');\r\n        } catch {\r\n            toast.error('Magic failed');\r\n        } finally {\r\n            setIsGeneratingReply(false);\r\n        }\r\n    };\r\n\r\n    // Handle file upload for reply\r\n    const handleReplyFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files && e.target.files[0]) {\r\n            const file = e.target.files[0];\r\n            setIsUploadingReply(true);\r\n            try {\r\n                const timestamp = Date.now();\r\n                const filename = `${timestamp}-${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;\r\n                const storageRef = ref(storage, `comments/replies/${filename}`);\r\n                const snapshot = await uploadBytes(storageRef, file);\r\n                const url = await getDownloadURL(snapshot.ref);\r\n                setReplyMediaUrl(url);\r\n                toast.success('File uploaded');\r\n            } catch (error) {\r\n                console.error('Error uploading:', error);\r\n                toast.error('Upload failed');\r\n            } finally {\r\n                setIsUploadingReply(false);\r\n                if (replyFileInputRef.current) replyFileInputRef.current.value = '';\r\n            }\r\n        }\r\n    };\r\n\r\n    // Handle reply submission\r\n    const handleReplySubmit = async () => {\r\n        if (!replyText.trim() || !currentUserId) return;\r\n\r\n        console.log('üîµ Starting reply submission:', {\r\n            postId,\r\n            commentId: comment.id,\r\n            replyText,\r\n            contextType,\r\n            contextId\r\n        });\r\n\r\n        setIsSubmittingReply(true);\r\n\r\n        try {\r\n            const newReply = await addReply(postId, comment.id, replyText, contextType, contextId);\r\n            console.log('‚úÖ Reply created successfully:', newReply);\r\n\r\n            if (newReply) {\r\n                // Cast to Reply with required fields\r\n                const replyWithMetadata: Reply = {\r\n                    ...newReply,\r\n                    commentId: comment.id,\r\n                    postId: postId\r\n                } as Reply;\r\n                setReplies(prev => [...prev, replyWithMetadata]);\r\n                setReplyText('');\r\n                setReplyMediaUrl(null);\r\n                setShowReplyInput(false);\r\n                toast.success('Reply added');\r\n                onUpdate?.();\r\n            }\r\n        } catch (error: any) { // Keep explicit any here if we need access to .message, or cast it.\r\n            // Actually, best to cast: (error as Error).message\r\n            const err = error as Error;\r\n            console.error('‚ùå Reply submission failed:', err);\r\n\r\n            // Check for Server Action version mismatch\r\n            if (err.message?.includes('not found on the server')) {\r\n                toast.error('New update available. Refreshing...');\r\n                setTimeout(() => {\r\n                    window.location.reload();\r\n                }, 1500);\r\n                return;\r\n            }\r\n\r\n            console.error('Error details:', {\r\n                message: err.message,\r\n                // code: (err as any).code, // Optional\r\n                stack: err.stack\r\n            });\r\n            toast.error(`Failed to add reply: ${err.message || 'Unknown error'}`);\r\n        } finally {\r\n            setIsSubmittingReply(false);\r\n        }\r\n    };\r\n\r\n    // Handle comment edit\r\n    const handleEditSave = async () => {\r\n        if (!editContent.trim()) return;\r\n        setIsSaving(true);\r\n\r\n        try {\r\n            await editComment(postId, comment.id, editContent, contextType, contextId);\r\n            toast.success('Comment updated');\r\n            setIsEditingComment(false);\r\n            onUpdate?.();\r\n        } catch (error) {\r\n            toast.error('Failed to update comment');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    // Handle comment delete\r\n    const handleDelete = async () => {\r\n        if (!confirm('Delete this comment?')) return;\r\n\r\n        try {\r\n            await deleteComment(postId, comment.id, contextType, contextId);\r\n            toast.success('Comment deleted');\r\n            onUpdate?.();\r\n        } catch (error) {\r\n            toast.error('Failed to delete comment');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-2\">\r\n            {/* Main Comment */}\r\n            <div className=\"bg-muted/40 p-3 rounded-lg\">\r\n                <div className=\"flex items-start gap-2\">\r\n                    <Link href={`/u/${comment.authorId}`}>\r\n                        <Avatar className=\"w-8 h-8 border border-border cursor-pointer hover:opacity-80 transition-opacity\">\r\n                            <AvatarImage src={commentAuthor.imageUrl || undefined} />\r\n                            <AvatarFallback className=\"text-xs bg-primary text-primary-foreground\">\r\n                                {commentAuthor.displayName.charAt(0)}\r\n                            </AvatarFallback>\r\n                        </Avatar>\r\n                    </Link>\r\n\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        <div className=\"flex items-center justify-between gap-2 mb-1\">\r\n                            <div className=\"flex items-center gap-2 flex-wrap\">\r\n                                <Link href={`/u/${comment.authorId}`} className=\"font-semibold text-sm hover:underline cursor-pointer\">\r\n                                    {commentAuthor.displayName}\r\n                                </Link>\r\n                                <span className=\"text-xs text-muted-foreground\">\r\n                                    <SafeDate date={comment.createdAt} />\r\n                                </span>\r\n                                {comment.isEdited && <span className=\"text-[10px] text-muted-foreground\">(edited)</span>}\r\n                            </div>\r\n\r\n                            {(canEdit || canDelete) && (\r\n                                <DropdownMenu>\r\n                                    <DropdownMenuTrigger asChild>\r\n                                        <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\">\r\n                                            <MoreHorizontal className=\"w-4 h-4\" />\r\n                                        </Button>\r\n                                    </DropdownMenuTrigger>\r\n                                    <DropdownMenuContent align=\"end\">\r\n                                        {canEdit && (\r\n                                            <DropdownMenuItem onClick={() => setIsEditingComment(true)}>\r\n                                                <Edit2 className=\"w-4 h-4 mr-2\" /> Edit\r\n                                            </DropdownMenuItem>\r\n                                        )}\r\n                                        {canDelete && (\r\n                                            <DropdownMenuItem onClick={handleDelete} className=\"text-red-500\">\r\n                                                <Trash2 className=\"w-4 h-4 mr-2\" /> Delete\r\n                                            </DropdownMenuItem>\r\n                                        )}\r\n                                    </DropdownMenuContent>\r\n                                </DropdownMenu>\r\n                            )}\r\n                        </div>\r\n\r\n                        {isEditingComment ? (\r\n                            <div className=\"space-y-2\">\r\n                                <Input\r\n                                    value={editContent}\r\n                                    onChange={(e) => setEditContent(e.target.value)}\r\n                                    className=\"w-full\"\r\n                                />\r\n                                <div className=\"flex gap-2\">\r\n                                    <Button size=\"sm\" variant=\"outline\" onClick={() => setIsEditingComment(false)}>\r\n                                        Cancel\r\n                                    </Button>\r\n                                    <Button size=\"sm\" onClick={handleEditSave} disabled={isSaving}>\r\n                                        {isSaving ? 'Saving...' : 'Save'}\r\n                                    </Button>\r\n                                </div>\r\n                            </div>\r\n                        ) : (\r\n                            <p className=\"text-sm whitespace-pre-wrap break-words\">\r\n                                <Linkify text={comment.content} />\r\n                            </p>\r\n                        )}\r\n\r\n                        {/* Comment Actions */}\r\n                        <div className=\"flex items-center gap-4 mt-2\">\r\n                            {/* Emoji Reaction Dropdown */}\r\n                            <DropdownMenu>\r\n                                <DropdownMenuTrigger asChild>\r\n                                    <Button\r\n                                        variant=\"ghost\"\r\n                                        size=\"sm\"\r\n                                        className={cn(\"h-7 px-2 gap-1\", hasLiked && \"text-pink-600\")}\r\n                                    >\r\n                                        <span className={cn(\"text-base\", hasLiked && \"scale-110\")}>\r\n                                            {hasLiked ? getReactionIcon(userReaction as ReactionType) : 'ü§ç'}\r\n                                        </span>\r\n                                        <span className=\"text-xs\">{Object.keys(likesState).length > 0 && Object.keys(likesState).length}</span>\r\n                                    </Button>\r\n                                </DropdownMenuTrigger>\r\n                                <DropdownMenuContent align=\"start\" className=\"flex gap-2 p-3 bg-background/95 backdrop-blur-sm\">\r\n                                    {REACTIONS.map(r => (\r\n                                        <button\r\n                                            key={r.type}\r\n                                            onClick={() => handleLike(r.type as ReactionType)}\r\n                                            className=\"text-2xl cursor-pointer hover:scale-150 transition-all duration-200 p-1 rounded-lg hover:bg-muted/50\"\r\n                                            title={r.label}\r\n                                        >\r\n                                            {r.emoji}\r\n                                        </button>\r\n                                    ))}\r\n                                </DropdownMenuContent>\r\n                            </DropdownMenu>\r\n\r\n                            <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => setShowReplyInput(!showReplyInput)}\r\n                                className=\"h-7 px-2 gap-1\"\r\n                            >\r\n                                <MessageCircle className=\"w-3.5 h-3.5\" />\r\n                                <span className=\"text-xs\">Reply</span>\r\n                            </Button>\r\n\r\n                            {replies.length > 0 && (\r\n                                <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    onClick={() => setShowReplies(!showReplies)}\r\n                                    className=\"h-7 px-2 text-xs text-muted-foreground\"\r\n                                >\r\n                                    {showReplies ? 'Hide' : 'Show'} {replies.length} {replies.length === 1 ? 'reply' : 'replies'}\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Reply Input */}\r\n            {showReplyInput && (\r\n                <div className=\"ml-10 space-y-2 animate-in fade-in slide-in-from-top-1\">\r\n                    {replyMediaUrl && (\r\n                        <div className=\"relative inline-block\">\r\n                            <div className=\"relative group w-20 h-20 rounded-lg overflow-hidden border border-border\">\r\n                                {replyMediaUrl.includes('.mp4') || replyMediaUrl.includes('.webm') ? (\r\n                                    <div className=\"w-full h-full bg-black flex items-center justify-center\">\r\n                                        <Video className=\"w-6 h-6 text-white/70\" />\r\n                                    </div>\r\n                                ) : (\r\n                                    {/* eslint-disable-next-line @next/next/no-img-element */ }\r\n                                    < img src={replyMediaUrl} alt=\"Upload\" className=\"w-full h-full object-cover\" />\r\n                                )}\r\n                                <button\r\n                                    onClick={() => setReplyMediaUrl(null)}\r\n                                    className=\"absolute top-0.5 right-0.5 bg-black/50 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                                >\r\n                                    <X className=\"w-3 h-3\" />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                    <div className=\"flex gap-2\">\r\n                        <Input\r\n                            placeholder=\"Write a reply...\"\r\n                            value={replyText}\r\n                            onChange={(e) => setReplyText(e.target.value)}\r\n                            onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && handleReplySubmit()}\r\n                            className=\"flex-1\"\r\n                        />\r\n                        <input\r\n                            type=\"file\"\r\n                            ref={replyFileInputRef}\r\n                            className=\"hidden\"\r\n                            accept=\"image/*,video/*\"\r\n                            onChange={handleReplyFileSelect}\r\n                            disabled={isUploadingReply}\r\n                        />\r\n                        <Button\r\n                            size=\"icon\"\r\n                            variant=\"ghost\"\r\n                            onClick={() => replyFileInputRef.current?.click()}\r\n                            disabled={isUploadingReply}\r\n                            title=\"Add photo/video\"\r\n                        >\r\n                            {isUploadingReply ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <ImageIcon className=\"w-4 h-4\" />}\r\n                        </Button>\r\n                        <Button\r\n                            size=\"icon\"\r\n                            variant=\"ghost\"\r\n                            onClick={handleReplyMagic}\r\n                            disabled={isGeneratingReply}\r\n                            className=\"text-primary hover:bg-primary/10\"\r\n                            title=\"Magic AI\"\r\n                        >\r\n                            {isGeneratingReply ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Sparkles className=\"w-4 h-4\" />}\r\n                        </Button>\r\n                        <Button\r\n                            size=\"icon\"\r\n                            onClick={handleReplySubmit}\r\n                            disabled={isSubmittingReply || !replyText.trim()}\r\n                        >\r\n                            {isSubmittingReply ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4\" />}\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Nested Replies */}\r\n            {showReplies && replies.length > 0 && (\r\n                <div className=\"ml-10 space-y-2\">\r\n                    {replies.map((reply) => (\r\n                        <ReplyItem\r\n                            key={reply.id}\r\n                            reply={reply}\r\n                            postId={postId}\r\n                            commentId={comment.id}\r\n                            currentUserId={currentUserId}\r\n                            contextType={contextType}\r\n                            contextId={contextId}\r\n                            postAuthorId={postAuthorId}\r\n                            commentAuthorId={comment.authorId}\r\n                            onUpdate={() => onUpdate?.()}\r\n                            onDelete={(replyId) => setReplies(prev => prev.filter(r => r.id !== replyId))}\r\n                        />\r\n                    ))}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n// Reply Item Component (nested under comments)\r\nfunction ReplyItem({\r\n    reply,\r\n    postId,\r\n    commentId,\r\n    currentUserId,\r\n    contextType,\r\n    contextId,\r\n    onUpdate,\r\n    onDelete,\r\n    postAuthorId,\r\n    commentAuthorId\r\n}: {\r\n    reply: Reply;\r\n    postId: string;\r\n    commentId: string;\r\n    currentUserId?: string;\r\n    contextType?: string;\r\n    contextId?: string;\r\n    onUpdate?: () => void;\r\n    onDelete?: (replyId: string) => void;\r\n    postAuthorId?: string;\r\n    commentAuthorId?: string;\r\n}) {\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editContent, setEditContent] = useState(reply.content || '');\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [likesState, setLikesState] = useState(reply.reactions || {});\r\n\r\n    const isAuthor = currentUserId === reply.authorId;\r\n    const canEdit = currentUserId === reply.authorId;\r\n    // Delete rights: Reply Author OR Comment Author OR Post Author\r\n    const canDelete = currentUserId === reply.authorId ||\r\n        currentUserId === commentAuthorId ||\r\n        currentUserId === postAuthorId;\r\n    const userReaction = currentUserId ? likesState[currentUserId] : null;\r\n    const hasLiked = !!userReaction;\r\n    const replyAuthor = reply.author ? {\r\n        ...reply.author,\r\n        displayName: (reply.author.displayName && reply.author.displayName !== \"Family Member\")\r\n            ? reply.author.displayName\r\n            : \"Unknown\"\r\n    } : { displayName: 'Unknown', imageUrl: undefined };\r\n\r\n    const handleLike = async (reactionType: ReactionType) => {\r\n        if (!currentUserId) return toast.error('Please login');\r\n\r\n        const prevLikes = { ...likesState };\r\n        const newLikes = { ...likesState };\r\n\r\n        // If clicking the same reaction, remove it. Otherwise, set new reaction\r\n        if (newLikes[currentUserId] === reactionType) {\r\n            delete newLikes[currentUserId];\r\n        } else {\r\n            newLikes[currentUserId] = reactionType;\r\n        }\r\n\r\n        setLikesState(newLikes);\r\n\r\n        try {\r\n            await toggleReplyLike(postId, commentId, reply.id || '', reactionType, contextType, contextId);\r\n        } catch (error) {\r\n            setLikesState(prevLikes);\r\n            toast.error('Failed to react to reply');\r\n        }\r\n    };\r\n\r\n    const handleEditSave = async () => {\r\n        if (!editContent.trim()) return;\r\n        setIsSaving(true);\r\n\r\n        try {\r\n            await editReply(postId, commentId, reply.id || '', editContent, contextType, contextId);\r\n            toast.success('Reply updated');\r\n            setIsEditing(false);\r\n            onUpdate?.();\r\n        } catch (error) {\r\n            toast.error('Failed to update reply');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleDelete = async () => {\r\n        if (!confirm('Delete this reply?')) return;\r\n\r\n        try {\r\n            await deleteReply(postId, commentId, reply.id || '', contextType, contextId);\r\n            toast.success('Reply deleted');\r\n            onDelete?.(reply.id || '');\r\n            onUpdate?.();\r\n        } catch (error) {\r\n            toast.error('Failed to delete reply');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-muted/20 p-2.5 rounded-lg border-l-2 border-border\">\r\n            <div className=\"flex items-start gap-2\">\r\n                <Link href={`/u/${reply.authorId}`}>\r\n                    <Avatar className=\"w-7 h-7 border border-border cursor-pointer hover:opacity-80 transition-opacity\">\r\n                        <AvatarImage src={replyAuthor.imageUrl || undefined} />\r\n                        <AvatarFallback className=\"text-xs bg-primary text-primary-foreground\">\r\n                            {replyAuthor.displayName?.charAt(0) || '?'}\r\n                        </AvatarFallback>\r\n                    </Avatar>\r\n                </Link>\r\n\r\n                <div className=\"flex-1 min-w-0\">\r\n                    <div className=\"flex items-center justify-between gap-2 mb-1\">\r\n                        <div className=\"flex items-center gap-2 flex-wrap\">\r\n                            <Link href={`/u/${reply.authorId}`} className=\"font-semibold text-xs hover:underline cursor-pointer\">\r\n                                {replyAuthor.displayName}\r\n                            </Link>\r\n                            <span className=\"text-[10px] text-muted-foreground\">\r\n                                <SafeDate date={reply.createdAt} />\r\n                            </span>\r\n                            {reply.isEdited && <span className=\"text-[9px] text-muted-foreground\">(edited)</span>}\r\n                        </div>\r\n\r\n                        {(canEdit || canDelete) && (\r\n                            <DropdownMenu>\r\n                                <DropdownMenuTrigger asChild>\r\n                                    <Button variant=\"ghost\" size=\"icon\" className=\"h-5 w-5\">\r\n                                        <MoreHorizontal className=\"w-3 h-3\" />\r\n                                    </Button>\r\n                                </DropdownMenuTrigger>\r\n                                <DropdownMenuContent align=\"end\">\r\n                                    {canEdit && (\r\n                                        <DropdownMenuItem onClick={() => setIsEditing(true)}>\r\n                                            <Edit2 className=\"w-3 h-3 mr-2\" /> Edit\r\n                                        </DropdownMenuItem>\r\n                                    )}\r\n                                    {canDelete && (\r\n                                        <DropdownMenuItem onClick={handleDelete} className=\"text-red-500\">\r\n                                            <Trash2 className=\"w-3 h-3 mr-2\" /> Delete\r\n                                        </DropdownMenuItem>\r\n                                    )}\r\n                                </DropdownMenuContent>\r\n                            </DropdownMenu>\r\n                        )}\r\n                    </div>\r\n\r\n                    {isEditing ? (\r\n                        <div className=\"space-y-2\">\r\n                            <Input\r\n                                value={editContent}\r\n                                onChange={(e) => setEditContent(e.target.value)}\r\n                                className=\"w-full text-sm\"\r\n                            />\r\n                            <div className=\"flex gap-2\">\r\n                                <Button size=\"sm\" variant=\"outline\" onClick={() => setIsEditing(false)}>\r\n                                    Cancel\r\n                                </Button>\r\n                                <Button size=\"sm\" onClick={handleEditSave} disabled={isSaving}>\r\n                                    {isSaving ? 'Saving...' : 'Save'}\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        <p className=\"text-xs whitespace-pre-wrap break-words\">\r\n                            <Linkify text={reply.content} />\r\n                        </p>\r\n                    )}\r\n\r\n                    <div className=\"mt-1.5\">\r\n                        {/* Emoji Reaction Dropdown for Replies */}\r\n                        <DropdownMenu>\r\n                            <DropdownMenuTrigger asChild>\r\n                                <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    className={cn(\"h-6 px-2 gap-1\", hasLiked && \"text-pink-600\")}\r\n                                >\r\n                                    <span className={cn(\"text-sm\", hasLiked && \"scale-110\")}>\r\n                                        {hasLiked ? getReactionIcon(userReaction as ReactionType) : 'ü§ç'}\r\n                                    </span>\r\n                                    <span className=\"text-[10px]\">{Object.keys(likesState).length > 0 && Object.keys(likesState).length}</span>\r\n                                </Button>\r\n                            </DropdownMenuTrigger>\r\n                            <DropdownMenuContent align=\"start\" className=\"flex gap-2 p-3 bg-background/95 backdrop-blur-sm\">\r\n                                {REACTIONS.map(r => (\r\n                                    <button\r\n                                        key={r.type}\r\n                                        onClick={() => handleLike(r.type as ReactionType)}\r\n                                        className=\"text-2xl cursor-pointer hover:scale-150 transition-all duration-200 p-1 rounded-lg hover:bg-muted/50\"\r\n                                        title={r.label}\r\n                                    >\r\n                                        {r.emoji}\r\n                                    </button>\r\n                                ))}\r\n                            </DropdownMenuContent>\r\n                        </DropdownMenu>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\create-post.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3260,3263],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3260,3263],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4843,4846],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4843,4846],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":161,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6587,6590],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6587,6590],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":220,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9981,9984],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9981,9984],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":250,"column":41,"nodeType":"JSXOpeningElement","endLine":250,"endColumn":111}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useRef } from \"react\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { createPost } from \"@/app/actions/posts\";\r\nimport { storage } from \"@/lib/firebase\";\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\";\r\nimport { toast } from \"sonner\";\r\nimport { ImageIcon, Loader2, Send, X, Mic, MicOff } from \"lucide-react\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { useSpeechRecognition } from \"@/hooks/use-speech-recognition\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport { VisibilitySelector, PrivacyType } from \"./visibility-selector\";\r\nimport { useMagicAI } from \"@/hooks/use-magic-ai\";\r\nimport { MagicAIButton } from \"@/components/magic-ai/magic-ai-button\";\r\nimport { AIPreviewPanel } from \"@/components/magic-ai/ai-preview-panel\";\r\n\r\n\r\n\r\ninterface CreatePostProps {\r\n    onClose?: () => void;\r\n}\r\n\r\nexport function CreatePost({ onClose }: CreatePostProps) {\r\n    const { user, profile } = useAuth();\r\n    const { t } = useLanguage();\r\n    // Admin or Verified\r\n    const isVerified = profile?.role === 'admin' || profile?.emailVerified;\r\n\r\n    const [content, setContent] = useState(\"\");\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [mediaUrls, setMediaUrls] = useState<string[]>([]);\r\n    const [thumbnailUrl, setThumbnailUrl] = useState<string | null>(null);\r\n    const [privacy, setPrivacy] = useState<PrivacyType>('public');\r\n    const [allowedViewers, setAllowedViewers] = useState<string[]>([]);\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const [lastUploadError, setLastUploadError] = useState<string | null>(null);\r\n\r\n    // Magic AI Integration\r\n    const magicAI = useMagicAI({ context: { type: 'timeline' } });\r\n\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    const { isListening, startListening, stopListening, isSupported: isSpeechSupported } = useSpeechRecognition({\r\n        onResult: (result) => setContent(prev => {\r\n            if (!prev) return result;\r\n            return prev + \" \" + result;\r\n        })\r\n    });\r\n\r\n    const handleSubmit = async () => {\r\n        if (!content.trim() && mediaUrls.length === 0) return;\r\n\r\n        setIsSubmitting(true);\r\n        try {\r\n            // Pass thumbnailUrl (undefined for engagement settings to use default)\r\n            // Pass thumbnailUrl and engagement settings\r\n            await createPost(\r\n                content,\r\n                mediaUrls,\r\n                { privacy },\r\n                thumbnailUrl,\r\n                allowedViewers.length > 0 ? allowedViewers : undefined\r\n            );\r\n            setContent(\"\");\r\n            setMediaUrls([]);\r\n            setThumbnailUrl(null);\r\n            setPrivacy('public');\r\n            setAllowedViewers([]);\r\n            toast.success(\"Moment shared successfully! ‚ù§Ô∏è\");\r\n\r\n            // If we have an onClose handler (e.g. valid submission in modal mode), close it\r\n            if (onClose) onClose();\r\n\r\n            window.location.reload();\r\n        } catch (err: any) {\r\n            console.error(\"Post creation error:\", err);\r\n            toast.error(err.message || \"Failed to share moment. Please try again.\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    }\r\n\r\n    // Magic AI handlers\r\n    const handleOpenMagicAI = () => {\r\n        magicAI.openMagic(content);\r\n    };\r\n\r\n    const handleAcceptMagic = () => {\r\n        const enhancedContent = magicAI.acceptEnhanced();\r\n        if (enhancedContent) {\r\n            setContent(enhancedContent);\r\n        }\r\n    };\r\n\r\n    const handleRevertMagic = () => {\r\n        const originalContent = magicAI.revertToOriginal();\r\n        setContent(originalContent);\r\n    };\r\n\r\n    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        setLastUploadError(null);\r\n        if (!user) {\r\n            toast.error(\"Please log in to share a moment.\");\r\n            return;\r\n        }\r\n\r\n        if (e.target.files && e.target.files[0]) {\r\n            setIsUploading(true);\r\n            try {\r\n                const file = e.target.files[0];\r\n\r\n                const { getAuth } = await import(\"firebase/auth\");\r\n                const auth = getAuth();\r\n                if (!auth.currentUser) {\r\n                    const msg = \"Firebase SDK not authenticated. Storage rules will reject.\";\r\n                    console.error(msg);\r\n                    setLastUploadError(msg);\r\n                    toast.error(\"Authentication broken. Refresh page.\");\r\n                    return;\r\n                }\r\n\r\n                const userId = user.uid || (user as any).id;\r\n                if (!userId) throw new Error(\"User ID is missing.\");\r\n\r\n                // --- THUMBNAIL GENERATION FOR VIDEOS ---\r\n                if (file.type.startsWith('video/')) {\r\n                    try {\r\n                        console.log(\"Generating video thumbnail...\");\r\n                        const thumbBlob = await generateVideoThumbnail(file);\r\n                        if (thumbBlob) {\r\n                            const thumbRef = ref(storage, `users/${userId}/thumbnails/${Date.now()}_thumb.jpg`);\r\n                            await uploadBytes(thumbRef, thumbBlob);\r\n                            const tUrl = await getDownloadURL(thumbRef);\r\n                            setThumbnailUrl(tUrl);\r\n                            console.log(\"Thumbnail generated & uploaded:\", tUrl);\r\n                        }\r\n                    } catch (err) {\r\n                        console.error(\"Thumbnail generation failed (non-blocking):\", err);\r\n                    }\r\n                }\r\n                // ---------------------------------------\r\n\r\n                const storageRef = ref(storage, `users/${userId}/posts/${Date.now()}-${file.name}`);\r\n                const metadata = {\r\n                    contentType: file.type || 'application/octet-stream',\r\n                    customMetadata: {\r\n                        originalName: file.name,\r\n                        uploadedBy: userId\r\n                    }\r\n                };\r\n\r\n                const snapshot = await uploadBytes(storageRef, file, metadata);\r\n                const url = await getDownloadURL(snapshot.ref);\r\n\r\n                setMediaUrls(prev => [...prev, url]);\r\n                toast.success(\"Photo uploaded! üì∏\");\r\n            } catch (error: any) {\r\n                console.error(\"Upload failed\", error);\r\n                // ... error handling ...\r\n                const debugObj = {\r\n                    message: error.message || \"Unknown error\",\r\n                    code: error.code || \"No code\",\r\n                    name: error.name,\r\n                    stack: error.stack\r\n                };\r\n                const fullError = JSON.stringify(debugObj, null, 2);\r\n                window.alert(\"UPLOAD ERROR:\\n\" + fullError);\r\n                setLastUploadError(fullError);\r\n                setLastUploadError(fullError);\r\n                toast.error(`Upload failed: ${error.message}`);\r\n            } finally {\r\n                setIsUploading(false);\r\n            }\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Card className=\"mb-6 border-none glass-card rounded-lg relative group\">\r\n            {/* Close Button for Toggle Mode */}\r\n            {onClose && (\r\n                <div className=\"absolute top-2 right-2 z-10\">\r\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 rounded-full opacity-50 hover:opacity-100 hover:bg-gray-100 dark:hover:bg-white/10\" onClick={onClose}>\r\n                        <X className=\"w-4 h-4\" />\r\n                    </Button>\r\n                </div>\r\n            )}\r\n            <CardContent className=\"p-4\">\r\n                <div className=\"flex gap-3\">\r\n                    <Avatar className=\"w-10 h-10 border border-gray-200\">\r\n                        <AvatarImage src={user?.photoURL || undefined} />\r\n                        <AvatarFallback>{user?.displayName?.charAt(0)}</AvatarFallback>\r\n                    </Avatar>\r\n                    <div className=\"flex-1 space-y-3\">\r\n\r\n                        <Textarea\r\n                            disabled={!isVerified}\r\n                            placeholder={!isVerified ? t(\"create.verify.required\") : (isListening ? (t(\"feed.listening\") || \"Listening...\") : (t(\"feed.placeholder\") + \" üéôÔ∏è\"))}\r\n                            className=\"min-h-[80px] bg-gray-100 dark:bg-black hover:bg-gray-200 dark:hover:bg-zinc-900 focus:bg-white dark:focus:bg-card border-none rounded-xl resize-none text-[15px] placeholder:text-gray-500 pr-10 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                            value={content}\r\n                            onChange={(e) => setContent(e.target.value)}\r\n                        />\r\n\r\n                        {!isVerified && (\r\n                            <div className=\"mt-2 ml-1 text-sm text-amber-600 dark:text-amber-500 flex flex-wrap items-center gap-2\">\r\n                                <span>{t(\"create.verify.required\")}</span>\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={async () => {\r\n                                        try {\r\n                                            const { getAuth, sendEmailVerification } = await import(\"firebase/auth\");\r\n                                            const auth = getAuth();\r\n                                            if (auth.currentUser) {\r\n                                                await sendEmailVerification(auth.currentUser);\r\n                                                toast.success(t(\"create.verify.sent\"));\r\n                                            }\r\n                                        } catch (e: any) {\r\n                                            console.error(\"Verification send error:\", e);\r\n                                            toast.error(e.code === 'auth/too-many-requests' ? \"Please wait a moment before trying again.\" : \"Failed to send email.\");\r\n                                        }\r\n                                    }}\r\n                                    className=\"font-medium underline hover:text-amber-700 dark:hover:text-amber-400\"\r\n                                >\r\n                                    {t(\"create.verify.resend\")}\r\n                                </button>\r\n                            </div>\r\n                        )}\r\n\r\n                        {isSpeechSupported && isVerified && (\r\n                            <div className=\"absolute right-6 top-6\">\r\n                                <Button\r\n                                    size=\"icon\"\r\n                                    variant=\"ghost\"\r\n                                    onClick={isListening ? stopListening : startListening}\r\n                                    disabled={isUploading || isSubmitting}\r\n                                    className={isListening ? \"text-red-500 hover:bg-red-50 animate-pulse\" : \"text-gray-400 hover:text-gray-600\"}\r\n                                >\r\n                                    {isListening ? <MicOff className=\"w-5 h-5\" /> : <Mic className=\"w-5 h-5\" />}\r\n                                </Button>\r\n                            </div>\r\n                        )}\r\n\r\n                        {mediaUrls.length > 0 && (\r\n                            <div className=\"flex gap-2 mb-2 overflow-x-auto\">\r\n                                {mediaUrls.map((url, idx) => (\r\n                                    <div key={idx} className=\"relative w-20 h-20 rounded-md overflow-hidden group\">\r\n                                        <img src={url} alt=\"Preview\" className=\"w-full h-full object-cover\" />\r\n                                        <button\r\n                                            onClick={() => setMediaUrls(urls => urls.filter((_, i) => i !== idx))}\r\n                                            className=\"absolute top-1 right-1 bg-black/50 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                                        >\r\n                                            <X className=\"w-3 h-3\" />\r\n                                        </button>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"flex flex-col-reverse gap-3 pt-2 border-t border-gray-100 md:flex-row md:justify-between md:items-center\">\r\n                            <div className=\"flex gap-2 w-full justify-between md:justify-start md:w-auto\">\r\n                                <input\r\n                                    type=\"file\"\r\n                                    hidden\r\n                                    ref={fileInputRef}\r\n                                    accept=\"image/*,video/*\"\r\n                                    onChange={handleFileSelect}\r\n                                    disabled={!isVerified}\r\n                                />\r\n                                <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    onClick={() => fileInputRef.current?.click()}\r\n                                    disabled={isUploading || !isVerified}\r\n                                    className=\"gap-2 flex-1 md:flex-none text-muted-foreground hover:text-foreground\"\r\n                                >\r\n                                    {isUploading ? <Loader2 className=\"w-5 h-5 animate-spin text-primary\" /> : <ImageIcon className=\"w-6 h-6 text-primary\" />}\r\n                                    <span className=\"text-[15px] font-semibold text-foreground\">{t(\"create.photo_video\")}</span>\r\n                                </Button>\r\n                                <MagicAIButton\r\n                                    onClick={handleOpenMagicAI}\r\n                                    disabled={!content.trim() || !isVerified}\r\n                                    isGenerating={magicAI.isGenerating}\r\n                                />\r\n                            </div>\r\n\r\n                            <VisibilitySelector\r\n                                value={privacy}\r\n                                onChange={setPrivacy}\r\n                                allowedViewerIds={allowedViewers}\r\n                                onAllowedViewersChange={setAllowedViewers}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"flex flex-col-reverse gap-3 pt-2 md:flex-row md:justify-end md:items-center\">\r\n                            {lastUploadError && (\r\n                                <div className=\"text-red-500 text-xs mt-2 bg-red-50 p-2 rounded break-all whitespace-pre-wrap\">\r\n                                    <p className=\"font-bold\">DEBUG INFO:</p>\r\n                                    <p>Bucket: {storage.app.options.storageBucket}</p>\r\n                                    <p>Error: {lastUploadError}</p>\r\n                                </div>\r\n                            )}\r\n\r\n                            <Button\r\n                                onClick={handleSubmit}\r\n                                disabled={(!content.trim() && mediaUrls.length === 0) || isSubmitting || isUploading || !isVerified}\r\n                                className=\"bg-primary hover:bg-primary/90 text-white font-semibold w-full md:w-auto px-8\"\r\n                            >\r\n                                {isSubmitting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4 mr-2\" />}\r\n                                {t(\"btn.post\")}\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Magic AI Preview Panel */}\r\n                <AIPreviewPanel\r\n                    isOpen={magicAI.isPreviewOpen}\r\n                    onClose={magicAI.closePreview}\r\n                    originalContent={magicAI.originalContent}\r\n                    enhancedContent={magicAI.enhancedContent}\r\n                    selectedTone={magicAI.selectedTone}\r\n                    isGenerating={magicAI.isGenerating}\r\n                    onSelectTone={magicAI.generatePreview}\r\n                    onAccept={handleAcceptMagic}\r\n                    onRevert={handleRevertMagic}\r\n                />\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n\r\n// Helper: Generate video thumbnail from file\r\nconst generateVideoThumbnail = (file: File): Promise<Blob | null> => {\r\n    return new Promise((resolve) => {\r\n        const video = document.createElement('video');\r\n        video.preload = 'metadata';\r\n        video.src = URL.createObjectURL(file);\r\n        video.muted = true;\r\n        video.playsInline = true;\r\n        video.currentTime = 1; // Capture at 1s\r\n\r\n        video.onloadeddata = () => {\r\n            // \r\n        };\r\n\r\n        video.onseeked = () => {\r\n            try {\r\n                const canvas = document.createElement('canvas');\r\n                canvas.width = video.videoWidth;\r\n                canvas.height = video.videoHeight;\r\n                const ctx = canvas.getContext('2d');\r\n                ctx?.drawImage(video, 0, 0);\r\n                canvas.toBlob((blob) => {\r\n                    URL.revokeObjectURL(video.src);\r\n                    resolve(blob);\r\n                }, 'image/jpeg', 0.8);\r\n            } catch (e) {\r\n                console.error(\"Canvas draw failed\", e);\r\n                resolve(null);\r\n            }\r\n        };\r\n\r\n        video.onerror = () => {\r\n            URL.revokeObjectURL(video.src);\r\n            resolve(null);\r\n        };\r\n    });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\engagement-settings-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":87,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2804,2807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2804,2807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogFooter,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Switch } from '@/components/ui/switch';\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from '@/components/ui/select';\r\nimport { toast } from 'sonner';\r\nimport { updatePostEngagementSettings } from '@/app/actions/posts';\r\nimport { Globe, Users, Lock } from 'lucide-react';\r\n\r\ninterface EngagementSettingsDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    postId: string;\r\n    currentSettings?: {\r\n        allowLikes?: boolean;\r\n        allowComments?: boolean;\r\n        privacy?: 'public' | 'friends' | 'private';\r\n    };\r\n    contextType?: string;\r\n    contextId?: string;\r\n}\r\n\r\nexport function EngagementSettingsDialog({\r\n    open,\r\n    onOpenChange,\r\n    postId,\r\n    currentSettings = {},\r\n    contextType,\r\n    contextId,\r\n}: EngagementSettingsDialogProps) {\r\n    const [allowLikes, setAllowLikes] = useState(currentSettings.allowLikes ?? true);\r\n    const [allowComments, setAllowComments] = useState(currentSettings.allowComments ?? true);\r\n    const [privacy, setPrivacy] = useState<'public' | 'friends' | 'private'>(\r\n        currentSettings.privacy ?? 'friends'\r\n    );\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const handleSave = async () => {\r\n        setIsSaving(true);\r\n        try {\r\n            await updatePostEngagementSettings(\r\n                postId,\r\n                { allowLikes, allowComments, privacy },\r\n                contextType,\r\n                contextId\r\n            );\r\n            toast.success('Settings updated');\r\n            onOpenChange(false);\r\n        } catch (error) {\r\n            console.error(error);\r\n            toast.error('Failed to update settings');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-[425px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Post Settings</DialogTitle>\r\n                    <DialogDescription>\r\n                        Control who can see and engage with your post\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-6 py-4\">\r\n                    {/* Privacy Setting */}\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"privacy\">Who can see this post?</Label>\r\n                        <Select value={privacy} onValueChange={(val: any) => setPrivacy(val)}>\r\n                            <SelectTrigger id=\"privacy\">\r\n                                <SelectValue />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"public\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Globe className=\"w-4 h-4\" />\r\n                                        <div>\r\n                                            <div className=\"font-medium\">Public</div>\r\n                                            <div className=\"text-xs text-muted-foreground\">Anyone can view</div>\r\n                                        </div>\r\n                                    </div>\r\n                                </SelectItem>\r\n                                <SelectItem value=\"friends\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Users className=\"w-4 h-4\" />\r\n                                        <div>\r\n                                            <div className=\"font-medium\">Friends Only</div>\r\n                                            <div className=\"text-xs text-muted-foreground\">Only connected friends</div>\r\n                                        </div>\r\n                                    </div>\r\n                                </SelectItem>\r\n                                <SelectItem value=\"private\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Lock className=\"w-4 h-4\" />\r\n                                        <div>\r\n                                            <div className=\"font-medium\">Private</div>\r\n                                            <div className=\"text-xs text-muted-foreground\">Only you can see</div>\r\n                                        </div>\r\n                                    </div>\r\n                                </SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n\r\n                    {/* Allow Likes */}\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"space-y-0.5\">\r\n                            <Label htmlFor=\"allow-likes\">Allow Likes</Label>\r\n                            <p className=\"text-xs text-muted-foreground\">\r\n                                Let friends react to your post\r\n                            </p>\r\n                        </div>\r\n                        <Switch\r\n                            id=\"allow-likes\"\r\n                            checked={allowLikes}\r\n                            onCheckedChange={setAllowLikes}\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Allow Comments */}\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"space-y-0.5\">\r\n                            <Label htmlFor=\"allow-comments\">Allow Comments</Label>\r\n                            <p className=\"text-xs text-muted-foreground\">\r\n                                Let friends comment and reply\r\n                            </p>\r\n                        </div>\r\n                        <Switch\r\n                            id=\"allow-comments\"\r\n                            checked={allowComments}\r\n                            onCheckedChange={setAllowComments}\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Preview */}\r\n                    <div className=\"border border-border rounded-lg p-3 bg-muted/20\">\r\n                        <p className=\"text-xs font-medium mb-2\">Who can engage:</p>\r\n                        <div className=\"space-y-1 text-xs text-muted-foreground\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <div className={`w-2 h-2 rounded-full ${privacy === 'public' ? 'bg-green-500' : privacy === 'friends' ? 'bg-blue-500' : 'bg-gray-500'}`} />\r\n                                {privacy === 'public' ? 'Anyone can view' : privacy === 'friends' ? 'Friends can view' : 'Only you can view'}\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <div className={`w-2 h-2 rounded-full ${allowLikes && privacy !== 'private' ? 'bg-green-500' : 'bg-gray-500'}`} />\r\n                                {allowLikes && privacy !== 'private' ? 'Friends can like' : 'Likes disabled'}\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <div className={`w-2 h-2 rounded-full ${allowComments && privacy !== 'private' ? 'bg-green-500' : 'bg-gray-500'}`} />\r\n                                {allowComments && privacy !== 'private' ? 'Friends can comment' : 'Comments disabled'}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n                        Cancel\r\n                    </Button>\r\n                    <Button onClick={handleSave} disabled={isSaving}>\r\n                        {isSaving ? 'Saving...' : 'Save Changes'}\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\feed-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PostCard' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"PostCard"},"fix":{"range":[131,169],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[796,799],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[796,799],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":25,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1047,1050],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1047,1050],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'debugInfo' is assigned a value but never used.","line":30,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1217,1220],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1217,1220],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2840,2843],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2840,2843],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useAuth } from \"@/components/auth-provider\"\r\nimport { useLanguage } from \"@/components/language-context\"\r\nimport { PostCard } from \"./post-card\"\r\nimport { MasonryFeed } from \"./masonry-feed\"\r\nimport { useEffect, useState } from \"react\"\r\nimport { getPosts } from \"@/app/actions/posts\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Loader2, Video } from \"lucide-react\"\r\nimport { useAutoScroll } from \"@/hooks/use-auto-scroll\"\r\nimport { AutoScrollToggle } from \"./auto-scroll-toggle\"\r\nimport { debugEnv } from \"@/app/actions/debug\";\r\n\r\nimport { PostFilters } from \"@/app/actions/posts\";\r\n\r\ninterface FeedListProps {\r\n    variant?: 'standard' | 'pinterest-mobile';\r\n    headerAction?: React.ReactNode;\r\n    fetcher?: (limit: number, filters: PostFilters) => Promise<any[]>;\r\n}\r\n\r\nexport function FeedList({ variant = 'standard', headerAction, fetcher }: FeedListProps) {\r\n    const router = useRouter()\r\n    const { profile, user } = useAuth()\r\n    const { t } = useLanguage()\r\n    const [posts, setPosts] = useState<any[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n    const [error, setError] = useState<string | null>(null)\r\n    const [debugInfo, setDebugInfo] = useState<any>(null)\r\n\r\n    // Auto-scroll integration\r\n    const {\r\n        isEnabled,\r\n        isPaused,\r\n        toggleAutoScroll,\r\n        containerRef,\r\n    } = useAutoScroll({\r\n        pauseOnHover: true,\r\n        pauseOnInteraction: true,\r\n    });\r\n\r\n    // Filters\r\n    const [timeRange, setTimeRange] = useState<'all' | 'day' | 'week' | 'month' | 'year'>('all');\r\n    const [contentType, setContentType] = useState<'all' | 'text' | 'photo' | 'video'>('all');\r\n\r\n    useEffect(() => {\r\n        const fetchPosts = async () => {\r\n            setLoading(true);\r\n            try {\r\n                // Determine which fetcher to use\r\n                const fetchFn = fetcher || getPosts;\r\n\r\n                // Parallel fetch for speed + debug\r\n                const [data, debug] = await Promise.all([\r\n                    fetchFn(50, { timeRange, contentType }),\r\n                    debugEnv()\r\n                ]);\r\n                setPosts(data)\r\n                setDebugInfo(debug)\r\n            } catch (err) {\r\n                console.error(\"Error loading feed:\", err)\r\n                setError(err instanceof Error ? err.message : \"Unknown Load Error\")\r\n            } finally {\r\n                setLoading(false)\r\n            }\r\n        }\r\n        fetchPosts()\r\n    }, [timeRange, contentType, fetcher]) // Re-fetch when filters change\r\n\r\n    // Filter UI Components\r\n    const FilterBar = () => (\r\n        <div className=\"flex flex-wrap items-center gap-2 mb-4 w-full\">\r\n            {/* Time Filter */}\r\n            <select\r\n                value={timeRange}\r\n                onChange={(e) => setTimeRange(e.target.value as any)}\r\n                className=\"text-xs bg-muted/50 border-none rounded-full px-3 py-1.5 focus:ring-1 focus:ring-primary outline-none cursor-pointer hover:bg-muted transition-colors\"\r\n                aria-label=\"Filter by time\"\r\n            >\r\n                <option value=\"all\">All Time</option>\r\n                <option value=\"day\">Today</option>\r\n                <option value=\"week\">This Week</option>\r\n                <option value=\"month\">This Month</option>\r\n                <option value=\"year\">This Year</option>\r\n            </select>\r\n\r\n            {/* Content Filter */}\r\n            <div className=\"flex bg-muted/50 rounded-full p-1 gap-1 overflow-x-auto scrollbar-hide max-w-[150px] md:max-w-none\">\r\n                {(['all', 'text', 'photo', 'video'] as const).map((type) => (\r\n                    <button\r\n                        key={type}\r\n                        onClick={() => setContentType(type)}\r\n                        className={`text-xs px-3 py-1 rounded-full transition-all capitalize whitespace-nowrap ${contentType === type\r\n                            ? 'bg-background shadow-sm text-foreground font-medium'\r\n                            : 'text-muted-foreground hover:text-foreground'\r\n                            }`}\r\n                    >\r\n                        {type}\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Go Live Action */}\r\n            <button\r\n                onClick={() => router.push('/live/broadcast')}\r\n                className=\"text-xs px-3 py-1.5 rounded-full bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-all flex items-center gap-1.5 font-medium border border-red-200/50 dark:border-red-500/20\"\r\n            >\r\n                <Video className=\"w-3.5 h-3.5\" />\r\n                <span className=\"whitespace-nowrap\">Go Live</span>\r\n            </button>\r\n\r\n            <div className=\"ml-auto flex items-center gap-2\">\r\n                {/* Auto-Scroll Toggle */}\r\n                <AutoScrollToggle\r\n                    isEnabled={isEnabled}\r\n                    isPaused={isPaused}\r\n                    onToggle={toggleAutoScroll}\r\n                />\r\n\r\n                {/* Custom Header Action (e.g. Create Post) */}\r\n                {headerAction && (\r\n                    <div className=\"pl-1 border-l border-border/50\">\r\n                        {headerAction}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"space-y-4\">\r\n                <FilterBar />\r\n                <div className=\"flex justify-center py-10\">\r\n                    <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    if (error) {\r\n        return (\r\n            <div className=\"space-y-4\">\r\n                <FilterBar />\r\n                <div className=\"text-center py-10 text-red-500\">\r\n                    <p>Unable to load feed. Please pull to refresh.</p>\r\n                    <p className=\"text-xs mt-2 opacity-50\">{error}</p>\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <FilterBar />\r\n\r\n            {posts.length === 0 && (\r\n                <div className=\"text-center py-10 text-gray-500\">\r\n                    <p>{t(\"feed.empty\")}</p>\r\n                </div>\r\n            )}\r\n\r\n            {/* Scrollable container with auto-scroll */}\r\n            {/* Added standard vh fallback and dvh for mobile browsers */}\r\n            <div\r\n                ref={containerRef}\r\n                className=\"max-h-[calc(100vh-200px)] max-h-[calc(100dvh-200px)] md:max-h-[calc(100vh-250px)] md:max-h-[calc(100dvh-250px)] overflow-y-auto scroll-smooth overscroll-contain\"\r\n                style={{ WebkitOverflowScrolling: 'touch' } as React.CSSProperties}\r\n            >\r\n                <MasonryFeed posts={posts} currentUserId={profile?.id} variant={variant} />\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\home-feed.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\link-preview-card.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":54,"column":25,"nodeType":"JSXOpeningElement","endLine":58,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { ExternalLink } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface LinkPreviewCardProps {\r\n    url: string;\r\n    provider: 'linkedin' | 'facebook' | 'instagram' | 'other';\r\n    title?: string;\r\n    description?: string;\r\n    thumbnail?: string;\r\n}\r\n\r\nexport function LinkPreviewCard({ url, provider, title, description, thumbnail }: LinkPreviewCardProps) {\r\n    const providerConfig = {\r\n        linkedin: {\r\n            name: 'LinkedIn',\r\n            logo: 'üîó',\r\n            color: 'bg-blue-600',\r\n            ctaText: 'View on LinkedIn'\r\n        },\r\n        facebook: {\r\n            name: 'Facebook',\r\n            logo: 'üìò',\r\n            color: 'bg-blue-500',\r\n            ctaText: 'View on Facebook'\r\n        },\r\n        instagram: {\r\n            name: 'Instagram',\r\n            logo: 'üì∑',\r\n            color: 'bg-pink-500',\r\n            ctaText: 'View on Instagram'\r\n        },\r\n        other: {\r\n            name: 'External Link',\r\n            logo: 'üîó',\r\n            color: 'bg-gray-600',\r\n            ctaText: 'View Link'\r\n        }\r\n    };\r\n\r\n    const config = providerConfig[provider];\r\n\r\n    return (\r\n        <a\r\n            href={url}\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            className=\"block mt-3 rounded-xl overflow-hidden border border-border bg-card hover:bg-muted/50 transition-colors group\"\r\n        >\r\n            <div className=\"flex gap-4 p-4\">\r\n                {thumbnail && (\r\n                    <div className=\"flex-shrink-0 w-24 h-24 sm:w-32 sm:h-32 rounded-lg overflow-hidden bg-muted\">\r\n                        <img\r\n                            src={thumbnail}\r\n                            alt=\"\"\r\n                            className=\"w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity\"\r\n                        />\r\n                    </div>\r\n                )}\r\n\r\n                <div className=\"flex-1 min-w-0 flex flex-col justify-center\">\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                        <span className=\"text-lg\">{config.logo}</span>\r\n                        <span className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\r\n                            {config.name}\r\n                        </span>\r\n                    </div>\r\n\r\n                    {title && (\r\n                        <h4 className=\"font-semibold text-sm sm:text-base line-clamp-2 mb-1 group-hover:text-primary transition-colors\">\r\n                            {title}\r\n                        </h4>\r\n                    )}\r\n\r\n                    {description && (\r\n                        <p className=\"text-xs sm:text-sm text-muted-foreground line-clamp-2 mb-3\">\r\n                            {description}\r\n                        </p>\r\n                    )}\r\n\r\n                    <div className={cn(\r\n                        \"inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-medium text-white self-start\",\r\n                        config.color\r\n                    )}>\r\n                        <span>{config.ctaText}</span>\r\n                        <ExternalLink className=\"w-3 h-3\" />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </a>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\linkedin-viewer.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadContent'. Either include it or remove the dependency array.","line":22,"column":8,"nodeType":"ArrayExpression","endLine":22,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [loadContent, url]","fix":{"range":[731,736],"text":"[loadContent, url]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":81,"column":29,"nodeType":"JSXOpeningElement","endLine":85,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { ExternalLink, Sparkles, MessageCircle, Linkedin } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { analyzeLinkedInContent, LinkedInContent } from '@/app/actions/linkedin';\r\n\r\ninterface LinkedInViewerProps {\r\n    url: string;\r\n    title?: string;\r\n    description?: string;\r\n    thumbnail?: string;\r\n}\r\n\r\nexport function LinkedInViewer({ url, title, description, thumbnail }: LinkedInViewerProps) {\r\n    const [content, setContent] = useState<LinkedInContent | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [showInsights, setShowInsights] = useState(true);\r\n\r\n    useEffect(() => {\r\n        loadContent();\r\n    }, [url]);\r\n\r\n    async function loadContent() {\r\n        setLoading(true);\r\n        try {\r\n            const result = await analyzeLinkedInContent(url, { title, description, image: thumbnail });\r\n            setContent(result);\r\n        } catch (error) {\r\n            console.error('Failed to load LinkedIn content:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"mt-3 rounded-xl border border-border bg-card p-6 animate-pulse\">\r\n                <div className=\"flex gap-4\">\r\n                    <div className=\"w-24 h-24 bg-muted rounded-lg\" />\r\n                    <div className=\"flex-1 space-y-2\">\r\n                        <div className=\"h-4 bg-muted rounded w-3/4\" />\r\n                        <div className=\"h-3 bg-muted rounded w-1/2\" />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!content) return null;\r\n\r\n    const hasAI = content.aiSummary && content.aiSummary.keyInsights.length > 0;\r\n\r\n    return (\r\n        <div className=\"mt-3 rounded-xl border-2 border-blue-600/20 bg-gradient-to-br from-blue-50/50 to-transparent dark:from-blue-950/20 overflow-hidden\">\r\n            {/* Header */}\r\n            <div className=\"bg-blue-600/10 px-4 py-2 border-b border-blue-600/20 flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Linkedin className=\"w-4 h-4 text-blue-600\" />\r\n                    <span className=\"text-xs font-semibold text-blue-600 uppercase tracking-wider\">\r\n                        LinkedIn Content\r\n                    </span>\r\n                </div>\r\n                {hasAI && (\r\n                    <button\r\n                        onClick={() => setShowInsights(!showInsights)}\r\n                        className=\"flex items-center gap-1 text-xs text-blue-600/80 hover:text-blue-600 transition-colors\"\r\n                    >\r\n                        <Sparkles className=\"w-3 h-3\" />\r\n                        <span>AI Insights</span>\r\n                        <span className=\"text-[10px]\">{showInsights ? '‚ñº' : '‚ñ∂'}</span>\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"p-4\">\r\n                {/* Content Preview */}\r\n                <div className=\"flex gap-4 mb-4\">\r\n                    {content.image && (\r\n                        <div className=\"flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden bg-muted\">\r\n                            <img\r\n                                src={content.image}\r\n                                alt=\"\"\r\n                                className=\"w-full h-full object-cover\"\r\n                            />\r\n                        </div>\r\n                    )}\r\n\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        <h4 className=\"font-semibold text-base line-clamp-2 mb-1\">\r\n                            {content.title || 'LinkedIn Post'}\r\n                        </h4>\r\n                        {content.description && (\r\n                            <p className=\"text-sm text-muted-foreground line-clamp-2\">\r\n                                {content.description}\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* AI Insights */}\r\n                {hasAI && showInsights && content.aiSummary && (\r\n                    <div className=\"bg-gradient-to-br from-primary/5 to-transparent border border-primary/10 rounded-lg p-4 space-y-3 mb-4\">\r\n                        {/* Topic */}\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Sparkles className=\"w-4 h-4 text-primary\" />\r\n                            <span className=\"text-xs font-semibold text-primary uppercase tracking-wider\">\r\n                                AI Analysis\r\n                            </span>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-3 text-sm\">\r\n                            {/* Topic Badge */}\r\n                            <div>\r\n                                <span className=\"inline-flex items-center gap-1 px-2 py-1 rounded-md bg-primary/10 text-primary text-xs font-medium\">\r\n                                    üìå {content.aiSummary.topic}\r\n                                </span>\r\n                            </div>\r\n\r\n                            {/* Key Insights */}\r\n                            <div>\r\n                                <div className=\"font-semibold text-foreground/90 mb-1.5\">Key Insights</div>\r\n                                <div className=\"space-y-1.5\">\r\n                                    {content.aiSummary.keyInsights.map((insight, i) => (\r\n                                        <div key={i} className=\"flex gap-2\">\r\n                                            <span className=\"text-primary/60 flex-shrink-0\">‚Ä¢</span>\r\n                                            <span className=\"text-foreground/80\">{insight}</span>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Why It Matters */}\r\n                            {content.aiSummary.whyItMatters && (\r\n                                <div className=\"pt-2 border-t border-primary/10\">\r\n                                    <div className=\"font-semibold text-primary/80 mb-1\">Why It Matters</div>\r\n                                    <p className=\"text-foreground/70 italic\">{content.aiSummary.whyItMatters}</p>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Discussion Prompts */}\r\n                            {content.aiSummary.discussionPrompts && content.aiSummary.discussionPrompts.length > 0 && (\r\n                                <div className=\"pt-2 border-t border-primary/10\">\r\n                                    <div className=\"flex items-center gap-1.5 font-semibold text-primary/80 mb-2\">\r\n                                        <MessageCircle className=\"w-3.5 h-3.5\" />\r\n                                        <span>Discuss</span>\r\n                                    </div>\r\n                                    <div className=\"space-y-1.5\">\r\n                                        {content.aiSummary.discussionPrompts.map((prompt, i) => (\r\n                                            <div key={i} className=\"text-foreground/70 text-xs\">\r\n                                                ‚Ä¢ {prompt}\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"text-[10px] text-muted-foreground/60 pt-2 border-t border-primary/5\">\r\n                            AI-generated insights. View original for full context.\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* View Original Button */}\r\n                <a\r\n                    href={content.url}\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer\"\r\n                    className={cn(\r\n                        \"inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-white transition-colors\",\r\n                        \"bg-blue-600 hover:bg-blue-700\"\r\n                    )}\r\n                >\r\n                    <span>View Original on LinkedIn</span>\r\n                    <ExternalLink className=\"w-4 h-4\" />\r\n                </a>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\masonry-feed.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[136,139],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[136,139],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { PostCard } from \"./post-card\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface MasonryFeedProps {\r\n    posts: any[];\r\n    currentUserId?: string;\r\n    className?: string;\r\n    variant?: 'standard' | 'pinterest-mobile';\r\n}\r\n\r\nexport function MasonryFeed({\r\n    posts,\r\n    currentUserId,\r\n    className,\r\n    variant = 'standard'\r\n}: MasonryFeedProps) {\r\n    if (!posts || posts.length === 0) return null;\r\n\r\n    // Pinterest mode: active when variant is pinterest-mobile (works on all screen sizes)\r\n    // The grid itself handles responsive column counts (2 on mobile, 3 on desktop)\r\n    const isPinterestMode = variant === 'pinterest-mobile';\r\n\r\n    // STABILITY FIX:\r\n    // Replaced react-masonry-css with Native CSS Columns.\r\n    // This removes all Javascript-based layout calculations and hydration risks.\r\n    // CSS Columns are 100% crash-proof and performant.\r\n\r\n    return (\r\n        <div className={cn(\"w-full block\", className)}>\r\n            <div className={cn(\r\n                isPinterestMode\r\n                    ? \"columns-2 lg:columns-3 gap-4 lg:gap-6 space-y-0\" // Pinterest: 2 cols mobile, 3 cols desktop, uniform gaps\r\n                    : \"columns-1 sm:columns-2 lg:columns-3 gap-4 lg:gap-6 space-y-0\" // Standard: responsive, uniform gaps\r\n            )}>\r\n                {posts.map((post) => (\r\n                    <div\r\n                        key={post.id}\r\n                        className={cn(\r\n                            \"break-inside-avoid-column\",\r\n                            \"mb-4 lg:mb-6\" // Equal to gap values for symmetry\r\n                        )}\r\n                    >\r\n                        <PostCard\r\n                            post={post}\r\n                            currentUserId={currentUserId}\r\n                            variant={isPinterestMode ? 'pinterest' : 'standard'}\r\n                        />\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\media-embed.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[34,45],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[436,439],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[436,439],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":76,"column":21,"nodeType":"JSXOpeningElement","endLine":76,"endColumn":160},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'urlObj' is assigned a value but never used.","line":170,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":170,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Play } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport dynamic from \"next/dynamic\";\r\nimport { LinkPreviewCard } from \"./link-preview-card\";\r\nimport { LinkedInViewer } from \"./linkedin-viewer\";\r\n\r\n// Lazy load ReactPlayer for embeddable sources (Vimeo, SoundCloud, etc.)\r\nconst ReactPlayer = dynamic(() => import(\"react-player\"), { ssr: false }) as any;\r\n\r\ntype Provider = 'youtube' | 'linkedin' | 'facebook' | 'instagram' | 'vimeo' | 'other';\r\n\r\nfunction detectProvider(url: string): Provider {\r\n    try {\r\n        const urlObj = new URL(url);\r\n        const hostname = urlObj.hostname.replace(/^(www\\.|m\\.)/, '');\r\n\r\n        if (hostname.includes('youtube.com') || hostname === 'youtu.be') {\r\n            return 'youtube';\r\n        }\r\n        if (hostname.includes('linkedin.com')) {\r\n            return 'linkedin';\r\n        }\r\n        if (hostname.includes('facebook.com') || hostname.includes('fb.watch')) {\r\n            return 'facebook';\r\n        }\r\n        if (hostname.includes('instagram.com')) {\r\n            return 'instagram';\r\n        }\r\n        if (hostname.includes('vimeo.com')) {\r\n            return 'vimeo';\r\n        }\r\n\r\n        return 'other';\r\n    } catch {\r\n        return 'other';\r\n    }\r\n}\r\n\r\ninterface MediaEmbedProps {\r\n    url: string;\r\n    playInline?: boolean;\r\n    onPlayRequest?: () => void;\r\n}\r\n\r\nexport function MediaEmbed({ url, playInline = true, onPlayRequest }: MediaEmbedProps) {\r\n    const [isLoaded, setIsLoaded] = useState(false);\r\n\r\n    // Derived state (no effects needed)\r\n    const provider = detectProvider(url || '');\r\n    const embedUrl = provider === 'youtube' && url ? parseYouTubeUrl(url) : null;\r\n\r\n    // YouTube: Custom Player Control\r\n    if (provider === 'youtube' && embedUrl) {\r\n        // If playInline is FALSE, we show a static preview that looks like a player.\r\n        // Clicking it should trigger the ENLARGEMENT (via parent onClick) rather than playing.\r\n        if (!playInline) {\r\n            const videoId = embedUrl.split('/').pop();\r\n            const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;\r\n\r\n            return (\r\n                <div\r\n                    className=\"relative w-full overflow-hidden rounded-xl bg-black border border-border mt-3 aspect-video group cursor-pointer\"\r\n                    onClick={(e) => {\r\n                        // If we have a play request handler (enlarge), call it.\r\n                        // Otherwise, do nothing (let bubble up)\r\n                        if (onPlayRequest) {\r\n                            e.stopPropagation();\r\n                            onPlayRequest();\r\n                        }\r\n                    }}\r\n                >\r\n                    {/* Thumbnail */}\r\n                    <img src={thumbnailUrl} alt=\"Video Preview\" className=\"w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity\" />\r\n\r\n                    {/* Play Button Overlay */}\r\n                    <div className=\"absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/10 transition-colors\">\r\n                        <div className=\"w-12 h-12 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm shadow-lg group-hover:scale-110 transition-transform\">\r\n                            <Play className=\"w-6 h-6 text-white fill-current\" />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        // Inline Playback (Standard)\r\n        return (\r\n            <div className=\"relative w-full overflow-hidden rounded-xl bg-black border border-border mt-3 aspect-video group\">\r\n                {!isLoaded && (\r\n                    <div className=\"absolute inset-0 flex items-center justify-center bg-muted/10 z-10 pointer-events-none\">\r\n                        <div className=\"w-12 h-12 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm shadow-lg\">\r\n                            <Play className=\"w-6 h-6 text-white fill-current opacity-90\" />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                <iframe\r\n                    src={embedUrl}\r\n                    className={cn(\"w-full h-full\", !isLoaded && \"opacity-0 transition-opacity duration-300\")}\r\n                    allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\"\r\n                    allowFullScreen\r\n                    onLoad={() => setIsLoaded(true)}\r\n                    title=\"Embedded Video\"\r\n                />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // LinkedIn: Render AI-powered content viewer (no embed allowed)\r\n    if (provider === 'linkedin') {\r\n        return (\r\n            <LinkedInViewer\r\n                url={url}\r\n                title={extractTitle(url, provider)}\r\n                description={extractDescription(provider)}\r\n            />\r\n        );\r\n    }\r\n\r\n    // Facebook, Instagram: Render rich preview card (no embed allowed)\r\n    if (provider === 'facebook' || provider === 'instagram') {\r\n        return (\r\n            <LinkPreviewCard\r\n                url={url}\r\n                provider={provider}\r\n                title={extractTitle(url, provider)}\r\n                description={extractDescription(provider)}\r\n            />\r\n        );\r\n    }\r\n\r\n    // Vimeo and other embeddable providers: Use ReactPlayer\r\n    // If !playInline, we use 'light' mode which shows thumbnail.\r\n    return (\r\n        <div\r\n            className=\"mt-3 rounded-xl overflow-hidden border border-border bg-black aspect-video relative group cursor-pointer\"\r\n            onClick={!playInline && onPlayRequest ? (e) => { e.stopPropagation(); onPlayRequest(); } : undefined}\r\n        >\r\n            <ReactPlayer\r\n                url={url}\r\n                width=\"100%\"\r\n                height=\"100%\"\r\n                controls={playInline}\r\n                light={!playInline} // Shows thumbnail if not inline\r\n                // If light=true, clicking it normally plays it. We intercept via wrapper onClick if needed.\r\n                // However, ReactPlayer 'light' mode usually handles click to play.\r\n                // To force our custom enlargement, we might need a custom overlay or use playIcon prop.\r\n                playIcon={\r\n                    !playInline ? (\r\n                        <div className=\"absolute inset-0 flex items-center justify-center z-10\">\r\n                            <div className=\"w-12 h-12 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm shadow-lg group-hover:scale-110 transition-transform\">\r\n                                <Play className=\"w-6 h-6 text-white fill-current\" />\r\n                            </div>\r\n                        </div>\r\n                    ) : undefined\r\n                }\r\n                config={{\r\n                    facebook: { appId: '130969678083861' }\r\n                }}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n\r\n// Helper: Extract title from URL\r\nfunction extractTitle(url: string, provider: Provider): string {\r\n    try {\r\n        const urlObj = new URL(url);\r\n\r\n        if (provider === 'linkedin') {\r\n            if (url.includes('/feed/update')) {\r\n                return 'LinkedIn Post';\r\n            }\r\n            if (url.includes('/posts/')) {\r\n                return 'LinkedIn Post';\r\n            }\r\n            if (url.includes('/video/')) {\r\n                return 'LinkedIn Video';\r\n            }\r\n            return 'LinkedIn Content';\r\n        }\r\n\r\n        if (provider === 'facebook') {\r\n            return 'Facebook Post';\r\n        }\r\n\r\n        if (provider === 'instagram') {\r\n            return 'Instagram Post';\r\n        }\r\n\r\n        return 'Shared Content';\r\n    } catch {\r\n        return 'Shared Link';\r\n    }\r\n}\r\n\r\n// Helper: Extract description based on provider\r\nfunction extractDescription(provider: Provider): string {\r\n    const descriptions: Record<Provider, string> = {\r\n        youtube: '',\r\n        linkedin: 'View this post on LinkedIn',\r\n        facebook: 'View this post on Facebook',\r\n        instagram: 'View this post on Instagram',\r\n        vimeo: '',\r\n        other: 'Click to view content'\r\n    };\r\n\r\n    return descriptions[provider];\r\n}\r\n\r\n// Robust YouTube URL Parser\r\nfunction parseYouTubeUrl(url: string): string | null {\r\n    try {\r\n        const urlObj = new URL(url);\r\n        const hostname = urlObj.hostname.replace(/^(www\\.|m\\.)/, '');\r\n\r\n        let videoId = null;\r\n\r\n        // 1. youtube.com/watch?v=ID\r\n        if (hostname === 'youtube.com' && urlObj.pathname === '/watch') {\r\n            videoId = urlObj.searchParams.get('v');\r\n        }\r\n        // 2. youtube.com/shorts/ID\r\n        else if (hostname === 'youtube.com' && urlObj.pathname.startsWith('/shorts/')) {\r\n            const parts = urlObj.pathname.split('/');\r\n            videoId = parts[2];\r\n        }\r\n        // 3. youtu.be/ID\r\n        else if (hostname === 'youtu.be') {\r\n            videoId = urlObj.pathname.slice(1);\r\n        }\r\n        // 4. youtube.com/embed/ID\r\n        else if (hostname === 'youtube.com' && urlObj.pathname.startsWith('/embed/')) {\r\n            videoId = urlObj.pathname.split('/embed/')[1];\r\n        }\r\n\r\n        if (videoId) {\r\n            const cleanId = videoId.split('?')[0].replace(/[^a-zA-Z0-9_-]/g, '');\r\n            if (!cleanId) return null;\r\n\r\n            return `https://www.youtube-nocookie.com/embed/${cleanId}`;\r\n        }\r\n\r\n        return null;\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\post-card.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getReactionLabel' is defined but never used.","line":22,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":54,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getReactionLabel"},"fix":{"range":[1092,1110],"text":""},"desc":"Remove unused variable \"getReactionLabel\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2048,2051],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2048,2051],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isSavingEdit' is assigned a value but never used.","line":64,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isTranslating' is assigned a value but never used.","line":67,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":67,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3794,3797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3794,3797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'commentMediaUrl' is assigned a value but never used.","line":74,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":74,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isUploadingComment' is assigned a value but never used.","line":75,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isGeneratingComment' is assigned a value but never used.","line":76,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleCommentMagic' is assigned a value but never used.","line":136,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":136,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleCommentFileSelect' is assigned a value but never used.","line":146,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":146,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":193,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10151,10154],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10151,10154],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":269,"column":33,"nodeType":"JSXOpeningElement","endLine":274,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\n// Pinterest-Style Card Redesign\r\n// Goal: Media First, Title/Content below, Clean Actions.\r\n\r\nimport { useState, useRef } from \"react\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { SafeDate } from \"@/components/shared/safe-date\";\r\nimport {\r\n    DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger,\r\n    DropdownMenuSub, DropdownMenuSubContent, DropdownMenuSubTrigger, DropdownMenuPortal, DropdownMenuSeparator\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport { Heart, MessageCircle, Share2, Sparkles, MoreHorizontal, Send, Loader2, Lock, Globe, Users, X, Play } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\nimport { toggleReaction, addComment, editPost, deletePostWithContext } from \"@/app/actions/posts\";\r\nimport { ReactionType } from \"@/types/posts\";\r\nimport { REACTIONS, getReactionIcon, getReactionLabel } from \"./reaction-selector\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { ReportDialog } from \"@/components/reporting/report-dialog\";\r\nimport { Linkify } from \"@/components/shared/linkify\";\r\nimport { CommentItem } from \"./comment-item\";\r\nimport { EngagementSettingsDialog } from \"./engagement-settings-dialog\";\r\nimport { storage } from '@/lib/firebase';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\nimport { chatWithAgent } from '@/app/actions/ai-agents';\r\nimport { MediaEmbed } from \"./media-embed\";\r\nimport { AskAIDialog } from \"./ask-ai-dialog\";\r\n\r\nfunction isUrlVideo(url: string | null | undefined): boolean {\r\n    if (!url) return false;\r\n    const cleanUrl = url.split('?')[0].toLowerCase();\r\n    return cleanUrl.endsWith('.mp4') || cleanUrl.endsWith('.mov') || cleanUrl.endsWith('.webm') || cleanUrl.endsWith('.ogg');\r\n}\r\n\r\n// ... imports ...\r\n\r\ninterface PostCardProps {\r\n    post: any;\r\n    currentUserId?: string;\r\n    isEnlarged?: boolean;\r\n    variant?: 'standard' | 'pinterest';\r\n    initialTranslatedContent?: string | null;\r\n    initialLanguage?: 'es' | 'en' | 'fr' | 'zh' | 'hi' | 'ar';\r\n}\r\n\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\nexport function PostCard({ post, currentUserId, isEnlarged = false, variant = 'standard', initialTranslatedContent = null, initialLanguage }: PostCardProps) {\r\n    const { t } = useLanguage();\r\n    const isPinterest = variant === 'pinterest' && !isEnlarged;\r\n    // Hooks must be called unconditionally\r\n    const [reportDialogOpen, setReportDialogOpen] = useState(false);\r\n    const [showComments, setShowComments] = useState(isEnlarged); // Auto-show comments if enlarged\r\n    const [commentText, setCommentText] = useState(\"\");\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const videoRef = useRef<HTMLVideoElement>(null);\r\n    const [editContent, setEditContent] = useState(post?.content || \"\");\r\n    const [isSavingEdit, setIsSavingEdit] = useState(false);\r\n    const [translatedContent, setTranslatedContent] = useState<string | null>(initialTranslatedContent);\r\n    const [targetLanguage, setTargetLanguage] = useState<typeof initialLanguage | undefined>(initialLanguage);\r\n    const [isTranslating, setIsTranslating] = useState(false);\r\n    const [currentReaction, setCurrentReaction] = useState<ReactionType | undefined>(\r\n        currentUserId && post?.reactions ? post.reactions[currentUserId] : undefined\r\n    );\r\n    const [reactionCount, setReactionCount] = useState(post?.reactions ? Object.keys(post.reactions).length : 0);\r\n    const [comments, setComments] = useState<any[]>(post?.comments || []);\r\n    const [settingsDialogOpen, setSettingsDialogOpen] = useState(false);\r\n    const [commentMediaUrl, setCommentMediaUrl] = useState<string | null>(null);\r\n    const [isUploadingComment, setIsUploadingComment] = useState(false);\r\n    const [isGeneratingComment, setIsGeneratingComment] = useState(false);\r\n    const commentFileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    // Enlargement State (Only used if !isEnlarged)\r\n    const [enlargedViewOpen, setEnlargedViewOpen] = useState(false);\r\n    const [askAIDialogOpen, setAskAIDialogOpen] = useState(false);\r\n\r\n    // Early return AFTER hooks\r\n    if (!post || post.isDeleted) return null;\r\n\r\n    const handleEnlarge = () => {\r\n        if (!isEnlarged) setEnlargedViewOpen(true);\r\n    };\r\n\r\n    const engagementSettings = post.engagementSettings || { allowLikes: true, allowComments: true, privacy: 'friends' };\r\n    const author = post.author || { displayName: \"Unknown\" };\r\n    const name = (author.displayName && author.displayName !== \"Family Member\") ? author.displayName : \"Unknown\";\r\n    const profilePic = author.imageUrl;\r\n\r\n    const rawMediaMatch = post.content?.match(/https?:\\/\\/(www\\.)?(youtube\\.com|youtu\\.be|facebook\\.com|linkedin\\.com|vimeo\\.com|dailymotion\\.com|soundcloud\\.com)\\/\\S+/gi);\r\n    let mediaUrl = rawMediaMatch ? rawMediaMatch[0]?.replace(/[\\s.,!?;:]+$/, '').trim() : null;\r\n\r\n    const contextType = post.context?.type;\r\n    const contextId = post.context?.id;\r\n    const isAuthor = currentUserId === post.authorId;\r\n\r\n    const getPrivacyIcon = () => {\r\n        const privacy = engagementSettings.privacy;\r\n        switch (privacy) {\r\n            case 'public': return <Globe className=\"w-3 h-3\" />;\r\n            case 'private': return <Lock className=\"w-3 h-3\" />;\r\n            case 'specific': return <Users className=\"w-3 h-3 text-blue-500\" />;\r\n            default: return <Users className=\"w-3 h-3\" />; // 'companions' or legacy 'friends'\r\n        }\r\n    };\r\n\r\n    const handleReaction = async (type: ReactionType) => {\r\n        if (!currentUserId) return toast.error(\"Please login\");\r\n        if (!engagementSettings.allowLikes) return toast.error(\"Likes disabled\");\r\n        const previousReaction = currentReaction;\r\n        const isRemoving = currentReaction === type;\r\n        setCurrentReaction(isRemoving ? undefined : type);\r\n        setReactionCount(prev => (previousReaction && !isRemoving ? prev : isRemoving ? prev - 1 : prev + 1));\r\n        try { await toggleReaction(post.id, type, contextType, contextId); }\r\n        catch { setCurrentReaction(previousReaction); setReactionCount(prev => (previousReaction && !isRemoving ? prev : isRemoving ? prev + 1 : prev - 1)); }\r\n    };\r\n\r\n    const handleCommentSubmit = async () => {\r\n        if (!commentText.trim() || !currentUserId) return;\r\n        setIsSubmitting(true);\r\n        try {\r\n            const newComment = await addComment(post.id, commentText, contextType, contextId);\r\n            if (newComment) setComments(prev => [...prev, newComment]);\r\n            setCommentText(\"\"); setCommentMediaUrl(null);\r\n            toast.success(\"Comment added\");\r\n            setShowComments(true);\r\n        } catch { toast.error(\"Failed to comment\"); }\r\n        finally { setIsSubmitting(false); }\r\n    };\r\n\r\n    const handleCommentMagic = async () => {\r\n        if (!commentText.trim()) return toast.error('Type something first!');\r\n        setIsGeneratingComment(true);\r\n        try {\r\n            const magicText = await chatWithAgent(`Make this comment witty and friendly: \"${commentText}\"`, 'general');\r\n            setCommentText(magicText || commentText);\r\n        } catch { toast.error(\"Magic failed\"); }\r\n        finally { setIsGeneratingComment(false); }\r\n    };\r\n\r\n    const handleCommentFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files?.[0]) {\r\n            setIsUploadingComment(true);\r\n            try {\r\n                const snapshot = await uploadBytes(ref(storage, `comments/${Date.now()}-${e.target.files[0].name}`), e.target.files[0]);\r\n                setCommentMediaUrl(await getDownloadURL(snapshot.ref));\r\n            } catch { toast.error('Upload failed'); }\r\n            finally { setIsUploadingComment(false); if (commentFileInputRef.current) commentFileInputRef.current.value = ''; }\r\n        }\r\n    };\r\n\r\n    const handleEditSave = async () => {\r\n        if (!editContent.trim()) return;\r\n        setIsSavingEdit(true);\r\n        try { await editPost(post.id, editContent, contextType, contextId); toast.success(\"Updated\"); setIsEditing(false); }\r\n        catch { toast.error(\"Update failed\"); } finally { setIsSavingEdit(false); }\r\n    };\r\n\r\n    const handleDeletePost = async () => {\r\n        if (!confirm(\"Delete post?\")) return;\r\n        try { await deletePostWithContext(post.id, contextType, contextId); toast.success(\"Deleted\"); const card = document.getElementById(`post-${post.id}`); if (card) card.style.display = 'none'; }\r\n        catch { toast.error(\"Delete failed\"); }\r\n    };\r\n\r\n    const handleTranslate = async (targetLang: 'es' | 'en' | 'fr' | 'zh' | 'hi' | 'ar' = 'en') => {\r\n        setIsTranslating(true);\r\n        setTargetLanguage(targetLang);\r\n        try {\r\n            const { translateText } = await import(\"@/app/actions/ai\");\r\n            setTranslatedContent(await translateText(post.content, targetLang));\r\n        } catch { toast.error(\"Translation failed\"); } finally { setIsTranslating(false); }\r\n    };\r\n\r\n    const handleShare = async (mode: 'copy' | 'native' | 'repost') => {\r\n        let url = `${window.location.origin}/post/${post.id}`;\r\n        if (mode === 'copy') { try { await navigator.clipboard.writeText(url); toast.success(t(\"feed.share.copy\")); } catch { } }\r\n        else if (mode === 'native' && navigator.share) navigator.share({ title: `Post by ${name}`, text: post.content, url }).catch(() => { });\r\n        else if (mode === 'repost') {\r\n            try {\r\n                const { createPost } = await import(\"@/app/actions/posts\");\r\n                await createPost(`üîÑ ${t(\"feed.repost\")}: ${post.content.substring(0, 100)}...`, post.mediaUrls || []);\r\n                toast.success(t(\"feed.repost.success\"));\r\n            } catch { toast.error(\"Repost failed\"); }\r\n        }\r\n    };\r\n\r\n    // --- RENDER ---\r\n    const pinterestPreview = (post as any).linkPreview;\r\n    const hasUploadedMedia = post.mediaUrls && post.mediaUrls.length > 0;\r\n    const hasLinkPreview = !!pinterestPreview?.image;\r\n\r\n    // Determine Main Media Anchor (use first image/video, OR the embedded link, OR link preview)\r\n    let mainMedia = hasUploadedMedia ? post.mediaUrls[0] : (hasLinkPreview ? pinterestPreview.image : mediaUrl);\r\n    const hasMedia = !!mainMedia;\r\n\r\n    const isEmbeddable = !hasUploadedMedia && !hasLinkPreview && (mainMedia === mediaUrl);\r\n    const isVideoFile = isUrlVideo(mainMedia);\r\n    const isPinterestLinkPreview = hasLinkPreview && !hasUploadedMedia;\r\n\r\n    // Card Styles\r\n    const cardClasses = isEnlarged\r\n        ? \"w-full max-w-3xl bg-card rounded-[1.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh] overflow-y-auto custom-scrollbar ring-1 ring-black/5\"\r\n        : isPinterest\r\n            ? \"group relative break-inside-avoid border-none shadow-sm hover:shadow-md transition-all duration-300 bg-white dark:bg-card rounded-2xl overflow-hidden flex flex-col cursor-pointer ring-1 ring-black/[0.03]\"\r\n            : \"group relative break-inside-avoid border-none shadow-sm hover:shadow-md transition-shadow duration-300 bg-card rounded-[1.5rem] overflow-hidden flex flex-col cursor-pointer ring-1 ring-black/5\";\r\n\r\n    return (\r\n        <>\r\n            <Card\r\n                id={`post-${post.id}`}\r\n                className={cardClasses}\r\n                onClick={!isEnlarged ? handleEnlarge : undefined}\r\n                data-post-card=\"true\"\r\n            >\r\n\r\n                {/* 1. MEDIA ANCHOR (Top) */}\r\n                {hasMedia && (\r\n                    <div className=\"w-full relative\">\r\n                        {isEmbeddable && mediaUrl ? (\r\n                            // Embeddable (YouTube etc)\r\n                            // In Feed: playInline=false (Show Preview). onClick -> Enlarge\r\n                            // In Modal: playInline=true (Playable).\r\n                            <div className=\"w-full\">\r\n                                <MediaEmbed\r\n                                    url={mediaUrl}\r\n                                    playInline={isEnlarged}\r\n                                    onPlayRequest={handleEnlarge}\r\n                                />\r\n                            </div>\r\n                        ) : isVideoFile ? (\r\n                            <div\r\n                                className=\"w-full bg-black rounded-lg overflow-hidden relative cursor-pointer\"\r\n                                onMouseEnter={() => { if (!isEnlarged && videoRef.current) videoRef.current.play().catch(() => { }); }}\r\n                                onMouseLeave={() => { if (!isEnlarged && videoRef.current) { videoRef.current.pause(); videoRef.current.currentTime = 0; } }}\r\n                                onClick={(e) => {\r\n                                    if (!isEnlarged) {\r\n                                        e.stopPropagation();\r\n                                        handleEnlarge();\r\n                                    }\r\n                                }}\r\n                            >\r\n                                <video\r\n                                    ref={videoRef}\r\n                                    src={`${mainMedia}#t=0.001`}\r\n                                    poster={post.thumbnailUrl || undefined}\r\n                                    className=\"w-full h-auto object-cover max-h-[70vh]\"\r\n                                    controls={isEnlarged} // Only controls if enlarged\r\n                                    autoPlay={isEnlarged}\r\n                                    muted={!isEnlarged}\r\n                                    preload=\"metadata\"\r\n                                    playsInline\r\n                                />\r\n                                {!isEnlarged && (\r\n                                    <div className=\"absolute inset-0 flex items-center justify-center bg-black/10 transition-colors pointer-events-none\">\r\n                                        <div className=\"w-12 h-12 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm shadow-lg\">\r\n                                            <Play className=\"w-6 h-6 text-white fill-current\" />\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"w-full relative overflow-hidden bg-muted\">\r\n                                {/* eslint-disable-next-line @next/next/no-img-element */}\r\n                                <img\r\n                                    src={mainMedia}\r\n                                    alt=\"\"\r\n                                    className=\"w-full h-auto object-cover max-h-[70vh] hover:scale-105 transition-transform duration-500\"\r\n                                    onError={(e) => { e.currentTarget.style.display = 'none'; }}\r\n                                />\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Pinterest Overlay Actions (Mobile Only) */}\r\n                        {isPinterest && hasMedia && (\r\n                            <div className=\"absolute inset-0 opacity-0 group-hover:opacity-100 group-active:opacity-100 transition-opacity pointer-events-none\">\r\n                                {/* Top-right: Save + Share */}\r\n                                <div className=\"absolute top-2 right-2 flex gap-2 pointer-events-auto\" onClick={e => e.stopPropagation()}>\r\n                                    <Button\r\n                                        size=\"icon\"\r\n                                        className=\"h-8 w-8 rounded-full bg-white/95 hover:bg-white backdrop-blur-sm shadow-md text-foreground border-none\"\r\n                                        onClick={(e) => {\r\n                                            e.stopPropagation();\r\n                                            handleReaction('love');\r\n                                        }}\r\n                                    >\r\n                                        <Heart className={cn(\"w-4 h-4\", currentReaction && \"fill-current text-pink-600\")} />\r\n                                    </Button>\r\n                                    <Button\r\n                                        size=\"icon\"\r\n                                        className=\"h-8 w-8 rounded-full bg-white/95 hover:bg-white backdrop-blur-sm shadow-md text-foreground border-none\"\r\n                                        onClick={(e) => {\r\n                                            e.stopPropagation();\r\n                                            handleShare('native');\r\n                                        }}\r\n                                    >\r\n                                        <Share2 className=\"w-4 h-4\" />\r\n                                    </Button>\r\n                                </div>\r\n                                {/* Bottom-right: More menu */}\r\n                                <div className=\"absolute bottom-2 right-2 pointer-events-auto\" onClick={e => e.stopPropagation()}>\r\n                                    <DropdownMenu>\r\n                                        <DropdownMenuTrigger asChild>\r\n                                            <Button size=\"icon\" className=\"h-7 w-7 rounded-full bg-black/40 hover:bg-black/60 backdrop-blur-sm text-white border-none\">\r\n                                                <MoreHorizontal className=\"w-4 h-4\" />\r\n                                            </Button>\r\n                                        </DropdownMenuTrigger>\r\n                                        <DropdownMenuContent align=\"end\">\r\n                                            <DropdownMenuSub>\r\n                                                <DropdownMenuSubTrigger>\r\n                                                    <Globe className=\"w-4 h-4 mr-2\" />\r\n                                                    <span>{t(\"post.translate\")}</span>\r\n                                                </DropdownMenuSubTrigger>\r\n                                                <DropdownMenuPortal>\r\n                                                    <DropdownMenuSubContent>\r\n                                                        <DropdownMenuItem onClick={() => handleTranslate('en')}>English</DropdownMenuItem>\r\n                                                        <DropdownMenuItem onClick={() => handleTranslate('zh')}>‰∏≠Êñá (Mandarin)</DropdownMenuItem>\r\n                                                        <DropdownMenuItem onClick={() => handleTranslate('hi')}>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</DropdownMenuItem>\r\n                                                        <DropdownMenuItem onClick={() => handleTranslate('es')}>Espa√±ol</DropdownMenuItem>\r\n                                                        <DropdownMenuItem onClick={() => handleTranslate('fr')}>Fran√ßais</DropdownMenuItem>\r\n                                                        <DropdownMenuItem onClick={() => handleTranslate('ar')}>ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</DropdownMenuItem>\r\n                                                        {translatedContent && (\r\n                                                            <>\r\n                                                                <DropdownMenuSeparator />\r\n                                                                <DropdownMenuItem onClick={() => setTranslatedContent(null)}>\r\n                                                                    {t(\"post.translate.original\")}\r\n                                                                </DropdownMenuItem>\r\n                                                            </>\r\n                                                        )}\r\n                                                    </DropdownMenuSubContent>\r\n                                                </DropdownMenuPortal>\r\n                                            </DropdownMenuSub>\r\n                                            {isAuthor && <DropdownMenuItem onClick={() => setIsEditing(true)}>{t(\"post.edit\")}</DropdownMenuItem>}\r\n                                            {isAuthor && <DropdownMenuItem onClick={handleDeletePost} className=\"text-red-500\">{t(\"post.delete\")}</DropdownMenuItem>}\r\n                                            {!isAuthor && <DropdownMenuItem className=\"text-red-500\">{t(\"post.report\")}</DropdownMenuItem>}\r\n                                        </DropdownMenuContent>\r\n                                    </DropdownMenu>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Original Pinterest Link Preview Overlay */}\r\n                        {!isPinterest && isPinterestLinkPreview && (\r\n                            <div className=\"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-4 text-white flex flex-col justify-end pt-16 pointer-events-none\">\r\n                                <div className=\"flex items-center gap-2 mb-1\">\r\n                                    <div className=\"bg-[#E60023] rounded-full p-1 shadow-sm\"><span className=\"sr-only\">Pinterest</span><svg viewBox=\"0 0 24 24\" fill=\"currentColor\" className=\"w-3 h-3 text-white\"><path d=\"M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.228.085.355-.09.376-.292 1.199-.332 1.363-.053.225-.172.271-.399.165-1.487-.695-2.42-2.875-2.42-4.646 0-3.778 2.305-7.252 7.951-7.252 4.173 0 6.949 3.018 6.949 6.169 0 3.714-2.313 6.649-5.512 6.649-1.084 0-2.092-.565-2.435-1.229l-.665 2.527c-.237.906-.883 2.052-1.314 2.749 1.002.301 2.05.461 3.137.461 6.613 0 11.979-5.368 11.979-11.987001C24 5.367 18.618 0 12.017 0z\" /></svg></div>\r\n                                    <span className=\"text-xs font-bold uppercase tracking-wider opacity-95 drop-shadow-md\">Pinterest</span>\r\n                                </div>\r\n                                {pinterestPreview.title && <h3 className=\"text-sm font-bold line-clamp-2 leading-tight drop-shadow-md\">{pinterestPreview.title}</h3>}\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Additional media indicator */}\r\n                        {post.mediaUrls?.length > 1 && (\r\n                            <div className=\"absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full font-medium pointer-events-none\">\r\n                                +{post.mediaUrls.length - 1} more\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Enlarge Hint Overlay (Only in Feed) */}\r\n                        {!isEnlarged && !isEmbeddable && !isVideoFile && (\r\n                            <div className=\"absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end justify-center pb-2\">\r\n                                <span className=\"text-white text-xs font-medium flex items-center gap-1\">\r\n                                    <Sparkles className=\"w-3 h-3\" /> {t(\"post.view\")}\r\n                                </span>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* 2. CONTENT & TITLE (Middle) */}\r\n                <div className={cn(\r\n                    isPinterest ? \"px-3 py-2 flex flex-col gap-1.5\" : \"px-4 pt-3 pb-2 flex flex-col gap-2\",\r\n                    !hasMedia && !isPinterest && \"pt-4\"\r\n                )}>\r\n                    {/* Author Info - Always visible, but styled differently for Pinterest */}\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2\" onClick={e => e.stopPropagation()}>\r\n                            <Link href={`/u/${post.authorId}`}>\r\n                                <Avatar className=\"w-6 h-6 border border-border\">\r\n                                    <AvatarImage src={profilePic || undefined} />\r\n                                    <AvatarFallback className=\"text-[10px]\">{name.charAt(0)}</AvatarFallback>\r\n                                </Avatar>\r\n                            </Link>\r\n                            <div className=\"flex flex-col\">\r\n                                <Link href={`/u/${post.authorId}`} className=\"text-xs font-semibold hover:underline line-clamp-1\">{name}</Link>\r\n                                <div className=\"flex items-center gap-1 text-[10px] text-muted-foreground\">\r\n                                    <SafeDate date={post.createdAt} />\r\n                                    {post.context?.name && <span>{t(\"post.posted_in\")} {post.context.name}</span>}\r\n                                    <span className=\"opacity-50 flex items-center gap-1\">\r\n                                        {getPrivacyIcon()}\r\n                                        {engagementSettings.privacy === 'specific' && post.allowedViewerIds?.length > 0 && (\r\n                                            <span className=\"text-[9px] bg-blue-50 text-blue-600 px-1 rounded-sm\">\r\n                                                +{post.allowedViewerIds.length}\r\n                                            </span>\r\n                                        )}\r\n                                    </span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        {/* Menu - Stop Propagation */}\r\n                        <div onClick={e => e.stopPropagation()}>\r\n                            <DropdownMenu>\r\n                                <DropdownMenuTrigger asChild>\r\n                                    <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity\"><MoreHorizontal className=\"w-4 h-4\" /></Button>\r\n                                </DropdownMenuTrigger>\r\n                                <DropdownMenuContent align=\"end\">\r\n                                    <DropdownMenuSub>\r\n                                        <DropdownMenuSubTrigger>\r\n                                            <Globe className=\"w-4 h-4 mr-2\" />\r\n                                            <span>{t(\"post.translate\")}</span>\r\n                                        </DropdownMenuSubTrigger>\r\n                                        <DropdownMenuPortal>\r\n                                            <DropdownMenuSubContent>\r\n                                                <DropdownMenuItem onClick={() => handleTranslate('en')}>English</DropdownMenuItem>\r\n                                                <DropdownMenuItem onClick={() => handleTranslate('zh')}>‰∏≠Êñá (Mandarin)</DropdownMenuItem>\r\n                                                <DropdownMenuItem onClick={() => handleTranslate('hi')}>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</DropdownMenuItem>\r\n                                                <DropdownMenuItem onClick={() => handleTranslate('es')}>Espa√±ol</DropdownMenuItem>\r\n                                                <DropdownMenuItem onClick={() => handleTranslate('fr')}>Fran√ßais</DropdownMenuItem>\r\n                                                <DropdownMenuItem onClick={() => handleTranslate('ar')}>ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</DropdownMenuItem>\r\n                                                {translatedContent && (\r\n                                                    <>\r\n                                                        <DropdownMenuSeparator />\r\n                                                        <DropdownMenuItem onClick={() => setTranslatedContent(null)}>\r\n                                                            {t(\"post.translate.original\")}\r\n                                                        </DropdownMenuItem>\r\n                                                    </>\r\n                                                )}\r\n                                            </DropdownMenuSubContent>\r\n                                        </DropdownMenuPortal>\r\n                                    </DropdownMenuSub>\r\n                                    <DropdownMenuItem onClick={() => setAskAIDialogOpen(true)} className=\"text-purple-600 dark:text-purple-400 gap-2\">\r\n                                        <Sparkles className=\"w-4 h-4\" />\r\n                                        {t(\"post.ask_ai\")}\r\n                                    </DropdownMenuItem>\r\n                                    {isAuthor && <DropdownMenuItem onClick={() => setIsEditing(true)}>{t(\"post.edit\")}</DropdownMenuItem>}\r\n                                    {isAuthor && <DropdownMenuItem onClick={handleDeletePost} className=\"text-red-500\">{t(\"post.delete\")}</DropdownMenuItem>}\r\n                                    {!isAuthor && <DropdownMenuItem className=\"text-red-500\">{t(\"post.report\")}</DropdownMenuItem>}\r\n                                </DropdownMenuContent>\r\n                            </DropdownMenu>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Text Content */}\r\n                    <div onClick={e => !isEditing && isEnlarged ? e.stopPropagation() : undefined}>\r\n                        {isEditing ? (\r\n                            <div className=\"space-y-2 mt-2\" onClick={e => e.stopPropagation()}>\r\n                                <Textarea value={editContent} onChange={e => setEditContent(e.target.value)} className=\"text-sm\" />\r\n                                <div className=\"flex justify-end gap-2\"><Button size=\"sm\" onClick={() => setIsEditing(false)} variant=\"outline\">Cancel</Button><Button size=\"sm\" onClick={handleEditSave}>Save</Button></div>\r\n                            </div>\r\n                        ) : (\r\n                            // If in feed (!isEnlarged), clicking text bubbles to Card onClick -> handleEnlarge\r\n                            <div className={cn(\r\n                                \"text-sm leading-relaxed whitespace-pre-wrap\",\r\n                                isPinterest ? \"text-foreground/95 font-medium line-clamp-2\" : \"text-foreground/90\",\r\n                                !isPinterest && (!isEnlarged && hasMedia ? \"line-clamp-3\" : \"line-clamp-6\")\r\n                            )}>\r\n                                <Linkify text={translatedContent || post.content} hideUrls={mediaUrl ? [mediaUrl] : []} onMediaFound={() => { }} />\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 3. ACTIONS & STATS (Bottom) - Minimal on Pinterest, full on standard */}\r\n                <div className={cn(\r\n                    \"mt-auto pt-2 pb-3\",\r\n                    isPinterest ? \"px-3\" : \"px-3\"\r\n                )} onClick={e => e.stopPropagation()}>\r\n                    <div className=\"flex items-center justify-between\">\r\n                        {/* Reactions */}\r\n                        <div className=\"flex items-center gap-1\">\r\n                            <DropdownMenu>\r\n                                <DropdownMenuTrigger asChild>\r\n                                    <Button variant=\"ghost\" size=\"sm\" className={cn(\"h-8 px-2 gap-1.5 rounded-full hover:bg-pink-50 dark:hover:bg-pink-900/20\", currentReaction && \"text-pink-600 bg-pink-50 dark:bg-pink-900/10\")}>\r\n                                        {currentReaction ? <span className=\"text-lg\">{getReactionIcon(currentReaction)}</span> : <Heart className=\"w-4 h-4\" />}\r\n                                        <span className=\"text-xs font-medium\">{reactionCount > 0 ? reactionCount : \"\"}</span>\r\n                                    </Button>\r\n                                </DropdownMenuTrigger>\r\n                                <DropdownMenuContent align=\"start\" className=\"flex p-2 gap-1\">\r\n                                    {REACTIONS.map(r => <button key={r.type} onClick={() => handleReaction(r.type as ReactionType)} className=\"text-2xl hover:scale-125 transition-transform p-1\">{r.emoji}</button>)}\r\n                                </DropdownMenuContent>\r\n                            </DropdownMenu>\r\n\r\n                            <Button variant=\"ghost\" size=\"sm\" onClick={() => !isEnlarged ? handleEnlarge() : setShowComments(!showComments)} className=\"h-8 px-2 gap-1.5 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/20 text-muted-foreground hover:text-blue-600\">\r\n                                <MessageCircle className=\"w-4 h-4\" />\r\n                                <span className=\"text-xs font-medium\">{comments.length > 0 ? comments.length : \"\"}</span>\r\n                            </Button>\r\n\r\n                            <Button variant=\"ghost\" size=\"sm\" onClick={() => handleShare('native')} className=\"h-8 w-8 rounded-full text-muted-foreground hover:bg-green-50 dark:hover:bg-green-900/20 hover:text-green-600 p-0\">\r\n                                <Share2 className=\"w-4 h-4\" />\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* COMMENTS SECTION (Expandable) */}\r\n                    {(showComments || isEnlarged) && (\r\n                        <div className=\"mt-3 pt-3 border-t border-border animate-in fade-in zoom-in-95 duration-200\">\r\n                            {/* Comment Input */}\r\n                            <div className=\"flex gap-2 items-center mb-3\">\r\n                                <Input placeholder=\"Write a comment...\" value={commentText} onChange={e => setCommentText(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleCommentSubmit()} className=\"h-9 text-sm rounded-full bg-muted/50 border-none focus-visible:ring-1\" />\r\n                                <Button size=\"icon\" className=\"h-9 w-9 rounded-full shrink-0\" onClick={handleCommentSubmit} disabled={!commentText.trim() || isSubmitting}>\r\n                                    {isSubmitting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4\" />}\r\n                                </Button>\r\n                            </div>\r\n                            {/* Comments List */}\r\n                            <div className={cn(\"space-y-3 pr-1 custom-scrollbar\", isEnlarged ? \"max-h-[min(300px,40vh)] overflow-y-auto\" : \"max-h-[300px] overflow-y-auto\")}>\r\n                                {comments.map(c => (\r\n                                    <CommentItem key={c.id} comment={c} postId={post.id} currentUserId={currentUserId} contextType={contextType} contextId={contextId} postAuthorId={post.authorId} />\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                <ReportDialog open={reportDialogOpen} onOpenChange={setReportDialogOpen} targetType=\"post\" targetId={post.id} context={{ contextType, contextId, authorId: post.authorId }} />\r\n                {isAuthor && <EngagementSettingsDialog open={settingsDialogOpen} onOpenChange={setSettingsDialogOpen} postId={post.id} currentSettings={engagementSettings} contextType={contextType} contextId={contextId} />}\r\n                <AskAIDialog\r\n                    isOpen={askAIDialogOpen}\r\n                    onClose={() => setAskAIDialogOpen(false)}\r\n                    postContent={translatedContent || post.content}\r\n                    postAuthor={name}\r\n                />\r\n            </Card>\r\n\r\n            {/* ENLARGED VIEW MODAL */}\r\n            {enlargedViewOpen && (\r\n                <div className=\"fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200\" onClick={() => setEnlargedViewOpen(false)}>\r\n                    {/* Close Button */}\r\n                    <button onClick={() => setEnlargedViewOpen(false)} className=\"absolute top-4 right-4 p-2 text-white/70 hover:text-white rounded-full bg-white/10 hover:bg-white/20 transition-colors z-50\">\r\n                        <X className=\"w-6 h-6\" />\r\n                    </button>\r\n\r\n                    <div className=\"w-full max-w-3xl max-h-[95vh] flex flex-col items-center justify-center pointer-events-none\">\r\n                        {/* Prevent clicks on the card itself from closing the modal */}\r\n                        <div className=\"w-full pointer-events-auto\" onClick={e => e.stopPropagation()}>\r\n                            <PostCard\r\n                                post={post}\r\n                                currentUserId={currentUserId}\r\n                                isEnlarged={true}\r\n                                initialTranslatedContent={translatedContent}\r\n                                initialLanguage={targetLanguage}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\reaction-selector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[17,65],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { ReactionType } from \"@/types/posts\";\r\n\r\nexport const REACTIONS: { type: ReactionType; label: string; emoji: string; color: string }[] = [\r\n    { type: 'brilliant', label: 'Brilliant', emoji: 'üí°', color: 'text-amber-500' },\r\n    { type: 'excellent', label: 'Excellent', emoji: 'üåü', color: 'text-yellow-500' },\r\n    { type: 'hugs', label: 'Hugs', emoji: 'ü§ó', color: 'text-orange-500' },\r\n    { type: 'thinking_of_you', label: 'Thinking of you', emoji: 'üíñ', color: 'text-pink-500' },\r\n    { type: 'vibe', label: \"That's a Vibe\", emoji: 'üòé', color: 'text-purple-500' },\r\n    { type: 'positive_energy', label: 'Positive Energy', emoji: '‚ú®', color: 'text-yellow-400' },\r\n    { type: 'healing_energy', label: 'Sending Healing Energy', emoji: '‚ù§Ô∏è‚Äçü©π', color: 'text-red-400' },\r\n    { type: 'optimistic', label: 'Optimistic', emoji: 'üåà', color: 'text-blue-500' },\r\n];\r\n\r\ninterface ReactionSelectorProps {\r\n    onSelect: (type: ReactionType) => void;\r\n    currentReaction?: ReactionType;\r\n}\r\n\r\nexport function ReactionSelector({ onSelect, currentReaction }: ReactionSelectorProps) {\r\n    return (\r\n        <div className=\"flex items-center gap-1 p-1 bg-background border border-border rounded-full shadow-lg animate-in fade-in zoom-in-95 duration-200\">\r\n            {REACTIONS.map((reaction) => (\r\n                <button\r\n                    key={reaction.type}\r\n                    onClick={() => onSelect(reaction.type)}\r\n                    title={reaction.label}\r\n                    className={cn(\r\n                        \"text-2xl p-2 hover:scale-125 transition-transform duration-200 rounded-full hover:bg-muted\",\r\n                        currentReaction === reaction.type && \"bg-muted scale-110\"\r\n                    )}\r\n                >\r\n                    {reaction.emoji}\r\n                </button>\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n\r\nexport function getReactionIcon(type?: ReactionType) {\r\n    const reaction = REACTIONS.find(r => r.type === type);\r\n    return reaction ? reaction.emoji : 'üëç';\r\n}\r\n\r\nexport function getReactionLabel(type?: ReactionType) {\r\n    const reaction = REACTIONS.find(r => r.type === type);\r\n    return reaction ? reaction.label : 'Like';\r\n}\r\n\r\nexport function getReactionColor(type?: ReactionType) {\r\n    const reaction = REACTIONS.find(r => r.type === type);\r\n    return reaction ? reaction.color : 'text-muted-foreground';\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\visibility-selector.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1330,1333],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1330,1333],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":57,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":201,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9627,9630],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9627,9630],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuLabel,\r\n    DropdownMenuRadioGroup,\r\n    DropdownMenuRadioItem,\r\n    DropdownMenuSeparator,\r\n    DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\r\nimport { Globe, Users, Lock, ChevronDown, Check } from \"lucide-react\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { getFamilyMembers } from \"@/app/actions/family\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { toast } from \"sonner\";\r\n\r\nexport type PrivacyType = 'public' | 'companions' | 'specific' | 'private';\r\n\r\ninterface VisibilitySelectorProps {\r\n    value: PrivacyType;\r\n    onChange: (value: PrivacyType) => void;\r\n    onAllowedViewersChange: (ids: string[]) => void;\r\n    allowedViewerIds: string[];\r\n}\r\n\r\nexport function VisibilitySelector({ value, onChange, onAllowedViewersChange, allowedViewerIds }: VisibilitySelectorProps) {\r\n    const [viewerDialogOpen, setViewerDialogOpen] = useState(false);\r\n    const [companions, setCompanions] = useState<any[]>([]);\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    // Temp state for dialog\r\n    const [tempSelectedIds, setTempSelectedIds] = useState<Set<string>>(new Set(allowedViewerIds));\r\n\r\n    useEffect(() => {\r\n        // Pre-fetch companions if not already done, or fetch on dialog open\r\n    }, []);\r\n\r\n    const handleSelect = (val: string) => {\r\n        if (val === 'specific') {\r\n            setViewerDialogOpen(true);\r\n            loadCompanions();\r\n        } else {\r\n            onChange(val as PrivacyType);\r\n        }\r\n    };\r\n\r\n    const loadCompanions = async () => {\r\n        if (companions.length > 0) return;\r\n        setIsLoading(true);\r\n        try {\r\n            const data = await getFamilyMembers();\r\n            setCompanions(data);\r\n        } catch (e) {\r\n            toast.error(\"Failed to load companions\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const toggleSelection = (id: string) => {\r\n        const newSet = new Set(tempSelectedIds);\r\n        if (newSet.has(id)) newSet.delete(id);\r\n        else newSet.add(id);\r\n        setTempSelectedIds(newSet);\r\n    };\r\n\r\n    const saveSpecific = () => {\r\n        if (tempSelectedIds.size === 0) {\r\n            toast.error(\"Please select at least one person\");\r\n            return;\r\n        }\r\n        onAllowedViewersChange(Array.from(tempSelectedIds));\r\n        onChange('specific');\r\n        setViewerDialogOpen(false);\r\n    };\r\n\r\n    const getIcon = () => {\r\n        switch (value) {\r\n            case 'public': return <Globe className=\"w-4 h-4\" />;\r\n            case 'companions': return <Users className=\"w-4 h-4\" />;\r\n            case 'specific': return <Users className=\"w-4 h-4\" />; // Or a specific icon\r\n            case 'private': return <Lock className=\"w-4 h-4\" />;\r\n            default: return <Globe className=\"w-4 h-4\" />;\r\n        }\r\n    };\r\n\r\n    const getLabel = () => {\r\n        switch (value) {\r\n            case 'public': return \"Public\";\r\n            case 'companions': return \"Companions\";\r\n            case 'specific': return \"Specific Companions\";\r\n            case 'private': return \"Only Me\";\r\n            default: return \"Public\";\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                    <Button variant=\"outline\" size=\"sm\" className=\"gap-2 h-8 px-3 rounded-full bg-background/50 backdrop-blur-sm border-white/20 hover:bg-white/10 dark:hover:bg-black/20 text-xs font-medium\">\r\n                        {getIcon()}\r\n                        <span>{getLabel()}</span>\r\n                        <ChevronDown className=\"w-3 h-3 opacity-50\" />\r\n                    </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\" className=\"w-56\">\r\n                    <DropdownMenuLabel>Who can see this?</DropdownMenuLabel>\r\n                    <DropdownMenuSeparator />\r\n                    <DropdownMenuRadioGroup value={value} onValueChange={handleSelect}>\r\n                        <DropdownMenuRadioItem value=\"public\" className=\"cursor-pointer\">\r\n                            <Globe className=\"w-4 h-4 mr-2\" />\r\n                            <div className=\"flex flex-col\">\r\n                                <span>Public</span>\r\n                                <span className=\"text-[10px] text-muted-foreground\">Anyone on Famio</span>\r\n                            </div>\r\n                        </DropdownMenuRadioItem>\r\n                        <DropdownMenuRadioItem value=\"companions\" className=\"cursor-pointer\">\r\n                            <Users className=\"w-4 h-4 mr-2\" />\r\n                            <div className=\"flex flex-col\">\r\n                                <span>Companions</span>\r\n                                <span className=\"text-[10px] text-muted-foreground\">Your connections</span>\r\n                            </div>\r\n                        </DropdownMenuRadioItem>\r\n                        <DropdownMenuRadioItem value=\"specific\" className=\"cursor-pointer\">\r\n                            <UserGroupIcon className=\"w-4 h-4 mr-2\" />\r\n                            <div className=\"flex flex-col\">\r\n                                <span>Specific Companions</span>\r\n                                <span className=\"text-[10px] text-muted-foreground\">Select people...</span>\r\n                            </div>\r\n                        </DropdownMenuRadioItem>\r\n                        <DropdownMenuSeparator />\r\n                        <DropdownMenuRadioItem value=\"private\" className=\"cursor-pointer\">\r\n                            <Lock className=\"w-4 h-4 mr-2\" />\r\n                            <div className=\"flex flex-col\">\r\n                                <span>Only Me</span>\r\n                                <span className=\"text-[10px] text-muted-foreground\">Visible to you only</span>\r\n                            </div>\r\n                        </DropdownMenuRadioItem>\r\n                    </DropdownMenuRadioGroup>\r\n                </DropdownMenuContent>\r\n            </DropdownMenu>\r\n\r\n            <Dialog open={viewerDialogOpen} onOpenChange={setViewerDialogOpen}>\r\n                <DialogContent className=\"max-w-md\">\r\n                    <DialogHeader>\r\n                        <DialogTitle>Select Audience</DialogTitle>\r\n                        <DialogDescription>Only the people you select will be able to see this post.</DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <ScrollArea className=\"h-[300px] pr-4\">\r\n                        {isLoading ? (\r\n                            <div className=\"py-8 text-center text-sm text-muted-foreground\">Loading connections...</div>\r\n                        ) : companions.length === 0 ? (\r\n                            <div className=\"py-8 text-center text-sm text-muted-foreground\">No companions found.</div>\r\n                        ) : (\r\n                            <div className=\"space-y-2\">\r\n                                {companions.map((person) => {\r\n                                    const isSelected = tempSelectedIds.has(person.id);\r\n                                    return (\r\n                                        <div\r\n                                            key={person.id}\r\n                                            onClick={() => toggleSelection(person.id)}\r\n                                            className={cn(\r\n                                                \"flex items-center gap-3 p-2 rounded-lg cursor-pointer transition-colors border\",\r\n                                                isSelected ? \"bg-primary/10 border-primary/50\" : \"hover:bg-muted border-transparent\"\r\n                                            )}\r\n                                        >\r\n                                            <Avatar className=\"w-8 h-8\">\r\n                                                <AvatarImage src={person.imageUrl} />\r\n                                                <AvatarFallback>{person.displayName?.charAt(0)}</AvatarFallback>\r\n                                            </Avatar>\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <p className=\"text-sm font-medium truncate\">{person.displayName}</p>\r\n                                                <p className=\"text-xs text-muted-foreground truncate\">{person.email}</p>\r\n                                            </div>\r\n                                            {isSelected && <Check className=\"w-4 h-4 text-primary\" />}\r\n                                        </div>\r\n                                    );\r\n                                })}\r\n                            </div>\r\n                        )}\r\n                    </ScrollArea>\r\n\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setViewerDialogOpen(false)}>Cancel</Button>\r\n                        <Button onClick={saveSpecific} disabled={tempSelectedIds.size === 0}>\r\n                            Done ({tempSelectedIds.size})\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </>\r\n    );\r\n}\r\n\r\nfunction UserGroupIcon(props: any) {\r\n    return (\r\n        <svg\r\n            {...props}\r\n            xmlns=\"http://www.w3.org/2000/svg\"\r\n            width=\"24\"\r\n            height=\"24\"\r\n            viewBox=\"0 0 24 24\"\r\n            fill=\"none\"\r\n            stroke=\"currentColor\"\r\n            strokeWidth=\"2\"\r\n            strokeLinecap=\"round\"\r\n            strokeLinejoin=\"round\"\r\n        >\r\n            <path d=\"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2\" />\r\n            <circle cx=\"9\" cy=\"7\" r=\"4\" />\r\n            <path d=\"M22 21v-2a4 4 0 0 0-3-3.87\" />\r\n            <path d=\"M16 3.13a4 4 0 0 1 0 7.75\" />\r\n        </svg>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\feed\\welcome-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\gallery\\gallery-grid.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":67,"column":29,"nodeType":"JSXOpeningElement","endLine":71,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport { Trash2, AlertTriangle, Eye } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { deletePost } from \"@/app/actions/posts\";\r\nimport Link from \"next/link\";\r\nimport {\r\n    AlertDialog,\r\n    AlertDialogAction,\r\n    AlertDialogCancel,\r\n    AlertDialogContent,\r\n    AlertDialogDescription,\r\n    AlertDialogFooter,\r\n    AlertDialogHeader,\r\n    AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\ninterface GalleryItemType {\r\n    url: string;\r\n    postId: string;\r\n    authorId: string;\r\n}\r\n\r\ninterface GalleryGridProps {\r\n    items: GalleryItemType[];\r\n    currentUserId: string;\r\n}\r\n\r\nexport function GalleryGrid({ items, currentUserId }: GalleryGridProps) {\r\n    const { t } = useLanguage();\r\n    const [itemList, setItemList] = useState(items);\r\n    const [isDeleting, setIsDeleting] = useState(false);\r\n    const [itemToDelete, setItemToDelete] = useState<string | null>(null);\r\n\r\n    const handleDelete = async () => {\r\n        if (!itemToDelete) return;\r\n\r\n        setIsDeleting(true);\r\n        try {\r\n            await deletePost(itemToDelete);\r\n            setItemList(prev => prev.filter(i => i.postId !== itemToDelete));\r\n            toast.success(\"Photo deleted (Post removed)\");\r\n        } catch (error) {\r\n            console.error(error);\r\n            toast.error(\"Failed to delete photo\");\r\n        } finally {\r\n            setIsDeleting(false);\r\n            setItemToDelete(null);\r\n        }\r\n    };\r\n\r\n    if (itemList.length === 0) {\r\n        return <p className=\"text-center text-gray-500 py-10\">{t('gallery.empty')}</p>;\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\r\n                {itemList.map((item, idx) => {\r\n                    const isOwner = item.authorId === currentUserId;\r\n\r\n                    return (\r\n                        <div key={`${item.postId}-${idx}`} className=\"aspect-square rounded-lg overflow-hidden relative group bg-gray-100 dark:bg-muted\">\r\n                            <img\r\n                                src={item.url}\r\n                                alt=\"Gallery item\"\r\n                                className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\r\n                            />\r\n\r\n                            {/* Overlay Actions */}\r\n                            <div className=\"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-3\">\r\n                                {/* View Link */}\r\n                                <Link href={`/u/${item.authorId}#post-${item.postId}`}>\r\n                                    <Button size=\"icon\" variant=\"secondary\" className=\"rounded-full w-10 h-10 bg-white/90 hover:bg-white text-black\">\r\n                                        <Eye className=\"w-5 h-5\" />\r\n                                    </Button>\r\n                                </Link>\r\n\r\n                                {/* Delete Button (Owner Only) */}\r\n                                {isOwner && (\r\n                                    <Button\r\n                                        size=\"icon\"\r\n                                        variant=\"destructive\"\r\n                                        className=\"rounded-full w-10 h-10 shadow-lg\"\r\n                                        onClick={() => setItemToDelete(item.postId)}\r\n                                    >\r\n                                        <Trash2 className=\"w-5 h-5\" />\r\n                                    </Button>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            {/* Delete Confirmation Dialog */}\r\n            <AlertDialog open={!!itemToDelete} onOpenChange={(open) => !open && setItemToDelete(null)}>\r\n                <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                        <AlertDialogTitle>{t('gallery.delete.title')}</AlertDialogTitle>\r\n                        <AlertDialogDescription className=\"space-y-3\">\r\n                            <div className=\"flex items-center gap-2 p-3 bg-amber-50 text-amber-800 rounded-md border border-amber-200\">\r\n                                <AlertTriangle className=\"w-5 h-5 shrink-0\" />\r\n                                <span className=\"text-sm font-medium\">{t('gallery.delete.warning')}</span>\r\n                            </div>\r\n                        </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                        <AlertDialogCancel disabled={isDeleting}>{t('btn.cancel')}</AlertDialogCancel>\r\n                        <AlertDialogAction\r\n                            onClick={(e) => { e.preventDefault(); handleDelete(); }}\r\n                            className=\"bg-red-600 hover:bg-red-700 text-white\"\r\n                            disabled={isDeleting}\r\n                        >\r\n                            {isDeleting ? \"Deleting...\" : t('gallery.delete.confirm')}\r\n                        </AlertDialogAction>\r\n                    </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n            </AlertDialog>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\gallery\\gallery-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[256,259],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[256,259],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport { MainLayout } from \"@/components/layout/main-layout\";\r\nimport { GalleryGrid } from \"@/components/gallery/gallery-grid\";\r\n\r\ninterface GalleryViewProps {\r\n    mediaItems: any[];\r\n    currentUserId: string;\r\n}\r\n\r\nexport function GalleryView({ mediaItems, currentUserId }: GalleryViewProps) {\r\n    const { t } = useLanguage();\r\n\r\n    return (\r\n        <MainLayout>\r\n            <div className=\"mb-6\">\r\n                <h1 className=\"text-2xl font-bold text-foreground\">{t('gallery.title')}</h1>\r\n                <p className=\"text-muted-foreground\">{t('gallery.desc')}</p>\r\n            </div>\r\n\r\n            <GalleryGrid\r\n                items={mediaItems}\r\n                currentUserId={currentUserId}\r\n            />\r\n        </MainLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\create-group-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\group-ai-tutor-banner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\group-card.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":26,"column":29,"nodeType":"JSXOpeningElement","endLine":30,"endColumn":31},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":35,"column":37,"nodeType":"JSXOpeningElement","endLine":39,"endColumn":39},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":45,"column":21,"nodeType":"JSXOpeningElement","endLine":49,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { Card, CardContent, CardFooter, CardHeader } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Users, Lock, Globe } from \"lucide-react\";\r\nimport { Group } from \"@/app/actions/groups\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\nexport function GroupCard({ group }: { group: Group }) {\r\n    const { t } = useLanguage();\r\n\r\n    return (\r\n        <Card className=\"flex flex-col h-full hover:shadow-md transition-shadow\">\r\n            <div className=\"h-32 w-full bg-muted relative rounded-t-lg overflow-hidden\">\r\n                {group.coverUrl ? (\r\n                    <>\r\n                        {group.coverUrl.includes('mp4') || group.coverUrl.includes('webm') ? (\r\n                            <video\r\n                                src={group.coverUrl}\r\n                                className=\"w-full h-full object-cover\"\r\n                                autoPlay\r\n                                loop\r\n                                muted\r\n                                playsInline\r\n                            />\r\n                        ) : (\r\n                            <img\r\n                                src={group.coverUrl}\r\n                                alt={group.name}\r\n                                className=\"w-full h-full object-cover\"\r\n                            />\r\n                        )}\r\n                        {group.imageUrl && (\r\n                            <div className=\"absolute inset-0 flex items-center justify-center\">\r\n                                <div className=\"w-16 h-16 rounded-full border-4 border-white dark:border-gray-800 overflow-hidden bg-white shadow-lg\">\r\n                                    <img\r\n                                        src={group.imageUrl}\r\n                                        alt={group.name}\r\n                                        className=\"w-full h-full object-cover\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                    </>\r\n                ) : group.imageUrl ? (\r\n                    <img\r\n                        src={group.imageUrl}\r\n                        alt={group.name}\r\n                        className=\"w-full h-full object-cover\"\r\n                    />\r\n                ) : (\r\n                    <div className=\"w-full h-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center\">\r\n                        <Users className=\"w-12 h-12 text-primary/40\" />\r\n                    </div>\r\n                )}\r\n                <div className=\"absolute top-2 right-2 bg-background/80 backdrop-blur-sm px-2 py-1 rounded text-xs font-medium flex items-center gap-1\">\r\n                    {group.privacy === 'private' ? <Lock className=\"w-3 h-3\" /> : <Globe className=\"w-3 h-3\" />}\r\n                    {group.privacy === 'private' ? t(\"status.private\") : t(\"status.public\")}\r\n                </div>\r\n            </div>\r\n            <CardHeader className=\"pb-2\">\r\n                <div className=\"flex justify-between items-start\">\r\n                    <div>\r\n                        <h3 className=\"font-bold text-lg leading-tight\">{group.name}</h3>\r\n                        <p className=\"text-sm text-muted-foreground capitalize\">{group.category}</p>\r\n                    </div>\r\n                </div>\r\n            </CardHeader>\r\n            <CardContent className=\"flex-1 pb-4\">\r\n                <p className=\"text-sm text-muted-foreground line-clamp-2\">\r\n                    {group.description}\r\n                </p>\r\n                <div className=\"mt-4 flex items-center gap-2 text-xs text-muted-foreground\">\r\n                    <Users className=\"w-3 h-3\" />\r\n                    <span>{group.memberCount || 1} {t(\"sidebar.members\")}</span>\r\n                </div>\r\n            </CardContent>\r\n            <CardFooter>\r\n                <Button asChild className=\"w-full\">\r\n                    <Link href={`/groups/${group.slug || group.id}`}>\r\n                        {t(\"groups.view\")}\r\n                    </Link>\r\n                </Button>\r\n            </CardFooter>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\group-cover-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\group-feed.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"User"},"fix":{"range":[386,423],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[494,497],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[494,497],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { AnimatePresence, motion } from \"framer-motion\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Plus } from \"lucide-react\";\r\nimport { GroupPostCreator } from \"@/components/groups/group-post-creator\";\r\nimport { FeedList } from \"@/components/feed/feed-list\";\r\nimport { getGroupPosts } from \"@/app/actions/groups\";\r\nimport { User } from \"firebase/auth\";\r\n\r\ninterface GroupFeedProps {\r\n    groupId: string;\r\n    currentUser: any; // Using any to match existing props usage, ideally imports Profile type\r\n}\r\n\r\nexport function GroupFeed({ groupId, currentUser }: GroupFeedProps) {\r\n    const [isComposeOpen, setIsComposeOpen] = useState(false);\r\n\r\n    return (\r\n        <>\r\n            {/* Create Post - Smooth Expand/Collapse */}\r\n            <AnimatePresence initial={false}>\r\n                {isComposeOpen && (\r\n                    <motion.div\r\n                        initial={{ height: 0, opacity: 0 }}\r\n                        animate={{ height: \"auto\", opacity: 1 }}\r\n                        exit={{ height: 0, opacity: 0 }}\r\n                        transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n                        className=\"overflow-hidden mb-6\"\r\n                    >\r\n                        <GroupPostCreator\r\n                            groupId={groupId}\r\n                            user={currentUser}\r\n                            onClose={() => setIsComposeOpen(false)}\r\n                        />\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            <FeedList\r\n                variant=\"pinterest-mobile\"\r\n                fetcher={(limit, filters) => getGroupPosts(groupId, limit, filters)}\r\n                headerAction={\r\n                    <Button\r\n                        size=\"sm\"\r\n                        variant=\"outline\"\r\n                        className=\"rounded-full w-8 h-8 p-0 bg-background border-dashed border-primary/50 text-primary hover:bg-primary hover:text-white transition-all shadow-sm\"\r\n                        onClick={() => setIsComposeOpen(!isComposeOpen)}\r\n                    >\r\n                        <Plus className={`w-4 h-4 transition-transform duration-300 ${isComposeOpen ? \"rotate-45\" : \"\"}`} />\r\n                    </Button>\r\n                }\r\n            />\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\group-management-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogFooter' is defined but never used.","line":5,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":64,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogFooter"},"fix":{"range":[151,165],"text":""},"desc":"Remove unused variable \"DialogFooter\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogTrigger' is defined but never used.","line":5,"column":93,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":106,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogTrigger"},"fix":{"range":[192,207],"text":""},"desc":"Remove unused variable \"DialogTrigger\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Trash2' is defined but never used.","line":10,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Trash2"},"fix":{"range":[511,519],"text":""},"desc":"Remove unused variable \"Trash2\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1882,1885],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1882,1885],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2371,2374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2371,2374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":121,"column":45,"nodeType":"JSXOpeningElement","endLine":121,"endColumn":112},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"img elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":121,"column":45,"nodeType":"JSXOpeningElement","endLine":121,"endColumn":112}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Settings, Image as ImageIcon, Trash2, AlertTriangle, Loader2 } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { updateGroupDetails, softDeleteGroup } from \"@/app/actions/groups\";\r\nimport { CoverUploadDialog } from \"@/components/shared/cover-upload-dialog\";\r\n\r\ninterface GroupManagementDialogProps {\r\n    group: {\r\n        id: string;\r\n        name: string;\r\n        description: string;\r\n        coverUrl?: string;\r\n        founderId: string;\r\n    };\r\n    currentUser: {\r\n        id: string;\r\n    };\r\n    isAdmin: boolean;\r\n}\r\n\r\nexport function GroupManagementDialog({ group, currentUser, isAdmin }: GroupManagementDialogProps) {\r\n    const router = useRouter();\r\n    const [open, setOpen] = useState(false);\r\n    const [isLoading, setIsLoading] = useState(false);\r\n\r\n    // Form State\r\n    const [name, setName] = useState(group.name);\r\n    const [description, setDescription] = useState(group.description);\r\n\r\n    // Cover Upload State\r\n    const [coverDialogOpen, setCoverDialogOpen] = useState(false);\r\n\r\n    const handleUpdate = async () => {\r\n        setIsLoading(true);\r\n        try {\r\n            await updateGroupDetails(group.id, { name, description });\r\n            toast.success(\"Group updated successfully\");\r\n            setOpen(false);\r\n            router.refresh(); // Refresh to show new details\r\n        } catch (error: any) {\r\n            toast.error(error.message || \"Failed to update group\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleDelete = async () => {\r\n        setIsLoading(true);\r\n        try {\r\n            await softDeleteGroup(group.id);\r\n            toast.success(\"Group deleted. It will be permanently removed in 30 days.\");\r\n            setOpen(false);\r\n            router.push('/groups'); // Redirect to groups list\r\n        } catch (error: any) {\r\n            toast.error(error.message || \"Failed to delete group\");\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const isFounder = group.founderId === currentUser.id;\r\n\r\n    // Only admins/founder can see this\r\n    if (!isAdmin && !isFounder) return null;\r\n\r\n    return (\r\n        <>\r\n            <Button variant=\"ghost\" size=\"icon\" onClick={() => setOpen(true)} title=\"Group Settings\">\r\n                <Settings className=\"h-5 w-5\" />\r\n            </Button>\r\n\r\n            <Dialog open={open} onOpenChange={setOpen}>\r\n                <DialogContent className=\"sm:max-w-[600px]\">\r\n                    <DialogHeader>\r\n                        <DialogTitle>Manage Group</DialogTitle>\r\n                        <DialogDescription>\r\n                            Update group details or manage settings.\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <Tabs defaultValue=\"general\" className=\"w-full\">\r\n                        <TabsList className=\"grid w-full grid-cols-2\">\r\n                            <TabsTrigger value=\"general\">General</TabsTrigger>\r\n                            <TabsTrigger value=\"danger\">Danger Zone</TabsTrigger>\r\n                        </TabsList>\r\n\r\n                        <TabsContent value=\"general\" className=\"space-y-4 py-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"name\">Group Name</Label>\r\n                                <Input\r\n                                    id=\"name\"\r\n                                    value={name}\r\n                                    onChange={(e) => setName(e.target.value)}\r\n                                    placeholder=\"Group Name\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"description\">Description</Label>\r\n                                <Textarea\r\n                                    id=\"description\"\r\n                                    value={description}\r\n                                    onChange={(e) => setDescription(e.target.value)}\r\n                                    placeholder=\"Describe your group...\"\r\n                                    className=\"min-h-[100px]\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"pt-4 border-t\">\r\n                                <Label className=\"mb-2 block\">Cover Photo/Video</Label>\r\n                                <div className=\"flex items-center gap-4\">\r\n                                    <div className=\"relative w-32 h-20 bg-muted rounded overflow-hidden\">\r\n                                        {group.coverUrl ? (\r\n                                            <img src={group.coverUrl} className=\"w-full h-full object-cover\" />\r\n                                        ) : (\r\n                                            <div className=\"flex items-center justify-center w-full h-full text-muted-foreground\">\r\n                                                <ImageIcon className=\"w-6 h-6\" />\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                    <Button variant=\"outline\" onClick={() => setCoverDialogOpen(true)}>\r\n                                        Change Cover\r\n                                    </Button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"flex justify-end pt-4\">\r\n                                <Button onClick={handleUpdate} disabled={isLoading}>\r\n                                    {isLoading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                                    Save Changes\r\n                                </Button>\r\n                            </div>\r\n                        </TabsContent>\r\n\r\n                        <TabsContent value=\"danger\" className=\"space-y-4 py-4\">\r\n                            <div className=\"rounded-md border border-destructive/50 bg-destructive/10 p-4\">\r\n                                <div className=\"flex items-start gap-4\">\r\n                                    <AlertTriangle className=\"h-5 w-5 text-destructive mt-0.5\" />\r\n                                    <div>\r\n                                        <h4 className=\"font-semibold text-destructive\">Delete Group</h4>\r\n                                        <p className=\"text-sm text-destructive/90 mt-1\">\r\n                                            This action will hide the group immediately. You will have 30 days to restore it before it is permanently deleted along with all posts and members.\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {isFounder ? (\r\n                                    <div className=\"mt-4 flex justify-end\">\r\n                                        <Button\r\n                                            variant=\"destructive\"\r\n                                            onClick={handleDelete}\r\n                                            disabled={isLoading}\r\n                                        >\r\n                                            {isLoading ? \"Deleting...\" : \"Delete Group\"}\r\n                                        </Button>\r\n                                    </div>\r\n                                ) : (\r\n                                    <p className=\"text-sm text-muted-foreground mt-4 italic\">\r\n                                        Only the group founder can delete this group.\r\n                                    </p>\r\n                                )}\r\n                            </div>\r\n                        </TabsContent>\r\n                    </Tabs>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            <CoverUploadDialog\r\n                open={coverDialogOpen}\r\n                onOpenChange={setCoverDialogOpen}\r\n                type=\"group\"\r\n                id={group.id}\r\n                currentCoverUrl={group.coverUrl}\r\n                userId={currentUser.id}\r\n            />\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\group-post-creator.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3332,3335],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3332,3335],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":151,"column":45,"nodeType":"JSXOpeningElement","endLine":155,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { createGroupPost } from \"@/app/actions/groups\"\r\nimport { toast } from \"sonner\"\r\nimport { Image as ImageIcon, Send, Loader2, X, Mic, MicOff, Video } from \"lucide-react\"\r\nimport { storage } from \"@/lib/firebase\"\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\"\r\nimport { useSpeechRecognition } from \"@/hooks/use-speech-recognition\"\r\nimport { useMagicAI } from \"@/hooks/use-magic-ai\"\r\nimport { MagicAIButton } from \"@/components/magic-ai/magic-ai-button\"\r\nimport { AIPreviewPanel } from \"@/components/magic-ai/ai-preview-panel\"\r\n\r\ninterface GroupPostCreatorProps {\r\n    groupId: string;\r\n    user: { displayName?: string | null; imageUrl?: string | null };\r\n    onClose?: () => void;\r\n}\r\n\r\nexport function GroupPostCreator({ groupId, user, onClose }: GroupPostCreatorProps) {\r\n    const router = useRouter();\r\n    const [content, setContent] = useState(\"\");\r\n    const [isPosting, setIsPosting] = useState(false);\r\n    const [mediaUrls, setMediaUrls] = useState<string[]>([]);\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    // Magic AI Integration\r\n    const magicAI = useMagicAI({ context: { type: 'group', name: groupId } });\r\n\r\n    const { isListening, startListening, stopListening, isSupported: isSpeechSupported } = useSpeechRecognition({\r\n        onResult: (result) => setContent(prev => prev ? prev + \" \" + result : result)\r\n    });\r\n\r\n    // Magic AI handlers\r\n    const handleOpenMagicAI = () => {\r\n        magicAI.openMagic(content);\r\n    };\r\n\r\n    const handleAcceptMagic = () => {\r\n        const enhancedContent = magicAI.acceptEnhanced();\r\n        if (enhancedContent) {\r\n            setContent(enhancedContent);\r\n        }\r\n    };\r\n\r\n    const handleRevertMagic = () => {\r\n        const originalContent = magicAI.revertToOriginal();\r\n        setContent(originalContent);\r\n    };\r\n\r\n    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files && e.target.files[0]) {\r\n            const file = e.target.files[0];\r\n            setIsUploading(true);\r\n            try {\r\n                // Determine path based on file type or context\r\n                // For simplified group uploads: groups/{groupId}/posts/{timestamp}-{filename}\r\n                const timestamp = Date.now();\r\n                const filename = `${timestamp}-${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;\r\n\r\n                // IMPORTANT: Ensure this path is writable by the user in Storage Rules\r\n                // Usually rules allow write if request.auth != null\r\n                const storageRef = ref(storage, `groups/${groupId}/posts/${filename}`);\r\n\r\n                // Direct upload\r\n                const snapshot = await uploadBytes(storageRef, file);\r\n                const url = await getDownloadURL(snapshot.ref);\r\n\r\n                setMediaUrls(prev => [...prev, url]);\r\n                toast.success(\"File uploaded\");\r\n            } catch (error: any) {\r\n                console.error(\"Error uploading file:\", error);\r\n                toast.error(`Failed to upload: ${error.message}`);\r\n            } finally {\r\n                setIsUploading(false);\r\n                if (fileInputRef.current) fileInputRef.current.value = \"\";\r\n            }\r\n        }\r\n    };\r\n\r\n    const removeMedia = (index: number) => {\r\n        setMediaUrls(prev => prev.filter((_, i) => i !== index));\r\n    };\r\n\r\n    async function handlePost() {\r\n        if (!content.trim() && mediaUrls.length === 0) return;\r\n\r\n        setIsPosting(true);\r\n        try {\r\n            await createGroupPost(groupId, content, mediaUrls);\r\n            setContent(\"\");\r\n            setMediaUrls([]);\r\n            toast.success(\"Posted to group!\");\r\n            if (onClose) onClose();\r\n            router.refresh();\r\n        } catch (error) {\r\n            console.error(error);\r\n            toast.error(\"Failed to post\");\r\n        } finally {\r\n            setIsPosting(false);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Card className=\"mb-6 border-none glass-card rounded-lg\">\r\n            <CardContent className=\"p-4\">\r\n                <div className=\"flex gap-3\">\r\n                    <Avatar className=\"w-10 h-10 border border-gray-200\">\r\n                        <AvatarImage src={user.imageUrl || \"\"} />\r\n                        <AvatarFallback>{user.displayName?.[0]}</AvatarFallback>\r\n                    </Avatar>\r\n                    <div className=\"flex-1 space-y-4\">\r\n                        <div className=\"relative\">\r\n                            <Textarea\r\n                                placeholder={isListening ? \"Listening...\" : \"Write something to the group...\"}\r\n                                className=\"min-h-[80px] bg-muted/50 border-0 focus-visible:ring-1 rounded-xl resize-none text-[15px] pr-12\"\r\n                                value={content}\r\n                                onChange={(e) => setContent(e.target.value)}\r\n                                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && handlePost()}\r\n                            />\r\n                            {isSpeechSupported && (\r\n                                <div className=\"absolute right-3 top-3\">\r\n                                    <Button\r\n                                        size=\"icon\"\r\n                                        variant=\"ghost\"\r\n                                        onClick={isListening ? stopListening : startListening}\r\n                                        className={isListening ? \"text-red-500 hover:bg-red-50 animate-pulse\" : \"text-gray-400 hover:text-gray-600\"}\r\n                                    >\r\n                                        {isListening ? <MicOff className=\"w-5 h-5\" /> : <Mic className=\"w-5 h-5\" />}\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Media Previews */}\r\n                        {mediaUrls.length > 0 && (\r\n                            <div className=\"flex gap-2 overflow-x-auto py-2\">\r\n                                {mediaUrls.map((url, index) => (\r\n                                    <div key={index} className=\"relative group flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border border-border\">\r\n                                        {url.includes('.mp4') || url.includes('.webm') ? (\r\n                                            <div className=\"w-full h-full bg-black flex items-center justify-center\">\r\n                                                <Video className=\"w-8 h-8 text-white/70\" />\r\n                                            </div>\r\n                                        ) : (\r\n                                            <img\r\n                                                src={url}\r\n                                                alt=\"Uploaded content\"\r\n                                                className=\"w-full h-full object-cover\"\r\n                                            />\r\n                                        )}\r\n                                        <button\r\n                                            onClick={() => removeMedia(index)}\r\n                                            className=\"absolute top-1 right-1 bg-black/50 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                                        >\r\n                                            <X className=\"w-3 h-3\" />\r\n                                        </button>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"flex justify-between items-center pt-2 border-t border-border\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <input\r\n                                    type=\"file\"\r\n                                    ref={fileInputRef}\r\n                                    className=\"hidden\"\r\n                                    accept=\"image/*,video/*\"\r\n                                    onChange={handleFileSelect}\r\n                                    disabled={isUploading}\r\n                                />\r\n                                <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    className=\"text-muted-foreground hover:text-primary gap-2\"\r\n                                    onClick={() => fileInputRef.current?.click()}\r\n                                    disabled={isUploading}\r\n                                >\r\n                                    {isUploading ? (\r\n                                        <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                                    ) : (\r\n                                        <ImageIcon className=\"w-5 h-5\" />\r\n                                    )}\r\n                                    <span className=\"hidden sm:inline\">Photo/Video</span>\r\n                                </Button>\r\n                                <MagicAIButton\r\n                                    onClick={handleOpenMagicAI}\r\n                                    disabled={!content.trim()}\r\n                                    isGenerating={magicAI.isGenerating}\r\n                                />\r\n                            </div>\r\n                            <Button\r\n                                size=\"sm\"\r\n                                onClick={handlePost}\r\n                                disabled={(!content.trim() && mediaUrls.length === 0) || isPosting || isUploading}\r\n                                className=\"bg-primary text-primary-foreground font-semibold px-6\"\r\n                            >\r\n                                {isPosting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4 mr-2\" />}\r\n                                Post\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Magic AI Preview Panel */}\r\n                <AIPreviewPanel\r\n                    isOpen={magicAI.isPreviewOpen}\r\n                    onClose={magicAI.closePreview}\r\n                    originalContent={magicAI.originalContent}\r\n                    enhancedContent={magicAI.enhancedContent}\r\n                    selectedTone={magicAI.selectedTone}\r\n                    isGenerating={magicAI.isGenerating}\r\n                    onSelectTone={magicAI.generatePreview}\r\n                    onAccept={handleAcceptMagic}\r\n                    onRevert={handleRevertMagic}\r\n                />\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\groups-view.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\groups\\join-group-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'memberCount' is defined but never used.","line":15,"column":71,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":82}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { joinGroup, leaveGroup } from \"@/app/actions/groups\";\r\nimport { toast } from \"sonner\";\r\nimport { Loader2 } from \"lucide-react\";\r\n\r\ninterface JoinGroupButtonProps {\r\n    groupId: string;\r\n    isMember: boolean;\r\n    memberCount?: number;\r\n}\r\n\r\nexport function JoinGroupButton({ groupId, isMember: initialIsMember, memberCount }: JoinGroupButtonProps) {\r\n    const [isMember, setIsMember] = useState(initialIsMember);\r\n    const [isLoading, setIsLoading] = useState(false);\r\n\r\n    async function handleToggle() {\r\n        setIsLoading(true);\r\n        try {\r\n            if (isMember) {\r\n                await leaveGroup(groupId);\r\n                setIsMember(false);\r\n                toast.success(\"Left group\");\r\n            } else {\r\n                await joinGroup(groupId);\r\n                setIsMember(true);\r\n                toast.success(\"Joined group!\");\r\n            }\r\n        } catch (error) {\r\n            console.error(error);\r\n            toast.error(\"Action failed\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Button\r\n            variant={isMember ? \"outline\" : \"default\"}\r\n            onClick={handleToggle}\r\n            disabled={isLoading}\r\n            className=\"min-w-[100px]\"\r\n        >\r\n            {isLoading && <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />}\r\n            {isMember ? \"Leave\" : \"Join Group\"}\r\n        </Button>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\landing-page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Button"},"fix":{"range":[148,155],"text":""},"desc":"Remove unused variable \"Button\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Image' is defined but never used.","line":9,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":13,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Image"},"fix":{"range":[354,384],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\n// Updated: 2026-01-03 19:10 - Audio toggle added\r\nimport { useState, useRef } from \"react\"\r\nimport Link from \"next/link\"\r\nimport { Button, buttonVariants } from \"@/components/ui/button\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { Heart, Shield, Users, Globe, CheckCircle, Sparkles, Volume2, VolumeX, MessageCircle } from \"lucide-react\"\r\nimport Image from \"next/image\"\r\n\r\nexport function LandingPage() {\r\n    const [isMuted, setIsMuted] = useState(true);\r\n    const videoRef = useRef<HTMLVideoElement>(null);\r\n\r\n    const toggleAudio = () => {\r\n        if (videoRef.current) {\r\n            videoRef.current.muted = !isMuted;\r\n            setIsMuted(!isMuted);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-white\">\r\n            {/* Navigation */}\r\n            <nav className=\"border-b border-gray-200 bg-white sticky top-0 z-[100]\">\r\n                <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\r\n                    <div className=\"flex items-center justify-between h-16\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <Heart className=\"w-7 h-7 text-blue-600\" fill=\"currentColor\" />\r\n                            <div>\r\n                                <div className=\"font-bold text-2xl text-gray-900 tracking-tight\">Famio</div>\r\n                                <div className=\"text-xs text-gray-600 font-medium -mt-1\">by ChanceTEK</div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <Link href=\"/login\" className={cn(buttonVariants({ variant: \"ghost\" }), \"text-gray-700 hover:text-gray-900 hover:bg-gray-100 font-medium\")}>\r\n                                Sign In\r\n                            </Link>\r\n                            <Link href=\"/signup\" className={cn(buttonVariants(), \"bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-sm\")}>\r\n                                Create Account\r\n                            </Link>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </nav>\r\n\r\n            {/* Hero Section */}\r\n            <section className=\"relative overflow-hidden min-h-[90vh] flex items-center bg-black\">\r\n                {/* Background Video */}\r\n                <video\r\n                    ref={videoRef}\r\n                    autoPlay\r\n                    loop\r\n                    muted={isMuted} // React controls this property\r\n                    playsInline\r\n                    className=\"absolute inset-0 w-full h-full object-cover opacity-60 pointer-events-none\"\r\n                >\r\n                    <source src=\"/Create_a_highquality_1080p_202601031842.mp4\" type=\"video/mp4\" />\r\n                </video>\r\n                <div className=\"absolute inset-0 bg-gradient-to-b from-black/70 via-black/50 to-black/80 pointer-events-none\" />\r\n\r\n                {/* Audio Control */}\r\n                <button\r\n                    onClick={toggleAudio}\r\n                    className=\"absolute bottom-8 right-8 z-30 p-3 rounded-full bg-black/40 hover:bg-black/60 text-white/80 hover:text-white backdrop-blur-sm border border-white/20 transition-all duration-200\"\r\n                    title={isMuted ? \"Unmute Video\" : \"Mute Video\"}\r\n                >\r\n                    {isMuted ? <VolumeX className=\"w-6 h-6\" /> : <Volume2 className=\"w-6 h-6\" />}\r\n                </button>\r\n\r\n                <div className=\"relative z-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 md:py-32 w-full\">\r\n                    <div className=\"text-center\">\r\n                        <div className=\"mb-4 inline-flex items-center gap-2 text-blue-400\">\r\n                            <Heart className=\"w-8 h-8\" fill=\"currentColor\" />\r\n                            <span className=\"text-sm font-semibold uppercase tracking-wider\">WeAreFamily Presents</span>\r\n                        </div>\r\n                        <h1 className=\"text-6xl md:text-7xl lg:text-8xl font-extrabold text-white tracking-tight mb-4 drop-shadow-lg\">\r\n                            Famio\r\n                        </h1>\r\n                        <p className=\"text-2xl md:text-3xl font-semibold text-blue-100 mb-6 drop-shadow-md\">\r\n                            Connect with Your Family and Friends.<br />\r\n                            We Are One Family\r\n                        </p>\r\n\r\n                        <div className=\"inline-flex items-center gap-2 px-4 py-2 bg-white/10 backdrop-blur-md border border-white/20 rounded-full mb-8\">\r\n                            <Sparkles className=\"w-5 h-5 text-blue-300\" />\r\n                            <span className=\"text-sm font-semibold text-blue-50\">Powered by OpenAI, Claude & Perplexity</span>\r\n                        </div>\r\n\r\n                        <p className=\"max-w-3xl mx-auto text-xl md:text-2xl text-gray-200 mb-10 leading-relaxed font-normal shadow-black drop-shadow-sm\">\r\n                            A private, secure platform designed exclusively for families to share moments,\r\n                            plan events, and stay connected with the people who matter most.\r\n                        </p>\r\n                        <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center\">\r\n                            <Link href=\"/signup\" className={cn(buttonVariants({ size: \"lg\" }), \"h-14 px-10 text-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-lg shadow-blue-900/50 border-0\")}>\r\n                                Join Famio\r\n                            </Link>\r\n                            <Link href=\"/learn-more\" className={cn(buttonVariants({ size: \"lg\", variant: \"outline\" }), \"h-14 px-10 text-lg border-2 border-white/30 bg-white/10 text-white hover:bg-white/20 backdrop-blur-sm font-semibold\")}>\r\n                                Learn More\r\n                            </Link>\r\n                        </div>\r\n\r\n                        {/* Trust Badge */}\r\n                        <div className=\"mt-12 flex items-center justify-center gap-2 text-sm text-gray-300\">\r\n                            <Shield className=\"w-5 h-5 text-blue-400\" />\r\n                            <span className=\"font-medium\">Trusted by thousands of families worldwide</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </section>\r\n\r\n            {/* Features Section */}\r\n            <section className=\"py-20 bg-white\">\r\n                <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\r\n                    <div className=\"text-center mb-16\">\r\n                        <h2 className=\"text-4xl font-bold text-gray-900 mb-4\">Why Choose Famio?</h2>\r\n                        <p className=\"text-xl text-gray-600 max-w-2xl mx-auto\">\r\n                            Everything your family needs to stay connected, secure, and organized.\r\n                        </p>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-8\">\r\n                        <FeatureCard\r\n                            icon={<Shield className=\"w-10 h-10 text-blue-600\" />}\r\n                            title=\"Private & Secure\"\r\n                            description=\"Enterprise-grade security with end-to-end encryption. No ads, no tracking, no third-party access.\"\r\n                        />\r\n                        <FeatureCard\r\n                            icon={<Users className=\"w-10 h-10 text-blue-600\" />}\r\n                            title=\"Built for Families\"\r\n                            description=\"Share photos, plan events, coordinate schedules, and create lasting memories together.\"\r\n                        />\r\n                        <FeatureCard\r\n                            icon={<Sparkles className=\"w-10 h-10 text-blue-600\" />}\r\n                            title=\"AI Research Assistant\"\r\n                            description=\"ChatGPT-style interface for everyone‚ÄîExecutives, Engineers, Architects, Medical Professionals, Students, Parents, and Kids. Powered by OpenAI, Claude, and Gemini with voice input and file uploads.\"\r\n                        />\r\n                        <FeatureCard\r\n                            icon={<Globe className=\"w-10 h-10 text-blue-600\" />}\r\n                            title=\"Live Streaming\"\r\n                            description=\"Broadcast real-time video to share announcements, celebrations, or just hang out with family.\"\r\n                        />\r\n                        <FeatureCard\r\n                            icon={<MessageCircle className=\"w-10 h-10 text-blue-600\" />}\r\n                            title=\"Always Connected\"\r\n                            description=\"Real-time messaging, event notifications, and instant photo sharing from anywhere in the world.\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </section>\r\n\r\n            {/* Benefits Section */}\r\n            <section className=\"py-20 bg-gray-50 border-y border-gray-200\">\r\n                <div className=\"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8\">\r\n                    <div className=\"text-center mb-12\">\r\n                        <h2 className=\"text-3xl font-bold text-gray-900 mb-4\">What You'll Get</h2>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-4\">\r\n                        <BenefitItem text=\"Unlimited photo and video sharing\" />\r\n                        <BenefitItem text=\"Private family messaging and group chats\" />\r\n                        <BenefitItem text=\"Shared calendar and event planning\" />\r\n                        <BenefitItem text=\"My Life updates to keep everyone close\" />\r\n                        <BenefitItem text=\"Secure cloud storage for family memories\" />\r\n                        <BenefitItem text=\"Mobile and desktop access\" />\r\n                    </div>\r\n                </div>\r\n            </section>\r\n\r\n            {/* CTA Section */}\r\n            <section className=\"py-24 bg-blue-600\">\r\n                <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center\">\r\n                    <h2 className=\"text-4xl md:text-5xl font-bold text-white mb-6\">\r\n                        Ready to bring your family closer?\r\n                    </h2>\r\n                    <p className=\"text-xl text-blue-100 mb-10 max-w-2xl mx-auto\">\r\n                        Join thousands of families who are already sharing, connecting, and creating memories together.\r\n                    </p>\r\n                    <Link href=\"/signup\" className={cn(buttonVariants({ size: \"lg\" }), \"h-16 px-12 text-lg bg-white text-blue-600 hover:bg-gray-100 font-bold shadow-lg\")}>\r\n                        Get Started Free\r\n                    </Link>\r\n                </div>\r\n            </section>\r\n\r\n            {/* Footer */}\r\n            <footer className=\"bg-white border-t border-gray-200 py-12\">\r\n                <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\r\n                    <div className=\"flex flex-col items-center justify-center space-y-6\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Heart className=\"w-6 h-6 text-blue-600\" fill=\"currentColor\" />\r\n                            <div>\r\n                                <span className=\"font-bold text-gray-900 text-lg\">Famio</span>\r\n                                <span className=\"text-gray-500 text-sm ml-2\">by ChanceTEK</span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Privacy Link */}\r\n                        <div className=\"flex gap-6\">\r\n                            <Link href=\"/privacy\" className=\"text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors\">\r\n                                Privacy Policy\r\n                            </Link>\r\n                        </div>\r\n\r\n                        <div className=\"text-center space-y-2\">\r\n                            <p className=\"text-sm text-gray-500 font-medium\">\r\n                                \"Built with privacy and security at the core.\"\r\n                            </p>\r\n                            <p className=\"text-gray-600 text-sm\">\r\n                                ¬© 2026 Famio by ChanceTEK. All Rights Reserved.\r\n                            </p>\r\n                            <p className=\"text-gray-500 text-xs\">\r\n                                Developed by Chancellor Minus | ChanceTEK LLC | iChanceTEK\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </footer>\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction FeatureCard({ icon, title, description }: { icon: React.ReactNode, title: string, description: string }) {\r\n    return (\r\n        <div className=\"text-center\">\r\n            <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 mb-6\">\r\n                {icon}\r\n            </div>\r\n            <h3 className=\"text-xl font-bold text-gray-900 mb-3\">{title}</h3>\r\n            <p className=\"text-gray-600 leading-relaxed\">{description}</p>\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction BenefitItem({ text }: { text: string }) {\r\n    return (\r\n        <div className=\"flex items-center gap-3 bg-white px-6 py-4 rounded-lg border border-gray-200\">\r\n            <CheckCircle className=\"w-6 h-6 text-blue-600 flex-shrink-0\" />\r\n            <span className=\"text-gray-900 font-medium\">{text}</span>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\landing\\landing-chat-widget.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":7,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[233,236],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronUp' is defined but never used.","line":7,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":77,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronUp"},"fix":{"range":[280,291],"text":""},"desc":"Remove unused variable \"ChevronUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":51,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":66,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":66,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Bot, Send, X, MessageCircle, Sparkles, User, ChevronDown, ChevronUp } from \"lucide-react\";\r\nimport { chatWithLandingAgent } from \"@/app/actions/landing-rag\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Loader2 } from \"lucide-react\";\r\n\r\ntype Message = {\r\n    role: 'user' | 'assistant';\r\n    content: string;\r\n};\r\n\r\nexport function LandingChatWidget() {\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const [messages, setMessages] = useState<Message[]>([\r\n        { role: 'assistant', content: \"Hi! I'm the Famio Assistant. Ask me anything about our features, security, or how Famio fits your lifestyle!\" }\r\n    ]);\r\n    const [inputValue, setInputValue] = useState(\"\");\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const scrollRef = useRef<HTMLDivElement>(null);\r\n\r\n    useEffect(() => {\r\n        if (isOpen && scrollRef.current) {\r\n            scrollRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n        }\r\n    }, [messages, isOpen]);\r\n\r\n    const handleSendMessage = async (e?: React.FormEvent) => {\r\n        e?.preventDefault();\r\n        const text = inputValue.trim();\r\n        if (!text || isLoading) return;\r\n\r\n        // Dev Command: Seed Knowledge Base\r\n        if (text === '/seed') {\r\n            setMessages(prev => [...prev, { role: 'user', content: text }]);\r\n            setInputValue(\"\");\r\n            setIsLoading(true);\r\n            try {\r\n                // Dynamic import to avoid server-action bundling issues if any\r\n                const { seedKnowledgeBase } = await import(\"@/app/actions/landing-rag\");\r\n                const res = await seedKnowledgeBase();\r\n                if (res.success) {\r\n                    setMessages(prev => [...prev, { role: 'assistant', content: `‚úÖ Knowledge Base Seeded with ${res.count} documents.` }]);\r\n                } else {\r\n                    setMessages(prev => [...prev, { role: 'assistant', content: `‚ùå Error seeding: ${res.error}` }]);\r\n                }\r\n            } catch (err) {\r\n                setMessages(prev => [...prev, { role: 'assistant', content: \"Failed to run seed command.\" }]);\r\n            } finally {\r\n                setIsLoading(false);\r\n            }\r\n            return;\r\n        }\r\n\r\n        setMessages(prev => [...prev, { role: 'user', content: text }]);\r\n        setInputValue(\"\");\r\n        setIsLoading(true);\r\n\r\n        try {\r\n            const response = await chatWithLandingAgent(text, 'gpt-4o');\r\n            setMessages(prev => [...prev, { role: 'assistant', content: response || \"Error getting response.\" }]);\r\n        } catch (err) {\r\n            setMessages(prev => [...prev, { role: 'assistant', content: \"Sorry, something went wrong.\" }]);\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    if (!isOpen) {\r\n        return (\r\n            <Button\r\n                onClick={() => setIsOpen(true)}\r\n                className=\"fixed bottom-6 right-6 h-14 w-14 rounded-full shadow-lg bg-blue-600 hover:bg-blue-700 text-white z-50 animate-bounce-slow\"\r\n            >\r\n                <MessageCircle className=\"w-8 h-8\" />\r\n            </Button>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <Card className=\"fixed bottom-6 right-6 w-[350px] h-[500px] flex flex-col shadow-2xl border-blue-100 z-50 overflow-hidden animate-in slide-in-from-bottom-10 fade-in duration-300\">\r\n            {/* Header */}\r\n            <div className=\"p-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white flex justify-between items-center shrink-0\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <div className=\"bg-white/20 p-1.5 rounded-full\">\r\n                        <Bot className=\"w-5 h-5\" />\r\n                    </div>\r\n                    <div>\r\n                        <h3 className=\"font-bold text-sm\">Famio Assistant</h3>\r\n                        <p className=\"text-[10px] text-blue-100 flex items-center gap-1\">\r\n                            <Sparkles className=\"w-3 h-3\" /> Powered by AI\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n                <Button variant=\"ghost\" size=\"icon\" onClick={() => setIsOpen(false)} className=\"text-white hover:bg-white/20 rounded-full h-8 w-8\">\r\n                    <ChevronDown className=\"w-5 h-5\" />\r\n                </Button>\r\n            </div>\r\n\r\n            {/* Messages */}\r\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50\">\r\n                {messages.map((msg, idx) => (\r\n                    <div\r\n                        key={idx}\r\n                        className={cn(\r\n                            \"flex gap-2 max-w-[85%]\",\r\n                            msg.role === 'user' ? \"ml-auto flex-row-reverse\" : \"\"\r\n                        )}\r\n                    >\r\n                        <div className={cn(\r\n                            \"w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-xs\",\r\n                            msg.role === 'assistant' ? \"bg-blue-100 text-blue-600\" : \"bg-gray-200 text-gray-600\"\r\n                        )}>\r\n                            {msg.role === 'assistant' ? <Bot className=\"w-4 h-4\" /> : <User className=\"w-4 h-4\" />}\r\n                        </div>\r\n                        <div className={cn(\r\n                            \"p-3 rounded-2xl text-sm shadow-sm\",\r\n                            msg.role === 'user'\r\n                                ? \"bg-blue-600 text-white rounded-tr-none\"\r\n                                : \"bg-white border border-gray-100 text-gray-700 rounded-tl-none\"\r\n                        )}>\r\n                            {msg.content}\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n                {isLoading && (\r\n                    <div className=\"flex gap-2\">\r\n                        <div className=\"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center shrink-0\">\r\n                            <Bot className=\"w-4 h-4 text-blue-600\" />\r\n                        </div>\r\n                        <div className=\"bg-white border border-gray-100 p-3 rounded-2xl rounded-tl-none\">\r\n                            <Loader2 className=\"w-4 h-4 animate-spin text-gray-400\" />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n                <div ref={scrollRef} />\r\n            </div>\r\n\r\n            {/* Input */}\r\n            <div className=\"p-3 border-t border-gray-100 bg-white\">\r\n                <form onSubmit={handleSendMessage} className=\"relative flex items-center\">\r\n                    <Input\r\n                        value={inputValue}\r\n                        onChange={(e) => setInputValue(e.target.value)}\r\n                        placeholder=\"Ask about features...\"\r\n                        className=\"pr-10 rounded-full py-5 bg-gray-50 border-gray-200 focus-visible:ring-blue-500\"\r\n                        disabled={isLoading}\r\n                    />\r\n                    <Button\r\n                        type=\"submit\"\r\n                        size=\"icon\"\r\n                        disabled={!inputValue.trim() || isLoading}\r\n                        className=\"absolute right-1 w-8 h-8 rounded-full bg-blue-600 hover:bg-blue-700 text-white\"\r\n                    >\r\n                        <Send className=\"w-4 h-4\" />\r\n                    </Button>\r\n                </form>\r\n            </div>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\language-context.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chanc\\Documents\\WeAreFamily\\components\\language-context.tsx:39:13\n  37 |         if (profileLang && Object.keys(dictionaries).includes(profileLang)) {\n  38 |             // eslint-disable-next-line react-hooks/set-state-in-effect\n> 39 |             setLanguageState((prev) => {\n     |             ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  40 |                 if (prev !== profileLang) {\n  41 |                     return profileLang as Language;\n  42 |                 }","line":39,"column":13,"nodeType":null,"endLine":39,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\activity-tracker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\bottom-nav.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profile' is assigned a value but never used.","line":19,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'label' is defined but never used.","line":51,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":50}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\bottom-nav.tsx:30:9\n  28 |     useEffect(() => {\n  29 |         // eslint-disable-next-line react-hooks/set-state-in-effect\n> 30 |         setOpen(false);\n     |         ^^^^^^^ Avoid calling setState() directly within an effect\n  31 |     }, [pathname]);\n  32 |\n  33 |     // React to scroll direction","line":30,"column":9,"nodeType":null,"endLine":30,"endColumn":16,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\bottom-nav.tsx:37:13\n  35 |         if (scrollDirection === 'down') {\n  36 |             // eslint-disable-next-line react-hooks/set-state-in-effect\n> 37 |             setIsVisible((prev) => (prev ? false : prev));\n     |             ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  38 |         } else if (scrollDirection === 'up') {\n  39 |              \n  40 |             setIsVisible((prev) => (!prev ? true : prev));","line":37,"column":13,"nodeType":null,"endLine":37,"endColumn":25,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { usePathname, useRouter } from \"next/navigation\";\r\nimport { Home, Users, Bell, User, Menu, ChevronDown, ChevronUp } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { Sheet, SheetContent, SheetTrigger, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\r\nimport { MobileSidebar } from \"./mobile-sidebar\";\r\nimport { VisuallyHidden } from \"@radix-ui/react-visually-hidden\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useScrollDirection } from \"@/hooks/use-scroll-direction\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\nexport function BottomNav() {\r\n    const { t } = useLanguage();\r\n    const pathname = usePathname();\r\n    const router = useRouter();\r\n    const { profile } = useAuth();\r\n    const [open, setOpen] = useState(false);\r\n    const scrollDirection = useScrollDirection();\r\n\r\n    // Auto-hide logic: default to visible, hide on scroll down, show on scroll up\r\n    // Also allow manual collapse preference?\r\n    const [isManuallyCollapsed, setIsManuallyCollapsed] = useState(false);\r\n    const [isVisible, setIsVisible] = useState(true);\r\n\r\n    useEffect(() => {\r\n        // eslint-disable-next-line react-hooks/set-state-in-effect\r\n        setOpen(false);\r\n    }, [pathname]);\r\n\r\n    // React to scroll direction\r\n    useEffect(() => {\r\n        if (scrollDirection === 'down') {\r\n            // eslint-disable-next-line react-hooks/set-state-in-effect\r\n            setIsVisible((prev) => (prev ? false : prev));\r\n        } else if (scrollDirection === 'up') {\r\n             \r\n            setIsVisible((prev) => (!prev ? true : prev));\r\n        }\r\n    }, [scrollDirection]);\r\n\r\n    const links = [\r\n        { href: \"/\", label: t('nav.home'), icon: Home },\r\n        { href: \"/family\", label: t('nav.family'), icon: Users },\r\n        { href: \"/notifications\", label: t(\"nav.notifications\"), icon: Bell },\r\n        { href: \"/profile\", label: t(\"nav.profile\"), icon: User },\r\n    ];\r\n\r\n    const handleNavigation = (href: string, label: string) => {\r\n        try {\r\n            router.push(href);\r\n            // Fallback check\r\n            setTimeout(() => {\r\n                if (pathname !== href) window.location.assign(href);\r\n            }, 300);\r\n        } catch {\r\n            window.location.assign(href);\r\n        }\r\n    };\r\n\r\n    const shouldShow = isVisible && !isManuallyCollapsed;\r\n\r\n    return (\r\n        <>\r\n            {/* Manual Collapse Toggle (Visible when collapsed or hidden) */}\r\n            <div className={cn(\r\n                \"md:hidden fixed bottom-6 right-4 z-[101] transition-all duration-300\",\r\n                shouldShow ? \"opacity-0 translate-y-10 pointer-events-none\" : \"opacity-100 translate-y-0\"\r\n            )}>\r\n                <Button\r\n                    onClick={() => {\r\n                        setIsManuallyCollapsed(false);\r\n                        setIsVisible(true);\r\n                    }}\r\n                    size=\"icon\"\r\n                    className=\"h-10 w-10 rounded-full bg-primary/20 backdrop-blur-md border border-primary/20 shadow-lg text-primary hover:bg-primary/30\"\r\n                >\r\n                    <ChevronUp className=\"h-6 w-6\" />\r\n                </Button>\r\n            </div>\r\n\r\n            <div className={cn(\r\n                \"md:hidden fixed bottom-6 left-4 right-4 z-[100] pb-safe transition-all duration-500 ease-in-out transform\",\r\n                shouldShow ? \"translate-y-0 opacity-100\" : \"translate-y-[150%] opacity-0\"\r\n            )}>\r\n                {/* Floating Glass Island */}\r\n                <div className=\"relative flex justify-around items-center px-2 py-3 bg-[rgba(11,15,20,0.85)] dark:bg-[rgba(11,15,20,0.85)] backdrop-blur-xl rounded-[24px] border border-white/10 shadow-[0_8px_32px_rgba(0,0,0,0.2)]\">\r\n\r\n                    {/* Collapse Button (Absolute positioned on the bar) */}\r\n                    <button\r\n                        onClick={() => setIsManuallyCollapsed(true)}\r\n                        className=\"absolute -top-3 right-4 h-6 w-6 bg-background/50 backdrop-blur-md rounded-full border border-white/10 flex items-center justify-center text-muted-foreground hover:text-white shadow-sm\"\r\n                    >\r\n                        <ChevronDown className=\"h-3 w-3\" />\r\n                    </button>\r\n\r\n                    {links.map((link) => {\r\n                        const isActive = pathname === link.href;\r\n                        return (\r\n                            <button\r\n                                key={link.href}\r\n                                onClick={(e) => {\r\n                                    e.preventDefault();\r\n                                    e.stopPropagation();\r\n                                    handleNavigation(link.href, link.label);\r\n                                }}\r\n                                className={cn(\r\n                                    \"relative flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 w-16 group\",\r\n                                    isActive ? \"text-primary\" : \"text-zinc-400 hover:text-white\"\r\n                                )}\r\n                                type=\"button\"\r\n                            >\r\n                                {/* Active Background Glow */}\r\n                                {isActive && (\r\n                                    <div className=\"absolute inset-0 bg-primary/10 blur-md rounded-full transform scale-75\" />\r\n                                )}\r\n\r\n                                <link.icon\r\n                                    className={cn(\r\n                                        \"w-6 h-6 transition-all duration-300 relative z-10\",\r\n                                        isActive ? \"-translate-y-1 scale-110 drop-shadow-[0_0_8px_rgba(111,76,255,0.6)]\" : \"scale-100\"\r\n                                    )}\r\n                                    strokeWidth={isActive ? 2.5 : 2}\r\n                                />\r\n\r\n                                {/* Animated Label */}\r\n                                <span className={cn(\r\n                                    \"text-[10px] font-medium mt-1 transition-all duration-300 relative z-10\",\r\n                                    isActive ? \"text-white opacity-100 translate-y-0\" : \"opacity-0 -translate-y-2 absolute\"\r\n                                )}>\r\n                                    {link.label}\r\n                                </span>\r\n\r\n                                {/* Active Dot */}\r\n                                {isActive && (\r\n                                    <div className=\"absolute -bottom-1 w-1 h-1 bg-primary rounded-full shadow-[0_0_5px_currentColor]\" />\r\n                                )}\r\n                            </button>\r\n                        );\r\n                    })}\r\n\r\n                    {/* Menu Trigger */}\r\n                    <Sheet open={open} onOpenChange={setOpen}>\r\n                        <SheetTrigger asChild>\r\n                            <button\r\n                                className=\"relative flex flex-col items-center justify-center p-2 rounded-xl text-zinc-400 hover:text-white transition-colors w-16\"\r\n                                type=\"button\"\r\n                            >\r\n                                <Menu className=\"w-6 h-6\" />\r\n                            </button>\r\n                        </SheetTrigger>\r\n                        <SheetContent side=\"bottom\" className=\"p-0 h-[80vh] rounded-t-[32px] border-t border-white/10 bg-[#0B0F14]/95 backdrop-blur-xl\">\r\n                            <VisuallyHidden>\r\n                                <SheetTitle>Navigation Menu</SheetTitle>\r\n                                <SheetDescription>Main navigation links</SheetDescription>\r\n                            </VisuallyHidden>\r\n                            <div className=\"p-6 h-full overflow-y-auto\">\r\n                                <div className=\"w-12 h-1 bg-white/10 rounded-full mx-auto mb-8\" /> {/* Drag Handle */}\r\n                                <MobileSidebar className=\"w-full h-full bg-transparent shadow-none border-none p-0\" onLinkClick={() => setOpen(false)} />\r\n                            </div>\r\n                        </SheetContent>\r\n                    </Sheet>\r\n                </div>\r\n            </div>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\contact-item.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[654,657],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[654,657],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState } from \"react\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { getFamilyStatus, sendFamilyRequest } from \"@/app/actions/family\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface ContactItemProps {\r\n    user: {\r\n        id: string;\r\n        displayName: string;\r\n        imageUrl?: string | null;\r\n        profileData?: any;\r\n        isOnline?: boolean;\r\n    }\r\n}\r\n\r\nexport function ContactItem({ user }: ContactItemProps) {\r\n    const router = useRouter();\r\n    const [loading, setLoading] = useState(false);\r\n    const [showRequestDialog, setShowRequestDialog] = useState(false);\r\n\r\n    const profile = user.profileData as { firstName: string, lastName: string, imageUrl: string } | null;\r\n    const name = user.displayName || (profile?.firstName ? `${profile.firstName} ${profile.lastName}` : \"Unknown\");\r\n    const imageUrl = user.imageUrl || profile?.imageUrl;\r\n\r\n    async function handleClick() {\r\n        if (loading) return;\r\n        setLoading(true);\r\n\r\n        try {\r\n            const status = await getFamilyStatus(user.id);\r\n\r\n            if (status.status === 'accepted') {\r\n                router.push(`/u/${user.id}`);\r\n            } else if (status.status === 'pending') {\r\n                toast.info(\"Family request pending\", {\r\n                    description: \"You have already sent or received a request from this person.\"\r\n                });\r\n            } else {\r\n                setShowRequestDialog(true);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error checking status:\", error);\r\n            toast.error(\"Something went wrong\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }\r\n\r\n    async function handleSendRequest() {\r\n        try {\r\n            setLoading(true);\r\n            await sendFamilyRequest(user.id);\r\n            toast.success(\"Request sent!\", {\r\n                description: `Family request sent to ${name}`\r\n            });\r\n            setShowRequestDialog(false);\r\n        } catch (error) {\r\n            console.error(\"Error sending request:\", error);\r\n            toast.error(\"Failed to send request\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <div\r\n                onClick={handleClick}\r\n                className=\"flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer group\"\r\n            >\r\n                <div className=\"relative\">\r\n                    <Avatar className=\"h-10 w-10 border border-white/10\">\r\n                        <AvatarImage src={imageUrl || \"\"} alt={name} />\r\n                        <AvatarFallback>{name.charAt(0)}</AvatarFallback>\r\n                    </Avatar>\r\n                    <span\r\n                        className={`absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background ${user.isOnline ? \"bg-green-500\" : \"bg-gray-500/50\"\r\n                            }`}\r\n                    />\r\n                </div>\r\n                <div className=\"flex-1 min-w-0\">\r\n                    <span className=\"text-sm font-medium text-gray-300 group-hover:text-white transition-colors truncate block\">\r\n                        {name}\r\n                    </span>\r\n                </div>\r\n                {loading && <Loader2 className=\"h-3 w-3 animate-spin text-muted-foreground\" />}\r\n            </div>\r\n\r\n            <Dialog open={showRequestDialog} onOpenChange={setShowRequestDialog}>\r\n                <DialogContent>\r\n                    <DialogHeader>\r\n                        <DialogTitle>Send Family Request?</DialogTitle>\r\n                        <DialogDescription>\r\n                            Connect with {name} to share posts, photos, and see their updates on your timeline.\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setShowRequestDialog(false)}>Cancel</Button>\r\n                        <Button onClick={handleSendRequest} disabled={loading}>\r\n                            {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                            Send Request\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\main-layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\mobile-sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":21,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { LogOut, Home, Users, MessageSquare, Ticket, Image as ImageIcon, Settings, Shield, Tent, Heart, Briefcase, Bell, User, Video, Bot, Newspaper, Sun, Moon, Laptop } from \"lucide-react\";\r\nimport { NotificationBadge } from \"@/components/notifications/notification-badge\";\r\nimport { usePathname, useRouter } from \"next/navigation\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport { useTheme } from \"next-themes\";\r\n\r\ninterface MobileSidebarProps {\r\n    isAdmin?: boolean;\r\n    className?: string;\r\n    onLinkClick?: () => void;\r\n}\r\n\r\nexport function MobileSidebar({ isAdmin, className, onLinkClick }: MobileSidebarProps) {\r\n    const pathname = usePathname();\r\n    const router = useRouter();\r\n    const { user, signOut, profile } = useAuth();\r\n    const { t } = useLanguage();\r\n    const { theme, setTheme } = useTheme();\r\n\r\n    const handleNavigation = (href: string, label: string) => {\r\n        console.log('üîµ MOBILE NAV CLICK:', label, href);\r\n\r\n        try {\r\n            // Close the sheet\r\n            if (onLinkClick) {\r\n                console.log('üîµ Calling onLinkClick to close sheet');\r\n                onLinkClick();\r\n            }\r\n\r\n            // Navigate immediately using window.location as fallback\r\n            console.log('üîµ Attempting navigation to:', href);\r\n\r\n            // Try router.push first\r\n            router.push(href);\r\n\r\n            // Fallback to window.location after a short delay if router doesn't work\r\n            setTimeout(() => {\r\n                if (pathname === href) {\r\n                    console.log('üîµ Already at destination, no navigation needed');\r\n                } else {\r\n                    console.log('üîµ Using window.location fallback');\r\n                    window.location.href = href;\r\n                }\r\n            }, 300);\r\n\r\n        } catch (error) {\r\n            console.error('üî¥ Navigation error:', error);\r\n            // Ultimate fallback\r\n            window.location.href = href;\r\n        }\r\n    };\r\n\r\n    const groups = [\r\n        {\r\n            title: t(\"nav.section.main\"),\r\n            items: [\r\n                { href: \"/\", label: t(\"nav.home\"), icon: Home },\r\n                { href: \"/profile\", label: profile?.displayName || t(\"nav.profile\"), icon: User },\r\n                { href: \"/family\", label: t(\"nav.family\"), icon: Users },\r\n                { href: \"/groups\", label: t(\"nav.groups\"), icon: Tent },\r\n                { href: \"/chat\", label: t(\"nav.ai\"), icon: Bot },\r\n            ]\r\n        },\r\n        {\r\n            title: t(\"nav.section.discover\"),\r\n            items: [\r\n                { href: \"/messages\", label: t(\"nav.messages\"), icon: MessageSquare },\r\n                { href: \"/news\", label: t(\"nav.news\"), icon: Newspaper },\r\n                { href: \"/live\", label: t(\"nav.social.live\"), icon: Video },\r\n                { href: \"/events\", label: t(\"nav.social.events\"), icon: Ticket },\r\n                { href: \"/gallery\", label: t(\"nav.social.gallery\"), icon: ImageIcon },\r\n            ]\r\n        },\r\n        {\r\n            title: t(\"nav.section.system\"),\r\n            items: [\r\n                { href: \"/branding\", label: t(\"nav.branding\"), icon: Briefcase },\r\n                { href: \"/notifications\", label: t(\"nav.notifications\"), icon: Bell },\r\n                { href: \"/settings\", label: t(\"nav.settings\"), icon: Settings },\r\n            ]\r\n        }\r\n    ];\r\n\r\n    if (isAdmin) {\r\n        groups.push({\r\n            title: t(\"nav.admin\"),\r\n            items: [\r\n                { href: \"/admin\", label: t(\"nav.admin\"), icon: Shield }\r\n            ]\r\n        });\r\n    }\r\n\r\n    // Helper for theme labels\r\n    const getThemeLabel = (mode: string) => {\r\n        switch (mode) {\r\n            case 'light': return t('theme.light');\r\n            case 'dark': return t('theme.dark');\r\n            case 'system': return t('theme.system');\r\n            default: return mode;\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className={cn(\"flex flex-col h-full py-4 overflow-y-auto bg-transparent\", className)}>\r\n            {/* Header / Logo */}\r\n            <div className=\"px-6 py-4 flex-shrink-0 mb-6\">\r\n                <button\r\n                    className=\"flex items-center gap-3 cursor-pointer border-none bg-transparent p-0 group\"\r\n                    onClick={() => handleNavigation(\"/\", \"Logo\")}\r\n                    type=\"button\"\r\n                >\r\n                    <div className=\"relative flex items-center justify-center w-10 h-10\">\r\n                        <Heart className=\"w-6 h-6 text-primary fill-primary/20\" />\r\n                        <div className=\"absolute inset-0 bg-primary/20 blur-lg rounded-full opacity-50 group-hover:opacity-100 transition-opacity\" />\r\n                    </div>\r\n                    <span className=\"text-2xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-zinc-900 to-zinc-500 dark:from-white dark:to-zinc-400\">\r\n                        Famio\r\n                    </span>\r\n                </button>\r\n            </div>\r\n\r\n            {/* Navigation Groups */}\r\n            <nav className=\"flex-1 px-4 space-y-8\">\r\n                {groups.map((group) => (\r\n                    <div key={group.title} className=\"space-y-2\">\r\n                        {/* Section Title */}\r\n                        {group.title !== t(\"nav.section.main\") && (\r\n                            <h4 className=\"px-4 text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-3 opacity-80\">\r\n                                {group.title}\r\n                            </h4>\r\n                        )}\r\n\r\n                        {group.items.map((link) => {\r\n                            const isActive = pathname === link.href;\r\n                            return (\r\n                                <button\r\n                                    key={link.href}\r\n                                    onClick={(e) => {\r\n                                        e.preventDefault();\r\n                                        e.stopPropagation();\r\n                                        handleNavigation(link.href, link.label);\r\n                                    }}\r\n                                    className={cn(\r\n                                        \"relative flex items-center gap-4 w-full text-base font-medium transition-all h-14 rounded-2xl px-4\",\r\n                                        \"border-none bg-transparent text-left cursor-pointer group overflow-hidden\",\r\n                                        isActive\r\n                                            ? \"text-primary dark:text-white\"\r\n                                            : \"text-zinc-600 dark:text-zinc-400 hover:text-primary dark:hover:text-white\"\r\n                                    )}\r\n                                    type=\"button\"\r\n                                >\r\n                                    {/* Active Background Glow */}\r\n                                    {isActive && (\r\n                                        <div className=\"absolute inset-0 bg-primary/10 dark:bg-white/5 border border-primary/20 dark:border-white/10 rounded-2xl\" />\r\n                                    )}\r\n\r\n                                    {/* Hover Effect */}\r\n                                    <div className=\"absolute inset-0 bg-zinc-100/50 dark:bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-2xl\" />\r\n\r\n                                    <div className={cn(\r\n                                        \"relative z-10 p-2 rounded-xl transition-all duration-300\",\r\n                                        isActive ? \"bg-primary/20 text-primary dark:bg-white/10 dark:text-white\" : \"bg-zinc-100 dark:bg-white/5 text-zinc-500 dark:text-zinc-400 group-hover:scale-110\"\r\n                                    )}>\r\n                                        <link.icon className=\"w-5 h-5\" strokeWidth={isActive ? 2.5 : 2} />\r\n                                    </div>\r\n\r\n                                    <span className={cn(\"relative z-10 font-medium tracking-wide\", isActive && \"font-semibold\")}>\r\n                                        {link.label}\r\n                                    </span>\r\n\r\n                                    {link.href === '/notifications' && (\r\n                                        <div className=\"ml-auto relative z-10\">\r\n                                            <NotificationBadge />\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Active Indicator Arrow */}\r\n                                    {isActive && (\r\n                                        <div className=\"absolute right-4 w-1.5 h-1.5 bg-primary rounded-full shadow-[0_0_8px_currentColor]\" />\r\n                                    )}\r\n                                </button>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                ))}\r\n            </nav>\r\n\r\n            {/* Footer Actions */}\r\n            <div className=\"px-4 mt-8 pb-8 space-y-6\">\r\n                {/* Theme Toggle */}\r\n                <div className=\"p-1.5 bg-zinc-100 dark:bg-white/5 rounded-2xl border border-zinc-200 dark:border-white/5 flex gap-1\">\r\n                    {['light', 'dark', 'system'].map((tMode) => (\r\n                        <button\r\n                            key={tMode}\r\n                            onClick={() => setTheme(tMode)}\r\n                            className={cn(\r\n                                \"flex-1 py-2.5 rounded-xl text-xs font-medium transition-all flex items-center justify-center gap-2\",\r\n                                theme === tMode\r\n                                    ? \"bg-white text-zinc-900 shadow-sm dark:bg-zinc-800 dark:text-white\"\r\n                                    : \"text-zinc-500 hover:text-zinc-900 dark:hover:text-zinc-300\"\r\n                            )}\r\n                        >\r\n                            {tMode === 'light' && <Sun className=\"w-4 h-4\" />}\r\n                            {tMode === 'dark' && <Moon className=\"w-4 h-4\" />}\r\n                            {tMode === 'system' && <Laptop className=\"w-4 h-4\" />}\r\n                            <span className=\"capitalize\">{getThemeLabel(tMode)}</span>\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    className=\"w-full justify-start gap-3 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-500/10 rounded-2xl h-14 px-4 text-base font-medium\"\r\n                    onClick={() => {\r\n                        if (onLinkClick) onLinkClick();\r\n                        signOut();\r\n                    }}\r\n                >\r\n                    <div className=\"p-2 bg-red-500/10 rounded-xl\">\r\n                        <LogOut className=\"h-5 w-5\" />\r\n                    </div>\r\n                    {t(\"nav.signout\")}\r\n                </Button>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\right-sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Avatar' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Avatar"},"fix":{"range":[26,33],"text":""},"desc":"Remove unused variable \"Avatar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AvatarFallback' is defined but never used.","line":3,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AvatarFallback"},"fix":{"range":[32,48],"text":""},"desc":"Remove unused variable \"AvatarFallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AvatarImage' is defined but never used.","line":3,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":45,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"AvatarImage"},"fix":{"range":[17,94],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[614,617],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[614,617],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1963,1966],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1963,1966],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { getActiveUsers } from \"@/app/actions/users\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { ContactItem } from \"./contact-item\";\r\nimport { NewsFeed } from \"@/components/news/news-feed\";\r\nimport { useEffect, useState } from \"react\";\r\n\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\ninterface RightSidebarProps {\r\n    className?: string;\r\n}\r\n\r\nexport function RightSidebar({ className }: RightSidebarProps) {\r\n    const { t } = useLanguage();\r\n    const [activeUsers, setActiveUsers] = useState<any[]>([]);\r\n\r\n    useEffect(() => {\r\n        const fetchUsers = async () => {\r\n            try {\r\n                const users = await getActiveUsers();\r\n                setActiveUsers(users);\r\n            } catch (error) {\r\n                console.error(\"Failed to load active users\", error);\r\n            }\r\n        };\r\n\r\n        fetchUsers();\r\n        // Refresh every minute\r\n        const interval = setInterval(fetchUsers, 60000);\r\n        return () => clearInterval(interval);\r\n    }, []);\r\n\r\n    return (\r\n        <aside className={cn(\"hidden lg:flex flex-col gap-4 p-4 w-80 overflow-y-auto border-l border-border/50\", className)}>\r\n            <div className=\"flex flex-col gap-2\">\r\n                <h3 className=\"text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2 flex items-center justify-between\">\r\n                    {t(\"sidebar.members\")}\r\n                    <span className=\"text-xs text-muted-foreground bg-muted px-2 py-0.5 rounded-full\">{activeUsers.length}</span>\r\n                </h3>\r\n\r\n                {activeUsers.length === 0 ? (\r\n                    <div className=\"text-xs text-gray-400 p-2 text-center border border-dashed border-gray-700/50 rounded-lg\">\r\n                        {t(\"sidebar.members.empty\")}\r\n                    </div>\r\n                ) : (\r\n                    activeUsers.map((user: any) => (\r\n                        <ContactItem key={user.id} user={user} />\r\n                    ))\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"my-2 border-t border-border/50\" />\r\n\r\n            <NewsFeed />\r\n        </aside>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\sidebar-item.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnimatePresence' is defined but never used.","line":6,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[142,159],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { LucideIcon } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\n\r\ninterface SidebarItemProps {\r\n    icon: LucideIcon;\r\n    label: string;\r\n    href: string;\r\n    isActive?: boolean;\r\n    isExpanded?: boolean;\r\n    hasNotification?: boolean;\r\n    onClick?: () => void;\r\n}\r\n\r\nexport function SidebarItem({\r\n    icon: Icon,\r\n    label,\r\n    href,\r\n    isActive,\r\n    isExpanded,\r\n    hasNotification,\r\n    onClick\r\n}: SidebarItemProps) {\r\n    return (\r\n        <Link\r\n            href={href}\r\n            onClick={onClick}\r\n            className={cn(\r\n                \"relative flex items-center h-12 px-3 rounded-xl transition-all duration-200 group overflow-hidden\",\r\n                isActive\r\n                    ? \"bg-primary/10 text-primary dark:bg-gradient-to-r dark:from-primary/20 dark:to-transparent dark:text-white\"\r\n                    : \"text-zinc-500 hover:text-zinc-900 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:text-white dark:hover:bg-white/5\"\r\n            )}\r\n        >\r\n            {/* Active Indicator Bar (Neon Glow) */}\r\n            {isActive && (\r\n                <motion.div\r\n                    layoutId=\"sidebar-active\"\r\n                    className=\"absolute left-0 top-2 bottom-2 w-1 bg-primary rounded-r-full shadow-[0_0_12px_rgba(var(--primary-rgb),0.5)] dark:shadow-[0_0_12px_rgba(var(--primary-rgb),0.8)]\"\r\n                    initial={{ opacity: 0 }}\r\n                    animate={{ opacity: 1 }}\r\n                    exit={{ opacity: 0 }}\r\n                />\r\n            )}\r\n\r\n            {/* Icon Container */}\r\n            <div className={cn(\r\n                \"relative z-10 flex items-center justify-center w-8 h-8 transition-transform duration-300\",\r\n                \"group-hover:scale-110 group-hover:-translate-y-0.5\", // \"Lift\" effect\r\n                isActive && \"text-primary drop-shadow-[0_0_8px_rgba(111,76,255,0.5)]\"\r\n            )}>\r\n                <Icon className={cn(\"w-5 h-5\", isActive ? \"stroke-[2.5px]\" : \"stroke-[2px]\")} />\r\n\r\n                {/* Notification Dot on Icon (Collpased state) */}\r\n                {hasNotification && !isExpanded && (\r\n                    <span className=\"absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border-2 border-white dark:border-[#0B0F14]\" />\r\n                )}\r\n            </div>\r\n\r\n            {/* Label (Slide In/Out) */}\r\n            <div className={cn(\r\n                \"flex-1 ml-3 whitespace-nowrap overflow-hidden transition-all duration-300\",\r\n                isExpanded ? \"opacity-100 w-auto translate-x-0\" : \"opacity-0 w-0 -translate-x-2\"\r\n            )}>\r\n                <span className={cn(\r\n                    \"text-sm font-medium tracking-wide\",\r\n                    isActive ? \"font-bold text-primary dark:text-white\" : \"text-zinc-500 group-hover:text-zinc-900 dark:text-zinc-400 dark:group-hover:text-zinc-100\"\r\n                )}>\r\n                    {label}\r\n                </span>\r\n            </div>\r\n\r\n            {/* Notification Badge (Expanded) */}\r\n            {hasNotification && isExpanded && (\r\n                <span className=\"ml-auto w-2 h-2 bg-red-500 rounded-full shadow-[0_0_8px_rgba(239,68,68,0.6)]\" />\r\n            )}\r\n\r\n            {/* Hover Glow Background - Subtle Glass */}\r\n            <div className=\"absolute inset-0 bg-gradient-to-r from-zinc-100/50 to-transparent dark:from-white/5 dark:to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none\" />\r\n        </Link>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Laptop' is defined but never used.","line":5,"column":140,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":146,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Laptop"},"fix":{"range":[243,251],"text":""},"desc":"Remove unused variable \"Laptop\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronRight' is defined but never used.","line":5,"column":159,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":171,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronRight"},"fix":{"range":[262,276],"text":""},"desc":"Remove unused variable \"ChevronRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NotificationBadge' is defined but never used.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":27,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"NotificationBadge"},"fix":{"range":[301,383],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[499,547],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":27,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState } from \"react\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { LogOut, Home, Users, MessageSquare, Ticket, Image as ImageIcon, Settings, Shield, Tent, Heart, Briefcase, Bell, User, Video, Bot, Laptop, Sun, Moon, ChevronRight } from \"lucide-react\";\r\nimport { NotificationBadge } from \"@/components/notifications/notification-badge\";\r\nimport Link from \"next/link\";\r\nimport { usePathname } from \"next/navigation\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport { useTheme } from \"next-themes\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport { SidebarItem } from \"./sidebar-item\";\r\nimport { VoiceStatusIndicator } from \"@/components/ai/voice-status-indicator\";\r\n\r\nimport { useVoice } from \"@/components/ai/voice-provider\";\r\n\r\ninterface SidebarProps {\r\n    isAdmin?: boolean;\r\n    className?: string;\r\n    onLinkClick?: () => void;\r\n}\r\n\r\nexport function Sidebar({ isAdmin, className, onLinkClick }: SidebarProps) {\r\n    const pathname = usePathname();\r\n    const { user, signOut, profile } = useAuth();\r\n    const { t } = useLanguage();\r\n    const { theme, setTheme } = useTheme();\r\n    const [isHovered, setIsHovered] = useState(false);\r\n\r\n    // Global Voice State\r\n    const { state: aiState, toggleContinuous } = useVoice();\r\n\r\n    const groups = [\r\n        {\r\n            title: t(\"nav.section.main\"),\r\n            items: [\r\n                { href: \"/\", label: t(\"nav.home\"), icon: Home },\r\n                { href: \"/chat\", label: t(\"nav.ai\"), icon: Bot }, // Moved up for AI-first focus\r\n                { href: \"/profile\", label: profile?.displayName || t(\"nav.profile\"), icon: User },\r\n                { href: \"/messages\", label: t(\"nav.messages\"), icon: MessageSquare, hasNotification: true }, // Example notif\r\n            ]\r\n        },\r\n        {\r\n            title: t(\"nav.section.discover\"),\r\n            items: [\r\n                { href: \"/family\", label: t(\"nav.family\"), icon: Users },\r\n                { href: \"/groups\", label: t(\"nav.groups\"), icon: Tent },\r\n                { href: \"/live\", label: t(\"nav.live\"), icon: Video },\r\n                { href: \"/events\", label: t(\"nav.events\"), icon: Ticket },\r\n                { href: \"/gallery\", label: t(\"nav.gallery\"), icon: ImageIcon },\r\n            ]\r\n        },\r\n        {\r\n            title: t(\"nav.section.system\"),\r\n            items: [\r\n                { href: \"/branding\", label: t(\"nav.branding\"), icon: Briefcase },\r\n                { href: \"/notifications\", label: t(\"nav.notifications\"), icon: Bell },\r\n                { href: \"/privacy\", label: t(\"nav.privacy\"), icon: Shield },\r\n                { href: \"/settings\", label: t(\"nav.settings\"), icon: Settings },\r\n            ]\r\n        }\r\n    ];\r\n\r\n    if (isAdmin) {\r\n        groups.push({\r\n            title: \"Admin\",\r\n            items: [\r\n                { href: \"/admin\", label: t(\"nav.admin\"), icon: Shield }\r\n            ]\r\n        });\r\n    }\r\n\r\n    return (\r\n        <motion.div\r\n            className={cn(\r\n                \"hidden md:flex flex-col h-[calc(100vh-2rem)] my-4 ml-4 rounded-[24px] fixed left-0 top-0 z-50 shadow-2xl overflow-hidden\",\r\n                // Edgy Design: Dark charcoal background in dark mode, clean white in light mode\r\n                \"bg-white/80 dark:bg-[#0B0F14] backdrop-blur-xl border border-zinc-200 dark:border-white/5 shadow-xl dark:shadow-[0_0_40px_-10px_rgba(0,0,0,0.5)]\",\r\n                className\r\n            )}\r\n            initial={{ width: 80 }}\r\n            animate={{ width: isHovered ? 260 : 84 }} // 84px collapsed, 260px expanded\r\n            transition={{ type: \"spring\", stiffness: 300, damping: 30 }}\r\n            onMouseEnter={() => setIsHovered(true)}\r\n            onMouseLeave={() => setIsHovered(false)}\r\n        >\r\n            {/* 1. Header: Logo & AI Indicator */}\r\n            <div className=\"flex flex-col items-center px-4 pt-6 pb-2\">\r\n                <div className=\"flex items-center justify-between w-full mb-4 pl-1\">\r\n                    <Link\r\n                        href=\"/\"\r\n                        className=\"flex items-center gap-3 group\"\r\n                        onClick={onLinkClick}\r\n                    >\r\n                        <div className=\"relative flex items-center justify-center w-10 h-10\">\r\n                            {/* Animated Logo Mark */}\r\n                            <Heart className={cn(\r\n                                \"w-6 h-6 text-primary fill-primary/20\",\r\n                                isHovered ? \"scale-100\" : \"scale-90\"\r\n                            )} />\r\n                            <div className=\"absolute inset-0 bg-primary/20 blur-xl rounded-full opacity-50 group-hover:opacity-100 transition-opacity duration-500\" />\r\n                        </div>\r\n\r\n                        {/* Title text fades in */}\r\n                        <AnimatePresence>\r\n                            {isHovered && (\r\n                                <motion.span\r\n                                    className=\"text-xl font-bold tracking-tight text-zinc-900 dark:text-white whitespace-nowrap\"\r\n                                    initial={{ opacity: 0, x: -10 }}\r\n                                    animate={{ opacity: 1, x: 0 }}\r\n                                    exit={{ opacity: 0, x: -10 }}\r\n                                >\r\n                                    Famio\r\n                                </motion.span>\r\n                            )}\r\n                        </AnimatePresence>\r\n                    </Link>\r\n                </div>\r\n\r\n                {/* AI Presence Bar */}\r\n                <div className=\"w-full\">\r\n                    <VoiceStatusIndicator\r\n                        state={aiState}\r\n                        className=\"w-full bg-zinc-100/50 hover:bg-zinc-100 dark:bg-white/5 dark:hover:bg-white/10\"\r\n                        onClick={toggleContinuous}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            {/* 2. Scrollable Navigation */}\r\n            <nav className=\"flex-1 px-3 py-4 space-y-6 overflow-y-auto overflow-x-hidden custom-scrollbar\">\r\n                {groups.map((group) => (\r\n                    <div key={group.title} className=\"space-y-1\">\r\n                        {/* Section Title (Only visible when expanded) */}\r\n                        <div className={cn(\r\n                            \"px-3 text-[10px] font-bold text-zinc-500 uppercase tracking-widest transition-opacity duration-200 h-4 mb-2 flex items-center\",\r\n                            isHovered ? \"opacity-100\" : \"opacity-0\"\r\n                        )}>\r\n                            {group.title}\r\n                        </div>\r\n\r\n                        {group.items.map((link) => (\r\n                            <SidebarItem\r\n                                key={link.href}\r\n                                icon={link.icon}\r\n                                label={link.label}\r\n                                href={link.href}\r\n                                isActive={pathname === link.href}\r\n                                isExpanded={isHovered}\r\n                                hasNotification={link.href === '/notifications' || link.href === '/messages'} // Logic for demo\r\n                                onClick={onLinkClick}\r\n                            />\r\n                        ))}\r\n                    </div>\r\n                ))}\r\n            </nav>\r\n\r\n            {/* 3. Footer: User & Settings */}\r\n            <div className=\"p-3 bg-gradient-to-t from-zinc-100/80 to-transparent dark:from-black/50 dark:to-transparent\">\r\n                {/* Theme Toggles (Simplified) */}\r\n                {isHovered ? (\r\n                    <motion.div\r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        className=\"flex gap-1 p-1 mb-2 bg-zinc-100 dark:bg-white/5 rounded-xl border border-zinc-200 dark:border-white/5\"\r\n                    >\r\n                        {['light', 'dark', 'system'].map((tMode) => (\r\n                            <button\r\n                                key={tMode}\r\n                                onClick={() => setTheme(tMode)}\r\n                                className={cn(\r\n                                    \"flex-1 p-1.5 rounded-lg text-xs font-medium transition-all\",\r\n                                    theme === tMode\r\n                                        ? \"bg-white text-zinc-900 shadow-sm dark:bg-zinc-800 dark:text-white\"\r\n                                        : \"text-zinc-500 hover:text-zinc-900 dark:hover:text-zinc-300\"\r\n                                )}\r\n                            >\r\n                                {tMode === 'light' && <p>‚òÄ</p>}\r\n                                {tMode === 'dark' && <p>‚òæ</p>}\r\n                                {tMode === 'system' && <p>üíª</p>}\r\n                            </button>\r\n                        ))}\r\n                    </motion.div>\r\n                ) : (\r\n                    // Collapsed Theme Toggle (Cycle)\r\n                    <button\r\n                        onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}\r\n                        className=\"w-full flex items-center justify-center h-10 text-zinc-500 hover:text-zinc-900 dark:hover:text-white transition-colors mb-2\"\r\n                    >\r\n                        {theme === 'dark' ? <Moon className=\"w-5 h-5\" /> : <Sun className=\"w-5 h-5\" />}\r\n                    </button>\r\n                )}\r\n\r\n                <div className=\"border-t border-zinc-200 dark:border-white/10 pt-3 mt-1\">\r\n                    <SidebarItem\r\n                        icon={LogOut}\r\n                        label={t(\"nav.signout\")}\r\n                        href=\"#\"\r\n                        onClick={() => signOut().then(() => window.location.href = '/login')}\r\n                        isExpanded={isHovered}\r\n                        isActive={false}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            {/* Drag Handle Indicator (Optional visual cue) */}\r\n            <div className=\"absolute right-0 top-1/2 -translate-y-1/2 w-1 h-12 bg-zinc-200/50 dark:bg-white/5 rounded-l-full\" />\r\n        </motion.div>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\layout\\top-nav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\live\\live-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[412,415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[412,415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Video, Users, ArrowLeft } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\ninterface LiveViewProps {\r\n    broadcasts: any[];\r\n    error: string | null;\r\n}\r\n\r\nexport function LiveView({ broadcasts, error }: LiveViewProps) {\r\n    const { t } = useLanguage();\r\n\r\n    return (\r\n        <div className=\"container mx-auto p-6 max-w-6xl\">\r\n            <div className=\"flex items-center justify-between mb-8\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    <Link href=\"/\">\r\n                        <Button variant=\"ghost\" size=\"icon\">\r\n                            <ArrowLeft className=\"h-5 w-5\" />\r\n                        </Button>\r\n                    </Link>\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-bold\">{t('live.title')}</h1>\r\n                        <p className=\"text-muted-foreground mt-1\">{t('live.desc')}</p>\r\n                    </div>\r\n                </div>\r\n                <Link href=\"/live/broadcast\">\r\n                    <Button size=\"lg\" className=\"gap-2\">\r\n                        <Video className=\"h-5 w-5\" />\r\n                        {t('live.go_live')}\r\n                    </Button>\r\n                </Link>\r\n            </div>\r\n\r\n            {error ? (\r\n                <Card>\r\n                    <CardContent className=\"flex flex-col items-center justify-center py-16\">\r\n                        <p className=\"text-destructive mb-4\">{t('live.error')}</p>\r\n                        <p className=\"text-sm text-muted-foreground\">{error}</p>\r\n                    </CardContent>\r\n                </Card>\r\n            ) : broadcasts.length === 0 ? (\r\n                <Card>\r\n                    <CardContent className=\"flex flex-col items-center justify-center py-16\">\r\n                        <Video className=\"h-16 w-16 text-muted-foreground mb-4\" />\r\n                        <h3 className=\"text-xl font-semibold mb-2\">{t('live.empty.title')}</h3>\r\n                        <p className=\"text-muted-foreground text-center max-w-md\">\r\n                            {t('live.empty.desc')}\r\n                        </p>\r\n                    </CardContent>\r\n                </Card>\r\n            ) : (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                    {broadcasts.map((broadcast) => (\r\n                        <Link key={broadcast.id} href={`/live/${broadcast.id}`}>\r\n                            <Card className=\"hover:shadow-lg transition-shadow cursor-pointer\">\r\n                                <CardHeader className=\"p-0\">\r\n                                    <div className=\"relative aspect-video bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center\">\r\n                                        <Video className=\"h-16 w-16 text-primary/40\" />\r\n                                        <div className=\"absolute top-3 left-3 flex items-center gap-2 bg-red-600 text-white px-2 py-1 rounded text-xs font-semibold\">\r\n                                            <div className=\"w-1.5 h-1.5 bg-white rounded-full animate-pulse\" />\r\n                                            Live\r\n                                        </div>\r\n                                    </div>\r\n                                </CardHeader>\r\n                                <CardContent className=\"p-4\">\r\n                                    <div className=\"flex items-center gap-3\">\r\n                                        <Avatar className=\"h-10 w-10\">\r\n                                            <AvatarImage src={broadcast.hostImage} />\r\n                                            <AvatarFallback>{broadcast.hostName?.[0]}</AvatarFallback>\r\n                                        </Avatar>\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <h3 className=\"font-semibold truncate\">{broadcast.hostName}</h3>\r\n                                            <p className=\"text-sm text-muted-foreground flex items-center gap-1\">\r\n                                                <Users className=\"h-3 w-3\" />\r\n                                                {t('live.watching')}\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        </Link>\r\n                    ))}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\magic-ai\\ai-preview-panel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[265,267],"text":""},"desc":"Remove unused variable \"X\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { ToneSelector } from \"./tone-selector\";\r\nimport { X, ArrowLeft, Check, Edit3, Loader2 } from \"lucide-react\";\r\nimport type { EmotionalTone } from \"@/types/magic-ai\";\r\n\r\ninterface AIPreviewPanelProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    originalContent: string;\r\n    enhancedContent: string | null;\r\n    selectedTone: EmotionalTone | null;\r\n    isGenerating: boolean;\r\n    onSelectTone: (tone: EmotionalTone) => void;\r\n    onAccept: () => void;\r\n    onRevert: () => void;\r\n}\r\n\r\nexport function AIPreviewPanel({\r\n    isOpen,\r\n    onClose,\r\n    originalContent,\r\n    enhancedContent,\r\n    selectedTone,\r\n    isGenerating,\r\n    onSelectTone,\r\n    onAccept,\r\n    onRevert\r\n}: AIPreviewPanelProps) {\r\n    const showPreview = enhancedContent !== null;\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={onClose}>\r\n            <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <span className=\"text-2xl\">‚ú®</span>\r\n                        <span>Magic AI - Emotional Intelligence</span>\r\n                    </DialogTitle>\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-6 py-4\">\r\n                    {/* Tone Selector */}\r\n                    <ToneSelector\r\n                        selectedTone={selectedTone}\r\n                        onSelectTone={onSelectTone}\r\n                        disabled={isGenerating}\r\n                    />\r\n\r\n                    {/* Loading State */}\r\n                    {isGenerating && (\r\n                        <div className=\"flex flex-col items-center justify-center py-12 space-y-3\">\r\n                            <Loader2 className=\"w-12 h-12 animate-spin text-primary\" />\r\n                            <p className=\"text-sm text-muted-foreground\">\r\n                                Generating your {selectedTone?.replace('_', ' ')} content...\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Preview Comparison */}\r\n                    {showPreview && !isGenerating && (\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"grid md:grid-cols-2 gap-4\">\r\n                                {/* Original Content */}\r\n                                <div className=\"space-y-2\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <Badge variant=\"outline\" className=\"text-xs\">\r\n                                            Original\r\n                                        </Badge>\r\n                                        <span className=\"text-xs text-muted-foreground\">\r\n                                            {originalContent.length} characters\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"p-4 bg-muted rounded-lg border border-border min-h-[120px]\">\r\n                                        <p className=\"text-sm whitespace-pre-wrap\">{originalContent}</p>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Enhanced Content */}\r\n                                <div className=\"space-y-2\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <Badge className=\"text-xs bg-primary/10 text-primary border-primary/20\">\r\n                                            ‚ú® Magic AI Enhanced\r\n                                        </Badge>\r\n                                        <span className=\"text-xs text-muted-foreground\">\r\n                                            {enhancedContent.length} characters\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"p-4 bg-gradient-to-br from-primary/5 to-purple/5 rounded-lg border border-primary/20 min-h-[120px]\">\r\n                                        <p className=\"text-sm whitespace-pre-wrap\">{enhancedContent}</p>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Action Buttons */}\r\n                            <div className=\"flex flex-col-reverse md:flex-row gap-3 pt-4 border-t\">\r\n                                <Button\r\n                                    variant=\"outline\"\r\n                                    onClick={onRevert}\r\n                                    className=\"gap-2\"\r\n                                >\r\n                                    <ArrowLeft className=\"w-4 h-4\" />\r\n                                    Revert to Original\r\n                                </Button>\r\n\r\n                                <Button\r\n                                    variant=\"outline\"\r\n                                    onClick={() => {\r\n                                        // Re-open tone selector\r\n                                        onRevert();\r\n                                    }}\r\n                                    className=\"gap-2\"\r\n                                >\r\n                                    <Edit3 className=\"w-4 h-4\" />\r\n                                    Try Another Tone\r\n                                </Button>\r\n\r\n                                <Button\r\n                                    onClick={onAccept}\r\n                                    className=\"gap-2 bg-primary hover:bg-primary/90 flex-1\"\r\n                                >\r\n                                    <Check className=\"w-4 h-4\" />\r\n                                    Use This Content\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Empty State - Waiting for tone selection */}\r\n                    {!showPreview && !isGenerating && (\r\n                        <div className=\"text-center py-8 text-muted-foreground\">\r\n                            <p className=\"text-sm\">\r\n                                Select a tone above to see your enhanced content\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\magic-ai\\magic-ai-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\magic-ai\\tone-selector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\messages\\message-notification-provider.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sonnerToast' is defined but never used.","line":9,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":30,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"sonnerToast"},"fix":{"range":[382,427],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { createContext, useContext, useState, useEffect, ReactNode } from \"react\"\r\nimport { useAuth } from \"@/components/auth-provider\"\r\nimport { usePathname } from \"next/navigation\"\r\nimport { listenForNewMessages, NewMessageData } from \"@/lib/message-listener\"\r\nimport { MessageToast } from \"./message-toast\"\r\nimport { QuickReplyModal } from \"./quick-reply-modal\"\r\nimport { toast as sonnerToast } from \"sonner\"\r\n\r\ninterface MessageNotificationContextType {\r\n    // Can add methods here if needed later\r\n}\r\n\r\nconst MessageNotificationContext = createContext<MessageNotificationContextType>({})\r\n\r\nexport function useMessageNotifications() {\r\n    return useContext(MessageNotificationContext)\r\n}\r\n\r\nexport function MessageNotificationProvider({ children }: { children: ReactNode }) {\r\n    const { user } = useAuth()\r\n    const pathname = usePathname()\r\n    const [activeNotification, setActiveNotification] = useState<NewMessageData | null>(null)\r\n    const [quickReplyOpen, setQuickReplyOpen] = useState(false)\r\n    const [quickReplySession, setQuickReplySession] = useState<{\r\n        sessionId: string\r\n        senderName: string\r\n        senderImage?: string\r\n    } | null>(null)\r\n\r\n    useEffect(() => {\r\n        if (!user) return\r\n\r\n        // Don't show notifications if user is already on messages page\r\n        const isOnMessagesPage = pathname?.startsWith(\"/messages\")\r\n        if (isOnMessagesPage) return\r\n\r\n        const unsubscribe = listenForNewMessages(user.uid, (message) => {\r\n            // Show toast notification\r\n            setActiveNotification(message)\r\n\r\n            // Auto-dismiss after 10 seconds\r\n            setTimeout(() => {\r\n                setActiveNotification(null)\r\n            }, 10000)\r\n        })\r\n\r\n        return () => unsubscribe()\r\n    }, [user, pathname])\r\n\r\n    const handleReadNow = () => {\r\n        if (!activeNotification) return\r\n\r\n        setQuickReplySession({\r\n            sessionId: activeNotification.sessionId,\r\n            senderName: activeNotification.senderName,\r\n            senderImage: activeNotification.senderImage,\r\n        })\r\n        setQuickReplyOpen(true)\r\n        setActiveNotification(null)\r\n    }\r\n\r\n    const handleIgnore = () => {\r\n        setActiveNotification(null)\r\n    }\r\n\r\n    return (\r\n        <MessageNotificationContext.Provider value={{}}>\r\n            {children}\r\n\r\n            {/* Toast Notification */}\r\n            {activeNotification && (\r\n                <div className=\"fixed bottom-4 right-4 z-50\">\r\n                    <MessageToast\r\n                        message={activeNotification}\r\n                        onReadNow={handleReadNow}\r\n                        onIgnore={handleIgnore}\r\n                    />\r\n                </div>\r\n            )}\r\n\r\n            {/* Quick Reply Modal */}\r\n            {quickReplySession && user && (\r\n                <QuickReplyModal\r\n                    open={quickReplyOpen}\r\n                    onOpenChange={setQuickReplyOpen}\r\n                    sessionId={quickReplySession.sessionId}\r\n                    senderName={quickReplySession.senderName}\r\n                    senderImage={quickReplySession.senderImage}\r\n                    currentUserId={user.uid}\r\n                />\r\n            )}\r\n        </MessageNotificationContext.Provider>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\messages\\message-toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\messages\\quick-reply-modal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadMessages'. Either include it or remove the dependency array.","line":41,"column":8,"nodeType":"ArrayExpression","endLine":41,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [loadMessages, open, sessionId]","fix":{"range":[1313,1330],"text":"[loadMessages, open, sessionId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { getMessages, sendMessage, Message } from \"@/app/actions/chat\"\r\nimport { Send, ExternalLink } from \"lucide-react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\n\r\ninterface QuickReplyModalProps {\r\n    open: boolean\r\n    onOpenChange: (open: boolean) => void\r\n    sessionId: string\r\n    senderName: string\r\n    senderImage?: string\r\n    currentUserId: string\r\n}\r\n\r\nexport function QuickReplyModal({\r\n    open,\r\n    onOpenChange,\r\n    sessionId,\r\n    senderName,\r\n    senderImage,\r\n    currentUserId,\r\n}: QuickReplyModalProps) {\r\n    const router = useRouter()\r\n    const [messages, setMessages] = useState<Message[]>([])\r\n    const [inputText, setInputText] = useState(\"\")\r\n    const [isSending, setIsSending] = useState(false)\r\n    const [isLoading, setIsLoading] = useState(true)\r\n\r\n    useEffect(() => {\r\n        if (open) {\r\n            loadMessages()\r\n        }\r\n    }, [open, sessionId])\r\n\r\n    const loadMessages = async () => {\r\n        try {\r\n            setIsLoading(true)\r\n            const data = await getMessages(sessionId)\r\n            // Show last 5 messages\r\n            setMessages(data.slice(-5))\r\n        } catch (error) {\r\n            console.error(\"Error loading messages:\", error)\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleSend = async () => {\r\n        if (!inputText.trim()) return\r\n\r\n        const content = inputText\r\n        setInputText(\"\")\r\n\r\n        setIsSending(true)\r\n        try {\r\n            await sendMessage(sessionId, content)\r\n            await loadMessages()\r\n        } catch (error) {\r\n            console.error(\"Error sending message:\", error)\r\n        } finally {\r\n            setIsSending(false)\r\n        }\r\n    }\r\n\r\n    const handleOpenFullChat = () => {\r\n        onOpenChange(false)\r\n        router.push(\"/messages\")\r\n    }\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-[500px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <Avatar className=\"h-8 w-8\">\r\n                            <AvatarImage src={senderImage} />\r\n                            <AvatarFallback>{senderName[0]}</AvatarFallback>\r\n                        </Avatar>\r\n                        {senderName}\r\n                    </DialogTitle>\r\n                </DialogHeader>\r\n\r\n                <ScrollArea className=\"h-[300px] pr-4\">\r\n                    {isLoading ? (\r\n                        <div className=\"flex items-center justify-center h-full\">\r\n                            <p className=\"text-muted-foreground\">Loading messages...</p>\r\n                        </div>\r\n                    ) : messages.length === 0 ? (\r\n                        <div className=\"flex items-center justify-center h-full\">\r\n                            <p className=\"text-muted-foreground\">No messages yet</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"space-y-4\">\r\n                            {messages.map((msg) => {\r\n                                const isOwn = msg.senderId === currentUserId\r\n                                return (\r\n                                    <div\r\n                                        key={msg.id}\r\n                                        className={`flex ${isOwn ? \"justify-end\" : \"justify-start\"}`}\r\n                                    >\r\n                                        <div\r\n                                            className={`max-w-[70%] rounded-lg px-4 py-2 ${isOwn\r\n                                                    ? \"bg-primary text-primary-foreground\"\r\n                                                    : \"bg-muted\"\r\n                                                }`}\r\n                                        >\r\n                                            <p className=\"text-sm\">{msg.content}</p>\r\n                                            <p\r\n                                                className={`text-xs mt-1 ${isOwn ? \"text-primary-foreground/70\" : \"text-muted-foreground\"\r\n                                                    }`}\r\n                                            >\r\n                                                {formatDistanceToNow(msg.createdAt, { addSuffix: true })}\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                )\r\n                            })}\r\n                        </div>\r\n                    )}\r\n                </ScrollArea>\r\n\r\n                <div className=\"flex gap-2\">\r\n                    <Input\r\n                        placeholder=\"Type a message...\"\r\n                        value={inputText}\r\n                        onChange={(e) => setInputText(e.target.value)}\r\n                        onKeyDown={(e) => {\r\n                            if (e.key === \"Enter\" && !e.shiftKey) {\r\n                                e.preventDefault()\r\n                                handleSend()\r\n                            }\r\n                        }}\r\n                        disabled={isSending}\r\n                    />\r\n                    <Button onClick={handleSend} disabled={isSending || !inputText.trim()}>\r\n                        <Send className=\"h-4 w-4\" />\r\n                    </Button>\r\n                </div>\r\n\r\n                <Button\r\n                    variant=\"outline\"\r\n                    onClick={handleOpenFullChat}\r\n                    className=\"w-full gap-2\"\r\n                >\r\n                    <ExternalLink className=\"h-4 w-4\" />\r\n                    Open Full Chat\r\n                </Button>\r\n            </DialogContent>\r\n        </Dialog>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\mode-toggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\news\\crypto-ticker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\news\\news-card.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ExternalLink' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ExternalLink"},"fix":{"range":[123,136],"text":""},"desc":"Remove unused variable \"ExternalLink\"."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":40,"column":25,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":153}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { NewsItem } from \"@/app/actions/news\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\nimport { ExternalLink, Sparkles, TrendingUp, TrendingDown, Minus } from \"lucide-react\";\r\nimport { useState } from \"react\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nexport function NewsCard({ item }: { item: NewsItem }) {\r\n    const [showAI, setShowAI] = useState(false);\r\n\r\n    let timeAgo = '';\r\n    try {\r\n        if (item.pubDate) {\r\n            timeAgo = formatDistanceToNow(new Date(item.pubDate), { addSuffix: true });\r\n        }\r\n    } catch { timeAgo = 'Just now' }\r\n\r\n    const hasAI = item.aiSummary && item.aiSummary.length > 0;\r\n\r\n    const sentimentConfig = {\r\n        positive: { icon: TrendingUp, color: 'text-green-600', bg: 'bg-green-500/10' },\r\n        negative: { icon: TrendingDown, color: 'text-red-600', bg: 'bg-red-500/10' },\r\n        neutral: { icon: Minus, color: 'text-gray-600', bg: 'bg-gray-500/10' }\r\n    };\r\n\r\n    const config = item.sentiment ? sentimentConfig[item.sentiment] : sentimentConfig.neutral;\r\n    const SentimentIcon = config.icon;\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-2 p-3 rounded-lg hover:bg-muted/50 transition-colors border-b border-border/50 last:border-0\">\r\n            <a\r\n                href={item.link}\r\n                target=\"_blank\"\r\n                rel=\"noopener noreferrer\"\r\n                className=\"flex gap-3 group items-start\"\r\n            >\r\n                {item.thumbnail && (\r\n                    <div className=\"flex-shrink-0 w-16 h-16 rounded-md overflow-hidden bg-gray-200\">\r\n                        <img src={item.thumbnail} alt=\"\" className=\"w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity\" />\r\n                    </div>\r\n                )}\r\n                <div className=\"flex flex-col flex-1 min-w-0\">\r\n                    <h4 className=\"text-sm font-medium leading-tight line-clamp-2 group-hover:text-primary transition-colors\">\r\n                        {item.title}\r\n                    </h4>\r\n                    <div className=\"flex items-center gap-2 mt-1 text-xs text-muted-foreground\">\r\n                        <span className=\"font-semibold text-primary/80\">{item.source}</span>\r\n                        <span>‚Ä¢</span>\r\n                        <span>{timeAgo}</span>\r\n                        {item.sentiment && (\r\n                            <>\r\n                                <span>‚Ä¢</span>\r\n                                <div className={cn(\"flex items-center gap-1 px-1.5 py-0.5 rounded\", config.bg)}>\r\n                                    <SentimentIcon className={cn(\"w-3 h-3\", config.color)} />\r\n                                </div>\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </a>\r\n\r\n            {/* AI Insights Section */}\r\n            {hasAI && (\r\n                <div className=\"mt-2 space-y-2\">\r\n                    <button\r\n                        onClick={() => setShowAI(!showAI)}\r\n                        className=\"flex items-center gap-1.5 text-xs font-medium text-primary/80 hover:text-primary transition-colors\"\r\n                    >\r\n                        <Sparkles className=\"w-3 h-3\" />\r\n                        <span>AI Summary</span>\r\n                        <span className=\"text-[10px] ml-1\">{showAI ? '‚ñº' : '‚ñ∂'}</span>\r\n                    </button>\r\n\r\n                    {showAI && (\r\n                        <div className=\"bg-gradient-to-br from-primary/5 to-transparent border border-primary/10 rounded-lg p-3 space-y-2 text-xs\">\r\n                            <div className=\"space-y-1.5\">\r\n                                {item.aiSummary?.map((bullet, i) => (\r\n                                    <div key={i} className=\"flex gap-2\">\r\n                                        <span className=\"text-primary/60 flex-shrink-0\">‚Ä¢</span>\r\n                                        <span className=\"text-foreground/80\">{bullet}</span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n\r\n                            {item.whyItMatters && (\r\n                                <div className=\"pt-2 border-t border-primary/10\">\r\n                                    <div className=\"font-semibold text-primary/80 mb-1\">Why It Matters</div>\r\n                                    <p className=\"text-foreground/70 italic\">{item.whyItMatters}</p>\r\n                                </div>\r\n                            )}\r\n\r\n                            <div className=\"text-[10px] text-muted-foreground/60 pt-1 border-t border-primary/5\">\r\n                                AI-generated summary. Read full article for complete context.\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\news\\news-feed.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\news\\stock-ticker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\notifications\\notification-badge.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Bell' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Bell"},"fix":{"range":[125,161],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getUnreadCount } from \"@/app/actions/notifications\";\r\nimport { Bell } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nexport function NotificationBadge({ className }: { className?: string }) {\r\n    const [count, setCount] = useState(0);\r\n\r\n    useEffect(() => {\r\n        // Initial load\r\n        getUnreadCount().then(setCount);\r\n\r\n        // Simple poll every 30s to keep it somewhat fresh without socket overhead\r\n        const interval = setInterval(() => {\r\n            getUnreadCount().then(setCount);\r\n        }, 30000);\r\n\r\n        return () => clearInterval(interval);\r\n    }, []);\r\n\r\n    if (count === 0) return null;\r\n\r\n    return (\r\n        <span className={cn(\r\n            \"absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-gradient-to-r from-red-500 to-pink-500 text-[10px] font-bold text-white shadow-sm ring-2 ring-white dark:ring-black animate-in zoom-in duration-300\",\r\n            className\r\n        )}>\r\n            <span className=\"absolute inline-flex h-full w-full animate-ping rounded-full bg-red-400 opacity-75\"></span>\r\n            <span className=\"relative\">{count > 9 ? \"9+\" : count}</span>\r\n        </span>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\notifications\\notifications-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Card' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Card"},"fix":{"range":[311,355],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isPending' is assigned a value but never used.","line":19,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect, useTransition } from \"react\";\r\nimport { getNotifications, markAsRead, markAllAsRead, Notification } from \"@/app/actions/notifications\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { CheckCheck, Heart, MessageCircle, UserPlus, Users } from \"lucide-react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport Link from \"next/link\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\nexport function NotificationsList() {\r\n    const { t } = useLanguage();\r\n    const [notifications, setNotifications] = useState<Notification[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isPending, startTransition] = useTransition();\r\n    const router = useRouter();\r\n\r\n    useEffect(() => {\r\n        loadNotifications();\r\n    }, []);\r\n\r\n    async function loadNotifications() {\r\n        try {\r\n            const data = await getNotifications();\r\n            setNotifications(data);\r\n        } catch (error) {\r\n            console.error(\"Failed to load notifications:\", error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }\r\n\r\n    async function handleMarkAllRead() {\r\n        startTransition(async () => {\r\n            await markAllAsRead();\r\n            setNotifications(prev => prev.map(n => ({ ...n, read: true })));\r\n            router.replace(window.location.href); // Soft refresh\r\n        });\r\n    }\r\n\r\n    async function handleClick(notification: Notification) {\r\n        if (!notification.read) {\r\n            await markAsRead(notification.id);\r\n            setNotifications(prev => prev.map(n => n.id === notification.id ? { ...n, read: true } : n));\r\n        }\r\n\r\n        // Navigate based on type\r\n        switch (notification.type) {\r\n            case 'like':\r\n            case 'comment':\r\n                // Ideally scroll to post? For now just go to feed maybe or we have a single post view?\r\n                // We don't have a single post view yet (except group/branding feeds). \r\n                // Let's assume we go home for now.\r\n                router.push('/');\r\n                break;\r\n            case 'message':\r\n                router.push(notification.referenceId ? `/messages?chatId=${notification.referenceId}` : '/messages');\r\n                break;\r\n            case 'follow':\r\n                router.push(`/branding/${notification.referenceId}`);\r\n                break;\r\n            case 'group_invite':\r\n                router.push(`/groups/${notification.referenceId}`);\r\n                break;\r\n        }\r\n    }\r\n\r\n    function getNotificationText(n: Notification) {\r\n        switch (n.type) {\r\n            case 'like': return t('notification.action.liked');\r\n            case 'message': return n.meta?.message || t('notification.action.message_sent');\r\n            case 'comment': return t('notification.action.commented');\r\n            case 'follow': return `${t('notification.action.followed')} ${n.meta?.brandingName || t('notification.branding.yours')}.`;\r\n            case 'group_invite': return t('notification.action.group_invite');\r\n            default: return t('notification.action.default');\r\n        }\r\n    }\r\n\r\n    if (loading) return <div className=\"p-8 text-center text-muted-foreground\">{t('notifications.loading')}</div>;\r\n\r\n    if (notifications.length === 0) {\r\n        return (\r\n            <div className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n                <div className=\"bg-muted w-16 h-16 rounded-full flex items-center justify-center mb-4\">\r\n                    <CheckCheck className=\"w-8 h-8 text-muted-foreground\" />\r\n                </div>\r\n                <h3 className=\"text-lg font-medium\">{t('notifications.caught_up')}</h3>\r\n                <p className=\"text-muted-foreground\">{t('notifications.no_new')}</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"flex justify-between items-center mb-4\">\r\n                <h2 className=\"text-xl font-semibold\">{t('notifications.title')}</h2>\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={handleMarkAllRead} className=\"text-muted-foreground\">\r\n                    {t('notifications.mark_read')}\r\n                </Button>\r\n            </div>\r\n\r\n            {notifications.map(notification => (\r\n                <div\r\n                    key={notification.id}\r\n                    onClick={() => handleClick(notification)}\r\n                    className={cn(\r\n                        \"flex items-start gap-4 p-4 rounded-lg cursor-pointer transition-colors border-b last:border-0\",\r\n                        notification.read ? \"bg-background/50 opacity-80\" : \"bg-blue-50/50 dark:bg-blue-950/20\"\r\n                    )}\r\n                >\r\n                    {notification.sender?.id ? (\r\n                        <Link href={`/u/${notification.sender.id}`} onClick={(e) => e.stopPropagation()}>\r\n                            <Avatar className=\"w-10 h-10 border border-border cursor-pointer hover:opacity-80 transition-opacity\">\r\n                                <AvatarImage src={notification.sender.imageUrl || \"\"} />\r\n                                <AvatarFallback>{notification.sender.displayName?.[0] || \"?\"}</AvatarFallback>\r\n                            </Avatar>\r\n                        </Link>\r\n                    ) : (\r\n                        <Avatar className=\"w-10 h-10 border border-border\">\r\n                            <AvatarImage src={notification.sender?.imageUrl || \"\"} />\r\n                            <AvatarFallback>{notification.sender?.displayName?.[0] || \"?\"}</AvatarFallback>\r\n                        </Avatar>\r\n                    )}\r\n\r\n                    <div className=\"flex-1 space-y-1\">\r\n                        <p className=\"text-sm\">\r\n                            {notification.sender?.id ? (\r\n                                <Link\r\n                                    href={`/u/${notification.sender.id}`}\r\n                                    onClick={(e) => e.stopPropagation()}\r\n                                    className=\"font-semibold hover:underline\"\r\n                                >\r\n                                    {notification.sender.displayName || t('notifications.someone')}\r\n                                </Link>\r\n                            ) : (\r\n                                <span className=\"font-semibold\">{notification.sender?.displayName || t('notifications.someone')}</span>\r\n                            )}\r\n                            {\" \"}\r\n                            {getNotificationText(notification)}\r\n                        </p>\r\n                        {notification.meta?.postPreview && (\r\n                            <p className=\"text-xs text-muted-foreground line-clamp-1 italic\">\r\n                                \"{notification.meta.postPreview}\"\r\n                            </p>\r\n                        )}\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                            {formatDistanceToNow(new Date(notification.createdAt), { addSuffix: true })}\r\n                        </p>\r\n                    </div>\r\n\r\n                    <div className=\"text-muted-foreground\">\r\n                        {getIcon(notification.type)}\r\n                    </div>\r\n\r\n                    {!notification.read && (\r\n                        <div className=\"w-2 h-2 bg-blue-500 rounded-full mt-2\" />\r\n                    )}\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n\r\n\r\n\r\nfunction getIcon(type: string) {\r\n    switch (type) {\r\n        case 'like': return <Heart className=\"w-4 h-4 text-red-500 fill-red-500\" />;\r\n        case 'message': return <MessageCircle className=\"w-4 h-4 text-primary\" />;\r\n        case 'comment': return <MessageCircle className=\"w-4 h-4 text-blue-500\" />;\r\n        case 'follow': return <UserPlus className=\"w-4 h-4 text-green-500\" />;\r\n        case 'group_invite': return <Users className=\"w-4 h-4 text-purple-500\" />;\r\n        default: return <CheckCheck className=\"w-4 h-4\" />;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\onboarding\\birthday-onboarding.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":42,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { updateProfile } from \"@/app/actions/settings\";\r\nimport { toast } from \"sonner\";\r\nimport { PartyPopper } from \"lucide-react\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\n\r\nexport function BirthdayOnboarding({ currentBirthday }: { currentBirthday: string | null }) {\r\n    const { user } = useAuth();\r\n    const [open, setOpen] = useState(false);\r\n    const [birthday, setBirthday] = useState(\"\");\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n    useEffect(() => {\r\n        // Only show if user is loaded and birthday is missing\r\n        if (user && !currentBirthday) {\r\n            // Add a small delay so it doesn't pop up instantly on load\r\n            const timer = setTimeout(() => {\r\n                setOpen(true);\r\n            }, 2000);\r\n            return () => clearTimeout(timer);\r\n        }\r\n    }, [user, currentBirthday]);\r\n\r\n    const handleSubmit = async () => {\r\n        // Simple validation for MM-DD format\r\n        const regex = /^(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])$/;\r\n        if (!regex.test(birthday)) {\r\n            toast.error(\"Please enter format MM-DD (e.g. 12-25)\");\r\n            return;\r\n        }\r\n\r\n        setIsSubmitting(true);\r\n        try {\r\n            await updateProfile({ birthday });\r\n            toast.success(\"Birthday saved! Get ready for balloons! üéà\");\r\n            setOpen(false);\r\n        } catch (error) {\r\n            toast.error(\"Failed to save birthday\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    if (!open) return null;\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={setOpen}>\r\n            <DialogContent className=\"sm:max-w-[425px]\">\r\n                <DialogHeader>\r\n                    <div className=\"mx-auto bg-primary/10 p-4 rounded-full mb-4\">\r\n                        <PartyPopper className=\"w-10 h-10 text-primary\" />\r\n                    </div>\r\n                    <DialogTitle className=\"text-center text-xl\">When is your birthday?</DialogTitle>\r\n                    <DialogDescription className=\"text-center\">\r\n                        We want to celebrate with you! Enter your birthday so the family can send you meaningful wishes.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n                <div className=\"flex flex-col gap-4 py-4\">\r\n                    <Input\r\n                        placeholder=\"MM-DD (e.g. 05-20)\"\r\n                        value={birthday}\r\n                        onChange={(e) => setBirthday(e.target.value)}\r\n                        className=\"text-center text-lg tracking-widest\"\r\n                        maxLength={5}\r\n                    />\r\n                </div>\r\n                <DialogFooter>\r\n                    <Button variant=\"ghost\" onClick={() => setOpen(false)}>Skip for now</Button>\r\n                    <Button onClick={handleSubmit} disabled={isSubmitting || !birthday}>\r\n                        {isSubmitting ? \"Saving...\" : \"Save Celebration\"}\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\profile\\block-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":31,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { blockUser, unblockUser } from \"@/app/actions/security\";\r\nimport { toast } from \"sonner\";\r\nimport { Ban, CheckCircle } from \"lucide-react\";\r\nimport { useState } from \"react\";\r\n\r\ninterface BlockButtonProps {\r\n    targetUserId: string;\r\n    isBlocked?: boolean;\r\n    className?: string;\r\n}\r\n\r\nexport function BlockButton({ targetUserId, isBlocked: initialBlocked = false, className }: BlockButtonProps) {\r\n    const [isBlocked, setIsBlocked] = useState(initialBlocked);\r\n    const [isLoading, setIsLoading] = useState(false);\r\n\r\n    const handleToggleBlock = async () => {\r\n        setIsLoading(true);\r\n        try {\r\n            if (isBlocked) {\r\n                await unblockUser(targetUserId);\r\n                toast.success(\"User unblocked\");\r\n                setIsBlocked(false);\r\n            } else {\r\n                await blockUser(targetUserId);\r\n                toast.error(\"User blocked\"); // Using error style for blocking action often fits better conceptually (destructive), or use custom\r\n                setIsBlocked(true);\r\n            }\r\n        } catch (error) {\r\n            toast.error(\"Failed to update block status\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Button\r\n            variant={isBlocked ? \"outline\" : \"destructive\"}\r\n            size=\"sm\"\r\n            onClick={handleToggleBlock}\r\n            disabled={isLoading}\r\n            className={className}\r\n        >\r\n            {isBlocked ? (\r\n                <>\r\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\r\n                    Unblock\r\n                </>\r\n            ) : (\r\n                <>\r\n                    <Ban className=\"w-4 h-4 mr-2\" />\r\n                    Block\r\n                </>\r\n            )}\r\n        </Button>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\profile\\deleted-feed.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'t' is assigned a value but never used.","line":23,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":14},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[827,830],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[827,830],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchDeleted'. Either include it or remove the dependency array.","line":43,"column":8,"nodeType":"ArrayExpression","endLine":43,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [fetchDeleted, userId]","fix":{"range":[1386,1394],"text":"[fetchDeleted, userId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { getDeletedPosts, permanentDeletePost, restorePost } from \"@/app/actions/posts\";\r\nimport { toast } from \"sonner\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Loader2, Trash2, RefreshCcw, AlertTriangle } from \"lucide-react\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\nimport {\r\n    AlertDialog,\r\n    AlertDialogAction,\r\n    AlertDialogCancel,\r\n    AlertDialogContent,\r\n    AlertDialogDescription,\r\n    AlertDialogFooter,\r\n    AlertDialogHeader,\r\n    AlertDialogTitle,\r\n    AlertDialogTrigger,\r\n} from \"@/components/ui/alert-dialog\";\r\n\r\nexport function DeletedFeed({ userId }: { userId: string }) {\r\n    const { t } = useLanguage();\r\n    const [posts, setPosts] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [processingId, setProcessingId] = useState<string | null>(null);\r\n\r\n    const fetchDeleted = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await getDeletedPosts(userId);\r\n            setPosts(data);\r\n        } catch (error) {\r\n            console.error(error);\r\n            toast.error(\"Failed to load deleted posts\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchDeleted();\r\n    }, [userId]);\r\n\r\n    const handleRestore = async (postId: string) => {\r\n        setProcessingId(postId);\r\n        try {\r\n            await restorePost(postId);\r\n            toast.success(\"Post restored to timeline\");\r\n            setPosts(prev => prev.filter(p => p.id !== postId));\r\n        } catch {\r\n            toast.error(\"Restore failed\");\r\n        } finally {\r\n            setProcessingId(null);\r\n        }\r\n    };\r\n\r\n    const handlePermanentDelete = async (postId: string) => {\r\n        setProcessingId(postId);\r\n        try {\r\n            await permanentDeletePost(postId);\r\n            toast.success(\"Post deleted permanently\");\r\n            setPosts(prev => prev.filter(p => p.id !== postId));\r\n        } catch {\r\n            toast.error(\"Delete failed\");\r\n        } finally {\r\n            setProcessingId(null);\r\n        }\r\n    };\r\n\r\n    if (loading) return <div className=\"flex justify-center p-8\"><Loader2 className=\"animate-spin h-8 w-8 text-primary\" /></div>;\r\n\r\n    if (posts.length === 0) {\r\n        return (\r\n            <div className=\"flex flex-col items-center justify-center p-12 text-center border rounded-xl bg-slate-50 dark:bg-slate-900/50\">\r\n                <Trash2 className=\"h-12 w-12 text-slate-300 mb-4\" />\r\n                <h3 className=\"text-lg font-medium text-slate-900 dark:text-slate-100\">Trash is empty</h3>\r\n                <p className=\"text-slate-500 max-w-sm mt-2\">Deleted posts stay here for 10 days before disappearing forever.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            <div className=\"bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg flex gap-3 text-sm text-yellow-800 dark:text-yellow-200 border border-yellow-200 dark:border-yellow-900\">\r\n                <AlertTriangle className=\"h-5 w-5 shrink-0\" />\r\n                <p>Items in the trash are permanently deleted after 10 days.</p>\r\n            </div>\r\n\r\n            <div className=\"grid gap-4\">\r\n                {posts.map((post) => (\r\n                    <div key={post.id} className=\"bg-card border rounded-lg p-4 flex flex-col gap-3 relative overflow-hidden\">\r\n                        <div className=\"flex justify-between items-start\">\r\n                            <div className=\"text-sm text-muted-foreground\">\r\n                                Deleted {post.deletedAt ? formatDistanceToNow(new Date(post.deletedAt), { addSuffix: true }) : 'recently'}\r\n                            </div>\r\n                            {post.permanentDeleteAt && (\r\n                                <div className=\"text-xs font-medium text-red-500 bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded\">\r\n                                    Expires {formatDistanceToNow(new Date(post.permanentDeleteAt), { addSuffix: true })}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"p-3 bg-muted/50 rounded-md text-sm line-clamp-3\">\r\n                            {post.content || <span className=\"italic text-muted-foreground\">No text content</span>}\r\n                            {post.mediaUrls?.length > 0 && (\r\n                                <div className=\"mt-2 text-xs text-blue-500 font-medium flex items-center gap-1\">\r\n                                    <span className=\"w-2 h-2 bg-blue-500 rounded-full\"></span>\r\n                                    Contains {post.mediaUrls.length} attachment(s)\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"flex gap-2 justify-end mt-2\">\r\n                            <AlertDialog>\r\n                                <AlertDialogTrigger asChild>\r\n                                    <Button variant=\"ghost\" size=\"sm\" className=\"text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-950/50\" disabled={!!processingId}>\r\n                                        <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                                        Delete Forever\r\n                                    </Button>\r\n                                </AlertDialogTrigger>\r\n                                <AlertDialogContent>\r\n                                    <AlertDialogHeader>\r\n                                        <AlertDialogTitle>Delete permanently?</AlertDialogTitle>\r\n                                        <AlertDialogDescription>\r\n                                            This action cannot be undone. This post will be immediately removed from our servers.\r\n                                        </AlertDialogDescription>\r\n                                    </AlertDialogHeader>\r\n                                    <AlertDialogFooter>\r\n                                        <AlertDialogCancel>Cancel</AlertDialogCancel>\r\n                                        <AlertDialogAction\r\n                                            onClick={() => handlePermanentDelete(post.id)}\r\n                                            className=\"bg-red-600 hover:bg-red-700 text-white\"\r\n                                        >\r\n                                            Delete Forever\r\n                                        </AlertDialogAction>\r\n                                    </AlertDialogFooter>\r\n                                </AlertDialogContent>\r\n                            </AlertDialog>\r\n\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                onClick={() => handleRestore(post.id)}\r\n                                disabled={!!processingId}\r\n                            >\r\n                                {processingId === post.id ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <RefreshCcw className=\"h-4 w-4 mr-2\" />}\r\n                                Restore\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\profile\\family-members-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\profile\\profile-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showExitDialog' is assigned a value but never used.","line":65,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setShowExitDialog' is assigned a value but never used.","line":65,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isDirty' is assigned a value but never used.","line":101,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":101,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":205,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8859,8862],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8859,8862],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":230,"column":45,"nodeType":"JSXOpeningElement","endLine":230,"endColumn":118},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":258,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":258,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12300,12303],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12300,12303],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useRouter } from \"next/navigation\"\r\nimport { zodResolver } from \"@hookform/resolvers/zod\"\r\nimport { useForm } from \"react-hook-form\"\r\nimport * as z from \"zod\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n    Form,\r\n    FormControl,\r\n    FormDescription,\r\n    FormField,\r\n    FormItem,\r\n    FormLabel,\r\n    FormMessage,\r\n} from \"@/components/ui/form\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { toast } from \"sonner\"\r\nimport { updateProfile } from \"@/app/actions/settings\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { useState } from \"react\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { useLanguage } from \"@/components/language-context\"\r\nimport { ArrowLeft } from \"lucide-react\"\r\nimport { storage } from \"@/lib/firebase\"\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\"\r\n\r\n\r\nconst profileFormSchema = z.object({\r\n    displayName: z.string().min(2, {\r\n        message: \"Display name must be at least 2 characters.\",\r\n    }).refine((val) => val.trim().split(/\\s+/).length >= 2, {\r\n        message: \"Please enter your First and Last Name\",\r\n    }),\r\n    bio: z.string().max(160).optional(),\r\n    imageUrl: z.string().optional(),\r\n    coverUrl: z.string().optional(),\r\n    coverType: z.string().optional(),\r\n    birthday: z.string().optional(),\r\n})\r\n\r\ntype ProfileFormValues = z.infer<typeof profileFormSchema>\r\n\r\ninterface ProfileContentProps {\r\n    user: {\r\n        id: string;\r\n        displayName?: string | null;\r\n        imageUrl?: string | null;\r\n        coverUrl?: string | null;\r\n        coverType?: string | null;\r\n        bio?: string | null;\r\n        birthday?: string | null;\r\n    }\r\n    onClose?: () => void;\r\n}\r\n\r\nexport function ProfileContent({ user, onClose }: ProfileContentProps) {\r\n    const router = useRouter()\r\n    const { t } = useLanguage()\r\n\r\n    const [imageUrl, setImageUrl] = useState<string | undefined>(user.imageUrl || undefined)\r\n    const [coverUrl, setCoverUrl] = useState<string | undefined>(user.coverUrl || undefined)\r\n    const [coverType, setCoverType] = useState<'image' | 'video' | undefined>(user.coverType as 'image' | 'video' || undefined)\r\n    const [showExitDialog, setShowExitDialog] = useState(false)\r\n\r\n    const form = useForm<ProfileFormValues>({\r\n        resolver: zodResolver(profileFormSchema),\r\n        defaultValues: {\r\n            displayName: user.displayName || \"\",\r\n            bio: user.bio || \"\",\r\n            imageUrl: user.imageUrl || \"\",\r\n            coverUrl: user.coverUrl || \"\",\r\n            coverType: user.coverType || \"\",\r\n            birthday: user.birthday || \"\",\r\n        },\r\n    })\r\n\r\n    async function onSubmit(data: ProfileFormValues) {\r\n        try {\r\n            await updateProfile({\r\n                ...data,\r\n                imageUrl: imageUrl,\r\n                coverUrl: coverUrl,\r\n                coverType: coverType,\r\n                birthday: data.birthday\r\n            })\r\n            form.reset({ ...data, imageUrl, coverUrl, coverType, birthday: data.birthday })\r\n            toast.success(\"Profile updated\")\r\n            router.refresh()\r\n            if (onClose) onClose();\r\n        } catch {\r\n            toast.error(\"Failed to update profile\")\r\n        }\r\n    }\r\n\r\n    // State for in-place confirmation to avoid z-index/portal issues\r\n    const [confirmingExit, setConfirmingExit] = useState(false);\r\n\r\n    // Unsaved changes logic\r\n    const { isDirty } = form.formState;\r\n\r\n    const handleExit = () => {\r\n        if (form.formState.isDirty) {\r\n            setConfirmingExit(true);\r\n        } else {\r\n            if (onClose) onClose();\r\n            else router.back();\r\n        }\r\n    };\r\n\r\n    const handleDiscardAndExit = () => {\r\n        if (onClose) onClose();\r\n        else router.back();\r\n    };\r\n\r\n    const handleSaveAndExit = async () => {\r\n        await form.handleSubmit(async (data) => {\r\n            await onSubmit(data);\r\n        })();\r\n    };\r\n\r\n    if (confirmingExit) {\r\n        return (\r\n            <div className=\"space-y-6\">\r\n                <div className=\"flex items-center justify-between mb-4\">\r\n                    <h2 className=\"text-2xl font-bold tracking-tight text-red-600\">Unsaved Changes</h2>\r\n                </div>\r\n                <Card className=\"border-red-200 bg-red-50 dark:bg-red-950/20\">\r\n                    <CardHeader>\r\n                        <CardTitle>You have unsaved changes</CardTitle>\r\n                        <CardDescription>\r\n                            If you leave now, your changes will be lost. What would you like to do?\r\n                        </CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent className=\"flex flex-col gap-3\">\r\n                        <Button onClick={handleSaveAndExit} className=\"w-full\">Save & Exit</Button>\r\n                        <Button variant=\"outline\" onClick={handleDiscardAndExit} className=\"w-full border-red-200 hover:bg-red-100 hover:text-red-900 dark:hover:bg-red-900/40\">\r\n                            Discard Changes & Exit\r\n                        </Button>\r\n                        <Button variant=\"ghost\" onClick={() => setConfirmingExit(false)} className=\"w-full\">\r\n                            Keep Editing\r\n                        </Button>\r\n                    </CardContent>\r\n                </Card>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n                <div>\r\n                    <h2 className=\"text-2xl font-bold tracking-tight\">{t(\"profile.title\")}</h2>\r\n                    <p className=\"text-muted-foreground\">\r\n                        {t(\"settings.profile.desc\")}\r\n                    </p>\r\n                </div>\r\n                <Button type=\"button\" variant=\"outline\" onClick={handleExit} className=\"gap-2\">\r\n                    <ArrowLeft className=\"w-4 h-4\" />\r\n                    {t(\"profile.back\")}\r\n                </Button>\r\n            </div>\r\n\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle>{t(\"settings.profile.title\")}</CardTitle>\r\n                    <CardDescription>{t(\"settings.profile.desc\")}</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <Form {...form}>\r\n                        <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-8\">\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <Avatar className=\"w-20 h-20\">\r\n                                    <AvatarImage src={imageUrl} />\r\n                                    <AvatarFallback>{user.displayName?.charAt(0) || \"U\"}</AvatarFallback>\r\n                                </Avatar>\r\n                                <div className=\"flex flex-col gap-2\">\r\n                                    <FormLabel>{t(\"settings.profilePic\")}</FormLabel>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Input\r\n                                            type=\"file\"\r\n                                            accept=\"image/*\"\r\n                                            onChange={async (e) => {\r\n                                                const file = e.target.files?.[0];\r\n                                                if (!file) return;\r\n\r\n                                                try {\r\n                                                    const { getAuth } = await import(\"firebase/auth\");\r\n                                                    const auth = getAuth();\r\n                                                    if (!auth.currentUser) {\r\n                                                        toast.error(\"Client session invalid. Please refresh.\");\r\n                                                        return;\r\n                                                    }\r\n\r\n                                                    toast.info(\"Uploading...\");\r\n\r\n                                                    const storageRef = ref(storage, `users/${user.id}/profile/${file.name}`);\r\n                                                    await uploadBytes(storageRef, file);\r\n                                                    const url = await getDownloadURL(storageRef);\r\n\r\n                                                    setImageUrl(url);\r\n                                                    form.setValue('imageUrl', url, { shouldDirty: true, shouldTouch: true, shouldValidate: true });\r\n                                                    toast.success(\"Upload complete\");\r\n                                                } catch (error: any) {\r\n                                                    console.error(\"Upload failed\", error);\r\n                                                    toast.error(`Error uploading: ${error.message || \"Unknown error\"}`);\r\n                                                }\r\n                                            }}\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Cover Upload */}\r\n                            <div className=\"flex flex-col gap-2\">\r\n                                <FormLabel>{t(\"settings.cover\")}</FormLabel>\r\n                                {coverUrl && (\r\n                                    <div className=\"relative w-full h-32 rounded-md overflow-hidden bg-muted mb-2\">\r\n                                        {coverUrl.includes(\"mp4\") || coverUrl.includes(\"webm\") ? (\r\n                                            <video\r\n                                                src={coverUrl}\r\n                                                className=\"w-full h-full object-cover\"\r\n                                                style={{ objectPosition: 'center 10%' }}\r\n                                                autoPlay\r\n                                                loop\r\n                                                muted\r\n                                            />\r\n                                        ) : (\r\n                                            <img src={coverUrl} alt=\"Cover\" className=\"w-full h-full object-cover\" />\r\n                                        )}\r\n                                    </div>\r\n                                )}\r\n                                <Input\r\n                                    type=\"file\"\r\n                                    accept=\"image/*,video/*\"\r\n                                    onChange={async (e) => {\r\n                                        const file = e.target.files?.[0];\r\n                                        if (!file) return;\r\n\r\n                                        try {\r\n                                            toast.info(\"Uploading cover...\");\r\n\r\n                                            const storageRef = ref(storage, `users/${user.id}/cover/${file.name}`);\r\n                                            await uploadBytes(storageRef, file);\r\n                                            const url = await getDownloadURL(storageRef);\r\n\r\n                                            setCoverUrl(url);\r\n                                            // Enhanced video detection: Check MIME type OR file extension\r\n                                            const isVideo = file.type.startsWith('video') || file.name.toLowerCase().endsWith('.mov') || file.name.toLowerCase().endsWith('.mp4');\r\n                                            const type = isVideo ? 'video' : 'image';\r\n                                            setCoverType(type);\r\n\r\n                                            form.setValue('coverUrl', url, { shouldDirty: true, shouldTouch: true, shouldValidate: true });\r\n                                            form.setValue('coverType', type, { shouldDirty: true, shouldTouch: true, shouldValidate: true });\r\n\r\n                                            toast.success(\"Cover uploaded\");\r\n                                        } catch (error: any) {\r\n                                            console.error(\"Upload failed\", error);\r\n                                            toast.error(`Error uploading: ${error.message || \"Unknown error\"}`);\r\n                                        }\r\n                                    }}\r\n                                />\r\n                            </div>\r\n\r\n                            <FormField\r\n                                control={form.control}\r\n                                name=\"displayName\"\r\n                                render={({ field }) => (\r\n                                    <FormItem>\r\n                                        <FormLabel>{t(\"settings.displayName\")}</FormLabel>\r\n                                        <FormControl>\r\n                                            <Input placeholder=\"John Doe\" {...field} />\r\n                                        </FormControl>\r\n                                        <FormDescription>{t(\"settings.displayName.desc\")}</FormDescription>\r\n                                        <FormMessage />\r\n                                    </FormItem>\r\n                                )}\r\n                            />\r\n                            <FormField\r\n                                control={form.control}\r\n                                name=\"bio\"\r\n                                render={({ field }) => (\r\n                                    <FormItem>\r\n                                        <FormLabel>{t(\"settings.bio\")}</FormLabel>\r\n                                        <FormControl>\r\n                                            <Textarea\r\n                                                placeholder=\"Tell us a little bit about yourself\"\r\n                                                className=\"resize-none\"\r\n                                                {...field}\r\n                                            />\r\n                                        </FormControl>\r\n                                        <FormDescription>{t(\"settings.bio.desc\")}</FormDescription>\r\n                                        <FormMessage />\r\n                                    </FormItem>\r\n                                )}\r\n                            />\r\n                            <FormField\r\n                                control={form.control}\r\n                                name=\"birthday\"\r\n                                render={({ field }) => (\r\n                                    <FormItem>\r\n                                        <FormLabel>Birthday</FormLabel>\r\n                                        <FormControl>\r\n                                            <Input type=\"text\" placeholder=\"MM-DD\" {...field} />\r\n                                        </FormControl>\r\n                                        <FormDescription>MM-DD (e.g., 12-25)</FormDescription>\r\n                                        <FormMessage />\r\n                                    </FormItem>\r\n                                )}\r\n                            />\r\n                            <Button type=\"submit\">{t(\"settings.updateProfile\")}</Button>\r\n                        </form>\r\n                    </Form>\r\n                </CardContent>\r\n            </Card>\r\n        </div >\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\profile\\profile-feed.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\profile\\profile-header.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":50,"column":25,"nodeType":"JSXOpeningElement","endLine":54,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5691,5694],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5691,5694],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { useLanguage } from \"@/components/language-context\"\r\nimport { Edit2, BookHeart } from \"lucide-react\"\r\nimport { useState } from \"react\"\r\nimport { Dialog, DialogContent, DialogTrigger } from \"@/components/ui/dialog\"\r\nimport { ProfileContent } from \"./profile-content\"\r\nimport { BlockButton } from \"@/components/profile/block-button\"\r\nimport { toast } from \"sonner\"\r\nimport { ProfileShareButton } from \"@/components/profile/profile-share-button\"\r\n\r\ninterface ProfileHeaderProps {\r\n    user: {\r\n        id: string;\r\n        displayName?: string | null;\r\n        imageUrl?: string | null;\r\n        coverUrl?: string | null;\r\n        coverType?: string | null;\r\n        bio?: string | null;\r\n        isPublicProfile?: boolean;\r\n    };\r\n    isCurrentUser?: boolean;\r\n    isBlocked?: boolean;\r\n}\r\n\r\nexport function ProfileHeader({ user, isCurrentUser, isBlocked }: ProfileHeaderProps) {\r\n    const { t } = useLanguage()\r\n    const [isEditing, setIsEditing] = useState(false)\r\n\r\n    const initials = user.displayName?.slice(0, 2).toUpperCase() || \"U\"\r\n\r\n    return (\r\n        <div className=\"relative mb-8\">\r\n            {/* Cover Photo/Video */}\r\n            <div className=\"relative h-48 md:h-64 rounded-xl overflow-hidden bg-muted group\">\r\n                {user.coverUrl ? (\r\n                    user.coverType === 'video' ? (\r\n                        <video\r\n                            src={user.coverUrl}\r\n                            className=\"w-full h-full object-cover\"\r\n                            style={{ objectPosition: 'center 10%' }}\r\n                            autoPlay\r\n                            loop\r\n                            muted\r\n                            playsInline\r\n                        />\r\n                    ) : (\r\n                        <img\r\n                            src={user.coverUrl}\r\n                            alt=\"Cover\"\r\n                            className=\"w-full h-full object-cover\"\r\n                        />\r\n                    )\r\n                ) : (\r\n                    <div className=\"w-full h-full bg-gradient-to-r from-blue-500/20 to-purple-500/20\" />\r\n                )}\r\n            </div>\r\n\r\n            {/* Avatar & Profile Info */}\r\n            <div className=\"px-4 -mt-12 sm:-mt-16 sm:px-6 relative z-10\">\r\n                <div className=\"flex flex-col sm:flex-row sm:items-end sm:justify-between sm:space-x-5\">\r\n                    <div className=\"flex\">\r\n                        <Avatar className=\"h-24 w-24 sm:h-32 sm:w-32 rounded-full ring-4 ring-white dark:ring-slate-950 bg-white\">\r\n                            <AvatarImage src={user.imageUrl || undefined} className=\"object-cover\" />\r\n                            <AvatarFallback className=\"text-2xl font-bold\">{initials}</AvatarFallback>\r\n                        </Avatar>\r\n                    </div>\r\n                    <div className=\"mt-6 sm:flex-1 sm:min-w-0 sm:flex sm:items-center sm:justify-end sm:space-x-6 sm:pb-1\">\r\n                        <div className=\"sm:hidden 2xl:block mt-6 min-w-0 flex-1\">\r\n                            <h1 className=\"text-2xl font-bold text-foreground truncate\">\r\n                                {user.displayName}\r\n                            </h1>\r\n                        </div>\r\n                        <div className=\"mt-6 flex flex-col justify-stretch space-y-3 sm:flex-row sm:space-y-0 sm:space-x-4\">\r\n                            {isCurrentUser ? (\r\n                                <div className=\"flex flex-col w-full gap-3 sm:flex-row sm:w-auto sm:gap-2\">\r\n                                    <Button\r\n                                        variant=\"outline\"\r\n                                        className=\"w-full sm:w-auto flex-1 sm:flex-none gap-2 border-blue-500/20 hover:bg-blue-500/5 text-blue-600 dark:text-blue-400\"\r\n                                        onClick={() => {\r\n                                            const event = new CustomEvent('famio:open-ai', {\r\n                                                detail: {\r\n                                                    mode: 'biographer',\r\n                                                    context: t(\"profile.biographer.context\"),\r\n                                                    type: 'biographer_start'\r\n                                                }\r\n                                            });\r\n                                            window.dispatchEvent(event);\r\n                                            toast.success(t(\"profile.biographer.init\"));\r\n                                        }}\r\n                                    >\r\n                                        <BookHeart className=\"h-4 w-4\" />\r\n                                        {t(\"profile.memory\")}\r\n                                    </Button>\r\n                                    <Dialog open={isEditing} onOpenChange={setIsEditing}>\r\n                                        <DialogTrigger asChild>\r\n                                            <Button variant=\"outline\" className=\"w-full sm:w-auto gap-2\">\r\n                                                <Edit2 className=\"h-4 w-4\" />\r\n                                                {t(\"profile.edit\")}\r\n                                            </Button>\r\n                                        </DialogTrigger>\r\n                                        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n                                            <ProfileContent\r\n                                                user={user as any}\r\n                                                onClose={() => setIsEditing(false)}\r\n                                            />\r\n                                        </DialogContent>\r\n                                    </Dialog>\r\n                                    <div className=\"w-full sm:w-auto\">\r\n                                        <ProfileShareButton\r\n                                            userId={user.id}\r\n                                            displayName={user.displayName || \"Famio Member\"}\r\n                                            isPublic={user.isPublicProfile || false}\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <div className=\"flex flex-col w-full gap-3 sm:flex-row sm:w-auto sm:gap-2\">\r\n                                    <div className=\"w-full sm:w-auto\">\r\n                                        <BlockButton\r\n                                            targetUserId={user.id}\r\n                                            isBlocked={isBlocked}\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"w-full sm:w-auto\">\r\n                                        <ProfileShareButton\r\n                                            userId={user.id}\r\n                                            displayName={user.displayName || \"Famio Member\"}\r\n                                            isPublic={user.isPublicProfile || false}\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"hidden sm:block 2xl:hidden mt-6 min-w-0 flex-1\">\r\n                    <h1 className=\"text-2xl font-bold text-foreground truncate\">\r\n                        {user.displayName}\r\n                    </h1>\r\n                </div>\r\n\r\n                {user.bio && (\r\n                    <p className=\"mt-4 text-muted-foreground max-w-2xl\">\r\n                        {user.bio}\r\n                    </p>\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\profile\\profile-share-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":39,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Share2, Facebook, Linkedin, Twitter, Link as LinkIcon, Check } from \"lucide-react\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface ProfileShareButtonProps {\r\n    userId: string;\r\n    displayName: string;\r\n    isPublic: boolean;\r\n}\r\n\r\nexport function ProfileShareButton({ userId, displayName, isPublic }: ProfileShareButtonProps) {\r\n    const [copied, setCopied] = useState(false);\r\n    const [open, setOpen] = useState(false);\r\n\r\n    // Use actual deployment URL\r\n    const baseUrl = typeof window !== 'undefined'\r\n        ? window.location.origin\r\n        : 'https://we-are-family-221.web.app';\r\n\r\n    const profileUrl = `${baseUrl}/u/${userId}`;\r\n\r\n    const handleCopyLink = async () => {\r\n        try {\r\n            await navigator.clipboard.writeText(profileUrl);\r\n            setCopied(true);\r\n            toast.success(\"Link copied to clipboard!\");\r\n            setTimeout(() => setCopied(false), 2000);\r\n        } catch (error) {\r\n            toast.error(\"Failed to copy link\");\r\n        }\r\n    };\r\n\r\n    const handleShareFacebook = () => {\r\n        const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(profileUrl)}`;\r\n        window.open(fbUrl, '_blank', 'width=600,height=400');\r\n        setOpen(false);\r\n    };\r\n\r\n    const handleShareLinkedIn = () => {\r\n        const liUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(profileUrl)}`;\r\n        window.open(liUrl, '_blank', 'width=600,height=600');\r\n        setOpen(false);\r\n    };\r\n\r\n    const handleShareTwitter = () => {\r\n        const text = `Check out ${displayName}'s profile on Famio`;\r\n        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(profileUrl)}`;\r\n        window.open(twitterUrl, '_blank', 'width=600,height=400');\r\n        setOpen(false);\r\n    };\r\n\r\n    // Show share button by default (profiles are shareable unless explicitly set to private)\r\n    // Only hide if user has explicitly set isPublic to false\r\n    const shouldHide = isPublic === false;\r\n\r\n    if (shouldHide) {\r\n        return null;\r\n    }\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={setOpen}>\r\n            <DialogTrigger asChild>\r\n                <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\r\n                    <Share2 className=\"w-4 h-4\" />\r\n                    Share Profile\r\n                </Button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"sm:max-w-md\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Share Profile</DialogTitle>\r\n                    <DialogDescription>\r\n                        Share {displayName}'s profile on social media or copy the link\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <div className=\"grid gap-3 py-4\">\r\n                    {/* External Share Options */}\r\n                    <button\r\n                        onClick={handleShareFacebook}\r\n                        className=\"flex items-center gap-3 p-4 rounded-lg border border-border hover:bg-muted transition-colors text-left\"\r\n                    >\r\n                        <div className=\"p-2 rounded-full bg-blue-500/10\">\r\n                            <Facebook className=\"w-5 h-5 text-blue-600\" />\r\n                        </div>\r\n                        <div className=\"flex-1\">\r\n                            <div className=\"font-medium\">Share on Facebook</div>\r\n                            <div className=\"text-xs text-muted-foreground\">Post to your timeline</div>\r\n                        </div>\r\n                    </button>\r\n\r\n                    <button\r\n                        onClick={handleShareLinkedIn}\r\n                        className=\"flex items-center gap-3 p-4 rounded-lg border border-border hover:bg-muted transition-colors text-left\"\r\n                    >\r\n                        <div className=\"p-2 rounded-full bg-blue-700/10\">\r\n                            <Linkedin className=\"w-5 h-5 text-blue-700\" />\r\n                        </div>\r\n                        <div className=\"flex-1\">\r\n                            <div className=\"font-medium\">Share on LinkedIn</div>\r\n                            <div className=\"text-xs text-muted-foreground\">Share professionally</div>\r\n                        </div>\r\n                    </button>\r\n\r\n                    <button\r\n                        onClick={handleShareTwitter}\r\n                        className=\"flex items-center gap-3 p-4 rounded-lg border border-border hover:bg-muted transition-colors text-left\"\r\n                    >\r\n                        <div className=\"p-2 rounded-full bg-sky-500/10\">\r\n                            <Twitter className=\"w-5 h-5 text-sky-500\" />\r\n                        </div>\r\n                        <div className=\"flex-1\">\r\n                            <div className=\"font-medium\">Share on X</div>\r\n                            <div className=\"text-xs text-muted-foreground\">Post a tweet</div>\r\n                        </div>\r\n                    </button>\r\n\r\n                    <button\r\n                        onClick={handleCopyLink}\r\n                        className=\"flex items-center gap-3 p-4 rounded-lg border border-border hover:bg-muted transition-colors text-left\"\r\n                    >\r\n                        <div className=\"p-2 rounded-full bg-primary/10\">\r\n                            {copied ? (\r\n                                <Check className=\"w-5 h-5 text-green-600\" />\r\n                            ) : (\r\n                                <LinkIcon className=\"w-5 h-5 text-primary\" />\r\n                            )}\r\n                        </div>\r\n                        <div className=\"flex-1\">\r\n                            <div className=\"font-medium\">{copied ? \"Copied!\" : \"Copy Link\"}</div>\r\n                            <div className=\"text-xs text-muted-foreground truncate\">\r\n                                {profileUrl}\r\n                            </div>\r\n                        </div>\r\n                    </button>\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\profile\\profile-tabs.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PostCard' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"PostCard"},"fix":{"range":[98,153],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Grid' is defined but never used.","line":8,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Grid"},"fix":{"range":[352,357],"text":""},"desc":"Remove unused variable \"Grid\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[666,669],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[666,669],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[693,696],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[693,696],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'activeTab' is assigned a value but never used.","line":24,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isEnabled' is assigned a value but never used.","line":28,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isPaused' is assigned a value but never used.","line":29,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":17},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":53,"column":25,"nodeType":"JSXOpeningElement","endLine":53,"endColumn":54},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":97,"column":37,"nodeType":"JSXOpeningElement","endLine":97,"endColumn":171}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { PostCard } from \"@/components/feed/post-card\";\r\nimport { MasonryFeed } from \"@/components/feed/masonry-feed\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Grid, Image, Film, Users, LayoutList, Trash2 } from \"lucide-react\";\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport { useState } from \"react\";\r\nimport { useAutoScroll } from \"@/hooks/use-auto-scroll\";\r\nimport { DeletedFeed } from \"./deleted-feed\";\r\n\r\ninterface ProfileTabsProps {\r\n    posts: any[];\r\n    familyMembers: any[];\r\n    isOwnProfile: boolean;\r\n    currentUserId?: string;\r\n}\r\n\r\nexport function ProfileTabs({ posts, familyMembers, isOwnProfile, currentUserId }: ProfileTabsProps) {\r\n    const { t } = useLanguage();\r\n    const router = useRouter();\r\n    const [activeTab, setActiveTab] = useState(\"timeline\");\r\n\r\n    // Auto-scroll integration (only active on Timeline tab)\r\n    const {\r\n        isEnabled,\r\n        isPaused,\r\n        containerRef,\r\n    } = useAutoScroll({\r\n        pauseOnHover: true,\r\n        pauseOnInteraction: true,\r\n    });\r\n\r\n    const photos = posts.flatMap(post =>\r\n        (post.mediaUrls || []).filter((url: string) => !url.match(/\\.(mp4|webm)$/i)).map((url: string) => ({ url, postId: post.id }))\r\n    );\r\n\r\n    const videos = posts.flatMap(post =>\r\n        (post.mediaUrls || []).filter((url: string) => url.match(/\\.(mp4|webm)$/i)).map((url: string) => ({ url, postId: post.id }))\r\n    );\r\n\r\n    return (\r\n        <>\r\n            <Tabs defaultValue=\"timeline\" className=\"w-full\" onValueChange={setActiveTab}>\r\n                <TabsList className={`grid w-full mb-8 ${isOwnProfile ? 'grid-cols-5' : 'grid-cols-4'}`}>\r\n                    <TabsTrigger value=\"timeline\" className=\"gap-2\">\r\n                        <LayoutList className=\"w-4 h-4\" />\r\n                        <span className=\"hidden sm:inline\">{t('profile.tabs.timeline')}</span>\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"photos\" className=\"gap-2\">\r\n                        <Image className=\"w-4 h-4\" />\r\n                        <span className=\"hidden sm:inline\">{t('profile.tabs.photos')}</span>\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"videos\" className=\"gap-2\">\r\n                        <Film className=\"w-4 h-4\" />\r\n                        <span className=\"hidden sm:inline\">{t('profile.tabs.videos')}</span>\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"family\" className=\"gap-2\">\r\n                        <Users className=\"w-4 h-4\" />\r\n                        <span className=\"hidden sm:inline\">{t('profile.companions')}</span>\r\n                    </TabsTrigger>\r\n                    {isOwnProfile && (\r\n                        <TabsTrigger value=\"trash\" className=\"gap-2 text-red-500 data-[state=active]:text-red-600\">\r\n                            <Trash2 className=\"w-4 h-4\" />\r\n                            <span className=\"hidden sm:inline\">Trash</span>\r\n                        </TabsTrigger>\r\n                    )}\r\n                </TabsList>\r\n\r\n                <TabsContent value=\"timeline\" className=\"space-y-4\">\r\n                    {posts.length === 0 ? (\r\n                        <div className=\"p-8 text-center border rounded-xl bg-slate-50 dark:bg-slate-900 text-gray-500\">\r\n                            {t('profile.empty.posts')}\r\n                        </div>\r\n                    ) : (\r\n                        <div\r\n                            ref={containerRef}\r\n                            className=\"max-h-[calc(100vh-300px)] md:max-h-[calc(100vh-350px)] overflow-y-auto scroll-smooth overscroll-contain\"\r\n                            style={{ WebkitOverflowScrolling: 'touch' } as React.CSSProperties}\r\n                        >\r\n                            <MasonryFeed posts={posts} currentUserId={currentUserId} />\r\n                        </div>\r\n                    )}\r\n                </TabsContent>\r\n\r\n                <TabsContent value=\"photos\">\r\n                    {photos.length === 0 ? (\r\n                        <div className=\"p-8 text-center border rounded-xl bg-slate-50 dark:bg-slate-900 text-gray-500\">\r\n                            {t('profile.empty.photos')}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\r\n                            {photos.map((item, idx) => (\r\n                                <div key={idx} className=\"aspect-square rounded-lg overflow-hidden relative group cursor-pointer\" onClick={() => router.push(`/post/${item.postId}`)}>\r\n                                    <img src={item.url} alt=\"User photo\" className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-110\" />\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </TabsContent>\r\n\r\n                <TabsContent value=\"videos\">\r\n                    {videos.length === 0 ? (\r\n                        <div className=\"p-8 text-center border rounded-xl bg-slate-50 dark:bg-slate-900 text-gray-500\">\r\n                            {t('profile.empty.videos')}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\r\n                            {videos.map((item, idx) => (\r\n                                <div key={idx} className=\"aspect-square rounded-lg overflow-hidden relative group bg-black\">\r\n                                    <video src={item.url} className=\"w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity\" controls />\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </TabsContent>\r\n\r\n                <TabsContent value=\"family\">\r\n                    {familyMembers.length === 0 ? (\r\n                        <div className=\"p-8 text-center border rounded-xl bg-slate-50 dark:bg-slate-900 text-gray-500\">\r\n                            {t('profile.empty.family')}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                            {familyMembers.map((member) => (\r\n                                <div key={member.id} className=\"flex items-center gap-3 p-4 bg-white dark:bg-card border rounded-lg hover:border-primary transition-colors cursor-pointer\" onClick={() => router.push(`/u/${member.id}`)}>\r\n                                    <Avatar className=\"h-12 w-12 shrink-0\">\r\n                                        <AvatarImage src={member.imageUrl || undefined} className=\"object-cover\" />\r\n                                        <AvatarFallback>{member.displayName?.charAt(0)}</AvatarFallback>\r\n                                    </Avatar>\r\n                                    <div>\r\n                                        <p className=\"font-semibold\">{member.displayName}</p>\r\n                                        <p className=\"text-sm text-gray-500\">{t('profile.role.companion')}</p>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </TabsContent>\r\n\r\n                {isOwnProfile && (\r\n                    <TabsContent value=\"trash\">\r\n                        <DeletedFeed userId={currentUserId || \"\"} />\r\n                    </TabsContent>\r\n                )}\r\n            </Tabs>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\reporting\\report-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[767,770],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[767,770],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { AlertTriangle, Loader2 } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { createReport, ReportReason } from \"@/app/actions/reporting\";\r\n\r\ninterface ReportDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    targetType: 'post' | 'comment' | 'group' | 'branding' | 'user';\r\n    targetId: string;\r\n    context?: any;\r\n}\r\n\r\nconst REASONS: { value: ReportReason; label: string }[] = [\r\n    { value: 'spam', label: \"Spam\" },\r\n    { value: 'harassment', label: \"Harassment or Bullying\" },\r\n    { value: 'hate_speech', label: \"Hate Speech\" },\r\n    { value: 'nudity', label: \"Nudity or Sexual Activity\" },\r\n    { value: 'violence', label: \"Violence\" },\r\n    { value: 'other', label: \"Something else\" },\r\n];\r\n\r\nexport function ReportDialog({ open, onOpenChange, targetType, targetId, context }: ReportDialogProps) {\r\n    const [reason, setReason] = useState<ReportReason>('spam');\r\n    const [details, setDetails] = useState(\"\");\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n    const handleSubmit = async () => {\r\n        setIsSubmitting(true);\r\n        try {\r\n            await createReport(targetType, targetId, reason, details, context);\r\n            toast.success(\"Report submitted. Thank you for making our community safer.\");\r\n            onOpenChange(false);\r\n            setDetails(\"\"); // Reset\r\n            setReason('spam');\r\n        } catch (error) {\r\n            console.error(\"Report failed\", error);\r\n            toast.error(\"Failed to submit report. Please try again.\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-[425px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <AlertTriangle className=\"h-5 w-5 text-yellow-500\" />\r\n                        Report Content\r\n                    </DialogTitle>\r\n                    <DialogDescription>\r\n                        Please select a reason why you are reporting this content.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <div className=\"grid gap-4 py-4\">\r\n                    <RadioGroup value={reason} onValueChange={(v) => setReason(v as ReportReason)}>\r\n                        {REASONS.map((r) => (\r\n                            <div key={r.value} className=\"flex items-center space-x-2\">\r\n                                <RadioGroupItem value={r.value} id={r.value} />\r\n                                <Label htmlFor={r.value}>{r.label}</Label>\r\n                            </div>\r\n                        ))}\r\n                    </RadioGroup>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"details\">Additional Details (Optional)</Label>\r\n                        <Textarea\r\n                            id=\"details\"\r\n                            placeholder=\"Please provide any extra context...\"\r\n                            value={details}\r\n                            onChange={(e) => setDetails(e.target.value)}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={() => onOpenChange(false)} disabled={isSubmitting}>\r\n                        Cancel\r\n                    </Button>\r\n                    <Button onClick={handleSubmit} disabled={isSubmitting}>\r\n                        {isSubmitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                        Submit Report\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\rtc\\broadcast-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Card' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Card"},"fix":{"range":[300,305],"text":""},"desc":"Remove unused variable \"Card\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardContent' is defined but never used.","line":7,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardContent"},"fix":{"range":[304,317],"text":""},"desc":"Remove unused variable \"CardContent\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":7,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[317,329],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":7,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":50,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"CardTitle"},"fix":{"range":[291,370],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used.","line":8,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":55,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Users"},"fix":{"range":[419,426],"text":""},"desc":"Remove unused variable \"Users\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":223,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8154,8157],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8154,8157],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState, useRef, useCallback } from \"react\"\r\nimport { useAuth } from \"@/components/auth-provider\"\r\nimport { sendSignal, endSession, updateSessionPrivacy, updateSessionHeartbeat } from \"@/app/actions/rtc\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Mic, MicOff, Video, VideoOff, PhoneOff, Users, Lock, Globe, ChevronLeft, ChevronRight } from \"lucide-react\"\r\nimport { toast } from \"sonner\"\r\nimport { db } from \"@/lib/firebase\"\r\nimport { collection, query, where, onSnapshot, orderBy } from \"firebase/firestore\"\r\nimport { ViewerListPanel } from \"./viewer-list-panel\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { Label } from \"@/components/ui/label\"\r\n\r\ninterface BroadcastViewProps {\r\n    sessionId: string;\r\n    onEnd?: () => void;\r\n}\r\n\r\nexport function BroadcastView({ sessionId, onEnd }: BroadcastViewProps) {\r\n    const { user } = useAuth()\r\n    const [isMuted, setIsMuted] = useState(false)\r\n    const [isVideoOff, setIsVideoOff] = useState(false)\r\n    const [viewerCount, setViewerCount] = useState(0)\r\n    const [isLive, setIsLive] = useState(false)\r\n    const [showViewerPanel, setShowViewerPanel] = useState(true)\r\n    const [isPublic, setIsPublic] = useState(false)\r\n\r\n    const localVideoRef = useRef<HTMLVideoElement>(null)\r\n    const localStreamRef = useRef<MediaStream | null>(null)\r\n    const peerConnectionsRef = useRef<Map<string, RTCPeerConnection>>(new Map())\r\n\r\n    // Heartbeat Effect\r\n    useEffect(() => {\r\n        // Send heartbeat immediately on mount\r\n        updateSessionHeartbeat(sessionId).catch(console.error)\r\n\r\n        const interval = setInterval(() => {\r\n            updateSessionHeartbeat(sessionId).catch(console.error)\r\n        }, 5000) // 5 seconds (must be much faster than 30s stale timeout)\r\n\r\n        return () => clearInterval(interval)\r\n    }, [sessionId])\r\n\r\n\r\n\r\n    const cleanup = useCallback(async () => {\r\n        // Stop local stream\r\n        if (localStreamRef.current) {\r\n            localStreamRef.current.getTracks().forEach((track) => track.stop())\r\n        }\r\n\r\n        // Close all peer connections\r\n        peerConnectionsRef.current.forEach((pc) => pc.close())\r\n        peerConnectionsRef.current.clear()\r\n\r\n        // Attempt to end session on server\r\n        try {\r\n            await endSession(sessionId)\r\n        } catch (err) {\r\n            console.error(\"Failed to end session during cleanup:\", err)\r\n        }\r\n    }, [sessionId])\r\n\r\n    const handleNewViewer = useCallback(async (viewerId: string, offerSdp: string) => {\r\n        if (!localStreamRef.current) return\r\n\r\n        // Create peer connection for this viewer\r\n        const { RTC_CONFIG } = await import(\"@/lib/rtc-config\")\r\n        const pc = new RTCPeerConnection(RTC_CONFIG)\r\n\r\n        // Add local stream\r\n        localStreamRef.current.getTracks().forEach((track) => {\r\n            pc.addTrack(track, localStreamRef.current!)\r\n        })\r\n\r\n        // Handle ICE candidates\r\n        pc.onicecandidate = async (event) => {\r\n            if (event.candidate) {\r\n                await sendSignal(sessionId, {\r\n                    type: \"candidate\",\r\n                    candidate: event.candidate.toJSON(),\r\n                    to: viewerId,\r\n                })\r\n            }\r\n        }\r\n\r\n        // Handle connection state\r\n        pc.onconnectionstatechange = () => {\r\n            if (pc.connectionState === \"connected\") {\r\n                setViewerCount(prev => prev + 1)\r\n            } else if (pc.connectionState === \"disconnected\" || pc.connectionState === \"failed\") {\r\n                setViewerCount(prev => Math.max(0, prev - 1))\r\n                peerConnectionsRef.current.delete(viewerId)\r\n            }\r\n        }\r\n\r\n        // Set remote description and create answer\r\n        await pc.setRemoteDescription(new RTCSessionDescription({ type: \"offer\", sdp: offerSdp }))\r\n        const answer = await pc.createAnswer()\r\n        await pc.setLocalDescription(answer)\r\n\r\n        // Send answer to viewer\r\n        await sendSignal(sessionId, {\r\n            type: \"answer\",\r\n            sdp: answer.sdp!,\r\n            to: viewerId,\r\n        })\r\n\r\n        peerConnectionsRef.current.set(viewerId, pc)\r\n    }, [sessionId])\r\n\r\n    const startBroadcast = useCallback(async () => {\r\n        if (!user) return\r\n\r\n        try {\r\n            // Get user media\r\n            const stream = await navigator.mediaDevices.getUserMedia({\r\n                video: true,\r\n                audio: true,\r\n            })\r\n\r\n            localStreamRef.current = stream\r\n            if (localVideoRef.current) {\r\n                localVideoRef.current.srcObject = stream\r\n            }\r\n\r\n            setIsLive(true)\r\n\r\n            // Listen for viewers joining (signals with type 'offer')\r\n            const signalsRef = collection(db, `active_sessions/${sessionId}/signals`)\r\n            const signalsQuery = query(\r\n                signalsRef,\r\n                where(\"to\", \"==\", user.uid),\r\n                orderBy(\"timestamp\", \"asc\")\r\n            )\r\n\r\n            // Return unsubscribe function for cleanup\r\n            return onSnapshot(signalsQuery, async (snapshot) => {\r\n                for (const change of snapshot.docChanges()) {\r\n                    if (change.type === \"added\") {\r\n                        const signal = change.doc.data()\r\n\r\n                        if (signal.type === \"offer\") {\r\n                            // New viewer joining\r\n                            await handleNewViewer(signal.from, signal.sdp)\r\n                        } else if (signal.type === \"candidate\") {\r\n                            // ICE candidate from viewer\r\n                            const pc = peerConnectionsRef.current.get(signal.from)\r\n                            if (pc) {\r\n                                await pc.addIceCandidate(new RTCIceCandidate(signal.candidate))\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            })\r\n\r\n        } catch (error) {\r\n            console.error(\"Broadcast setup error:\", error)\r\n            toast.error(\"Failed to start broadcast\")\r\n            return undefined\r\n        }\r\n    }, [sessionId, user, handleNewViewer])\r\n\r\n    useEffect(() => {\r\n        let unsubscribe: (() => void) | undefined;\r\n\r\n        const init = async () => {\r\n            unsubscribe = await startBroadcast()\r\n            if (unsubscribe) {\r\n                toast.success(\"You're now live!\")\r\n            }\r\n        }\r\n\r\n        init()\r\n\r\n        // Handle page unload (tab close/refresh) to ensure session ends\r\n        const handleBeforeUnload = () => {\r\n            cleanup()\r\n        }\r\n        window.addEventListener('beforeunload', handleBeforeUnload)\r\n\r\n        return () => {\r\n            window.removeEventListener('beforeunload', handleBeforeUnload)\r\n            if (unsubscribe) unsubscribe()\r\n            cleanup()\r\n        }\r\n    }, [startBroadcast, cleanup])\r\n\r\n    const handleEndBroadcast = async () => {\r\n        await cleanup() // Await cleanup to ensure session ends\r\n        setIsLive(false)\r\n        toast.success(\"Broadcast ended\")\r\n        onEnd?.()\r\n    }\r\n\r\n    const toggleMute = () => {\r\n        if (localStreamRef.current) {\r\n            const audioTrack = localStreamRef.current.getAudioTracks()[0]\r\n            if (audioTrack) {\r\n                audioTrack.enabled = !audioTrack.enabled\r\n                setIsMuted(!audioTrack.enabled)\r\n            }\r\n        }\r\n    }\r\n\r\n    const toggleVideo = () => {\r\n        if (localStreamRef.current) {\r\n            const videoTrack = localStreamRef.current.getVideoTracks()[0]\r\n            if (videoTrack) {\r\n                videoTrack.enabled = !videoTrack.enabled\r\n                setIsVideoOff(!videoTrack.enabled)\r\n            }\r\n        }\r\n    }\r\n\r\n    const handlePrivacyToggle = async (checked: boolean) => {\r\n        try {\r\n            await updateSessionPrivacy(sessionId, checked)\r\n            setIsPublic(checked)\r\n            toast.success(checked ? \"Broadcast is now public\" : \"Broadcast is now family-only\")\r\n        } catch (error: any) {\r\n            toast.error(error.message || \"Failed to update privacy\")\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex gap-4 w-full h-full min-h-[600px]\">\r\n            {/* Main Broadcast View */}\r\n            <div className=\"relative flex-1 bg-black rounded-lg overflow-hidden\">\r\n                {/* Local Video */}\r\n                <video\r\n                    ref={localVideoRef}\r\n                    autoPlay\r\n                    playsInline\r\n                    muted\r\n                    className=\"w-full h-full object-cover\"\r\n                />\r\n\r\n                {/* Live Indicator */}\r\n                {isLive && (\r\n                    <div className=\"absolute top-4 left-4 flex items-center gap-2 bg-red-600 text-white px-3 py-1 rounded-full text-sm font-semibold\">\r\n                        <div className=\"w-2 h-2 bg-white rounded-full animate-pulse\" />\r\n                        LIVE\r\n                    </div>\r\n                )}\r\n\r\n                {/* Privacy Toggle */}\r\n                <div className=\"absolute top-4 right-4 flex items-center gap-2 bg-black/50 text-white px-3 py-2 rounded-lg backdrop-blur-sm\">\r\n                    <Lock className=\"h-4 w-4\" />\r\n                    <Label htmlFor=\"privacy-toggle\" className=\"text-sm cursor-pointer\">\r\n                        {isPublic ? \"Public\" : \"Family Only\"}\r\n                    </Label>\r\n                    <Switch\r\n                        id=\"privacy-toggle\"\r\n                        checked={isPublic}\r\n                        onCheckedChange={handlePrivacyToggle}\r\n                    />\r\n                    {isPublic ? <Globe className=\"h-4 w-4\" /> : <Lock className=\"h-4 w-4\" />}\r\n                </div>\r\n\r\n                {/* Viewer Panel Toggle */}\r\n                <Button\r\n                    variant=\"secondary\"\r\n                    size=\"icon\"\r\n                    className=\"absolute top-1/2 right-4 -translate-y-1/2 rounded-full\"\r\n                    onClick={() => setShowViewerPanel(!showViewerPanel)}\r\n                >\r\n                    {showViewerPanel ? <ChevronRight className=\"h-5 w-5\" /> : <ChevronLeft className=\"h-5 w-5\" />}\r\n                </Button>\r\n\r\n                {/* Controls */}\r\n                <div className=\"absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4\">\r\n                    <Button\r\n                        size=\"lg\"\r\n                        variant={isMuted ? \"destructive\" : \"secondary\"}\r\n                        onClick={toggleMute}\r\n                        className=\"rounded-full h-14 w-14\"\r\n                    >\r\n                        {isMuted ? <MicOff className=\"h-6 w-6\" /> : <Mic className=\"h-6 w-6\" />}\r\n                    </Button>\r\n\r\n                    <Button\r\n                        size=\"lg\"\r\n                        variant={isVideoOff ? \"destructive\" : \"secondary\"}\r\n                        onClick={toggleVideo}\r\n                        className=\"rounded-full h-14 w-14\"\r\n                    >\r\n                        {isVideoOff ? <VideoOff className=\"h-6 w-6\" /> : <Video className=\"h-6 w-6\" />}\r\n                    </Button>\r\n\r\n                    <Button\r\n                        size=\"lg\"\r\n                        variant=\"destructive\"\r\n                        onClick={handleEndBroadcast}\r\n                        className=\"rounded-full h-14 w-14\"\r\n                    >\r\n                        <PhoneOff className=\"h-6 w-6\" />\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Viewer List Panel */}\r\n            {showViewerPanel && (\r\n                <div className=\"w-80 rounded-lg overflow-hidden\">\r\n                    <ViewerListPanel sessionId={sessionId} viewerCount={viewerCount} />\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\rtc\\call-overlay.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getActiveSession' is defined but never used.","line":5,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":67,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getActiveSession"},"fix":{"range":[171,189],"text":""},"desc":"Remove unused variable \"getActiveSession\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":9,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":58,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[480,483],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[925,928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[925,928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState, useRef } from \"react\"\r\nimport { useAuth } from \"@/components/auth-provider\"\r\nimport { getIncomingCall, endSession, sendSignal, getActiveSession } from \"@/app/actions/rtc\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { Phone, PhoneOff, Mic, MicOff, Video, VideoOff, X } from \"lucide-react\"\r\nimport { toast } from \"sonner\"\r\nimport { db } from \"@/lib/firebase\"\r\nimport { collection, query, where, onSnapshot, orderBy } from \"firebase/firestore\"\r\n\r\ninterface CallOverlayProps {\r\n    sessionId?: string;\r\n    onClose?: () => void;\r\n}\r\n\r\nexport function CallOverlay({ sessionId: initialSessionId, onClose }: CallOverlayProps) {\r\n    const { user } = useAuth()\r\n    const [incomingCall, setIncomingCall] = useState<any>(null)\r\n    const [activeSessionId, setActiveSessionId] = useState<string | null>(initialSessionId || null)\r\n    const [callState, setCallState] = useState<\"ringing\" | \"connecting\" | \"active\" | null>(null)\r\n    const [isMuted, setIsMuted] = useState(false)\r\n    const [isVideoOff, setIsVideoOff] = useState(false)\r\n\r\n    const localVideoRef = useRef<HTMLVideoElement>(null)\r\n    const remoteVideoRef = useRef<HTMLVideoElement>(null)\r\n    const peerConnectionRef = useRef<RTCPeerConnection | null>(null)\r\n    const localStreamRef = useRef<MediaStream | null>(null)\r\n\r\n    // Listen for incoming calls\r\n    useEffect(() => {\r\n        if (!user || activeSessionId) return\r\n\r\n        const checkInterval = setInterval(async () => {\r\n            try {\r\n                const call = await getIncomingCall(user.uid)\r\n                if (call && call.id !== incomingCall?.id) {\r\n                    setIncomingCall(call)\r\n                    setCallState(\"ringing\")\r\n                    // Play ringtone (optional)\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error checking for calls:\", error)\r\n            }\r\n        }, 2000)\r\n\r\n        return () => clearInterval(checkInterval)\r\n    }, [user, activeSessionId, incomingCall?.id])\r\n\r\n    // Setup WebRTC\r\n    const setupWebRTC = async (sessionId: string, isInitiator: boolean) => {\r\n        try {\r\n            // Get user media\r\n            const stream = await navigator.mediaDevices.getUserMedia({\r\n                video: incomingCall?.type === \"call_video\" || true,\r\n                audio: true,\r\n            })\r\n\r\n            localStreamRef.current = stream\r\n            if (localVideoRef.current) {\r\n                localVideoRef.current.srcObject = stream\r\n            }\r\n\r\n            // Create peer connection\r\n            const { RTC_CONFIG } = await import(\"@/lib/rtc-config\")\r\n            const pc = new RTCPeerConnection(RTC_CONFIG)\r\n\r\n            peerConnectionRef.current = pc\r\n\r\n            // Add local stream to peer connection\r\n            stream.getTracks().forEach((track) => {\r\n                pc.addTrack(track, stream)\r\n            })\r\n\r\n            // Handle remote stream\r\n            pc.ontrack = (event) => {\r\n                if (remoteVideoRef.current) {\r\n                    remoteVideoRef.current.srcObject = event.streams[0]\r\n                }\r\n            }\r\n\r\n            // Handle ICE candidates\r\n            pc.onicecandidate = async (event) => {\r\n                if (event.candidate) {\r\n                    await sendSignal(sessionId, {\r\n                        type: \"candidate\",\r\n                        candidate: event.candidate.toJSON(),\r\n                        to: incomingCall?.hostId || user!.uid,\r\n                    })\r\n                }\r\n            }\r\n\r\n            // Listen for signals\r\n            const signalsRef = collection(db, `active_sessions/${sessionId}/signals`)\r\n            const signalsQuery = query(\r\n                signalsRef,\r\n                where(\"to\", \"==\", user!.uid),\r\n                orderBy(\"timestamp\", \"asc\")\r\n            )\r\n\r\n            const unsubscribe = onSnapshot(signalsQuery, async (snapshot) => {\r\n                for (const change of snapshot.docChanges()) {\r\n                    if (change.type === \"added\") {\r\n                        const signal = change.doc.data()\r\n\r\n                        if (signal.type === \"offer\") {\r\n                            await pc.setRemoteDescription(new RTCSessionDescription({ type: \"offer\", sdp: signal.sdp }))\r\n                            const answer = await pc.createAnswer()\r\n                            await pc.setLocalDescription(answer)\r\n                            await sendSignal(sessionId, {\r\n                                type: \"answer\",\r\n                                sdp: answer.sdp!,\r\n                                to: signal.from,\r\n                            })\r\n                        } else if (signal.type === \"answer\") {\r\n                            await pc.setRemoteDescription(new RTCSessionDescription({ type: \"answer\", sdp: signal.sdp }))\r\n                        } else if (signal.type === \"candidate\") {\r\n                            await pc.addIceCandidate(new RTCIceCandidate(signal.candidate))\r\n                        }\r\n                    }\r\n                }\r\n            })\r\n\r\n            // If initiator, create offer\r\n            if (isInitiator) {\r\n                const offer = await pc.createOffer()\r\n                await pc.setLocalDescription(offer)\r\n                await sendSignal(sessionId, {\r\n                    type: \"offer\",\r\n                    sdp: offer.sdp!,\r\n                    to: incomingCall?.hostId || user!.uid,\r\n                })\r\n            }\r\n\r\n            setCallState(\"active\")\r\n\r\n            return () => {\r\n                unsubscribe()\r\n            }\r\n        } catch (error) {\r\n            console.error(\"WebRTC setup error:\", error)\r\n            toast.error(\"Failed to setup call\")\r\n            handleEndCall()\r\n        }\r\n    }\r\n\r\n    const handleAcceptCall = async () => {\r\n        if (!incomingCall) return\r\n        setCallState(\"connecting\")\r\n        setActiveSessionId(incomingCall.id)\r\n        await setupWebRTC(incomingCall.id, false)\r\n    }\r\n\r\n    const handleRejectCall = async () => {\r\n        if (incomingCall) {\r\n            await endSession(incomingCall.id)\r\n        }\r\n        setIncomingCall(null)\r\n        setCallState(null)\r\n    }\r\n\r\n    const handleEndCall = async () => {\r\n        // Clean up media\r\n        if (localStreamRef.current) {\r\n            localStreamRef.current.getTracks().forEach((track) => track.stop())\r\n        }\r\n\r\n        // Close peer connection\r\n        if (peerConnectionRef.current) {\r\n            peerConnectionRef.current.close()\r\n        }\r\n\r\n        // End session\r\n        if (activeSessionId) {\r\n            await endSession(activeSessionId)\r\n        }\r\n\r\n        // Reset state\r\n        setActiveSessionId(null)\r\n        setCallState(null)\r\n        setIncomingCall(null)\r\n        onClose?.()\r\n    }\r\n\r\n    const toggleMute = () => {\r\n        if (localStreamRef.current) {\r\n            const audioTrack = localStreamRef.current.getAudioTracks()[0]\r\n            if (audioTrack) {\r\n                audioTrack.enabled = !audioTrack.enabled\r\n                setIsMuted(!audioTrack.enabled)\r\n            }\r\n        }\r\n    }\r\n\r\n    const toggleVideo = () => {\r\n        if (localStreamRef.current) {\r\n            const videoTrack = localStreamRef.current.getVideoTracks()[0]\r\n            if (videoTrack) {\r\n                videoTrack.enabled = !videoTrack.enabled\r\n                setIsVideoOff(!videoTrack.enabled)\r\n            }\r\n        }\r\n    }\r\n\r\n    if (!callState) return null\r\n    if (!user) return null\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[40] flex items-center justify-center p-4 pointer-events-none\">\r\n            {callState === \"ringing\" && (\r\n                <Card className=\"w-full max-w-md pointer-events-auto shadow-2xl\">\r\n                    <CardHeader>\r\n                        <CardTitle className=\"text-center\">Incoming Call</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent className=\"flex flex-col items-center gap-6\">\r\n                        <Avatar className=\"h-24 w-24\">\r\n                            <AvatarImage src={incomingCall?.callerImage} />\r\n                            <AvatarFallback>{incomingCall?.callerName?.[0]}</AvatarFallback>\r\n                        </Avatar>\r\n                        <div className=\"text-xl font-semibold\">{incomingCall?.callerName}</div>\r\n                        <div className=\"text-sm text-muted-foreground\">\r\n                            {incomingCall?.type === \"call_video\" ? \"Video Call\" : \"Voice Call\"}\r\n                        </div>\r\n                        <div className=\"flex gap-4\">\r\n                            <Button\r\n                                size=\"lg\"\r\n                                variant=\"destructive\"\r\n                                onClick={handleRejectCall}\r\n                                className=\"rounded-full h-16 w-16\"\r\n                            >\r\n                                <PhoneOff className=\"h-6 w-6\" />\r\n                            </Button>\r\n                            <Button\r\n                                size=\"lg\"\r\n                                onClick={handleAcceptCall}\r\n                                className=\"rounded-full h-16 w-16 bg-green-600 hover:bg-green-700\"\r\n                            >\r\n                                <Phone className=\"h-6 w-6\" />\r\n                            </Button>\r\n                        </div>\r\n                    </CardContent>\r\n                </Card>\r\n            )}\r\n\r\n            {(callState === \"connecting\" || callState === \"active\") && (\r\n                <div className=\"relative w-full h-full pointer-events-auto bg-black/80\">\r\n                    {/* Remote Video (Full Screen) */}\r\n                    <video\r\n                        ref={remoteVideoRef}\r\n                        autoPlay\r\n                        playsInline\r\n                        className=\"w-full h-full object-cover\"\r\n                    />\r\n\r\n                    {/* Local Video (PiP) */}\r\n                    <video\r\n                        ref={localVideoRef}\r\n                        autoPlay\r\n                        playsInline\r\n                        muted\r\n                        className=\"absolute top-4 right-4 w-48 h-36 object-cover rounded-lg border-2 border-white shadow-lg\"\r\n                    />\r\n\r\n                    {/* Controls */}\r\n                    <div className=\"absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4\">\r\n                        <Button\r\n                            size=\"lg\"\r\n                            variant={isMuted ? \"destructive\" : \"secondary\"}\r\n                            onClick={toggleMute}\r\n                            className=\"rounded-full h-14 w-14\"\r\n                        >\r\n                            {isMuted ? <MicOff className=\"h-6 w-6\" /> : <Mic className=\"h-6 w-6\" />}\r\n                        </Button>\r\n\r\n                        {incomingCall?.type === \"call_video\" && (\r\n                            <Button\r\n                                size=\"lg\"\r\n                                variant={isVideoOff ? \"destructive\" : \"secondary\"}\r\n                                onClick={toggleVideo}\r\n                                className=\"rounded-full h-14 w-14\"\r\n                            >\r\n                                {isVideoOff ? <VideoOff className=\"h-6 w-6\" /> : <Video className=\"h-6 w-6\" />}\r\n                            </Button>\r\n                        )}\r\n\r\n                        <Button\r\n                            size=\"lg\"\r\n                            variant=\"destructive\"\r\n                            onClick={handleEndCall}\r\n                            className=\"rounded-full h-14 w-14\"\r\n                        >\r\n                            <PhoneOff className=\"h-6 w-6\" />\r\n                        </Button>\r\n                    </div>\r\n\r\n                    {callState === \"connecting\" && (\r\n                        <div className=\"absolute inset-0 flex items-center justify-center bg-black/50\">\r\n                            <div className=\"text-white text-xl\">Connecting...</div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\rtc\\viewer-list-panel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2224,2227],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2224,2227],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { UserX, Users as UsersIcon } from \"lucide-react\"\r\nimport { getSessionViewers, kickViewer } from \"@/app/actions/rtc\"\r\nimport { toast } from \"sonner\"\r\nimport {\r\n    AlertDialog,\r\n    AlertDialogAction,\r\n    AlertDialogCancel,\r\n    AlertDialogContent,\r\n    AlertDialogDescription,\r\n    AlertDialogFooter,\r\n    AlertDialogHeader,\r\n    AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\"\r\n\r\ninterface Viewer {\r\n    id: string\r\n    displayName: string\r\n    imageUrl?: string\r\n}\r\n\r\ninterface ViewerListPanelProps {\r\n    sessionId: string\r\n    viewerCount: number\r\n}\r\n\r\nexport function ViewerListPanel({ sessionId, viewerCount }: ViewerListPanelProps) {\r\n    const [viewers, setViewers] = useState<Viewer[]>([])\r\n    const [isLoading, setIsLoading] = useState(true)\r\n    const [kickingViewerId, setKickingViewerId] = useState<string | null>(null)\r\n    const [viewerToKick, setViewerToKick] = useState<Viewer | null>(null)\r\n\r\n    const loadViewers = useCallback(async () => {\r\n        try {\r\n            const data = await getSessionViewers(sessionId)\r\n            setViewers(data)\r\n        } catch (error) {\r\n            console.error(\"Error loading viewers:\", error)\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }, [sessionId])\r\n\r\n    useEffect(() => {\r\n        loadViewers()\r\n        // Refresh viewer list every 5 seconds\r\n        const interval = setInterval(loadViewers, 5000)\r\n        return () => clearInterval(interval)\r\n    }, [loadViewers, viewerCount])\r\n\r\n    const handleKickClick = (viewer: Viewer) => {\r\n        setViewerToKick(viewer)\r\n    }\r\n\r\n    const confirmKick = async () => {\r\n        if (!viewerToKick) return\r\n\r\n        setKickingViewerId(viewerToKick.id)\r\n        try {\r\n            await kickViewer(sessionId, viewerToKick.id)\r\n            toast.success(`Removed ${viewerToKick.displayName} from broadcast`)\r\n            setViewers(prev => prev.filter(v => v.id !== viewerToKick.id))\r\n        } catch (error: any) {\r\n            toast.error(error.message || \"Failed to remove viewer\")\r\n        } finally {\r\n            setKickingViewerId(null)\r\n            setViewerToKick(null)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <div className=\"w-full h-full bg-black/80 backdrop-blur-sm text-white flex flex-col\">\r\n                <div className=\"p-4 border-b border-white/10\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <UsersIcon className=\"h-5 w-5\" />\r\n                        <h3 className=\"font-semibold\">Viewers ({viewerCount})</h3>\r\n                    </div>\r\n                </div>\r\n\r\n                <ScrollArea className=\"flex-1\">\r\n                    {isLoading ? (\r\n                        <div className=\"p-4 text-center text-white/60\">\r\n                            Loading viewers...\r\n                        </div>\r\n                    ) : viewers.length === 0 ? (\r\n                        <div className=\"p-4 text-center text-white/60\">\r\n                            <UsersIcon className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\r\n                            <p>No viewers yet</p>\r\n                            <p className=\"text-sm mt-1\">Waiting for people to join...</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"p-2 space-y-1\">\r\n                            {viewers.map((viewer) => (\r\n                                <div\r\n                                    key={viewer.id}\r\n                                    className=\"flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors\"\r\n                                >\r\n                                    <Avatar className=\"h-10 w-10\">\r\n                                        <AvatarImage src={viewer.imageUrl} />\r\n                                        <AvatarFallback>{viewer.displayName[0]}</AvatarFallback>\r\n                                    </Avatar>\r\n                                    <div className=\"flex-1 min-w-0\">\r\n                                        <p className=\"font-medium truncate\">{viewer.displayName}</p>\r\n                                    </div>\r\n                                    <Button\r\n                                        variant=\"ghost\"\r\n                                        size=\"icon\"\r\n                                        className=\"h-8 w-8 text-white/60 hover:text-red-500 hover:bg-red-500/10\"\r\n                                        onClick={() => handleKickClick(viewer)}\r\n                                        disabled={kickingViewerId === viewer.id}\r\n                                    >\r\n                                        <UserX className=\"h-4 w-4\" />\r\n                                    </Button>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </ScrollArea>\r\n            </div>\r\n\r\n            <AlertDialog open={!!viewerToKick} onOpenChange={() => setViewerToKick(null)}>\r\n                <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                        <AlertDialogTitle>Remove Viewer?</AlertDialogTitle>\r\n                        <AlertDialogDescription>\r\n                            Are you sure you want to remove <strong>{viewerToKick?.displayName}</strong> from your broadcast? They will be disconnected immediately.\r\n                        </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                        <AlertDialogCancel>Cancel</AlertDialogCancel>\r\n                        <AlertDialogAction onClick={confirmKick} className=\"bg-destructive hover:bg-destructive/90\">\r\n                            Remove\r\n                        </AlertDialogAction>\r\n                    </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n            </AlertDialog>\r\n        </>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\rtc\\viewer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isConnected' is assigned a value but never used.","line":21,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState, useRef, useCallback } from \"react\"\r\nimport { useAuth } from \"@/components/auth-provider\"\r\nimport { sendSignal, getActiveSession, addViewer } from \"@/app/actions/rtc\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Loader2, PhoneOff } from \"lucide-react\"\r\nimport { toast } from \"sonner\"\r\nimport { db } from \"@/lib/firebase\"\r\nimport { collection, query, where, onSnapshot, orderBy } from \"firebase/firestore\"\r\nimport { useRouter } from \"next/navigation\"\r\n\r\ninterface ViewerProps {\r\n    sessionId: string;\r\n}\r\n\r\nexport function Viewer({ sessionId }: ViewerProps) {\r\n    const { user } = useAuth()\r\n    const router = useRouter()\r\n    const [isConnecting, setIsConnecting] = useState(true)\r\n    const [isConnected, setIsConnected] = useState(false)\r\n\r\n    const remoteVideoRef = useRef<HTMLVideoElement>(null)\r\n    const peerConnectionRef = useRef<RTCPeerConnection | null>(null)\r\n\r\n    const cleanup = useCallback(() => {\r\n        if (peerConnectionRef.current) {\r\n            peerConnectionRef.current.close()\r\n        }\r\n    }, [])\r\n\r\n    const handleLeave = () => {\r\n        cleanup()\r\n        router.push(\"/live\")\r\n    }\r\n\r\n    const joinStream = useCallback(async () => {\r\n        if (!user) return undefined\r\n\r\n        try {\r\n            // Add viewer to session (checks privacy and kicked status)\r\n            await addViewer(sessionId)\r\n\r\n            // Get session info\r\n            const session = await getActiveSession(sessionId)\r\n            if (!session || session.status !== \"active\") {\r\n                toast.error(\"This broadcast has ended\")\r\n                router.push(\"/live\")\r\n                return\r\n            }\r\n\r\n            // Create peer connection\r\n            const { RTC_CONFIG } = await import(\"@/lib/rtc-config\")\r\n            const pc = new RTCPeerConnection(RTC_CONFIG)\r\n\r\n            peerConnectionRef.current = pc\r\n\r\n            // Handle remote stream\r\n            pc.ontrack = (event) => {\r\n                if (remoteVideoRef.current) {\r\n                    remoteVideoRef.current.srcObject = event.streams[0]\r\n                    setIsConnected(true)\r\n                    setIsConnecting(false)\r\n                }\r\n            }\r\n\r\n            // Handle ICE candidates\r\n            pc.onicecandidate = async (event) => {\r\n                if (event.candidate) {\r\n                    await sendSignal(sessionId, {\r\n                        type: \"candidate\",\r\n                        candidate: event.candidate.toJSON(),\r\n                        to: session.hostId,\r\n                    })\r\n                }\r\n            }\r\n\r\n            // Handle connection state\r\n            pc.onconnectionstatechange = () => {\r\n                if (pc.connectionState === \"connected\") {\r\n                    setIsConnected(true)\r\n                    setIsConnecting(false)\r\n                } else if (pc.connectionState === \"disconnected\" || pc.connectionState === \"failed\") {\r\n                    toast.error(\"Connection lost\")\r\n                    router.push(\"/live\")\r\n                }\r\n            }\r\n\r\n            // Listen for signals from host\r\n            const signalsRef = collection(db, `active_sessions/${sessionId}/signals`)\r\n            const signalsQuery = query(\r\n                signalsRef,\r\n                where(\"to\", \"==\", user.uid),\r\n                orderBy(\"timestamp\", \"asc\")\r\n            )\r\n\r\n            // Return unsubscribe for cleanup\r\n            const unsubscribe = onSnapshot(signalsQuery, async (snapshot) => {\r\n                for (const change of snapshot.docChanges()) {\r\n                    if (change.type === \"added\") {\r\n                        const signal = change.doc.data()\r\n\r\n                        if (signal.type === \"answer\") {\r\n                            await pc.setRemoteDescription(new RTCSessionDescription({ type: \"answer\", sdp: signal.sdp }))\r\n                        } else if (signal.type === \"candidate\") {\r\n                            await pc.addIceCandidate(new RTCIceCandidate(signal.candidate))\r\n                        } else if (signal.type === \"kicked\") {\r\n                            // Host kicked this viewer\r\n                            toast.error(\"You have been removed from this broadcast\")\r\n                            cleanup()\r\n                            router.push(\"/live\")\r\n                        }\r\n                    }\r\n                }\r\n            })\r\n\r\n            // Create and send offer\r\n            const offer = await pc.createOffer()\r\n            await pc.setLocalDescription(offer)\r\n            await sendSignal(sessionId, {\r\n                type: \"offer\",\r\n                sdp: offer.sdp!,\r\n                to: session.hostId,\r\n            })\r\n\r\n            return unsubscribe\r\n\r\n        } catch (error) {\r\n            console.error(\"Viewer setup error:\", error)\r\n            toast.error(\"Failed to join stream\")\r\n            router.push(\"/live\")\r\n            return undefined\r\n        }\r\n    }, [sessionId, user, router, cleanup])\r\n\r\n    useEffect(() => {\r\n        let unsubscribe: (() => void) | undefined;\r\n\r\n        const init = async () => {\r\n            unsubscribe = await joinStream()\r\n        }\r\n\r\n        init()\r\n\r\n        return () => {\r\n            if (unsubscribe) unsubscribe()\r\n            cleanup()\r\n        }\r\n    }, [joinStream, cleanup])\r\n\r\n    return (\r\n        <div className=\"relative w-full h-full min-h-[600px] bg-black rounded-lg overflow-hidden\">\r\n            {/* Remote Video */}\r\n            <video\r\n                ref={remoteVideoRef}\r\n                autoPlay\r\n                playsInline\r\n                className=\"w-full h-full object-cover\"\r\n            />\r\n\r\n            {/* Loading State */}\r\n            {isConnecting && (\r\n                <div className=\"absolute inset-0 flex items-center justify-center bg-black/80\">\r\n                    <div className=\"flex flex-col items-center gap-4\">\r\n                        <Loader2 className=\"h-12 w-12 text-white animate-spin\" />\r\n                        <p className=\"text-white text-lg\">Connecting to stream...</p>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Leave Button */}\r\n            <div className=\"absolute bottom-8 left-1/2 -translate-x-1/2\">\r\n                <Button\r\n                    size=\"lg\"\r\n                    variant=\"destructive\"\r\n                    onClick={handleLeave}\r\n                    className=\"rounded-full h-14 w-14\"\r\n                >\r\n                    <PhoneOff className=\"h-6 w-6\" />\r\n                </Button>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\settings\\account-form.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used.","line":27,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Shield"},"fix":{"range":[668,705],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1410,1413],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1410,1413],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'authUser' is assigned a value but never used.","line":49,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\nimport { useRouter } from \"next/navigation\"\r\n\r\nimport { zodResolver } from \"@hookform/resolvers/zod\"\r\nimport { useForm, useWatch } from \"react-hook-form\"\r\nimport * as z from \"zod\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n    Form,\r\n    FormControl,\r\n    FormDescription,\r\n    FormField,\r\n    FormItem,\r\n    FormLabel,\r\n    FormMessage,\r\n} from \"@/components/ui/form\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { toast } from \"sonner\"\r\nimport { updateAccountSettings } from \"@/app/actions/settings\"\r\nimport { useTheme } from \"next-themes\"\r\nimport { Shield } from \"lucide-react\"\r\nimport { useLanguage } from \"@/components/language-context\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { useEffect, useState } from \"react\"\r\nimport { useAuth } from \"@/components/auth-provider\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { Slider } from \"@/components/ui/slider\"\r\n\r\nconst accountFormSchema = z.object({\r\n    language: z.string().optional(),\r\n    theme: z.string().optional(),\r\n    autoScrollEnabled: z.boolean().optional(),\r\n    autoScrollSpeed: z.number().min(10).max(100).optional(),\r\n})\r\n\r\ntype AccountFormValues = z.infer<typeof accountFormSchema>\r\n\r\n// ...\r\n\r\nexport function AccountForm({ user }: { user: any }) {\r\n    const router = useRouter()\r\n    const { setTheme } = useTheme()\r\n    const { user: authUser } = useAuth() // No openUserProfile in firebase\r\n    const { setLanguage, t } = useLanguage()\r\n\r\n    // Load auto-scroll settings from localStorage\r\n    const [autoScrollEnabled, setAutoScrollEnabled] = useState(() => {\r\n        if (typeof window === 'undefined') return true;\r\n        const saved = localStorage.getItem('famio-auto-scroll-enabled');\r\n        return saved !== null ? saved === 'true' : true;\r\n    });\r\n\r\n    const [autoScrollSpeed, setAutoScrollSpeed] = useState(() => {\r\n        if (typeof window === 'undefined') return 30;\r\n        const saved = localStorage.getItem('famio-auto-scroll-speed');\r\n        return saved !== null ? parseInt(saved, 10) : 30;\r\n    });\r\n\r\n    const form = useForm<AccountFormValues>({\r\n        resolver: zodResolver(accountFormSchema),\r\n        defaultValues: {\r\n            language: user.language || \"en\",\r\n            theme: user.theme || \"system\",\r\n            autoScrollEnabled,\r\n            autoScrollSpeed,\r\n        },\r\n    })\r\n\r\n    // Listen to theme changes from the form to update live\r\n    const themeValue = useWatch({\r\n        control: form.control,\r\n        name: \"theme\",\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (themeValue) {\r\n            setTheme(themeValue);\r\n        }\r\n    }, [themeValue, setTheme]);\r\n\r\n    async function onSubmit(data: AccountFormValues) {\r\n        try {\r\n            // Save auto-scroll settings to localStorage\r\n            if (data.autoScrollEnabled !== undefined) {\r\n                localStorage.setItem('famio-auto-scroll-enabled', String(data.autoScrollEnabled));\r\n                setAutoScrollEnabled(data.autoScrollEnabled);\r\n            }\r\n            if (data.autoScrollSpeed !== undefined) {\r\n                localStorage.setItem('famio-auto-scroll-speed', String(data.autoScrollSpeed));\r\n                setAutoScrollSpeed(data.autoScrollSpeed);\r\n            }\r\n\r\n            await updateAccountSettings(data)\r\n            // Also update client-side theme\r\n            if (data.theme) {\r\n                setTheme(data.theme)\r\n            }\r\n            if (data.language) {\r\n                // @ts-ignore\r\n                setLanguage(data.language)\r\n            }\r\n            toast.success(\"Account settings updated\")\r\n            router.refresh()\r\n        } catch {\r\n            toast.error(\"Failed to update settings\")\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader>\r\n                <CardTitle>{t(\"settings.account.title\")}</CardTitle>\r\n                <CardDescription>\r\n                    {t(\"settings.account.desc\")}\r\n                </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n                <Form {...form}>\r\n                    <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-8\">\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"language\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>{t(\"settings.language\")}</FormLabel>\r\n                                    <Select onValueChange={field.onChange} defaultValue={field.value}>\r\n                                        <FormControl>\r\n                                            <SelectTrigger>\r\n                                                <SelectValue placeholder=\"Select a language\" />\r\n                                            </SelectTrigger>\r\n                                        </FormControl>\r\n                                        <SelectContent>\r\n                                            <SelectItem value=\"en\">English</SelectItem>\r\n                                            <SelectItem value=\"zh\">‰∏≠Êñá (Mandarin)</SelectItem>\r\n                                            <SelectItem value=\"hi\">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</SelectItem>\r\n                                            <SelectItem value=\"es\">Espa√±ol</SelectItem>\r\n                                            <SelectItem value=\"fr\">Fran√ßais</SelectItem>\r\n                                            <SelectItem value=\"ar\">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</SelectItem>\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                    <FormDescription>\r\n                                        {t(\"settings.language.desc\")}\r\n                                    </FormDescription>\r\n                                    <FormMessage />\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"theme\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>{t(\"settings.theme\")}</FormLabel>\r\n                                    <Select onValueChange={field.onChange} defaultValue={field.value}>\r\n                                        <FormControl>\r\n                                            <SelectTrigger>\r\n                                                <SelectValue placeholder=\"Select a theme\" />\r\n                                            </SelectTrigger>\r\n                                        </FormControl>\r\n                                        <SelectContent>\r\n                                            <SelectItem value=\"light\">Light</SelectItem>\r\n                                            <SelectItem value=\"dark\">Dark</SelectItem>\r\n                                            <SelectItem value=\"system\">System</SelectItem>\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                    <FormDescription>\r\n                                        {t(\"settings.theme.desc\")}\r\n                                    </FormDescription>\r\n                                    <FormMessage />\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n\r\n                        {/* Feed Preferences Section */}\r\n                        <div className=\"space-y-6 pt-6 border-t\">\r\n                            <div>\r\n                                <h3 className=\"text-lg font-medium\">Feed Preferences</h3>\r\n                                <p className=\"text-sm text-muted-foreground\">Configure your auto-scrolling experience</p>\r\n                            </div>\r\n\r\n                            <FormField\r\n                                control={form.control}\r\n                                name=\"autoScrollEnabled\"\r\n                                render={({ field }) => (\r\n                                    <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\r\n                                        <div className=\"space-y-0.5\">\r\n                                            <FormLabel className=\"text-base\">Auto-Scroll Feeds</FormLabel>\r\n                                            <FormDescription>\r\n                                                Automatically scroll through your feed and profiles\r\n                                            </FormDescription>\r\n                                        </div>\r\n                                        <FormControl>\r\n                                            <Switch\r\n                                                checked={field.value}\r\n                                                onCheckedChange={field.onChange}\r\n                                            />\r\n                                        </FormControl>\r\n                                    </FormItem>\r\n                                )}\r\n                            />\r\n\r\n                            <FormField\r\n                                control={form.control}\r\n                                name=\"autoScrollSpeed\"\r\n                                render={({ field }) => (\r\n                                    <FormItem>\r\n                                        <div className=\"flex items-center justify-between\">\r\n                                            <FormLabel>Scroll Speed</FormLabel>\r\n                                            <span className=\"text-sm text-muted-foreground\">{field.value} px/s</span>\r\n                                        </div>\r\n                                        <FormControl>\r\n                                            <Slider\r\n                                                min={10}\r\n                                                max={100}\r\n                                                step={5}\r\n                                                value={[field.value || 30]}\r\n                                                onValueChange={(values: number[]) => field.onChange(values[0])}\r\n                                                className=\"w-full\"\r\n                                            />\r\n                                        </FormControl>\r\n                                        <FormDescription>\r\n                                            Adjust how fast the feed scrolls automatically (10-100 pixels per second)\r\n                                        </FormDescription>\r\n                                        <FormMessage />\r\n                                    </FormItem>\r\n                                )}\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Security Section Removed - Managed via Firebase Auth directly */}\r\n\r\n                        <Button type=\"submit\">{t(\"settings.updateAccount\")}</Button>\r\n                    </form>\r\n                </Form>\r\n            </CardContent>\r\n        </Card >\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\settings\\profile-form.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertDialogAction' is defined but never used.","line":28,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertDialogAction"},"fix":{"range":[878,902],"text":""},"desc":"Remove unused variable \"AlertDialogAction\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":183,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7461,7464],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7461,7464],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":200,"column":41,"nodeType":"JSXOpeningElement","endLine":200,"endColumn":114},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":226,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":226,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9976,9979],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9976,9979],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useRouter } from \"next/navigation\"\r\n\r\nimport { zodResolver } from \"@hookform/resolvers/zod\"\r\nimport { useForm } from \"react-hook-form\"\r\nimport * as z from \"zod\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n    Form,\r\n    FormControl,\r\n    FormDescription,\r\n    FormField,\r\n    FormItem,\r\n    FormLabel,\r\n    FormMessage,\r\n} from \"@/components/ui/form\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { toast } from \"sonner\"\r\nimport { updateProfile } from \"@/app/actions/settings\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { useState } from \"react\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { useLanguage } from \"@/components/language-context\";\r\nimport {\r\n    AlertDialog,\r\n    AlertDialogAction,\r\n    AlertDialogCancel,\r\n    AlertDialogContent,\r\n    AlertDialogDescription,\r\n    AlertDialogFooter,\r\n    AlertDialogHeader,\r\n    AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\"\r\nimport { ArrowLeft } from \"lucide-react\"\r\nimport { storage } from \"@/lib/firebase\";\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\";\r\n\r\nconst profileFormSchema = z.object({\r\n    displayName: z.string().min(2, {\r\n        message: \"Display name must be at least 2 characters.\",\r\n    }),\r\n    bio: z.string().max(160).optional(),\r\n    imageUrl: z.string().optional(),\r\n    coverUrl: z.string().optional(),\r\n    coverType: z.string().optional(),\r\n})\r\n\r\ntype ProfileFormValues = z.infer<typeof profileFormSchema>\r\n\r\ninterface ProfileFormProps {\r\n    user: {\r\n        id: string;\r\n        displayName?: string | null;\r\n        imageUrl?: string | null;\r\n        coverUrl?: string | null;\r\n        coverType?: string | null;\r\n        bio?: string | null;\r\n    }\r\n}\r\n\r\nexport function ProfileForm({ user }: ProfileFormProps) {\r\n    const router = useRouter()\r\n    const [imageUrl, setImageUrl] = useState<string | undefined>(user.imageUrl || undefined);\r\n    const [coverUrl, setCoverUrl] = useState<string | undefined>(user.coverUrl || undefined);\r\n    const [coverType, setCoverType] = useState<'image' | 'video' | undefined>(user.coverType as 'image' | 'video' || undefined);\r\n    const [showExitDialog, setShowExitDialog] = useState(false);\r\n\r\n    const form = useForm<ProfileFormValues>({\r\n        resolver: zodResolver(profileFormSchema),\r\n        defaultValues: {\r\n            displayName: user.displayName || \"\",\r\n            bio: user.bio || \"\",\r\n            imageUrl: user.imageUrl || \"\",\r\n            coverUrl: user.coverUrl || \"\",\r\n            coverType: user.coverType || \"\",\r\n        },\r\n    })\r\n\r\n    async function onSubmit(data: ProfileFormValues) {\r\n        try {\r\n            await updateProfile({\r\n                ...data,\r\n                imageUrl: imageUrl,\r\n                coverUrl: coverUrl,\r\n                coverType: coverType\r\n            })\r\n            toast.success(\"Profile updated\")\r\n\r\n            // Re-sync form state so it's not dirty anymore\r\n            form.reset({ ...data, imageUrl: imageUrl });\r\n            router.refresh()\r\n        } catch {\r\n            toast.error(\"Failed to update profile\")\r\n        }\r\n    }\r\n\r\n    const { isDirty } = form.formState;\r\n\r\n    const handleExit = () => {\r\n        if (isDirty) {\r\n            setShowExitDialog(true);\r\n        } else {\r\n            router.push('/');\r\n        }\r\n    };\r\n\r\n    const handleDiscardAndExit = () => {\r\n        router.push('/');\r\n    };\r\n\r\n    const handleSaveAndExit = async () => {\r\n        await form.handleSubmit(async (data) => {\r\n            await onSubmit(data);\r\n            router.push('/');\r\n        })();\r\n    };\r\n\r\n    const { t } = useLanguage();\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between\">\r\n                <div>\r\n                    <CardTitle>{t(\"settings.profile.title\")}</CardTitle>\r\n                    <CardDescription>\r\n                        {t(\"settings.profile.desc\")}\r\n                    </CardDescription>\r\n                </div>\r\n                <Button variant=\"outline\" onClick={handleExit} className=\"gap-2\">\r\n                    <ArrowLeft className=\"w-4 h-4\" />\r\n                    Exit\r\n                </Button>\r\n            </CardHeader>\r\n            <CardContent>\r\n                <Form {...form}>\r\n                    <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-8\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <Avatar className=\"w-20 h-20\">\r\n                                <AvatarImage src={imageUrl} />\r\n                                <AvatarFallback>JD</AvatarFallback>\r\n                            </Avatar>\r\n                            <div className=\"flex flex-col gap-2\">\r\n                                <FormLabel>{t(\"settings.profilePic\")}</FormLabel>\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <Input\r\n                                        type=\"file\"\r\n                                        accept=\"image/*,video/*\"\r\n                                        onChange={async (e) => {\r\n                                            const file = e.target.files?.[0];\r\n                                            if (!file) return;\r\n\r\n                                            try {\r\n                                                const { getAuth } = await import(\"firebase/auth\");\r\n                                                const auth = getAuth();\r\n                                                const currentUser = auth.currentUser;\r\n\r\n                                                if (!currentUser) {\r\n                                                    toast.error(\"Authentication error: You appear to be logged out on the client. Please refresh page or re-login.\");\r\n                                                    return;\r\n                                                }\r\n\r\n                                                if (currentUser.uid !== user.id) {\r\n                                                    console.error(`Auth Mismatch: Client(${currentUser.uid}) vs Prop(${user.id})`);\r\n                                                    toast.error(\"Security mismatch. Please refresh the page.\");\r\n                                                    return;\r\n                                                }\r\n\r\n                                                toast.info(\"Uploading...\");\r\n\r\n                                                const storageRef = ref(storage, `users/${user.id}/profile/${file.name}`);\r\n                                                await uploadBytes(storageRef, file);\r\n                                                const url = await getDownloadURL(storageRef);\r\n\r\n                                                setImageUrl(url);\r\n\r\n                                                // Mark form as dirty manually since we're managing image state outside hook form for now\r\n                                                // Ideally should integrate fully, but for dirty check:\r\n                                                form.setValue('imageUrl', url, { shouldDirty: true });\r\n\r\n                                                toast.success(\"Upload complete\");\r\n                                            } catch (error: any) {\r\n                                                console.error(\"Upload failed\", error);\r\n                                                toast.error(`Error uploading: ${error.message || \"Unknown error\"}`);\r\n                                            }\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"flex flex-col gap-2\">\r\n                            <FormLabel>{t(\"settings.cover\")}</FormLabel>\r\n                            {coverUrl && (\r\n                                <div className=\"relative w-full h-32 rounded-md overflow-hidden bg-muted mb-2\">\r\n                                    {coverUrl.includes(\"mp4\") || coverUrl.includes(\"webm\") ? (\r\n                                        <video src={coverUrl} className=\"w-full h-full object-cover\" autoPlay loop muted />\r\n                                    ) : (\r\n                                        <img src={coverUrl} alt=\"Cover\" className=\"w-full h-full object-cover\" />\r\n                                    )}\r\n                                </div>\r\n                            )}\r\n                            <Input\r\n                                type=\"file\"\r\n                                accept=\"image/*,video/*\"\r\n                                onChange={async (e) => {\r\n                                    const file = e.target.files?.[0];\r\n                                    if (!file) return;\r\n\r\n                                    try {\r\n                                        toast.info(\"Uploading cover...\");\r\n\r\n                                        const storageRef = ref(storage, `users/${user.id}/cover/${file.name}`);\r\n                                        await uploadBytes(storageRef, file);\r\n                                        const url = await getDownloadURL(storageRef);\r\n\r\n                                        setCoverUrl(url);\r\n                                        const type = file.type.startsWith('video') ? 'video' : 'image';\r\n                                        setCoverType(type);\r\n\r\n                                        form.setValue('coverUrl', url, { shouldDirty: true });\r\n                                        form.setValue('coverType', type, { shouldDirty: true });\r\n\r\n                                        toast.success(\"Cover uploaded\");\r\n                                    } catch (error: any) {\r\n                                        console.error(\"Upload failed\", error);\r\n                                        toast.error(`Error uploading: ${error.message || \"Unknown error\"}`);\r\n                                    }\r\n                                }}\r\n                            />\r\n                        </div>\r\n\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"displayName\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>{t(\"settings.displayName\")}</FormLabel>\r\n                                    <FormControl>\r\n                                        <Input placeholder=\"John Doe\" {...field} />\r\n                                    </FormControl>\r\n                                    <FormDescription>\r\n                                        {t(\"settings.displayName.desc\")}\r\n                                    </FormDescription>\r\n                                    <FormMessage />\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"bio\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>{t(\"settings.bio\")}</FormLabel>\r\n                                    <FormControl>\r\n                                        <Textarea\r\n                                            placeholder=\"Tell us a little bit about yourself\"\r\n                                            className=\"resize-none\"\r\n                                            {...field}\r\n                                        />\r\n                                    </FormControl>\r\n                                    <FormDescription>\r\n                                        {t(\"settings.bio.desc\")}\r\n                                    </FormDescription>\r\n                                    <FormMessage />\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n                        <Button type=\"submit\">{t(\"settings.updateProfile\")}</Button>\r\n                    </form>\r\n                </Form>\r\n\r\n                <AlertDialog open={showExitDialog} onOpenChange={setShowExitDialog}>\r\n                    <AlertDialogContent>\r\n                        <AlertDialogHeader>\r\n                            <AlertDialogTitle>Unsaved Changes</AlertDialogTitle>\r\n                            <AlertDialogDescription>\r\n                                You have unsaved changes. Do you want to save them before exiting?\r\n                            </AlertDialogDescription>\r\n                        </AlertDialogHeader>\r\n                        <AlertDialogFooter>\r\n                            <AlertDialogCancel onClick={() => setShowExitDialog(false)}>Cancel</AlertDialogCancel>\r\n                            <Button variant=\"outline\" onClick={handleDiscardAndExit}>Discard</Button>\r\n                            <Button onClick={handleSaveAndExit}>Save & Exit</Button>\r\n                        </AlertDialogFooter>\r\n                    </AlertDialogContent>\r\n                </AlertDialog>\r\n            </CardContent>\r\n        </Card >\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\settings\\settings-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Textarea' is defined but never used.","line":18,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Textarea"},"fix":{"range":[438,489],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toggleInvisibleMode' is defined but never used.","line":28,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"toggleInvisibleMode"},"fix":{"range":[742,762],"text":""},"desc":"Remove unused variable \"toggleInvisibleMode\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertDialogAction' is defined but never used.","line":35,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":35,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertDialogAction"},"fix":{"range":[1115,1139],"text":""},"desc":"Remove unused variable \"AlertDialogAction\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useAuth' is defined but never used.","line":45,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":17,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useAuth"},"fix":{"range":[1412,1464],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setImageUrl' is assigned a value but never used.","line":112,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":112,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setCoverUrl' is assigned a value but never used.","line":113,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":113,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setCoverType' is assigned a value but never used.","line":114,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":114,"endColumn":35},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":118,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4382,4385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4382,4385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'onProfileSubmit' is defined but never used.","line":185,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":185,"endColumn":35},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":267,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":267,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10090,10093],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10090,10093],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":346,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":346,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13516,13519],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13516,13519],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":371,"column":118,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":371,"endColumn":121,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15538,15541],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15538,15541],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useRouter } from \"next/navigation\"\r\nimport { zodResolver } from \"@hookform/resolvers/zod\"\r\nimport { useForm } from \"react-hook-form\"\r\nimport * as z from \"zod\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n    Form,\r\n    FormControl,\r\n    FormDescription,\r\n    FormField,\r\n    FormItem,\r\n    FormLabel,\r\n    FormMessage,\r\n} from \"@/components/ui/form\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { toast } from \"sonner\"\r\nimport { updateProfile, updateAccountSettings } from \"@/app/actions/settings\"\r\nimport { toggleInvisibleMode, unblockUser } from \"@/app/actions/security\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { useState, useEffect } from \"react\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { useLanguage } from \"@/components/language-context\"\r\nimport {\r\n    AlertDialog,\r\n    AlertDialogAction,\r\n    AlertDialogCancel,\r\n    AlertDialogContent,\r\n    AlertDialogDescription,\r\n    AlertDialogFooter,\r\n    AlertDialogHeader,\r\n    AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\"\r\nimport { ArrowLeft } from \"lucide-react\"\r\nimport { useTheme } from \"next-themes\"\r\nimport { useAuth } from \"@/components/auth-provider\"\r\n// import { useClerk } from \"@clerk/nextjs\" // Removed\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Slider } from \"@/components/ui/slider\"\r\n\r\n// --- Schemas ---\r\nconst profileFormSchema = z.object({\r\n    displayName: z.string().min(2, {\r\n        message: \"Display name must be at least 2 characters.\",\r\n    }).refine((val) => val.trim().split(/\\s+/).length >= 2, {\r\n        message: \"Please enter your First and Last Name\",\r\n    }),\r\n    bio: z.string().max(160).optional(),\r\n    imageUrl: z.string().optional(),\r\n    coverUrl: z.string().optional(),\r\n    coverType: z.string().optional(),\r\n    birthday: z.string().optional(),\r\n})\r\n\r\nconst accountFormSchema = z.object({\r\n    language: z.string().optional(),\r\n    theme: z.string().optional(),\r\n    autoScrollEnabled: z.boolean().optional(),\r\n    autoScrollSpeed: z.number().min(10).max(100).optional(),\r\n})\r\n\r\ntype ProfileFormValues = z.infer<typeof profileFormSchema>\r\ntype AccountFormValues = z.infer<typeof accountFormSchema>\r\n\r\ninterface SettingsContentProps {\r\n    user: {\r\n        id: string;\r\n        displayName?: string | null;\r\n        imageUrl?: string | null;\r\n        coverUrl?: string | null;\r\n        coverType?: string | null;\r\n        bio?: string | null;\r\n        language?: string | null;\r\n        theme?: string | null;\r\n        birthday?: string | null;\r\n        isInvisible?: boolean;\r\n        isPublicProfile?: boolean;\r\n        email?: string | null;\r\n    },\r\n    blockedUsers: {\r\n        id: string;\r\n        displayName?: string | null;\r\n        email: string;\r\n        imageUrl?: string | null;\r\n        profileData: unknown;\r\n    }[]\r\n}\r\n\r\nexport function SettingsContent({ user, blockedUsers }: SettingsContentProps) {\r\n    const router = useRouter()\r\n    const { t, setLanguage } = useLanguage()\r\n    const { setTheme } = useTheme()\r\n    // const { signOut } = useAuth() // Unused\r\n    // const { openUserProfile } = useClerk() // Removed Clerk\r\n    const [showExitDialog, setShowExitDialog] = useState(false)\r\n\r\n    console.log(\"[SettingsContent] user prop:\", user);\r\n    console.log(\"[SettingsContent] blockedUsers prop:\", blockedUsers);\r\n    console.log(\"[SettingsContent] isInvisible initial state:\", user.isInvisible);\r\n\r\n    // --- Profile Form State ---\r\n    const [imageUrl, setImageUrl] = useState<string | undefined>(user.imageUrl || undefined)\r\n    const [coverUrl, setCoverUrl] = useState<string | undefined>(user.coverUrl || undefined)\r\n    const [coverType, setCoverType] = useState<'image' | 'video' | undefined>(user.coverType as 'image' | 'video' || undefined)\r\n    const [isInvisible, setIsInvisible] = useState(user.isInvisible || false);\r\n    const [isPublicProfile, setIsPublicProfile] = useState(user.isPublicProfile || false);\r\n    const [blockedList, setBlockedList] = useState(blockedUsers);\r\n    const [searchResults, setSearchResults] = useState<any[]>([]);\r\n\r\n    // Auto-scroll state\r\n    const [autoScrollEnabled, setAutoScrollEnabled] = useState(() => {\r\n        if (typeof window === 'undefined') return true;\r\n        const saved = localStorage.getItem('famio-auto-scroll-enabled');\r\n        return saved !== null ? saved === 'true' : true;\r\n    });\r\n\r\n    const [autoScrollSpeed, setAutoScrollSpeed] = useState(() => {\r\n        if (typeof window === 'undefined') return 30;\r\n        const saved = localStorage.getItem('famio-auto-scroll-speed');\r\n        return saved !== null ? parseInt(saved, 10) : 30;\r\n    });\r\n\r\n    // Initialize localStorage with defaults if not set\r\n    useEffect(() => {\r\n        if (typeof window !== 'undefined') {\r\n            const enabledSaved = localStorage.getItem('famio-auto-scroll-enabled');\r\n            const speedSaved = localStorage.getItem('famio-auto-scroll-speed');\r\n\r\n            if (enabledSaved === null) {\r\n                console.log('[Settings] Setting default auto-scroll enabled: true');\r\n                localStorage.setItem('famio-auto-scroll-enabled', 'true');\r\n            }\r\n            if (speedSaved === null) {\r\n                console.log('[Settings] Setting default auto-scroll speed: 30');\r\n                localStorage.setItem('famio-auto-scroll-speed', '30');\r\n            }\r\n        }\r\n    }, []);\r\n\r\n    const profileForm = useForm<ProfileFormValues>({\r\n        resolver: zodResolver(profileFormSchema),\r\n        defaultValues: {\r\n            displayName: user.displayName || \"\",\r\n            bio: user.bio || \"\",\r\n            imageUrl: user.imageUrl || \"\",\r\n            coverUrl: user.coverUrl || \"\",\r\n            coverType: user.coverType || \"\",\r\n            birthday: user.birthday || \"\",\r\n        },\r\n    })\r\n\r\n    // --- Account Form State ---\r\n    const accountForm = useForm<AccountFormValues>({\r\n        resolver: zodResolver(accountFormSchema),\r\n        defaultValues: {\r\n            language: user.language || \"en\",\r\n            theme: user.theme || \"system\",\r\n            autoScrollEnabled,\r\n            autoScrollSpeed,\r\n        },\r\n    })\r\n\r\n    // Listen to theme changes - Only apply if theme field specifically changed\r\n    const themeValue = accountForm.watch(\"theme\")\r\n    useEffect(() => {\r\n        // Only apply theme if the theme field itself was changed (not other fields)\r\n        const themeFieldState = accountForm.getFieldState(\"theme\");\r\n        if (themeValue && themeFieldState.isDirty) {\r\n            console.log('[Settings] Applying theme:', themeValue);\r\n            setTheme(themeValue)\r\n        }\r\n    }, [themeValue, setTheme, accountForm])\r\n\r\n    // --- Submit Handlers ---\r\n    async function onProfileSubmit(data: ProfileFormValues) {\r\n        try {\r\n            await updateProfile({\r\n                ...data,\r\n                imageUrl: imageUrl,\r\n                coverUrl: coverUrl,\r\n                coverType: coverType,\r\n                birthday: data.birthday\r\n            })\r\n            profileForm.reset({ ...data, imageUrl, coverUrl, coverType, birthday: data.birthday })\r\n            return true\r\n        } catch {\r\n            return false\r\n        }\r\n    }\r\n\r\n    async function onAccountSubmit(data: AccountFormValues) {\r\n        try {\r\n            // Save auto-scroll settings to localStorage\r\n            if (data.autoScrollEnabled !== undefined) {\r\n                localStorage.setItem('famio-auto-scroll-enabled', String(data.autoScrollEnabled));\r\n                setAutoScrollEnabled(data.autoScrollEnabled);\r\n            }\r\n            if (data.autoScrollSpeed !== undefined) {\r\n                localStorage.setItem('famio-auto-scroll-speed', String(data.autoScrollSpeed));\r\n                setAutoScrollSpeed(data.autoScrollSpeed);\r\n            }\r\n\r\n            await updateAccountSettings(data)\r\n            if (data.language) {\r\n                // @ts-ignore\r\n                setLanguage(data.language)\r\n            }\r\n            accountForm.reset(data)\r\n            return true\r\n        } catch {\r\n            return false\r\n        }\r\n    }\r\n\r\n    // --- Security Handlers ---\r\n    const handleToggleInvisible = async (checked: boolean) => {\r\n        setIsInvisible(checked);\r\n        try {\r\n            toast.success(checked ? \"Invisible mode enabled\" : \"Invisible mode disabled\");\r\n        } catch {\r\n            setIsInvisible(!checked); // Revert on error\r\n            toast.error(\"Failed to update visibility\");\r\n        }\r\n    };\r\n\r\n    const handleTogglePublicProfile = async (checked: boolean) => {\r\n        setIsPublicProfile(checked);\r\n        try {\r\n            await updateAccountSettings({ isPublicProfile: checked });\r\n            toast.success(checked ? \"Profile is now PUBLIC\" : \"Profile is now PRIVATE\");\r\n        } catch {\r\n            setIsPublicProfile(!checked); // Revert on error\r\n            toast.error(\"Failed to update profile visibility\");\r\n        }\r\n    };\r\n\r\n    const handleUnblock = async (userId: string) => {\r\n        try {\r\n            await unblockUser(userId);\r\n            setBlockedList(prev => prev.filter(u => u.id !== userId));\r\n            toast.success(\"Member unblocked\");\r\n        } catch {\r\n            toast.error(\"Failed to unblock member\");\r\n        }\r\n    };\r\n\r\n    const handlePasswordReset = async () => {\r\n        if (!user.email) {\r\n            toast.error(\"User email not found\");\r\n            return;\r\n        }\r\n        try {\r\n            const { getAuth, sendPasswordResetEmail } = await import(\"firebase/auth\");\r\n            const auth = getAuth();\r\n            await sendPasswordResetEmail(auth, user.email);\r\n            toast.success(\"Password reset email sent!\", { description: \"Please check your inbox and Junk/Spam folder.\" });\r\n        } catch (error: any) {\r\n            console.error(\"Password reset error:\", error);\r\n            toast.error(error.message || \"Failed to send reset email\");\r\n        }\r\n    };\r\n\r\n    // --- Unified Exit Logic ---\r\n    const isDirty = accountForm.formState.isDirty\r\n\r\n    const handleExit = () => {\r\n        if (isDirty) {\r\n            setShowExitDialog(true)\r\n        } else {\r\n            router.push('/')\r\n        }\r\n    }\r\n\r\n    const handleDiscardAndExit = () => {\r\n        router.push('/')\r\n    }\r\n\r\n    const handleSaveAndExit = async () => {\r\n        const promises = []\r\n        if (accountForm.formState.isDirty) {\r\n            promises.push(accountForm.handleSubmit(onAccountSubmit)())\r\n        }\r\n\r\n        const results = await Promise.all(promises)\r\n        const allSuccess = results.every(Boolean)\r\n\r\n        if (allSuccess) {\r\n            toast.success(\"Settings updated\")\r\n            router.refresh()\r\n            router.push('/')\r\n        } else {\r\n            toast.error(\"Some settings failed to save\")\r\n        }\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <div className=\"flex flex-col space-y-8 lg:flex-row lg:space-x-12 lg:space-y-0 relative\">\r\n                <div className=\"flex-1 lg:max-w-2xl space-y-6\">\r\n                    {/* Header with Exit Button */}\r\n                    <div className=\"flex items-center justify-between mb-4\">\r\n                        <div>\r\n                            <h2 className=\"text-2xl font-bold tracking-tight\">Settings</h2>\r\n                            <p className=\"text-muted-foreground\">\r\n                                Manage your profile and account preferences.\r\n                            </p>\r\n                        </div>\r\n                        <Button variant=\"outline\" onClick={handleExit} className=\"gap-2\">\r\n                            <ArrowLeft className=\"w-4 h-4\" />\r\n                            Exit\r\n                        </Button>\r\n                    </div>\r\n\r\n                    {/* Profile Section Moved to /profile */}\r\n\r\n                    {/* Security Section */}\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle>Privacy & Security</CardTitle>\r\n                            <CardDescription>\r\n                                Manage your visibility and blocked users.\r\n                            </CardDescription>\r\n                        </CardHeader>\r\n                        <CardContent className=\"space-y-6\">\r\n                            {/* 1. Block Search (Moved to Top) */}\r\n                            <div className=\"space-y-4\">\r\n                                <Label className=\"text-base\">{t(\"settings.block.title\")}</Label>\r\n                                <div className=\"flex gap-2\">\r\n                                    <Input\r\n                                        placeholder=\"Search by name...\"\r\n                                        onChange={async (e) => {\r\n                                            const q = e.target.value;\r\n                                            if (q.length >= 2) {\r\n                                                const { searchUsers } = await import(\"@/app/actions/user\"); // Keep dynamic or move to top? Let's keep for now but simplify structure\r\n                                                const results = await searchUsers(q);\r\n                                                const unblockedResults = results.filter((r: any) => !blockedList.some(b => b.id === r.id));\r\n                                                setSearchResults(unblockedResults);\r\n                                            } else {\r\n                                                setSearchResults([]);\r\n                                            }\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                                {searchResults.length > 0 && (\r\n                                    <div className=\"border rounded-md divide-y max-h-48 overflow-y-auto\">\r\n                                        {searchResults.map(u => (\r\n                                            <div key={u.id} className=\"p-2 flex justify-between items-center bg-card hover:bg-muted/50\">\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <Avatar className=\"w-8 h-8\">\r\n                                                        <AvatarImage src={u.imageUrl} />\r\n                                                        <AvatarFallback>{u.displayName?.slice(0, 2).toUpperCase()}</AvatarFallback>\r\n                                                    </Avatar>\r\n                                                    <span className=\"text-sm font-medium\">{u.displayName}</span>\r\n                                                </div>\r\n                                                <Button\r\n                                                    size=\"sm\"\r\n                                                    variant=\"destructive\"\r\n                                                    onClick={async () => {\r\n                                                        const { blockUser } = await import(\"@/app/actions/security\");\r\n                                                        await blockUser(u.id);\r\n                                                        setBlockedList(prev => [...prev, { ...u, profileData: u } as any]);\r\n                                                        setSearchResults(prev => prev.filter(r => r.id !== u.id));\r\n                                                        toast.error(`Blocked ${u.displayName}`);\r\n                                                    }}\r\n                                                >\r\n                                                    {t(\"button.block\")}\r\n                                                </Button>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* 2. Invisible Mode */}\r\n                            <div className=\"flex items-center justify-between pt-4 border-t border-border\">\r\n                                <div className=\"space-y-0.5\">\r\n                                    <Label className=\"text-base\">{t(\"settings.invisible.title\")}</Label>\r\n                                    <p className=\"text-sm text-muted-foreground\">\r\n                                        {t(\"settings.invisible.desc\")}\r\n                                    </p>\r\n                                </div>\r\n                                <Switch\r\n                                    checked={isInvisible}\r\n                                    onCheckedChange={handleToggleInvisible}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* 3. Public Profile */}\r\n                            <div className=\"flex items-center justify-between pt-4 border-t border-border\">\r\n                                <div className=\"space-y-0.5\">\r\n                                    <Label className=\"text-base text-blue-600\">{t(\"settings.public.title\")}</Label>\r\n                                    <p className=\"text-sm text-muted-foreground\">\r\n                                        {t(\"settings.public.desc\")}\r\n                                        <br />\r\n                                        <span className=\"text-xs text-amber-600 font-medium\">Note: Private messages and settings remain secure.</span>\r\n                                    </p>\r\n                                </div>\r\n                                <Switch\r\n                                    checked={isPublicProfile}\r\n                                    onCheckedChange={handleTogglePublicProfile}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* 3. Blocked List */}\r\n                            <div className=\"space-y-4 pt-4 border-t border-border\">\r\n                                <Label className=\"text-base\">{t(\"settings.block.list.title\")}</Label>\r\n                                {blockedList.length === 0 ? (\r\n                                    <p className=\"text-sm text-muted-foreground\">{t(\"settings.block.empty\")}</p>\r\n                                ) : (\r\n                                    <div className=\"space-y-2\">\r\n                                        {blockedList.map((blockedUser) => {\r\n                                            const profile = blockedUser.profileData as { firstName: string, lastName: string } | null;\r\n                                            const name = blockedUser.displayName || (profile?.firstName ? `${profile.firstName} ${profile.lastName}` : blockedUser.email);\r\n                                            return (\r\n                                                <div key={blockedUser.id} className=\"flex items-center justify-between p-3 bg-muted/50 rounded-lg\">\r\n                                                    <div className=\"flex items-center gap-3\">\r\n                                                        <Avatar className=\"h-8 w-8\">\r\n                                                            <AvatarImage src={blockedUser.imageUrl || undefined} />\r\n                                                            <AvatarFallback>{name.slice(0, 2).toUpperCase()}</AvatarFallback>\r\n                                                        </Avatar>\r\n                                                        <span className=\"text-sm font-medium\">{name}</span>\r\n                                                    </div>\r\n                                                    <Button variant=\"ghost\" size=\"sm\" onClick={() => handleUnblock(blockedUser.id)}>\r\n                                                        {t(\"button.unblock\")}\r\n                                                    </Button>\r\n                                                </div>\r\n                                            );\r\n                                        })}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Account Section */}\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle>{t(\"settings.account.title\")}</CardTitle>\r\n                            <CardDescription>{t(\"settings.account.desc\")}</CardDescription>\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <Form {...accountForm}>\r\n                                <form onSubmit={accountForm.handleSubmit(async (data) => {\r\n                                    if (await onAccountSubmit(data)) {\r\n                                        toast.success(\"Account settings updated\")\r\n                                        router.refresh()\r\n                                    } else {\r\n                                        toast.error(\"Failed to update settings\")\r\n                                    }\r\n                                })} className=\"space-y-8\">\r\n                                    <FormField\r\n                                        control={accountForm.control}\r\n                                        name=\"language\"\r\n                                        render={({ field }) => (\r\n                                            <FormItem>\r\n                                                <FormLabel>{t(\"settings.language\")}</FormLabel>\r\n                                                <Select onValueChange={field.onChange} defaultValue={field.value}>\r\n                                                    <FormControl>\r\n                                                        <SelectTrigger>\r\n                                                            <SelectValue placeholder=\"Select a language\" />\r\n                                                        </SelectTrigger>\r\n                                                    </FormControl>\r\n                                                    <SelectContent>\r\n                                                        <SelectItem value=\"en\">English</SelectItem>\r\n                                                        <SelectItem value=\"zh\">‰∏≠Êñá (Mandarin)</SelectItem>\r\n                                                        <SelectItem value=\"hi\">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</SelectItem>\r\n                                                        <SelectItem value=\"es\">Espa√±ol</SelectItem>\r\n                                                        <SelectItem value=\"fr\">Fran√ßais</SelectItem>\r\n                                                        <SelectItem value=\"ar\">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</SelectItem>\r\n                                                    </SelectContent>\r\n                                                </Select>\r\n                                                <FormDescription>{t(\"settings.language.desc\")}</FormDescription>\r\n                                                <FormMessage />\r\n                                            </FormItem>\r\n                                        )}\r\n                                    />\r\n                                    <FormField\r\n                                        control={accountForm.control}\r\n                                        name=\"theme\"\r\n                                        render={({ field }) => (\r\n                                            <FormItem>\r\n                                                <FormLabel>{t(\"settings.theme\")}</FormLabel>\r\n                                                <Select onValueChange={field.onChange} defaultValue={field.value}>\r\n                                                    <FormControl>\r\n                                                        <SelectTrigger>\r\n                                                            <SelectValue placeholder=\"Select a theme\" />\r\n                                                        </SelectTrigger>\r\n                                                    </FormControl>\r\n                                                    <SelectContent>\r\n                                                        <SelectItem value=\"light\">Light</SelectItem>\r\n                                                        <SelectItem value=\"dark\">Dark</SelectItem>\r\n                                                        <SelectItem value=\"system\">System</SelectItem>\r\n                                                    </SelectContent>\r\n                                                </Select>\r\n                                                <FormDescription>{t(\"settings.theme.desc\")}</FormDescription>\r\n                                                <FormMessage />\r\n                                            </FormItem>\r\n                                        )}\r\n                                    />\r\n\r\n                                    {/* Feed Preferences Section */}\r\n                                    <div className=\"space-y-6 pt-6 border-t\">\r\n                                        <div>\r\n                                            <h3 className=\"text-lg font-medium\">{t(\"settings.feed.title\")}</h3>\r\n                                            <p className=\"text-sm text-muted-foreground\">{t(\"settings.feed.desc\")}</p>\r\n                                        </div>\r\n\r\n                                        <FormField\r\n                                            control={accountForm.control}\r\n                                            name=\"autoScrollEnabled\"\r\n                                            render={({ field }) => (\r\n                                                <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\r\n                                                    <div className=\"space-y-0.5\">\r\n                                                        <FormLabel className=\"text-base\">{t(\"settings.autoscroll.title\")}</FormLabel>\r\n                                                        <FormDescription>\r\n                                                            {t(\"settings.autoscroll.desc\")}\r\n                                                        </FormDescription>\r\n                                                    </div>\r\n                                                    <FormControl>\r\n                                                        <Switch\r\n                                                            checked={field.value}\r\n                                                            onCheckedChange={field.onChange}\r\n                                                        />\r\n                                                    </FormControl>\r\n                                                </FormItem>\r\n                                            )}\r\n                                        />\r\n\r\n                                        <FormField\r\n                                            control={accountForm.control}\r\n                                            name=\"autoScrollSpeed\"\r\n                                            render={({ field }) => (\r\n                                                <FormItem>\r\n                                                    <div className=\"flex items-center justify-between\">\r\n                                                        <FormLabel>{t(\"settings.speed.title\")}</FormLabel>\r\n                                                        <span className=\"text-sm text-muted-foreground\">{field.value} px/s</span>\r\n                                                    </div>\r\n                                                    <FormControl>\r\n                                                        <Slider\r\n                                                            min={10}\r\n                                                            max={100}\r\n                                                            step={5}\r\n                                                            value={[field.value || 30]}\r\n                                                            onValueChange={(values: number[]) => field.onChange(values[0])}\r\n                                                            className=\"w-full\"\r\n                                                        />\r\n                                                    </FormControl>\r\n                                                    <FormDescription>\r\n                                                        {t(\"settings.speed.desc\")}\r\n                                                    </FormDescription>\r\n                                                    <FormMessage />\r\n                                                </FormItem>\r\n                                            )}\r\n                                        />\r\n                                    </div>\r\n\r\n                                    <div className=\"space-y-4 pt-4 border-t border-border\">\r\n                                        <Label className=\"text-base\">{t(\"settings.security.title\")}</Label>\r\n                                        <p className=\"text-sm text-muted-foreground\">\r\n                                            {t(\"settings.security.desc\")}\r\n                                        </p>\r\n                                        <Button\r\n                                            type=\"button\"\r\n                                            variant=\"outline\"\r\n                                            className=\"w-full text-blue-600 border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20\"\r\n                                            onClick={handlePasswordReset}\r\n                                        >\r\n                                            {t(\"settings.password.button\")}\r\n                                        </Button>\r\n                                    </div>\r\n\r\n                                    <Button type=\"submit\">{t(\"settings.updateAccount\")}</Button>\r\n                                </form>\r\n                            </Form>\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n            </div>\r\n\r\n            <AlertDialog open={showExitDialog} onOpenChange={setShowExitDialog}>\r\n                <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                        <AlertDialogTitle>Unsaved Changes</AlertDialogTitle>\r\n                        <AlertDialogDescription>\r\n                            You have unsaved changes. Do you want to save them before exiting?\r\n                        </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                        <AlertDialogCancel onClick={() => setShowExitDialog(false)}>Cancel</AlertDialogCancel>\r\n                        <Button variant=\"outline\" onClick={handleDiscardAndExit}>Discard</Button>\r\n                        <Button onClick={handleSaveAndExit}>Save & Exit</Button>\r\n                    </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n            </AlertDialog>\r\n        </>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\shared\\cover-upload-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userId' is defined but never used.","line":23,"column":84,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":90},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2589,2592],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2589,2592],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3207,3210],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3207,3210],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":114,"column":37,"nodeType":"JSXOpeningElement","endLine":114,"endColumn":114},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":120,"column":37,"nodeType":"JSXOpeningElement","endLine":120,"endColumn":125}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Upload, X, Loader2 } from \"lucide-react\";\r\nimport { storage } from \"@/lib/firebase\";\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\";\r\nimport { toast } from \"sonner\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { updateGroupCover } from \"@/app/actions/groups\";\r\nimport { updateBrandingCover } from \"@/app/actions/branding\";\r\n\r\ninterface CoverUploadDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    type: \"group\" | \"branding\";\r\n    id: string;\r\n    currentCoverUrl?: string | null;\r\n    userId: string;\r\n}\r\n\r\nexport function CoverUploadDialog({ open, onOpenChange, type, id, currentCoverUrl, userId }: CoverUploadDialogProps) {\r\n    const [uploading, setUploading] = useState(false);\r\n    const [previewUrl, setPreviewUrl] = useState<string | null>(null);\r\n    const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n    const router = useRouter();\r\n\r\n    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files && e.target.files[0]) {\r\n            const file = e.target.files[0];\r\n            setSelectedFile(file);\r\n\r\n            // Create preview\r\n            const reader = new FileReader();\r\n            reader.onloadend = () => {\r\n                setPreviewUrl(reader.result as string);\r\n            };\r\n            reader.readAsDataURL(file);\r\n        }\r\n    };\r\n\r\n    const handleUpload = async () => {\r\n        if (!selectedFile) return;\r\n\r\n        setUploading(true);\r\n        try {\r\n            const storagePath = type === \"group\"\r\n                ? `groups/${id}/cover/${Date.now()}-${selectedFile.name}`\r\n                : `branding/${id}/cover/${Date.now()}-${selectedFile.name}`;\r\n\r\n            const storageRef = ref(storage, storagePath);\r\n            const snapshot = await uploadBytes(storageRef, selectedFile);\r\n            const url = await getDownloadURL(snapshot.ref);\r\n\r\n            // Update cover using appropriate action\r\n            if (type === \"group\") {\r\n                await updateGroupCover(id, url);\r\n            } else {\r\n                await updateBrandingCover(id, url);\r\n            }\r\n\r\n            toast.success(\"Cover updated successfully!\");\r\n            router.refresh();\r\n            onOpenChange(false);\r\n            setPreviewUrl(null);\r\n            setSelectedFile(null);\r\n        } catch (error: any) {\r\n            console.error(\"Upload error:\", error);\r\n            toast.error(error.message || \"Failed to upload cover\");\r\n        } finally {\r\n            setUploading(false);\r\n        }\r\n    };\r\n\r\n    const handleRemove = async () => {\r\n        setUploading(true);\r\n        try {\r\n            if (type === \"group\") {\r\n                await updateGroupCover(id, null);\r\n            } else {\r\n                await updateBrandingCover(id, null);\r\n            }\r\n\r\n            toast.success(\"Cover removed successfully!\");\r\n            router.refresh();\r\n            onOpenChange(false);\r\n        } catch (error: any) {\r\n            console.error(\"Remove error:\", error);\r\n            toast.error(error.message || \"Failed to remove cover\");\r\n        } finally {\r\n            setUploading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-md\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Update Cover Photo</DialogTitle>\r\n                    <DialogDescription>\r\n                        Upload a photo or video to use as your {type} cover. Recommended size: 1200x400px\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-4\">\r\n                    {/* Preview */}\r\n                    {(previewUrl || currentCoverUrl) && (\r\n                        <div className=\"relative w-full h-40 rounded-lg overflow-hidden bg-muted\">\r\n                            {previewUrl ? (\r\n                                selectedFile?.type.startsWith('video/') ? (\r\n                                    <video src={previewUrl} className=\"w-full h-full object-cover\" autoPlay loop muted />\r\n                                ) : (\r\n                                    <img src={previewUrl} alt=\"Preview\" className=\"w-full h-full object-cover\" />\r\n                                )\r\n                            ) : currentCoverUrl ? (\r\n                                currentCoverUrl.includes('mp4') || currentCoverUrl.includes('webm') ? (\r\n                                    <video src={currentCoverUrl} className=\"w-full h-full object-cover\" autoPlay loop muted />\r\n                                ) : (\r\n                                    <img src={currentCoverUrl} alt=\"Current cover\" className=\"w-full h-full object-cover\" />\r\n                                )\r\n                            ) : null}\r\n\r\n                            {previewUrl && (\r\n                                <button\r\n                                    onClick={() => {\r\n                                        setPreviewUrl(null);\r\n                                        setSelectedFile(null);\r\n                                    }}\r\n                                    className=\"absolute top-2 right-2 bg-black/50 text-white rounded-full p-1 hover:bg-black/70\"\r\n                                >\r\n                                    <X className=\"w-4 h-4\" />\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Upload Button */}\r\n                    <div className=\"flex flex-col gap-2\">\r\n                        <label htmlFor=\"cover-upload\">\r\n                            <div className=\"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center hover:border-primary/50 cursor-pointer transition-colors\">\r\n                                <Upload className=\"w-8 h-8 mx-auto mb-2 text-muted-foreground\" />\r\n                                <p className=\"text-sm text-muted-foreground\">\r\n                                    Click to upload photo or video\r\n                                </p>\r\n                                <p className=\"text-xs text-muted-foreground mt-1\">\r\n                                    JPG, PNG, MP4, or WebM\r\n                                </p>\r\n                            </div>\r\n                        </label>\r\n                        <input\r\n                            id=\"cover-upload\"\r\n                            type=\"file\"\r\n                            accept=\"image/*,video/mp4,video/webm\"\r\n                            onChange={handleFileSelect}\r\n                            className=\"hidden\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Actions */}\r\n                    <div className=\"flex gap-2\">\r\n                        {selectedFile && (\r\n                            <Button\r\n                                onClick={handleUpload}\r\n                                disabled={uploading}\r\n                                className=\"flex-1\"\r\n                            >\r\n                                {uploading && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\r\n                                Upload\r\n                            </Button>\r\n                        )}\r\n                        {currentCoverUrl && !selectedFile && (\r\n                            <Button\r\n                                onClick={handleRemove}\r\n                                disabled={uploading}\r\n                                variant=\"destructive\"\r\n                                className=\"flex-1\"\r\n                            >\r\n                                {uploading && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\r\n                                Remove Cover\r\n                            </Button>\r\n                        )}\r\n                        <Button\r\n                            onClick={() => onOpenChange(false)}\r\n                            variant=\"outline\"\r\n                            disabled={uploading}\r\n                        >\r\n                            Cancel\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\shared\\linkify.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'urlRegex'. Either include it or remove the dependency array.","line":53,"column":8,"nodeType":"ArrayExpression","endLine":53,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [text, mounted, onMediaFound, urlRegex]","fix":{"range":[1949,1978],"text":"[text, mounted, onMediaFound, urlRegex]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chanc\\Documents\\WeAreFamily\\components\\shared\\linkify.tsx:20:9\n  18 |     useEffect(() => {\n  19 |         // eslint-disable-next-line react-hooks/set-state-in-effect\n> 20 |         setMounted(true);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  21 |     }, []);\n  22 |\n  23 |","line":20,"column":9,"nodeType":null,"endLine":20,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport React, { useState, useEffect } from \"react\";\r\n\r\ninterface LinkifyProps {\r\n    text: string;\r\n    className?: string;\r\n    onMediaFound?: (url: string) => void;\r\n    hideUrls?: string[];\r\n}\r\n\r\nexport function Linkify({ text, className, onMediaFound, hideUrls }: LinkifyProps) {\r\n    // improved regex to separate punctuation at the end of a URL\r\n    // This captures the URL provided it starts with http/https and doesn't contain whitespace.\r\n    // It blindly captures until a space. We will clean it up inside.\r\n    const urlRegex = /(https?:\\/\\/[^\\s]+)/g;\r\n    const [mounted, setMounted] = useState(false);\r\n\r\n    useEffect(() => {\r\n        // eslint-disable-next-line react-hooks/set-state-in-effect\r\n        setMounted(true);\r\n    }, []);\r\n\r\n\r\n\r\n    // Detect media in a side effect, not during render\r\n    useEffect(() => {\r\n        if (!mounted || !onMediaFound) return;\r\n\r\n        // Re-scan text for media to notify parent (idempotent check ideally handled by parent or here)\r\n        // For simplicity, we just find the first video and report it once if needed.\r\n        // But since we can't easily sync \"capturedMedia\" across renders without state,\r\n        // we'll skip the complex deduping here and assume onMediaFound handles it or is stable.\r\n\r\n\r\n        const matches = text.match(urlRegex) || [];\r\n\r\n        for (const url of matches) {\r\n            const lower = url.toLowerCase();\r\n            const isVideo = lower.includes('youtube.com') ||\r\n                lower.includes('youtu.be') ||\r\n                lower.includes('facebook.com') ||\r\n                lower.includes('linkedin.com') ||\r\n                lower.includes('.mp4') ||\r\n                lower.includes('vimeo.com') ||\r\n                lower.includes('dailymotion.com');\r\n\r\n            if (isVideo) {\r\n                onMediaFound(url);\r\n\r\n                break; // Only report the first one\r\n            }\r\n        }\r\n    }, [text, mounted, onMediaFound]); // urlRegex is constant enough or we can recreate logic\r\n\r\n    if (!text) return null;\r\n\r\n    if (!mounted) return <span className={className}>{text}</span>;\r\n\r\n    const parts = text.split(urlRegex);\r\n\r\n    return (\r\n        <span className={className}>\r\n            {parts.map((part, i) => {\r\n                if (part.match(urlRegex)) {\r\n                    // This part is a URL\r\n                    let url = part;\r\n                    let suffix = '';\r\n\r\n                    // Basic cleanup for punctuation at the end of a URL\r\n                    const lastChar = url[url.length - 1];\r\n                    if (lastChar && (lastChar === '.' || lastChar === ',' || lastChar === '!' || lastChar === '?')) {\r\n                        url = url.slice(0, -1);\r\n                        suffix = lastChar;\r\n                    }\r\n\r\n                    // Check if this URL should be hidden (e.g. because it's embedded)\r\n                    // We check if the exact clean URL is in the hidden list\r\n                    if (hideUrls && hideUrls.includes(url)) {\r\n                        return <span key={i}>{suffix}</span>;\r\n                    }\r\n\r\n                    return (\r\n                        <span key={i}>\r\n                            <Link\r\n                                href={url}\r\n                                target=\"_blank\"\r\n                                rel=\"noopener noreferrer\"\r\n                                className=\"text-primary hover:underline break-all\"\r\n                                onClick={(e) => e.stopPropagation()}\r\n                            >\r\n                                {url}\r\n                            </Link>\r\n                            {suffix}\r\n                        </span>\r\n                    );\r\n                }\r\n                return <span key={i}>{part}</span>;\r\n            })}\r\n        </span>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\shared\\safe-date.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[176,179],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[176,179],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":30,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":19}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chanc\\Documents\\WeAreFamily\\components\\shared\\safe-date.tsx:17:9\n  15 |     useEffect(() => {\n  16 |         // eslint-disable-next-line react-hooks/set-state-in-effect\n> 17 |         setMounted(true);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  18 |         try {\n  19 |             if (!date) {\n  20 |                 setText(fallback);","line":17,"column":9,"nodeType":null,"endLine":17,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { formatDistanceToNow } from 'date-fns';\r\n\r\ninterface SafeDateProps {\r\n    date: Date | string | number | any;\r\n    fallback?: string;\r\n}\r\n\r\nexport function SafeDate({ date, fallback = \"Just now\" }: SafeDateProps) {\r\n    const [mounted, setMounted] = useState(false);\r\n    const [text, setText] = useState<string>(\"\");\r\n\r\n    useEffect(() => {\r\n        // eslint-disable-next-line react-hooks/set-state-in-effect\r\n        setMounted(true);\r\n        try {\r\n            if (!date) {\r\n                setText(fallback);\r\n                return;\r\n            }\r\n            const d = new Date(date);\r\n            // Check for invalid date\r\n            if (isNaN(d.getTime())) {\r\n                setText(fallback);\r\n                return;\r\n            }\r\n            setText(formatDistanceToNow(d, { addSuffix: true }));\r\n        } catch (e) {\r\n            setText(fallback);\r\n        }\r\n    }, [date, fallback]);\r\n\r\n    // Always render the span to ensure the DOM tree structure matches between server and client.\r\n    // hydration warning prevented by suppressHydrationWarning\r\n    return (\r\n        <span suppressHydrationWarning>\r\n            {mounted ? text : fallback}\r\n        </span>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\shared\\share-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":5,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Check"},"fix":{"range":[117,124],"text":""},"desc":"Remove unused variable \"Check\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":36,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Share2, Check, ExternalLink } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuItem,\r\n    DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\n\r\ninterface ShareButtonProps {\r\n    title: string;\r\n    text: string;\r\n    url?: string; // Optional override, defaults to current window.location\r\n    variant?: \"default\" | \"outline\" | \"ghost\" | \"secondary\";\r\n    size?: \"default\" | \"sm\" | \"lg\" | \"icon\";\r\n    className?: string;\r\n}\r\n\r\nexport function ShareButton({ title, text, url, variant = \"outline\", size = \"default\", className }: ShareButtonProps) {\r\n    const [open, setOpen] = useState(false);\r\n\r\n    const getUrl = () => {\r\n        if (typeof window === 'undefined') return '';\r\n        return url || window.location.href;\r\n    };\r\n\r\n    const handleCopy = async () => {\r\n        const shareUrl = getUrl();\r\n        try {\r\n            await navigator.clipboard.writeText(shareUrl);\r\n            toast.success(\"Link copied to clipboard\");\r\n        } catch (err) {\r\n            toast.error(\"Failed to copy link\");\r\n        }\r\n    };\r\n\r\n    const handleNativeShare = () => {\r\n        const shareUrl = getUrl();\r\n        if (navigator.share) {\r\n            navigator.share({\r\n                title: title,\r\n                text: text,\r\n                url: shareUrl,\r\n            }).then(() => {\r\n                toast.success(\"Shared successfully\");\r\n            }).catch((err) => {\r\n                // User cancelled or failed\r\n                if (err.name !== 'AbortError') {\r\n                    console.error('Share failed:', err);\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    // If native sharing is available, prefer it on mobile, but on desktop show options\r\n    // Actually, Dropdown is safer everywhere to give choice (Copy vs Share)\r\n\r\n    return (\r\n        <DropdownMenu open={open} onOpenChange={setOpen}>\r\n            <DropdownMenuTrigger asChild>\r\n                <Button variant={variant} size={size} className={className}>\r\n                    <Share2 className=\"w-4 h-4 mr-2\" />\r\n                    Share\r\n                </Button>\r\n            </DropdownMenuTrigger>\r\n            <DropdownMenuContent align=\"end\">\r\n                <DropdownMenuItem onClick={handleNativeShare}>\r\n                    <ExternalLink className=\"w-4 h-4 mr-2\" />\r\n                    Share via...\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={handleCopy}>\r\n                    <Share2 className=\"w-4 h-4 mr-2\" />\r\n                    Copy Link\r\n                </DropdownMenuItem>\r\n            </DropdownMenuContent>\r\n        </DropdownMenu>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\stories\\create-story-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogDescription' is defined but never used.","line":5,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogDescription"},"fix":{"range":[92,111],"text":""},"desc":"Remove unused variable \"DialogDescription\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":13,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[623,626],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isSubmitting' is assigned a value but never used.","line":25,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2375,2378],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2375,2378],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'clearMedia' is assigned a value but never used.","line":84,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":84,"endColumn":21},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":119,"column":33,"nodeType":"JSXOpeningElement","endLine":119,"endColumn":126}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n\"use client\";\r\n\r\nimport { useState, useRef } from \"react\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { createStory } from \"@/app/actions/stories\";\r\n// import { uploadFile } from \"@/app/actions/upload\"; // Removed - using Firebase Storage\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { toast } from \"sonner\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Loader2, Plus, Image as ImageIcon, X } from \"lucide-react\";\r\nimport { storage } from \"@/lib/firebase\";\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\ninterface CreateStoryDialogProps {\r\n    children?: React.ReactNode;\r\n    onOpenChange?: (open: boolean) => void;\r\n}\r\n\r\nexport function CreateStoryDialog({ children }: CreateStoryDialogProps) {\r\n    const [open, setOpen] = useState(false);\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const [mediaUrl, setMediaUrl] = useState<string | null>(null);\r\n    const [mediaType, setMediaType] = useState<'image' | 'video' | null>(null);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    const { user } = useAuth();\r\n    const router = useRouter();\r\n\r\n    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (!user) {\r\n            toast.error(\"You must be logged in to add to My Life.\");\r\n            return;\r\n        }\r\n\r\n        if (e.target.files && e.target.files[0]) {\r\n            const file = e.target.files[0];\r\n            const type = file.type.startsWith('video/') ? 'video' : 'image';\r\n\r\n            setIsUploading(true);\r\n            try {\r\n                // Create a unique reference\r\n                const timestamp = Date.now();\r\n                const storageRef = ref(storage, `users/${user.uid}/stories/${timestamp}-${file.name}`);\r\n\r\n                await uploadBytes(storageRef, file);\r\n                const url = await getDownloadURL(storageRef);\r\n\r\n                setMediaUrl(url);\r\n                setMediaType(type);\r\n                toast.success(\"Media uploaded! Ready to post.\");\r\n            } catch (error: any) {\r\n                console.error(\"Upload failed\", error);\r\n                toast.error(\"Upload failed: \" + error.message);\r\n            } finally {\r\n                setIsUploading(false);\r\n            }\r\n        }\r\n    }\r\n\r\n    const handleSubmit = async () => {\r\n        if (!mediaUrl || !mediaType) return;\r\n\r\n        setIsSubmitting(true);\r\n        try {\r\n            await createStory(mediaUrl, mediaType);\r\n            toast.success(\"Added to your My Life!\");\r\n            setOpen(false);\r\n            setMediaUrl(null);\r\n            setMediaType(null);\r\n            router.refresh();\r\n        } catch (err) {\r\n            toast.error(\"Failed to post story\");\r\n            console.error(err);\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    }\r\n\r\n    const clearMedia = () => {\r\n        setMediaUrl(null);\r\n        setMediaType(null);\r\n        if (fileInputRef.current) {\r\n            fileInputRef.current.value = '';\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={setOpen}>\r\n            <DialogTrigger asChild>\r\n                {children || (\r\n                    <Button variant=\"ghost\" className=\"relative w-full h-full p-0 overflow-hidden rounded-xl\">\r\n                        <div className=\"absolute inset-0 bg-black/20 hover:bg-black/30 transition-colors flex items-center justify-center\">\r\n                            <Plus className=\"w-8 h-8 text-white\" />\r\n                        </div>\r\n                    </Button>\r\n                )}\r\n            </DialogTrigger>\r\n            <DialogContent className=\"sm:max-w-md bg-white\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Add to My Life</DialogTitle>\r\n                </DialogHeader>\r\n                <div className=\"grid gap-4 py-4\">\r\n                    {/* Preview Area */}\r\n                    <div className=\"w-full h-64 bg-black rounded-lg overflow-hidden relative flex items-center justify-center border border-border\">\r\n                        {!mediaUrl ? (\r\n                            <div className=\"text-center p-4\">\r\n                                <ImageIcon className=\"w-12 h-12 text-muted-foreground mx-auto mb-2\" />\r\n                                <p className=\"text-sm text-muted-foreground\">Select an image or video</p>\r\n                            </div>\r\n                        ) : (\r\n                            mediaType === 'video' ? (\r\n                                <video src={mediaUrl} className=\"max-w-full max-h-full\" controls />\r\n                            ) : (\r\n                                <img src={mediaUrl} alt=\"My Life preview\" className=\"max-w-full max-h-full object-contain\" />\r\n                            )\r\n                        )}\r\n\r\n                        {isUploading && (\r\n                            <div className=\"absolute inset-0 bg-black/50 flex items-center justify-center z-10\">\r\n                                <Loader2 className=\"w-8 h-8 text-white animate-spin\" />\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                        <Label htmlFor=\"story-file\" className=\"text-right\">\r\n                            Media\r\n                        </Label>\r\n                        <Input\r\n                            id=\"story-file\"\r\n                            type=\"file\"\r\n                            accept=\"image/*,video/*\"\r\n                            className=\"col-span-3\"\r\n                            onChange={handleFileSelect}\r\n                            disabled={isUploading}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <DialogFooter>\r\n                    <Button onClick={handleSubmit} disabled={!mediaUrl || isUploading}>\r\n                        {isUploading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                        Share to My Life\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\stories\\stories-tray-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Avatar' is defined but never used.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Avatar"},"fix":{"range":[168,175],"text":""},"desc":"Remove unused variable \"Avatar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AvatarFallback' is defined but never used.","line":6,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AvatarFallback"},"fix":{"range":[174,190],"text":""},"desc":"Remove unused variable \"AvatarFallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AvatarImage' is defined but never used.","line":6,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":45,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"AvatarImage"},"fix":{"range":[159,236],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentUserId' is defined but never used.","line":36,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentUserRole' is defined but never used.","line":37,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":20},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":64,"column":41,"nodeType":"JSXOpeningElement","endLine":64,"endColumn":129},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isMe' is assigned a value but never used.","line":91,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":91,"endColumn":31},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":103,"column":33,"nodeType":"JSXOpeningElement","endLine":103,"endColumn":188},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":111,"column":33,"nodeType":"JSXOpeningElement","endLine":111,"endColumn":181}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { CreateStoryDialog } from \"./create-story-dialog\";\r\nimport { StoryViewer } from \"./story-viewer\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Plus } from \"lucide-react\";\r\n\r\ninterface Story {\r\n    id: string;\r\n    mediaUrl: string;\r\n    mediaType: 'image' | 'video';\r\n    authorId: string;\r\n    createdAt: Date;\r\n}\r\n\r\ninterface UserStories {\r\n    user: {\r\n        imageUrl: string | null;\r\n        displayName: string | null;\r\n    };\r\n    stories: Story[];\r\n}\r\n\r\ninterface StoriesTrayClientProps {\r\n    currentUserId?: string; // Clerk ID\r\n    currentUserRole?: string;\r\n    currentUserImage?: string | null;\r\n    currentUserDisplayName?: string | null;\r\n    activeStories: UserStories[];\r\n}\r\n\r\nimport { useLanguage } from \"@/components/language-context\";\r\n\r\nexport function StoriesTrayClient({\r\n    currentUserId,\r\n    currentUserRole,\r\n    currentUserImage,\r\n    currentUserDisplayName,\r\n    activeStories\r\n}: StoriesTrayClientProps) {\r\n    const { t } = useLanguage();\r\n    const [viewerOpen, setViewerOpen] = useState(false);\r\n    const [selectedUserIndex, setSelectedUserIndex] = useState(0);\r\n\r\n    // Enable for all users\r\n    const canAddStory = true;\r\n\r\n    const handleStoryClick = (index: number) => {\r\n        setSelectedUserIndex(index);\r\n        setViewerOpen(true);\r\n    };\r\n\r\n    return (\r\n        <div className=\"relative mb-6\">\r\n            <div className=\"flex gap-4 overflow-x-auto pb-4 scrollbar-hide snap-x\">\r\n                {/* Add Story Card */}\r\n                {canAddStory && (\r\n                    <div className=\"flex-shrink-0 snap-start\">\r\n                        <CreateStoryDialog>\r\n                            <div className=\"relative w-28 h-48 rounded-xl overflow-hidden cursor-pointer group shadow-sm transition-transform hover:scale-[1.02]\">\r\n                                <div className=\"absolute inset-0 bg-gray-100 dark:bg-muted\">\r\n                                    {currentUserImage ? (\r\n                                        <img src={currentUserImage} alt=\"Me\" className=\"w-full h-2/3 object-cover opacity-80\" />\r\n                                    ) : (\r\n                                        <div className=\"w-full h-2/3 bg-gray-200 dark:bg-muted/80 flex items-center justify-center\">\r\n                                            <span className=\"text-2xl font-bold text-gray-400\">{currentUserDisplayName?.charAt(0)}</span>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                                <div className=\"absolute bottom-0 inset-x-0 h-1/3 bg-white dark:bg-card flex flex-col items-center justify-center pt-4 z-10\">\r\n                                    <div className=\"absolute inset-0 flex flex-col items-center justify-center bg-card transition-colors group-hover:bg-accent/50\">\r\n                                        <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mb-2 group-hover:bg-primary/20 transition-colors\">\r\n                                            <Plus className=\"w-6 h-6 text-primary\" />\r\n                                        </div>\r\n                                        <span className=\"text-xs font-semibold text-foreground\">{t(\"stories.add\")}</span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </CreateStoryDialog>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Active Stories */}\r\n                {activeStories.map((storyGroup, idx) => {\r\n                    // Check if *this* story group belongs to the current user (if so, we could merge it with the \"Add Story\" card visually, but Facebook separates them: \"Your Story\" vs \"Add\". For v1 let's just list them.)\r\n                    // Actually, standard UI is usually: My Story (Add) | Friend 1 | Friend 2. \r\n                    // If \"My Story\" exists, clicking it usually shows my story. The \"Add\" button is often separate or a sub-action.\r\n                    // For simplicity: The \"Create Story\" card is always first. If I have stories, I appear in the list too. \r\n\r\n                    const isMe = false; // We can rely on ID comparison if we want to treat 'me' differently, but seeing myself in the feed is fine.\r\n\r\n                    return (\r\n                        <div\r\n                            key={idx}\r\n                            className=\"flex-shrink-0 snap-start cursor-pointer group relative w-28 h-48 rounded-xl overflow-hidden transition-transform hover:scale-[1.02]\"\r\n                            onClick={() => handleStoryClick(idx)}\r\n                        >\r\n                            {/* Background Image (Thumbnail of latest story) */}\r\n                            {storyGroup.stories[0].mediaType === 'video' ? (\r\n                                <video src={storyGroup.stories[0].mediaUrl} className=\"absolute inset-0 w-full h-full object-cover transition-transform group-hover:scale-110\" />\r\n                            ) : (\r\n                                <img src={storyGroup.stories[0].mediaUrl} alt=\"Story\" className=\"absolute inset-0 w-full h-full object-cover transition-transform group-hover:scale-110\" />\r\n                            )}\r\n\r\n                            {/* Gradient Overlay */}\r\n                            <div className=\"absolute inset-0 bg-black/20 group-hover:bg-black/10 transition-colors\" />\r\n\r\n                            {/* User Avatar */}\r\n                            <div className=\"absolute top-3 left-3 w-10 h-10 rounded-full border-4 border-primary overflow-hidden z-10\">\r\n                                <img src={storyGroup.user.imageUrl || '/placeholder-user.jpg'} alt={storyGroup.user.displayName || 'User'} className=\"w-full h-full object-cover\" />\r\n                            </div>\r\n\r\n                            {/* User Name */}\r\n                            <div className=\"absolute bottom-3 left-3 right-3 z-10\">\r\n                                <p className=\"text-white text-xs font-bold truncate drop-shadow-md\">\r\n                                    {storyGroup.user.displayName}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            {/* Viewer Overlay */}\r\n            <StoryViewer\r\n                open={viewerOpen}\r\n                onOpenChange={setViewerOpen}\r\n                initialStories={activeStories}\r\n                initialUserIndex={selectedUserIndex}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\stories\\stories-tray.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profile' is assigned a value but never used.","line":13,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[812,815],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[812,815],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getActiveStories } from \"@/app/actions/stories\";\r\nimport { getUserProfile } from \"@/lib/auth\";\r\nimport { StoriesTrayClient } from \"./stories-tray-client\";\r\n\r\nexport async function StoriesTray() {\r\n    try {\r\n        const [user, stories] = await Promise.all([\r\n            getUserProfile(),\r\n            getActiveStories()\r\n        ]);\r\n\r\n        // Handle profileData type safety\r\n        const profile = user?.profileData as { firstName?: string, lastName?: string, imageUrl?: string } | null;\r\n\r\n        return (\r\n            <StoriesTrayClient\r\n                currentUserId={user?.id}\r\n                currentUserRole={user?.role}\r\n                currentUserImage={user?.imageUrl}\r\n                currentUserDisplayName={user?.displayName || 'Unknown'}\r\n                activeStories={stories as any} // Cast to any to bypass strict type check for now, knowing structure matches\r\n            />\r\n        );\r\n    } catch (error) {\r\n        console.error(\"Error loading stories:\", error)\r\n        // Return empty stories tray on error\r\n        return <StoriesTrayClient currentUserId={undefined} currentUserRole={undefined} currentUserImage={undefined} currentUserDisplayName=\"Unknown\" activeStories={[]} />\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\stories\\story-viewer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":157,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":157,"endColumn":49},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":253,"column":29,"nodeType":"JSXOpeningElement","endLine":262,"endColumn":31}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chanc\\Documents\\WeAreFamily\\components\\stories\\story-viewer.tsx:60:9\n  58 |     useEffect(() => {\n  59 |         // eslint-disable-next-line react-hooks/set-state-in-effect\n> 60 |         setCurrentUserIndex(initialUserIndex);\n     |         ^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  61 |          \n  62 |         setCurrentStoryIndex(0);\n  63 |          ","line":60,"column":9,"nodeType":null,"endLine":60,"endColumn":28,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback } from \"react\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\";\r\nimport { X, ChevronLeft, ChevronRight, Trash2, Volume2, VolumeX } from \"lucide-react\";\r\nimport { useAuth } from \"@/components/auth-provider\";\r\nimport { deleteStory } from \"@/app/actions/stories\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface Story {\r\n    id: string;\r\n    mediaUrl: string;\r\n    mediaType: 'image' | 'video';\r\n    authorId: string; // Ensure interface includes authorId\r\n    createdAt: Date;\r\n}\r\n\r\ninterface UserStories {\r\n    user: {\r\n        imageUrl: string | null;\r\n        displayName: string | null;\r\n    };\r\n    stories: Story[];\r\n}\r\n\r\ninterface StoryViewerProps {\r\n    initialStories: UserStories[]; // Array of users with their stories\r\n    initialUserIndex: number; // Which user did we click on?\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n}\r\n\r\nexport function StoryViewer({ initialStories, initialUserIndex, open, onOpenChange }: StoryViewerProps) {\r\n    const { user } = useAuth();\r\n    const [currentUserIndex, setCurrentUserIndex] = useState(initialUserIndex);\r\n    const [currentStoryIndex, setCurrentStoryIndex] = useState(0);\r\n    const [progress, setProgress] = useState(0);\r\n    const [mediaError, setMediaError] = useState<string | null>(null);\r\n    const [isUnmuted, setIsUnmuted] = useState(false);\r\n\r\n    const currentUser = initialStories[currentUserIndex];\r\n    const currentStory = currentUser?.stories[currentStoryIndex];\r\n\r\n    useEffect(() => {\r\n        if (open) {\r\n            console.log(\"StoryViewer Open:\", {\r\n                currentUserIndex,\r\n                currentStoryIndex,\r\n                user: currentUser?.user.displayName,\r\n                mediaUrl: currentStory?.mediaUrl,\r\n                mediaType: currentStory?.mediaType\r\n            });\r\n        }\r\n    }, [open, currentUserIndex, currentStoryIndex, currentUser, currentStory]);\r\n\r\n    // Reset when user changes\r\n    useEffect(() => {\r\n        // eslint-disable-next-line react-hooks/set-state-in-effect\r\n        setCurrentUserIndex(initialUserIndex);\r\n         \r\n        setCurrentStoryIndex(0);\r\n         \r\n        setProgress(0);\r\n         \r\n        setMediaError(null);\r\n    }, [initialUserIndex, open]);\r\n\r\n    // Navigate to next story/user\r\n    const next = useCallback(() => {\r\n        if (!currentUser) return;\r\n        if (currentStoryIndex < currentUser.stories.length - 1) {\r\n            setCurrentStoryIndex(prev => prev + 1);\r\n            setProgress(0);\r\n            setMediaError(null);\r\n        } else if (currentUserIndex < initialStories.length - 1) {\r\n            setCurrentUserIndex(prev => prev + 1);\r\n            setCurrentStoryIndex(0);\r\n            setProgress(0);\r\n            setMediaError(null);\r\n        } else {\r\n            onOpenChange(false);\r\n        }\r\n    }, [currentStoryIndex, currentUserIndex, initialStories.length, currentUser, onOpenChange]);\r\n\r\n    // Navigate to previous story/user\r\n    const prev = useCallback(() => {\r\n        if (!currentUser) return;\r\n        if (currentStoryIndex > 0) {\r\n            setCurrentStoryIndex(prev => prev - 1);\r\n            setProgress(0);\r\n            setMediaError(null);\r\n        } else if (currentUserIndex > 0) {\r\n            const prevUser = initialStories[currentUserIndex - 1];\r\n            if (prevUser) {\r\n                setCurrentUserIndex(prev => prev - 1);\r\n                setCurrentStoryIndex(prevUser.stories.length - 1);\r\n                setProgress(0);\r\n                setMediaError(null);\r\n            }\r\n        }\r\n    }, [currentStoryIndex, currentUserIndex, initialStories, currentUser]);\r\n\r\n    // Auto-advance logic\r\n    useEffect(() => {\r\n        if (!open || !currentStory) return;\r\n\r\n        if (currentStory.mediaType === 'image') {\r\n            const duration = 5000; // 5 seconds for images\r\n            const interval = 100;\r\n            const step = 100 / (duration / interval);\r\n\r\n            const timer = setInterval(() => {\r\n                setProgress(p => {\r\n                    if (p >= 100) {\r\n                        clearInterval(timer);\r\n                        next();\r\n                        return 0;\r\n                    }\r\n                    return p + step;\r\n                });\r\n            }, interval);\r\n\r\n            return () => clearInterval(timer);\r\n        }\r\n    }, [currentStory, next, open]);\r\n\r\n    // Video end handler\r\n    const handleVideoEnded = () => {\r\n        next();\r\n    };\r\n\r\n    if (!currentUser || !currentStory) return null;\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"max-w-4xl w-full h-[85vh] p-0 bg-black border-none overflow-hidden flex items-center justify-center\">\r\n\r\n                {/* Navigation Overlays */}\r\n                <div className=\"absolute inset-y-0 left-0 w-1/4 z-10 cursor-pointer\" onClick={prev} />\r\n                <div className=\"absolute inset-y-0 right-0 w-1/4 z-10 cursor-pointer\" onClick={next} />\r\n\r\n                {/* Close Button */}\r\n                <div className=\"absolute top-4 right-4 z-50 flex gap-2\">\r\n                    {/* Delete Button (Only for author) */}\r\n                    {user?.uid === currentStory.authorId && (\r\n                        <button\r\n                            onClick={async (e) => {\r\n                                e.stopPropagation();\r\n                                if (confirm(\"Delete this story?\")) {\r\n                                    try {\r\n                                        await deleteStory(currentStory.id);\r\n                                        toast.success(\"Story deleted\");\r\n                                        // Force close or navigate\r\n                                        onOpenChange(false);\r\n                                        window.location.reload(); // Simple refresh to clear state\r\n                                    } catch (err) {\r\n                                        toast.error(\"Failed to delete\");\r\n                                    }\r\n                                }\r\n                            }}\r\n                            className=\"text-white/70 hover:text-red-400 bg-black/20 hover:bg-black/40 rounded-full p-2 backdrop-blur-sm transition-colors\"\r\n                        >\r\n                            <Trash2 className=\"w-6 h-6\" />\r\n                        </button>\r\n                    )}\r\n\r\n                    <button\r\n                        onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            onOpenChange(false);\r\n                        }}\r\n                        className=\"text-white bg-black/20 hover:bg-black/40 rounded-full p-2 backdrop-blur-sm\"\r\n                    >\r\n                        <X className=\"w-6 h-6\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Story Content */}\r\n                <div className=\"relative w-full h-full flex flex-col\">\r\n                    {/* Header / Progress Bar */}\r\n                    <div className=\"absolute top-0 left-0 right-0 z-20 p-4 bg-gradient-to-b from-black/60 to-transparent pointer-events-none\">\r\n                        {/* pointer-events-none allows clicks to pass through header to overlays if needed, but buttons above are higher z-index */}\r\n                        <div className=\"flex gap-1 mb-2\">\r\n                            {currentUser.stories.map((story, idx) => (\r\n                                <div key={story.id} className=\"h-1 flex-1 bg-white/30 rounded-full overflow-hidden\">\r\n                                    <div\r\n                                        className=\"h-full bg-white transition-all duration-300 ease-linear\"\r\n                                        style={{\r\n                                            width: idx < currentStoryIndex ? '100%' :\r\n                                                idx === currentStoryIndex ? `${progress}%` : '0%'\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Avatar className=\"w-8 h-8 border border-white/50\">\r\n                                <AvatarImage src={currentUser.user.imageUrl || undefined} />\r\n                                <AvatarFallback>{currentUser.user.displayName?.charAt(0)}</AvatarFallback>\r\n                            </Avatar>\r\n                            <span className=\"text-white font-semibold text-sm\">\r\n                                {currentUser.user.displayName}\r\n                            </span>\r\n                            <span className=\"text-white/60 text-xs ml-auto\">\r\n                                {new Date(currentStory.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Media */}\r\n                    <div className=\"flex-1 flex items-center justify-center bg-zinc-900 relative\">\r\n                        {mediaError ? (\r\n                            <div className=\"text-center p-6 text-white bg-red-500/10 rounded-xl border border-red-500/20\">\r\n                                <p className=\"font-semibold text-red-400 mb-2\">Failed to load story</p>\r\n                                <p className=\"text-xs text-white/50\">{mediaError}</p>\r\n                            </div>\r\n                        ) : currentStory.mediaType === 'video' ? (\r\n                            <div className=\"relative w-full h-full flex items-center justify-center\">\r\n                                <video\r\n                                    key={currentStory.id} // Re-mount on change\r\n                                    src={currentStory.mediaUrl}\r\n                                    className=\"max-h-full max-w-full object-contain\"\r\n                                    autoPlay\r\n                                    playsInline\r\n                                    muted={!isUnmuted}\r\n                                    onEnded={handleVideoEnded}\r\n                                    onTimeUpdate={(e) => {\r\n                                        const video = e.currentTarget;\r\n                                        if (video.duration) {\r\n                                            setProgress((video.currentTime / video.duration) * 100);\r\n                                        }\r\n                                    }}\r\n                                    onError={(e) => {\r\n                                        console.error(\"Video load error\", e);\r\n                                        setMediaError(\"Video format not supported or load failed\");\r\n                                    }}\r\n                                />\r\n\r\n                                {/* Unmute Button (Custom) */}\r\n                                <button\r\n                                    className=\"absolute bottom-6 right-6 z-50 bg-black/50 p-2 rounded-full text-white hover:bg-black/70 backdrop-blur-md flex items-center gap-2 transition-all hover:scale-105\"\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation(); // CRITICAL FIX\r\n                                        setIsUnmuted(prev => !prev);\r\n                                    }}\r\n                                >\r\n                                    {isUnmuted ? <Volume2 className=\"w-5 h-5\" /> : <VolumeX className=\"w-5 h-5\" />}\r\n                                    <span className=\"text-xs font-medium pr-1\">{isUnmuted ? 'Mute' : 'Unmute'}</span>\r\n                                </button>\r\n                            </div>\r\n                        ) : (\r\n                            <img\r\n                                key={currentStory.id}\r\n                                src={currentStory.mediaUrl}\r\n                                className=\"max-h-full max-w-full object-contain animate-in fade-in zoom-in-95 duration-500\"\r\n                                alt=\"Story\"\r\n                                onError={(e) => {\r\n                                    console.error(\"Image load error\", e);\r\n                                    setMediaError(\"Image failed to load\");\r\n                                }}\r\n                            />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Side Navigation Buttons (Visible on desktop) */}\r\n                <button onClick={(e) => { e.stopPropagation(); prev(); }} className=\"absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white z-20 hidden md:block border border-white/10 rounded-full p-1 bg-black/20\">\r\n                    <ChevronLeft className=\"w-8 h-8\" />\r\n                </button>\r\n                <button onClick={(e) => { e.stopPropagation(); next(); }} className=\"absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white z-20 hidden md:block border border-white/10 rounded-full p-1 bg-black/20\">\r\n                    <ChevronRight className=\"w-8 h-8\" />\r\n                </button>\r\n\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\theme-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\command.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\hooks\\use-auto-scroll.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\hooks\\use-chat.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\hooks\\use-magic-ai.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\hooks\\use-scroll-direction.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\hooks\\use-speech-recognition.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[771,774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[771,774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'audioChunks' is assigned a value but never used.","line":23,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1621,1624],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1621,1624],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1658,1661],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1658,1661],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2069,2072],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2069,2072],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3275,3278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3275,3278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useRef } from 'react';\r\n\r\nexport interface UseSpeechRecognitionProps {\r\n    onResult?: (transcript: string) => void;\r\n    onEnd?: () => void;\r\n    useWhisper?: boolean; // Use OpenAI Whisper instead of browser API\r\n    continuous?: boolean; // NEW: Continuous listening mode\r\n}\r\n\r\nexport function useSpeechRecognition({\r\n    onResult,\r\n    onEnd,\r\n    useWhisper = true, // Default to Whisper for better accuracy\r\n    continuous = false // Default to single-turn\r\n}: UseSpeechRecognitionProps = {}) {\r\n    const [isListening, setIsListening] = useState(false);\r\n    const [transcript, setTranscript] = useState('');\r\n    const [isSupported, setIsSupported] = useState(false);\r\n    const [recognition, setRecognition] = useState<any>(null);\r\n\r\n    // Whisper-specific state\r\n    const [mediaRecorder, setMediaRecorder] = useState<MediaRecorder | null>(null);\r\n    const [audioChunks, setAudioChunks] = useState<Blob[]>([]);\r\n    const [isProcessing, setIsProcessing] = useState(false);\r\n\r\n    // Use refs to avoid recreating recognition instance\r\n    const onResultRef = useRef(onResult);\r\n    const onEndRef = useRef(onEnd);\r\n    const continuousRef = useRef(continuous);\r\n\r\n    // Update refs when props change\r\n    useEffect(() => {\r\n        onResultRef.current = onResult;\r\n        onEndRef.current = onEnd;\r\n        continuousRef.current = continuous;\r\n    }, [onResult, onEnd, continuous]);\r\n\r\n    // Initialize browser Speech Recognition (fallback)\r\n    useEffect(() => {\r\n        if (typeof window === 'undefined') return;\r\n\r\n        const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;\r\n\r\n        if (SpeechRecognition) {\r\n            try {\r\n                const recognitionInstance = new SpeechRecognition();\r\n                recognitionInstance.continuous = continuous; // Use continuous flag\r\n                recognitionInstance.interimResults = true;\r\n                recognitionInstance.lang = 'en-US';\r\n\r\n                recognitionInstance.onresult = (event: any) => {\r\n                    let interimTranscript = '';\r\n                    let finalTranscript = '';\r\n\r\n                    for (let i = event.resultIndex; i < event.results.length; ++i) {\r\n                        if (event.results[i].isFinal) {\r\n                            finalTranscript += event.results[i][0].transcript;\r\n                        } else {\r\n                            interimTranscript += event.results[i][0].transcript;\r\n                        }\r\n                    }\r\n\r\n                    const currentTranscript = finalTranscript || interimTranscript;\r\n                    setTranscript(currentTranscript);\r\n                    if (onResultRef.current) {\r\n                        onResultRef.current(currentTranscript);\r\n                    }\r\n                };\r\n\r\n                recognitionInstance.onend = () => {\r\n                    // Only stop listening state if NOT continuous, or if explicitly stopped\r\n                    if (!continuousRef.current) {\r\n                        setIsListening(false);\r\n                    }\r\n                    if (onEndRef.current) onEndRef.current();\r\n                };\r\n\r\n                recognitionInstance.onerror = (event: any) => {\r\n                    console.error('Speech recognition error', event.error);\r\n                    setIsListening(false);\r\n                };\r\n\r\n                setRecognition(recognitionInstance);\r\n                setIsSupported(true);\r\n            } catch (e) {\r\n                console.error(\"SpeechRecognition initialization failed:\", e);\r\n                setIsSupported(false);\r\n            }\r\n        }\r\n    }, [continuous]);\r\n\r\n    // Initialize MediaRecorder for Whisper\r\n    useEffect(() => {\r\n        if (!useWhisper || typeof window === 'undefined') return;\r\n\r\n        navigator.mediaDevices.getUserMedia({ audio: true })\r\n            .then(() => {\r\n                setIsSupported(true);\r\n            })\r\n            .catch((err) => {\r\n                console.error('Microphone access denied:', err);\r\n                setIsSupported(false);\r\n            });\r\n    }, [useWhisper]);\r\n\r\n    // Whisper transcription\r\n    const transcribeWithWhisper = useCallback(async (audioBlob: Blob) => {\r\n        setIsProcessing(true);\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append('audio', audioBlob, 'recording.webm');\r\n\r\n            const response = await fetch('/api/transcribe', {\r\n                method: 'POST',\r\n                body: formData,\r\n            });\r\n\r\n            if (!response.ok) {\r\n                throw new Error('Transcription failed');\r\n            }\r\n\r\n            const data = await response.json();\r\n            const transcriptText = data.text;\r\n\r\n            setTranscript(transcriptText);\r\n            if (onResultRef.current) {\r\n                onResultRef.current(transcriptText);\r\n            }\r\n        } catch (error) {\r\n            console.error('Whisper transcription error:', error);\r\n        } finally {\r\n            setIsProcessing(false);\r\n            if (onEndRef.current) onEndRef.current();\r\n        }\r\n    }, []);\r\n\r\n    const startListening = useCallback(async () => {\r\n        if (isListening) return;\r\n\r\n        // Use Whisper if enabled\r\n        if (useWhisper) {\r\n            try {\r\n                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n                const recorder = new MediaRecorder(stream);\r\n                const chunks: Blob[] = [];\r\n\r\n                recorder.ondataavailable = (e) => {\r\n                    if (e.data.size > 0) {\r\n                        chunks.push(e.data);\r\n                    }\r\n                };\r\n\r\n                recorder.onstop = async () => {\r\n                    const audioBlob = new Blob(chunks, { type: 'audio/webm' });\r\n                    await transcribeWithWhisper(audioBlob);\r\n                    stream.getTracks().forEach(track => track.stop());\r\n\r\n                    // If continuous, restart recording after processing (or handled by wrapper)\r\n                    // Note: Whisper continuous mode is better handled by VAD wrapper essentially calling start/stop\r\n                };\r\n\r\n                recorder.start();\r\n                setMediaRecorder(recorder);\r\n                setAudioChunks([]);\r\n                setIsListening(true);\r\n                setTranscript('');\r\n            } catch (e) {\r\n                console.error(\"Failed to start Whisper recording\", e);\r\n            }\r\n        }\r\n        // Fallback to browser API\r\n        else if (recognition && !isListening) {\r\n            try {\r\n                recognition.start();\r\n                setIsListening(true);\r\n                setTranscript('');\r\n            } catch (e) {\r\n                console.error(\"Failed to start browser recognition\", e);\r\n            }\r\n        }\r\n    }, [recognition, isListening, useWhisper, transcribeWithWhisper]);\r\n\r\n    const stopListening = useCallback(() => {\r\n        if (!isListening) return;\r\n\r\n        if (useWhisper && mediaRecorder) {\r\n            mediaRecorder.stop();\r\n            setMediaRecorder(null);\r\n        } else if (recognition) {\r\n            recognition.stop();\r\n        }\r\n\r\n        setIsListening(false);\r\n    }, [recognition, isListening, useWhisper, mediaRecorder]);\r\n\r\n    return {\r\n        isListening,\r\n        transcript,\r\n        startListening,\r\n        stopListening,\r\n        isSupported,\r\n        isProcessing,\r\n        mode: useWhisper ? 'whisper' : 'browser',\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\hooks\\use-text-to-speech.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'speakWithBrowser'. Either include it or remove the dependency array.","line":63,"column":8,"nodeType":"ArrayExpression","endLine":63,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [speakWithBrowser]","fix":{"range":[2127,2129],"text":"[speakWithBrowser]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useCallback, useEffect, useRef } from 'react';\r\n\r\nexport type TTSVoice = 'alloy' | 'echo' | 'fable' | 'onyx' | 'nova' | 'shimmer';\r\n\r\ninterface UseTextToSpeechOptions {\r\n    useOpenAI?: boolean; // Use OpenAI TTS for premium quality\r\n    voice?: TTSVoice;\r\n}\r\n\r\nexport function useTextToSpeech(options: UseTextToSpeechOptions = {}) {\r\n    const {\r\n        useOpenAI = true, // Default to OpenAI for best quality\r\n        voice = 'alloy'\r\n    } = options;\r\n\r\n    const [isSpeaking, setIsSpeaking] = useState(false);\r\n    const [isSupported, setIsSupported] = useState(false);\r\n    const audioRef = useRef<HTMLAudioElement | null>(null);\r\n\r\n    useEffect(() => {\r\n        if (typeof window !== 'undefined') {\r\n            setIsSupported(true);\r\n            // Create audio element for OpenAI TTS\r\n            if (useOpenAI) {\r\n                audioRef.current = new Audio();\r\n                audioRef.current.onended = () => setIsSpeaking(false);\r\n                audioRef.current.onerror = () => setIsSpeaking(false);\r\n            }\r\n        }\r\n    }, [useOpenAI]);\r\n\r\n    const speakWithOpenAI = useCallback(async (text: string, selectedVoice: TTSVoice) => {\r\n        try {\r\n            setIsSpeaking(true);\r\n\r\n            const response = await fetch('/api/tts', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({ text, voice: selectedVoice }),\r\n            });\r\n\r\n            if (!response.ok) {\r\n                throw new Error('TTS request failed');\r\n            }\r\n\r\n            const audioBlob = await response.blob();\r\n            const audioUrl = URL.createObjectURL(audioBlob);\r\n\r\n            if (audioRef.current) {\r\n                audioRef.current.src = audioUrl;\r\n                await audioRef.current.play();\r\n            }\r\n        } catch (error) {\r\n            console.error('OpenAI TTS error:', error);\r\n            setIsSpeaking(false);\r\n            // Fallback to browser TTS on error\r\n            speakWithBrowser(text);\r\n        }\r\n    }, []);\r\n\r\n    const speakWithBrowser = useCallback((text: string) => {\r\n        if (typeof window === 'undefined' || !window.speechSynthesis) return;\r\n\r\n        // Cancel any current speech\r\n        window.speechSynthesis.cancel();\r\n\r\n        const utterance = new SpeechSynthesisUtterance(text);\r\n\r\n        // Select a pleasant voice if available\r\n        const voices = window.speechSynthesis.getVoices();\r\n        const preferredVoice = voices.find(v => v.name.includes('Google US English')) || voices[0];\r\n        if (preferredVoice) utterance.voice = preferredVoice;\r\n\r\n        utterance.onstart = () => setIsSpeaking(true);\r\n        utterance.onend = () => setIsSpeaking(false);\r\n        utterance.onerror = () => setIsSpeaking(false);\r\n\r\n        window.speechSynthesis.speak(utterance);\r\n    }, []);\r\n\r\n    const speak = useCallback((text: string) => {\r\n        if (useOpenAI) {\r\n            speakWithOpenAI(text, voice);\r\n        } else {\r\n            speakWithBrowser(text);\r\n        }\r\n    }, [useOpenAI, voice, speakWithOpenAI, speakWithBrowser]);\r\n\r\n    const stop = useCallback(() => {\r\n        setIsSpeaking(false);\r\n\r\n        // Stop OpenAI audio\r\n        if (audioRef.current) {\r\n            audioRef.current.pause();\r\n            audioRef.current.currentTime = 0;\r\n        }\r\n\r\n        // Stop browser TTS\r\n        if (typeof window !== 'undefined' && window.speechSynthesis) {\r\n            window.speechSynthesis.cancel();\r\n        }\r\n    }, []);\r\n\r\n    return {\r\n        speak,\r\n        stop,\r\n        isSpeaking,\r\n        isSupported,\r\n        mode: useOpenAI ? 'openai' : 'browser',\r\n        voice\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\hooks\\use-voice-conversation.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'cleanupVAD' and 'stopSpeaking'. Either include them or remove the dependency array.","line":195,"column":8,"nodeType":"ArrayExpression","endLine":195,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [cleanupVAD, stopSpeaking]","fix":{"range":[7646,7648],"text":"[cleanupVAD, stopSpeaking]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback, useEffect, useRef } from 'react';\r\nimport { useSpeechRecognition } from './use-speech-recognition';\r\nimport { useTextToSpeech } from './use-text-to-speech';\r\n\r\ninterface UseVoiceConversationProps {\r\n    onMessage: (message: string) => Promise<string>; // Callback to send message to AI\r\n    onStateChange?: (state: 'idle' | 'listening' | 'processing' | 'speaking') => void;\r\n}\r\n\r\nexport function useVoiceConversation({ onMessage, onStateChange }: UseVoiceConversationProps) {\r\n    const [state, setState] = useState<'idle' | 'listening' | 'processing' | 'speaking'>('idle');\r\n    const [isContinuous, setIsContinuous] = useState(false);\r\n\r\n    // Audio refs\r\n    const audioContextRef = useRef<AudioContext | null>(null);\r\n    const analyserRef = useRef<AnalyserNode | null>(null);\r\n    const sourceRef = useRef<MediaStreamAudioSourceNode | null>(null);\r\n    const streamRef = useRef<MediaStream | null>(null);\r\n    const silenceTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n    const animationFrameRef = useRef<number | null>(null);\r\n\r\n    // TTS Hook - Use Nova voice (warm, natural)\r\n    const { speak, stop: stopSpeaking, isSpeaking } = useTextToSpeech({\r\n        useOpenAI: true,\r\n        voice: 'nova'\r\n    });\r\n\r\n    // Update state helper\r\n    const updateState = useCallback((newState: 'idle' | 'listening' | 'processing' | 'speaking') => {\r\n        setState(newState);\r\n        onStateChange?.(newState);\r\n    }, [onStateChange]);\r\n\r\n    // Handle incoming transcript result\r\n    const handleResult = useCallback(async (transcript: string) => {\r\n        if (!transcript.trim()) return;\r\n\r\n        // Stop listening while processing\r\n        updateState('processing');\r\n\r\n        try {\r\n            // Get AI response\r\n            const response = await onMessage(transcript);\r\n\r\n            // Speak response\r\n            updateState('speaking');\r\n            speak(response);\r\n\r\n            // If continuous, we will restart listening AFTER speaking finishes\r\n            // This logic needs to be in an effect checking isSpeaking\r\n        } catch (error) {\r\n            console.error('Conversation error:', error);\r\n            updateState('idle');\r\n        }\r\n    }, [onMessage, speak, updateState]);\r\n\r\n    // Speech Recognition Hook\r\n    const {\r\n        isListening,\r\n        startListening,\r\n        stopListening: stopRecognition,\r\n        isProcessing\r\n    } = useSpeechRecognition({\r\n        useWhisper: true,\r\n        continuous: true, // We handle the restart logic manually for better control\r\n        onResult: handleResult\r\n    });\r\n\r\n    // Effect to restart listening after speaking finishes (if continuous)\r\n    useEffect(() => {\r\n        if (isContinuous && state === 'speaking' && !isSpeaking) {\r\n            // Finished speaking, back to listening\r\n            // Use setTimeout to avoid \"cannot update component while rendering\" warning\r\n            setTimeout(() => {\r\n                updateState('listening');\r\n                startListening();\r\n            }, 0);\r\n        }\r\n    }, [isContinuous, state, isSpeaking, updateState, startListening]);\r\n\r\n    // Barge-in: Stop speaking if user starts talking\r\n    const handleUserSpeechStart = useCallback(() => {\r\n        if (isSpeaking) {\r\n            stopSpeaking();\r\n            updateState('listening'); // Switch back to listening state\r\n        }\r\n    }, [isSpeaking, stopSpeaking, updateState]);\r\n\r\n    // -------------------------------------------------------------------------\r\n    // VAD Logic (Simplified)\r\n    // -------------------------------------------------------------------------\r\n    const startVAD = useCallback(async () => {\r\n        try {\r\n            // Close existing context if any\r\n            if (audioContextRef.current) {\r\n                audioContextRef.current.close();\r\n            }\r\n\r\n            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n            streamRef.current = stream;\r\n\r\n            audioContextRef.current = new AudioContext();\r\n            analyserRef.current = audioContextRef.current.createAnalyser();\r\n            sourceRef.current = audioContextRef.current.createMediaStreamSource(stream);\r\n\r\n            analyserRef.current.fftSize = 256;\r\n            sourceRef.current.connect(analyserRef.current);\r\n\r\n            const bufferLength = analyserRef.current.frequencyBinCount;\r\n            const dataArray = new Uint8Array(bufferLength);\r\n\r\n            const checkAudio = () => {\r\n                if (!analyserRef.current) return;\r\n\r\n                analyserRef.current.getByteFrequencyData(dataArray);\r\n\r\n                // Calculate average volume\r\n                let sum = 0;\r\n                for (let i = 0; i < bufferLength; i++) {\r\n                    sum += dataArray[i];\r\n                }\r\n                const average = sum / bufferLength;\r\n\r\n                // Threshold for \"User is speaking\"\r\n                if (average > 20) { // Slightly higher threshold to avoid background noise\r\n                    handleUserSpeechStart();\r\n\r\n                    // Clear silence timer if user is talking\r\n                    if (silenceTimerRef.current) {\r\n                        clearTimeout(silenceTimerRef.current);\r\n                        silenceTimerRef.current = null;\r\n                    }\r\n                } else {\r\n                    // Silence detected \r\n                    // Only start timer if we are in listening state and have detecting 'some' previous activity?\r\n                    // For simplicity: if silence persists for 1.5s while listening, assume end of turn\r\n                    if (!silenceTimerRef.current && state === 'listening') {\r\n                        silenceTimerRef.current = setTimeout(() => {\r\n                            // End of turn - stop recording to trigger Whisper\r\n                            if (isListening) {\r\n                                stopRecognition();\r\n                            }\r\n                        }, 2000); // 2s of silence = end of turn\r\n                    }\r\n                }\r\n\r\n                animationFrameRef.current = requestAnimationFrame(checkAudio);\r\n            };\r\n\r\n            checkAudio();\r\n        } catch (err) {\r\n            console.error('VAD Error:', err);\r\n        }\r\n    }, [state, isListening, handleUserSpeechStart, stopRecognition]); // Added state/isListening dependencies\r\n\r\n    const cleanupVAD = useCallback(() => {\r\n        if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current);\r\n        if (silenceTimerRef.current) clearTimeout(silenceTimerRef.current);\r\n\r\n        if (streamRef.current) {\r\n            streamRef.current.getTracks().forEach(t => t.stop());\r\n            streamRef.current = null;\r\n        }\r\n\r\n        if (audioContextRef.current) {\r\n            audioContextRef.current.close();\r\n            audioContextRef.current = null;\r\n        }\r\n    }, []);\r\n\r\n    // Toggle Continuous Mode\r\n    const toggleContinuous = useCallback(() => {\r\n        setIsContinuous(prev => {\r\n            const next = !prev;\r\n            if (next) {\r\n                updateState('listening');\r\n                startListening();\r\n                startVAD();\r\n            } else {\r\n                updateState('idle');\r\n                stopRecognition();\r\n                stopSpeaking();\r\n                cleanupVAD();\r\n            }\r\n            return next;\r\n        });\r\n    }, [startListening, stopRecognition, stopSpeaking, startVAD, cleanupVAD, updateState]);\r\n\r\n    // Cleanup effects\r\n    useEffect(() => {\r\n        return () => {\r\n            cleanupVAD();\r\n            stopSpeaking();\r\n        };\r\n    }, []);\r\n\r\n    return {\r\n        state,\r\n        isContinuous,\r\n        toggleContinuous,\r\n        isSpeaking,\r\n        isProcessing\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":47,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1373,1376],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1373,1376],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { cookies } from \"next/headers\";\r\nimport { adminDb } from \"@/lib/firebase-admin\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { sanitizeData } from \"@/lib/serialization\";\r\n\r\nexport async function getUserProfile() {\r\n    try {\r\n        const cookieStore = await cookies();\r\n        const sessionUid = cookieStore.get(\"session_uid\")?.value;\r\n\r\n        if (!sessionUid) {\r\n            console.log(\"[getUserProfile] No session cookie found\");\r\n            return null;\r\n        }\r\n\r\n        console.log(`[getUserProfile] Fetching profile for uid: ${sessionUid}`);\r\n        const userDoc = await adminDb.collection(\"users\").doc(sessionUid).get();\r\n\r\n        if (!userDoc.exists) {\r\n            console.warn(`[getUserProfile] User document not found for ${sessionUid}`);\r\n            return null;\r\n        }\r\n\r\n        const data = userDoc.data();\r\n        return sanitizeData({\r\n            id: userDoc.id,\r\n            ...data\r\n        });\r\n    } catch (error) {\r\n        console.error(\"[getUserProfile] Critical Error fetching user profile:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function requireUser() {\r\n    const profile = await getUserProfile();\r\n\r\n    if (!profile) {\r\n        redirect(\"/login\");\r\n    }\r\n\r\n    return profile;\r\n}\r\n\r\nexport const GRACE_PERIOD_MS = 24 * 60 * 60 * 1000; // 24 hours\r\n\r\nexport function isVerified(profile: any): boolean {\r\n    if (!profile) return false;\r\n    // Admins bypass verification requirements\r\n    if (profile.role === 'admin') return true;\r\n    return profile.emailVerified === true;\r\n}\r\n\r\n/**\r\n * Enforces Access Policy:\r\n * - Unverified > 24h: Redirects to /verify-email (BLOCKED)\r\n * - Be lenient if verifying login state\r\n */\r\nexport async function enforceVerificationAccess() {\r\n    const profile = await getUserProfile();\r\n    if (!profile) return; // Not logged in\r\n\r\n    if (isVerified(profile)) return;\r\n\r\n    // Unverified Logic\r\n    const createdAt = profile.createdAt instanceof Date ? profile.createdAt : new Date();\r\n    const age = Date.now() - createdAt.getTime();\r\n\r\n    if (age > GRACE_PERIOD_MS) {\r\n        redirect(\"/verify-email\");\r\n    }\r\n}\r\n\r\n/**\r\n * STRICTLY enforces verification for Mutations (Writes).\r\n * NO Grace Period for writing (per policy).\r\n */\r\nexport async function requireVerifiedAction() {\r\n    const profile = await requireUser();\r\n\r\n    if (!isVerified(profile)) {\r\n        throw new Error(\"Email verification required for this action.\");\r\n    }\r\n    return profile;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\device-detection.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\dictionaries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\firebase-admin.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":19,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'server-only';\r\nexport const dynamic = 'force-dynamic'; // Force dynamic (server-rendered) to ensure env vars are read at runtime\r\n\r\nimport { initializeApp, getApps, getApp, cert, applicationDefault } from 'firebase-admin/app';\r\nimport { getFirestore } from 'firebase-admin/firestore';\r\nimport { getAuth } from 'firebase-admin/auth';\r\nimport { getStorage } from 'firebase-admin/storage';\r\n\r\n// Initialize Firebase Admin\r\nlet credential;\r\n\r\n// 1. Try Local Secrets (Dev)\r\nif (process.env.NODE_ENV === 'development') {\r\n    try {\r\n        const secrets = require('./firebase-secrets');\r\n        if (secrets.SERVICE_ACCOUNT) {\r\n            credential = cert(secrets.SERVICE_ACCOUNT);\r\n        }\r\n    } catch (e) {\r\n        // Ignore\r\n    }\r\n}\r\n\r\n// 2. Try Environment Variables (Manual CI/Vercel)\r\nif (!credential && process.env.FIREBASE_PRIVATE_KEY) {\r\n    try {\r\n        const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n').replace(/\"/g, '');\r\n        credential = cert({\r\n            projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || \"we-are-family-221\",\r\n            clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\r\n            privateKey: privateKey,\r\n        });\r\n    } catch (e) {\r\n        console.warn(\"Failed to parse FIREBASE_PRIVATE_KEY from env. Falling back to default credentials.\", e);\r\n    }\r\n}\r\n\r\n// 3. Fallback to Default Credentials (Google Cloud / App Hosting)\r\nif (!credential) {\r\n    credential = applicationDefault();\r\n}\r\n\r\nconst firebaseAdminConfig = {\r\n    credential,\r\n    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || \"we-are-family-221\",\r\n    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET || \"we-are-family-221.firebasestorage.app\",\r\n};\r\n\r\nlet app;\r\ntry {\r\n    if (!getApps().length) {\r\n        app = initializeApp(firebaseAdminConfig);\r\n    } else {\r\n        app = getApp();\r\n    }\r\n} catch (error) {\r\n    console.error(\"Firebase Admin Initialization Check Failed.\");\r\n    console.error(\"Critical Error: Firebase Admin could not be initialized.\", error);\r\n    // Re-throw the error to prevent the app from starting in a broken state\r\n    // preventing silent failures in server actions\r\n    throw new Error(`Firebase Admin Initialization Failed: ${error instanceof Error ? error.message : \"Unknown error\"}`);\r\n}\r\n\r\nexport const adminAuth = getAuth(app);\r\nexport const adminDb = getFirestore(app);\r\nexport const adminStorage = getStorage(app);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\firebase-secrets.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\firebase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\media-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\memory-manager.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'vectorIds' is assigned a value but never used.","line":322,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":322,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":343,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":343,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9630,9633],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9630,9633],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Memory Manager\r\n * Handles conversation persistence, short-term and long-term memory\r\n */\r\n\r\nimport { adminDb } from '@/lib/firebase-admin';\r\nimport { upsertVectors, queryVectors, deleteNamespace } from '@/lib/vector-db';\r\nimport { nanoid } from 'nanoid';\r\n\r\nexport interface ConversationMessage {\r\n    role: 'user' | 'assistant' | 'system';\r\n    content: string;\r\n    timestamp: Date;\r\n    metadata?: {\r\n        model?: string;\r\n        tokens?: number;\r\n        responseTime?: number;\r\n    };\r\n}\r\n\r\nexport interface ConversationData {\r\n    conversationId: string;\r\n    userId: string;\r\n    messages: ConversationMessage[];\r\n    metadata: {\r\n        mode: string;\r\n        startedAt: Date;\r\n        lastMessageAt: Date;\r\n        title?: string;\r\n    };\r\n    memoryEnabled: boolean;\r\n}\r\n\r\nexport interface MemorySettings {\r\n    enabled: boolean;\r\n    retentionDays: number;\r\n}\r\n\r\n/**\r\n * Generate a new conversation ID\r\n */\r\nexport function generateConversationId(): string {\r\n    return nanoid(16);\r\n}\r\n\r\n/**\r\n * Get conversation history for a user\r\n */\r\nexport async function getConversationHistory(\r\n    userId: string,\r\n    conversationId: string,\r\n    limit: number = 50\r\n): Promise<ConversationMessage[]> {\r\n    try {\r\n        const docRef = adminDb\r\n            .collection('ai_conversations')\r\n            .doc(`${userId}_${conversationId}`);\r\n\r\n        const doc = await docRef.get();\r\n\r\n        if (!doc.exists) {\r\n            return [];\r\n        }\r\n\r\n        const data = doc.data() as ConversationData;\r\n        const messages = data.messages || [];\r\n\r\n        // Return most recent messages up to limit\r\n        return messages.slice(-limit);\r\n    } catch (error) {\r\n        console.error('Error fetching conversation history:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Save a message to conversation history\r\n */\r\nexport async function saveMessage(\r\n    userId: string,\r\n    conversationId: string,\r\n    message: ConversationMessage,\r\n    mode: string = 'general',\r\n    memoryEnabled: boolean = true\r\n): Promise<void> {\r\n    try {\r\n        const docRef = adminDb\r\n            .collection('ai_conversations')\r\n            .doc(`${userId}_${conversationId}`);\r\n\r\n        const doc = await docRef.get();\r\n        const now = new Date();\r\n\r\n        if (!doc.exists) {\r\n            // Create new conversation\r\n            const newConversation: ConversationData = {\r\n                conversationId,\r\n                userId,\r\n                messages: [message],\r\n                metadata: {\r\n                    mode,\r\n                    startedAt: now,\r\n                    lastMessageAt: now,\r\n                },\r\n                memoryEnabled,\r\n            };\r\n\r\n            await docRef.set(newConversation);\r\n        } else {\r\n            // Append to existing conversation\r\n            await docRef.update({\r\n                messages: [...(doc.data()?.messages || []), message],\r\n                'metadata.lastMessageAt': now,\r\n                memoryEnabled,\r\n            });\r\n        }\r\n\r\n        console.log(`üíæ Message saved to conversation ${conversationId}`);\r\n    } catch (error) {\r\n        console.error('Error saving message:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Summarize a conversation for embedding\r\n * Creates a concise summary suitable for vector search\r\n */\r\nexport async function summarizeConversation(\r\n    messages: ConversationMessage[]\r\n): Promise<string> {\r\n    // Simple summarization: extract key user queries and assistant responses\r\n    const userQueries = messages\r\n        .filter(m => m.role === 'user')\r\n        .map(m => m.content)\r\n        .slice(0, 3); // First 3 user messages\r\n\r\n    const topics = userQueries.join(' | ');\r\n    return `Conversation topics: ${topics}`;\r\n}\r\n\r\n/**\r\n * Get relevant past conversations using vector search\r\n */\r\nexport async function getRelevantMemories(\r\n    userId: string,\r\n    queryEmbedding: number[],\r\n    topK: number = 3\r\n): Promise<QueryResult[]> {\r\n    try {\r\n        // Query the conversations namespace filtered by userId\r\n        const results = await queryVectors(\r\n            'conversations',\r\n            queryEmbedding,\r\n            topK,\r\n            { userId },\r\n            0.75 // Higher threshold for conversations\r\n        );\r\n\r\n        return results;\r\n    } catch (error) {\r\n        console.error('Error fetching relevant memories:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Index a conversation for future retrieval\r\n * Called after conversation ends or periodically\r\n */\r\nexport async function indexConversation(\r\n    userId: string,\r\n    conversationId: string,\r\n    embedding: number[]\r\n): Promise<void> {\r\n    try {\r\n        const docRef = adminDb\r\n            .collection('ai_conversations')\r\n            .doc(`${userId}_${conversationId}`);\r\n\r\n        const doc = await docRef.get();\r\n        if (!doc.exists) {\r\n            throw new Error('Conversation not found');\r\n        }\r\n\r\n        const data = doc.data() as ConversationData;\r\n        const summary = await summarizeConversation(data.messages);\r\n\r\n        // Upsert to vector DB\r\n        await upsertVectors('conversations', [\r\n            {\r\n                id: `${userId}_${conversationId}`,\r\n                values: embedding,\r\n                metadata: {\r\n                    userId,\r\n                    content: summary,\r\n                    createdAt: data.metadata.startedAt.toISOString(),\r\n                    mode: data.metadata.mode,\r\n                    messageCount: data.messages.length,\r\n                },\r\n            },\r\n        ]);\r\n\r\n        console.log(`üìá Conversation indexed: ${conversationId}`);\r\n    } catch (error) {\r\n        console.error('Error indexing conversation:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Reset all memory for a user (GDPR compliance)\r\n */\r\nexport async function resetUserMemory(userId: string): Promise<void> {\r\n    try {\r\n        console.log(`üóëÔ∏è Resetting memory for user: ${userId}`);\r\n\r\n        // Delete from Firestore\r\n        const conversationsRef = adminDb.collection('ai_conversations');\r\n        const snapshot = await conversationsRef\r\n            .where('userId', '==', userId)\r\n            .get();\r\n\r\n        const batch = adminDb.batch();\r\n        snapshot.docs.forEach(doc => {\r\n            batch.delete(doc.ref);\r\n        });\r\n        await batch.commit();\r\n\r\n        // Delete from vector DB\r\n        await deleteNamespace('conversations', { userId });\r\n\r\n        console.log(`‚úÖ Memory reset completed for user: ${userId}`);\r\n    } catch (error) {\r\n        console.error('Error resetting user memory:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Get user's memory settings\r\n */\r\nexport async function getUserMemorySettings(\r\n    userId: string\r\n): Promise<MemorySettings> {\r\n    try {\r\n        const docRef = adminDb.collection('user_settings').doc(userId);\r\n        const doc = await docRef.get();\r\n\r\n        if (!doc.exists) {\r\n            // Default settings\r\n            return {\r\n                enabled: true,\r\n                retentionDays: 90,\r\n            };\r\n        }\r\n\r\n        const aiSettings = doc.data()?.aiMemory;\r\n        return {\r\n            enabled: aiSettings?.enabled ?? true,\r\n            retentionDays: aiSettings?.retentionDays ?? 90,\r\n        };\r\n    } catch (error) {\r\n        console.error('Error fetching memory settings:', error);\r\n        return { enabled: true, retentionDays: 90 };\r\n    }\r\n}\r\n\r\n/**\r\n * Update user's memory settings\r\n */\r\nexport async function updateMemorySettings(\r\n    userId: string,\r\n    settings: Partial<MemorySettings>\r\n): Promise<void> {\r\n    try {\r\n        const docRef = adminDb.collection('user_settings').doc(userId);\r\n        await docRef.set(\r\n            {\r\n                aiMemory: settings,\r\n                updatedAt: new Date(),\r\n            },\r\n            { merge: true }\r\n        );\r\n\r\n        console.log(`‚öôÔ∏è Memory settings updated for user: ${userId}`);\r\n    } catch (error) {\r\n        console.error('Error updating memory settings:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Clean up old conversations based on retention policy\r\n */\r\nexport async function cleanupOldConversations(\r\n    userId: string,\r\n    retentionDays: number = 90\r\n): Promise<number> {\r\n    try {\r\n        const cutoffDate = new Date();\r\n        cutoffDate.setDate(cutoffDate.getDate() - retentionDays);\r\n\r\n        const conversationsRef = adminDb.collection('ai_conversations');\r\n        const snapshot = await conversationsRef\r\n            .where('userId', '==', userId)\r\n            .where('metadata.lastMessageAt', '<', cutoffDate)\r\n            .get();\r\n\r\n        const batch = adminDb.batch();\r\n        const conversationIds: string[] = [];\r\n\r\n        snapshot.docs.forEach(doc => {\r\n            batch.delete(doc.ref);\r\n            conversationIds.push(doc.data().conversationId);\r\n        });\r\n\r\n        await batch.commit();\r\n\r\n        // Also delete from vector DB\r\n        if (conversationIds.length > 0) {\r\n            const vectorIds = conversationIds.map(id => `${userId}_${id}`);\r\n            await deleteNamespace('conversations', { userId });\r\n        }\r\n\r\n        console.log(`üßπ Cleaned up ${conversationIds.length} old conversations`);\r\n        return conversationIds.length;\r\n    } catch (error) {\r\n        console.error('Error cleaning up old conversations:', error);\r\n        return 0;\r\n    }\r\n}\r\n\r\n// Type export for QueryResult from vector-db\r\ninterface QueryResult {\r\n    id: string;\r\n    score: number;\r\n    metadata: {\r\n        title?: string;\r\n        content: string;\r\n        userId?: string;\r\n        createdAt: string;\r\n        [key: string]: any;\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\message-listener.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'otherParticipant' is assigned a value but never used.","line":46,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from \"@/lib/firebase\"\r\nimport { collection, query, where, orderBy, onSnapshot, Timestamp } from \"firebase/firestore\"\r\n\r\nexport interface NewMessageData {\r\n    id: string\r\n    sessionId: string\r\n    senderId: string\r\n    senderName: string\r\n    senderImage?: string\r\n    content: string\r\n    createdAt: Date\r\n}\r\n\r\nexport function listenForNewMessages(\r\n    userId: string,\r\n    onNewMessage: (message: NewMessageData) => void\r\n): () => void {\r\n    // Track the last checked timestamp to avoid showing old messages\r\n    let lastCheckedAt = Timestamp.now()\r\n\r\n    // Listen to all chat sessions where user is a participant\r\n    const sessionsQuery = query(\r\n        collection(db, \"chatSessions\"),\r\n        where(\"participants\", \"array-contains\", userId)\r\n    )\r\n\r\n    const unsubscribe = onSnapshot(sessionsQuery, async (sessionsSnapshot) => {\r\n        for (const sessionDoc of sessionsSnapshot.docs) {\r\n            const sessionData = sessionDoc.data()\r\n\r\n            // Listen to messages in this session\r\n            const messagesQuery = query(\r\n                collection(db, `chatSessions/${sessionDoc.id}/messages`),\r\n                where(\"createdAt\", \">\", lastCheckedAt),\r\n                orderBy(\"createdAt\", \"desc\")\r\n            )\r\n\r\n            onSnapshot(messagesQuery, (messagesSnapshot) => {\r\n                messagesSnapshot.docChanges().forEach((change) => {\r\n                    if (change.type === \"added\") {\r\n                        const messageData = change.doc.data()\r\n\r\n                        // Only notify if message is from someone else\r\n                        if (messageData.senderId !== userId) {\r\n                            // Get sender info from session participants\r\n                            const otherParticipant = sessionData.participants.find(\r\n                                (p: string) => p !== userId\r\n                            )\r\n\r\n                            onNewMessage({\r\n                                id: change.doc.id,\r\n                                sessionId: sessionDoc.id,\r\n                                senderId: messageData.senderId,\r\n                                senderName: sessionData.otherUserName || \"Unknown\",\r\n                                senderImage: sessionData.otherUserImage,\r\n                                content: messageData.content,\r\n                                createdAt: messageData.createdAt?.toDate() || new Date(),\r\n                            })\r\n                        }\r\n                    }\r\n                })\r\n            })\r\n        }\r\n\r\n        // Update last checked timestamp\r\n        lastCheckedAt = Timestamp.now()\r\n    })\r\n\r\n    return unsubscribe\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\metadata.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'OG_IMAGE_DEFAULT' is assigned a value but never used.","line":6,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'embedUrl' is defined but never used.","line":24,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3616,3619],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3616,3619],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { Metadata } from 'next';\r\nimport { isUrlVideo, extractYouTubeId, fetchYouTubeTitle } from '@/lib/media-utils';\r\n\r\n// Default Fallback Image (Must be generic, not user-specific)\r\nconst OG_IMAGE_DEFAULT = \"https://firebasestorage.googleapis.com/v0/b/we-are-family-221.appspot.com/o/admin%2Ffamio-og-default.png?alt=media\";\r\n// Note: If this URL doesn't exist, we might need a placeholder. \r\n// For now, I'll use a reliable placeholder or the user needs to provide one.\r\n// Let's use a nice generated one if the specific file isn't guaranteed.\r\nconst OG_IMAGE_FALLBACK = \"https://placehold.co/1200x630/1e293b/ffffff/png?text=Famio+Content\";\r\n\r\ntype PostData = {\r\n    content?: string;\r\n    mediaUrls?: string[];\r\n    thumbnailUrl?: string | null; // Added\r\n    author?: {\r\n        displayName?: string;\r\n    };\r\n};\r\n\r\nexport async function generateContentMetadata(\r\n    post: PostData,\r\n    canonicalUrl: string,\r\n    embedUrl?: string\r\n): Promise<Metadata> {\r\n\r\n    // 1. YouTube Logic\r\n    const youtubeUrlMatch = post.content?.match(/https?:\\/\\/(www\\.)?(youtube\\.com|youtu\\.be)\\/\\S+/gi);\r\n    const youtubeUrl = youtubeUrlMatch ? youtubeUrlMatch[0].replace(/[\\s.,!?;:]+$/, '').trim() : null;\r\n\r\n    let videoTitle = null;\r\n    if (youtubeUrl) {\r\n        const yId = extractYouTubeId(youtubeUrl);\r\n        if (yId) {\r\n            videoTitle = await fetchYouTubeTitle(yId);\r\n        }\r\n    }\r\n\r\n    // Title Logic\r\n    const authorName = post.author?.displayName || \"Famio User\";\r\n    const title = videoTitle || (post.content ? truncate(post.content, 60) : `${authorName} on Famio`);\r\n\r\n    // Description Logic: Strip URLs to avoid ugly links in preview\r\n    const cleanContent = post.content ? post.content.replace(/(?:https?|ftp):\\/\\/[\\n\\S]+/g, '').trim() : '';\r\n    const description = cleanContent\r\n        ? truncate(cleanContent, 160)\r\n        : (videoTitle ? `Watch \"${videoTitle}\" on Famio` : `View this post on Famio.`);\r\n\r\n\r\n    // 2. Image Selection Logic (STRICT: NO PROFILE PHOTOS)\r\n    let imageUrl = OG_IMAGE_FALLBACK;\r\n    let type = 'article';\r\n    let videoUrlForOg: string | undefined = undefined;\r\n\r\n    // Priority 1: YouTube\r\n    if (youtubeUrl) {\r\n        const yId = extractYouTubeId(youtubeUrl);\r\n        if (yId) {\r\n            imageUrl = `https://img.youtube.com/vi/${yId}/maxresdefault.jpg`;\r\n            type = 'video.other';\r\n            videoUrlForOg = youtubeUrl;\r\n        }\r\n    }\r\n    // Priority 2: Explicit Thumbnail (Uploaded Video)\r\n    else if (post.thumbnailUrl) {\r\n        imageUrl = post.thumbnailUrl;\r\n        // Check if underlying media is video to set correct OG type\r\n        if (post.mediaUrls && post.mediaUrls.length > 0 && isUrlVideo(post.mediaUrls[0])) {\r\n            type = 'video.other';\r\n            videoUrlForOg = post.mediaUrls[0];\r\n        }\r\n    }\r\n    // Priority 3: Uploaded Media (Photo/Video Fallback)\r\n    else if (post.mediaUrls && post.mediaUrls.length > 0) {\r\n        const firstMedia = post.mediaUrls[0];\r\n\r\n        if (isUrlVideo(firstMedia)) {\r\n            // Video without generic thumbnail -> Use Placeholder\r\n            // Note: If we had a thumbnail generated by cloud function, we would use it here.\r\n            imageUrl = \"https://placehold.co/1200x630/000000/ffffff/png?text=‚ñ∂+Watch+Video\";\r\n            type = 'video.other';\r\n            videoUrlForOg = firstMedia;\r\n        } else {\r\n            // Photo -> Use directly\r\n            imageUrl = firstMedia;\r\n        }\r\n    }\r\n\r\n    return {\r\n        title,\r\n        description,\r\n        openGraph: {\r\n            title,\r\n            description,\r\n            type: type as any,\r\n            url: canonicalUrl,\r\n            siteName: 'Famio',\r\n            images: [\r\n                {\r\n                    url: imageUrl,\r\n                    width: 1200,\r\n                    height: 630,\r\n                    alt: 'Content Preview'\r\n                }\r\n            ],\r\n            videos: videoUrlForOg ? [{ url: videoUrlForOg }] : undefined\r\n        },\r\n        twitter: {\r\n            card: 'summary_large_image',\r\n            title,\r\n            description,\r\n            images: [imageUrl],\r\n        }\r\n    };\r\n}\r\n\r\nfunction truncate(str: string, n: number) {\r\n    return (str.length > n) ? str.slice(0, n - 1) + '...' : str;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\prompts\\agentic-voice.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\rtc-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\serialization.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35,38],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35,38],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41,44],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41,44],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[992,995],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[992,995],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":34,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export function sanitizeData(data: any): any {\r\n    if (data === null || data === undefined) return data;\r\n\r\n    // Handle Dates (already sanitized or native)\r\n    if (data instanceof Date) {\r\n        return data; // Dates are serializable in Next.js\r\n    }\r\n\r\n    // Handle Firestore Timestamp\r\n    if (typeof data === 'object' && typeof data.toDate === 'function') {\r\n        return data.toDate();\r\n    }\r\n\r\n    // Handle array\r\n    if (Array.isArray(data)) {\r\n        return data.map(item => sanitizeData(item));\r\n    }\r\n\r\n    // Handle Object (plain objects)\r\n    // We check if it's a plain object or at least not something we should let through\r\n    if (typeof data === 'object') {\r\n        // If it's a Firestore-like object that isn't a plain object (e.g. GeoPoint, DocumentReference)\r\n        // we might want to convert them to strings or plain objects if needed.\r\n        // For now, let's just make sure we don't crash on recursion.\r\n\r\n        try {\r\n            const sanitized: any = {};\r\n            for (const key in data) {\r\n                if (Object.prototype.hasOwnProperty.call(data, key)) {\r\n                    sanitized[key] = sanitizeData(data[key]);\r\n                }\r\n            }\r\n            return sanitized;\r\n        } catch (e) {\r\n            console.error(\"Sanitize failed for object:\", data);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    return data;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\trend-cache.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[67,70],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[67,70],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[237,240],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[237,240],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[569,572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[569,572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// In-memory trend cache with TTL\r\ntype CachedTrend = {\r\n    data: any;\r\n    timestamp: number;\r\n    ttl: number; // milliseconds\r\n};\r\n\r\nconst trendCache = new Map<string, CachedTrend>();\r\n\r\nexport function getCachedTrends(key: string): any | null {\r\n    const cached = trendCache.get(key);\r\n\r\n    if (!cached) return null;\r\n\r\n    const now = Date.now();\r\n    if (now - cached.timestamp > cached.ttl) {\r\n        // Expired\r\n        trendCache.delete(key);\r\n        return null;\r\n    }\r\n\r\n    return cached.data;\r\n}\r\n\r\nexport function setCachedTrends(key: string, data: any, ttlMinutes: number = 30) {\r\n    trendCache.set(key, {\r\n        data,\r\n        timestamp: Date.now(),\r\n        ttl: ttlMinutes * 60 * 1000\r\n    });\r\n}\r\n\r\nexport function clearTrendCache(key?: string) {\r\n    if (key) {\r\n        trendCache.delete(key);\r\n    } else {\r\n        trendCache.clear();\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\user-utils.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[268,271],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[268,271],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n/**\r\n * Smartly resolves a user's display name from various profile fields.\r\n * Prioritizes custom display names, then real names, then email usernames.\r\n * Explicitly rejects generic placeholders like \"Family Member\".\r\n */\r\nexport function resolveDisplayName(data: any): string {\r\n    if (!data) return \"Unknown User\";\r\n\r\n    // 1. Use displayName if it exists and is meaningful (not generic/default)\r\n    if (data.displayName && data.displayName.trim()) {\r\n        const lowerName = data.displayName.toLowerCase();\r\n        const generics = [\"family member\", \"unknown user\", \"member\", \"user\", \"guest\"];\r\n\r\n        // Only use if NOT generic\r\n        if (!generics.includes(lowerName)) {\r\n            return data.displayName;\r\n        }\r\n    }\r\n\r\n    // 2. Try to build from profile data\r\n    if (data.profileData?.firstName) {\r\n        const fullName = `${data.profileData.firstName} ${data.profileData.lastName || ''}`.trim();\r\n        if (fullName) return fullName;\r\n    }\r\n\r\n    // 2b. Fallback: If we have first/last name at top level (sometimes happens in legacy data)\r\n    if (data.firstName) {\r\n        const fullName = `${data.firstName} ${data.lastName || ''}`.trim();\r\n        if (fullName) return fullName;\r\n    }\r\n\r\n    // 3. Fallback: Try Email\r\n    if (data.email) {\r\n        return data.email.split('@')[0];\r\n    }\r\n\r\n    // 4. Final Fallback\r\n    return \"Famio Member\";\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\lib\\vector-db.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[331,334],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[331,334],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[563,566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[563,566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2483,2486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2483,2486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":112,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3045,3048],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3045,3048],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3104,3107],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3104,3107],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":153,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4228,4231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4228,4231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":176,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":176,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4831,4834],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4831,4834],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Vector Database Abstraction Layer\r\n * Provides a unified interface for vector operations using Pinecone\r\n * Supports multiple namespaces for different data types\r\n */\r\n\r\nimport { Pinecone } from '@pinecone-database/pinecone';\r\n\r\n// Singleton Pinecone client\r\nlet pineconeClient: Pinecone | null = null;\r\nlet pineconeIndex: any = null;\r\n\r\nexport type VectorNamespace = 'knowledge' | 'conversations' | 'user_content';\r\n\r\ninterface VectorMetadata {\r\n    title?: string;\r\n    content: string;\r\n    userId?: string;\r\n    createdAt: string;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface VectorRecord {\r\n    id: string;\r\n    values: number[];\r\n    metadata: VectorMetadata;\r\n}\r\n\r\ninterface QueryResult {\r\n    id: string;\r\n    score: number;\r\n    metadata: VectorMetadata;\r\n}\r\n\r\n/**\r\n * Initialize Pinecone client (called once)\r\n */\r\nexport async function initVectorDB() {\r\n    if (pineconeClient && pineconeIndex) {\r\n        return { client: pineconeClient, index: pineconeIndex };\r\n    }\r\n\r\n    const apiKey = process.env.PINECONE_API_KEY;\r\n    const indexName = process.env.PINECONE_INDEX_NAME || 'famio-ai';\r\n\r\n    if (!apiKey) {\r\n        throw new Error('PINECONE_API_KEY is not set in environment variables');\r\n    }\r\n\r\n    try {\r\n        console.log('üîå Initializing Pinecone client...');\r\n        pineconeClient = new Pinecone({\r\n            apiKey: apiKey,\r\n        });\r\n\r\n        // Get or create index\r\n        pineconeIndex = pineconeClient.index(indexName);\r\n\r\n        console.log('‚úÖ Pinecone initialized successfully');\r\n        return { client: pineconeClient, index: pineconeIndex };\r\n    } catch (error) {\r\n        console.error('‚ùå Failed to initialize Pinecone:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Upsert vectors to a specific namespace\r\n */\r\nexport async function upsertVectors(\r\n    namespace: VectorNamespace,\r\n    vectors: VectorRecord[]\r\n): Promise<void> {\r\n    try {\r\n        const { index } = await initVectorDB();\r\n\r\n        console.log(`üì§ Upserting ${vectors.length} vectors to namespace: ${namespace}`);\r\n\r\n        await index.namespace(namespace).upsert(vectors);\r\n\r\n        console.log('‚úÖ Vectors upserted successfully');\r\n    } catch (error) {\r\n        console.error('‚ùå Error upserting vectors:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Query vectors for similarity search\r\n */\r\nexport async function queryVectors(\r\n    namespace: VectorNamespace,\r\n    queryVector: number[],\r\n    topK: number = 5,\r\n    filter?: Record<string, any>,\r\n    minScore: number = 0.7\r\n): Promise<QueryResult[]> {\r\n    try {\r\n        const { index } = await initVectorDB();\r\n\r\n        console.log(`üîç Querying ${topK} vectors from namespace: ${namespace}`);\r\n\r\n        const queryResponse = await index.namespace(namespace).query({\r\n            vector: queryVector,\r\n            topK,\r\n            includeMetadata: true,\r\n            filter,\r\n        });\r\n\r\n        // Filter by minimum score and map to simplified format\r\n        const results: QueryResult[] = queryResponse.matches\r\n            .filter((match: any) => match.score >= minScore)\r\n            .map((match: any) => ({\r\n                id: match.id,\r\n                score: match.score,\r\n                metadata: match.metadata as VectorMetadata,\r\n            }));\r\n\r\n        console.log(`‚úÖ Found ${results.length} results above score ${minScore}`);\r\n        return results;\r\n    } catch (error) {\r\n        console.error('‚ùå Error querying vectors:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Delete vectors from a namespace (for cleanup or GDPR)\r\n */\r\nexport async function deleteVectors(\r\n    namespace: VectorNamespace,\r\n    ids: string[]\r\n): Promise<void> {\r\n    try {\r\n        const { index } = await initVectorDB();\r\n\r\n        console.log(`üóëÔ∏è Deleting ${ids.length} vectors from namespace: ${namespace}`);\r\n\r\n        await index.namespace(namespace).deleteMany(ids);\r\n\r\n        console.log('‚úÖ Vectors deleted successfully');\r\n    } catch (error) {\r\n        console.error('‚ùå Error deleting vectors:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Delete all vectors in a namespace (for user data cleanup)\r\n */\r\nexport async function deleteNamespace(\r\n    namespace: VectorNamespace,\r\n    filter?: Record<string, any>\r\n): Promise<void> {\r\n    try {\r\n        const { index } = await initVectorDB();\r\n\r\n        console.log(`üóëÔ∏è Deleting all vectors from namespace: ${namespace}`);\r\n\r\n        if (filter) {\r\n            await index.namespace(namespace).deleteMany(filter);\r\n        } else {\r\n            await index.namespace(namespace).deleteAll();\r\n        }\r\n\r\n        console.log('‚úÖ Namespace cleaned successfully');\r\n    } catch (error) {\r\n        console.error('‚ùå Error deleting namespace:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Get index stats\r\n */\r\nexport async function getVectorStats(): Promise<any> {\r\n    try {\r\n        const { index } = await initVectorDB();\r\n        const stats = await index.describeIndexStats();\r\n        return stats;\r\n    } catch (error) {\r\n        console.error('‚ùå Error fetching stats:', error);\r\n        throw error;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\scripts\\check_api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\scripts\\debug_user_lookup.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2601,2604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2601,2604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { initializeApp, cert, getApps, applicationDefault } from 'firebase-admin/app';\r\nimport { getFirestore } from 'firebase-admin/firestore';\r\nimport dotenv from 'dotenv';\r\nimport path from 'path';\r\n\r\n// Load env vars from .env.local\r\ndotenv.config({ path: path.resolve(process.cwd(), '.env.local') });\r\n\r\nasync function main() {\r\n    console.log('--- Debug Script: User Lookup ---');\r\n\r\n    // Initialize Firebase Admin\r\n    const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || \"we-are-family-221\";\r\n    console.log('Project ID:', projectId);\r\n\r\n    let credential;\r\n    try {\r\n        if (process.env.FIREBASE_PRIVATE_KEY) {\r\n            console.log('FIREBASE_PRIVATE_KEY found in env (length: ' + process.env.FIREBASE_PRIVATE_KEY.length + ')');\r\n            credential = cert({\r\n                projectId,\r\n                clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\r\n                privateKey: process.env.FIREBASE_PRIVATE_KEY.replace(/\\\\n/g, '\\n'),\r\n            });\r\n        } else {\r\n            console.warn('No FIREBASE_PRIVATE_KEY found in env or empty.');\r\n            credential = applicationDefault();\r\n        }\r\n\r\n        if (!getApps().length) {\r\n            initializeApp({\r\n                credential,\r\n                projectId,\r\n            });\r\n        }\r\n    } catch (err) {\r\n        console.error(\"Initialization Error:\", err);\r\n        return;\r\n    }\r\n\r\n    const db = getFirestore();\r\n    const targetEmail = \"chancellor@ichancetek.com\";\r\n\r\n    try {\r\n        console.log(`\\nListing first 5 users to verify connection...`);\r\n        const recentUsers = await db.collection(\"users\").limit(5).get();\r\n        if (recentUsers.empty) {\r\n            console.log(\"No users found in 'users' collection.\");\r\n        } else {\r\n            recentUsers.docs.forEach(d => console.log(`- [${d.id}] ${d.data().email} (${d.data().displayName})`));\r\n        }\r\n\r\n        console.log(`\\nSearching for user with email: ${targetEmail}`);\r\n        const snapshot = await db.collection(\"users\").where(\"email\", \"==\", targetEmail).limit(1).get();\r\n\r\n        if (snapshot.empty) {\r\n            console.error(\"User NOT FOUND by email:\", targetEmail);\r\n        } else {\r\n            const doc = snapshot.docs[0];\r\n            console.log(\"User FOUND.\");\r\n            console.log(\"ID:\", doc.id);\r\n            console.log(\"Email:\", doc.data().email);\r\n\r\n            // Re-verify by ID\r\n            const verifyPath = await db.collection(\"users\").doc(doc.id).get();\r\n            console.log(`Direct lookup by ID (${doc.id}) exists:`, verifyPath.exists);\r\n        }\r\n\r\n    } catch (e: any) {\r\n        console.error(\"Error querying Firestore:\", e);\r\n        if (e.code === 7) { // PERMISSION_DENIED\r\n            console.error(\"Hint: Permission Denied. Check service account roles.\");\r\n        }\r\n    }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\temp_fetch_user.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\types\\ai.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\types\\engagement.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\types\\magic-ai.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chanc\\Documents\\WeAreFamily\\types\\posts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]